var m=m||{};m.aio=m.aio||{},m.aio.commandhandler=m.aio.commandhandler||{},m.aio.commandhandler.Task=function(e,o){this.type=e,this.callback=o,this.device=null,this.command=null,this.devices=null;},m.aio.commandhandler.Task.TYPE={DO_COMMAND:0,DO_STATUS:1,DO_SINGLE_DEVICE_STATUS:2},m.aio.commandhandler.Queue=function(){this._queue=[];},m.aio.commandhandler.Queue.prototype.push=function(e){this._queue.push(e);},m.aio.commandhandler.Queue.prototype.pop=function(){var e=this._queue.splice(0,1);return e.length?e[0]:null;},m.aio.commandhandler.Queue.prototype.size=function(){return this._queue.length;},m.aio.commandhandler.ExecutionQueue=function(e){this._executor=e,this._state=0,this._queue=new m.aio.commandhandler.Queue();},m.aio.commandhandler.ExecutionQueue.prototype.pushTask=function(e){this._executeTask(e);},m.aio.commandhandler.ExecutionQueue.prototype._executeTask=function(e){this._executor.executeTask(e,function(){}.bind(this));},m.aio.commandhandler.Executor=function(e,o,t){this.sys=e,this._host=o,this._queue=new m.aio.commandhandler.ExecutionQueue(this),this._handler=t;},m.aio.commandhandler.Executor.prototype.getHost=function(){return this._host;},m.aio.commandhandler.Executor.prototype.execute=function(e){this._queue.pushTask(e);},m.aio.commandhandler.Executor.prototype.executeTask=function(e,o){switch(e.type){case m.aio.commandhandler.Task.TYPE.DO_COMMAND:if(!this._host||!this._host.executeCommandCreator)return void(e.callback&&e.callback(new Error("device accept no command")));e.device,this._host.executeCommandCreator(e.device,e.command,function(t,a){e.callback&&e.callback(t,a),o&&o();});break;case m.aio.commandhandler.Task.TYPE.DO_STATUS:if(!this._host||!this._host.getStatesCreator)return void(e.callback&&e.callback(new Error("device has no states")));this._host.getStatesCreator(this._handler,e.devices,function(t,a,n){e.callback&&e.callback(t,a,n),o&&o();});break;case m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS:if(!this._host||!this._host.getSingleDeviceStatesCreator)return void(e.callback&&e.callback(new Error("device has no such function")));this._host.getSingleDeviceStatesCreator(this._handler,e.device,e.devices,function(t,a){e.callback&&e.callback(t,a),o&&o();});break;default:o&&o();}},m.aio.commandhandler.ExecutorPool=function(){this._executors=[];},m.aio.commandhandler.ExecutorPool.prototype.getExecutor=function(e,o){for(var t=null,a=0;a<this._executors.length;a++){var n=this._executors[a];if(n.sys==e&&n._host&&n._host.equalsTo&&"function"==typeof n._host.equalsTo&&n._host.equalsTo(o)){t=n;break;}}return t;},m.aio.commandhandler.ExecutorPool.prototype.addExecutor=function(e){this._executors.push(e);},m.aio.commandhandler.ExecutorPool.prototype.cleanPool=function(){this._executors=[];},m.aio.commandhandler.IntHandler=function(){this._executorPool=new m.aio.commandhandler.ExecutorPool(),this._cloudForwardHost=null,this._statesListener=null;},m.aio.commandhandler.IntHandler.prototype.clean=function(e){this._executorPool.cleanPool(),e();},m.aio.commandhandler.IntHandler.prototype.setStatesListener=function(e){this._statesListener=e;},m.aio.commandhandler.IntHandler.prototype.resolveHost=function(e,o,t,a){var n;if(e){if(!e.sys)return void(a&&a(new Error("gateway json format in valid")));n=e.sys;}else{if(!o.sys)return void(a&&a(new Error("device json format in valid")));n=o.sys;}var r,i=require("m.aio.devicemanager").getModule(n);i?(e&&i.resolveGateway&&"function"==typeof i.resolveGateway?r=i.resolveGateway(e):i.resolveDevice&&"function"==typeof i.resolveDevice&&(r=i.resolveDevice(o,t)),r?a&&a(null,r,n):a&&a(new Error("resolve device object error"))):a&&a(new Error("module "+n+" do not exist"));},m.aio.commandhandler.IntHandler.prototype.executeCommand=function(e,o,t,a,n,r,i){if(o){var c=this._executorPool.getExecutor(e,o);c||(c=new m.aio.commandhandler.Executor(e,o,this),o._deviceInfo||this._executorPool.addExecutor(c));var s=c.getHost();if(this._cloudForwardHost&&this._cloudForwardHost!=s)this._cloudForwardHost.forwardExecuteCommand(r,t,a,n);else{"aio"!=e&&"neoserver"!=e||!a||"cfOn"!=a.value&&"cfOff"!=a.value&&"cfToggle"!=a.value||("cfOn"==a.value?this._cloudForwardHost=s:"cfOff"==a.value?this._cloudForwardHost=null:s&&("on"==s._cfSetting?this._cloudForwardHost=null:this._cloudForwardHost=s));var d=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_COMMAND,n);d.device=t,d.command=a,c.execute(d);}}else n&&n(new Error("invalid host"));},m.aio.commandhandler.IntHandler.prototype.getStates=function(e,o,t,a,n,r,i){if(o){var c=this._executorPool.getExecutor(e,o);c||(c=new m.aio.commandhandler.Executor(e,o,this),this._executorPool.addExecutor(c));var s=c.getHost();if(this._cloudForwardHost&&this._cloudForwardHost!=s)this._cloudForwardHost.forwardGetStates(n,r,t,a);else{var d=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_STATUS,a);d.devices=t,c.execute(d);}}else a&&a(new Error("invalid host"));},m.aio.commandhandler.IntHandler.prototype.getStatesForSingleDevice=function(e,o,t,a,n){if(o){var r=this._executorPool.getExecutor(e,o);r||(r=new m.aio.commandhandler.Executor(e,o,this),this._executorPool.addExecutor(r));var i=new m.aio.commandhandler.Task(m.aio.commandhandler.Task.TYPE.DO_SINGLE_DEVICE_STATUS,n);i.device=t,i.devices=a,r.execute(i);}else n&&n(new Error("invalid host"));},m.aio.commandhandler.IntHandler.prototype.reportStates=function(e,o){this._statesListener&&this._statesListener.reportStates&&this._statesListener.reportStates(e,o);},m.aio.commandhandler._SingeltonHandler=new m.aio.commandhandler.IntHandler(),m.aio.commandhandler.Handler=function(){},m.aio.commandhandler.Handler.prototype.Handler=m.aio.commandhandler.IntHandler,m.aio.commandhandler.Handler.prototype.CentralHandler=m.aio.commandhandler._SingeltonHandler,"undefined"!=typeof module&&null!=module&&module.exports&&(module.exports=new m.aio.commandhandler.Handler());