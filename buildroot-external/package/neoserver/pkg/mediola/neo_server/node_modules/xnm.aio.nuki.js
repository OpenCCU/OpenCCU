var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.nuki=xnm.aio.nuki||{},xnm.aio.nuki.SmartLockBridge=function(){var e={0:"uncalibrated",1:"locked",2:"unlocking",3:"unlocked",4:"locking",5:"unlatched",6:"unlocked_lock_n_go",7:"unlatching",254:"motor_blocked",255:"undefined"},Bridge=function Bridge(e,t,n){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.nuki.SmartLock"),this.ip=e,this.port=t,this.port||(this.port=8080),this.token=n,this.timeout=5e4;};return Bridge.prototype.executeCommandCreator=function(e,t,n){if(e&&e.address){if(t&&t.value){var a;switch(t.value){case"unlock":a=1;break;case"lock":a=2;break;case"unlatch":a=3;break;case"lockGo":a=4;break;case"lockGoUnlatch":a=5;break;default:return void(n&&n(new Error("no such command")));}this._lockAction(e.address,a,0,n);}else n&&n(new Error("command json format invalid"));}else n&&n(new Error("device json format invalid"));},Bridge.prototype.getStatesCreator=function(e,t,n){this.getLocalStates(function(e,a){for(var o=[],i=0;i<t.length;i++){if(t[i]&&t[i].id){var r="?";if(a&&t[i].status&&t[i].status.value&&t[i].device&&t[i].device.address){var s=t[i].status.value,l=t[i].device.address;a[l]&&(void 0!==(r=a[l][s])&&null!=r||(r="?"));}o.push({id:t[i].id,status:r});}}n&&n(null,o);});},Bridge.prototype.getLocalStates=function(e){var t=this;this._list(function(n,a){if(n)e&&e(n);else{for(var o={},i=0;i<a.length;i++){var r=a[i];if(r.nukiId&&r.lastKnownState){var s=t._toState(r.lastKnownState);s&&(o[r.nukiId]=s);}}e&&e(null,o);}});},Bridge.prototype.getDevices=function(e){this._list(function(t,n){if(t)e&&e(t);else{for(var a=[],o=0;o<n.length;o++){var i=n[o];i.nukiId&&i.name&&a.push({sys:"nuki",type:"smartlock",address:i.nukiId,name:i.name});}e&&e(null,a);}});},Bridge.prototype._toState=function(t){var n={};return n.state=e[t.state],n.lowbat=t.batteryCritical,n.stateCode=t.state,n.stateName=t.stateName,n;},Bridge.prototype._lockAction=function(e,t,n,a){this._doLocalRequest("/lockAction",{token:this.token,nukiId:e,action:t,noWait:n},function(e,t,n){if(e){var o=e;return 401==parseInt(t)?(o=new Error("invalid token")).code=1e3:400==parseInt(t)?(o=new Error("invalid action")).code=1003:404==parseInt(t)?(o=new Error("unknown smart lock")).code=1001:503==parseInt(t)&&((o=new Error("smart lock offline")).code=1002),void(a&&a(o));}a&&a(null,n);});},Bridge.prototype._lockState=function(e,t){this._doLocalRequest("/lockState",{token:this.token,nukiId:e},function(e,n,a){if(e){var o=e;return 401==parseInt(n)?(o=new Error("invalid token")).code=1e3:404==parseInt(n)?(o=new Error("unknown smart lock")).code=1001:503==parseInt(n)&&((o=new Error("smart lock offline")).code=1002),void(t&&t(o));}t&&t(null,a);});},Bridge.prototype._list=function(e){this._doLocalRequest("/list",{token:this.token},function(t,n,a){if(t){var o=t;return 401==parseInt(n)&&((o=new Error("invalid token")).code=1e3),void(e&&e(o));}e&&e(null,a);});},Bridge.prototype._doLocalRequest=function(e,t,n){var a=this,o="http://"+this.ip+":"+this.port+e,i=o;if(t){var r=[],s=[];for(var l in t){if(t.hasOwnProperty(l)){var u=l+"=",c=t[l];void 0!==c&&null!=c&&(u+=encodeURIComponent(c)),r.push(u),"token"!=l?s.push(u):s.push("token=xxxxxx");}}o+="?"+r.join("&"),i+="?"+s.join("&");}this._logger.log("trace","send get to url:"+i);var d=n;$.ajax({url:o,type:"GET",timeout:this.timeout,dataType:"text",cache:!0,success:function success(e){a._logger.log("trace","http request success:"+e);try{var t=JSON.parse(e);d&&(d(null,200,t),d=null);}catch(e){d&&(d(e,200),d=null);}},error:function error(e,t){var n="http request error:"+(e?e.status:"0")+"-"+t;a._logger.log("trace",n),d&&(d(new Error(n),e?e.status:"0"),d=null);}});},Bridge.prototype.equalsTo=function(e){return!!(e&&e instanceof Bridge)&&this.ip===e.ip&&this.port===e.port&&this.token===e.token;},Bridge;}(),xnm.aio.nuki.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="NukiDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"nuki",MAP:{command:[{type:"enum",name:"unlock",ref:{value:"unlock"}},{type:"enum",name:"lock",ref:{value:"lock"}},{type:"enum",name:"unlatch",ref:{value:"unlatch"}},{type:"enum",name:"lock 'n' go",ref:{value:"lockGo"}},{type:"enum",name:"lock 'n' go with unlatch",ref:{value:"lockGoUnlatch"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["uncalibrated","locked","unlocking","unlocked","locking","unlatched","unlocked_lock_n_go","unlatching","motor_blocked","undefined"]}},{type:"enum",name:"low battery",ref:{value:"lowbat",options:["true","false"]}}]},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"NUKI Bridge",port:8080}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"smartlock",name:"Smart Lock"}];},createGateway:function createGateway(e,t,n){var a=DMError,o=DMError.ERROR_CODE;e?e.ip?e.token?n(null,e):n(new a(o.INVALID,"token is invalid")):n(new a(o.INVALID,"ip is invalid")):n(new a(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,a){var o=DMError,i=DMError.ERROR_CODE;t?t.ip?t.token?a(null,t):a(new o(i.INVALID,"token is invalid")):a(new o(i.INVALID,"ip is invalid")):a(new o(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var a=DMError,o=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,r,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){r=s[i];break;}}r?n(null,e):n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.INVALID,"address is invalid"));}else n(new a(o.INVALID,"gateway is invalid"));}else n(new a(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var a=DMError,o=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,r,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){r=s[i];break;}}r?n(null,e):n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(o.INVALID,"address is invalid"));}else n(new a(o.INVALID,"gateway is invalid"));}else n(new a(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t){var n=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++){if(e[a]==t){n=!0;break;}}return n;},_filter=function _filter(e,t){var a=[],o=null,i=n.getCommandStatusMap(e);return i&&(o=function(e,t,n){var a=[];switch(n.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});}return a;}(i,0,t),a=a.concat(o)),a;};if(!e||null==e.type||void 0===e.type)return null;var a=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),a.command=o;break;case"status":o=_filter(e,t),a.status=o;break;default:return null;}return o&&0!=o.length?a:null;},getCommandStatusMap:function getCommandStatusMap(e){return this.MAP;}};}(),xnm.aio.nuki.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.nuki.DM,Handler.prototype.SmartLockBridge=xnm.aio.nuki.SmartLockBridge,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"nuki");},Handler.prototype.resolveGateway=function(e){return e&&e.ip?new this.SmartLockBridge(e.ip,e.port,e.token):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},Handler.prototype.doCommand=function(e,t,n,a){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,n,a,o){var i=this.resolveGateway(t);if(i){var r=[{id:e,device:n,status:a}];i.getStatesCreator(null,r,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.nuki.Handler());