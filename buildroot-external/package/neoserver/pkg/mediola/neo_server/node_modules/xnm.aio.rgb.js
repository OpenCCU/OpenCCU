function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.rgb=xnm.aio.rgb||{},xnm.aio.rgb.Util={rgbToHsv:function rgbToHsv(e,t,r){e/=255,t/=255,r/=255;var n,a,i=Math.max(e,t,r),s=Math.min(e,t,r),o=i,u=i-s;if(a=0==i?0:u/i,i==s)n=0;else{switch(i){case e:n=(t-r)/u+(t<r?6:0);break;case t:n=(r-e)/u+2;break;case r:n=(e-t)/u+4;}n=Math.round(60*n),a=Math.round(100*a),o=Math.round(100*o);}return[n,a,o];},hsvToMilightColor:function hsvToMilightColor(e){return(432-Math.floor(Number(e[0])/360*255))%256;},rgbToHue:function rgbToMilightHue(e,t,r){var n=this.rgbToHsv(e,t,r);return(432-Math.floor(Number(n[0])/360*255))%256;}},xnm.aio.rgb.ArtNetNode=function(){var e=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3],ArtNetNode=function ArtNetNode(e,t){this.ip=e,this.port=t,this.port||(this.port=6454);};return ArtNetNode.prototype.executeCommandCreator=function(e,t,r){this._executeCommand(t,function(e){r&&r(e);});},ArtNetNode.prototype.equalsTo=function(e){return!!e&&e instanceof ArtNetNode&&this.ip==e.ip&&this.port==e.port;},ArtNetNode.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port};},ArtNetNode.prototype._executeCommand=function(e,t){var r;if(e){if("hex"===e.value){if(r=e.ext){var n=this._buildData(r);this._doRequest(n,function(){t&&t();});}else t&&t(new Error("command is empty"));}else t&&t(new Error("no such command:"+e.value));}else t&&t(new Error("command format invalid"));},ArtNetNode.prototype._buildData=function(t){t.length%2!=0&&(t="0"+t);var r=e.slice();r[16]=t.length/2>>8&15,r[17]=t.length/2&15;for(var n=0;n<t.length/2;n++){var a=t.substr(2*n,2);r.push(parseInt(a,16));}return r;},ArtNetNode.prototype._doRequest=function(e,t){var r=require("dgram"),n=new Buffer(e),a=r.createSocket("udp4");a.send(n,0,e.length,this.port,this.ip,function(e){a.close(),t&&t(e);});},ArtNetNode._stateBuffer={},ArtNetNode.parseJSON=function(e){return e.ip?new ArtNetNode(e.ip,e.port):null;},ArtNetNode;}(),xnm.aio.rgb.ArtNetNode.DM=function(){var e={command:[{type:"string",name:"HEX command",ref:{value:"hex",ext:"%s"}}]};return{SYS:"artnet",registModule:function registModule(e){e.register(this.SYS,"rgb");},getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"ArtNet Node"};},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(){return e;}};}(),xnm.aio.rgb.WiFiLED2=function(){var WiFiLED2=function WiFiLED2(e,t){var r=require("x.logger.js");this._logger=r?r.getLogger("xnm.aio.rgb.WiFiLED2"):{log:function log(){}},this.ip=e,this.port=t,this.port||(this.port=5e4);};return WiFiLED2.prototype._doRequest=function(e,t){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(e));var r=require("dgram"),n=new Buffer(e),a=r.createSocket("udp4");a.send(n,0,n.length,this.port,this.ip,function(e){a.close(),t&&setTimeout(function(){t(e);},250);});},WiFiLED2.prototype.executeCommand=function(e,t){var r=[32,0,85];if("on"==e)r[0]=34;else if("off"==e)r[0]=33;else if("up"==e)r[0]=35;else if("down"==e)r[0]=36;else if("modeUp"==e)r[0]=39;else if("modeDown"==e)r[0]=40;else if("speedUp"==e)r[0]=37;else if("speedDown"==e)r[0]=38;else if("allBulbsOn"==e)r[0]=53;else if("allBulbsOff"==e)r[0]=57;else if("bulbUp"==e)r[0]=60;else if("bulbDown"==e)r[0]=52;else if("bulbLightUp"==e)r[0]=62;else if("bulbLightDown"==e)r[0]=63;else if("zone1On"==e)r[0]=56;else if("zone1Off"==e)r[0]=59;else if("zone2On"==e)r[0]=61;else if("zone2Off"==e)r[0]=51;else if("zone3On"==e)r[0]=55;else if("zone3Off"==e)r[0]=58;else if("zone4On"==e)r[0]=50;else if("zone4Off"==e)r[0]=54;else if(6==e.length){var n,a=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16),s=parseInt(e.substr(4,2),16),o=0,u=85,l=s,c=i;s<=a&&s<=i?(l=i,c=a,o=86,u=170):i<=a&&i<=s&&(l=a,c=s,o=171,u=255),n=255==l?o+c/255*((u-o)/2):u-l/255*((u-o)/2),(n+=10)>255&&(n-=255),0==a&&0==i&&0==s?r[0]=21:r[1]=n;}this._doRequest(r,t);},WiFiLED2.prototype.executeCommandCreator=function(e,t,r){var n=t.value;"rgb"!=n&&"rgbS"!=n||(n=t.ext),this.executeCommand(n,function(){r&&r();});},WiFiLED2.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rgb.WiFiLED2&&this.ip==e.ip&&this.port==e.port;},WiFiLED2.parseJSON=function(e){return e.ip?new WiFiLED2(e.ip,e.port):null;},WiFiLED2;}(),xnm.aio.rgb.WiFiLED2.DM=function(){var e={command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"modeUp",ref:{value:"modeUp"}},{type:"enum",name:"modeDown",ref:{value:"modeDown"}},{type:"enum",name:"speedUp",ref:{value:"speedUp"}},{type:"enum",name:"speedDown",ref:{value:"speedDown"}},{type:"enum",name:"allBulbsOn",ref:{value:"allBulbsOn"}},{type:"enum",name:"allBulbsOff",ref:{value:"allBulbsOff"}},{type:"enum",name:"bulbUp",ref:{value:"bulbUp"}},{type:"enum",name:"bulbDown",ref:{value:"bulbDown"}},{type:"enum",name:"bulbLightUp",ref:{value:"bulbLightUp"}},{type:"enum",name:"bulbLightDown",ref:{value:"bulbLightDown"}},{type:"enum",name:"zone1On",ref:{value:"zone1On"}},{type:"enum",name:"zone1Off",ref:{value:"zone1Off"}},{type:"enum",name:"zone2On",ref:{value:"zone2On"}},{type:"enum",name:"zone2Off",ref:{value:"zone2Off"}},{type:"enum",name:"zone3On",ref:{value:"zone3On"}},{type:"enum",name:"zone3Off",ref:{value:"zone3Off"}},{type:"enum",name:"zone4On",ref:{value:"zone4On"}},{type:"enum",name:"zone4Off",ref:{value:"zone4Off"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]};return{SYS:"wifiled2",registModule:function registModule(e){e.register(this.SYS,"rgb");},getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"Wifi LED II"};},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(){return e;}};}(),xnm.aio.rgb.DMX4ALL=function(){var e=[65,114,116,45,78,101,116,0,0,80,0,14,0,0,0,0,0,3,0,0,0],DMX4ALL=function DMX4ALL(e,t){this.ip=e,this.port=t,this.port||(this.port=6454);};return DMX4ALL.prototype.executeCommandCreator=function(e,t,r){this._executeCommand(t,function(e){r&&r(e);});},DMX4ALL.prototype.equalsTo=function(e){return!!e&&e instanceof DMX4ALL&&this.ip==e.ip&&this.port==e.port;},DMX4ALL.prototype.toJSON=function(){return{sys:xnm.aio.rgb.DMX4ALL.DM.SYS,ip:this.ip,port:this.port};},DMX4ALL.prototype._executeCommand=function(e,t){if(e){var r=0,n=0,a=0,i=0,s=100;if(DMX4ALL._stateBuffer[this.ip]){var o=DMX4ALL._stateBuffer[this.ip];null!=o.red&&void 0!==o.red&&(r=o.red),null!=o.green&&void 0!==o.green&&(n=o.green),null!=o.blue&&void 0!==o.blue&&(a=o.blue),null!=o.white&&void 0!==o.white&&(i=o.white),null!=o.bri&&void 0!==o.bri&&(s=o.bri);}switch(e.value){case"off":r=0,n=0,a=0,i=0;break;case"red":case"green":case"blue":case"white":if(null==e.ext||void 0===e.ext)return void(t&&t(new Error("command red value invalid")));if("number"==typeof e.ext)switch(e.value){case"red":r=parseInt(e.ext);break;case"green":n=parseInt(e.ext);break;case"blue":a=parseInt(e.ext);break;case"white":i=parseInt(e.ext);}else{if(!e.ext.match(/^[-+]?[0-9]+$/))return void(t&&t(new Error("command red value invalid")));switch(e.value){case"red":r=parseInt(e.ext);break;case"green":n=parseInt(e.ext);break;case"blue":a=parseInt(e.ext);break;case"white":i=parseInt(e.ext);}}break;case"rgb":case"rgbS":if(!e.ext||e.ext.length<6)return void(t&&t(new Error("command rgb value invalid")));r=parseInt(e.ext.substr(0,2),16),n=parseInt(e.ext.substr(2,2),16),a=parseInt(e.ext.substr(4,2),16);break;case"rgbw":case"rgbwS":if(!e.ext||e.ext.length<8)return void(t&&t(new Error("command rgbw value invalid")));r=parseInt(e.ext.substr(0,2),16),n=parseInt(e.ext.substr(2,2),16),a=parseInt(e.ext.substr(4,2),16),i=parseInt(e.ext.substr(6,2),16);break;case"brightness":if(null==e.ext||void 0===e.ext)return void(t&&t(new Error("command brightness value invalid")));if("number"==typeof e.ext)s=parseInt(e.ext);else{if(!e.ext.match(/^[-+]?[0-9]+$/))return void(t&&t(new Error("command brightness value invalid")));s=parseInt(e.ext);}break;default:return void(t&&t(new Error("no such command:"+e.value)));}DMX4ALL._stateBuffer[this.ip]={red:r,green:n,blue:a,white:i,bri:s};var u=this._buildColor(r,n,a,i,s/100);this._doRequest(new Buffer(u),function(){t&&t();});}else t&&t(new Error("command format invalid"));},DMX4ALL.prototype._buildColor=function(t,r,n,a,i){var s=Math.round(t*i),o=Math.round(r*i),u=Math.round(n*i),l=Math.round(a*i);s>255&&(s=255),o>255&&(o=255),u>255&&(u=255),l>255&&(l=255);var c=e.slice();return c[17]=4,c[18]=s,c[19]=o,c[20]=u,c.push(l),c;},DMX4ALL.prototype._doRequest=function(e,t){var r=require("dgram").createSocket("udp4");r.send(e,0,e.length,this.port,this.ip,function(e){r.close(),t&&t(e);});},DMX4ALL._stateBuffer={},DMX4ALL._discovery=function(e,t){if(!DMX4ALL._logger){var r=require("x.logger.js");DMX4ALL._logger=r?r.getLogger("xnm.aio.rgb.DMX4ALL"):{log:function log(){}};}var _createSenderSocket=function _createSenderSocket(e,t){var r=t,n=require("dgram").createSocket("udp4");n.on("listening",function(){DMX4ALL._logger.log("trace","sender socket started:"+e),n.setBroadcast(!0),r&&(r(null,n),r=null);}),n.on("error",function(e){r&&(r(e),r=null);}),n.bind(null,e);};if(t){this._discoveryCallback||(this._discoveryCallback=[]);for(var n=!1,a=0;a<this._discoveryCallback.length;a++){if(this._discoveryCallback[a]===t){n=!0;break;}}if(n||this._discoveryCallback.push(t),!this._discoverRunning){this._discoverResults={},this._discoverRunning=!0;var i,s,o=this._discoverResults,u=this;!function(e,t){var r=require("dgram"),n=t,a=r.createSocket("udp4");a.on("listening",function(){DMX4ALL._logger.log("trace","listener socket started"),a.setBroadcast(!0),n&&(n(null,a),n=null);}),a.on("message",function(t,r){e(t,r);}),a.on("error",function(e){n?(DMX4ALL._logger.log("warn","create listener socket error:"+e),n(e),n=null):DMX4ALL._logger.log("warn","listener socket error:"+e);}),a.bind(6454);}(function(e){var t=e.toString("hex"),r=t.substr(0,16);if(t.length>16&&"4172742d4e657400"==r.toLowerCase()&&(r=t.substr(16,4),t.length>20&&"0021"==r.toLowerCase()&&t.length>28)){var n=parseInt(t.substr(20,2),16)+"."+parseInt(t.substr(22,2),16)+"."+parseInt(t.substr(24,2),16)+"."+parseInt(t.substr(26,2),16);r=t.substr(48,4),t.length>52&&"1a2c"==r.toLowerCase()&&(r=t.substr(52,36),t.length>88&&"4172744e65742d4c45442044696d6d657200"==r.toLowerCase()&&(o[n]=new DMX4ALL(n)));}},function(t,r){if(t){for(var n=0;n<u._discoveryCallback.length;n++){u._discoveryCallback[n](t);}u._discoverRunning=!1;}else i=r,function(e){var t=[],r=[],n=require("os");if(require("dgram"),n&&n.networkInterfaces){var a=n.networkInterfaces();for(var i in a){if(a.hasOwnProperty(i))for(var s=a[i],o=0;o<s.length;o++){"IPv4"==s[o].family&&0==s[o].internal&&t.push(s[o].address);}}}else t.push("0.0.0.0");for(var u=0,l=0;l<t.length;l++){var c=t[l];"0.0.0.0"==c&&(c=null),_createSenderSocket(c,function(n,a){u++,!n&&a&&r.push(a),u==t.length&&e&&e(null,r);});}}(function(t,r){if(t){for(var n=0;n<u._discoveryCallback.length;n++){u._discoveryCallback[n](t);}return u._discoverRunning=!1,void i.end();}!function(e,t){if(0!=e.length)for(var r=new Buffer([65,114,116,45,78,101,116,0,0,32,0,14,0,0]),n=0,a=0;a<e.length;a++){e[a].send(r,0,r.length,6454,"255.255.255.255",function(){++n==e.length&&t();});}else t();}(s=r,function(){setTimeout(function(){for(var e=0;e<s.length;e++){s[e].close();}i.close();for(var t=0;t<u._discoveryCallback.length;t++){var r=[];for(var n in u._discoverResults){u._discoverResults.hasOwnProperty(n)&&r.push(u._discoverResults[n]);}u._discoveryCallback[t](null,r);}u._discoverRunning=!1,u._discoveryCallback=[];},e);});});});}}},DMX4ALL.parseJSON=function(e){return e.ip?new DMX4ALL(e.ip,e.port):null;},DMX4ALL;}(),xnm.aio.rgb.DMX4ALL.DM=function(){var e={command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"int",name:"red",ref:{value:"red",ext:"%d",extMeta:"0-255"}},{type:"int",name:"green",ref:{value:"green",ext:"%d",extMeta:"0-255"}},{type:"int",name:"blue",ref:{value:"blue",ext:"%d",extMeta:"0-255"}},{type:"int",name:"white",ref:{value:"white",ext:"%d",extMeta:"0-255"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100"}},{type:"string",name:"rgb+white color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}}]};return{SYS:"dmx4all",registModule:function registModule(e){e.register(this.SYS,"rgb");},getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"DMX4ALL"};},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(){return e;}};}(),xnm.aio.rgb.MiLight=function(){var MiLight=function MiLight(e,t,r){var n=require("x.logger.js");this._logger=n?n.getLogger("xnm.aio.rgb.MiLight"):{log:function log(){}},this.ip=e,this.port=t,this.port||(this.port=8899),this.uuid=r;};return MiLight.prototype._doRequest=function(e,t){this._logger.log("trace","send to "+this.ip+" data:"+JSON.stringify(e));var r=require("dgram"),n=new Buffer(e),a=r.createSocket("udp4"),i=this;a.send(n,0,n.length,this.port,this.ip,function(e){e&&i._logger.log("warn","send data error:"+e.message),a.close(),t&&setTimeout(function(){t(e);},250);});},MiLight.prototype.executeCommand=function(e,t,r){if(e&&e.type&&null!=t&&void 0!==t)switch(e.type){case"easy_rgbw":case"easy_white":if(null==e.address||void 0===e.address)return void(r&&r(new Error("address invalid")));"easy_rgbw"==e.type?this._execEasyRGBW(e.address,t,r):this._execEasyWhite(e.address,t,r);break;case"rgb":this._execRGB(t,r);break;default:r&&r(new Error(e.type+" not supported"));}else r&&r(new Error("argument invalid"));},MiLight.prototype.executeCommandCreator=function(e,t,r){if(e&&e.type&&t){var n=t.value;switch(e.type){case"easy_rgbw":case"easy_white":switch(t.value){case"brightness":case"rgbS":case"rgb":n=t.ext;}break;case"rgb":switch(t.value){case"rgbS":case"rgb":n=t.ext;}}null!=n&&void 0!==n?this.executeCommand(e,n,function(e){r&&r(e);}):r&&r(new Error("command invalid"));}else r&&r(new Error("argument invalid"));},MiLight.prototype._execEasyRGBW=function(e,t,r){var n,a=this;switch(t){case"speedDown":case"speedUp":case"discoMode":case"on":case"off":n=this._buildEasyRGBWData(e,t),this._doRequest(n,r);break;default:"white"==t||6==t.length||parseInt(t)>=0&&parseInt(t)<=100?(n=this._buildEasyRGBWData(e,"on"),this._doRequest(n,function(i){i?r&&r(i):(n=a._buildEasyRGBWData(e,t),setTimeout(function(){a._doRequest(n,r);},100));})):r&&r(new Error("no such command"));}},MiLight.prototype._buildEasyRGBWData=function(e,t){e=parseInt(e);var r,n=[255,0,85];switch(t){case"speedDown":n[0]=67;break;case"speedUp":n[0]=68;break;case"discoMode":n[0]=77;break;case"on":switch(e){case 0:n[0]=66;break;case 1:n[0]=69;break;case 2:n[0]=71;break;case 3:n[0]=73;break;case 4:n[0]=75;}break;case"off":switch(e){case 0:n[0]=65;break;case 1:n[0]=70;break;case 2:n[0]=72;break;case 3:n[0]=74;break;case 4:n[0]=76;}break;case"white":switch(e){case 0:n[0]=194;break;case 1:n[0]=197;break;case 2:n[0]=199;break;case 3:n[0]=201;break;case 4:n[0]=203;}break;default:if(6==t.length){var a=parseInt(t.substr(0,2),16),i=parseInt(t.substr(2,2),16),s=parseInt(t.substr(4,2),16),o=0,u=85,l=s,c=i;if(s<=a&&s<=i?(l=i,c=a,o=86,u=170):i<=a&&i<=s&&(l=a,c=s,o=171,u=255),r=255==l?o+c/255*((u-o)/2):u-l/255*((u-o)/2),(r+=10)>255&&(r-=255),0==a&&0==i&&0==s)return this._buildEasyRGBWData(e,"off");n[0]=64,n[1]=r;}else if(parseInt(t)>=0&&parseInt(t)<=100){if((r=Math.round(parseInt(t)/100*26)+1)<1?r=1:r>27&&(r=27),1==r)return this._buildEasyRGBWData(e,"off");n[0]=78,n[1]=r;}}return 255==n[0]?null:n;},MiLight.prototype._execEasyWhite=function(e,t,r){var n,a=this;switch(t){case"briUp":case"briDown":case"warmUp":case"coolUp":case"on":case"off":n=this._buildEasyWhiteData(e,t),this._doRequest(n,r);break;case"night":case"fullbri":n="night"==t?this._buildEasyWhiteData(e,"off"):this._buildEasyWhiteData(e,"on"),this._doRequest(n,function(i){i?r&&r(i):(n=a._buildEasyWhiteData(e,t),setTimeout(function(){a._doRequest(n,r);},100));});break;default:r&&r(new Error("no such command"));}},MiLight.prototype._buildEasyWhiteData=function(e,t){e=parseInt(e);var r=[255,0,85];switch(t){case"briUp":r[0]=60;break;case"briDown":r[0]=52;break;case"warmUp":r[0]=62;break;case"coolUp":r[0]=63;break;case"on":switch(e){case 0:r[0]=53;break;case 1:r[0]=56;break;case 2:r[0]=61;break;case 3:r[0]=55;break;case 4:r[0]=50;}break;case"off":switch(e){case 0:r[0]=57;break;case 1:r[0]=59;break;case 2:r[0]=51;break;case 3:r[0]=58;break;case 4:r[0]=54;}break;case"night":switch(e){case 0:r[0]=185;break;case 1:r[0]=187;break;case 2:r[0]=179;break;case 3:r[0]=186;break;case 4:r[0]=182;}break;case"fullbri":switch(e){case 0:r[0]=181;break;case 1:r[0]=184;break;case 2:r[0]=189;break;case 3:r[0]=183;break;case 4:r[0]=178;}}return 255==r[0]?null:r;},MiLight.prototype._execRGB=function(e,t){var r,n=this;switch(e){case"speedDown":case"speedUp":case"briUp":case"briDown":case"modeUp":case"modeDown":case"on":case"off":r=this._buildRGBData(e),this._doRequest(r,t);break;default:6==e.length?(r=this._buildRGBData("on"),this._doRequest(r,function(a){a?t&&t(a):(r=n._buildRGBData(e),setTimeout(function(){n._doRequest(r,t);},100));})):t&&t(new Error("no such command"));}},MiLight.prototype._buildRGBData=function(e){var t=[255,0,85];switch(e){case"off":t[0]=33;break;case"on":t[0]=34;break;case"briUp":t[0]=35;break;case"briDown":t[0]=36;break;case"speedUp":t[0]=37;break;case"speedDown":t[0]=38;break;case"modeUp":t[0]=39;break;case"modeDown":t[0]=40;break;default:if(6==e.length){var r,n=parseInt(e.substr(0,2),16),a=parseInt(e.substr(2,2),16),i=parseInt(e.substr(4,2),16),s=0,o=85,u=i,l=a;if(i<=n&&i<=a?(u=a,l=n,s=86,o=170):a<=n&&a<=i&&(u=n,l=i,s=171,o=255),r=255==u?s+l/255*((o-s)/2):o-u/255*((o-s)/2),(r+=10)>255&&(r-=255),0==n&&0==a&&0==i)return this._buildRGBData("off");t[0]=32,t[1]=r;}}return 255==t[0]?null:t;},MiLight.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rgb.MiLight&&this.ip==e.ip&&this.port==e.port;},MiLight.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLight.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},MiLight.parseJSON=function(e){return e.ip?new MiLight(e.ip,e.port,e.uuid):null;},MiLight;}(),xnm.aio.rgb.MiLight.Discovery=function(){var Discovery=function Discovery(){var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.rgb.MiLight.Discovery"):{log:function log(){}},this._searching=!1,this._tempCallbacks=[],this._callbacks=[],this._controllers={},this._sockets=[];var t=require("os");require("dgram");if(t&&t.networkInterfaces){var r=t.networkInterfaces();for(var n in r){if(r.hasOwnProperty(n))for(var a=r[n],i=0;i<a.length;i++){this._addDiscoverSocket(48899,a[i]);}}}else this._addDiscoverSocket(48899,null);};return Discovery.prototype.discoverDevices=function(e){this._addCallback(e,this._callbacks),this._sendDiscoveryMessages();},Discovery.prototype.discoverWithTimeout=function(e,t){this._addCallback(t,this._tempCallbacks),this._searching||(this._controllers={},this._searching=!0,this._sendDiscoveryMessages());var r=this;setTimeout(function(){r._removeCallback(t,r._tempCallbacks);var e=[];for(var n in r._controllers){r._controllers.hasOwnProperty(n)&&r._controllers[n]&&e.push(r._controllers[n]);}t(e),0==r._tempCallbacks.length&&(r._searching=!1);},e);},Discovery.prototype._addCallback=function(e,t){if(e)for(var r=0;r<t.length;r++){if(t[r]===e)return;}t.push(e);},Discovery.prototype._removeCallback=function(e,t){if(e){for(var r=-1,n=0;n<t.length;n++){if(t[n]===e){r=n;break;}}-1!=r&&t.splice(r,1);}},Discovery.prototype._addDiscoverSocket=function(e,t){var r,n=require("dgram"),a=this;try{r=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){r=n.createSocket("udp4");}t?"IPv4"==t.family&&0==t.internal&&(r.on("listening",function(){r.setBroadcast(!0);}),r.on("message",function(e,t){a._receivedData(t.address,e);}),r.on("error",function(e){a._logger.log("warn","milight listener error on address:"+t.address+" mesage:"+(e?e.message:null));}),r.bind(e,t.address),this._logger.log("start listener on address:"+t.address+"-port:"+e),this._sockets.push(r)):(r.on("message",function(e,t){a._receivedData(t.address,e);}),r.on("error",function(e){a._logger.log("warn","milight listener error:"+(e?e.message:null));}),r.bind(e),this._logger.log("debug","start listener on address:[ANY]-port:"+e),this._sockets.push(r));},Discovery.prototype._receivedData=function(e,t){"object"==_typeof(t)&&(t=t.toString()),this._logger.log("trace","receive discovery response:"+t);var r=t.split(",");if(r.length>=2){var n=r[0],a=r[1],i=r[2];if(n&&a){var s;s=i?new xnm.aio.rgb.MiLightV6(n,null,a):new xnm.aio.rgb.MiLight(n,null,a),this._controllers[a]=s;for(var o=0;o<this._callbacks.length;o++){this._callbacks[o]&&this._callbacks[o](s);}}}},Discovery.prototype._sendDiscoveryMessages=function(){for(var e="Link_Wi-Fi",t=0;t<this._sockets.length;t++){this._sockets[t].send(e,0,e.length,48899,"255.255.255.255");}e="HF-A11ASSISTHREAD";for(t=0;t<this._sockets.length;t++){this._sockets[t].send(e,0,e.length,48899,"255.255.255.255");}},Discovery;}(),xnm.aio.rgb.MiLight.DM={SYS:"milight",MAP:{easy_rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]},easy_rgbw_all:{command:[{type:"enum",name:"disco mode",ref:{value:"discoMode"}},{type:"enum",name:"disco speed up",ref:{value:"speedUp"}},{type:"enum",name:"disco speed down",ref:{value:"speedDown"}}]},easy_white:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night mode",ref:{value:"night"}},{type:"enum",name:"full brightness",ref:{value:"fullbri"}}]},easy_white_all:{command:[{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"warm white up",ref:{value:"warmUp"}},{type:"enum",name:"cool white up",ref:{value:"coolUp"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}}]}},registModule:function registModule(e){e.register(this.SYS,"rgb");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Mi.Light Controller (WiFi)",port:8899};},getGatewayDeviceType:function getGatewayDeviceType(e){return e.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"MultiZone RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"MultiZone White Bulb"},{sys:this.SYS,type:"rgb",name:"SingleZone RGB Bulb"}]:null;},createGateway:function createGateway(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,n){var a=xnm.aio.rgb.DMError,i=xnm.aio.rgb.DMError.ERROR_CODE;t?t.ip?n(null,t):n(new a(i.INVALID,"ip is invalid")):n(new a(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,r){r();},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if("easy_rgbw"!=e.type&&"easy_white"!=e.type||null!=e.address&&void 0!==e.address){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,s,o=t.data.gateways;for(i=0;i<o.length;i++){if(o[i].index===e.gateway){s=o[i];break;}}s?r(null,e):r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.INVALID,"address is invalid"));}else r(new n(a.INVALID,"type is invalid"));}else r(new n(a.INVALID,"gateway is invalid"));}else r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if("easy_rgbw"!=e.type&&"easy_white"!=e.type||null!=e.address&&void 0!==e.address){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,s,o=t.data.gateways;for(i=0;i<o.length;i++){if(o[i].index===e.gateway){s=o[i];break;}}s?r(null,e):r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.INVALID,"address is invalid"));}else r(new n(a.INVALID,"type is invalid"));}else r(new n(a.INVALID,"gateway is invalid"));}else r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(e){if(!e)return null;var t,r=null;switch(e.type){case"easy_rgbw":r=JSON.parse(JSON.stringify(this.MAP.easy_rgbw)),0==parseInt(e.address)&&(t=JSON.parse(JSON.stringify(this.MAP.easy_rgbw_all)),r.command=r.command.concat(t.command));break;case"easy_white":r=JSON.parse(JSON.stringify(this.MAP.easy_white)),0==parseInt(e.address)&&(t=JSON.parse(JSON.stringify(this.MAP.easy_white_all)),r.command=r.command.concat(t.command));break;case"rgb":r=JSON.parse(JSON.stringify(this.MAP.rgb));}return r;}},xnm.aio.rgb.MiLightV6=function(){var e={bridges:{},socket:null,init:function init(){var _this=this;this.socket?(this.socket.close(),setTimeout(function(){_this.socket=new UdpSocket(_this);},1e3)):this.socket=new UdpSocket(this);},receiveData:function receiveData(e,t){var r=this.bridges[e];r&&r.receiveData(t);},getBridge:function getBridge(e){return this.bridges[e];},setBridge:function setBridge(e,t){this.bridges[e]=t;},sendPacket:function sendPacket(e,t,r){this.socket&&this.socket.sendPacket(e,t,r);}},UdpSocket=function UdpSocket(e){var t=require("x.logger.js");this._logger=t?t.getLogger("xnm.aio.rgb.MiLightV6.UdpSocket"):{log:function log(){}},this._listener=e,this._sockets=[];var r=require("os");require("dgram");if(r&&r.networkInterfaces){var n=r.networkInterfaces();for(var a in n){if(n.hasOwnProperty(a))for(var i=n[a],s=0;s<i.length;s++){this._addDiscoverSocket(5987,i[s]);}}}else this._addDiscoverSocket(5987,null);};UdpSocket.prototype.close=function(){this._sockets.forEach(function(e){return e.close();}),this._sockets=[];},UdpSocket.prototype._receivedData=function(e,t){t=t.toString("hex"),t=new Buffer(t,"hex"),this._listener&&this._listener.receiveData(e,t);},UdpSocket.prototype._addDiscoverSocket=function(e,t){var r,n=require("dgram"),a=this;if(t){if("IPv4"==t.family&&0==t.internal){try{r=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){r=n.createSocket("udp4");}r.on("listening",function(){r.setBroadcast(!0);}),r.on("message",function(e,t){a._receivedData(t.address,e);}),r.on("error",function(r){a._logger.log("error","udp socket at"+e+"@"+t.address+" error:"+r.message);}),r.bind(e,t.address),this._sockets.push(r);}}else{try{r=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){r=n.createSocket("udp4");}r.on("message",function(e,t){a._receivedData(t.address,e);}),r.on("error",function(t){a._logger.log("error","udp socket at"+e+" error:"+t.message);}),r.bind(e),this._sockets.push(r);}},UdpSocket.prototype.sendPacket=function(e,t,r){for(var n=0;n<this._sockets.length;n++){this._sockets[n].send(e,0,e.length,r,t);}};var MiLightV6=function MiLightV6(t,r,n){var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.rgb.MiLightV6"):{log:function log(){}},this.ip=t,this.port=r,this.port||(this.port=5987),this.uuid=n,e.getBridge(t)||e.setBridge(t,this),this._packetBuffer=[],this._sessionCreating=!1,this._sessionCreateTimeout=null,this._session=null,this._seqNo=-1;};return MiLightV6.prototype.executeCommandCreator=function(e,t,r){if(e&&e.type&&t){var n;switch(e.type){case"wifi_box":n=this._buildWifiBoxCommand(t.value,t.ext);break;case"rgb":n=this._buildRGBCommand(t.value,t.ext);break;case"rgbw":if(void 0===e.address||null==e.address)return void(r&&r(new Error("device has no address")));n=this._buildRGBWCommand(e.address,t.value,t.ext);break;case"rgbww_cw":if(void 0===e.address||null==e.address)return void(r&&r(new Error("device has no address")));n=this._buildRGBWWCommand(e.address,t.value,t.ext);break;case"ww_cw":if(void 0===e.address||null==e.address)return void(r&&r(new Error("device has no address")));n=this._buildWWCommand(e.address,t.value,t.ext);}n?this.sendCommand(n,function(e){r&&r(e);}):r&&r(new Error("command invalid"));}else r&&r(new Error("argument invalid"));},MiLightV6.prototype._buildWifiBoxCommand=function(e,t){var r=[49,0,0,0,255,255,0,0,0,1];switch(e){case"on":r[4]=3,r[5]=3;break;case"off":r[4]=3,r[5]=4;break;case"white":r[4]=3,r[5]=5;break;case"speedUp":r[4]=3,r[5]=2;break;case"speedDown":r[4]=3,r[5]=1;break;case"mode":if(!r)return null;r[4]=4,r[5]=parseInt(t);break;case"brightness":r[4]=2,r[5]=parseInt(t);break;case"rgb":case"rgbS":if(!t||t.length<6)return null;var n=parseInt(t.substr(0,2),16),a=parseInt(t.substr(2,2),16),i=parseInt(t.substr(4,2),16),s=xnm.aio.rgb.Util.rgbToHue(n,a,i);(s=255-(s=Math.min(Math.max(s,0),255))-82)<0&&(s=255+s),r[4]=1,r[5]=s,r[6]=s,r[7]=s,r[8]=s;break;default:return null;}return r;},MiLightV6.prototype._buildRGBWWCommand=function(e,t,r){var n=[49,0,0,8,255,255,0,0,0,255];switch(n[9]=parseInt(e),t){case"on":n[4]=4,n[5]=1;break;case"off":n[4]=4,n[5]=2;break;case"night":n[4]=4,n[5]=5;break;case"white":n[4]=5,n[5]=100;break;case"speedUp":n[4]=4,n[5]=3;break;case"speedDown":n[4]=4,n[5]=4;break;case"mode":if(!n)return null;n[4]=6,n[5]=parseInt(r);break;case"brightness":n[4]=3,n[5]=parseInt(r);break;case"saturation":n[4]=2,n[5]=parseInt(r);break;case"kelvin":n[4]=5;var a=(parseInt(r)-2700)/18;a<0&&(a=0),a>100&&(a=100),n[5]=a;break;case"rgb":case"rgbS":if(!r||r.length<6)return null;var i=parseInt(r.substr(0,2),16),s=parseInt(r.substr(2,2),16),o=parseInt(r.substr(4,2),16),u=xnm.aio.rgb.Util.rgbToHue(i,s,o);(u=255-(u=Math.min(Math.max(u,0),255))-82)<0&&(u=255+u),n[4]=1,n[5]=u,n[6]=u,n[7]=u,n[8]=u;break;default:return null;}return n;},MiLightV6.prototype._buildRGBWCommand=function(e,t,r){var n=[49,0,0,7,255,255,0,0,0,255];switch(n[9]=parseInt(e),t){case"on":n[4]=3,n[5]=1;break;case"off":n[4]=3,n[5]=2;break;case"night":n[4]=3,n[5]=6;break;case"white":n[4]=3,n[5]=5;break;case"speedUp":n[4]=3,n[5]=3;break;case"speedDown":n[4]=3,n[5]=4;break;case"mode":if(!n)return null;n[4]=4,n[5]=parseInt(r);break;case"brightness":n[4]=2,n[5]=parseInt(r);break;case"rgb":case"rgbS":if(!r||r.length<6)return null;var a=parseInt(r.substr(0,2),16),i=parseInt(r.substr(2,2),16),s=parseInt(r.substr(4,2),16),o=xnm.aio.rgb.Util.rgbToHue(a,i,s);(o=255-(o=Math.min(Math.max(o,0),255))-55)<0&&(o=255+o),n[4]=1,n[5]=o,n[6]=o,n[7]=o,n[8]=o;break;default:return null;}return n;},MiLightV6.prototype._buildRGBCommand=function(e,t){var r=[49,0,0,5,255,255,0,0,0,1];switch(e){case"on":r[4]=2,r[5]=9;break;case"off":r[4]=2,r[5]=10;break;case"briUp":r[4]=2,r[5]=1;break;case"briDown":r[4]=2,r[5]=2;break;case"speedUp":r[4]=2,r[5]=3;break;case"speedDown":r[4]=2,r[5]=4;break;case"modeUp":r[4]=2,r[5]=5;break;case"modeDown":r[4]=2,r[5]=6;break;case"rgb":case"rgbS":if(!t||t.length<6)return null;var n=parseInt(t.substr(0,2),16),a=parseInt(t.substr(2,2),16),i=parseInt(t.substr(4,2),16),s=xnm.aio.rgb.Util.rgbToHue(n,a,i);(s=255-(s=Math.min(Math.max(s,0),255))-55)<0&&(s=255+s),r[4]=1,r[5]=s,r[6]=s,r[7]=s,r[8]=s;break;default:return null;}return r;},MiLightV6.prototype._buildWWCommand=function(e,t,r){var n=[49,0,0,1,255,255,0,0,0,255];switch(n[9]=parseInt(e),t){case"on":n[4]=1,n[5]=7;break;case"off":n[4]=1,n[5]=8;break;case"night":n[4]=1,n[5]=6;break;case"briUp":n[4]=1,n[5]=1;break;case"briDown":n[4]=1,n[5]=2;break;case"briMax":n[4]=129,n[5]=7;break;case"warmer":n[4]=1,n[5]=3;break;case"cooler":n[4]=1,n[5]=4;break;default:return null;}return n;},MiLightV6.prototype.sendCommand=function(e,t){this._logger.log("trace","start send command");var r=this._packetBuffer.length;this._packetBuffer.push({command:e,callback:t}),null!=this._session||this._sessionCreating?this._session&&0==r&&this._sendNextPacket():this._createSession();},MiLightV6.prototype._buildPacket=function(e,t,r){var n=[128,0,0,0,17,255,255,0,255,0,255,255,255,255,255,255,255,255,255,255,0,255];n[5]=t[0],n[6]=t[1],n[8]=r;for(var a=0;a<e.length;a++){n[10+a]=e[a];}for(var i=0,s=0;s<e.length;s++){i+=e[s];}return n[21]=255&i,new Buffer(n);},MiLightV6.prototype._sendNextPacket=function(){if(this._packetBuffer.length>0){var t=this._packetBuffer[0];if(t){if(t.command){var r=this._buildPacket(t.command,this._session,this._seqNo++);this._logger.log("trace","send command:"+r.toString("hex")),e.sendPacket(r,this.ip,this.port);}t.callback&&t.callback();}this._packetBuffer.splice(0,1),this._sendNextPacket();}else this._sessionCreating=!1,this._sessionCreateTimeout=null,this._session=null,this._seqNo=-1;},MiLightV6.prototype._cancelAllPacket=function(){this._logger.log("trace","cancelling all packets, could not create a session");var e=this._packetBuffer;this._packetBuffer=[];for(var t=0;t<e.length;t++){var r=e[t];r&&r.callback&&r.callback(new Error("can not create session"));}},MiLightV6.prototype._createSession=function(){if(!this._sessionCreating){this._sessionCreating=!0;var t=this,r=new Buffer([32,0,0,0,22,2,98,58,213,237,163,1,174,8,45,70,97,65,167,246,220,175,211,230,0,0,30]);this._logger.log("trace","start session:"+r.toString("hex")),e.sendPacket(r,this.ip,this.port),setTimeout(function(){t._sessionCreated(!1);},2e3);}},MiLightV6.prototype._sessionCreated=function(e){e?(this._logger.log("trace","session created"),this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._seqNo=0,this._sendNextPacket()):(this._sessionCreating=!1,this._sessionCreateTimeout&&(clearTimeout(this._sessionCreateTimeout),this._sessionCreateTimeout=null),this._session=null,this._seqNo=-1,this._cancelAllPacket());},MiLightV6.prototype.receiveData=function(e){if(this._logger.log("trace","receive ("+this.ip+") data:"+e.toString("hex")),40==e[0]){this._session=[];for(var t=19;t<21;t++){this._session.push(e[t]);}this._logger.log("trace","get session id:"+new Buffer(this._session).toString("hex")),this._sessionCreated(!0);}},MiLightV6.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rgb.MiLightV6&&this.ip==e.ip&&this.port==e.port;},MiLightV6.prototype.toJSON=function(){return{sys:xnm.aio.rgb.MiLightV6.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},MiLightV6.parseJSON=function(t){if(!t.ip)return null;var r=new MiLightV6(t.ip,t.port,t.uuid),n=e.getBridge(t.ip);return n||r;},MiLightV6.init=function(){e.init();},MiLightV6;}(),xnm.aio.rgb.MiLightV6.DM={SYS:"milightv6",MAP:{wifi_box:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},ww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"enum",name:"max brightness",ref:{value:"briMax"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"warmer",ref:{value:"warmer"}},{type:"enum",name:"cooler",ref:{value:"cooler"}}]},rgbww_cw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"saturation",ref:{value:"saturation",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"int",name:"kelvin",ref:{value:"kelvin",ext:"%d",extMeta:"2700-6500",scale:"18"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"night light on",ref:{value:"night"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100",scale:"1"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"int",name:"mode",ref:{value:"mode",ext:"%d",extMeta:"1-9",scale:"1"}}]},rgb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"brightness up",ref:{value:"briUp"}},{type:"enum",name:"brightness down",ref:{value:"briDown"}},{type:"string",name:"RGB color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"RGB color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"speed up",ref:{value:"speedUp"}},{type:"enum",name:"speed down",ref:{value:"speedDown"}},{type:"enum",name:"mode up",ref:{value:"modeUp"}},{type:"enum",name:"mode down",ref:{value:"modeDown"}}]}},registModule:function registModule(e){e.register(this.SYS,"rgb");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Mi.Light iBox",port:5987};},getGatewayDeviceType:function getGatewayDeviceType(e){return e.sys==this.SYS?[{sys:this.SYS,type:"wifi_box",name:"WIFI Box"},{sys:this.SYS,type:"rgbww_cw",name:"RGBWW/CW Bulb"},{sys:this.SYS,type:"rgbw",name:"RGBW Bulb"},{sys:this.SYS,type:"rgb",name:"RGB Bulb"},{sys:this.SYS,type:"ww_cw",name:"WW/CW Bulb"}]:null;},createGateway:function createGateway(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,n){var a=xnm.aio.rgb.DMError,i=xnm.aio.rgb.DMError.ERROR_CODE;t?t.ip?n(null,t):n(new a(i.INVALID,"ip is invalid")):n(new a(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,r){r();},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,s,o=t.data.gateways;for(i=0;i<o.length;i++){if(o[i].index===e.gateway){s=o[i];break;}}s?r(null,e):r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.INVALID,"type is invalid"));}else r(new n(a.INVALID,"gateway is invalid"));}else r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if("easy_rgbw"!=e.type&&"easy_white"!=e.type||null!=e.address&&void 0!==e.address){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,s,o=t.data.gateways;for(i=0;i<o.length;i++){if(o[i].index===e.gateway){s=o[i];break;}}s?r(null,e):r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new n(a.INVALID,"address is invalid"));}else r(new n(a.INVALID,"type is invalid"));}else r(new n(a.INVALID,"gateway is invalid"));}else r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(e){return e?this.MAP[e.type]:null;}},xnm.aio.rgb.EasyLED=function(){var EasyLED=function EasyLED(e,t,r){xnm.aio.rgb.MiLight.call(this,e,t,r);var n=require("x.logger.js");this._logger=n?n.getLogger("xnm.aio.rgb.EasyLED"):{log:function log(){}};};return(EasyLED.prototype=Object.create(xnm.aio.rgb.MiLight.prototype)).constructor=EasyLED,EasyLED.prototype.equalsTo=function(e){return!!e&&e instanceof EasyLED&&this.ip==e.ip&&this.port==e.port;},EasyLED.prototype.toJSON=function(){return{sys:xnm.aio.rgb.EasyLED.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},EasyLED.parseJSON=function(e){return e.ip?new EasyLED(e.ip,e.port,e.uuid):null;},EasyLED;}(),xnm.aio.rgb.EasyLED.DM={SYS:"easyled",registModule:function registModule(e){e.register(this.SYS,"rgb");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"EasyLED Controller (WiFi)",port:8899};},getGatewayDeviceType:function getGatewayDeviceType(e){return e.sys==this.SYS?[{sys:this.SYS,type:"easy_rgbw",name:"Easy RGB+W Bulb"},{sys:this.SYS,type:"easy_white",name:"Easy White Bulb"}]:null;},createGateway:function createGateway(e,t,r){xnm.aio.rgb.MiLight.DM.createGateway(e,t,r);},updateGateway:function updateGateway(e,t,r,n){xnm.aio.rgb.MiLight.DM.updateGateway(e,t,r,n);},deleteGateway:function deleteGateway(e,t,r){xnm.aio.rgb.MiLight.DM.deleteGateway(e,t,r);},createDevice:function createDevice(e,t,r){xnm.aio.rgb.MiLight.DM.createDevice(e,t,r);},updateDevice:function updateDevice(e,t,r){xnm.aio.rgb.MiLight.DM.updateDevice(e,t,r);},deleteDevice:function deleteDevice(e,t,r){xnm.aio.rgb.MiLight.DM.deleteDevice(e,t,r);},getCommandStatusMap:function getCommandStatusMap(e){return xnm.aio.rgb.MiLight.DM.getCommandStatusMap(e);}},xnm.aio.rgb.DMError=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="RgbDmError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},DMError;}(),xnm.aio.rgb.DM={getGatewayType:function getGatewayType(){var e=[];for(var t in xnm.aio.rgb){if(xnm.aio.rgb.hasOwnProperty(t)){var r=xnm.aio.rgb[t];if(r&&r.DM&&r.DM.getGatewayType){var n=r.DM.getGatewayType();n&&e.push(n);}}}return e;},getGatewayDeviceType:function getGatewayDeviceType(e){var t=[];for(var r in xnm.aio.rgb){if(xnm.aio.rgb.hasOwnProperty(r)){var n=xnm.aio.rgb[r];if(n&&n.DM&&n.DM.getGatewayDeviceType){var a=n.DM.getGatewayDeviceType(e);a&&(Array.isArray(a)?t=t.concat(a):t.push(a));}}}return t;},getIPDeviceType:function getIPDeviceType(e,t){var r=[];for(var n in xnm.aio.rgb){if(xnm.aio.rgb.hasOwnProperty(n)){var a=xnm.aio.rgb[n];if(a&&a.DM&&a.DM.getIPDeviceType){var i=a.DM.getIPDeviceType(e,t);i&&r.push(i);}}}return r;},_getSystem:function _getSystem(e){for(var t in xnm.aio.rgb){if(xnm.aio.rgb.hasOwnProperty(t)){var r=xnm.aio.rgb[t];if(r&&r.DM&&r.DM.SYS&&r.DM.SYS==e)return r;}}return null;},createGateway:function createGateway(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.createGateway?i.DM.createGateway(e,t,r):r&&r(new n(a.INVALID,"no such sys:"+e.sys));}else r&&r(new n(a.INVALID,"sys is invalid"));}else r&&r(new n(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,n){var a=xnm.aio.rgb.DMError,i=xnm.aio.rgb.DMError.ERROR_CODE;if(t){if(t.sys){var s=this._getSystem(t.sys);s&&s.DM&&s.DM.updateGateway?s.DM.updateGateway(e,t,r,n):n&&n(new a(i.INVALID,"no such sys:"+t.sys));}else n&&n(new a(i.INVALID,"sys is invalid"));}else n(new a(i.INVALID,"info is invalid"));},deleteGateway:function deleteGateway(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.deleteGateway?i.DM.deleteGateway(e,t,r):r&&r(new n(a.INVALID,"no such sys:"+e.sys));}else r&&r(new n(a.INVALID,"sys is invalid"));}else r();},createDevice:function createDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.createDevice?i.DM.createDevice(e,t,r):r&&r(new n(a.INVALID,"no such sys:"+e.sys));}else r&&r(new n(a.INVALID,"sys is invalid"));}else r&&r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.updateDevice?i.DM.updateDevice(e,t,r):r&&r(new n(a.INVALID,"no such sys:"+e.sys));}else r&&r(new n(a.INVALID,"sys is invalid"));}else r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){var n=xnm.aio.rgb.DMError,a=xnm.aio.rgb.DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.deleteDevice?i.DM.deleteDevice(e,t,r):r&&r(new n(a.INVALID,"no such sys:"+e.sys));}else r&&r(new n(a.INVALID,"sys is invalid"));}else r();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,n=0;n<e.length;n++){if(e[n]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var r,n=[],a=null;if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.getCommandStatusMap&&(r=i.DM.getCommandStatusMap(e));}return r&&(a=function(e,t,r){var n=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(r,0,t),n=n.concat(a)),n;};if(!e.sys)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter.call(this,e,t),r.command=n;break;case"status":n=_filter.call(this,e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;}},xnm.aio.rgb.Handler=function(){var Handler=function Handler(){this._milightDiscovery=new xnm.aio.rgb.MiLight.Discovery(),this.MiLightV6.init();};return Handler.prototype.devicemanager=xnm.aio.rgb.DM,Handler.prototype.MiLight=xnm.aio.rgb.MiLight,Handler.prototype.MiLightV6=xnm.aio.rgb.MiLightV6,Handler.prototype.EasyLED=xnm.aio.rgb.EasyLED,Handler.prototype.registModule=function(e){for(var t in xnm.aio.rgb){if(xnm.aio.rgb.hasOwnProperty(t)){var r=xnm.aio.rgb[t];r&&r.DM&&r.DM.registModule&&r.DM.registModule(e);}}},Handler.prototype.resolveDevice=function(e){switch(e.sys){case xnm.aio.rgb.WiFiLED2.DM.SYS:return xnm.aio.rgb.WiFiLED2.parseJSON(e);case xnm.aio.rgb.DMX4ALL.DM.SYS:return xnm.aio.rgb.DMX4ALL.parseJSON(e);case xnm.aio.rgb.ArtNetNode.DM.SYS:return xnm.aio.rgb.ArtNetNode.parseJSON(e);default:return null;}},Handler.prototype.resolveGateway=function(e){switch(e.sys){case xnm.aio.rgb.MiLight.DM.SYS:return xnm.aio.rgb.MiLight.parseJSON(e);case xnm.aio.rgb.MiLightV6.DM.SYS:return xnm.aio.rgb.MiLightV6.parseJSON(e);case xnm.aio.rgb.EasyLED.DM.SYS:return xnm.aio.rgb.EasyLED.parseJSON(e);default:return null;}},Handler.prototype.getDeviceCommands=function(e,t){var r=xnm.aio.rgb.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=r?r.command:[];t&&t(null,n);},Handler.prototype.doWifiLED2Command=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(null,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doDMX4ALLCommand=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(null,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.discoverDMX4ALLWithTimeout=function(e,t){xnm.aio.rgb.DMX4ALL._discovery(e,t);},Handler.prototype.doArtNetCommand=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(null,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doMilightCommand=function(e,t,r,n){var a=this.resolveGateway(e);a?a.executeCommandCreator(t,r,function(e){n&&n(e);}):n&&n(new Error("gateway json format invalid"));},Handler.prototype.discoverMilightWithTimeout=function(e,t){this._milightDiscovery.discoverWithTimeout(e,function(e){t&&t(null,e);});},Handler.prototype.doEasyLEDCommand=function(e,t,r,n){var a=this.resolveGateway(e);a?a.executeCommandCreator(t,r,function(e){n&&n(e);}):n&&n(new Error("gateway json format invalid"));},Handler.prototype.discoverEasyLEDWithTimeout=function(e,t){this._milightDiscovery.discoverWithTimeout(e,function(e){var r=[];if(e)for(var n=0;n<e.length;n++){e[n]&&r.push(new xnm.aio.rgb.EasyLED(e[n].ip,e[n].port,e[n].uuid));}t&&t(null,r);});},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rgb.Handler());