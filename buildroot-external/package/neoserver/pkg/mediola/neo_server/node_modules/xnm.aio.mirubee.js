var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.mirubee=xnm.aio.mirubee||{},xnm.aio.mirubee.Mirubee=function(){var e={},Mirubee=function Mirubee(t,n,i){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.mirubee.Mirubee"),this._protocol="https",this._ip="v5dev.mediola.com",this._port=443,this.username=t,this.password=n,this.id=i,this._statesBuffer=e,this._getDeviceStatesCBs={};};return Mirubee.prototype._putStatesBuffer=function(e,t){this._statesBuffer[e]={data:t,timestamp:new Date().getTime()};},Mirubee.prototype._getStatesBuffer=function(e){var t=this._statesBuffer[e];if(!t)return null;var n=new Date().getTime();return t.timestamp?n-t.timestamp>6e4?(delete this._statesBuffer[e],null):t.data:(delete this._statesBuffer[e],null);},Mirubee.prototype.connect=function(e,t,n){this._doJsonRequest("GET","/eapi/v1/mirubee/connect",{account:e,password:t},null,function(e,t){n&&n(e,t);});},Mirubee.prototype.disconenct=function(e){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/disconnect",{id:this.id},null,function(t,n){e&&e(t,n);}):e&&e(new Error("account not connected"));},Mirubee.prototype.getInfo=function(e){this._doJsonRequest("GET","/eapi/v1/mirubee/info",null,null,function(t,n){e&&e(t,n);});},Mirubee.prototype.getDevices=function(e){this.id?this._doJsonRequest("GET","/eapi/v1/mirubee/devices/"+this.id,null,null,function(t,n){if(t)e&&e(t);else{var i=[];if(n)for(var r in n){var s=n[r];s.sys="mirubee",i.push(s);}e&&e(t,i);}}):e&&e(new Error("account not connected"));},Mirubee.prototype.executeCommandCreator=function(e,t,n){n&&n();},Mirubee.prototype.getStatesCreator=function(e,t,n){if(this.id){if(t){if(0!=t.length){for(var i=[],r=0;r<t.length;r++){var s=t[r];s&&s.device&&s.device.id&&-1==i.indexOf(s.device.id)&&i.push(s.device.id);}this.getStates(i,function(e,i){if(e)n&&n(e);else{for(var r=[],s=0;s<t.length;s++){var a=t[s];if(a&&a.id){var o=null;a.device&&a.device.id&&a.status&&a.status.value&&(o=i[a.device.id])&&(o=o[a.status.value]),void 0!==o&&null!=o||(o="?"),r.push({id:a.id,status:o});}}n&&n(null,r);}});}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));}else n&&n(new Error("account not connected"));},Mirubee.prototype.getStates=function(e,t){if(e&&0!=e.length)for(var n={},i=e.length,r=0;r<e.length;r++){this.getDeviceStates(e[r],function(e,r,s){!e&&r&&(n[s]=r),0==--i&&t&&t(null,n);});}else t&&t(null,{});},Mirubee.prototype.getDeviceStates=function(e,t){var n=this._getStatesBuffer(e);if(n)t&&t(null,n,e);else{var i=this._getDeviceStatesCBs[e];i||(this._getDeviceStatesCBs[e]=[],i=this._getDeviceStatesCBs[e]);var r=i.length;if(i.push(t),!(r>0)){var s=this;this._getDeviceStates(e,function(t,n){var i=s._getDeviceStatesCBs[e];s._getDeviceStatesCBs[e]=[],!t&&n&&(n=s._resolveStates(n),s._putStatesBuffer(e,n));for(var r=0;r<i.length;r++){i[r]&&i[r](t,n,e);}});}}},Mirubee.prototype._resolveStates=function(e){return e&&e.measured&&(e.measuredStr=new Date(e.measured).toLocaleString()),e;},Mirubee.prototype._getDeviceStates=function(e,t){if(this.id){var n="/eapi/v1/mirubee/states/"+this.id+"/"+e;this._doJsonRequest("GET",n,null,null,function(e,n){t&&t(e,n);});}else t&&t(new Error("account not connected"));},Mirubee.prototype._doJsonRequest=function(e,t,n,i,r){this._doRequest(e,t,n,i,function(e,t){e?r&&r(e):t?t.XC_ERR?((e=new Error("error response:"+t.XC_ERR.msg)).code=t.XC_ERR.code,r&&r(e)):t.XC_SUC?r&&r(null,t.XC_SUC):r&&r(new Error("unknown response")):r&&r(new Error("invalid response"));});},Mirubee.prototype._doRequest=function(e,t,n,i,r){var s=t;s||(s="/");var a={};n&&(a=JSON.parse(JSON.stringify(n)));var o="";for(var u in a){a.hasOwnProperty(u)&&(o&&(o+="&"),o+=u+"="+encodeURIComponent(a[u]));}o&&(s+="?"+o);var l={host:this._ip,port:this._port,path:s,method:e,headers:{Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};this._logger.log("trace","do request:"+JSON.stringify(l)),(this.username||this.password)&&(l.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),l.headers.Authorization="Basic "+new Buffer((this.username?this.username:"")+":"+(this.password?this.password:"")).toString("base64")),i&&(l.headers["Content-Length"]=i.length);var c=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var d=this,f=r,p=c.request(l,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var n,i;if(d._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),200==e.statusCode)try{i=t?JSON.parse(t):null;}catch(e){n=e;}else n=new Error("http reponse:"+e.statusCode);f&&(f(n,i,e.statusCode),f=null);});});p.on&&p.on("error",function(e){d._logger.log("trace","do request error:"+e.message),f&&(f(e),f=null);}),p.setTimeout&&p.setTimeout(2e4,function(){d._logger.log("trace","do request timeout"),p.abort(),f&&(f(new Error("timeout")),f=null);}),i&&(this._logger.log("trace","do request send body:"+i),p.write(i)),p.end();},Mirubee.prototype.toJSON=function(){return{sys:"mirubee",username:this.username,password:this.password,id:this.id};},Mirubee.prototype.equalsTo=function(e){return!!e&&e instanceof Mirubee&&this.id==e.id&&this.username==e.username&&this.password==e.password;},Mirubee.parseJSON=function(e){return e.username?new Mirubee(e.username,e.password,e.id):null;},Mirubee;}(),xnm.aio.mirubee.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="mirubeeDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"mirubee",MAP:{meter:{channel:{status:[{type:"float",name:"power",ref:{value:"power",unit:"W"}},{type:"float",name:"voltage",ref:{value:"voltage",unit:"V"}},{type:"float",name:"current",ref:{value:"current",unit:"A"}},{type:"int",name:"last measured time",ref:{value:"measured"}},{type:"string",name:"last measured time (text)",ref:{value:"measuredStr"}},{type:"statistic",name:"energy statistic",ref:{value:"energy"}}]}}},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"mirubee (alfanar)"}];},createGateway:function createGateway(e,t,n){var i=DMError,r=DMError.ERROR_CODE;e?e.username?e.password?e.id?n(null,e):n(new i(r.INVALID,"id is invalid")):n(new i(r.INVALID,"password is invalid")):n(new i(r.INVALID,"username is invalid")):n(new i(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,i){var r=DMError,s=DMError.ERROR_CODE;t?t.username?t.password?t.id?i(null,t):i(new r(s.INVALID,"id is invalid")):i(new r(s.INVALID,"password is invalid")):i(new r(s.INVALID,"username is invalid")):i(new r(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var i=DMError,r=DMError.ERROR_CODE;if(e){if(e.id){if(e.gateway){var s,a,o=t.data.gateways;for(s=0;s<o.length;s++){if(o[s].index===e.gateway){a=o[s];break;}}a?n&&n(null,e):n(new i(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new i(r.INVALID,"gateway is invalid"));}else n(new i(r.INVALID,"id is invalid"));}else n(new i(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var i=DMError,r=DMError.ERROR_CODE;if(e){if(e.id){if(e.gateway){var s,a,o=t.data.gateways;for(s=0;s<o.length;s++){if(o[s].index===e.gateway){a=o[s];break;}}a?n(null,e):n(new i(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new i(r.INVALID,"gateway is invalid"));}else n(new i(r.INVALID,"id is invalid"));}else n(new i(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _contains=function _contains(e,t){if("*"==e)return!0;for(var n=!1,i=0;i<e.length;i++){if(e[i]==t){n=!0;break;}}return n;},_filter=function _filter(e,t){var i=[],r=null,s=xnm.aio.mirubee.DM.getCommandStatusMap(e,n);return s&&(r=function(e,t,n){var i=[];return"command"==n.catagory?e.command&&e.command.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}}):"status"==n.catagory&&e.status&&e.status.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}}),i;}(s,0,t),i=i.concat(r)),i;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e)),r=null;if("command"==t.catagory)r=_filter(e,t),i.command=r;else{if("status"!=t.catagory)return null;r=_filter(e,t),i.status=r;}return r&&0!=r.length?i:null;},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e||!e.id)return null;if(e.id.split(":").length<3)return null;var n={status:[]};return n.status=this.MAP.meter.channel.status,n;}};}(),xnm.aio.mirubee.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.mirubee.DM,Handler.prototype.Mirubee=xnm.aio.mirubee.Mirubee,Handler.prototype.registModule=function(e){e.register("mirubee","mirubee");},Handler.prototype.resolveGateway=function(e){return e?this.Mirubee.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),i=n?n.command:[];t&&t(null,i);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),i=n?n.status:[];t&&t(null,i);},Handler.prototype.doCommand=function(e,t,n,i){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){i&&i(e);}):i&&i(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,n,i,r){var s=this.resolveGateway(t);if(s){var a=[{id:e,device:n,status:i}];s.getStatesCreator(null,a,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.connect=function(e,t,n,i){var r=this.resolveGateway(e);r?r.connect(t,n,function(e,t){i&&i(e,t);}):i&&i(new Error("gateway json format invalid"));},Handler.prototype.disconnect=function(e,t){var n=this.resolveGateway(e);n?n.disconenct(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mirubee.Handler());