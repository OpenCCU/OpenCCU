var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.moehlenhoff=xnm.aio.moehlenhoff||{},xnm.aio.moehlenhoff.Alpha2Device=function(){var Alpha2Device=function Alpha2Device(e){this._address=e.address,this._name=e.name;};return Alpha2Device.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"};},Alpha2Device;}(),xnm.aio.moehlenhoff.Alpha2HeatArea=function(){var Alpha2HeatArea=function Alpha2HeatArea(e){this._address=e.address,this._dpt=e.dpt,this._name=e.name,this._number=e.number,this._iodevice=e.iodevice;};return Alpha2HeatArea.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice};},Alpha2HeatArea;}(),xnm.aio.moehlenhoff.Alpha2=function(){var Alpha2=function Alpha2(e,t){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.moehlenhoff.Alpha2"),this._ip=e,this._port=t,(!this._port||this._port<0)&&(this._port=80);};return Alpha2.prototype.executeCommand=function(e,t,a){e=function(e){var t=e.address.split(":");return t.length>=2?{id:e.id,type:e.type,address:t[0],dpt:e.data,number:t[1]}:null;}(e),this._executeCommand(e,t,a);},Alpha2.prototype.getStates=function(e,t,a){var _getDevice=function _getDevice(e,t){if(!t||!t.Devices)return null;if(t.Devices.Device)return t.Devices.Device.ID==e?t.Devices.Device:null;if(t.Devices.Devices)for(var a=t.Devices.Devices,n=0;n<a.length;n++){var r=a[n];if(r.ID==e)return r;}return null;},_getHeatArea=function _getHeatArea(e,t){if(!t||!t.HEATAREAs)return null;for(var a=0;a<t.HEATAREAs.length;a++){var n=t.HEATAREAs[a];if(n.NUMBER==e)return n;}return null;},n=this;t=function(e){for(var t=[],a=0;a<e.length;a++){var n=e[a],r=n.address.split(":");if(r.length>=2){var i={id:n.id,type:n.type,address:r[0],dpt:n.data,number:r[1]};t.push(i);}}return t;}(t),this._getInfo(function(r,i){if(r)a&&a(r);else{var o,s;if(t&&e.setState)for(var u=0;u<t.length;u++){var l=t[u],f=_getDevice(l.address,i);if(f&&"HEATAREA"===l.dpt){var p=_getHeatArea(l.number,f);if(p)for(s in o=n._getStateValues(l,p,f)){o.hasOwnProperty(s)&&e.setState(l.id+":"+s,o[s]);}}}a&&a("OK");}});},Alpha2.prototype._executeCommand=function(e,t,a){if(e){if(e.address){if(t){var n,r,i='<?xml version="1.0" encoding="UTF-8"?><Devices><Device><ID>'+e.address+"</ID>%subdev</Device></Devices>";if("vac_off"==t?(n="<VACATION><VACATION_STATE>0</VACATION_STATE><START_DATE>2000-00-00</START_DATE><END_DATE>2000-00-00</END_DATE></VACATION>",i=i.replace("%subdev",n)):"vac_on"==t.name&&t.start&&t.end&&(n="<VACATION><VACATION_STATE>1</VACATION_STATE><START_DATE>"+t.start+"</START_DATE><END_DATE>"+t.end+"</END_DATE></VACATION>",i=i.replace("%subdev",n)),"HEATAREA"===e.dpt){if(null==e.number||void 0===e.number)return void(a&&a(new Error("device number invalid")));switch(r='<HEATAREA nr="'+e.number+'">%cmd</HEATAREA>',i=i.replace("%subdev",r),t){case"auto":n="<HEATAREA_MODE>0</HEATAREA_MODE>";break;case"day":n="<HEATAREA_MODE>1</HEATAREA_MODE>";break;case"night":n="<HEATAREA_MODE>2</HEATAREA_MODE>";break;default:if("string"==typeof t&&t.match(/^w_p/)){n="<PROGRAM_WEEK>"+t.replace("w_p","")+"</PROGRAM_WEEK>";break;}if("string"==typeof t&&t.match(/^we_p/)){n="<PROGRAM_WEEKEND>"+t.replace("we_p","")+"</PROGRAM_WEEKEND>";break;}var o;"number"==typeof t?o=t/5:t.match(/^[-+]?[0-9]*\.?[0-9]+$/)?o=parseFloat(t/5):a&&a(new Error("no such command")),o<5&&(o=5),o>30&&(o=30),n="<T_TARGET>"+o+"</T_TARGET>";}n&&(i=i.replace("%cmd",n));}this._doRequest({path:"/data/changes.xml",method:"POST"},i,function(e){a&&a(e);});}else a&&a(new Error("command invalid"));}else a&&a(new Error("device address invalid"));}else a&&a(new Error("device address format invalid"));},Alpha2.prototype._getStates=function(e){var t=this;this._getInfo(function(a,n){if(a)e&&e(a);else{var r=t._resolveInfo(n);e&&e(null,r);}});},Alpha2.prototype._resolveInfo=function(e){if(!e||!e.Devices)return null;var t,a=[];if(e.Devices.Device&&(t=this._resolveDevice(e.Devices.Device))&&a.push(t),e.Devices.Devices)for(var n=e.Devices.Devices,r=0;r<n.length;r++){var i=n[r];(t=this._resolveDevice(i))&&a.push(t);}return a;},Alpha2.prototype._resolveDevice=function(e){if(!e)return null;var t=this._getStateValues(null,null,e);if(!t)return null;if(t.id=e.ID,t.heatAreas=[],e.HEATAREAs)for(var a=0;a<e.HEATAREAs.length;a++){var n=e.HEATAREAs[a],r=this._getStateValues(null,n,e);r&&(r.number=n.NUMBER,t.heatAreas.push(r));}return t;},Alpha2.prototype.getDevices=function(e){this._getDevices(function(t,a){if(t)e&&e(t);else if(a){for(var n in a){if(a.hasOwnProperty(n))for(var r=a[n],i=0;i<r.length;i++){delete r[i]._deviceName;}}e&&e(null,a);}else e&&e(null,{});});},Alpha2.prototype._getDevices=function(e){this._getInfo(function(t,a){if(t)e&&e(t);else{var n={};if(a.Devices&&a.Devices.Devices){for(var r=a.Devices.Devices,i=0;i<r.length;i++){var o=r[i];if(o.ID){n[o.ID]=[];var s,u=o.NAME,l={};if(o.IODEVICEs)for(var f=0;f<o.IODEVICEs.length;f++){var p=o.IODEVICEs[f];p.HEATAREA_NR&&(l[p.HEATAREA_NR]=p);}if(o.HEATAREAs)for(var m=0;m<o.HEATAREAs.length;m++){var c=o.HEATAREAs[m];if(c.NUMBER){if(l[c.NUMBER])switch(s=l[c.NUMBER].IODEVICE_TYPE){case"1":case"3":case"4":s="analog";break;default:s="digital";}n[o.ID].push({type:"alpha2",address:o.ID,dpt:"HEATAREA",name:c.HEATAREA_NAME,number:c.NUMBER,iodevice:s,_deviceName:u});}}}}e&&e(null,n);}else e&&e(new Error("info format invalid"));}});},Alpha2.prototype._getStateValues=function(e,t,a,n){var r={},i="°C",o={};if(a){if(a.VACATION){if("0"===a.VACATION.VACATION_STATE)r.vacation="off";else r.vacation="on";a.VACATION.START_DATE&&(r.vacation_start_date=a.VACATION.START_DATE),a.VACATION.START_TIME&&(r.vacation_start_time=a.VACATION.START_TIME),a.VACATION.END_DATE&&(r.vacation_end_date=a.VACATION.END_DATE),a.VACATION.END_TIME&&(r.vacation_end_time=a.VACATION.END_TIME);}if(a.TEMPERATUREUNIT&&"0"!=a.TEMPERATUREUNIT&&(i="°F"),a.PROGRAM&&a.PROGRAM.SHIFT_PROGRAMs)for(var s=a.PROGRAM.SHIFT_PROGRAMs,u=0;u<s.length;u++){var l=s[u],f=l.NUMBER,p=l.START,m=l.END;f&&p&&m&&(r["prog_"+f]?r["prog_"+f]+=","+p+"-"+m:r["prog_"+f]=p+"-"+m);}if(a.IODEVICEs)for(var c=0;c<a.IODEVICEs.length;c++){var d=a.IODEVICEs[c];d.HEATAREA_NR&&(o[d.HEATAREA_NR]=d);}if(a.COOLING)switch(a.COOLING){case"0":r.cooling="off";break;case"1":r.cooling="on";}}if(t){switch(t.HEATAREA_MODE){case"0":r.mode="auto";break;case"1":r.mode="day";break;case"2":r.mode="night";}if(t.T_ACTUAL&&(r.actual_temp=parseFloat(t.T_ACTUAL),r.actual_temp_text=parseFloat(t.T_ACTUAL)+i),t.T_TARGET&&(r.target_temp=parseFloat(5*t.T_TARGET),r.target_temp_text=parseFloat(t.T_TARGET)+i),t.PROGRAM_WEEK&&(r.prog_week_0="inactive",r.prog_week_1="inactive",r.prog_week_2="inactive",r.prog_week_3="inactive",r["prog_week_"+parseInt(t.PROGRAM_WEEK)]="active"),t.PROGRAM_WEEKEND&&(r.prog_weekend_0="inactive",r.prog_weekend_1="inactive",r.prog_weekend_2="inactive",r.prog_weekend_3="inactive",r["prog_weekend_"+parseInt(t.PROGRAM_WEEKEND)]="active"),t.PARTY&&(r.party=parseInt(t.PARTY)),o&&o[t.NUMBER]){switch((n=o[t.NUMBER]).IODEVICE_TYPE){case"1":case"3":case"4":r.iodevice="analog";break;default:r.iodevice="digital";}if(n.BATTERY)switch(n.BATTERY){case"0":r.battery=0;break;case"1":r.battery=50;break;case"2":r.battery=100;}if(n.SIGNALSTRENGTH)switch(n.SIGNALSTRENGTH){case"0":r.signal=0;break;case"1":r.signal=50;break;case"2":r.signal=100;}}}return r;},Alpha2.prototype._getInfo=function(e){var t=this;this._doRequest({path:"/data/static.xml",method:"GET"},null,function(a,n){if(a)e&&e(a);else try{var r=$($.parseXML(n)),i=t._xml2json(r);e&&e(null,i);}catch(t){e&&e(t);}});},Alpha2.prototype._xml2json=function(e){var t=e.children();if(t&&t.length>0){for(var a={},n=0;n<t.length;n++){var r,i=$(t[n]),o=i.prop("tagName"),s=this._xml2json(i);if("HEATAREA"!=o&&"HEATCTRL"!=o&&"IODEVICE"!=o||null!=(r=i.attr("nr"))&&void 0!==r&&(s.NUMBER=r),"SHIFT_PROGRAM"==o){r=i.attr("nr");var u=i.attr("shiftingtime");null!=r&&void 0!==r&&(s.NUMBER=r),null!=u&&void 0!==u&&(s.SHIFINGTIME=u);}"Device"==o||"HEATAREA"==o||"HEATCTRL"==o||"IODEVICE"==o?(a[o+"s"]||(a[o+"s"]=[]),a[o+"s"].push(s)):a[o]&&!a[o+"s"]?(a[o+"s"]=[],a[o+"s"].push(a[o]),a[o+"s"].push(s),delete a[o]):!a[o]&&a[o+"s"]?a[o+"s"].push(s):a[o]=s;}return a;}return e.text();},Alpha2.prototype._doRequest=function(e,t,a){var n=a;e.host=this._ip,e.port=this._port,e.headers={"Content-Type":'text/xml; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"},"POST"==e.method&&t&&(e.headers["Content-Length"]=t.length);var r=this,i="",o=require("http").request(e,function(e){e.setEncoding("utf8"),e.on("data",function(e){i+=e;}),e.on("end",function(){var t;200!=e.statusCode&&(r._logger.log("warn","Failed to post request to "+r._ip+" with status code:"+e.statusCode),t=new Error("http request failed with status code:"+e.statusCode)),n&&(n(t,i),n=null);});});o.setTimeout(5e3),o.on("timeout",function(){n&&n(new Error("http timeout")),n=null;}),o.on&&"function"==typeof o.on&&o.on("error",function(e){n&&n(e),n=null;}),"POST"==e.method&&t&&o.write(t),o.end();},Alpha2.prototype.getDevicesCreator=function(e){this._getDevices(function(t,a){if(t)e&&e(t);else{var n={},r=[];if(a){for(var i in a){if(a.hasOwnProperty(i)){var o=a[i];if(o)for(var s=0;s<o.length;s++){var u=o[s];if(u){u.address&&!n[u.address]&&(n[u.address]=new xnm.aio.moehlenhoff.Alpha2Device(u),n[u.address]._name=u._deviceName,r.push(n[u.address]));var l=new xnm.aio.moehlenhoff.Alpha2HeatArea(u);r.push(l);}}}}e&&e(null,r);}}});},Alpha2.prototype.executeCommandCreator=function(e,t,a){if(e){if(t){var n=t.value;if("vac_on"==t.value){n={name:"vac_on"};for(var r=0;r<t.ext.length;r++){var i=t.ext[r];if(i)switch(i.value){case"start":n.start=i.ext;break;case"end":n.end=i.ext;}}}"target_temp"==n&&(n=5*t.ext),this._executeCommand(e,n,a);}else a&&a(new Error("command in null"));}else a&&a(new Error("device in null"));},Alpha2.prototype.getStatesCreator=function(e,t,a){var _resolveState=function _resolveState(e,t,a,n){if(!t.address)return null;if(!a||!a.value)return null;var r=function(e,t){for(var a=0;a<t.length;a++){if(t[a]&&t[a].id==e)return t[a];}return null;}(t.address,n);if(!r)return null;switch(t.dpt){case"HEATAREA":var i=function(e,t){if(!t.heatAreas)return null;for(var a=0;a<t.heatAreas.length;a++){if(t.heatAreas[a]&&t.heatAreas[a].number==e)return t.heatAreas[a];}return null;}(t.number,r);if(!i)return null;var o=i[a.value];return"target_temp"==a.value?o/5:o;case"DEVICE":return r[a.value];}};this._getStates(function(e,n){if(e)a&&a(e);else{for(var r=[],i=0;i<t.length;i++){var o=t[i],s=_resolveState(o.id,o.device,o.status,n);s&&r.push({id:o.id,status:s});}a&&a(null,r);}});},Alpha2.prototype.toJSON=function(){return{sys:xnm.aio.moehlenhoff.Alpha2.DM.SYS,ip:this._ip,port:this._port};},Alpha2.prototype.equalsTo=function(e){return!!e&&e instanceof Alpha2&&this._ip==e._ip&&this._port==e._port;},Alpha2.parseJSON=function(e){return e&&e.ip?new Alpha2(e.ip,e.port):null;},Alpha2;}(),xnm.aio.moehlenhoff.Alpha2.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="Alpha2DMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={alpha2:{DEVICE:{command:[{type:"enum",name:"vacation off",ref:{value:"vac_off"}},{type:"multi",name:"vacation on",ref:{value:"vac_on",ext:"%multi",extMeta:[{type:"string",name:"start date",ref:{value:"start",ext:"%s"}},{type:"string",name:"end date",ref:{value:"end",ext:"%s"}}]}}],status:[{type:"enum",name:"cooling",ref:{value:"cooling",options:["off","on"]}},{type:"enum",name:"vacation",ref:{value:"vacation",options:["off","on"]}},{type:"string",name:"vacation start date",ref:{value:"vacation_start_date"}},{type:"string",name:"vacation start time",ref:{value:"vacation_start_time"}},{type:"string",name:"vacation end date",ref:{value:"vacation_end_date"}},{type:"string",name:"vacation end time",ref:{value:"vacation_end_time"}},{type:"string",name:"program 1",ref:{value:"prog_1"}},{type:"string",name:"program 2",ref:{value:"prog_2"}},{type:"string",name:"program 3",ref:{value:"prog_3"}},{type:"string",name:"program 4",ref:{value:"prog_4"}}]},HEATAREA:{command:[{type:"enum",name:"auto mode",ref:{value:"auto"}},{type:"enum",name:"day mode",ref:{value:"day",value_t:"dayMode"}},{type:"enum",name:"night mode",ref:{value:"night",value_t:"nightMode"}},{type:"enum",name:"week program 0",ref:{value:"w_p0"}},{type:"enum",name:"week program 1",ref:{value:"w_p1"}},{type:"enum",name:"week program 2",ref:{value:"w_p2"}},{type:"enum",name:"week program 3",ref:{value:"w_p3"}},{type:"enum",name:"weekend program 0",ref:{value:"we_p0"}},{type:"enum",name:"weekend program 1",ref:{value:"we_p1"}},{type:"enum",name:"weekend program 2",ref:{value:"we_p2"}},{type:"enum",name:"weekend program 3",ref:{value:"we_p3"}},{type:"float",name:"target temperature",ref:{value:"target_temp",value_t:"temperature",ext:"%f",extMeta:"5-30",scale:"0.2"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","day","night"]}},{type:"float",name:"actual temperature",ref:{value:"actual_temp"}},{type:"string",name:"actual temperature with unit",ref:{value:"actual_temp_text"}},{type:"float",name:"target temperature",ref:{value:"target_temp",extMeta:"5-30",scale:"0.2"}},{type:"string",name:"target temperature with unit",ref:{value:"target_temp_text"}},{type:"enum",name:"week program 0",ref:{value:"prog_week_0",options:["active","inactive"]}},{type:"enum",name:"week program 1",ref:{value:"prog_week_1",options:["active","inactive"]}},{type:"enum",name:"week program 2",ref:{value:"prog_week_2",options:["active","inactive"]}},{type:"enum",name:"week program 3",ref:{value:"prog_week_3",options:["active","inactive"]}},{type:"enum",name:"weekend program 0",ref:{value:"prog_weekend_0",options:["active","inactive"]}},{type:"enum",name:"weekend program 1",ref:{value:"prog_weekend_1",options:["active","inactive"]}},{type:"enum",name:"weekend program 2",ref:{value:"prog_weekend_2",options:["active","inactive"]}},{type:"enum",name:"weekend program 3",ref:{value:"prog_weekend_3",options:["active","inactive"]}}]}}};return{SYS:"alpha2",NEA_SMART_SYS:"neasmart",hasSys:function hasSys(e){return e==this.SYS||e==this.NEA_SMART_SYS;},registModule:function registModule(e){e.register(this.SYS,"moehlenhoff"),e.register(this.NEA_SMART_SYS,"moehlenhoff");},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Möhlenhoff Alpha2",port:80},{sys:this.NEA_SMART_SYS,name:"REHAU Nea Smart",port:80}];},createGateway:function createGateway(e,t,a){var n=DMError,r=DMError.ERROR_CODE;e?e.ip?a(null,e):a(new n(r.INVALID,"ip is invalid")):a(new n(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,n){var r=DMError,i=DMError.ERROR_CODE;t?t.ip?n(null,t):n(new r(i.INVALID,"ip is invalid")):n(new r(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,o,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){o=s[i];break;}}o?a(null,e):a(new n(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(r.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){var i,o,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){o=s[i];break;}}o?a(null,e):a(new n(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(r.INVALID,"gateway is invalid"));}else a(new n(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},getCommandStatusMap:function getCommandStatusMap(t){if(!t||!t.sys||!t.dpt)return null;var a=t.sys;a==this.NEA_SMART_SYS&&(a=this.SYS);var n=e[a];if(!n)return null;var r=n[t.dpt];if("analog"==t.iodevice){for(var i={command:[],status:r.status},o=0;o<r.command.length;o++){var s=r.command[o];"target_temp"!=s.ref.value&&i.command.push(s);}r=i;}return r;}};}(),xnm.aio.rehau=xnm.aio.rehau||{},xnm.aio.rehau.NeaSmartDevice=function(){var NeaSmartDevice=function NeaSmartDevice(e){this._address=e.address,this._name=e.name;};return NeaSmartDevice.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,name:this._name,dpt:"DEVICE"};},NeaSmartDevice;}(),xnm.aio.rehau.NeaSmartHeatArea=function(){var NeaSmartHeatArea=function NeaSmartHeatArea(e){this._address=e.address,this._dpt=e.dpt,this._name=e.name,this._number=e.number,this._iodevice=e.iodevice;};return NeaSmartHeatArea.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,address:this._address,dpt:this._dpt,name:this._name,number:this._number,iodevice:this._iodevice};},NeaSmartHeatArea;}(),xnm.aio.rehau.NeaSmart=function(e,t){xnm.aio.moehlenhoff.Alpha2.call(this,e,t),this._logger=require("x.logger.js").getLogger("xnm.aio.rehau.NeaSmart");},xnm.aio.rehau.NeaSmart.prototype=new xnm.aio.moehlenhoff.Alpha2(),xnm.aio.rehau.NeaSmart.prototype.constructor=xnm.aio.rehau.NeaSmart,xnm.aio.rehau.NeaSmart.prototype.toJSON=function(){return{sys:xnm.aio.rehau.NeaSmart.DM.SYS,ip:this._ip,port:this._port};},xnm.aio.rehau.NeaSmart.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rehau.NeaSmart&&this._ip==e._ip&&this._port==e._port;},xnm.aio.rehau.NeaSmart.parseJSON=function(e){return e&&e.ip?new xnm.aio.rehau.NeaSmart(e.ip,e.port):null;},xnm.aio.rehau.NeaSmart.prototype.getDevicesCreator=function(e){this._getDevices(function(t,a){if(t)e&&e(t);else{var n={},r=[];if(a){for(var i in a){if(a.hasOwnProperty(i)){var o=a[i];if(o)for(var s=0;s<o.length;s++){var u=o[s];if(u){u.address&&!n[u.address]&&(n[u.address]=new xnm.aio.rehau.NeaSmartDevice(u),n[u.address]._name=u._deviceName,r.push(n[u.address]));var l=new xnm.aio.rehau.NeaSmartHeatArea(u);r.push(l);}}}}e&&e(null,r);}}});},xnm.aio.rehau.NeaSmart.DM={SYS:xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS},xnm.aio.moehlenhoff.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="MoehlenhoffDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{getGatewayType:function getGatewayType(e){var t=[];for(var a in xnm.aio.moehlenhoff){if(xnm.aio.moehlenhoff.hasOwnProperty(a)){var n=xnm.aio.moehlenhoff[a];if(n&&n.DM&&n.DM.getGatewayType){var r=n.DM.getGatewayType(e);r&&Array.isArray(r)?t=t.concat(r):t.push(r);}}}return t;},_getSystem:function _getSystem(e){for(var t in xnm.aio.moehlenhoff){if(xnm.aio.moehlenhoff.hasOwnProperty(t)){var a=xnm.aio.moehlenhoff[t];if(a&&a.DM&&a.DM.SYS&&a.DM.SYS==e)return a;if(a&&a.DM&&a.DM.hasSys&&a.DM.hasSys(e))return a;}}return null;},createGateway:function createGateway(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.createGateway?i.DM.createGateway(e,t,a):a&&a(new n(r.INVALID,"no such sys:"+e.sys));}else a&&a(new n(r.INVALID,"sys is invalid"));}else a&&a(new n(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,n){var r=DMError,i=DMError.ERROR_CODE;if(t){if(t.sys){var o=this._getSystem(t.sys);o&&o.DM&&o.DM.updateGateway?o.DM.updateGateway(e,t,a,n):n&&n(new r(i.INVALID,"no such sys:"+t.sys));}else n&&n(new r(i.INVALID,"sys is invalid"));}else n&&n(new r(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.deleteGateway?i.DM.deleteGateway(e,t,a):a&&a(new n(r.INVALID,"no such sys:"+e.sys));}else a&&a(new n(r.INVALID,"sys is invalid"));}else a&&a();},createDevice:function createDevice(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.createDevice?i.DM.createDevice(e,t,a):a&&a(new n(r.INVALID,"no such sys:"+e.sys));}else a&&a(new n(r.INVALID,"sys is invalid"));}else a&&a(new n(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.updateDevice?i.DM.updateDevice(e,t,a):a&&a(new n(r.INVALID,"no such sys:"+e.sys));}else a&&a(new n(r.INVALID,"sys is invalid"));}else a&&a(new n(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){var n=DMError,r=DMError.ERROR_CODE;if(e){if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.deleteDevice?i.DM.deleteDevice(e,t,a):a&&a(new n(r.INVALID,"no such sys:"+e.sys));}else a&&a(new n(r.INVALID,"sys is invalid"));}else a&&a();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,n=0;n<e.length;n++){if(e[n]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var a,n=[],r=null;if(e.sys){var i=this._getSystem(e.sys);i&&i.DM&&i.DM.getCommandStatusMap&&(a=i.DM.getCommandStatusMap(e));}return a&&(r=function(e,t,a){var n=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(a,0,t),n=n.concat(r)),n;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter.call(this,e,t),a.command=n;break;case"status":n=_filter.call(this,e,t),a.status=n;break;default:return null;}return n&&0!=n.length?a:null;}};}(),xnm.aio.moehlenhoff.Handler=function(){var Handler=function Handler(){var e=require("x.logger.js");xnm.aio.moehlenhoff.DM._logger=e?e.getLogger("xnm.aio.moehlenhoff.DM"):{log:function log(){}};};return Handler.prototype.Alpha2=xnm.aio.moehlenhoff.Alpha2,Handler.prototype.NeaSmart=xnm.aio.rehau.NeaSmart,Handler.prototype.getDeviceCommandList=function(e,t){var a=[];if("analog"!=e.data&&"digital"!=e.data||(a.push({id:window.XC_Text.auto,cmd:"auto"}),a.push({id:window.XC_Text.day,cmd:"day"}),a.push({id:window.XC_Text.night,cmd:"night"}),a.push({id:window.XC_Text.w_p0,cmd:"w_p0"}),a.push({id:window.XC_Text.w_p1,cmd:"w_p1"}),a.push({id:window.XC_Text.w_p2,cmd:"w_p2"}),a.push({id:window.XC_Text.w_p3,cmd:"w_p3"}),a.push({id:window.XC_Text.we_p0,cmd:"we_p0"}),a.push({id:window.XC_Text.we_p1,cmd:"we_p1"}),a.push({id:window.XC_Text.we_p2,cmd:"we_p2"}),a.push({id:window.XC_Text.we_p3,cmd:"we_p3"})),"digital"==e.data){var n=this.getDeviceCommandListDigital();a.push.apply(a,n);}return a;},Handler.prototype.getDeviceCommandListDigital=function(){for(var e=[],t=4.8,a=24,n=0;n<126;n++){t+=.2,a++,e.push({id:window.XC_Text.target_temp+t.toFixed(1),cmd:a});}return e;},Handler.prototype.devicemanager=xnm.aio.moehlenhoff.DM,Handler.prototype.registModule=function(e){for(var t in xnm.aio.moehlenhoff){if(xnm.aio.moehlenhoff.hasOwnProperty(t)){var a=xnm.aio.moehlenhoff[t];a&&a.DM&&a.DM.registModule&&a.DM.registModule(e);}}},Handler.prototype.resolveGateway=function(e){if(!e)return null;switch(e.sys){case xnm.aio.moehlenhoff.Alpha2.DM.SYS:return xnm.aio.moehlenhoff.Alpha2.parseJSON(e);case xnm.aio.moehlenhoff.Alpha2.DM.NEA_SMART_SYS:return xnm.aio.rehau.NeaSmart.parseJSON(e);default:return null;}},Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.moehlenhoff.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=a?a.command:[];t&&t(null,n);},Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.moehlenhoff.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),n=a?a.status:[];t&&t(null,n);},Handler.prototype.getDevices=function(e,t){if(e){var a=this.resolveGateway(e);a?a.getDevicesCreator?a.getDevicesCreator(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway do not have getDevicesCreator function")):t&&t(new Error("gatewayJSON invalid"));}else t&&t(new Error("gatewayJSON is empty"));},Handler.prototype.doCommand=function(e,t,a,n){if(e){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){n&&n(e);}):n&&n(new Error("gatewayJSON invalid"));}else n&&n(new Error("gatewayJSON is empty"));},Handler.prototype.doStatus=function(e,t,a,n,r){if(t){var i=this.resolveGateway(t);if(i){var o=[{id:e,device:a,status:n}];i.getStatesCreator(null,o,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gatewayJSON invalid"));}else r&&r(new Error("gatewayJSON is empty"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.moehlenhoff.Handler());