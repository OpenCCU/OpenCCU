var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.heos=xnm.aio.heos||{},xnm.aio.heos.HEOS=function(){var HEOS=function HEOS(e){this._ip=e.ip,this._port=e.port,this._username=e.username,this._password=e.password,this._uuid=e.uuid,this._port||(this._port=1255),this._controller=require("xnm.aio.heos.js").getController();};return HEOS.prototype.executeCommandCreator=function(e,t,o){if(e&&e.type){if(t&&t.value){var s=null;if("player"==e.type){if(!e.pid)return void(o&&o(new Error("invalid player pid")));s=e.pid;}else if("group"==e.type){if(!e.gid)return void(o&&o(new Error("invalid group gid")));s=e.gid;}else o&&o(new Error("unknown device type"));var cb=function cb(e){!e||-5!=e.code&&-6!=e.code||(e.source="heos"),o&&o(e);};switch(t.value){case"play":this.play(s,cb);break;case"pause":this.pause(s,cb);break;case"stop":this.stop(s,cb);break;case"previous":this.previous(s,cb);break;case"next":this.next(s,cb);break;case"toggleMute":"player"==e.type?this.togglePlayerMute(s,cb):this.toggleGroupMute(s,cb);break;case"mute":"player"==e.type?this.playerMute(s,!0,cb):this.groupMute(s,!0,cb);break;case"unmute":"player"==e.type?this.playerMute(s,!1,cb):this.groupMute(s,!1,cb);break;case"volume":if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("invalid volume value")));var r=parseInt(t.ext);if(isNaN(r))return void(o&&o(new Error("invalid volume value")));"player"==e.type?this.setPlayerVolume(s,r,cb):this.setGroupVolume(s,r,cb);break;case"volumeUp":"player"==e.type?this.playerVolumeUp(s,cb):this.groupVolumeUp(s,cb);break;case"volumeDown":"player"==e.type?this.playerVolumeDown(s,cb):this.groupVolumeDown(s,cb);break;case"shuffleOn":this.shuffle(s,"on",cb);break;case"shuffleOff":this.shuffle(s,"off",cb);break;case"shuffleToggle":this.toggleShuffle(s,cb);break;case"repeatOff":this.repeat(s,"off",cb);break;case"repeatAll":this.repeat(s,"on_all",cb);break;case"repeatOne":this.repeat(s,"on_one",cb);break;case"repeatSwitch":this.switchRepeat(s,cb);break;case"playUrl":if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("invalid url value")));this.playUrl(s,t.ext,cb);break;case"clearQueue":this.clearQueue(s,cb);break;default:o&&o(new Error("unknonw command"));}}else o&&o(new Error("device json invalid"));}else o&&o(new Error("device json invalid"));},HEOS.prototype.getStatesCreator=function(e,t,o){var s=this,_getHeosState=function _getHeosState(e,t,o,r){switch(o){case"mute":"player"==e?s.isPlayerMute(t,function(s,i){r(s,i,e,t,o);}):s.isGroupMute(t,function(s,i){r(s,i,e,t,o);});break;case"level":"player"==e?s.getPlayerVolume(t,function(s,i){r(s,i,e,t,o);}):s.getGroupVolume(t,function(s,i){r(s,i,e,t,o);});break;case"shuffle":s.getShuffle(t,function(s,i){r(s,i,e,t,o);});break;case"repeat":s.getRepeat(t,function(s,i){r(s,i,e,t,o);});break;case"play_state":s.getPlayState(t,function(s,i){r(s,i,e,t,o);});break;case"playing_media":s.getPlayingMedia(t,function(s,i){r(s,i,e,t,o);});break;case"duration":s.getPlayingProgress(t,function(s,i,n){r(s,n,e,t,o);});break;case"cur_pos":s.getPlayingProgress(t,function(s,i,n){r(s,i,e,t,o);});}},r=[],i=function(e,t){for(var o=[],s=0;s<e.length;s++){var r=e[s];if(r&&r.id)if(r.device&&r.device.type&&r.status&&r.status.value){var i=r.device.type,n="player"==i?r.device.pid:r.device.gid,a=null;switch(r.status.value){case"muted":a="mute";break;case"volume":a="level";break;case"shuffle":a="shuffle";break;case"repeat":a="repeat";break;case"playState":a="play_state";break;case"artist":case"title":case"album":a="playing_media";break;case"duration":case"durationS":a="duration";break;case"position":case"positionS":a="cur_pos";}for(var l=!1,u=0;u<o.length;u++){var p=o[u];p.type==i&&p.id==n&&p.key==a&&(l=!0);}l||o.push({type:i,id:n,key:a});}else t.push({id:r.id,status:"?"});}return o;}(t,r);if(0!=i.length){var n=0,cb=function cb(s,a,l,u,p){if(!s){var c=function(e,t,o,s,r,i){for(var n=[],a=0;a<r.length;a++){var l=r[a];if(l&&l.id&&l.device&&l.status&&l.status.value){var u=l.device.type,p="player"==e?l.device.pid:l.device.gid;if(e==u&&t==p)switch(o){case"mute":"muted"==l.status.value&&(i.push({id:l.id,status:s}),n.push({id:l.id,status:s}));break;case"level":"volume"==l.status.value&&(i.push({id:l.id,status:s}),n.push({id:l.id,status:s}));break;case"shuffle":"shuffle"==l.status.value&&(i.push({id:l.id,status:s||"?"}),n.push({id:l.id,status:s||"?"}));break;case"repeat":"repeat"==l.status.value&&(i.push({id:l.id,status:s||"?"}),n.push({id:l.id,status:s||"?"}));break;case"play_state":"playState"==l.status.value&&(i.push({id:l.id,status:s||"?"}),n.push({id:l.id,status:s||"?"}));break;case"playing_media":"artist"==l.status.value?(i.push({id:l.id,status:s?s.artist:"?"}),n.push({id:l.id,status:s?s.artist:"?"})):"title"==l.status.value?(i.push({id:l.id,status:s?s.title:"?"}),n.push({id:l.id,status:s?s.title:"?"})):"album"==l.status.value&&(i.push({id:l.id,status:s?s.album:"?"}),n.push({id:l.id,status:s?s.album:"?"}));break;case"duration":if("durationS"==l.status.value)i.push({id:l.id,status:isNaN(s)?0:Math.round(s/1e3)}),n.push({id:l.id,status:isNaN(s)?0:Math.round(s/1e3)});else if("duration"==l.status.value)if(null==s)i.push({id:l.id,status:"?"}),n.push({id:l.id,status:"?"});else{var c=Math.floor(s/6e4);2!=(_=(h=Math.round(s%6e4/1e3))+"").length&&(_="0"+h),i.push({id:l.id,status:c+":"+_}),n.push({id:l.id,status:c+":"+_});}break;case"cur_pos":if("positionS"==l.status.value)i.push({id:l.id,status:isNaN(s)?0:Math.round(s/1e3)}),n.push({id:l.id,status:isNaN(s)?0:Math.round(s/1e3)});else if("position"==l.status.value)if(null==s)i.push({id:l.id,status:"?"}),n.push({id:l.id,status:"?"});else{var h,_;c=Math.floor(s/6e4),2!=(_=(h=Math.round(s%6e4/1e3))+"").length&&(_="0"+h),i.push({id:l.id,status:c+":"+_}),n.push({id:l.id,status:c+":"+_});}}}}return n;}(l,u,p,a,t,r);c.length>0&&void 0!==e&&null!=e&&void 0!==e.reportStates&&null!=e.reportStates&&e.reportStates(null,c);}++n<i.length?_getHeosState(i[n].type,i[n].id,i[n].key,cb):o&&o(null,r);};_getHeosState(i[n].type,i[n].id,i[n].key,cb);}},HEOS.prototype.play=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerState(e,"play",t);},HEOS.prototype.pause=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerState(e,"pause",t);},HEOS.prototype.stop=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerState(e,"stop",t);},HEOS.prototype.previous=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerPlayPrevious(e,t);},HEOS.prototype.next=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerPlayNext(e,t);},HEOS.prototype.playerMute=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerMute(e,t?"on":"off",o);},HEOS.prototype.togglePlayerMute=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.togglePlayerMute(e,t);},HEOS.prototype.groupMute=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setGroupMute(e,t?"on":"off",o);},HEOS.prototype.toggleGroupMute=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.toggleGroupMute(e,t);},HEOS.prototype.setPlayerVolume=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),t>100&&(t=100),t<0&&(t=0),this._controller.setPlayerVolume(e,t,o);},HEOS.prototype.setGroupVolume=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),t>100&&(t=100),t<0&&(t=0),this._controller.setGroupVolume(e,t,o);},HEOS.prototype.playerVolumeUp=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerVolumeUp(e,null,t);},HEOS.prototype.playerVolumeDown=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerVolumeDown(e,null,t);},HEOS.prototype.clearQueue=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerClearQueue(e,t);},HEOS.prototype.groupVolumeUp=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.groupVolumeUp(e,null,t);},HEOS.prototype.groupVolumeDown=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.groupVolumeDown(e,null,t);},HEOS.prototype.shuffle=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerMode(e,null,t,o);},HEOS.prototype.toggleShuffle=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON());var o=this;this._controller.getPlayerMode(e,function(s,r,i){if(s)t&&t(s);else{var n="off";"off"==i&&(n="on"),o._controller.setPlayerMode(e,null,n,t);}});},HEOS.prototype.repeat=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.setPlayerMode(e,t,null,o);},HEOS.prototype.switchRepeat=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON());var o=this;this._controller.getPlayerMode(e,function(s,r,i){if(s)t&&t(s);else{var n="off";"off"==r?n="on_all":"on_all"==r&&(n="on_one"),o._controller.setPlayerMode(e,n,null,t);}});},HEOS.prototype.getShuffle=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerMode(e,function(e,o,s){t&&t(e,s);});},HEOS.prototype.getRepeat=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerMode(e,function(e,o,s){if(e)t&&t(e);else{var r=null;"on_all"==o?r="all":"on_one"==o?r="one":"off"==o&&(r="off"),t&&t(e,r);}});},HEOS.prototype.getPlayState=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerState(e,function(e,o){t&&t(e,o);});},HEOS.prototype.getPlayingMedia=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerNowPlayingMedia(e,function(e,o){if(e)t&&t(e);else{var s=null;o&&((s=JSON.parse(JSON.stringify(o))).title=o.song),t&&t(null,s);}});},HEOS.prototype.getPlayingProgress=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerNowPlayingProgress(e,function(e,o,s){t&&t(e,o,s);});},HEOS.prototype.getPlayers=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayers(e);},HEOS.prototype.isPlayerMute=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerMute(e,function(e,o){if(e)t&&t(e);else{var s=null;"on"==o?s=!0:"off"==o&&(s=!1),t&&t(null,s);}});},HEOS.prototype.getPlayerVolume=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getPlayerVolume(e,function(e,o){t&&t(e,o);});},HEOS.prototype.getGroups=function(e){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getGroups(e);},HEOS.prototype.isGroupMute=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getGroupMute(e,function(e,o){e?t&&t(e):t&&t(null,"on"==o);});},HEOS.prototype.getGroupVolume=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getGroupVolume(e,function(e,o){t&&t(e,o);});},HEOS.prototype.playUrl=function(e,t,o){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.playerPlayURL(e,t,o);},HEOS.prototype.toJSON=function(){return{sys:"heos",ip:this._ip,port:this._port,username:this._username,password:this._password,uuid:this._uuid};},HEOS.prototype.equalsTo=function(e){return!!e&&e instanceof HEOS&&this.ip==e.ip&&this.port==e.port;},HEOS.parseJSON=function(e){return e&&e.ip?new HEOS(e):null;},HEOS;}(),xnm.aio.heos._Controller=function(){var _StateBuffer=function _StateBuffer(){this._stateExpiredTime=300,this._errorStateExpiredTime=10,this._playerBuffer={},this._groupBuffer={};};_StateBuffer.prototype.reset=function(){this._playerBuffer={},this._groupBuffer={};},_StateBuffer.prototype.removePlayerState=function(e,t){var o=this._playerBuffer[e];o||(this._playerBuffer[e]={},o=this._playerBuffer[e]),o[t]=null;},_StateBuffer.prototype.putPlayerState=function(e,t,o){var s=this._playerBuffer[e];s||(this._playerBuffer[e]={},s=this._playerBuffer[e]);var r=s[t];r||(s[t]={},r=s[t]),r.update=Math.round(new Date().getTime()/1e3),r.value=o;},_StateBuffer.prototype.getPlayerState=function(e,t){var o=this._playerBuffer[e];o||(this._playerBuffer[e]={},o=this._playerBuffer[e]);var s=o[t];if(s||(o[t]={},s=o[t]),"cur_pos"==t||"duration"==t)return s.value?s.value:null;var r=Math.round(new Date().getTime()/1e3);return!s.update||null==s.value&&r-s.update>this._errorStateExpiredTime||r-s.update>this._stateExpiredTime?(s.update=r,void(s.value=null)):s.value;},_StateBuffer.prototype.getPlayerStateRaw=function(e,t){var o=this._playerBuffer[e];o||(this._playerBuffer[e]={},o=this._playerBuffer[e]);var s=o[t];return s||(o[t]={},s=o[t]),s.value;},_StateBuffer.prototype.removeGroupState=function(e,t){var o=this._groupBuffer[e];o||(this._groupBuffer[e]={},o=this._groupBuffer[e]),o[t]=null;},_StateBuffer.prototype.putGroupState=function(e,t,o){var s=this._groupBuffer[e];s||(this._groupBuffer[e]={},s=this._groupBuffer[e]);var r=s[t];r||(s[t]={},r=s[t]),r.update=Math.round(new Date().getTime()/1e3),r.value=o;},_StateBuffer.prototype.getGroupState=function(e,t){var o=this._groupBuffer[e];o||(this._groupBuffer[e]={},o=this._groupBuffer[e]);var s=o[t];s||(o[t]={},s=o[t]);var r=Math.round(new Date().getTime()/1e3);return!s.update||null==s.value&&r-s.update>this._errorStateExpiredTime||r-s.update>this._stateExpiredTime?(s.update=r,void(s.value=null)):s.value;},_StateBuffer.prototype.getGroupStateRaw=function(e,t){var o=this._groupBuffer[e];o||(this._groupBuffer[e]={},o=this._groupBuffer[e]);var s=o[t];return s||(o[t]={},s=o[t]),s.value;};var e=function(){var _API=function _API(e){this._controller=e;};return _API.prototype.getPlayers=function(e){this._doRequest({path:"player/get_players"},null,function(t,o,s){e&&e(t,s);});},_API.prototype.getPlayerState=function(e,t){var o={path:"player/get_play_state",attributes:{pid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):o&&void 0!==o.state&&null!=o.state?t&&t(null,o.state):t&&t(new Error("invalid get player state reponse"));});},_API.prototype.setPlayerState=function(e,t,o){var s={path:"player/set_play_state",attributes:{pid:e,state:t}};this._doRequest(s,null,function(e,t){e?o&&o(e):t&&void 0!==t.state&&null!=t.state?o&&o(null,t.state):o&&o(new Error("invalid get player state reponse"));});},_API.prototype.getPlayerNowPlayingMedia=function(e,t){var o={path:"player/get_now_playing_media",attributes:{pid:e}};this._doRequest(o,null,function(e,o,s){e?t&&t(e):s?t&&t(null,s):t&&t(new Error("invalid now playing media reponse"));});},_API.prototype.getPlayerVolume=function(e,t){var o={path:"player/get_volume",attributes:{pid:e}};this._doRequest(o,null,function(e,o){if(e)t&&t(e);else if(o&&void 0!==o.level&&null!=o.level){var s=parseInt(o.level);isNaN(s)?t&&t(new Error("invalid get player volume reponse")):t&&t(null,s);}else t&&t(new Error("invalid get player volume reponse"));});},_API.prototype.setPlayerVolume=function(e,t,o){var s={path:"player/set_volume",attributes:{pid:e,level:t}};this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.level&&null!=t.level){var s=parseInt(t.level);isNaN(s)?o&&o(new Error("invalid set player volume reponse")):o&&o(null,s);}else o&&o(new Error("invalid set player volume reponse"));});},_API.prototype.playerVolumeUp=function(e,t,o){var s={path:"player/volume_up",attributes:{pid:e}};t&&(s.attributes.step=t),this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.step&&null!=t.step){var s=parseInt(t.step);isNaN(s)?o&&o(new Error("invalid player volume up reponse")):o&&o(null,s);}else o&&o(new Error("invalid player volume up reponse"));});},_API.prototype.playerVolumeDown=function(e,t,o){var s={path:"player/volume_down",attributes:{pid:e}};t&&(s.attributes.step=t),this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.step&&null!=t.step){var s=parseInt(t.step);isNaN(s)?o&&o(new Error("invalid player volume down reponse")):o&&o(null,s);}else o&&o(new Error("invalid player volume down reponse"));});},_API.prototype.getPlayerMute=function(e,t){var o={path:"player/get_mute",attributes:{pid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):o&&o.state?t&&t(null,o.state):t&&t(new Error("invalid get player mute reponse"));});},_API.prototype.setPlayerMute=function(e,t,o){var s={path:"player/set_mute",attributes:{pid:e,state:t}};this._doRequest(s,null,function(e,t){e?o&&o(e):t&&t.state?o&&o(null,t.state):o&&o(new Error("invalid set player mute reponse"));});},_API.prototype.togglePlayerMute=function(e,t){var o={path:"player/toggle_mute",attributes:{pid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):t&&t(null);});},_API.prototype.getPlayerMode=function(e,t){var o={path:"player/get_play_mode",attributes:{pid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):o&&o.repeat&&o.shuffle?t&&t(null,o.repeat,o.shuffle):t&&t(new Error("invalid get player mute reponse"));});},_API.prototype.setPlayerMode=function(e,t,o,s){var r={path:"player/set_play_mode",attributes:{pid:e}};t&&(r.attributes.repeat=t),o&&(r.attributes.shuffle=o),this._doRequest(r,null,function(e,t){e?s&&s(e):t&&(t.repeat||t.shuffle)?s&&s(null,t.repeat,t.shuffle):s&&s(new Error("invalid set player mode reponse"));});},_API.prototype.playerClearQueue=function(e,t){var o={path:"player/clear_queue",attributes:{pid:e}};this._doRequest(o,null,function(e){t&&t(e);});},_API.prototype.playerPlayNext=function(e,t){var o={path:"player/play_next",attributes:{pid:e}};this._doRequest(o,null,function(e){t&&t(e);});},_API.prototype.playerPlayPrevious=function(e,t){var o={path:"player/play_previous",attributes:{pid:e}};this._doRequest(o,null,function(e){t&&t(e);});},_API.prototype.getGroups=function(e){this._doRequest({path:"player/get_groups"},null,function(t,o,s){e&&e(t,s);});},_API.prototype.getGroupVolume=function(e,t){var o={path:"group/get_volume",attributes:{gid:e}};this._doRequest(o,null,function(e,o){if(e)t&&t(e);else if(o&&void 0!==o.level&&null!=o.level){var s=parseInt(o.level);isNaN(s)?t&&t(new Error("invalid get group volume reponse")):t&&t(null,s);}else t&&t(new Error("invalid get group volume reponse"));});},_API.prototype.setGroupVolume=function(e,t,o){var s={path:"group/set_volume",attributes:{gid:e,level:t}};this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.level&&null!=t.level){var s=parseInt(t.level);isNaN(s)?o&&o(new Error("invalid set group volume reponse")):o&&o(null,s);}else o&&o(new Error("invalid set group volume reponse"));});},_API.prototype.groupVolumeUp=function(e,t,o){var s={path:"group/volume_up",attributes:{gid:e}};t&&(s.attributes.step=t),this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.step&&null!=t.step){var s=parseInt(t.step);isNaN(s)?o&&o(new Error("invalid group volume up reponse")):o&&o(null,s);}else o&&o(new Error("invalid group volume up reponse"));});},_API.prototype.groupVolumeDown=function(e,t,o){var s={path:"group/volume_down",attributes:{gid:e}};t&&(s.attributes.step=t),this._doRequest(s,null,function(e,t){if(e)o&&o(e);else if(t&&void 0!==t.step&&null!=t.step){var s=parseInt(t.step);isNaN(s)?o&&o(new Error("invalid group volume down reponse")):o&&o(null,s);}else o&&o(new Error("invalid group volume down reponse"));});},_API.prototype.getGroupMute=function(e,t){var o={path:"group/get_mute",attributes:{gid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):o&&o.state?t&&t(null,o.state):t&&t(new Error("invalid get group mute reponse"));});},_API.prototype.setGroupMute=function(e,t,o){var s={path:"group/set_mute",attributes:{gid:e,state:t}};this._doRequest(s,null,function(e,t){e?o&&o(e):t&&t.state?o&&o(null,t.state):o&&o(new Error("invalid set group mute reponse"));});},_API.prototype.toggleGroupMute=function(e,t){var o={path:"group/toggle_mute",attributes:{gid:e}};this._doRequest(o,null,function(e,o){e?t&&t(e):t&&t(null);});},_API.prototype.getMusicSources=function(e){this._doRequest({path:"browse/get_music_sources"},null,function(t,o,s){t?e&&e(t):e&&e(null,s);});},_API.prototype.browserSource=function(e,t,o,s,r){var i={path:"browse/browse",attributes:{sid:e}};t&&(i.attributes.id=t),o&&(i.attributes.scid=o),s&&(i.attributes.range=s),this._doRequest(i,null,function(e,t,o,s){e?r&&r(e):r&&r(null,t,o,s);});},_API.prototype.playerPlayURL=function(e,t,o){var s={path:"browse/play_stream",attributes:{pid:e,url:t}};this._doRequest(s,null,function(e,t){e?o&&o(e):o&&o(null,t);});},_API.prototype._doRequest=function(e,t,o){this._controller._sendCommand(e,t,function(e,t){e?o(e):o(null,t.message,t.payload,t.options);});},_API;}(),Controller=function Controller(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Controller");var t=this;this._api=new e(this),this._session=new xnm.aio.heos._Session(),this._session.on("open",function(){t._state="OPEN",t._logger.log("trace","session opened"),t._emitEvent("open");}),this._session.on("close",function(){t._state="IDLE",t._reset(),t._logger.log("trace","session closed"),t._emitEvent("close");}),this._session.on("error",function(e){t._state="CONNECT",t._logger.log("trace","session error:"+e.message),t._reset();}),this._session.on("event",function(e){t._logger.log("trace","receive session event:"+JSON.stringify(e)),t._processHeosEvent(e);}),this._state="IDLE",this._stateBuffer=new _StateBuffer(),this._listeners={};};return Controller.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},Controller.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var o=this._listeners[e].indexOf(t);-1!=o&&this._listeners[e].splice(o,1);}},Controller.prototype.open=function(e){"IDLE"==this._state&&(this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(e));},Controller.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state="CLOSED",this._session.close());},Controller.prototype.isOpen=function(){return"OPEN"==this._state;},Controller.prototype.isIdle=function(){return"IDLE"==this._state;},Controller.prototype.getPlayers=function(e){this._api.getPlayers(e);},Controller.prototype.getPlayerState=function(e,t){var o=this._getBufferedState("player",e,"play_state");if(void 0===o){var s=this;this._api.getPlayerState(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("player",e,"play_state",o?null:r):s._removeBufferedState("player",e,"play_state"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.setPlayerState=function(e,t,o){var s=this;this._api.setPlayerState(e,t,function(t,r){t||s._putBufferedState("player",e,"play_state",r),o&&o(t,r);});},Controller.prototype.getPlayerNowPlayingMedia=function(e,t){var o=this._getBufferedState("player",e,"playing_media");if(void 0===o){var s=this;this._api.getPlayerNowPlayingMedia(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("player",e,"playing_media",o?null:r):s._removeBufferedState("player",e,"playing_media"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.getPlayerVolume=function(e,t){var o=this._getBufferedState("player",e,"level");if(void 0===o){var s=this;this._api.getPlayerVolume(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("player",e,"level",o?null:r):s._removeBufferedState("player",e,"level"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.setPlayerVolume=function(e,t,o){var s=this;this._api.setPlayerVolume(e,t,function(t,r){t||s._putBufferedState("player",e,"level",r),o&&o(t,r);});},Controller.prototype.playerVolumeUp=function(e,t,o){var s=this;this._api.playerVolumeUp(e,t,function(t,r){if(!t){var i=s._stateBuffer.getPlayerStateRaw(e,"level");void 0!==i&&null!=i&&((i+=r)>100&&(i=100),s._putBufferedState("player",e,"level",i));}o&&o(t,r);});},Controller.prototype.playerVolumeDown=function(e,t,o){var s=this;this._api.playerVolumeDown(e,t,function(t,r){if(!t){var i=s._stateBuffer.getPlayerStateRaw(e,"level");void 0!==i&&null!=i&&((i-=r)<0&&(i=0),s._putBufferedState("player",e,"level",i));}o&&o(t,r);});},Controller.prototype.getPlayerMute=function(e,t){var o=this._getBufferedState("player",e,"mute");if(void 0===o){var s=this;this._api.getPlayerMute(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("player",e,"mute",o?null:r):s._removeBufferedState("player",e,"mute"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.setPlayerMute=function(e,t,o){var s=this;this._api.setPlayerMute(e,t,function(t,r){t||s._putBufferedState("player",e,"mute",r),o&&o(t,r);});},Controller.prototype.togglePlayerMute=function(e,t){var o=this;this._api.togglePlayerMute(e,function(s){if(!s){var r=o._stateBuffer.getPlayerStateRaw(e,"mute");void 0!==r&&null!=r&&(r="on"==r?"off":"on",o._putBufferedState("player",e,"mute",r));}t&&t(s);});},Controller.prototype.getPlayerMode=function(e,t){var o=this._getBufferedState("player",e,"repeat"),s=this._getBufferedState("player",e,"shuffle");if(void 0===o||void 0===s){var r=this;this._api.getPlayerMode(e,function(o,s,i){!o||-5!=o.code&&-6!=o.code?(r._putBufferedState("player",e,"repeat",o?null:s),r._putBufferedState("player",e,"shuffle",o?null:i)):(r._removeBufferedState("player",e,"repeat"),r._removeBufferedState("player",e,"shuffle")),t&&t(o,s,i);});}else t&&t(null,o,s);},Controller.prototype.getPlayerNowPlayingProgress=function(e,t){var o=this._getBufferedState("player",e,"cur_pos"),s=this._getBufferedState("player",e,"duration");t&&t(null,o,s);},Controller.prototype.getGroups=function(e){this._api.getGroups(e);},Controller.prototype.setPlayerMode=function(e,t,o,s){var r=this;this._api.setPlayerMode(e,t,o,function(t,o,i){t||r._putBufferedState("player",e,"repeat",o),t||r._putBufferedState("player",e,"shuffle",i),s&&s(t,o,i);});},Controller.prototype.playerClearQueue=function(e,t){this._api.playerClearQueue(e,function(e){t&&t(e);});},Controller.prototype.playerPlayNext=function(e,t){this._api.playerPlayNext(e,function(e){t&&t(e);});},Controller.prototype.playerPlayPrevious=function(e,t){this._api.playerPlayPrevious(e,function(e){t&&t(e);});},Controller.prototype.getGroupVolume=function(e,t){var o=this._getBufferedState("group",e,"level");if(void 0===o){var s=this;this._api.getGroupVolume(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("group",e,"level",o?null:r):s._removeBufferedState("group",e,"level"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.setGroupVolume=function(e,t,o){var s=this;this._api.setGroupVolume(e,t,function(t,r){t||s._putBufferedState("group",e,"level",r),o&&o(t,r);});},Controller.prototype.groupVolumeUp=function(e,t,o){var s=this;this._api.groupVolumeUp(e,t,function(t,r){if(!t){var i=s._stateBuffer.getGroupStateRaw(e,"level");void 0!==i&&null!=i&&((i+=r)>100&&(i=100),s._putBufferedState("group",e,"level",i));}o&&o(t,r);});},Controller.prototype.groupVolumeDown=function(e,t,o){var s=this;this._api.groupVolumeDown(e,t,function(t,r){if(!t){var i=s._stateBuffer.getGroupStateRaw(e,"level");void 0!==i&&null!=i&&((i-=r)<0&&(i=0),s._putBufferedState("group",e,"level",i));}o&&o(t,r);});},Controller.prototype.getGroupMute=function(e,t){var o=this._getBufferedState("group",e,"mute");if(void 0===o){var s=this;this._api.getGroupMute(e,function(o,r){!o||-5!=o.code&&-6!=o.code?s._putBufferedState("group",e,"mute",o?null:r):s._removeBufferedState("group",e,"mute"),t&&t(o,r);});}else t&&t(null,o);},Controller.prototype.setGroupMute=function(e,t,o){var s=this;this._api.setGroupMute(e,t,function(t,r){t||s._putBufferedState("group",e,"mute",r),o&&o(t,r);});},Controller.prototype.toggleGroupMute=function(e,t){var o=this;this._api.toggleGroupMute(e,function(s){if(!s){var r=o._stateBuffer.getGroupStateRaw(e,"mute");void 0!==r&&null!=r&&(r="on"==r?"off":"on",o._putBufferedState("group",e,"mute",r));}t&&t(s);});},Controller.prototype.getMusicSources=function(e){this._api.getMusicSources(function(t,o){e&&e(t,o);});},Controller.prototype.browserSource=function(e,t,o,s,r){this._api.browserSource(e,t,o,s,function(e,t,o,s){r&&r(e,t,o,s);});},Controller.prototype.playerPlayURL=function(e,t,o){this._api.playerPlayURL(e,t,function(e,t){e?o&&o(e):o&&o(null,t);});},Controller.prototype._putBufferedState=function(e,t,o,s){"player"==e?this._stateBuffer.putPlayerState(t,o,s):"group"==e&&this._stateBuffer.putGroupState(t,o,s);},Controller.prototype._getBufferedState=function(e,t,o){return"player"==e?this._stateBuffer.getPlayerState(t,o):"group"==e?this._stateBuffer.getGroupState(t,o):void 0;},Controller.prototype._removeBufferedState=function(e,t,o){"player"==e?this._stateBuffer.removePlayerState(t,o):"group"==e&&this._stateBuffer.removeGroupState(t,o);},Controller.prototype._sendCommand=function(e,t,o){this._session.sendCommand(e,t,o);},Controller.prototype._emitEvent=function(e,t){if(e){var o=this._listeners[e];if(o&&o.length>0)for(var s=0;s<o.length;s++){var r=o[s];try{r(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},Controller.prototype._processHeosEvent=function(e){if(e&&e.heos&&e.heos.command){var t=e.heos.message;switch(e.heos.command){case"event/player_state_changed":t&&t.pid&&t.state&&this._stateBuffer.putPlayerState(t.pid,"play_state",t.state);break;case"event/player_now_playing_changed":t&&t.pid&&(this._stateBuffer.removePlayerState(t.pid,"playing_media"),this._stateBuffer.removePlayerState(t.pid,"cur_pos"),this._stateBuffer.removePlayerState(t.pid,"duration"));break;case"event/player_now_playing_progress":t&&t.pid&&t.cur_pos&&t.duration&&(this._stateBuffer.putPlayerState(t.pid,"cur_pos",parseInt(t.cur_pos)),this._stateBuffer.putPlayerState(t.pid,"duration",parseInt(t.duration)));break;case"event/player_volume_changed":t&&t.pid&&t.level&&t.mute&&(this._stateBuffer.putPlayerState(t.pid,"level",parseInt(t.level)),this._stateBuffer.putPlayerState(t.pid,"mute",t.mute));break;case"event/repeat_mode_changed":t&&t.pid&&t.repeat&&this._stateBuffer.putPlayerState(t.pid,"repeat",t.repeat);break;case"event/shuffle_mode_changed":t&&t.pid&&t.shuffle&&this._stateBuffer.putPlayerState(t.pid,"shuffle",t.shuffle);break;case"event/group_volume_changed":t&&t.gid&&t.level&&t.mute&&(this._stateBuffer.putGroupState(t.gid,"level",parseInt(t.level)),this._stateBuffer.putGroupState(t.gid,"mute",t.mute));}}},Controller.prototype._reset=function(){this._stateBuffer.reset();},Controller;}(),xnm.aio.heos._Session=function(){var _Monitor=function _Monitor(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session._Monitor"),this._socket=null,this._monitorCallback=null,this._commandTimeoutCount=0,this._heartBeatTo=null,this._heatBeatMissCount=0;var e=this;this._socketErrorCallback=function(t){e._finishRun(t);},this._socketCloseCallback=function(){e._finishRun(new Error("socket closed"));};};_Monitor.prototype.run=function(e,t){this._socket=e,this._monitorCallback=t,this._setListener(),this.scheduleNextHeartBeat();},_Monitor.prototype.reset=function(){if(this._monitorCallback=null,this._heatBeatMissCount=0,this._heartBeatTo&&(clearTimeout(this._heartBeatTo),this._heartBeatTo=null),this._socket){var e=this._socket;this._clearListener(),this._socket=null,e.close();}},_Monitor.prototype.executeCommandTimeout=function(e){e?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),this._commandTimeoutCount>3&&this._finishRun(new Error("execute command is always timeout"))):this._commandTimeoutCount=0;},_Monitor.prototype.scheduleNextHeartBeat=function(e){this._scheduleNextHeartBeat(e||15e3);},_Monitor.prototype._scheduleNextHeartBeat=function(e){var t=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo),this._heartBeatTo=setTimeout(function(){t._checkHeartBeat();},e);},_Monitor.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var e=this;this._socket.sendCommand({path:"system/heart_beat"},2e3,function(t){t?(e._heatBeatMissCount++,e._logger.log("warn","check heart beat failed #"+e._heatBeatMissCount+", error:"+t.message),e._scheduleNextHeartBeat(2e3)):(e._heatBeatMissCount=0,e._scheduleNextHeartBeat(15e3)),e._heatBeatMissCount>3&&e._finishRun(new Error("heart beat failed"));});}},_Monitor.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback));},_Monitor.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback));},_Monitor.prototype._finishRun=function(e){var t=this._socket;if(this._socket&&(this._clearListener(),this._socket=null),e&&t&&t.close(),this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null),this._commandTimeoutCount=0,this._heatBeatMissCount=0,this._monitorCallback){var o=this._monitorCallback;this._monitorCallback=null,o(e);}};var _Runner=function _Runner(){this._socket=null,this._username=null,this._password=null,this._warmupCallback=null;var e=this;this._socketErrorCallback=function(t){e._finishWarmup(t);},this._socketCloseCallback=function(){e._finishWarmup(new Error("socket closed"));};};_Runner.prototype.warmup=function(e,t,o,s){this._socket=e,this._username=t,this._password=o,this._warmupCallback=s,this._setListener();var r=this;this._registerEvents("off",function(e){e?r._finishWarmup(e):r._signIn(function(e){e?r._finishWarmup(e):r._getPlayers(function(e){e?r._finishWarmup(e):r._registerEvents("on",function(e){r._finishWarmup(e);});});});});},_Runner.prototype.reset=function(){if(this._warmupCallback=null,this._socket){var e=this._socket;this._clearListener(),this._socket=null,e.close();}},_Runner.prototype._registerEvents=function(e,t){this._socket.sendCommand({path:"system/register_for_change_events",attributes:{enable:e}},5e3,function(e,o){t(e,o);});},_Runner.prototype._signIn=function(e){this._username&&this._password?this._socket.sendCommand({path:"system/sign_in",attributes:{un:this._username,pw:this._password}},5e3,function(t,o){e(t,o);}):e();},_Runner.prototype._getPlayers=function(e){this._socket.sendCommand({path:"player/get_players"},5e3,function(t,o){t?e(t):o&&o.heos&&o.payload&&"success"==o.heos.result?e(null,o.payload):e(new Error("get players response error"));});},_Runner.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback));},_Runner.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback));},_Runner.prototype._finishWarmup=function(e){var t=this._socket;this._socket&&(this._clearListener(),this._socket=null),e&&t&&t.close(),this._warmupCallback&&(this._warmupCallback(e),this._warmupCallback=null);};var _Connect=function _Connect(){this._socket=null,this._connectCallback=null;var e=this;this._socketOpenCallback=function(){e._finishConnect();},this._socketErrorCallback=function(t){e._finishConnect(t);},this._socketCloseCallback=function(){e._finishConnect(new Error("socket closed"));};};_Connect.prototype.connect=function(e,t){this._connectCallback=t,this._socket=new xnm.aio.heos._Socket(e),this._setListener(),this._socket.open();},_Connect.prototype.reset=function(){if(this._connectCallback=null,this._socket){var e=this._socket;this._clearListener(),this._socket=null,e.close();}},_Connect.prototype._setListener=function(){this._socket&&(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback));},_Connect.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback));},_Connect.prototype._finishConnect=function(e){var t=this._socket;if(this._socket&&(this._clearListener(),this._socket=null),e&&t&&t.close(),this._connectCallback){var o=this._connectCallback;this._connectCallback=null,o(e,t);}};var _Discover=function _Discover(){this._state="idle",this._heos=[],this._lastFetch=null,this._fetchCallback=null,this._searchTo=null;};_Discover.prototype.reset=function(){this._state="idle",this._heos=[],this._lastFetch=null,this._fetchCallback=null,this._searchTo&&clearTimeout(this._searchTo),this._searchTo=null;},_Discover.prototype.fetchHEOS=function(e){var t=Math.round(new Date().getTime()/1e3);this._lastFetch&&t-this._lastFetch>600&&(this._heos=[]);var o=this._getUnfetchedHEOSFromBuffer();if(o)return this._lastFetch=t,void e(null,o);if(this._fetchCallback=e,"run"!=this._state){var s=this;this._state="run",this._searchTo=setTimeout(function(){if(s._state="idle",s._heos=[],s._fetchCallback){var e=s._fetchCallback;s._fetchCallback=null,e(null,null);}},12e3),require("x.upnp.js").discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",1e4,function(e){if(e&&e.ip&&"run"==s._state){var o={fetched:!1,data:{ip:e.ip,port:1255,uuid:e.uuid}},r=s._heos.length;if(s._heos.push(o),0==r&&(o.fetched=!0,s._lastFetch=t,s._fetchCallback)){var i=s._fetchCallback;s._fetchCallback=null,i(null,o.data);}}});}},_Discover.prototype._getUnfetchedHEOSFromBuffer=function(){for(var e=null,t=0;t<this._heos.length;t++){var o=this._heos[t];if(0==o.fetched){o.fetched=!0,e=o.data;break;}}return e;};var _Session=function _Session(){this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Session"),this._discover=new _Discover(),this._connect=new _Connect(),this._runner=new _Runner(),this._monitor=new _Monitor();var e=this;this._socketEventCallback=function(t){t&&t.heos&&t.heos.message&&(t.heos.message=e._parseMessage(t.heos.message)),e._monitor.scheduleNextHeartBeat(),e._emitEvent("event",t);},this._socket=null,this._state="IDLE",this._ip=null,this._port=null,this._username=null,this._password=null,this._uuid=null,this._eventListeners={};};return _Session.prototype.on=function(e,t){e&&t&&(this._eventListeners[e]||(this._eventListeners[e]=[]),-1==this._eventListeners[e].indexOf(t)&&this._eventListeners[e].push(t));},_Session.prototype.off=function(e,t){if(e&&t&&this._eventListeners[e]){var o=this._eventListeners[e].indexOf(t);-1!=o&&this._eventListeners[e].splice(o,1);}},_Session.prototype.open=function(e){"IDLE"==this._state&&(this._ip=e?e.ip:null,this._port=e?e.port:null,this._username=e?e.username:null,this._password=e?e.password:null,this._uuid=e?e.uuid:null,this._logger.log("debug","start controller"+(this._ip?" with ip:"+this._ip:" without ip")),this._doFSM(this._ip?"init_with_ip":"init_without_ip"));},_Session.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"));},_Session.prototype.sendCommand=function(e,t,o){var s;if("IDLE"==this._state)return(s=new Error("session not initialized")).sys="heos",s.code=-5,void(o&&o(s));if("RUN"!=this._state)return(s=new Error("session is initialling")).sys="heos",s.code=-6,void(o&&o(s));var r=this;this._socket.sendCommand(e,t,function(e,t){if(e?-3==e.code?(r._monitor.scheduleNextHeartBeat(),r._monitor.executeCommandTimeout(!0)):r._monitor.executeCommandTimeout(!1):(r._monitor.scheduleNextHeartBeat(),r._monitor.executeCommandTimeout(!1)),e)o&&o(e);else{if(!t||!t.heos||!t.heos.result)return(e=new Error("invalid response")).code=-4,void(o&&o(e));var s={command:t.heos.comamnd,result:t.heos.result};t.heos.message&&(s.message=r._parseMessage(t.heos.message)),t.payload&&(s.payload=t.payload),t.options&&(s.options=t.options),"fail"==t.heos.result&&(s.message?(e=new Error(s.message.text)).code=parseInt(s.message.eid):(e=new Error("response fail")).code=0),o&&o(e,s);}});},_Session.prototype._emitEvent=function(e,t){if(e){var o=this._eventListeners[e];if(o&&o.length>0)for(var s=0;s<o.length;s++){var r=o[s];try{r(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},_Session.prototype._searchHEOS=function(){this._logger.log("trace","search heos device");var e=this;this._discover.fetchHEOS(function(t,o){o?(e._logger.log("trace","found heos device:"+o.ip),e._ip=o.ip,e._uuid=o.uuid,e._doFSM("find_heos")):(e._logger.log("trace","do not found heos device"),e._doFSM("no_heos"));});},_Session.prototype._stopSearchHEOS=function(){this._logger.log("trace","stop search heos device"),this._discover.reset(),this._reset();},_Session.prototype._connectHEOS=function(){this._logger.log("trace","connect heos device:"+this._ip);var e=this;this._connect.connect({ip:this._ip,port:this._port,username:this._username,passsword:this._password,uuid:this._uuid},function(t,o){t?(e._logger.log("trace","connect to heos device:"+e._ip+" failed, error:"+t.message),e._doFSM("conn_fail")):(e._logger.log("trace","connect to heos device:"+e._ip+" success"),e._socket=o,e._doFSM("conn_ok"));});},_Session.prototype._stopConnectHEOS=function(){this._logger.log("trace","stop connect heos device:"+this._ip),this._connect.reset(),this._reset();},_Session.prototype._warmupHEOS=function(){this._logger.log("trace","warmup heos device:"+this._ip);var e=this;this._runner.warmup(this._socket,this._username,this._password,function(t){t?(e._logger.log("trace","warmup heos device:"+e._ip+" failed, error:"+t.message),e._socket=null,e._doFSM("not_ready")):(e._logger.log("trace","warmup heos device:"+e._ip+" success"),e._doFSM("ready"));});},_Session.prototype._stopWarmupHEOS=function(){this._logger.log("trace","stop warmup heos device:"+this._ip),this._runner.reset(),this._reset();},_Session.prototype._runHEOS=function(){this._logger.log("trace","monitor heos device:"+this._ip);var e=this;this._monitor.run(this._socket,function(t){t&&(e._logger.log("trace","monitor heos device:"+e._ip+" failed, error:"+t.message),e._socket=null,e._doFSM("run_error"),e._emitEvent("error",t));}),this._setListener(),this._emitEvent("open");},_Session.prototype._stopRunHEOS=function(){this._logger.log("trace","stop monitor heos device:"+this._ip),this._monitor.reset(),this._clearListener(),this._emitEvent("close"),this._reset();},_Session.prototype._parseMessage=function(e){if(!e)return null;for(var t={},o=e.split("&"),s=0;s<o.length;s++){var r=o[s],i=r.indexOf("=");if(-1!=i){var n=r.substr(0,i),a=r.substr(i+1);t[n]=a;}}return t;},_Session.prototype._setListener=function(){this._socket&&this._socket.on("event",this._socketEventCallback);},_Session.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback);},_Session.prototype._reset=function(){this._socket=null,this._ip=null,this._port=null,this._username=null,this._password=null,this._uuid=null;},_Session.prototype._doFSM=function(e){switch(this._logger.log("trace","FSM current state:"+this._state+" input:"+e),this._state){case"IDLE":switch(e){case"init_with_ip":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectHEOS();break;case"init_without_ip":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS();}break;case"SEARCH":switch(e){case"no_heos":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS();break;case"find_heos":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectHEOS();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopSearchHEOS();}break;case"CONNECT":switch(e){case"conn_fail":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS();break;case"conn_ok":this._state="WARMUP",this._logger.log("trace","FSM new state:"+this._state),this._warmupHEOS();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectHEOS();}break;case"WARMUP":switch(e){case"not_ready":this._state="SEARCH",this._logger.log("trace","FSM new state:"+this._state),this._searchHEOS();break;case"ready":this._state="RUN",this._logger.log("trace","FSM new state:"+this._state),this._runHEOS();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopWarmupHEOS();}break;case"RUN":switch(e){case"run_error":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectHEOS();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopRunHEOS();}}},_Session;}(),xnm.aio.heos._Socket=function(){var Socket=function Socket(e){if(!e)throw new Error("options is null");if(!e.ip)throw new Error("no ip");this._logger=require("x.logger.js").getLogger("xnm.aio.heos._Socket"),this._responseTimeout=1e3,this._ip=e.ip,this._port=e.port,this._port||(this._port=1255),this._username=e.username,this._password=e.password,this._uuid=e.uuid,this._timeout=2e3,this._listeners={},this._socket=null,this._buf="",this._state="IDLE",this._commands=[];};return Socket.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},Socket.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var o=this._listeners[e].indexOf(t);-1!=o&&this._listeners[e].splice(o,1);}},Socket.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT",this._buf="";var t=require("net").connect({port:this._port,host:this._ip});t.setTimeout(this._timeout),t.setEncoding("utf8"),this._logger.log("trace","start connect to "+this._ip+":"+this._port),t.on("connect",function(){e._logger.log("trace","success to connect "+e._ip+":"+e._port),e._state="CONNECTED",e._emitEvent("open"),e._executeNextCommand();}),t.on("data",function(t){e._logger.log("trace","receive data: "+t.toString()),e._buf+=t.toString(),e._processBuffer();}),t.on("error",function(t){e._logger.log("trace","socket error: "+t.message),e._emitEvent("error",t);}),t.on("timeout",function(){"CONNECT"==e._state&&(e._logger.log("trace","connect timeout"),e._emitEvent("error",new Error("connect timeout")),e.close());}),t.on("close",function(){e._logger.log("trace","socket closed"),e._onClose();}),t._doConnect&&"function"==typeof t._doConnect&&t._doConnect(),this._socket=t;}},Socket.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose());},Socket.prototype.sendCommand=function(e,t,o){var s=null;if("CLOSED"==this._state)return(s=new Error("socket closed")).code=-1,void(o&&o(s));if(!e||!e.path)return(s=new Error("invalid command")).code=-2,void(o&&o(s));var r=t;r||(r=this._responseTimeout);var i={command:e,callback:o,timeout:null,state:"IDLE",responseTimeout:r},n=this._commands.length;this._commands.push(i),0==n&&this._executeNextCommand();},Socket.prototype._executeNextCommand=function(){var e=this._commands[0];if(e&&"IDLE"==e.state&&"CONNECTED"==this._state){var t=this._buildPacket(e.command);e.state="SENT",this._setupReponseTimeout(e),this._logger.log("debug","send command:"+t);var o=new Buffer(t);this._socket.write(o);}},Socket.prototype._setupReponseTimeout=function(e){var t=this;e.timeout=setTimeout(function(){if(t._commands.splice(0,1),e.state="TIMEOUT",e.callback){t._logger.log("debug","response timeout");var o=new Error("response timeout");o.code=-3,e.callback(o);}t._executeNextCommand();},e.responseTimeout);},Socket.prototype._buildPacket=function(e){var t="heos://"+e.path;if(e.attributes){t+="?";var o=[];for(var s in e.attributes){var r=this._escape(s)+"="+this._escape(e.attributes[s]);o.push(r);}t+=o.join("&");}return t+="\r\n";},Socket.prototype._escape=function(e){if(!e)return e;if("string"!=typeof e)return e;var t=e.replace(/%/g,"%25");return t=(t=t.replace(/&/g,"%26")).replace(/=/g,"%3D");},Socket.prototype._emitEvent=function(e,t){if(e){var o=this._listeners[e];if(o&&o.length>0)for(var s=0;s<o.length;s++){var r=o[s];try{r(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},Socket.prototype._processBuffer=function(){for(var e=this._buf.indexOf("\r\n");-1!=e;){if(0!=e){var t=this._buf.substr(0,e);this._processResponse(t);}this._buf=this._buf.substr(e+2),e=this._buf.indexOf("\r\n");}},Socket.prototype._processResponse=function(e){this._logger.log("debug","receive response: "+e);try{var t=JSON.parse(e);if(!t||!t.heos||!t.heos.command)throw new Error("invalid response");var o=this._commands[0];if(o&&"SENT"==o.state&&o.command&&o.command.path==t.heos.command){if(-1!=t.heos.message.indexOf("command under process"))return clearTimeout(o.timeout),void this._setupReponseTimeout(o);this._commands.splice(0,1),clearTimeout(o.timeout),o.callback&&o.callback(null,t),this._executeNextCommand();}else"event"==t.heos.command.substr(0,5)&&this._emitEvent("event",t);}catch(e){this._logger.log("debug","process response error: "+e.message);}},Socket.prototype._onClose=function(){this._state="CLOSED",this._socket=null,this._emitEvent("close"),this._listeners={};var e=new Error("socket closed");e.code=-1;for(var t=0;t<this._commands.length;t++){var o=this._commands[t];o.timeout&&clearTimeout(o.timeout),o.callback&&o.callback(e);}this._commands=[],this._buf="";},Socket;}(),xnm.aio.heos.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="HEOSDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"string",name:"play state",ref:{value:"playState",options:["play","pause","stop"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]};return{SYS:"heos",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"HEOS Controller",port:1255}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"player",name:"Player"},{sys:this.SYS,type:"group",name:"Group"}];},createGateway:function createGateway(e,t,o){var s=DMError,r=DMError.ERROR_CODE;e?e.ip?o(null,e):o(new s(r.INVALID,"ip is invalid")):o(new s(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,o,s){var r=DMError,i=DMError.ERROR_CODE;t?t.ip?s(null,t):s(new r(i.INVALID,"ip is invalid")):s(new r(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,o){o();},createDevice:function createDevice(e,t,o){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if("player"!=e.type||null!=e.pid&&void 0!==e.pid){if("group"!=e.type||null!=e.gid&&void 0!==e.gid){var i,n,a=t.data.gateways;for(i=0;i<a.length;i++){if(a[i].index===e.gateway){n=a[i];break;}}n?o(null,e):o(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else o(new s(r.INVALID,"gid is invalid"));}else o(new s(r.INVALID,"pid is invalid"));}else o(new s(r.INVALID,"type is invalid"));}else o(new s(r.INVALID,"gateway is invalid"));}else o(new s(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if("player"!=e.type||null!=e.pid&&void 0!==e.pid){if("group"!=e.type||null!=e.gid&&void 0!==e.gid){var i,n,a=t.data.gateways;for(i=0;i<a.length;i++){if(a[i].index===e.gateway){n=a[i];break;}}n?o(null,e):o(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else o(new s(r.INVALID,"gid is invalid"));}else o(new s(r.INVALID,"pid is invalid"));}else o(new s(r.INVALID,"type is invalid"));}else o(new s(r.INVALID,"gateway is invalid"));}else o(new s(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t){var o=this,_doFilterArr=function _doFilterArr(e,t,o){var s=[];return e.forEach(function(e){if("root"==e.type){var r=JSON.parse(JSON.stringify(e)),i=_doFilterArr(r.children,t,o);i&&i.length>0&&(r.children=i,s.push(r));}else if(function(e,t){if("*"==e)return!0;for(var o=!1,s=0;s<e.length;s++){if(e[s]==t){o=!0;break;}}return o;}(o.elems,e.type)){var n=JSON.parse(JSON.stringify(e));s.push(n);}}),s;},_filter=function _filter(e,t){var s=[],r=null,i=o.getCommandStatusMap(e);return i&&(r=function(e,t,o){var s=[];switch(o.catagory){case"command":e.command&&(s=_doFilterArr(e.command,t,o));break;case"status":e.status&&(s=_doFilterArr(e.status,t,o));}return s;}(i,e,t),s=s.concat(r)),s;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),s.command=r;break;case"status":r=_filter(e,t),s.status=r;break;default:return null;}return r&&0!=r.length?s:null;},getCommandStatusMap:function getCommandStatusMap(t){return t&&void 0!==t.type&&null!=t.type?e:null;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,o,s,r){return e._injectToSmartWidgetTemplate(s,["media"],r,{"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%shuffleToggle%":{value:"shuffleToggle"},"%stop%":{value:"stop"},"%toggleMute%":{value:"toggleMute"},"%volume%":{value:"volume",ext:"%d",extMeta:"0-100"}},{"%durationState%":{value:"durationS"},"%durationStringState%":{value:"duration"},"%mutedState%":{value:"muted",options:["true","false"]},"%playState%":{value:"playState",options:["play","pause","stop"]},"%positionState%":{value:"positionS"},"%shuffleState%":{value:"shuffle",options:["on","off"]},"%volumeState%":{value:"volume",extMeta:"0-100"}},null);}};}(),xnm.aio.heos.Handler=function(){var Handler=function Handler(){this._controller=null,this._getDeviceListTo=null;};return Handler.prototype.Socket=xnm.aio.heos._Socket,Handler.prototype.Session=xnm.aio.heos._Session,Handler.prototype.Controller=xnm.aio.heos._Controller,Handler.prototype.HEOS=xnm.aio.heos.HEOS,Handler.prototype.devicemanager=xnm.aio.heos.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"heos");},Handler.prototype.resolveGateway=function(e){return e?this.HEOS.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),s=o?o.command:[];t&&t(null,s);},Handler.prototype.getDeviceStatus=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),s=o?o.status:[];t&&t(null,s);},Handler.prototype.doCommand=function(e,t,o,s){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,o,function(e){s&&s(e);}):s&&s(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,o,s,r){var i=this.resolveGateway(t);if(i){var n=[{id:e,device:o,status:s}];i.getStatesCreator(null,n,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("device json format invalid"));},Handler.prototype.getController=function(){return this._controller||(this._controller=new this.Controller()),this._controller;},Handler.prototype.discoverDevices=function(e){var t=require("x.upnp.js"),o={};t.discoverTargetWithTimeout("urn:schemas-denon-com:device:ACT-Denon:1",5e3,function(e){if(e&&e.ip&&e.uuid){var t={sys:"heos",ip:e.ip,uuid:e.uuid};o[e.uuid]=t;}}),setTimeout(function(){var t=null;for(var s in o){var r=o[s];if(r){t=r;break;}}e&&e(null,t);},5e3);},Handler.prototype.getDeviceList=function(e,t){_getDeviceList=function _getDeviceList(e,t){var o=[];e.getPlayers(function(s,r){s?t&&t(s):(r&&r.map(function(e){return e.sys="heos",e.type="player",e;}),e.getGroups(function(e,s){e?t&&t(e):(s&&s.map(function(e){return e.sys="heos",e.type="group",delete e.players,e;}),r&&(o=o.concat(r)),s&&(o=o.concat(s)),t&&t(null,o));}));});};var o=this.resolveGateway(e);if(o){if(this._getDeviceListTo)t&&t(new Error("another get device list process running"));else{var s=this.getController();if(s.isOpen())_getDeviceList(o,t);else{var r=this,cb=function cb(){s.off("run",cb),r._getDeviceListTo&&(clearTimeout(r._getDeviceListTo),r._getDeviceListTo=null),_getDeviceList(o,t);};s.on("open",cb),this._getDeviceListTo=setTimeout(function(){s.off("run",cb),r._getDeviceListTo=null,t&&t(new Error("start heo controller timeout"));},5e3),s.open(o.toJSON());}}}else t&&t(new Error("gateway json format invalid"));},Handler.prototype.finalize=function(e){this._controller&&this._controller.close(),setTimeout(function(){e&&e();},1e3);},Handler.prototype.pause=function(e){this.finalize(e);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.heos.Handler());