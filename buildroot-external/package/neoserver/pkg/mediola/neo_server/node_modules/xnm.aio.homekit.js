"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.homekit=xnm.aio.homekit||{},xnm.aio.homekit.XCHomeKit=function(){this._errorCallback=null,this._stateCallback=null;var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.homekit"):{log:function log(){}};},xnm.aio.homekit.XCHomeKit.prototype.on=function(e,t){if("error"===e)this._errorCallback=t;else if("updatedState"===e){this._stateCallback=t;var o=this;XC.callHost("homekit","setStateCallback",null,function(e){e&&o._stateCallback(e);});}},xnm.aio.homekit.XCHomeKit.prototype.getDevices=function(e){this._logger.log("trace","Calling getDevices on host.");var t=this;XC.callHost("homekit","getDevices",{},function(o){t._logger.log("debug","Received getDevices response."),e&&e(o);});},xnm.aio.homekit.XCHomeKit.prototype.getStates=function(e){this._logger.log("trace","Calling getStates on host.");var t=this;XC.callHost("homekit","getStates",{},function(o){t._logger.log("trace","Received getStates response."),e&&e(o);});},xnm.aio.homekit.XCHomeKit.prototype.updateStates=function(e){this._logger.log("trace","Calling updateStates on host.");var t={};e&&(t.devices=e),XC.callHost("homekit","updateStates",t);},xnm.aio.homekit.XCHomeKit.prototype.executeCommand=function(e,t,o,r){this._logger.log("trace","Calling executeCommand on host with: "+e+" | "+t+" | "+o);var a={id:e,command:t};null!=o&&(a.value=o);var n=this;XC.callHost("homekit","executeCommand",a,function(e){try{n._logger.log("debug","Command has been executed: "+JSON.stringify(e));}catch(e){n._logger.log("error","JSON error in executeCommand response: "+e.message);}r&&(e&&e.error?r(!1):r(!0));});},xnm.aio.homekit.XCHomeKit.prototype.doScene=function(e,t){this._logger.log("trace","Calling doScene on host for ID: "+e);var o={id:e},r=this;XC.callHost("homekit","doScene",o,function(e){try{r._logger.log("debug","Scene has been executed: "+JSON.stringify(e));}catch(e){r._logger.log("error","JSON error in doScene response: "+e.message);}t&&(e&&e.error?t(!1):t(!0));});},xnm.aio.homekit.XCHomeKit.prototype.showCamera=function(e,t){this._logger.log("trace","Calling showCamera on host for ID: "+e),t.id=e,XC.callHost("homekit","showCamera",t);},xnm.aio.homekit.XCHomeKit.prototype.hideCamera=function(e){this._logger.log("trace","Calling hideCamera on host for ID: "+e);var t={id:e};XC.callHost("homekit","hideCamera",t);},xnm.aio.homekit.XCHomeKit.prototype.showCameraSnapshot=function(e,t,o,r,a){this._logger.log("trace","Calling showCameraSnapshot on host for ID: "+e);var n={id:e};t&&(n.left=t),o&&(n.top=o),r&&(n.width=r),a&&(n.height=a),XC.callHost("homekit","showCameraSnapshot",n);},xnm.aio.homekit.XCHomeKit.prototype.hideCameraSnapshot=function(e){this._logger.log("trace","Calling hideCameraSnapshot on host for ID: "+e);var t={id:e};XC.callHost("homekit","hideCameraSnapshot",t);},xnm.aio.homekit.XCHomeKit.prototype.hideAllCameraViews=function(){this._logger.log("trace","Calling hideAllCameraViews on host."),XC.callHost("homekit","hideAllCameraViews",null);},xnm.aio.homekit.DM={SYS:"homekit",applySmartWidgetFilter:function applySmartWidgetFilter(e,t,o,r,a){var n=this.applyUIFilter(t,{catagory:"command",elems:"*"}),i=this.applyUIFilter(t,{catagory:"status",elems:"*"});var s=null,l=null;if(n&&Array.isArray(n.command)&&n.command.length>0&&(s={},n.command.forEach(function(e){e&&e.ref&&(s[e.ref.value]=e.ref);})),i&&Array.isArray(i.status)&&i.status.length>0&&(l={},i.status.forEach(function(e){e&&e.ref&&(l[e.ref.value]=e.ref);})),!s&&!l)return null;s=s||{},l=l||{};var c={},m={},u=[],p={},d={};switch(t.type){case"airPurifier":p["%lockControls%"]="lockControls",p["%rotationSpeed%"]="rotationSpeed",p["%swingMode%"]="swingMode",p["%targetPurifierState%"]="targetPurifierState",p["%toggle%"]="toggle",p["%unlockControls%"]="unlockControls",d["%controlsLockedState%"]="controlsLocked",d["%rotationSpeedState%"]="rotationSpeed",d["%swingModeState%"]="swingMode",d["%switchState%"]="powerState",d["%targetPurifierState%"]="targetPurifierState",u.push("air_purifier");break;case"airQualitySensor":case"dioxideSensor":case"leakSensor":case"monoxideSensor":case"sensor":case"smokeSensor":t.states.dioxideLevel&&(d["%co2State%"]="dioxideLevel",u.push("sensor_co2")),t.states.leakDetected&&(d["%leakState%"]="leakDetected",u.push("sensor_water")),t.states.monoxideLevel&&(d["%coState%"]="monoxideLevel",u.push("sensor_co")),t.states.smokeDetected&&(d["%smokeState%"]="smokeDetected",u.push("sensor_smoke","smoke"));break;case"blind":case"shutter":p["%lamellaTo%"]="targetVerticalTilt",p["%moveDown%"]="down",p["%moveTo%"]="targetPosition",p["%moveUp%"]="up",p["%stop%"]="stop",d["%blindState%"]="currentPosition",d["%lamellaState%"]="currentVerticalTilt",d["%shutterState%"]="currentPosition",u.push("blind","shutter");break;case"contactSensor":d["%contactState%"]="contactDetected",u.push("contact","sensor_contact");break;case"door":case"window":p["%close%"]="close",p["%moveTo%"]="targetPosition",p["%open%"]="open",p["%stop%"]="stop",d["%positionState%"]="currentPosition",d["%targetPositionState%"]="targetPosition",u.push(t.type);break;case"fan":p["%lockControls%"]="lockControls",p["%rotationDirection%"]="rotationDirection",p["%rotationSpeed%"]="rotationSpeed",p["%swingMode%"]="swingMode",p["%toggle%"]="toggle",p["%unlockControls%"]="unlockControls",d["%controlsLockedState%"]="controlsLocked",d["%rotationDirectionState%"]="rotationDirection",d["%rotationSpeedState%"]="rotationSpeed",d["%swingModeState%"]="swingMode",d["%switchState%"]="powerState",u.push("fan");break;case"heater":case"thermostat":p["%heaterCoolingTemp%"]="coolingTemperature",p["%heaterHeatingTemp%"]="heatingTemperature",p["%lockControls%"]="lockControls",p["%rotationSpeed%"]="rotationSpeed",p["%swingMode%"]="swingMode",p["%targetMode%"]="targetMode",p["%thermoTempDown%"]="down",p["%thermoTempTo%"]="targetTemperature",p["%thermoTempUp%"]="up",p["%unlockControls%"]="unlockControls",d["%controlsLockedState%"]="controlsLocked",d["%heaterCoolingTempState%"]="coolingTemperature",d["%heaterHeatingTempState%"]="heatingTemperature",d["%humState%"]="currentHumidity",d["%rotationSpeedState%"]="rotationSpeed",d["%swingModeState%"]="swingMode",d["%targetModeState%"]="targetMode",d["%tempState%"]="currentTemperature",d["%thermoCurrentTemp%"]="currentTemperature",d["%thermoSetTemp%"]="targetTemperature",u.push("climate","thermostat","weather_station");break;case"motionSensor":d["%motionState%"]="motionDetected",u.push("motion","sensor_motion");break;case"light":case"switch":p["%colorTemp%"]="colorTemperature",p["%dimTo%"]="brightness",p["%off%"]="off",p["%on%"]="on",p["%rgb%"]="color",p["%toggle%"]="toggle",d["%colorTempState%"]="colorTemperature",d["%dimmerState%"]="brightness",d["%switchState%"]="powerState",u.push("dimmer","switch"),(t.commands.color||t.commands.colorTemperature)&&u.push("rgb");break;case"occupancySensor":d["%occupancyState%"]="occupancyDetected",u.push("occupancy","sensor_occupancy");break;case"speaker":p["%mute%"]="mute",p["%toggleMute%"]="toggle",p["%unmute%"]="unmute",p["%volume%"]="volume",d["%mutedState%"]="muted",d["%volumeState%"]="volume",u.push("speaker");break;default:return null;}for(var _e in p){var _t=p[_e];"string"==typeof _t?s[_t]&&(c[_e]=s[_t]):c[_e]=_t;}for(var _e2 in d){var _t2=d[_e2];"string"==typeof _t2?l[_t2]&&(m[_e2]=l[_t2]):m[_e2]=_t2;}return e._injectToSmartWidgetTemplate(r,u,a,c,m,null);},applyUIFilter:function applyUIFilter(e,t,o){if(!e.sys)return null;var _contains=function _contains(e,t){if("*"===e||"*"===e[0])return!0;for(var o=0;o<e.length;o++){if(e[o]==t)return!0;}return!1;},_filter=function _filter(e,t){var r=[],a=null,n=xnm.aio.homekit.DM.getCommandStatusMap(e,o);return n&&(a=function(e,t,o){var r=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(n,0,t),r=r.concat(a)),r;},r=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),r.command=a;break;case"status":a=_filter(e,t),r.status=a;break;default:return null;}return a&&0!=a.length?r:null;},createDevice:function createDevice(e,t,o){var r=xnm.aio.homekit.DM;e?e.type?o(null,e):o(new r.Error(r.Error.ERROR_CODE.INVALID,"type is missing")):o(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},createGateway:function createGateway(e,t,o){var r=xnm.aio.homekit.DM;e?o(null,e):o(new r.Error(r.ERROR.ERROR_CODE.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o&&o();},deleteGateway:function deleteGateway(e,t,o){o&&o();},getCommandStatusMap:function getCommandStatusMap(e,t){var o={command:[],status:[]};if("scene"===e.type)return o.command.push({name:"scene",type:"enum",ref:{value:"scene"}}),o;var r={command:{"enum":"%e","float":"%f","int":"%d",rgb:"%rgb",rgbw:"%rgbw",string:"%s"}};r.state=JSON.parse(JSON.stringify(r.command)),r.state.rgb="%s",r.state.rgbw="%s";var a={},convert=function convert(e,t,o){var n={name:t,type:"enum",ref:{value:t}},i=null;return o.value&&"object"==_typeof(o.value)&&("string"==typeof o.value.type&&("bool"===(i=String(o.value.type).toLowerCase())&&(i="enum"),n.type=i,r[e][i]&&(n.ref.ext=r[e][i])),["number","string"].indexOf(_typeof(o.value.min))>=0&&["number","string"].indexOf(_typeof(o.value.max))>=0&&(n.ref.extMeta=String(o.value.min)+"-"+String(o.value.max)),"command"===e&&n.ref.extMeta&&(a[t]={},a[t].extMeta=n.ref.extMeta)),"string"==typeof o.type&&("bool"===(i=String(o.type).toLowerCase())&&(i="enum",n.ref.options=["true","false"]),n.type=i,r[e][i]&&(n.ref.ext=r[e][i])),Array.isArray(o.values)&&(n.ref.ext="%e","command"===e?n.ref.extMeta||(n.ref.extMeta=o.values.slice(0)):n.ref.options=o.values.slice(0)),n;};if(e.commands&&"object"==_typeof(e.commands))for(var n in e.commands){var i=e.commands[n];o.command.push(convert("command",n,i));}if(e.states&&"object"==_typeof(e.states))for(var s in e.states){var l=e.states[s];o.status.push(convert("state",s,l));}for(var c in a){for(var m=a[c],u=0;u<o.status.length;u++){var p=o.status[u];if(p.name===c){!p.ref.extMeta&&m.extMeta&&(p.ref.extMeta=m.extMeta);break;}}}return o;},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"HomeKit"}];},supportSmartWidget:function supportSmartWidget(e){if(!e||!e.type)return!1;if(!e.commands&&!e.states)return!1;return["airPurifier","airQualitySensor","blind","contactSensor","dioxideSensor","door","fan","heater","leakSensor","light","motionSensor","occupancySensor","sensor","shutter","smokeSensor","speaker","switch","thermostat","window"].includes(e.type);},toGeneralDevice:function toGeneralDevice(e){return null;},updateDevice:function updateDevice(e,t,o){var r=xnm.aio.homekit.DM;e?e.type?o(null,e):o(new r.Error(r.Error.ERROR_CODE.INVALID,"type is missing")):o(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},updateGateway:function updateGateway(e,t,o,r){var a=xnm.aio.homekit.DM;t?r(null,t):r(new a.Error(a.Error.ERROR_CODE.INVALID,"update is invalid"));}},xnm.aio.homekit.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.homekit.DM.Error.prototype=new Error(),xnm.aio.homekit.DM.Error.prototype.name="HomeKitDMError",xnm.aio.homekit.DM.Error.prototype.code=0,xnm.aio.homekit.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4},xnm.aio.homekit.Handler=xnm.aio.homekit.XCHomeKit,xnm.aio.homekit.Handler.prototype.devicemanager=xnm.aio.homekit.DM,xnm.aio.homekit.Handler.prototype._buildRequestOptions=function(e,t){var o=require("url").parse(e.url),r={headers:{Authorization:e.basicAuth,"Content-Type":"application/json"},host:o.hostname,method:t||"GET",path:o.path,port:o.port};return 0!==r.headers.Authorization.indexOf("Basic ")&&(r.headers.Authorization="Basic "+r.headers.Authorization),r.port||(r.port=443),r;},xnm.aio.homekit.Handler.prototype.deleteFromServer=function(e,t){this._logger.log("trace","deleteFromServer()"),this.exportToServer(e,"",t);},xnm.aio.homekit.Handler.prototype.executeCommandCreator=function(e,t,o){if(t&&t.value){var r=this;"scene"===e.type?this.doScene(e.id,function(e){r.updateStates(),o&&o(e);}):this.executeCommand(e.id,t.value,t.ext,function(t){r.updateStates([e.id]),o&&o(t);});}else o&&o(new Error("Command value is empty."));},xnm.aio.homekit.Handler.prototype.exportToServer=function(e,t,o){this._logger.log("trace","exportToServer()");var r=null;try{if("string"==typeof t&&0===t.length)r=t;else{var a={encrypted:!1,data:t};if(e.password){a.encrypted=!0,r=JSON.stringify(a.data);var n=require("x.crypt");a.data=n.AES.encodeString(r,e.password),a.data=a.data.replace(/[\r\n]/g,"");}r=JSON.stringify(a);}}catch(e){return this._logger.log("error",e.message),void(o&&o(e));}var i=require("https"),s=this._buildRequestOptions(e,"POST"),l=this,c=i.request(s,function(e){var t="";e.on("data",function(e){t+=String(e);}),e.on("end",function(){var e=null;0===t.indexOf('{"XC_ERR":')?(e=new Error(t),l._logger.log("error","exportToServer: "+e.message)):l._logger.log("debug","Data has been exported."),o(e,t);});});"function"==typeof c.setEncoding&&c.setEncoding("utf-8"),c.on("error",function(e){l._logger.log("error",e.message),o(e,null);}),c.write(r),c.end();},xnm.aio.homekit.Handler.prototype.getStatesCreator=function(e,t,o){this.getStates(function(e){for(var r=[],a=0;a<t.length;a++){var n=t[a];if(n&&n.id&&n.status){var i=e[n.device.id];if(i){var s=i[n.status.value];null!=s&&r.push({id:n.id,status:s});}}}o&&o(null,r);});},xnm.aio.homekit.Handler.prototype.importFromServer=function(e,t){this._logger.log("trace","importFromServer()");var o=require("https"),r=this._buildRequestOptions(e,"GET"),a=this,n=o.request(r,function(o){var r="";o.on("data",function(e){r+=String(e);}),o.on("end",function(){var o=null,n=null;try{o=JSON.parse(r);}catch(s){return void t(s,r);}var i=o,s=null;if(o.XC_SUC){if(i=(n=o.XC_SUC).data,n.encrypted)if(e.password)try{var l=require("x.crypt");i=i.replace(/[\r\n]/g,""),(i=l.AES.decodeString(i,e.password))&&(i=JSON.parse(i)),i||(s=new Error("Could not decrypt data, wrong password."));}catch(e){s=e;}else s=new Error("Data is encrypted, but no password has been provided.");}else o.XC_ERR&&(s="000000"===(i=o.XC_ERR).code&&"internal error"===i.msg?new Error("No exported data available."):new Error(r));s?a._logger.log("error",s.message):a._logger.log("debug","Data has been received."),t(s,i);});});"function"==typeof n.setEncoding&&n.setEncoding("utf-8"),n.on("error",function(e){a._logger.log("error",e.message),t(e,null);}),n.end();},xnm.aio.homekit.Handler.prototype.registModule=function(e){e.register(xnm.aio.homekit.DM.SYS,"homekit");},xnm.aio.homekit.Handler.prototype.resolveDevice=function(e){return this;},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.homekit.Handler());