var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.tplink=xnm.aio.tplink||{},xnm.aio.tplink.SmartPlug=function(t,e){this._host=t,this._port=e,this._port||(this._port=9999),this._timeout=2e3,this.CommandHandler=null;},xnm.aio.tplink.SmartPlug.prototype._decryptData=function(t){var e=null;if(t&&t.length>4&&t[3]+(t[2]<<8)==t.length-4){e="";for(var n=171,o=4;o<t.length;o++){e.charCodeAt(o);var i=n^t[o];n=t[o],e+=String.fromCharCode(i);}}return e;},xnm.aio.tplink.SmartPlug.prototype._send=function(t,e){for(var n=[0,0,0,0],o=JSON.stringify(e),i=171,a=0;a<o.length;a++){var r=i^o.charCodeAt(a);i=r,n.push(r);}n[3]=n.length-4;var s=new Buffer(n);t&&t.write(s);},xnm.aio.tplink.SmartPlug.prototype._doRequest=function(t,e){var n=require("net"),o=this,i=n.connect({port:this._port,host:this._host});i.setTimeout(this._timeout),i.on("connect",function(){o._send(i,t);}),i.on("data",function(t){var n=o._decryptData(t),i=null;try{i=JSON.parse(n);}catch(t){}e&&e(i);}),i.on("error",function(t){e&&e(null);}),i.on("timeout",function(){i&&i.destroy(),e&&e(null);}),i.on("close",function(){i=null;});},xnm.aio.tplink.SmartPlug.prototype.executeCommand=function(t,e,n){var o=null;if("on"==e)o={system:{set_relay_state:{state:1}}};else if("off"==e)o={system:{set_relay_state:{state:0}}};else if("ledOn"==e)o={system:{set_led_off:{off:0}}};else if("ledOff"==e)o={system:{set_led_off:{off:1}}};else if("toggle"==e||"toggleLED"==e){var i=this;this.getState(function(o){o?"toggle"==e?"off"==o.state?i.executeCommand(t,"on",n):i.executeCommand(t,"off",n):"toggleLED"==e&&("off"==o.led?i.executeCommand(t,"ledOn",n):i.executeCommand(t,"ledOff",n)):n&&n();});}else n&&n();o&&this._doRequest(o,function(t,e){n&&n();});},xnm.aio.tplink.SmartPlug.prototype.getState=function(t){var e=this;this._doRequest({system:{get_sysinfo:{}}},function(n,o){var i={state:"?"};n&&n.system&&n.system.get_sysinfo?(1==n.system.get_sysinfo.relay_state?i.state="on":0==n.system.get_sysinfo.relay_state&&(i.state="off"),1==n.system.get_sysinfo.led_off?i.led="off":0==n.system.get_sysinfo.led_off&&(i.led="on"),e._doRequest({emeter:{get_realtime:{}}},function(e,n){e&&e.emeter&&e.emeter.get_realtime&&(i.current=e.emeter.get_realtime.current,i.power=e.emeter.get_realtime.power),t&&t(i);})):t&&t(i);});},xnm.aio.tplink.SmartPlug.prototype.getStates=function(t,e,n){var o=this;this.CommandHandler=t,this.getState(function(t){device&&o.CommandHandler.setState?o.CommandHandler.setState(device.id,t.state):o.CommandHandler.receivedState&&o.CommandHandler.receivedState("tplink",o.host,t),n&&n(t);});},xnm.aio.tplink.SmartPlug.prototype.getStateValues=function(t,e){return e;},xnm.aio.tplink.Handler=function(){this.detectedSmartPlugs={};},xnm.aio.tplink.Handler.prototype.discoverSmartPlugs=function(t){},xnm.aio.tplink.Handler.prototype.SmartPlug=xnm.aio.tplink.SmartPlug,xnm.aio.tplink.Handler.prototype.getStateValues=function(t,e){return new xnm.aio.tplink.SmartPlug().getStateValues(t.type,e);},xnm.aio.tplink.Handler.prototype.getDeviceCommandList=function(t,e,n){var o=[];return o.push({id:"on",cmd:"on"}),o.push({id:"off",cmd:"off"}),o.push({id:"toggle",cmd:"toggle"}),o;},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tplink.Handler());