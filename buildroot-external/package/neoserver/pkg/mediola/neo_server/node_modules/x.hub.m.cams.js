var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.cams=x.hub.m.cams||{},x.hub.m.cams.CAMS_MODULE=require("xnm.aio.cams.js"),x.hub.m.cams.DoorBirdMonitor=function(){var Monitor=function Monitor(o,r){this._id=this._gentId(o),this._logger=require("x.logger.js").getLogger("x.hub.m.cams.DoorBirdMonitor.["+this._id+"]"),this._handler=r,this._doorbird=o,this._metaInfos=[],this._running=!1,this._monitor=null,this._stateBuffer={};};return Monitor.prototype._gentId=function(o){return o.username+"@"+o.ip;},Monitor.prototype.start=function(){if(this._logger.log("debug","start monitor"),!this._running){this._running=!0;var o=this._handler.getDoorBirdHandler().addMonitor(this._doorbird);o.addListener(this),this._monitor=o;}},Monitor.prototype.stop=function(o){(this._logger.log("debug","stop monitor"),this._running)?this._metaInfos.length>0?o&&o(null,!1):(this._running=!1,this._monitor.removeListener(this),this._handler.getDoorBirdHandler().removeMonitor(this._doorbird),o&&o(null,!0)):o&&o(null,!0);},Monitor.prototype.addMetaInfo=function(o){for(var r=0;r<this._metaInfos.length;r++){var t=this._metaInfos[r];if(t&&t.callback&&t.callback===o.callback)return;}this._metaInfos.push(o);},Monitor.prototype.removeMetaInfo=function(o){for(var r=-1,t=0;t<this._metaInfos.length;t++){var e=this._metaInfos[t];if(e&&e.callback&&e.callback===o.callback){r=t;break;}}-1!=r&&this._metaInfos.splice(r,1);},Monitor.prototype.updateDoorbird=function(o){if(this._doorbirdJSON&&this._doorbirdJSON.mac&&this._doorbirdJSON.mac==o.mac&&this._doorbirdJSON.ip!=o.ip){this._logger.log("debug","doorbird has new ip:"+o.ip),this._doorbirdJSON.ip=o.ip;var r=this._gentId(this._doorbirdJSON.ip);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Monitor.["+r+"]"),this._monitor&&this._monitor.updateDoorbird(o);}},Monitor.prototype.onEvent=function(o,r){var t=new Date().getTime(),e=this._stateBuffer[o],i=!1,n=null;if(e){n=e[0];var a=e[1];(r!=n||1==r&&t-a>3e3)&&(i=!0);}else i=!0;if(this._stateBuffer[o]=[r,t],this._logger.log("debug","event:"+o+"="+r+"("+(i?"changed":"not changed")+")"),i){var s={key:o,value:r,oldvalue:n,changed:!0};this._invokeCallback({module:"cams",device:this._doorbird,data:s});}},Monitor.prototype._invokeCallback=function(o){for(var r=o.data.key,t=0;t<this._metaInfos.length;t++){var e=this._metaInfos[t];if(e&&e.statusKey==r&&e.callback&&e.callback.onEvent)try{e.callback.onEvent(o);}catch(o){}}},Monitor;}(),x.hub.m.cams.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.m.cams.Handler"),this._doorBirdMonitors={},this._doorBirdHandler=x.hub.m.cams.CAMS_MODULE.getDoorBirdHandler(),this._searchTo=null,this._searchPeriod=3e5;};return util.inherits(Handler,EventEmitter),Handler.prototype.init=function(o){this._startPeriodicalSearch(),this._doorBirdHandler.startUdpMonitor(),o&&o();},Handler.prototype.getSystems=function(){return["cam"];},Handler.prototype.addStateDevice=function(o,r,t){!o||"system"!=o.type||"doorbird"!=o.manufacturer&&"doorbird"!=o.type||"doorbird"!=o.model?r&&r({error:new Error("device json format invalid")}):this._startDoorBirdMonitor(o,function(o){r&&r({error:o});},t);},Handler.prototype.removeStateDevice=function(o,r,t){!o||"system"!=o.type||"doorbird"!=o.manufacturer&&"doorbird"!=o.type||"doorbird"!=o.model?r&&r({error:new Error("device json format invalid")}):this._stopDoorBirdMonitor(o,function(o){r&&r({error:o});},t);},Handler.prototype.getAllStates=function(){return[];},Handler.prototype.getStates=function(o){return null;},Handler.prototype.getState=function(o,r,t){require("x.hub.commandman.js").commandHandler.getStateLegacy(o,null,{value:r},t);},Handler.prototype.executeCommand=function(o,r,t){require("x.hub.commandman.js").commandHandler.executeCommandLegacy(o,null,r,t);},Handler.prototype.checkDeviceMatch=function(o,r){return!!(r&&r.device&&o&&o.device)&&r.device.manufacturer==o.device.manufacturer&&r.device.model==o.device.model&&r.device.ip==o.device.ip;},Handler.prototype.getDoorBirdHandler=function(){return this._doorBirdHandler;},Handler.prototype._startDoorBirdMonitor=function(o,r,t){if(o&&o.ip&&o.username){var e=o.username;if(this._doorBirdMonitors[e])return t&&t.callback&&this._doorBirdMonitors[e].addMetaInfo(t),void(r&&r(null,this._doorBirdMonitors[e]));if(x.hub.m.cams.CAMS_MODULE.resolveDevice(o)){var i=JSON.parse(JSON.stringify(o)),n=new x.hub.m.cams.DoorBirdMonitor(i,this);this._doorBirdMonitors[e]=n,t&&t.callback&&n.addMetaInfo(t),n.start(),r&&r(null,n);}else r&&r(new Error("doorbird json format invalid"));}else r&&r(new Error("doorbird json format invalid"));},Handler.prototype._stopDoorBirdMonitor=function(o,r,t){if(o&&o.ip&&o.username){var e=this,i=o.username,n=this._doorBirdMonitors[i];n?(t&&t.callback&&n.removeMetaInfo(t),n.stop(function(o,t){!o&&t&&delete e._doorBirdMonitors[i],r&&r(o,t);})):r&&r();}else r&&r(new Error("doorbird json format invalid"));},Handler.prototype._startPeriodicalSearch=function(){var o=this,_findDoorbirds=function _findDoorbirds(r){for(var t=0;t<r.length;t++){var e=r[t];if(e._options)for(var i in o._logger.log("trace","find doorbird:"+JSON.stringify(e._options)),o._doorBirdMonitors){o._doorBirdMonitors[i].updateDoorbird(e._options);}}},_nextSearch=function _nextSearch(){o._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5e3,function(o,r){!o&&r&&_findDoorbirds(r),_nextSearch();});},o._searchPeriod);};this._searchTo=setTimeout(function(){x.hub.m.cams.CAMS_MODULE.discoverDoorbird(5e3,function(o,r){!o&&r&&_findDoorbirds(r),_nextSearch();});},1e4);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.cams.Handler());