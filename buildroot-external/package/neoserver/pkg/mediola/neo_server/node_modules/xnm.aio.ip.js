var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.ip=xnm.aio.ip||{},xnm.aio.ip.Http=function(){var Http=function Http(e,t){this._options=e,this._deviceInfo=t;};return Http.prototype.executeCommandCreator=function(e,t,o){this.executeCommand(t.value,function(e){o&&o(e);});},Http.prototype.executeCommand=function(e,t){if(e){if(this._options&&this._options.ip){var o=this._getPort();if(o){var i=this._getMethod();if(i){var n=this._buildControlUrl(e);if(n){var r=this._buildPostData(e),s=this._buildHttpHeader(e),p={host:this._options.ip,port:o,path:n,method:i,username:this._options.username,password:this._options.password,headers:s};this._doRequest(p,r,function(e,o){t&&t(e,o);});}else t&&t(new Error("build control url error"));}else t&&t(new Error("build method error"));}else t&&t(new Error("build port error"));}else t&&t(new Error("ip is empty"));}else t&&t(new Error("command is empty"));},Http.prototype._getPort=function(){if(this._options&&this._options.port&&this._options.port>0)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var e=parseInt(this._deviceInfo.controlport);return e<=0?0:e;},Http.prototype._getMethod=function(){return this._deviceInfo?this._deviceInfo.controlpostdata?"POST":this._deviceInfo.controlurl?"GET":null:null;},Http.prototype._buildControlUrl=function(e){if(!this._deviceInfo||!this._deviceInfo.controlurl)return null;var t=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlurl),o=this._getCommandCode(e);return o?(o=xnm.aio.ip.Util._decodeXml(o),t.replace("%@",o)):null;},Http.prototype._buildPostData=function(e){if(!this._deviceInfo||!this._deviceInfo.controlpostdata)return null;var t=xnm.aio.ip.Util._decodeXml(this._deviceInfo.controlpostdata),o=this._getCommandCode(e);return o?(o=xnm.aio.ip.Util._decodeXml(o),t.replace("%@",o)):null;},Http.prototype._buildHttpHeader=function(e){if(!this._deviceInfo||!this._deviceInfo.httpheader)return{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"};var t={},o=xnm.aio.ip.Util._decodeXml(this._deviceInfo.httpheader).split("|");if(o&&o.length>0)for(var i=0;i<o.length;i++){var n=o[i].trim();if(n){var r=n.indexOf(":");if(-1!=r){var s=n.substr(0,r),p=n.substr(r+1);s&&(t[s]=p);}}}return t;},Http.prototype._getCommandCode=function(e){if(!e||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var t=0;t<this._deviceInfo.keys.length;t++){var o=this._deviceInfo.keys[t];if(o.id&&o.id==e)return o.code;}return null;},Http.prototype._doRequest=function(e,t,o){var i={host:e.host,port:e.port,path:e.path,method:e.method,headers:e.headers};e.username&&(e.password||(e.password=""),i.user=e.username,i.password=e.password,i.headers.Authorization="Basic "+new Buffer(e.username+":"+e.password).toString("base64")),t&&(i.headers["Content-Length"]=t.length);var n=require("http").request(i,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var i;200!=e.statusCode&&(i=new Error("http response:"+e.statusCode)),o&&o(i,t);});});n.on&&n.on("error",function(e){o&&o(e);}),t&&n.write(t),n.end();},Http;}(),xnm.aio.ip.Tcp=function(){var Tcp=function Tcp(e,t){this._options=e,this._deviceInfo=t,this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Tcp");};return Tcp.prototype.executeCommandCreator=function(e,t,o){this.executeCommand(t.value,function(e){o&&o(e);});},Tcp.prototype.executeCommand=function(e,t){if(e){if(this._options&&this._options.ip){if(this._getPort()){var o=this._buildTcpData(e);if(o){var i="utf8";switch(this._deviceInfo.tcptype){case"text":case"textnl":case"pioneer":i="utf8";break;case"binary":i="binary",o=new Buffer(o);}this._doRequest(o,i,function(e){setTimeout(function(){t&&t(e);},150);});}else t&&t(new Error("build data return null"));}else t&&t(new Error("build port error"));}else t&&t(new Error("ip is empty"));}else t&&t(new Error("command is empty"));},Tcp.prototype._getPort=function(){if(this._options&&this._options.port&&this._options.port>0)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var e=parseInt(this._deviceInfo.controlport);return e<=0?0:e;},Tcp.prototype._buildTcpData=function(e){if(!this._deviceInfo||!this._deviceInfo.tcptype)return null;var t=this._getCommandCode(e);if(!t)return null;switch(t=xnm.aio.ip.Util._decodeXml(t),this._deviceInfo.tcptype){case"text":return t;case"textnl":case"pioneer":return t+"\r";case"binary":return xnm.aio.ip.Util._hex2arr(t);default:return null;}},Tcp.prototype._getCommandCode=function(e){if(!e||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var t=0;t<this._deviceInfo.keys.length;t++){var o=this._deviceInfo.keys[t];if(o.id&&o.id==e)return o.code;}return null;},Tcp.prototype._doRequest=function(e,t,o){var i=this,n={port:this._options.port,host:this._options.ip},r=!1,s=!1,p=o,a=require("net").connect(n);a.setTimeout(1e3),t&&"binary"!=t&&a.setEncoding(t),this._logger.log("trace","try to connect tcp to:"+i._options.ip),a.on("connect",function(){i._logger.log("trace","tcp connected to:"+i._options.ip),i._logger.log("trace","write data:"+e.toString()),r=!0,a.write(e,t),s=!0;}),a.on("data",function(e){i._logger.log("trace","receive from tcp:"+i._options.ip+" data:"+e),s&&a.end();}),a.on("error",function(e){r?(i._logger.log("trace","tcp:"+i._options.ip+" error:"+e.message),a.end(),p&&(p(e),p=null)):(i._logger.log("trace","tcp:"+i._options.ip+" connection error:"+e.message),p&&(p(e),p=null));}),a.on("timeout",function(){r?(i._logger.log("trace","tcp:"+i._options.ip+" data timeout"),a.end(),p&&(p(),p=null)):(i._logger.log("trace","tcp:"+i._options.ip+" connection timeout"),a.end(),p&&(p(new Error("connection timeout")),p=null));}),a.on("close",function(){i._logger.log("trace","tcp:"+i._options.ip+" close socket"),p&&(p(),p=null);}),a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();},Tcp;}(),xnm.aio.ip.Udp=function(){var Udp=function Udp(e,t){this._options=e,this._deviceInfo=t,this._logger=require("x.logger.js").getLogger("xnm.aio.ip.Udp");};return Udp.prototype.executeCommandCreator=function(e,t,o){this.executeCommand(t.value,function(e){o&&o(e);});},Udp.prototype.executeCommand=function(e,t){if(e){if(this._options&&this._options.ip){if(this._getPort()){var o=this._buildUdpData(e);o?this._doRequest(new Buffer(o),function(e){t&&t(e);}):t&&t(new Error("build data return null"));}else t&&t(new Error("build port error"));}else t&&t(new Error("ip is empty"));}else t&&t(new Error("command is empty"));},Udp.prototype._getPort=function(){if(this._options&&this._options.port&&this._options.port>0)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var e=parseInt(this._deviceInfo.controlport);return e<=0?0:e;},Udp.prototype._buildUdpData=function(e){if(!this._deviceInfo||!this._deviceInfo.udptype)return null;var t=this._getCommandCode(e);if(!t)return null;switch(t=xnm.aio.ip.Util._decodeXml(t),this._deviceInfo.udptype){case"text":return t;case"textnl":return t+"\r";case"binary":return xnm.aio.ip.Util._hex2arr(t);default:return null;}},Udp.prototype._getCommandCode=function(e){if(!e||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var t=0;t<this._deviceInfo.keys.length;t++){var o=this._deviceInfo.keys[t];if(o.id&&o.id==e)return o.code;}return null;},Udp.prototype._doRequest=function(e,t){var o=require("dgram").createSocket("udp4");o.send(e,0,e.length,this._options.port,this._options.ip,function(e){o.close(),t&&t(e);});},Udp;}(),xnm.aio.ip._Proxy=function(){var Proxy=function Proxy(e,t){this._options=e,this._deviceInfo=t,this._logger=require("x.logger.js").getLogger("xnm.aio.ip._Proxy");};return Proxy.prototype.executeCommandCreator=function(e,t,o){this.executeCommand(t.value,function(e){o&&o(e);});},Proxy.prototype.executeCommand=function(e,t){if(e){if(this._options&&this._options.ip){if(this._getPort()){var o=this._buildData(e);o?this._doRequest(o,function(e){t&&t(e);}):t&&t(new Error("build data return null"));}else t&&t(new Error("build port error"));}else t&&t(new Error("ip is empty"));}else t&&t(new Error("command is empty"));},Proxy.prototype._getPort=function(){if(this._options&&this._options.port&&this._options.port>0)return this._options.port;if(!this._deviceInfo||!this._deviceInfo.controlport)return 0;var e=parseInt(this._deviceInfo.controlport);return e<=0?0:e;},Proxy.prototype._buildData=function(e){if(!this._deviceInfo)return null;var t=this._getCommandCode(e);return t?xnm.aio.ip.Util._decodeXml(t):null;},Proxy.prototype._getCommandCode=function(e){if(!e||!this._deviceInfo||!this._deviceInfo.keys)return null;for(var t=0;t<this._deviceInfo.keys.length;t++){var o=this._deviceInfo.keys[t];if(o.id&&o.id==e)return o.code;}return null;},Proxy.prototype._doRequest=function(e,t){if("samsung_tv"==this._deviceInfo.id)new(0,require("xnm.aio.samsung.js").SamsungTV)(this._options.ip,this._getPort())._executeCommand(e,function(e){t&&t(e);});else if(this._deviceInfo.ircccontrolurl){var o=new(0,require("xnm.aio.sony.js").IRCC)(this._options.ip,this._getPort(),this._deviceInfo.ircccontrolurl);this._deviceInfo.presharedkey&&(o._presharedkey=this._deviceInfo.presharedkey),o._executeCommand(e,function(e){t&&t(e);});}else if(this._deviceInfo.pnccontrolurl){new(0,require("xnm.aio.panasonic.js").TV)(this._options.ip,this._getPort(),this._deviceInfo.pnccontrolurl)._executeCommand(e,function(e){t&&t(e);});}else if("onkyo"==this._deviceInfo.tcptype){new(0,require("xnm.aio.onkyo.js").AVReceiver)(this._options.ip,this._getPort()).executeCommand(e,function(e){t&&t(e);});}else if("lgav"==this._deviceInfo.tcptype){new(0,require("xnm.aio.lg.js").BDP)(this._options.ip,this._getPort())._executeCommand(e,function(e){t&&t(e);});}else if("panasonicbdp"==this._deviceInfo.tcptype){new(0,require("xnm.aio.panasonic.js").BDP)(this._options.ip,this._getPort())._executeCommand(e,function(e){t&&t(e);});}else if("lgtv"==this._deviceInfo.tcptype){var i=require("xnm.aio.lg.js");new("lgtv2012"==this._deviceInfo.id?i.TV2012:i.TV)(this._options.ip,this._getPort(),this._options.authKey)._executeCommand(e,function(e){t&&t(e);});}else if("philips2011"==this._deviceInfo.tcptype){new(0,require("xnm.aio.philips.js").JointSpaceTV)(this._options.ip,this._getPort())._executeCommand(e,function(e){t&&t(e);});}else t&&t(new Error("unknow ip device proxy type"));},Proxy;}(),xnm.aio.ip.Util={_decodeXml:function _decodeXml(e){return e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");},_hex2arr:function _hex2arr(e){for(var t=[];e.length>=2;){t.push(parseInt(e.substring(0,2),16)),e=e.substring(2,e.length);}return t;}},xnm.aio.ip.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="IpDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"ip",getIPDeviceType:function getIPDeviceType(e,t){var o=[];if(e){var i=e.getDevices();if(i)for(var n=0;n<i.length;n++){var r=i[n],s=$(r).getAttributes();if(s&&s.id&&s.name){var p=this._deviceinfoXml2Json($(r)),a=this.getDeviceInfoType(p);if(a){var c={sys:this.SYS,type:a,id:s.id,name:s.name,port:s.controlport};if("proxy"==a&&!s.controlport){var u=this._getProxyDeviceClass(p);if(u){var l=new u();c.port=l.port;}}o.push(c);}}}}return o;},createDevice:function createDevice(e,t,o){var i=DMError,n=DMError.ERROR_CODE;e?e.type?e.id?e.ip?o(null,e):o(new i(n.INVALID,"ip is invalid")):o(new i(n.INVALID,"id is invalid")):o(new i(n.INVALID,"type is invalid")):o(new i(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){var i=DMError,n=DMError.ERROR_CODE;e?e.type?e.id?e.ip?o(null,e):o(new i(n.INVALID,"ip is invalid")):o(new i(n.INVALID,"id is invalid")):o(new i(n.INVALID,"type is invalid")):o(new i(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t,o){var _contains=function _contains(e,t){if("*"==e)return!0;for(var o=!1,i=0;i<e.length;i++){if(e[i]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var i=[],n=null,r=xnm.aio.ip.DM.getCommandStatusMap(e,o);return r&&(n=function(e,t,o){var i=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));i.push(t);}});}return i;}(r,0,t),i=i.concat(n)),i;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),i.command=n;break;case"status":n=_filter(e,t),i.status=n;break;default:return null;}return n&&0!=n.length?i:null;},getDeviceInfo:function getDeviceInfo(e,t){if(!e.id||!t)return null;var o=function(e,t){var o,i=t.find('device[id="'+e.id+'"]');return i&&i.length>0&&(o=i[0]),o?$(o):null;}(e,t);return o?this._deviceinfoXml2Json(o):null;},getDeviceInfoType:function getDeviceInfoType(e){if("samsung_tv"==e.id||e.ircccontrolurl||e.pnccontrolurl)return"proxy";if(e.tcptype){if("text"==e.tcptype||"textnl"==e.tcptype||"pioneer"==e.tcptype||"binary"==e.tcptype)return"tcp";if("generic"!=e.tcptype)return"proxy";}return e.udptype?"udp":e.controlurl?"http":null;},getCommandStatusMap:function getCommandStatusMap(e,t){var o=this.getDeviceInfo(e,t);if(!o)return null;var i={command:[]};if(o.keys)for(var n=0;n<o.keys.length;n++){var r=o.keys[n];i.command.push({type:"enum",name:r.id,ref:{value:r.id}});}return i;},_getProxyDeviceClass:function _getProxyDeviceClass(e){var t=null;return"samsung_tv"==e.id?t=require("xnm.aio.samsung.js").SamsungTV:e.ircccontrolurl?t=require("xnm.aio.sony.js").IRCC:e.pnccontrolurl?t=require("xnm.aio.panasonic.js").TV:"onkyo"==e.tcptype?t=require("xnm.aio.onkyo.js").AVReceiver:"lgav"==e.tcptype?t=require("xnm.aio.lg.js").BDP:"panasonicbdp"==e.tcptype?t=require("xnm.aio.panasonic.js").BDP:"lgtv"==e.tcptype?t=require("xnm.aio.lg.js").TV:"philips2011"==e.tcptype&&(t=require("xnm.aio.philips.js").JointSpaceTV),t;},_deviceinfoXml2Json:function _deviceinfoXml2Json(e){for(var t=e.getAttributes(),o=JSON.parse(JSON.stringify(t)),i=e.children(),n=0;n<i.length;n++){var r=i[n];if(r){var s=$(r).attr("id"),p=$(r).attr("code");s&&p&&(o.keys||(o.keys=[]),o.keys.push({id:s,code:p}));}}return o;}};}(),xnm.aio.ip.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.ip.DM,Handler.prototype.Http=xnm.aio.ip.Http,Handler.prototype.Tcp=xnm.aio.ip.Tcp,Handler.prototype.Udp=xnm.aio.ip.Udp,Handler.prototype.registModule=function(e){e.register(xnm.aio.ip.DM.SYS,"ip");},Handler.prototype.resolveDevice=function(e,t){var o=xnm.aio.ip.DM.getDeviceInfo(e,t);if(!o)return null;switch(xnm.aio.ip.DM.getDeviceInfoType(o)){case"http":return new xnm.aio.ip.Http(e,o);case"tcp":return new xnm.aio.ip.Tcp(e,o);case"udp":return new xnm.aio.ip.Udp(e,o);case"proxy":return new xnm.aio.ip._Proxy(e,o);default:return null;}},Handler.prototype.getDeviceCommands=function(e,t){var o=xnm.aio.cams.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),i=o?o.command:[];t&&t(null,i);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ip.Handler());