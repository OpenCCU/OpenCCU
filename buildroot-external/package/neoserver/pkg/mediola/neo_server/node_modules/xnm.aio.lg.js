var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.lg=xnm.aio.lg||{},xnm.aio.lg.CRC_TABLE=null,xnm.aio.lg.TV=function(){var TV=function TV(t,e,o){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV"),this.ip=t,this.port=e,(!this.port||this.port<0)&&(this.port=8080),this.udpport=7070,this.authKey=o,this.controlUrl="/hdcp/api/dtv_wifirc",this.authUrl="/hdcp/api/auth";};return TV.AUTHKEY_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthKeyReq</type></auth>',TV.AUTH_REQ='<?xml version="1.0" encoding="utf-8"?><auth><type>AuthReq</type><value>%@</value></auth>',TV.KEY_INPUT='<?xml version="1.0" encoding="utf-8"?><command><session>%@1</session><type>HandleKeyInput</type><value>%@2</value></command>',TV.prototype._executeCommand=function(t,e){if(t){this._logger.log("debug","execute command:"+t);var o=this;this._getSession(function(n,r){if(n)e&&e(n);else if("u"==t.charAt(0).toLowerCase()){var i=t.substr(1),s=o._buildUdpReq(r,i);o._doUdpCommand(s,e);}else o._doHttpCommand(r,t,e);});}else e&&e(new Error("code is empty"));},TV.prototype._showAuthKey=function(t){this._logger.log("debug","auth key");var e=this;this._doRequest(this.authUrl,TV.AUTHKEY_REQ,function(o){e._logger.log("warn","auth key "+(o?"error:"+o.message:"success")),t&&t(o);});},TV.prototype._getSession=function(t){if(!this.authKey)return this._logger.log("warn","no auth key"),void(t&&t(new Error("no auth key")));this._logger.log("debug","get session");var e=TV.AUTH_REQ.replace("%@",this.authKey),o=this;this._doRequest(this.authUrl,e,function(e,n){if(e)return o._logger.log("warn","get session http error:"+e.message),void(t&&t(e));var r;if(n){var i=n.indexOf("<session>"),s=n.indexOf("</session>");-1!=i&&-1!=s&&s-i>9&&(r=n.substring(i+9,s));}if(!r)return o._logger.log("warn","get session reponse error"),void(t&&t(new Error("get session reponse error")));o._logger.log("debug","get session success:"+r),t&&t(null,r);});},TV.prototype._doHttpCommand=function(t,e,o){var n=TV.KEY_INPUT.replace("%@1",t);n=n.replace("%@2",e),this._logger.log("debug","do http command:"+e),this._doRequest(this.controlUrl,n,function(t){o&&o(t);});},TV.prototype._buildUdpReq=function(t,e){var o=parseInt(t),n=[0,0,0,0];n.push(255&o),n.push(o>>8&255),n.push(o>>16&255),n.push(o>>24&255);for(var r=0;r<e.length;r+=2){var i=e.substr(r,2);i=parseInt(i,16),n.push(i);}var s=this._crc32(n);return n[0]=255&s,n[1]=s>>8&255,n[2]=s>>16&255,n[3]=s>>24&255,n;},TV.prototype._doUdpCommand=function(t,e){var o=require("dgram").createSocket("udp4"),n=new Buffer(t);o.send(n,0,n.length,this.udpport,this.ip,function(t){o.close(),e&&e(t);});},TV.prototype._doRequest=function(t,e,o){var n=this,r="http://"+this.ip+":"+this.port+t;this._logger.log("trace","send data:"+e);var i=o;$.ajax({url:r,type:"POST",timeout:3e3,data:e,dataType:"text",cache:!1,headers:{"Content-Type":"application/atom+xml","Content-Length":e.length},username:this.username,password:this.password,success:function success(t){n._logger.log("trace","http request success:"+t),i&&(i(null,t),i=null);},error:function error(t,e){var o="http request error:"+(t?t.status:"0")+"-"+e;i&&(i(new Error(o)),i=null);}});},TV.prototype._crc32=function(t){for(var e=xnm.aio.lg.CRC_TABLE||(xnm.aio.lg.CRC_TABLE=this._makeCRCTable()),o=-1,n=0;n<t.length;n++){o=o>>>8^e[255&(o^t[n])];}return(-1^o)>>>0;},TV.prototype._makeCRCTable=function(){for(var t,e=[],o=0;o<256;o++){t=o;for(var n=0;n<8;n++){t=1&t?3988292384^t>>>1:t>>>1;}e[o]=t;}return e;},TV;}(),xnm.aio.lg.TV2012=function(){var TV=function TV(t,e,o){xnm.aio.lg.TV.call(this,t,e,o),this._logger=require("x.logger.js").getLogger("xnm.aio.lg.TV2012"),this.controlUrl="/roap/api/command",this.authUrl="/roap/api/auth";};return(TV.prototype=Object.create(xnm.aio.lg.TV.prototype)).constructor=TV,TV;}(),xnm.aio.lg.BDP=function(){var CommandTask=function CommandTask(t,e,o){this.bdp=t,this.code=e,this.callback=o,this._socket=null;};CommandTask.prototype.run=function(){var t=this,e={onError:function onError(e){t._finish(e);},onTimeout:function onTimeout(){t._finish(new Error("response timeout"));},onData:function onData(){t._socket.end(),t._finish();},onClose:function onClose(){t._finish();}};this.bdp._connect(e,function(e,o){if(e)t._finish(e);else{t._socket=o;var n=t.bdp._buildReq(t.code);t.bdp._logger&&t.bdp._logger.log("trace","send lg bdp request:"+n),o.write(n,"hex");}});},CommandTask.prototype._finish=function(t){t&&this.bdp._logger.log("warn","execute lg bdp command error:"+t.message),this.callback&&this.callback(t),this.callback=null,this.bdp._finishTask(this);};var BDP=function BDP(t,e){this._logger=require("x.logger.js").getLogger("xnm.aio.lg.BDP"),this.ip=t,this.port=e,this.port||(this.port=9740),this._tasks=[];};return BDP.prototype._executeCommand=function(t,e){var o=new CommandTask(this,t,e);this._tasks.push(o),o.run();},BDP.prototype._finishTask=function(t){for(var e=-1,o=0;o<this._tasks.length;o++){if(this._tasks[o]===t){e=o;break;}}-1!=e&&this._tasks.splice(e,1);},BDP.prototype._buildReq=function(t){return t.length<30?t+"02"+t+"01":t;},BDP.prototype._hex2arr=function(t){for(var e=[],o=0;o<t.length;o+=2){e.push(parseInt(t.substr(o,2),16));}return e;},BDP.prototype._connect=function(t,e){var o=this,n={port:this.port,host:this.ip},r=!1,i=e,s=require("net").connect(n);t.__socket=s,s.setTimeout(1e4),s.setEncoding("hex"),s.on("connect",function(){if(o._logger.log("trace","connect tcp to:"+o.ip),r=!0,i){var e=t.__socket;delete t.__socket,i(null,e);}}),s.on("data",function(e){o._logger.log("trace","receive from tcp:"+o.ip+" data:"+e),t.onData(e);}),s.on("error",function(e){r?(o._logger.log("trace","tcp:"+o.ip+" error:"+e.message),s.end(),t.onError(e)):(o._logger.log("trace","tcp:"+o.ip+" connection error:"+e.message),i&&(i(e),i=null));}),s.on("timeout",function(){r?(o._logger.log("trace","tcp:"+o.ip+" data timeout"),s.end(),t.onTimeout()):(o._logger.log("trace","tcp:"+o.ip+" connection timeout"),s.end(),i&&(i(new Error("connection timeout")),i=null));}),s.on("close",function(){o._logger.log("trace","tcp:"+o.ip+" close socket"),t.onClose();}),s._doConnect&&"function"==typeof s._doConnect&&s._doConnect();},BDP;}(),xnm.aio.lg.BDP.DM={SYS:"lgav",getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"LG BDP"};}},xnm.aio.lg.DM=function(){var DMError=function DMError(t,e){this.code=t,this.message=e,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="LGDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{getSys:function getSys(){var t=[];for(var e in xnm.aio.lg){xnm.aio.lg.hasOwnProperty(e)&&xnm.aio.lg[e]&&xnm.aio.lg[e].DM&&t.push(xnm.aio.lg[e]);}return t;},registModule:function registModule(t){for(var e=this.getSys(),o=0;o<e.length;o++){e[o]&&e[o].DM&&e[o].DM.SYS&&t.register(e[o].DM.SYS,"lg");}},getIPDeviceType:function getIPDeviceType(){return[];}};}(),xnm.aio.lg.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.lg.DM,Handler.prototype.BDP=xnm.aio.lg.BDP,Handler.prototype.TV=xnm.aio.lg.TV,Handler.prototype.TV2012=xnm.aio.lg.TV2012,Handler.prototype.registModule=function(t){this.devicemanager.registModule(t);},Handler.prototype.showAuthKey=function(t,e){if(t&&t.ip){var o=new xnm.aio.lg.TV(t.ip,t.port);"lgtv2012"==t.id&&(o=new xnm.aio.lg.TV2012(t.ip,t.port)),o._showAuthKey(e);}else e&&e(new Error("device json invalid format"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.lg.Handler());