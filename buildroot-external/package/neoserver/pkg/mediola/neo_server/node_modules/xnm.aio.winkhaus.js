"use strict";function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.winkhaus={PACKET_TYPE:{UNKNOWN:0,RESPONSE:1,STATE:2,PAIRING_STEP1:3,PAIRING_STEP2:4},logger:{log:function log(e,t){console[e](t);}},concatUint8Arrays:function concatUint8Arrays(){var t=0;for(var _len=arguments.length,e=new Array(_len),_key=0;_key<_len;_key++){e[_key]=arguments[_key];}e.forEach(function(e){return t+=e.length;});var s=new Uint8Array(t);var n=0;return e.forEach(function(e){s.set(e,n),n+=e.length;}),s;},generateRandom:function generateRandom(e){var t=new Uint8Array(e);return t=t.fill().map(function(){return Math.round(255*Math.random());}),t;},getPacketType:function getPacketType(e){if(0===e.length)return this.PACKET_TYPE.UNKNOWN;var t=15&e[0];if(e.length>4){var s=(e[2]<<8)+e[3]+8;if(e.length===s){if(1===t)return this.PACKET_TYPE.STATE;if(6===t)return this.PACKET_TYPE.RESPONSE;}}if(1===t){if(34===e.length||66===e.length)return this.PACKET_TYPE.PAIRING_STEP1;}else if(2===t&&(4===e.length||24===e.length))return this.PACKET_TYPE.PAIRING_STEP2;return this.PACKET_TYPE.UNKNOWN;},isEqualUint8Array:function isEqualUint8Array(e,t){if(e.byteLength!==t.byteLength)return!1;for(var s=0;s<e.length;s++){if(e[s]!==t[s])return!1;}return!0;},parseJSON:function parseJSON(e){return new xnm.aio.winkhaus.doorControl({serialNumber:e.id,ip:e.ip,port:e.port,username:e.username,password:e.password});},strToUint8Array:function strToUint8Array(e,t){var s=Math.min(e.length,(t===null||t===void 0?void 0:t.maxLength)||e.length),n=new Uint8Array(s);for(var _t=0;_t<s;_t++){n[_t]=e.charCodeAt(_t);}return n;},uint8ArrayToStr:function uint8ArrayToStr(e){if("function"==typeof TextDecoder){return new TextDecoder().decode(e);}try{var t=require("util").TextDecoder;return new t().decode(e);}catch(e){xnm.aio.winkhaus.logger.log("error","[uint8ArrayToStr] "+e.message);}return String.fromCharCode.apply(null,e);}},xnm.aio.winkhaus.WebSocket=/*#__PURE__*/function(){function _class(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:443;_classCallCheck(this,_class);this._host=e,this._port=t,this._mode=xnm.aio.winkhaus.WebSocket.MODE.HTTP,this._on={},this._socket=null,this._wsSecKey=xnm.aio.winkhaus.WebSocket.generateSecKey();}_createClass(_class,[{key:"_packageForSending",value:function _packageForSending(e){var t=[];var s=0;if(t[s++]=129,e.byteLength<=125)t[s++]=e.byteLength+128;else{if(!(e.byteLength<=65535))return xnm.aio.winkhaus.logger.log("error","[WebSocket._packageForSending] Message too long: "+e.byteLength),null;t[s++]=254,t[s++]=e.byteLength>>8&255,t[s++]=255&e.byteLength;}var n=[];for(var _e=0;_e<4;_e++){n.push(Math.floor(255*Math.random())),t[s++]=n[_e];}for(var o=0;o<e.length;o++){t[s++]=e[o]^n[o%4];}return new Uint8Array(t);}},{key:"close",value:function close(){this._socket&&(this._socket.destroy(),this._socket=null),this._mode=xnm.aio.winkhaus.WebSocket.MODE.HTTP;}},{key:"connect",value:function connect(){var _this=this;var e=xnm.aio.winkhaus.WebSocket.MODE,t=require("net");this._socket=t.connect({host:this._host,port:this._port}),this._socket.on("connect",function(){xnm.aio.winkhaus.logger.log("debug","[WebSocket] Socket connected to \"".concat(_this._host,"\" on port ").concat(_this._port));var e=["GET /ws HTTP/1.1","Connection: Upgrade","Upgrade: websocket","Sec-WebSocket-Key: "+_this._wsSecKey,"Sec-WebSocket-Version: 13"].join("\n")+"\n\n";_this._socket.write(e);}),this._socket.on("error",function(e){xnm.aio.winkhaus.logger.log("error","[WebSocket] Error: "+e.message),_this._socket&&(_this._socket.end(),_this._socket=null),n=[],_this._on.error&&_this._on.error(e);}),"function"==typeof this._socket._doConnect&&this._socket._doConnect();var s=xnm.aio.winkhaus.PACKET_TYPE;var n=[],o=s.UNKNOWN;this._socket.on("data",function(t){if(xnm.aio.winkhaus.logger.log("debug","[WebSocket] (mode=".concat(_this._mode,") ")+new Uint8Array(t).toString()),_this._mode===e.HTTP){var _s=xnm.aio.winkhaus.uint8ArrayToStr(new Uint8Array(t));_s.startsWith("HTTP/1.1 101")?(xnm.aio.winkhaus.logger.log("debug","[WebSocket] Connection upgrade accepted"),_this._mode=e.WEBSOCKET):xnm.aio.winkhaus.logger.log("debug","[WebSocket] Unexpected HTTP message: "+_s);}else if(_this._mode===e.WEBSOCKET){var _e2=new Uint8Array(t);if(0===_e2.length)return void xnm.aio.winkhaus.logger.log("info","[WebSocket] Empty payload, ignore");if(130===_e2[0]){if(2===_e2.length)return void xnm.aio.winkhaus.logger.log("debug","[WebSocket] Ignoring WebSocket message header without payload: "+_e2.toString());_e2[1]===_e2.length-2&&(_e2=_e2.subarray(2));}var i=xnm.aio.winkhaus.getPacketType(_e2),r=(128&_e2[0])>0;o!==i&&(xnm.aio.winkhaus.logger.log("debug","[WebSocket] Packet type changed from ".concat(o," to ").concat(i,". Resetting collected messages.")),o=i,n=[]),n.push(_e2);(i>0&&r||i===s.PAIRING_STEP1||i===s.PAIRING_STEP2)&&(_this._on.message&&_this._on.message(n),n=[]);}}),this._socket.on("close",function(){xnm.aio.winkhaus.logger.log("debug","[WebSocket] Connection closed"),_this._socket=null,_this._on.close&&_this._on.close();});}},{key:"on",value:function on(e,t){if(!["close","error","message","open"].includes(e))throw new Error("Unknown event type: ".concat(e));this._on[e]=t;}},{key:"send",value:function send(e,t){if(!this._socket){var _e3=new Error("No socket for sending.");return xnm.aio.winkhaus.logger.log("error","[WebSocket.send] "+_e3.message),void(t&&t(_e3));}var s="utf-8";this._mode===xnm.aio.winkhaus.WebSocket.MODE.WEBSOCKET&&("string"==typeof e&&(e=xnm.aio.winkhaus.strToUint8Array(e)),e=this._packageForSending(e),s="binary"),xnm.aio.winkhaus.logger.log("debug","[WebSocket.send] Message with length "+e.length),this._socket.write(e,s,function(){t&&t();});}}],[{key:"generateSecKey",value:function generateSecKey(){var e=xnm.aio.winkhaus.generateRandom(16);return btoa(String.fromCharCode.apply(String,_toConsumableArray(e)));}}]);return _class;}(),xnm.aio.winkhaus.WebSocket.MODE={HTTP:1,WEBSOCKET:2},xnm.aio.winkhaus.doorControl=/*#__PURE__*/function(){function _class2(e){_classCallCheck(this,_class2);this.serialNumber=e.serialNumber,this.ip=e.ip,this.port=e.port||443,this.username=e.username||"admin",this.password=e.password,this._aesKey=null,this._challenge=null,this._challengeDevice=null,this._counter=0,this._counterDevice=0,this._nextMessageCallback=null,this._requestQueue=[],this._expectedSessionCode=null,this._isWaitingForHandshakeResponse=!1,this._ws=null,this._commandHandler=null,this._deviceCache=null,this._reportedState=!1,this.mode="ws",this.state=null;}_createClass(_class2,[{key:"_connectUsingHTTPS",value:function _connectUsingHTTPS(e){var _this2=this;this._doRequestHTTPS("/api/v1/getStates",null,function(t,s){t?_this2.state="error":(xnm.aio.winkhaus.logger.log("debug","[_connectUsingHTTPS] Using fallback to HTTPS."),_this2.state="connected",_this2.mode="https"),e&&e(t);});}},{key:"_createHmacDigest",value:function _createHmacDigest(e,t){var s=require("x.crypt.js").sjcl,n=new s.misc.hmac(s.codec.bytes.toBits(e),s.hash.sha1).encrypt(s.codec.bytes.toBits(t));return new Uint8Array(s.codec.bytes.fromBits(n,!1));}},{key:"_decryptMessage",value:function _decryptMessage(e){var _this3=this;if(0===e.length)return xnm.aio.winkhaus.logger.log("error","[_decryptMessage] Unexpected input length of 0"),null;var t={type:xnm.aio.winkhaus.PACKET_TYPE.UNKNOWN,message:new Uint8Array(0)};return e.forEach(function(e){var s=0;if(e.length>4&&(s=(e[2]<<8)+e[3]+8),e.length<=4||e.length!==s)return;if((128&e[0])>0){var _s2=xnm.aio.winkhaus.getPacketType(e);_s2!==xnm.aio.winkhaus.PACKET_TYPE.UNKNOWN&&(t.type=_s2);}if(e.length===s){var _s3=(e[4]<<24)+(e[5]<<16)+(e[6]<<8)+e[7];if(_s3>_this3._counterDevice){var n=_this3._decryptMessageAES256CCM(_this3._aesKey,_this3._getIV(_this3._challengeDevice,_s3),e.subarray(8));n.length>0&&(_this3._counterDevice=_s3,t.message=xnm.aio.winkhaus.concatUint8Arrays(t.message,n));}}}),t;}},{key:"_decryptMessageAES256CCM",value:function _decryptMessageAES256CCM(e,t,s){var n=require("x.crypt.js").sjcl,o=new n.cipher.aes(n.codec.bytes.toBits(e)),i=n.mode.ccm.decrypt(o,n.codec.bytes.toBits(s),n.codec.bytes.toBits(t),[],128);return new Uint8Array(n.codec.bytes.fromBits(i,!1));}},{key:"_doHandshake",value:function _doHandshake(e){xnm.aio.winkhaus.logger.log("debug","[doorControl._doHandshake] Starting handshake");var t=require("x.crypt.js"),s=e.subarray(0,32);this._challengeDevice=Uint8Array.from(e.subarray(32));var n=xnm.aio.winkhaus.generateRandom(32),o=t.axlsign.generateKeyPair(n),i=t.axlsign.sharedKey(o["private"],s);this._aesKey=Uint8Array.from(i);var r=xnm.aio.winkhaus.generateRandom(84);this._challenge=Uint8Array.from(r.subarray(0,32));var a=this._getPBKDF2DerivedKey(),c=xnm.aio.winkhaus.concatUint8Arrays(this._challengeDevice,this._challenge),h=this._createHmacDigest(a,c);this._updatePairingData(r,h);var l=this._challengeDevice.subarray(0,13),u=this._encryptMessageAES256CCM(this._aesKey,l,r);100!==u.length&&xnm.aio.winkhaus.logger.log("error","[doorControl._doHandshake] Encoded message length is ".concat(u.length," instead of 100"));var d=Uint8Array.from([129,0,0,o["public"].byteLength+u.byteLength]),g=xnm.aio.winkhaus.concatUint8Arrays(d,o["public"],u);this._expectedSessionCode=this._createHmacDigest(a,this._challenge),this._isWaitingForHandshakeResponse=!0,this._ws.send(g);}},{key:"_doRequest",value:function _doRequest(e,t,s){var _this4=this;var n=e;t&&(n+="\n",n+="string"==typeof t?t:JSON.stringify(t));var o=xnm.aio.winkhaus.strToUint8Array(n);xnm.aio.winkhaus.logger.log("debug","[_doRequest] (len: ".concat(o.length,") ")+n.replace("\n"," "));var sendNextBytes=function sendNextBytes(e){if(e>=o.length)return void(s&&s());var t=Math.min(o.length-e,1024),n=t+16-t%16;for(;n>1024;){t--,n=t+16-t%16;}var i=_this4._nextCounter(),r=_this4._encryptMessageAES256CCM(_this4._aesKey,_this4._getIV(_this4._challenge,i),o.subarray(e,e+t)),a=[5,0,r.length>>8,255&r.length,i>>24,(255&i)>>16,(255&i)>>8,255&i];(e+=t)===o.length&&(a[0]=133);var c=xnm.aio.winkhaus.concatUint8Arrays(a,r);_this4._ws.send(c,function(t){t?s&&s(t):sendNextBytes(e);});};sendNextBytes(0);}},{key:"_doRequestHTTPS",value:function _doRequestHTTPS(e,t,s){var n=require("https"),o=new Buffer(this.username+":"+this.password).toString("base64"),i=t?"POST":"GET",r={host:this.ip,path:e,method:i,headers:{Connection:"close","Content-Type":"application/json",Authorization:"Basic "+o},rejectUnauthorized:!1};t&&("string"!=typeof t&&(t=JSON.stringify(t)),r.headers["Content-Length"]=t.length),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),xnm.aio.winkhaus.logger.log("debug","[_doRequestHTTPS] ".concat(i," ").concat(e," with data ").concat(t));var a=n.request(r,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){var n=null,o=null;if(200==e.statusCode)try{o=t?JSON.parse(t):null;}catch(e){n=e;}else n=new Error("HTTP reponse: "+e.statusCode);s&&(s(n,o,e.statusCode),s=null);});});a.on&&a.on("error",function(e){xnm.aio.winkhaus.logger.log("error","[_doRequestHTTPS] "+e.message),s&&(s(e),s=null);}),a.setTimeout&&a.setTimeout(1e4,function(){xnm.aio.winkhaus.logger.log("error","[_doRequestHTTPS] Timeout for request \"".concat(e,"\"")),s&&(s(new Error("Timeout")),s=null);}),t&&a.write(t),a.end();}},{key:"_encryptMessageAES256CCM",value:function _encryptMessageAES256CCM(e,t,s){var n=require("x.crypt.js").sjcl,o=new n.cipher.aes(n.codec.bytes.toBits(e)),i=n.mode.ccm.encrypt(o,n.codec.bytes.toBits(s),n.codec.bytes.toBits(t),[],128);return new Uint8Array(n.codec.bytes.fromBits(i,!1));}},{key:"_getError",value:function _getError(e,t){var _t$XC_ERR;return e||(t!==null&&t!==void 0&&t.XC_ERR?new Error(((_t$XC_ERR=t.XC_ERR)===null||_t$XC_ERR===void 0?void 0:_t$XC_ERR.text)||JSON.stringify(t)):t!==null&&t!==void 0&&t.XC_SUC?null:new Error("Response does not include XC_SUC part."));}},{key:"_getIV",value:function _getIV(e,t){var s=new Uint8Array(e.subarray(0,13));return s[9]=(4278190080&t)>>24,s[10]=(16711680&t)>>16,s[11]=(65280&t)>>8,s[12]=255&t,s;}},{key:"_getPBKDF2DerivedKey",value:function _getPBKDF2DerivedKey(){var e=require("x.crypt.js").sjcl,t=this.serialNumber+":"+this.username,s=e.misc.pbkdf2(this.password,t,1e3);return new Uint8Array(e.codec.bytes.fromBits(s,!1));}},{key:"_handleConnecting",value:function _handleConnecting(e,t){if(this._isWaitingForHandshakeResponse){this._isWaitingForHandshakeResponse=!1;var s=null;xnm.aio.winkhaus.isEqualUint8Array(e,this._expectedSessionCode)?(xnm.aio.winkhaus.logger.log("info","[doorControl._handleConnecting] Success"),this._expectedSessionCode=null,this.state="connected"):(xnm.aio.winkhaus.logger.log("error","[doorControl._handleConnecting] Handshake failed, response did not match"),s=new Error("Connecting to the device failed, mismatch in handshake"),this.state="error"),t(s);}else if(64===e.byteLength){var _t2=Uint8Array.from(e);this._doHandshake(_t2);}}},{key:"_nextCounter",value:function _nextCounter(){return this._counter>4294967295?this._counter=0:this._counter++,this._counter;}},{key:"_updatePairingData",value:function _updatePairingData(e,t){var s=xnm.aio.winkhaus.strToUint8Array(this.username,{maxLength:32});for(var _t3=0;_t3<s.length;_t3++){e[32+_t3]=s[_t3];}s.length<32&&(e[32+s.length]=0);for(var _s4=0;_s4<20;_s4++){e[64+_s4]=t[_s4];}}},{key:"_prepareConnectingMessage",value:function _prepareConnectingMessage(e){var t=xnm.aio.winkhaus.PACKET_TYPE;var s=new Uint8Array(0);return e.forEach(function(e){var n=xnm.aio.winkhaus.getPacketType(e);if(n===t.PAIRING_STEP1)66!==e.length&&34!==e.length||(s=xnm.aio.winkhaus.concatUint8Arrays(s,e.subarray(2)));else if(n===t.PAIRING_STEP2){var _t4=(128&e[0])>0;4===e.length?s=xnm.aio.winkhaus.concatUint8Arrays(s,e.subarray(2)):24===e.length&&_t4&&(s=xnm.aio.winkhaus.concatUint8Arrays(s,e.subarray(4)));}}),s;}},{key:"_updateDeviceStates",value:function _updateDeviceStates(e){if(!this._commandHandler||!this._deviceList)return;var t=[];for(var s in this._deviceList){var n=this._deviceList[s],o=e[n.status.value];t.push({id:n.id,status:o});}this._reportedState=!0,this._commandHandler.reportStates(null,t);}},{key:"connect",value:function connect(e){var _this5=this;var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;if("connecting"===this.state)return;this._ws&&this._ws.close();var s=null;t||(s=setTimeout(function(){s=null,"connected"!==_this5.state&&(xnm.aio.winkhaus.logger.log("debug","[doorControl.connect] Connect timeout. Retrying."),_this5.state=null,_this5.connect(e,!0));},1e4)),this.mode="ws",this.state="connecting";var n=xnm.aio.winkhaus.PACKET_TYPE;this._reportedState=!1,this._ws=new xnm.aio.winkhaus.WebSocket(this.ip,this.port),this._ws.on("error",function(t){_this5.state="error",_this5._ws=null,null===s&&_this5._connectUsingHTTPS(e);}),this._ws.on("message",function(t){if("connected"!==_this5.state){var _s5=_this5._prepareConnectingMessage(t);_this5._handleConnecting(_s5,e);}else{var _e4=_this5._decryptMessage(t);if(_e4.type===n.RESPONSE){var _t6,_t7,_t7$XC_SUC,_this5$_latestCommand;var _t5=null,_s6=null;try{_t5=xnm.aio.winkhaus.uint8ArrayToStr(_e4.message),_t5=JSON.parse(_t5);}catch(e){_s6=e;}(_t6=_t5)!==null&&_t6!==void 0&&_t6.XC_SUC&&!((_t7=_t5)!==null&&_t7!==void 0&&(_t7$XC_SUC=_t7.XC_SUC)!==null&&_t7$XC_SUC!==void 0&&_t7$XC_SUC.state)?(_this5$_latestCommand=_this5._latestCommand)===null||_this5$_latestCommand===void 0?void 0:_this5$_latestCommand.cb(_s6,_t5):_this5._latestStatesRequest&&_this5._latestStatesRequest.cb(_s6,_t5);}else if(_e4.type===n.STATE)try{var _t8=xnm.aio.winkhaus.uint8ArrayToStr(_e4.message);_t8=JSON.parse(_t8),xnm.aio.winkhaus.logger.log("debug","STATE message received"),_this5._updateDeviceStates(_t8);}catch(e){xnm.aio.winkhaus.logger.log("error","STATE message parse error: "+e.message);}else xnm.aio.winkhaus.logger.log("warn","Unexpected decrypted message type: ".concat(_e4.type));}}),this._ws.connect();}},{key:"destroy",value:function destroy(){this._ws&&(this._ws.close(),this._ws=null),this._latestCommand=null,this._latestStatesRequest=null,this._reportedState=!1,this.mode="ws",this.state="destroyed";}},{key:"executeCommandCreator",value:function executeCommandCreator(e,t,s){var _this6=this;if("destroyed"===this.state)return void(s&&s(new Error("Instance has been destroyed.")));if(!t||!t.value)return void(s&&s(new Error("Command value is empty.")));this._latestCommand={cb:function cb(e,t){_this6._latestCommand=null,(e=_this6._getError(e,t))?(xnm.aio.winkhaus.logger.log("error","[excuteCommandCreator] "+e.message),s&&s(e)):s&&s(null,t.XC_SUC);}};var n={path:"/api/v1/control",data:{command:t.value}};"mode"===t.value&&(n.data.command=t.ext),"connected"===this.state?"https"===this.mode?this._doRequestHTTPS(n.path,n.data,function(e,t){_this6._latestCommand&&_this6._latestCommand.cb(e,t);}):this._doRequest(n.path,n.data):"connecting"!==this.state&&this.connect(function(e){e?s&&s(e):"https"===_this6.mode?_this6._doRequestHTTPS(n.path,n.data,function(e,t){_this6._latestCommand&&_this6._latestCommand.cb(e,t);}):_this6._doRequest(n.path,n.data);});}},{key:"getStatesCreator",value:function getStatesCreator(e,t,s){var _this7=this;if("destroyed"===this.state)return void(s&&s(new Error("Instance has been destroyed.")));this._commandHandler=e,this._deviceList=this._deviceList||{},t.forEach(function(e){_this7._deviceList[e.id]=e;});var n=t||[],o=Date.now();if(this._latestStatesRequest&&(o=this._latestStatesRequest.start,this._latestStatesRequest.deviceList.forEach(function(e){n.find(function(t){var _t$status,_e$status;return t.id==e.id&&((_t$status=t.status)===null||_t$status===void 0?void 0:_t$status.value)==((_e$status=e.status)===null||_e$status===void 0?void 0:_e$status.value);})||n.push(e);}),this._latestStatesRequest.deviceList=n,Date.now()-o<500))return;this._latestStatesRequest={start:o,deviceList:n,cb:function cb(e,t){var _this7$_latestStatesR;var o=((_this7$_latestStatesR=_this7._latestStatesRequest)===null||_this7$_latestStatesR===void 0?void 0:_this7$_latestStatesR.deviceList)||n;if(_this7._latestStatesRequest=null,e=_this7._getError(e,t))return xnm.aio.winkhaus.logger.log("error","[getStatesCreator] "+e.message),void(s&&s(e,[]));var i=t.XC_SUC,r=[];for(var _e5=0;_e5<o.length;_e5++){var _t9=o[_e5];if(!_t9||!_t9.id||!_t9.status)continue;var _s7=i[_t9.status.value];null!=_s7&&r.push({id:_t9.id,status:_s7});}s&&s(null,r);}};var i="/api/v1/getStates";"connected"===this.state?"https"===this.mode?this._doRequestHTTPS(i,null,function(e,t){_this7._latestStatesRequest&&_this7._latestStatesRequest.cb(e,t);}):this._doRequest(i):"connecting"!==this.state&&this.connect(function(e){e?s&&s(e):"https"===_this7.mode?_this7._doRequestHTTPS(i,null,function(e,t){_this7._latestStatesRequest&&_this7._latestStatesRequest.cb(e,t);}):_this7._doRequest(i);});}}]);return _class2;}(),xnm.aio.winkhaus.DM={MAP:{doorControl:{command:[{type:"enum",name:"unlock",ref:{value:"unlock"}},{type:"enum",name:"mode",ref:{value:"mode",ext:"%e",extMeta:["day","night"]}}],status:[{type:"enum",name:"state",ref:{value:"state",ext:"%e",options:["open","closed"]}},{type:"enum",name:"locked",ref:{value:"locked",ext:"%e",options:["true","false"]}},{type:"enum",name:"mode",ref:{value:"mode",ext:"%e",options:["day","night"]}}]}},SYS:"winkhaus",TYPE_DOORCONTROL:"doorControl",applyIPEventFilter:function applyIPEventFilter(e,t){if(!e.sys)return null;var s=this.getCommandStatusMap(e);if(!s)return null;var n=JSON.parse(JSON.stringify(e));return n.ipevt=s.ipevt,n;},applyUIFilter:function applyUIFilter(e,t,s){if(!e.sys)return null;var _contains=function _contains(e,t){if("*"===e||"*"===e[0])return!0;for(var s=0;s<e.length;s++){if(e[s]==t)return!0;}return!1;},_filter=function _filter(e,t){var n=[],o=null,i=xnm.aio.winkhaus.DM.getCommandStatusMap(e,s);return i&&(o=function(e,t,s){var n=[];switch(s.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(s.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(s.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(i,0,t),n=n.concat(o)),n;},n=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),n.command=o;break;case"status":o=_filter(e,t),n.status=o;break;default:return null;}return o&&0!=o.length?n:null;},createDevice:function createDevice(e,t,s){var n=xnm.aio.winkhaus.DM;e?e.id?e.ip?s(null,e):s(new n.Error(n.Error.ERROR_CODE.INVALID,"IP is missing")):s(new n.Error(n.Error.ERROR_CODE.INVALID,"ID (serial number) is missing")):s(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));},deleteDevice:function deleteDevice(e,t,s){s&&s();},getCommandStatusMap:function getCommandStatusMap(e,t){var s=xnm.aio.winkhaus.DM.MAP.doorControl,n={command:s.command.slice(0),status:s.status.slice(0)};return s.ipevt&&(n.ipevt=s.ipevt.slice(0)),n;},getIPDeviceType:function getIPDeviceType(){return[{sys:xnm.aio.winkhaus.DM.SYS,name:"Winkhaus doorControl"}];},supportSmartWidget:function supportSmartWidget(e){return!0;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,s,n,o){if(!t)return!1;return e._injectToSmartWidgetTemplate(n,["doorcontrol"],o,{"%unlock%":{value:"unlock"},"%mode_day%":{value:"mode",ext:"day"},"%mode_night%":{value:"mode",ext:"night"}},{"%state%":{value:"state"},"%locked%":{value:"locked"},"%mode%":{value:"mode"}});},toGeneralDevice:function toGeneralDevice(e){var t=xnm.aio.winkhaus.parseJSON(e);return t&&"function"==typeof t.toGeneralDevice?t.toGeneralDevice():null;},updateDevice:function updateDevice(e,t,s){var n=xnm.aio.winkhaus.DM;e?e.id?e.ip?s(null,e):s(new n.Error(n.Error.ERROR_CODE.INVALID,"IP is missing")):s(new n.Error(n.Error.ERROR_CODE.INVALID,"ID (serial number) is missing")):s(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));}},xnm.aio.winkhaus.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.winkhaus.DM.Error.prototype=new Error(),xnm.aio.winkhaus.DM.Error.prototype.name="WinkhausDMError",xnm.aio.winkhaus.DM.Error.prototype.code=0,xnm.aio.winkhaus.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,INVALID:2,UNKNOWN:3,NOT_FOUND:4,IP_EXISTS:5},xnm.aio.winkhaus.Handler=/*#__PURE__*/function(){function _class3(){_classCallCheck(this,_class3);this.devicemanager=xnm.aio.winkhaus.DM,this.doorControl=xnm.aio.winkhaus.doorControl,this._deviceCache={};var e=require("x.logger.js");e&&(xnm.aio.winkhaus.logger=e.getLogger("xnm.aio.winkhaus"));}_createClass(_class3,[{key:"discoverWithTimeout",value:function discoverWithTimeout(e,t){xnm.aio.winkhaus.logger.log("info","[discoverWithTimeout] Starting discovery ...");var s=require("x.mdns.js");s.clearRecordBuffer();var n="_whdc-device._tcp.local",o=[];var i=1;("number"!=typeof e||isNaN(e))&&(e=1e4),e=Math.ceil(e/2);var handleResult=function handleResult(r,a){if(r)return xnm.aio.winkhaus.logger.log("error","[discoverWithTimeout] "+r.message),void(i<2?(i++,s.discoverServiceWithTimeout(n,e,handleResult)):(o.length>0&&(r=null),t&&t(r,o)));for(var _e6=0;_e6<a.length;_e6++){var _t10=a[_e6];if(_t10.ip&&_t10.ip.length>0){(function(){var e=String(_t10.target).replace(/\.local$/,""),s=_t10.ip[0];o.find(function(t){return t.id===e&&t.ip===s;})||o.push({id:e,ip:s,sys:xnm.aio.winkhaus.DM.SYS,type:xnm.aio.winkhaus.DM.TYPE_DOORCONTROL});})();}}xnm.aio.winkhaus.logger.log("info","[discoverWithTimeout] Found ".concat(o.length," device(s) on attempt ").concat(i,"/2")),i<2?(i++,s.discoverServiceWithTimeout(n,e,handleResult)):(xnm.aio.winkhaus.logger.log("debug","[discoverWithTimeout] Found a total of ".concat(o.length," unique device(s)")),t&&t(null,o));};s.discoverServiceWithTimeout(n,e,handleResult);}},{key:"doCommand",value:function doCommand(e,t,s){var n=this.resolveDevice(e);n?n.executeCommandCreator(t,s):s&&s(new Error("device format invalid"));}},{key:"doStatus",value:function doStatus(e,t,s,n){var o=this.resolveDevice(t);if(!o)return void(n&&n(new Error("device format invalid")));var i=[{id:e,status:s}];o.getStatesCreator(null,i,function(e,t){e?n&&n(e):n&&n(null,t);});}},{key:"getDeviceCommands",value:function getDeviceCommands(e,t){var s=xnm.aio.winkhaus.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=s?s.command:[];t&&t(null,n);}},{key:"getDeviceStatus",value:function getDeviceStatus(e,t){var s=xnm.aio.winkhaus.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),n=s?s.status:[];t&&t(null,n);}},{key:"finalize",value:function finalize(e){var t=0;for(var _e7 in this._deviceCache){this._deviceCache[_e7].destroy(),t++;}this._deviceCache={},xnm.aio.winkhaus.logger.log("debug","[finalize] Destroyed ".concat(t," doorControl instance(s).")),e&&(0!==t?setTimeout(function(){e();},250):e());}},{key:"registModule",value:function registModule(e){e.register(xnm.aio.winkhaus.DM.SYS,"winkhaus");}},{key:"resolveDevice",value:function resolveDevice(e){if(!e)return null;var t=this._deviceCache[e.ip];return t&&"error"!==t.state||(t=xnm.aio.winkhaus.parseJSON(e),this._deviceCache[e.ip]=t),t;}}]);return _class3;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.winkhaus.Handler());