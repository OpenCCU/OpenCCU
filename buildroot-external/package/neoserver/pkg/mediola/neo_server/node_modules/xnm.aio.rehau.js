var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.rehau=xnm.aio.rehau||{},xnm.aio.rehau.Gauzy=function(){var Gauzy=function Gauzy(t,e){this.address=t,this.port=e,e&&""!=e||(this.port=5e3);};return Gauzy.prototype._setScene=function(t,e){var n={scene:t};this._doJsonRequest("POST","/scene",n,function(t,n){e&&e(t,n);});},Gauzy.prototype._setInvert=function(t,e){var n=this;this._getBlindStates(function(i,a){i?e&&e(i):n._setInvertAndBlindOpacity(t,a.opacity,e);});},Gauzy.prototype._setBlindPosition=function(t,e){var n=this;this._getBlindStates(function(i,a){if(i)e&&e(i);else{var o=t;n._setInvertAndBlindOpacity(a.invert,o,e);}});},Gauzy.prototype._setBlindOpacity=function(t,e){var n=this;this._getBlindStates(function(i,a){i?e&&e(i):n._setInvertAndBlindOpacity(a.invert,t,e);});},Gauzy.prototype._setInvertAndBlindOpacity=function(t,e,n){var i={opacity:e,invert:t};this._doJsonRequest("POST","/blind",i,function(t,e){n&&n(t,e);});},Gauzy.prototype._setLightsensor=function(t,e){var n=this;this._getLEDStates(function(i,a){i?e&&e(i):n._setLedPaintAndLightsensor(a.ledpaint,t,e);});},Gauzy.prototype._setLedPaint=function(t,e){var n=this;this._getLEDStates(function(i,a){i?e&&e(i):n._setLedPaintAndLightsensor(t,a.lightsensoractive,e);});},Gauzy.prototype._setLedPaintAndLightsensor=function(t,e,n){var i={ledpaint:t,lightsensoractive:e};this._doJsonRequest("POST","/external",i,function(t,e){n&&n(t,e);});},Gauzy.prototype.getAllStates=function(t){this._getAllStates(function(e,n){e?t&&t(e):(n&&(n.ledpaint=n.ledpaint?"on":"off",n.lightsensoractive=n.lightsensoractive?"on":"off",n.invert=n.invert?"on":"off"),t&&t(null,n));});},Gauzy.prototype._getAllStates=function(t){var e=this;this._getBlindStates(function(n,i){n?t&&t(n):e._getLEDStates(function(e,n){if(e)t&&t(e);else{var a=function(t){return[].slice.call(arguments,1).forEach(function(e){for(var n in e){t[n]=e[n];}}),t;}({},n,i);t&&t(null,a);}});});},Gauzy.prototype._getLEDStates=function(t){this._doJsonRequest("GET","/external",null,function(e,n){t&&t(e,n);});},Gauzy.prototype._getBlindStates=function(t){this._doJsonRequest("GET","/blind",null,function(e,n){t&&t(e,n);});},Gauzy.prototype._doJsonRequest=function(t,e,n,i){try{var a=n?JSON.stringify(n):null;this._doRequest(t,e,a,function(t,e){if(t)i&&i(t);else try{var n=null;e&&(n=JSON.parse(e)),i&&i(null,n);}catch(t){i&&i(t);}});}catch(t){i&&i(t);}},Gauzy.prototype._doRequest=function(t,e,n,i){var a={host:this.address,port:this.port,path:e,method:t,headers:{"Content-Type":"application/json"}},o=require("http").request(a,function(t){t.setEncoding("utf-8");var e="";t.on("data",function(t){e+=t;}),t.on("end",function(){i&&i(null,e);});});n&&o.write(n),o.setTimeout&&o.setTimeout(2e3,function(){i&&i(new Error("http request timeout"));}),o.on("error",function(t){i&&i(t);}),o.end();},Gauzy.prototype.executeCommand=function(t,e,n){if(console.log("======> command",e),e){var i,a,o,r,s,u=this;e>=0&&e<=100?this._getBlindStates(function(t,i){t?n&&n(t):u._setInvertAndBlindOpacity(i.invert,0==i.invert?100-e:e,n);}):-1!=e.indexOf("lightsensoractive")||-1!=e.indexOf("ledpaint")?(i=e.split("_"),-1!=e.indexOf("lightsensoractive")?(s=parseInt(i[1]),r="?"!=i[2]?parseInt(i[2]):0):-1!=e.indexOf("ledpaint")&&(r=parseInt(i[1]),s="?"!=i[2]?parseInt(i[2]):0),this._setLedPaintAndLightsensor(r,s,n)):-1!=e.indexOf("scene")?(i=e.split("_"),this._setScene(parseInt(i[1]),n)):-1!=e.indexOf("invert")&&(i=e.split("_"),o=parseInt(i[1]),a=parseInt(i[2]),this._setInvertAndBlindOpacity(o,a,n,!0));}else n&&n("missing params");},Gauzy.prototype.getStates=function(t,e,n){this._getAllStates(function(n,i){if(!n&&i&&t)for(var a in i){if(i.hasOwnProperty(a))if("opacity"==a){var o=i.opacity;0===i.invert&&(o=100-i.opacity),t.setState(e.id+":opacity",i.opacity),t.setState(e.id+":slider_opacity",o);}else t.setState(e.id+":"+a,i[a]);}});},Gauzy.prototype.executeCommandCreator=function(t,e,n){if(e&&e.value)switch(e.value){case"invertOn":case"invertOff":var i=0;"invertOn"==e.value&&(i=1),this._setInvert(i,n);break;case"ledpaintOn":case"ledpaintOff":var a=0;"ledpaintOn"==e.value&&(a=1),this._setLedPaint(a,n);break;case"lightsensorOn":case"lightsensorOff":var o=0;"lightsensorOn"==e.value&&(o=1),this._setLightsensor(o,n);break;case"doScene":if(void 0===e.ext||null==e.ext)return void(n&&n("command ext invalid"));var r=parseInt(e.ext);r<1&&(r=1),r>6&&(r=6),this._setScene(r,n);break;case"moveTo":if(void 0===e.ext||null==e.ext)return void(n&&n("command ext invalid"));var s=parseInt(e.ext);s<0&&(s=0),s>100&&(s=100),this._setBlindPosition(s,n);break;default:n&&n(new Error("unknown command"));}else n&&n(new Error("command json format invalid"));},Gauzy.prototype.getStatesCreator=function(t,e,n){this._getAllStates(function(t,i){if(t)n&&n(t);else{for(var a=[],o=0;o<e.length;o++){if(e[o]&&e[o].id){var r="?";if(e[o].status&&e[o].status.value)void 0!==(r=i[e[o].status.value])&&null!=r&&a.push({id:e[o].id,status:r});}}n&&n(null,a);}});},Gauzy.prototype.getSingleDeviceStatesCreator=function(t,e,n,i){this.getAllStates(function(t,e){i&&i(t,e);});},Gauzy.prototype.toJSON=function(){return{sys:"rehau",type:"gauzy",address:this.address,port:this.port};},Gauzy.prototype.equalsTo=function(t){return!!t&&t instanceof Gauzy&&this.address==t.address&&this.port==t.port;},Gauzy;}(),xnm.aio.rehau.DM=function(){var DMError=function DMError(t,e){this.code=t,this.message=e,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="RehauDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var t={gauzy:{command:[{type:"enum",name:"invert on",ref:{value:"invertOn"}},{type:"enum",name:"invert off",ref:{value:"invertOff"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100",scale:"5"}},{type:"enum",name:"LED-Paint on",ref:{value:"ledpaintOn"}},{type:"enum",name:"LED-Paint off",ref:{value:"ledpaintOff"}},{type:"enum",name:"activate light sensor",ref:{value:"lightsensorOn"}},{type:"enum",name:"deactivate light sensor",ref:{value:"lightsensorOff"}},{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d",extMeta:"1-6",scale:"1"}}],status:[{type:"int",name:"position",ref:{value:"position",extMeta:"0-100",scale:"5"}},{type:"enum",name:"invert",ref:{value:"invert",options:["on","off"]}},{type:"enum",name:"LED-Paint",ref:{value:"ledpaint",options:["on","off"]}},{type:"enum",name:"light sensor",ref:{value:"lightsensoractive",options:["on","off"]}}]}};return{SYS:"rehau",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Gauzy Scheibe",type:"gauzy"}];},createDevice:function createDevice(t,e,n){var i=DMError,a=DMError.ERROR_CODE;t?t.address?n(null,t):n(new i(a.INVALID,"address is invalid")):n(new i(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,e,n){var i=DMError,a=DMError.ERROR_CODE;t?t.address?n(null,t):n(new i(a.INVALID,"address is invalid")):n(new i(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e,n){var _doFilterArr=function _doFilterArr(t,e,n){var i=[];return t.forEach(function(t){if("root"==t.type){var a=JSON.parse(JSON.stringify(t)),o=_doFilterArr(a.children,e,n);o&&o.length>0&&(a.children=o,i.push(a));}else if(function(t,e){if("*"==t)return!0;for(var n=!1,i=0;i<t.length;i++){if(t[i]==e){n=!0;break;}}return n;}(n.elems,t.type)){var r=JSON.parse(JSON.stringify(t));i.push(r);}}),i;},_filter=function _filter(t,e){var i=[],a=null,o=xnm.aio.pioneer.DM.getCommandStatusMap(t,n);return o&&(a=function(t,e,n){var i=[];switch(n.catagory){case"command":t.command&&(i=_doFilterArr(t.command,e,n));break;case"status":t.status&&(i=_doFilterArr(t.status,e,n));}return i;}(o,t,e),i=i.concat(a)),i;};if(!t.sys)return null;var i=JSON.parse(JSON.stringify(t)),a=null;switch(e.catagory){case"command":a=_filter(t,e),i.command=a;break;case"status":a=_filter(t,e),i.status=a;break;default:return null;}return a&&0!=a.length?i:null;},getCommandStatusMap:function getCommandStatusMap(e){return e&&e.type?t[e.type]:null;}};}(),xnm.aio.rehau.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.rehau.DM,Handler.prototype.Gauzy=xnm.aio.rehau.Gauzy,Handler.prototype.registModule=function(t){t.register("rehau","rehau");},Handler.prototype.resolveDevice=function(t){return t&&"gauzy"===t.type&&t.address?new this.Gauzy(t.address,t.port):null;},Handler.prototype.getDeviceCommands=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"command",elems:"*"}),i=n?n.command:[];e&&e(null,i);},Handler.prototype.getDeviceStatus=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"status",elems:"*"}),i=n?n.status:[];e&&e(null,i);},Handler.prototype.doCommand=function(t,e,n){var i=this.resolveDevice(t);i?i.executeCommandCreator(t,e,function(t){n&&n(t);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(t,e,n,i){var a=this.resolveDevice(e);if(a){var o=[{id:t,device:e,status:n}];a.getStatesCreator(null,o,function(t,e){t?i&&i(t):i&&i(null,e[0]);});}else i&&i(new Error("device json format invalid"));},Handler.prototype.getDevice=function(t){return new xnm.aio.rehau.Gauzy(t.address,t.port);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.rehau.Handler());