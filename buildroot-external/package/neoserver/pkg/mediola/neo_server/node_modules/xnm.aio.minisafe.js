var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.minisafe=xnm.aio.minisafe||{};var Logger=require("x.logger.js");xnm.aio.minisafe.Importer=function(e,i){this._ip=e,this._port=12345,i&&(this._port=i),this.setBaseAddress=!0,this._timeout=15e3,this._devicesToImport=[],this._importedDevices=[],this._importIP=null,this._importPassword=null,this.onNotification=null;var t=require("xnm.aio.gateway.js"),o=t.devicemanager.getSystem({sys:"aio",type:"ENOCEAN"}).DM.V6_DEVICES;for(var r in this._AIODEVICES={},t.devicemanager.getSystem({sys:"aio",type:"ENOCEAN"}).DM.V6_DEVICES){this._AIODEVICES[o[r].vendor]=o[r].subtypes;}this._logger=require("x.logger.js").getLogger("xnm.aio.minisafe");},xnm.aio.minisafe.Importer.prototype._getMiniSafeConfiguration=function(e){var i=require("http"),t={host:this._ip,port:this._port,path:"/MediolaExport",method:"GET",timeout:this._timeout},o=i.request(t,function(i){var t="";i.setEncoding("utf8"),i.on("data",function(e){t+=e;}),i.on("end",function(){var i=null;try{i=JSON.parse(t);}catch(e){}e&&(null!=i?e(null,i):e(new Error("invalid data")),e=null);});});o.on("error",function(i){e&&(e(i),e=null);}),o.setTimeout(this._timeout,function(){o.abort();}),o.end();},xnm.aio.minisafe.Importer.prototype._getBaseAddress=function(e){var i=4294967295;for(var t in e){var o=e[t];for(var r in o.transmissionInformation){if(o.transmissionInformation[r].transmissionID&&8==o.transmissionInformation[r].transmissionID.length){var n=parseInt(o.transmissionInformation[r].transmissionID,16);n<i&&(i=n);}}}return 4294967295==i?null:i.toString(16).toUpperCase();},xnm.aio.minisafe.Importer.prototype._getVendor=function(e){var i="general";return"eltako"!=e.manufacturer&&"Eltako GmbH"!=e.manufacturer||(i="eltako"),i;},xnm.aio.minisafe.Importer.prototype._compareType=function(e,i,t){var o=e.physicalDevice,r=null;for(var n in e.deviceInformation){if(e.deviceInformation[n].eep){r=e.deviceInformation[n].eep;break;}}if(null==r&&e.transmissionInformation)for(var a in e.transmissionInformation){if(e.transmissionInformation[a].eep){r=e.transmissionInformation[a].eep;break;}}if(t){if(o.toLowerCase().indexOf(i.id.toLowerCase())>0)return!0;if(i.id.toLowerCase().indexOf(o.toLowerCase())>0)return!0;}else{if(i.id.toLowerCase()==o.toLowerCase())return!0;if(r&&i.data.toLowerCase()==r.toLowerCase())return!0;if(r&&i.eep&&i.eep.toLowerCase()==r.toLowerCase())return!0;if(0==o.toLowerCase().indexOf(i.id.toLowerCase()))return!0;if(0==i.id.toLowerCase().indexOf(o.toLowerCase()))return!0;}return!1;},xnm.aio.minisafe.Importer.prototype._getData=function(e){var i,t={type:"ENOCEAN",data:null,vendor:this._getVendor(e)};if(e.deviceInformation)if(1==e.deviceInformation.length)e.deviceInformation[0].deviceid&&(t.adr=e.deviceInformation[0].deviceid);else{var o=[];for(var r in e.deviceInformation){e.deviceInformation[r].deviceid&&o.push(e.deviceInformation[r].deviceid);}t.adr=JSON.stringify(o);}if(e.transmissionInformation)if(1==e.transmissionInformation.length)e.transmissionInformation[0].transmissionID&&(t.senderID=e.transmissionInformation[0].transmissionID);else{var n=[];for(var a in e.transmissionInformation){e.transmissionInformation[a].transmissionID&&n.push(e.transmissionInformation[a].transmissionID);}t.senderID=JSON.stringify(n);}if(i=this._AIODEVICES[t.vendor])for(var s in i){if(1==this._compareType(e,i[s],!1)){t.data=i[s].data;break;}}if(null==t.data&&(i=this._AIODEVICES[t.vendor]))for(var s in i){if(1==this._compareType(e,i[s],!0)){t.data=i[s].data;break;}}if(null==t.data&&(i=this._AIODEVICES.general))for(var s in i){if(1==this._compareType(e,i[s],!1)){t.data=i[s].data,t.vendor="general";break;}}if(null==t.data&&null==t.data&&(i=this._AIODEVICES.general))for(var s in i){if(1==this._compareType(e,i[s],!0)){t.data=i[s].data,t.vendor="general";break;}}return t.data&&"f6-02-03"==t.data&&(t.data="eltako_switch"),null==t.data?null:t;},xnm.aio.minisafe.Importer.prototype._setBaseAddress=function(e,i){var t={type:"ENOCEAN",baseAdr:e},o=new(require("xnm.aio.gateway.js").Gateway)(this._importIP);o.isV5=!0,o.timeout=2e3,o.password=this._importPassword,o.executeRequestV5("setConfig",t,function(e){e.error?i(!1):i(!0);});},xnm.aio.minisafe.Importer.prototype._setDeviceData=function(e,i){var t=this._getData(e);if(t){var o=new(require("xnm.aio.gateway.js").Gateway)(this._importIP);o.isV5=!0,o.timeout=2e3,o.password=this._importPassword,o.executeRequestV5("addSensor",t,function(e){setTimeout(function(){i(e);},100);});}else this._logger.log("trace","Failed to import: "+e.manufacturer+" "+e.physicalDevice),setTimeout(function(){i(null);},0);},xnm.aio.minisafe.Importer.prototype._importNextDevice=function(e){var i=this;if(this._devicesToImport.length>0){var t=this._devicesToImport.pop();this._setDeviceData(t,function(o){if(o&&e)if(o.data){if(Array.isArray(o.data))for(var r in o.data){t.location&&(o.data[r].location=t.location),o.data[r].name=t.friendlyId,r>0&&(o.data[r].name+="-"+r),r>0&&i._importedDevices.push(o.data[r]);}else t.location&&(o.data.location=t.location),o.data.name=t.friendlyId,i._importedDevices.push(o.data);e(!0);}else i._logger.log("trace","Failed to set: "+t.manufacturer+" "+t.physicalDevice);i._importNextDevice(e);});}else e(!1);},xnm.aio.minisafe.Importer.prototype._importDevices=function(e,i){this._importedDevices=[];var t=this;this._devicesToImport=e,this._importNextDevice(function(e){0==e&&i(null,t._importedDevices);});},xnm.aio.minisafe.Importer.prototype.importTo=function(e,i,t){this._importIP=e,this._importPassword=i;var o=this;this._getMiniSafeConfiguration(function(e,i){if(e)o._logger.log("trace",e),t&&(t("failed to get configuration"),t=null);else if(i.devices){var r=o._getBaseAddress(i.devices);o._logger.log("trace","Base address: "+r),null!=r&&1==o.setBaseAddress?o._setBaseAddress(r,function(e){1==e?o._importDevices(i.devices,t):t("failed to set base address");}):o._importDevices(i.devices,t);}});},xnm.aio.minisafe.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Importer=xnm.aio.minisafe.Importer,Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.minisafe.Handler());