var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.fritz=xnm.aio.fritz||{},xnm.aio.fritz.SessionCache={_cache:{},STATE_TO:5e3,setSessionID:function setSessionID(e,t){if(e){var a=this._cache[e];a||(this._cache[e]={},a=this._cache[e]),a.sessionID=t;}},getSessionID:function getSessionID(e){return e&&this._cache[e]?this._cache[e].sessionID:null;}},xnm.aio.fritz.Box=function(){var e={red:{hue:358,sat:[180,112,54],val:[255,255,255]},orange:{hue:35,sat:[214,140,72],val:[252,252,255]},yellow:{hue:52,sat:[153,102,51],val:[255,255,255]},lime:{hue:92,sat:[123,79,38],val:[248,250,252]},green:{hue:120,sat:[160,82,38],val:[220,232,242]},turquoise:{hue:160,sat:[145,84,41],val:[235,242,248]},cyan:{hue:195,sat:[179,118,59],val:[255,255,255]},lightblue:{hue:212,sat:[169,110,56],val:[252,252,255]},blue:{hue:225,sat:[204,135,67],val:[255,255,255]},purple:{hue:266,sat:[169,110,54],val:[250,250,252]},magenta:{hue:296,sat:[140,92,46],val:[250,252,255]},pink:{hue:335,sat:[180,107,51],val:[255,248,250]}};var Box=function Box(e,t,a,s){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.fritz.Box"),this.ip=e,this.port=s,this.protocol="http",e&&"http://"==e.substr(0,7)?this.ip=e.substr(7):e&&"https://"==e.substr(0,8)&&(this.ip=e.substr(8),this.protocol="https"),this.port||("https"==this.protocol?this.port=443:this.port=80),this.password=t,this.user="",a&&(this.user=a),this.CommandHandler=null;};return Box.prototype._doRequest=function(e,t){var a=this,s=e;this._cachedSessionID()&&(s+="&sid="+this._cachedSessionID());var r=t,n={host:this.ip,port:this.port,path:s,method:"GET"};this._logger.log("trace","send ("+this.protocol+") req to:"+JSON.stringify(n));var o="",i=require("http");"https"==this.protocol&&(i=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),n.port||(n.port=443));var u=i.request(n,function(e){e.on("data",function(e){o+=e;}),e.on("end",function(){var t=null;200==e.statusCode?a._logger.log("trace","http request success:"+o):(a._logger.log("trace","http request error:"+e.statusCode+"-"+o),t=new Error("request failed with status code:"+e.statusCode)),r&&r(t,o,e.statusCode),r=null;});});if(u.setTimeout){u.setTimeout(6e4,function(){u.abort();});}u.on&&"function"==typeof u.on&&u.on("error",function(e){e||(e=new Error("http request error")),a._logger.log("trace","http request error:"+e.message),r&&r(e),r=null;}),u.end();},Box.prototype._sendRequest=function(e,t){var a=this;this._doRequest(e,function(s,r,n){s&&403==n?(a._setSessionID(null),a._getSessionID(function(s,r){if(s)return a._logger.log("trace","create new session error:"+s.message),void(t&&t(s));a._setSessionID(r),a._sendRequest(e,t);})):t&&t(s,r);});},Box.prototype._setSessionID=function(e){return xnm.aio.fritz.SessionCache.setSessionID(this.ip,e);},Box.prototype._cachedSessionID=function(){return xnm.aio.fritz.SessionCache.getSessionID(this.ip);},Box.prototype._getSessionID=function(e){var t=this;this._logger.log("trace","create new session"),this._doRequest("/login_sid.lua",function(a,s){if(a)e&&e(a);else try{var r=$($.parseXML(s));if(r){var n=null,o=null,i=r.find("SID");if(i&&(n=$(i[0]).text()),(i=r.find("Challenge"))&&(o=$(i[0]).text()),"0000000000000000"!=n)e&&e(null,n);else if(o){n=null;var u=o+"-"+require("x.crypt.js").MD5(o+"-"+t.password,!0);t._doRequest("/login_sid.lua?username="+t.user+"&response="+u,function(t,a){if(t)e&&e(t);else try{var s=$($.parseXML(a));if(s){var r=s.find("SID");r&&(n=$(r[0]).text()),"0000000000000000"==n&&(n=null);}n||(t=new Error("session challenge fail")),e&&e(t,n);}catch(t){e&&e(t);}});}}}catch(t){e&&e(t);}});},Box.prototype._getDeviceInfos=function(e){var t=this;t._sendRequest("/webservices/homeautoswitch.lua?switchcmd=getdevicelistinfos",function(a,s){if(a)e&&e(a);else{var r=[];if(s){var n=$($.parseXML(s));r=t._resolveDevices(n);}e&&e(null,r);}});},Box.prototype._resolveDevices=function(e){var t=this,a=[];return e.find("device").each(function(){var e=$(this),s=t._resolveDevice(e);s&&a.push(s);}),e.find("group").each(function(){var e=$(this),s=t._resolveGroup(e);s&&a.push(s);}),a;},Box.prototype._resolveDevice=function(e){var t=e.attr("identifier");if(!t)return null;var a=e.find("name"),s="";a&&a[0]&&(s=$(a[0]).text()),t=t.replace(" ","");var r=e.attr("productname"),n=e.attr("functionbitmask"),o=null;if(1&(n=parseInt(n))){if(!(8192&n))return null;var i=e.find("etsiunitinfo");if(i&&i[0]){o={};var u=$(i[0]).find("unittype");o.unittype=u&&u[0]?$(u[0]).text():null;var l=$(i[0]).find("interfaces");o.interfaces=l&&l[0]?$(l[0]).text().split(","):null;}}var p=null;switch(r){case"Comet DECT":p="thermo";break;case"FRITZ!DECT 500":p="colorlight";break;default:p="switch";}n&1<<18&&(p="blind");var c={sys:"fritz",name:s,type:"fritz_dect",typeName:r,bitmask:parseInt(n),address:t,data:p,etsiunitinfo:o};return c.states=this._resolveStates(c,e),c;},Box.prototype._resolveGroup=function(e){var t=e.attr("identifier");if(!t)return null;var a=e.find("name"),s="";a&&a[0]&&(s=$(a[0]).text()),t=t.replace(" ","");var r=e.attr("productname");r||(r="Group");var n=e.attr("functionbitmask"),o={sys:"fritz",name:s,type:"fritz_dect",typeName:r,bitmask:parseInt(n),address:t,data:"group"};return o.states=this._resolveStates(o,e),o;},Box.prototype._resolveStates=function(e,t){var a,s={},r=!1,n=t,o=n.find("present");if(o&&o[0])switch(r=!0,o=$(o[0]).text()){case"1":s.connected="true";break;case"0":s.connected="false";break;default:s.connected="?";}if((o=n.find("switch"))&&o[0]){if(r=!0,(a=$(o[0]).find("state"))&&a[0])switch(a=$(a[0]).text()){case"1":s.state="on";break;case"0":s.state="off";break;default:s.state="?";}if((a=$(o[0]).find("mode"))&&a[0])switch(a=$(a[0]).text()){case"auto":s.switchMode="auto";break;case"manuell":s.switchMode="manu";break;default:s.switchMode="?";}}if((o=n.find("powermeter"))&&o[0]&&(r=!0,(a=$(o[0]).find("power"))&&a[0]&&(a=$(a[0]).text(),s.current=a?(parseInt(a)/1e3).toFixed(2):"?"),(a=$(o[0]).find("energy"))&&a[0]&&(a=$(a[0]).text(),s.energy=a?parseInt(a):"?")),(o=n.find("temperature"))&&o[0]&&(r=!0,(a=$(o[0]).find("celsius"))&&a[0]&&(a=$(a[0]).text(),s.tempC=a?(parseInt(a)/10).toFixed(1):"?")),(o=n.find("hkr"))&&o[0]&&(r=!0,(a=$(o[0]).find("tsoll"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),s.temp=254==a?28.5:253==a?7.5:(a/2).toFixed(1)):s.temp="?"),(a=$(o[0]).find("komfort"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),s.comfort=254==a?28.5:253==a?7.5:(a/2).toFixed(1)):s.comfort="?"),(a=$(o[0]).find("absenk"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),s.absenk=254==a?28.5:253==a?7.5:(a/2).toFixed(1)):s.absenk="?"),(a=$(o[0]).find("batterylow"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),s.batlow=1==a):s.batlow="?"),(a=$(o[0]).find("battery"))&&a[0]&&((a=$(a[0]).text())?(a=parseInt(a),s.battery=a):s.battery="?")),(o=n.find("simpleonoff"))&&o[0]&&(r=!0,(a=$(o[0]).find("state"))&&a[0]))switch(a=$(a[0]).text()){case"1":s.state="on";break;case"0":s.state="off";break;default:s.state="?";}if((o=n.find("levelcontrol"))&&o[0]&&(r=!0,(a=$(o[0]).find("levelpercentage"))&&a[0]&&(a=$(a[0]).text(),a=parseInt(a),"colorlight"==e.data?s.brightness=a:"blind"===e.data?s.level=100-a:s.level=a)),(o=n.find("colorcontrol"))&&o[0]){r=!0;var i=a=$(o[0]).attr("current_mode");if(s.colormode=1==i?"color":4==i?"color_temperature":"unknonw",1==i?s.colortemperature=null:(a=$(o[0]).find("temperature"))&&a[0]&&(a=$(a[0]).text(),s.colortemperature=parseInt(a)),4==i)s.rgb="";else{var u,l,p;(a=$(o[0]).find("hue"))&&a[0]&&(a=$(a[0]).text(),u=parseInt(a),u/=360),(a=$(o[0]).find("saturation"))&&a[0]&&(a=$(a[0]).text(),l=parseInt(a),l/=255),p=s.brightness,p/=100;var c=this._HSVToRGB(u,l,p),d=("0"+parseInt(c[0]).toString(16)).slice(-2);d+=("0"+parseInt(c[1]).toString(16)).slice(-2),d+=("0"+parseInt(c[2]).toString(16)).slice(-2),s.rgb=d;}}return r&&"off"==s.state&&void 0!==s.brightness&&null!=s.brightness&&(s.brightness=0),r?s:null;},Box.prototype.getDevices=function(e){this._getDeviceInfos(function(t,a){var s=[];if(!t&&a)for(var r=0;r<a.length;r++){var n=a[r];delete n.states,s.push(n);}e&&e(s);});},Box.prototype.getStates=function(e){this._getDeviceInfos(function(t,a){var s={};if(a)for(var r=0;r<a.length;r++){var n=a[r];n.address&&n.states&&(s[n.address]=n.states);}e&&e(t,s);});},Box.prototype.executeCommand=function(t,a,s){var r,n,o=a;a.value&&(o=a.value);var i=this;switch(o){case"on":r="colorlight"==t.type||t.bitmask&&32768&parseInt(t.bitmask)?"setsimpleonoff&onoff=1":"setswitchon";break;case"off":r="colorlight"==t.type||t.bitmask&&32768&parseInt(t.bitmask)?"setsimpleonoff&onoff=0":"setswitchoff";break;case"toggle":r="colorlight"==t.type?"setsimpleonoff&onoff=2":"setswitchtoggle";break;case"up":return void("blind"===t.data?i.executeCommand(t,{value:"setblind",ext:"open"},s):this.getStates(function(e,a){if(e)s&&s(e);else if(a&&a[t.address]){var r=a[t.address].brightness;void 0===r||null==r||isNaN(parseInt(r))?s&&s(new Error("invalid brightness state")):(r=parseInt(r),(r+=5)>100&&(r=100),i.executeCommand(t,{value:"brightness",ext:r},s));}else s&&s(new Error("get device states failed"));}));case"down":return void("blind"===t.data?i.executeCommand(t,{value:"setblind",ext:"close"},s):this.getStates(function(e,a){if(e)s&&s(e);else if(a&&a[t.address]){var r=a[t.address].brightness;void 0===r||null==r||isNaN(parseInt(r))?s&&s(new Error("invalid brightness state")):(r=parseInt(r),(r-=5)<0&&(r=0),i.executeCommand(t,{value:"brightness",ext:r},s));}else s&&s(new Error("get device states failed"));}));case"brightness":return void(void 0!==a.ext&&null!=a.ext?(n=parseInt(a.ext),isNaN(n)||(n<0&&(n=0),n>100&&(n=100)),0!=n?(r="setlevelpercentage&level="+n,this._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){e?s&&s(e):i.executeCommand(t,{value:"on"},s);})):this.executeCommand(t,{value:"off"},s)):s&&s(new Error("invalid command "+a)));case"set_level":return void(void 0!==a.ext&&null!=a.ext?(n=parseInt(a.ext),isNaN(n)||(n<0&&(n=0),n>100&&(n=100)),"blind"===t.data&&(n=100-n),r="setlevelpercentage&level="+n,this._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){s&&s(e);})):s&&s(new Error("invalid command "+a)));case"stop":return void("blind"===t.data&&i.executeCommand(t,{value:"setblind",ext:"stop"},s));case"setblind":return void(void 0!==a.ext&&null!=a.ext?(r="setblind&target="+a.ext,this._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){s&&s(e);})):s&&s(new Error("invalid command "+a)));case"rgb":if(void 0!==a.ext&&null!=a.ext&&a.ext.length>=6&&a.ext.length<=7){var _n=a.ext.replace("#","");var u=parseInt(_n.substr(0,2),16),l=parseInt(_n.substr(2,2),16),p=parseInt(_n.substr(4,2),16),c=this._RGBToHSV(u,l,p);c=function huesat2api(t,a){var s=360,r=-1,n=null,o=null,i=null;for(var u in e){i=e[u],(o=Math.abs(t-i.hue))<s&&(s=o,r=i.hue,n=u);}return s=256,[r,a>(i=e[n]).sat[0]?i.sat[0]:a>i.sat[1]?i.sat[1]:a>i.sat[2]?i.sat[2]:0];}(Math.round(c[0]),Math.round(255*c[1])),r=0==c[1]?"setcolortemperature&temperature=4200&duration=0":"setcolor&hue="+c[0]+"&saturation="+c[1]+"&duration=0",this._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){e?s&&s(e):i.executeCommand(t,{value:"on"},s);});}else s&&s(new Error("invalid command "+a));return;case"colortemperature":void 0!==a.ext&&null!=a.ext&&(n=parseInt(a.ext),isNaN(n)||(n<2700&&(n=2700),n>6500&&(n=6500)),n=function colortemp2api(e){return e>6200?6500:e>5600?5900:e>5e3?5300:e>4500?4700:e>4e3?4200:e>3600?3800:e>3200?3400:e>2850?3e3:2700;}(n),r="setcolortemperature&temperature="+n+"&duration=0");break;case"thermoOn":r="sethkrtsoll&param=254";break;case"thermoOff":r="sethkrtsoll&param=253";break;case"tempUp":return void this.getStates(function(e,a){if(e)s&&s(e);else if(a&&a[t.address]){var n=a[t.address].temp;n&&!isNaN(parseFloat(n))?(n=parseFloat(n),(n+=.5)>28.5&&(n=28.5),r="sethkrtsoll&param="+2*n,i._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){s&&setTimeout(function(){s(e);},250);})):s&&s(new Error("invalid setpoint state"));}else s&&s(new Error("get device states failed"));});case"tempDown":return void this.getStates(function(e,a){if(e)s&&s(e);else if(a&&a[t.address]){var n=a[t.address].temp;n&&!isNaN(parseFloat(n))?(n=parseFloat(n),(n-=.5)<7.5&&(n=7.5),r="sethkrtsoll&param="+2*n,i._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){s&&setTimeout(function(){s(e);},250);})):s&&s(new Error("invalid setpoint state"));}else s&&s(new Error("get device states failed"));});default:0==a.indexOf("temp")&&(r=a.replace("temp",""),r=(r=parseFloat(r))<=7.5||253==r?"sethkrtsoll&param=253":r>=28.5||254==r?"sethkrtsoll&param=254":"sethkrtsoll&param="+2*r);}r?this._sendRequest("/webservices/homeautoswitch.lua?ain="+t.address+"&switchcmd="+r,function(e){s&&setTimeout(function(){s(e);},250);}):s&&s(new Error("no such command "+a));},Box.prototype.executeCommandCreator=function(e,t,a){if(e&&e.address&&t&&t.value){var s=t.value;if("temp"==t.value){if(!t.ext)return void(a&&a(new Error("parameter ext invalid")));s+=t.ext;}else"brightness"!=t.value&&"set_level"!=t.value&&"colortemperature"!=t.value&&"rgb"!=t.value||(s=t);this.executeCommand(e,s,function(){a&&a();});}else a&&a(new Error("parameter invalid"));},Box.prototype.getStatesCreator=function(e,t,a){t?0!=t.length?this.getStates(function(e,s){if(e)a&&a(e);else{for(var r=[],n=0;n<t.length;n++){if(t[n]&&t[n].id){var o="?";t[n].device&&t[n].device.address&&t[n].status&&t[n].status.value&&s&&s[t[n].device.address]&&(void 0!==(o=s[t[n].device.address][t[n].status.value])&&null!=o||(o="?")),r.push({id:t[n].id,status:o});}}a&&a(null,r);}}):a&&a(null,[]):a&&a(new Error("deviceList is null"));},Box.prototype._RGBToHSV=function(e,t,a){e/=255,t/=255,a/=255;var s=Math.min(e,Math.min(t,a)),r=Math.max(e,Math.max(t,a));return s==r?[0,0,s]:[60*((e==s?3:a==s?1:5)-(e==s?t-a:a==s?e-t:a-e)/(r-s)),(r-s)/r,r];},Box.prototype._HSVToRGB=function(e,t,a){var s,r,n,o=Math.floor(6*e),i=6*e-o,u=a*(1-t),l=a*(1-i*t),p=a*(1-(1-i)*t);switch(o%6){case 0:s=a,r=p,n=u;break;case 1:s=l,r=a,n=u;break;case 2:s=u,r=a,n=p;break;case 3:s=u,r=l,n=a;break;case 4:s=p,r=u,n=a;break;case 5:s=a,r=u,n=l;}return[Math.round(255*s),Math.round(255*r),Math.round(255*n)];},Box.prototype.toJSON=function(){return{sys:"fritz",ip:this.ip,port:this.port,username:this.user,password:this.password};},Box.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.fritz.Box&&this.protocol==e.protocol&&this.ip==e.ip&&this.port==e.port&&this.user==e.user&&this.password==e.password;},Box;}(),xnm.aio.fritz.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="FritzDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={fritz_dect:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"current power",ref:{value:"current",value_t:"currentPower"}}]},hkr:{command:[{type:"float",name:"set temperature",ref:{value:"temp",value_t:"themoTemp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"temperature up",ref:{value:"tempUp"}},{type:"enum",name:"temperature down",ref:{value:"tempDown"}},{type:"enum",name:"thermostat on",ref:{value:"thermoOn"}},{type:"enum",name:"thermostat off",ref:{value:"thermoOff"}}],status:[{type:"float",name:"set temperature",ref:{value:"temp",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",name:"comfort temperature",ref:{value:"comfort",value_t:"tempComfort",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"float",name:"spar temperature",ref:{value:"absenk",value_t:"tempAbsenk",ext:"%f",extMeta:"7.5-28.5",scale:"0.5"}},{type:"enum",name:"battery low",ref:{value:"batlow",options:["true","false"]}}]},temp:{status:[{type:"float",name:"current temperature",ref:{value:"tempC",scale:"0.1"}}]},powermeter:{status:[{type:"float",name:"energy",ref:{value:"energy"}},{type:"float",name:"current power",ref:{value:"current",value_t:"currentPower"}}]},"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"switch mode",ref:{value:"switchMode",options:["auto","manu"]}}]},error:{status:[{type:"enum",name:"connected",ref:{value:"connected",options:["true","false"]}}]},simpleswitch:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]},brightness:{command:[{type:"enum",name:"brightness up",ref:{value:"up"}},{type:"enum",name:"brightness down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"brightness",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"set_level",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"position",ref:{value:"level",extMeta:"0-100"}}]},colortemperature:{command:[{type:"int",name:"color temperature",ref:{value:"colortemperature",value_t:"setColorTemp",ext:"%d",extMeta:"2700-6500",scale:"100"}}],status:[{type:"int",name:"color temperature",ref:{value:"colortemperature",value_t:"colortemp",extMeta:"2700-6500"}}]},color:{command:[{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}}],status:[{type:"string",name:"rgb color",ref:{value:"rgb",ext:"%s"}}]},colormode:{status:[{type:"enum",name:"color mode",ref:{value:"colormode",value_t:"colorMode",options:["color","color_temperature","unknown"]}}]}};return{SYS:"fritz",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"FRITZ!Box",port:80}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"fritz_dect",name:"FRITZ! Smart Home"}];},createGateway:function createGateway(e,t,a){var s=DMError,r=DMError.ERROR_CODE;e?e.ip?a(null,e):a(new s(r.INVALID,"ip is invalid")):a(new s(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,s){var r=DMError,n=DMError.ERROR_CODE;t?t.ip?s(null,t):s(new r(n.INVALID,"ip is invalid")):s(new r(n.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var n,o,i=t.data.gateways;for(n=0;n<i.length;n++){if(i[n].index===e.gateway){o=i[n];break;}}o?a(null,e):a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.INVALID,"type is invalid"));}else a(new s(r.INVALID,"address is invalid"));}else a(new s(r.INVALID,"gateway is invalid"));}else a(new s(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var n,o,i=t.data.gateways;for(n=0;n<i.length;n++){if(i[n].index===e.gateway){o=i[n];break;}}o?a(null,e):a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.INVALID,"type is invalid"));}else a(new s(r.INVALID,"address is invalid"));}else a(new s(r.INVALID,"gateway is invalid"));}else a(new s(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var a=this,_doFilterArr=function _doFilterArr(e,t,a){var s=[];return e.forEach(function(e){if("root"==e.type){var r=JSON.parse(JSON.stringify(e)),n=_doFilterArr(r.children,t,a);n&&n.length>0&&(r.children=n,s.push(r));}else if(function(e,t){if("*"==e)return!0;for(var a=!1,s=0;s<e.length;s++){if(e[s]==t){a=!0;break;}}return a;}(a.elems,e.type)){var o=JSON.parse(JSON.stringify(e));s.push(o);}}),s;},_filter=function _filter(e,t){var s=[],r=null,n=a.getCommandStatusMap(e);return n&&(r=function(e,t,a){var s=[];switch(a.catagory){case"command":e.command&&(s=_doFilterArr(e.command,t,a));break;case"status":e.status&&(s=_doFilterArr(e.status,t,a));}return s;}(n,e,t),s=s.concat(r)),s;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),s.command=r;break;case"status":r=_filter(e,t),s.status=r;break;default:return null;}return r&&0!=r.length?s:null;},getCommandStatusMap:function getCommandStatusMap(t){if(!t||!t.type)return null;var a=parseInt(t.bitmask),s=[];if(a?(64&a&&s.push("hkr"),128&a&&s.push("powermeter"),256&a&&s.push("temp"),512&a&&s.push("switch"),32768&a&&s.push("simpleswitch"),65536&a&&("blind"===t.data?s.push("blind"):s.push("brightness")),a&1<<17&&(s.push("colortemperature"),s.push("color"),s.push("colormode"))):"colorlight"==t.type?s=["simpleswitch","brightness","colortemperature","color","colormode"]:s.push(t.type),0==s.length)return null;var r={command:[],status:[]};return s.forEach(function(t){e[t]&&(e[t].command&&(r.command=r.command.concat(e[t].command)),e[t].status&&(r.status=r.status.concat(e[t].status)));}),(r.command.length>0||r.status.length>0)&&(r.status=r.status.concat(e.error.status)),r;},toGeneralDevice:function toGeneralDevice(e,t){var a=!1,s=!1,r=!1,n=!1,o=!1,i=!1,u=parseInt(e.bitmask);u?(64&u&&(o=!0),128&u&&(s=!0),256&u&&(n=!0),512&u&&(a=!0),32768&u&&(a=!0),65536&u&&!0,u&1<<17&&(r=!0),u&1<<18&&(i=!0)):"switch"==e.data?a=!0:"thermo"==e.data?o=!0:"colorlight"==e.data&&(r=!0);var l=null;return r?l={type:"dimmer",commands:{on:{},off:{},toggle:{},up:{},down:{},brightness:{value:{type:"INT",min:0,max:100,step:1}},colorTemperature:{value:{type:"INT",min:2700,max:6500,step:100}},color:{type:"RGB"}},states:{state:{values:["on","off"]},brightness:{min:0,max:100,unit:"%"},colorTemperature:{min:2700,max:6500}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},up:{value:"up"},down:{value:"down"},brightness:{value:"brightness",ext:"%d"},colorTemperature:{value:"colortemperature",ext:"%d",extMeta:"2700-6500",scale:"100"},color:{value:"rgb",ext:"%s"}},states:{state:{value:"state"},brightness:{value:"brightness"},colorTemperature:{value:"colortemperature"}}}}:o?l={type:"heater",commands:{up:{},down:{},tempTo:{value:{type:"FLOAT",min:7.5,max:28.5,step:.5}}},states:{setpoint:{type:"FLOAT",min:6,max:30,step:.5,unit:"°C"},temperature:{type:"FLOAT"}},details:{commands:{up:{value:"tempUp"},down:{value:"tempDown"},tempTo:{value:"temp",ext:"%f"}},states:{setpoint:{value:"temp"},temperature:{value:"tempC"}}}}:a?(l={type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"state"}}}},s&&(l.states.power={type:"FLOAT"},l.states.consumption={type:"FLOAT"},l.details.states.power={value:"current"},l.details.states.consumption={value:"energy"})):n?l={type:"temperature",states:{temperature:{type:"FLOAT"}},details:{states:{temperature:{value:"tempC"}}}}:i&&(l={type:"blind",commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{position:{min:0,max:100,unit:"%"}},details:{commands:{up:{value:"up"},down:{value:"down"},stop:{value:"stop"},position:{value:"set_level",ext:"%d",extMeta:"0-100"}},states:{position:{value:"level"}}}}),l;}};}(),xnm.aio.fritz.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Box=xnm.aio.fritz.Box,Handler.prototype.devicemanager=xnm.aio.fritz.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"fritz");},Handler.prototype.resolveGateway=function(e){return e&&e.ip?new xnm.aio.fritz.Box(e.ip,e.password,e.username,e.port):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.fritz.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),s=a?a.command:[];t&&t(null,s);},Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.fritz.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),s=a?a.status:[];t&&t(null,s);},Handler.prototype.doCommand=function(e,t,a,s){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){s&&s(e);}):s&&s(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,s,r){var n=this.resolveGateway(t);if(n){var o=[{id:e,device:a,status:s}];n.getStatesCreator(null,o,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDevices(function(e){t&&t(null,e);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fritz.Handler());