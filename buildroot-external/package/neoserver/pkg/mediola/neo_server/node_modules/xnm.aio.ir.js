var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.ir=xnm.aio.ir||{},xnm.aio.ir.RedEye=function(){var RedEye=function RedEye(e,t,i){var r=require("x.logger.js");this._logger=r?r.getLogger("RedEye"):{log:function log(){}},this._host=e,this._serial=i,this._port=t,(!this._port||this._port<0)&&(this._port=80);};return RedEye.SEND_PATH="/cgi-bin/play_iph.sh?/devicedata/",RedEye.LEARN_PATH="/cgi-bin/RedEyeApp?debug=1",RedEye.prototype.executeCommandCreator=function(e,t,i){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var r,o=0;o<e.ircodes.codes.length;o++){var a=e.ircodes.codes[o];if(a.key==t.value){r=a.code;break;}}r?this.executeCommand(e,r,function(e){i&&i(e);}):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},RedEye.prototype.executeCommand=function(e,t,i){if(t){var r=RedEye.SEND_PATH+t;this._doGetRequest(this._host,this._port,r,function(e){i&&i(e);});}else i&&i(new Error("command invalid"));},RedEye.prototype.learnIrCode=function(e){var t='<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>id</key><integer>-1</integer><key>serialNumber</key><string>'+this._serial+"</string><key>clientType</key><integer>99999</integer><key>softwareVersion</key><string>2.6.0</string><key>type</key><integer>26</integer><key>isInitialRequest</key><string>no</string><key>hostName</key><string></string><key>cookie</key><integer>-1</integer><key>actions</key></dict></plist>";this._doPostRequest(this._host,82,RedEye.LEARN_PATH,t,function(t,i){if(t)e&&e(t);else if(i&&-1!=i.indexOf("/devicedata/")){var r=i.indexOf("/devicedata/");if(-1!=(r=(i=i.substr(r+12)).indexOf("<"))){var o=i.substr(0,r);e&&e(null,o);}else e&&e(new Error("learn ir code response error"));}else e&&e(new Error("learn ir code response error"));});},RedEye.prototype._doGetRequest=function(e,t,i,r){var o=r,a={host:e,port:t,path:i,method:"GET"},n=this,s="",c=require("http").request(a,function(e){200==e.statusCode?(e.setEncoding("utf8"),e.on("data",function(e){s+=e;}),e.on("end",function(){o&&o(null,s),o=null;})):(n._logger.log("warn","Failed to do get request to "+n.ip+" with status code:"+e.statusCode),o&&o(new Error("post request failed with status code:"+e.statusCode)),o=null);});c.on&&"function"==typeof c.on&&c.on("error",function(e){o&&o(e),o=null;}),c.end();},RedEye.prototype._doPostRequest=function(e,t,i,r,o){var a=o,n={host:e,port:t,path:i,method:"POST",headers:{"Content-Type":'text/xml; charset="UTF-8"',"Content-Length":r.length,"User-Agent":"mediola",Connection:"close"}},s=this,c="",l=require("http").request(n,function(e){200==e.statusCode?(e.setEncoding("utf8"),e.on("data",function(e){c+=e;}),e.on("end",function(){a&&a(null,c),a=null;})):(s._logger.log("warn","Failed to do get request to "+s.ip+" with status code:"+e.statusCode),a&&a(new Error("post request failed with status code:"+e.statusCode)),a=null);});l.on&&"function"==typeof l.on&&l.on("error",function(e){a&&a(e),a=null;}),l.write(r),l.end();},RedEye.prototype.toJSON=function(){return{sys:xnm.aio.ir.RedEye.DM.SYS,ip:this._host,port:this._port,serial:this._serial};},RedEye.prototype.equalsTo=function(e){return!!e&&e instanceof RedEye&&this._host==e._host;},RedEye.parseJSON=function(e){return e.ip?new RedEye(e.ip,e.port,e.serial):null;},RedEye.discoveryWithTimeout=function(e,t){var i=require("x.mdns.js");i.clearRecordBuffer(),i.discoverServiceWithTimeout("_tf_redeye._tcp.local",e,function(e,i){if(e)t&&t(e);else{for(var r=[],o=0;o<i.length;o++){var a=i[o];if(a.target&&a.ip&&a.ip.length>0){var n=a.target.replace("RedEye_","");n=n.replace(".local","");var s=new RedEye(a.ip[0],80,n);r.push(s);}}t&&t(e,r);}});},RedEye;}(),xnm.aio.ir.RedEye.DM={SYS:"redeye",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"RedEye"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.IRTrans=function(){var IRTrans=function IRTrans(e,t){var i=require("x.logger.js");this._logger=i?i.getLogger("IRTrans"):{log:function log(){}},this._ip=e,this._port=t,this._port||(this._port=21e3),this._socket=null,this._idleTimer=null,this._commandTasks=[];};return IRTrans.SO_TIMEOUT=2e3,IRTrans.IDLE_TIMEOUT=6e4,IRTrans.CONNECTION_PREAMBLE="ASCI\n",IRTrans.prototype.executeCommandCreator=function(e,t,i,r){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var o,a=0;a<e.ircodes.codes.length;a++){var n=e.ircodes.codes[a];if(n.key==t.value){o=n.code;break;}}o?this.executeCommand(e,o,function(){i&&i();},r):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},IRTrans.prototype.executeCommand=function(e,t,i,r){var o="Asndhex ";switch(e.address){case"LD":case"LI":case"LE":case"LB":case"L1":case"L2":case"L3":case"L4":case"L5":case"L6":case"L7":case"L8":o+=e.address+" ";}o+="H"+t+"\n";var a=this;this._createSocket(function(e){e?i&&i(e):a._addTask("command",o,r,i);});},IRTrans.prototype.learnIrCode=function(e,t){var i="Alearn M"+(e&e.mode?e.mode:0)+" I"+(e&e.timeout?e.timeout:0)+" R"+(e&e.receiver?e.receiver:"I1")+" W10\n",r=this;this._createSocket(function(e){e?t&&t(e):r._addTask("learn",i,!0,t);});},IRTrans.prototype.toJSON=function(){return{sys:xnm.aio.ir.IRTrans.DM.SYS,ip:this._ip,port:this._port};},IRTrans.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.ir.IRTrans&&this._ip==e._ip&&this._port==e._port;},IRTrans.prototype._createSocket=function(e){if(this._socket)e();else{var t=this,i={port:this._port,host:this._ip},r=require("net").connect(i);r.setTimeout(IRTrans.SO_TIMEOUT),r.setEncoding("utf8"),r.on("connect",function(){t._logger.log("trace","connect to irtrans:"+t._ip),r.write(IRTrans.CONNECTION_PREAMBLE),t._socket=r,e();}),r.on("data",function(e){t._logger.log("trace","receive from irtrans:"+t._ip+" data:"+e),t._onSocketData(e);}),r.on("error",function(i){t._socket?(t._logger.log("trace","irtrans:"+t._ip+" error:"+i.message),t._onSocketError(i)):(t._logger.log("trace","irtrans:"+t._ip+" connection error:"+i.message),e(i));}),r.on("timeout",function(){t._socket?(t._logger.log("trace","irtrans:"+t._ip+" data timeout"),t._onSocketTimeout()):(t._logger.log("trace","irtrans:"+t._ip+" connection timeout"),r.destroy(),e(new Error("timeout")));}),r.on("close",function(){t._logger.log("trace","irtrans:"+t._ip+" close socket"),t._onSocketClose();}),r._doConnect&&"function"==typeof r._doConnect&&r._doConnect();}},IRTrans.prototype._closeSocket=function(){this._socket&&this._socket.end(),this._clean();},IRTrans.prototype._clean=function(){if(this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null),this._socket=null,this._commandTasks)for(var e=0;e<this._commandTasks.length;e++){var t=this._commandTasks[e];t&&t.callback&&t.callback(new Error("socket closed"));}this._commandTasks=[];},IRTrans.prototype._onSocketError=function(e){this._closeSocket();},IRTrans.prototype._onSocketTimeout=function(){this._commandTasks.length>4&&this._closeSocket();},IRTrans.prototype._onSocketClose=function(){this._clean();},IRTrans.prototype._onSocketData=function(e){var t,i=e.split(" "),r=i.length>2&&"LEARN"==i[1];r&&(t=i[2].replace(/\r?\n|\r/g,""));var o=!1;if(this._commandTasks.length>0){var a,n=this._commandTasks[0];o=n.closeSocket,this._commandTasks.splice(0,1),"learn"==n.type&&0==i[2].indexOf("Error")&&(i=i.slice(2),a=new Error(i.join(" ").replace(/\r?\n|\r/g,""))),n.callback&&n.callback(a,r?t:null);}o&&0==this._commandTasks.length&&this._closeSocket();},IRTrans.prototype._addTask=function(e,t,i,r){this._logger.log("trace","add task to buffer"),this._commandTasks.push({type:e,data:t,callback:r,closeSocket:i});var o=this;this._idleTimer&&clearTimeout(this._idleTimer),this._idleTimer=setTimeout(function(){o._closeSocket();},IRTrans.IDLE_TIMEOUT),this._doRequest(t);},IRTrans.prototype._doRequest=function(e){this._logger.log("trace","send data to irtrans:"+this._ip+" data:"+e),this._socket&&this._socket.write(e);},IRTrans.parseJSON=function(e){return e.ip?new IRTrans(e.ip,e.port):null;},IRTrans._discovery=function(e,t){var _receivedData=function _receivedData(e,t,i){var r=e.toString("hex");if(r.length>2&&0==r.toLowerCase().indexOf("e7")){var o=new xnm.aio.ir.IRTrans(t.address);i.push(o);}},_createDiscoverSocket=function _createDiscoverSocket(e,t,i,r){var o=r,a=require("dgram").createSocket({type:"udp4",reuseAddr:!0});return a.on("listening",function(){a.setBroadcast(!0),o&&(o(null,a),o=null);}),a.on("message",function(e,t){_receivedData(e,t,i);}),a.on("error",function(e){o&&(o(e),o=null);}),a.bind(e,t),a;},_sendDiscoverPacket=function _sendDiscoverPacket(e){var t=new Buffer([200,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8,214,2,39,11,100,179,139]);e.send(t,0,t.length,21e3,"255.255.255.255");};!function(e){var t,i=e,r=[],o=[],a=require("os"),n=require("dgram");a&&a.networkInterfaces?((t=n.createSocket({type:"udp4",reuseAddr:!0})).on("listening",function(){t.setBroadcast(!0);var e=a.networkInterfaces(),n=[];for(var s in e){for(var c=e[s],l=0;l<c.length;l++){"IPv4"==c[l].family&&0==c[l].internal&&n.push(c[l].address);}}for(var u=0,d=0;d<n.length;d++){_createDiscoverSocket(21e3,n[d],r,function(e,t){!e&&t&&o.push(t),++u==n.length&&i&&(i(null,o,r),i=null);});}}),t.on("message",function(e,t){_receivedData(e,t,r);}),t.on("error",function(e){t.close(),i&&(i(e),i=null);}),t.bind(21e3),t._isListenerSocket=!0,o.push(t)):_createDiscoverSocket(21e3,null,r,function(t,i){t?e&&e(t):(i&&o.push(i),e&&e(null,o,r));});}(function(i,r,o){if(!i&&r){for(var a=0;a<r.length;a++){var n=r[a];n._isListenerSocket||_sendDiscoverPacket(n);}setTimeout(function(){if(r)for(var e=0;e<r.length;e++){r[e].close();}t&&t(null,o);},e);}});},IRTrans;}(),xnm.aio.ir.IRTrans.DM={SYS:"irtrans",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"IRTrans"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.iTach=function(){var LearnIRTask=function LearnIRTask(e,t,i){this.type="learnIR",this.itach=e,this.closeSocket=t,this.callback=i,this.timer=null,this._step=0,this._data="";};LearnIRTask.prototype.run=function(){var e=this;this.itach._createSocket(function(t){if(t)return e.itach._delTask(e),e.callback&&e.callback(t),void e._taskFinish();e.itach._doRequest("get_IRL\r"),e._step=1,e.timer=setTimeout(function(){e.itach._doRequest("stop_IRL\r"),e.callback&&e.callback(new Error("learn ir code timeout")),e.itach._delTask(e),e._taskFinish();},2e4);});},LearnIRTask.prototype.onData=function(e){if(this._data+=e,-1!=this._data.indexOf("\r"))if(1==this._step)"IR Learner Enabled"==this._data.trim()?(this._data="",this._step=2):(this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(new Error(this._data)),this._taskFinish());else if(2==this._step)if(0==this._data.indexOf("sendir")){var t=this._data.split(",");t.splice(0,2);var i=t.join().trim();this._step=3,this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(null,i),this._taskFinish();}else this._data="";},LearnIRTask.prototype.onTimeout=function(){if(1===this._step)this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback(new Error("learn ir code req timeout")),this._taskFinish();},LearnIRTask.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask();};var SendIRTask=function SendIRTask(e,t,i){this.type="sendIR",this.itach=e,this.closeSocket=t.closeSocket,this.address=t.address?t.address:"1:1",this.code=t.code,this.callback=i,this._step=0,this._data="";};SendIRTask.prototype.run=function(){var e=this;this.itach._createSocket(function(t){if(t)return e.itach._delTask(e),e.callback&&e.callback(t),void e._taskFinish();e.itach._doRequest("set_IR,"+e.address+",IR\r"),e._step=1;});},SendIRTask.prototype.onData=function(e){if(this._data+=e,-1!=this._data.indexOf("\r"))if(1==this._step)-1!=this._data.trim().indexOf("ERR")?(this.itach._delTask(this),this.callback&&this.callback(new Error(this._data)),this._taskFinish()):(this._data="",this._step=2,this.itach._doRequest("sendir,"+this.address+","+this.code+"\r"));else if(2==this._step){var t;-1==this._data.trim().indexOf("ERR")&&-1==this._data.trim().indexOf("busyIR")||(t=new Error(this._data)),this.itach._delTask(this),this.callback&&this.callback(t),this._taskFinish();}},SendIRTask.prototype.onTimeout=function(){switch(this._step){case 1:case 2:this.timer&&clearTimeout(this.timer),this.itach._delTask(this),this.callback&&this.callback("send ir code timeout"),this._taskFinish();}},SendIRTask.prototype._taskFinish=function(){this.itach._taskBuffer&&0==this.itach._taskBuffer.length?this.closeSocket&&this.itach._closeSocket():this.itach._doNextTask();};var iTach=function iTach(e,t,i){var r=require("x.logger.js");this.ip=e,this.port=t||4998,this.uuid=i,this.model=null,this._logger=r?r.getLogger("xnm.aio.ir.iTach"):{log:function log(){}},this._socket=null,this._idleTimer=null,this._taskBuffer=[];};return iTach.prototype.toJSON=function(){return{sys:xnm.aio.ir.iTach.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid?this.uuid:"",model:this.model?this.model:""};},iTach.prototype.equalsTo=function(e){return!!e&&e instanceof iTach&&this.ip==e.ip&&this.port==e.port;},iTach.prototype.executeCommandCreator=function(e,t,i,r){if(t&&t.value){if(e&&e.ircodes&&e.ircodes.codes){for(var o,a=0;a<e.ircodes.codes.length;a++){var n=e.ircodes.codes[a];if(n.key==t.value){o=n.code;break;}}o?this.executeCommand(e.address,o,r,function(){i&&i();}):i&&i(new Error("no such ir code:"+t.value));}else i&&i(new Error("device has no ir codes"));}else i&&i(new Error("command invalid"));},iTach.prototype.executeCommand=function(e,t,i,r){var o=new SendIRTask(this,{address:e,code:t,closeSocket:i},r);this._addTask(o);},iTach.prototype.learnIrCode=function(e,t){if(t){var i=new LearnIRTask(this,e,t);this._addTask(i);}},iTach.SO_TIMEOUT=2e3,iTach.IDLE_TIMEOUT=6e4,iTach.prototype._createSocket=function(e){if(this._socket)e();else{var t=this,i={port:this.port,host:this.ip},r=require("net").connect(i);r.setTimeout(iTach.SO_TIMEOUT),r.setEncoding("utf8"),r.on("connect",function(){t._logger.log("trace","connect to itach:"+t.ip),t._socket=r,e();}),r.on("data",function(e){t._logger.log("trace","receive from itach:"+t.ip+" data:"+e),t._onSocketData(e);}),r.on("error",function(i){t._socket?(t._logger.log("trace","itach:"+t.ip+" error:"+i.message),t._onSocketError(i)):(t._logger.log("trace","itach:"+t.ip+" connection error:"+i.message),e(i));}),r.on("timeout",function(){t._socket?(t._logger.log("trace","itach:"+t.ip+" data timeout"),t._onSocketTimeout()):(t._logger.log("trace","itach:"+t.ip+" connection timeout"),r.destroy(),e(new Error("timeout")));}),r.on("close",function(){t._logger.log("trace","itach:"+t.ip+" close socket"),t._onSocketClose();}),r._doConnect&&"function"==typeof r._doConnect&&r._doConnect();}},iTach.prototype._closeSocket=function(){this._logger.log("trace","to close itach socket"),this._socket&&this._socket.end(),this._clean();},iTach.prototype._clean=function(){if(this._idleTimer&&(clearTimeout(this._idleTimer),this._idleTimer=null),this._socket=null,this._taskBuffer)for(var e=0;e<this._taskBuffer.length;e++){var t=this._taskBuffer[e];t&&t.callback&&t.callback(new Error("socket closed"));}this._taskBuffer=[];},iTach.prototype._onSocketError=function(e){this._closeSocket();},iTach.prototype._onSocketTimeout=function(){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].onTimeout();},iTach.prototype._onSocketClose=function(){this._clean();},iTach.prototype._onSocketData=function(e){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].onData(e);},iTach.prototype._addTask=function(e){this._logger.log("trace","add task to buffer"),this._idleTimer&&clearTimeout(this._idleTimer);var t=this;this._idleTimer=setTimeout(function(){t._logger.log("trace","idle timer triggered"),t._closeSocket();},iTach.IDLE_TIMEOUT);var i=this._taskBuffer.length;this._taskBuffer.push(e),0==i&&this._doNextTask();},iTach.prototype._delTask=function(e){this._logger.log("trace","delete task from buffer");for(var t=-1,i=0;i<this._taskBuffer.length;i++){if(this._taskBuffer[i]===e){t=i;break;}}-1!=t&&this._taskBuffer.splice(t,1);},iTach.prototype._doNextTask=function(){this._taskBuffer&&this._taskBuffer.length>0&&this._taskBuffer[0].run();},iTach.prototype._doRequest=function(e){this._logger.log("trace","send data to itach:"+this.ip+" data:"+e),this._socket&&this._socket.write(e);},iTach.parseJSON=function(e){if(!e||!e.ip)return null;var t=new iTach(e.ip,e.port,e.uuid);return t.model=e.model,t;},iTach.discovery=function(e){if(e&&(this._discoverCallbacks||(this._discoverCallbacks=[]),this._addDiscoverCallback(e),!this._discoverRunning)){this._discoverRunning=!0;var t=this;this._startDiscovery(function(e){if(e){for(var i=0;i<t._discoverCallbacks.length;i++){t._discoverCallbacks[i](e);}return t._discoverCallbacks=[],void(t._discoverRunning=!1);}setTimeout(function(){t._stopDiscovery(function(){var e=[];for(var i in t._discoverResults){t._discoverResults.hasOwnProperty(i)&&e.push(t._discoverResults[i]);}for(var r=0;r<t._discoverCallbacks.length;r++){t._discoverCallbacks[r](null,e);}t._discoverCallbacks=[];});},1e4);});}},iTach._addDiscoverCallback=function(e){for(var t=!1,i=0;i<this._discoverCallbacks.length;i++){if(this._discoverCallbacks[i]===e){t=!0;break;}}t||this._discoverCallbacks.push(e);},iTach._removeDiscoverCallback=function(e){for(var t=-1,i=0;i<this._discoverCallbacks.length;i++){if(this._discoverCallbacks[i]===e){t=i;break;}}-1!=t&&this._discoverCallbacks.splice(t,1);},iTach._startDiscovery=function(e){var t=require("x.logger.js");this._logger||(this._logger=t?t.getLogger("xnm.aio.ir.iTach"):{log:function log(){}});this._discoverResults={};var i=this;!function(e,t){var i=t,r=[],o=require("os"),a=require("dgram");if(o&&o.networkInterfaces){var n=o.networkInterfaces();for(var s in n){if(n.hasOwnProperty(s))for(var c=n[s],l=0;l<c.length;l++){"IPv4"==c[l].family&&0==c[l].internal&&r.push(c[l].address);}}}var u=a.createSocket("udp4");u.on("listening",function(){if(u.setBroadcast(!0),r.length>0)for(var e=0;e<r.length;e++){u.addMembership("239.255.250.250",r[e]);}else u.addMembership("239.255.250.250");i&&(i(null,u),i=null);}),u.on("message",function(t,i){e(t,i);}),u.on("error",function(e){u.close(),i&&(i(e),i=null);}),u.bind(9131);}(function(e,t){var r=e.toString();if(0==r.indexOf("AMXB")){var o=function(e){0==e.indexOf("AMXB")&&(e=e.substr(4));for(var t=e.split(/<-/g),i={},r=0;r<t.length;r++){var o=t[r].trim(),a=(o=o.substr(0,o.length-1)).split("=");a.length>=2&&a[0]&&(i[a[0]]=a[1]);}return i;}(r);if(i._logger.log("trace","find iTach:"+JSON.stringify(o)),o.UUID&&!i._discoverResults[o.UUID]){var a=new iTach(t.address,4998,o.UUID);a.model=o.Model,i._discoverResults[o.UUID]=a;}}},function(t,r){t?e&&e(t):(i._discoverSocket=r,e&&e());});},iTach._stopDiscovery=function(e){this._discoverSocket||e&&e(),this._discoverSocket.close(),this._discoverSocket=null,this._discoverRunning=!1,e&&e();},iTach;}(),xnm.aio.ir.iTach.DM={SYS:"itach",registModule:function registModule(e){e.register(this.SYS,"ir");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Global Caché iTach (IR)"};},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;e?e.ip?i(null,e):i(new r(o.INVALID,"ip is invalid")):i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;t?t.ip?r(null,t):r(new o(a.INVALID,"ip is invalid")):r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.gateway){var a,n,s=t.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===e.gateway){n=s[a];break;}}n?i(null,e):i(new r(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else i(new r(o.INVALID,"gateway is invalid"));}else i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){i();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.ircodes&&e.ircodes.codes){for(var i=0;i<e.ircodes.codes.length;i++){var r=e.ircodes.codes[i];t.command.push({type:"enum",name:r.key,ref:{value:r.key}});}return t;}return null;}},xnm.aio.ir.DMError=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="IrDmError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},DMError;}(),xnm.aio.ir.DM={getGatewayType:function getGatewayType(e){var t=[];for(var i in xnm.aio.ir){if(xnm.aio.ir.hasOwnProperty(i)){var r=xnm.aio.ir[i];if(r&&r.DM&&r.DM.getGatewayType){var o=r.DM.getGatewayType(e);o&&t.push(o);}}}return t;},_getSystem:function _getSystem(e){for(var t in xnm.aio.ir){if(xnm.aio.ir.hasOwnProperty(t)){var i=xnm.aio.ir[t];if(i&&i.DM&&i.DM.SYS&&i.DM.SYS==e)return i;}}return null;},createGateway:function createGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.createGateway?a.DM.createGateway(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,i,r){var o=xnm.aio.ir.DMError,a=xnm.aio.ir.DMError.ERROR_CODE;if(t){if(t.sys){var n=this._getSystem(t.sys);n&&n.DM&&n.DM.updateGateway?n.DM.updateGateway(e,t,i,r):r&&r(new o(a.INVALID,"no such sys:"+t.sys));}else r&&r(new o(a.INVALID,"sys is invalid"));}else r&&r(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.deleteGateway?a.DM.deleteGateway(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i();},createDevice:function createDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.createDevice?a.DM.createDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.updateDevice?a.DM.updateDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i(new r(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,i){var r=xnm.aio.ir.DMError,o=xnm.aio.ir.DMError.ERROR_CODE;if(e){if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.deleteDevice?a.DM.deleteDevice(e,t,i):i&&i(new r(o.INVALID,"no such sys:"+e.sys));}else i&&i(new r(o.INVALID,"sys is invalid"));}else i&&i();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var i=!1,r=0;r<e.length;r++){if(e[r]==t){i=!0;break;}}return i;},_filter=function _filter(e,t){var i,r=[],o=null;if(e.sys){var a=this._getSystem(e.sys);a&&a.DM&&a.DM.getCommandStatusMap&&(i=a.DM.getCommandStatusMap(e));}return i&&(o=function(e,t,i){var r=[];switch(i.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(i.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(i.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(i,0,t),r=r.concat(o)),r;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter.call(this,e,t),i.command=r;break;case"status":r=_filter.call(this,e,t),i.status=r;break;default:return null;}return r&&0!=r.length?i:null;}},xnm.aio.ir.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.ir.DM,Handler.prototype.registModule=function(e){for(var t in xnm.aio.ir){if(xnm.aio.ir.hasOwnProperty(t)){var i=xnm.aio.ir[t];i&&i.DM&&i.DM.registModule&&i.DM.registModule(e);}}},Handler.prototype.resolveGateway=function(e){switch(e.sys){case xnm.aio.ir.IRTrans.DM.SYS:return xnm.aio.ir.IRTrans.parseJSON(e);case xnm.aio.ir.RedEye.DM.SYS:return xnm.aio.ir.RedEye.parseJSON(e);case xnm.aio.ir.iTach.DM.SYS:return xnm.aio.ir.iTach.parseJSON(e);default:return null;}},Handler.prototype.getDeviceCommands=function(e,t){var i=xnm.aio.ir.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=i?i.command:[];t&&t(null,r);},Handler.prototype.searchIRTransWithTimeout=function(e,t){xnm.aio.ir.IRTrans._discovery(e,t);},Handler.prototype.learnIRTransCode=function(e,t,i){var r=xnm.aio.ir.IRTrans.parseJSON(e);r?r.learnIrCode(t,i):i&&i(new Error("gateway json format invalid"));},Handler.prototype.doIRTransCommand=function(e,t,i,r){var o=xnm.aio.ir.IRTrans.parseJSON(e);o?o.executeCommandCreator(t,i,r,!0):r&&r(new Error("gateway json format invalid"));},Handler.prototype.searchRedeyeWithTimeout=function(e,t){xnm.aio.ir.RedEye.discoveryWithTimeout(e,t);},Handler.prototype.learnRedeyeCode=function(e,t){var i=xnm.aio.ir.RedEye.parseJSON(e);i?i.learnIrCode(t):t&&t(new Error("gateway json format invalid"));},Handler.prototype.doRedeyeCommand=function(e,t,i,r){var o=xnm.aio.ir.RedEye.parseJSON(e);o?o.executeCommandCreator(t,i,r):r&&r(new Error("gateway json format invalid"));},Handler.prototype.searchITach=function(e){xnm.aio.ir.iTach.discovery(e);},Handler.prototype.learnITachCode=function(e,t){var i=xnm.aio.ir.iTach.parseJSON(e);i?i.learnIrCode(!0,t):t&&t(new Error("gateway json format invalid"));},Handler.prototype.doITachCommand=function(e,t,i,r){var o=xnm.aio.ir.iTach.parseJSON(e);o?o.executeCommandCreator(t,i,r,!0):r&&r(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.ir.Handler());