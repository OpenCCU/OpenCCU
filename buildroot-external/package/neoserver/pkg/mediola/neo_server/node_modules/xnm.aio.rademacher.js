var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.rademacher=xnm.aio.rademacher||{},xnm.aio.rademacher.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var t=JSON.parse(JSON.stringify(e));if(t.auth&&(t.auth="xxxxxx:xxxxxx"),t.headers)for(var a in headers){if(a&&"authorization"==a.toLocaleLowerCase()){var o=headers[a];if(o){var r=o.indexOf(" ");headers[a]=-1==r?"xxxxxx":o.substr(0,r)+" xxxxxx";}}}return t;}catch(t){return e;}}},xnm.aio.rademacher.HomePilot=function(e,t,a,o,r){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot"),this.ip=e,this.port=80,t&&(this.port=t),this._user=a,this._password=o,this._uid=r,this._inRemoteMode=!1,this.CommandHandler=null;},xnm.aio.rademacher.HomePilot.prototype.enableRemoteMode=function(e){this._inRemoteMode=e;},xnm.aio.rademacher.HomePilot.prototype._doRequest=function(e,t){var a=this.ip,o=this.port,r="/rest2/Index?do="+e,s=require("http");this._inRemoteMode&&(s=require("https"),a="www.homepilot.de",o=443,r="/uid/"+this._uid+"/rest2/Index?do="+e),"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var i={host:a,port:o,path:r,method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};this._inRemoteMode&&this._user&&this._password&&(i.headers.Authorization="Basic "+new Buffer(this._user+":"+this._password).toString("base64"));var n=this;this._logger.log("trace","send HTTP req: "+JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(i)));var d=s.request(i,function(e){if(n._logger.log("trace","receive HTTP rsp status code: "+e.statusCode),200==e.statusCode){e.setEncoding("utf-8");var a="";e.on("data",function(e){a+=e;}),e.on("end",function(){n._logger.log("trace","receive HTTP rsp: "+a);var e=JSON.parse(a);t&&t(e);});}else 403==e.statusCode?(XC.debugf("UNAUTHORIZED"),t&&t(null)):(XC.debugf("Failed to post request"),t&&t(null));});d.setTimeout(6e3,function(){n._logger.log("trace","send HTTP req timeout"),d.abort();}),d.on("error",function(e){n._logger.log("trace","send HTTP req err: "+e.message),t&&t(null);}),d.end();},xnm.aio.rademacher.HomePilot.prototype.getDevices=function(e){var t={};this._doRequest("/devices",function(a){if(a&&"ok"==a.status)for(var o=0;o<a.devices.length;o++){var r=a.devices[o],s={};s.name=r.name,s.type=r.deviceGroup,s.info=r.description,s.state=r.statusesMap,t[r.did]=s;}else t=null;e(t);});},xnm.aio.rademacher.HomePilot.prototype.getMeters=function(e){var t={},a=[],o=this;this._doRequest("/meters",function(r){if(r&&"ok"==r.status&&r.meters){for(var s=0;s<r.meters.length;s++){var i=r.meters[s];i&&i.did&&a.push(i.did);}0==a.length&&e&&e(null);for(var n=0,d=0;d<a.length;d++){o.getMeter(a[d],function(r){if(n+=1,r&&r.meter&&r.data){var s=o._resolveMeterType(r.data);r.meter.did&&s&&(t[r.meter.did]={name:r.meter.name,address:r.meter.did,type:s,data:r.data});}n==a.length&&e&&e(t);});}}else e&&e(null);});},xnm.aio.rademacher.HomePilot.prototype.getMeter=function(e,t){e?this._doRequest("/meters/"+e,function(e){e&&"ok"==e.status&&e.meter&&e.data?t&&t(e):t&&t(null);}):t&&t(null);},xnm.aio.rademacher.HomePilot.prototype._resolveMeterType=function(e){for(var t={},a=0;a<e.length;a++){for(var o=e[a],r=Object.keys(o),s=0;s<r.length;s++){t[r[s]]=o[r[s]];}}return t["SchlieÃŸer"]?"contact":"sensor";},xnm.aio.rademacher.HomePilot.prototype.getStates=function(e,t,a){if(t&&0!=t.length){var o=this;this.CommandHandler=e,this.getDevices(function(e){if(e&&o.CommandHandler)if(t&&o.CommandHandler.setState)for(var r=0;r<t.length;r++){var s,i=t[r];if(e[i.address]&&(s=e[i.address].state)){var n=o.getStateValues(e[i.address].type,s);for(var d in n){"state"==d?o.CommandHandler.setState(i.id,n[d]):o.CommandHandler.setState(i.id+":"+d,n[d]);}}}else if(o.CommandHandler.receivedState)for(var l in e){o.CommandHandler.receivedState("hp",l,e[l].state);}a&&a(null);});}else a&&a(null);},xnm.aio.rademacher.HomePilot.prototype.executeCommand=function(e,t,a){var o=this;"on"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=10",a):"off"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=11",a):"up"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=1",a):"down"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=2",a):"stop"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=3",a):"dimUp"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=23",a):"dimDown"==t?this._doRequest("/devices/"+e.address+"?do=use&cmd=24",a):"toggle"==t?this._doRequest("/devices/"+e.address,function(t){t&&"ok"==t.status&&t.device?t.device.statusesMap.Position>0?o._doRequest("/devices/"+e.address+"?do=use&cmd=11",a):o._doRequest("/devices/"+e.address+"?do=use&cmd=10",a):a&&a();}):("string"==typeof t&&0==t.indexOf("dimTo")&&(t=t.replace(/dimTo/g,"")),"string"==typeof t&&0==t.indexOf("moveTo")&&(t=t.replace(/moveTo/g,"")),"string"==typeof t&&(t=t.replace(/%/g,"")),this._doRequest("/devices/"+e.address+"?do=use&cmd=9&pos="+t,a));},xnm.aio.rademacher.HomePilot.prototype.getStateValues=function(e,t){var a={};return 1==e?100==t.Position?a.state="on":0==t.Position&&(a.state="off"):a.state=t.Position,a.manu=t.Manuellbetrieb,a;},xnm.aio.rademacher.Kodi=function(e,t,a,o){this.ip=e,this.port=80,t&&(this.port=t),this._user=a,this._password=o,this._inRemoteMode=!1,this.CommandHandler=null;},xnm.aio.rademacher.Kodi.prototype._doRequest=function(e,t,a){var o="/jsonrpc?request=",r={jsonrpc:"2.0",method:e,params:t,id:1};o+=encodeURI(JSON.stringify(r));var s={host:this.ip,port:this.port,path:o,method:"GET",headers:{Connection:"close"}};this._inRemoteMode&&this._user&&this._password&&(s.headers.Authorization="Basic "+new Buffer(this._user+":"+this._password).toString("base64"));var i=require("http").request(s,function(e){if(200==e.statusCode){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var e=JSON.parse(t);a&&a(e);});}else 403==e.statusCode?(XC.debugf("UNAUTHORIZED"),a&&a(null)):(XC.debugf("Failed to post request"),a&&a(null));});i.setTimeout(6e3,function(){i.abort();}),i.on("error",function(e){a&&a(null);}),i.end();},xnm.aio.rademacher.Kodi.prototype.executeCommand=function(e,t,a){var o=null,r={};"play"==t?(o="Player.PlayPause",r={playerid:0}):"stop"==t?(o="Player.Stop",r={playerid:0}):"previous"==t?(o="Player.GoTo",r={playerid:0,to:"previous"}):"next"==t?(o="Player.GoTo",r={playerid:0,to:"next"}):"left"==t?o="Input.Left":"right"==t?o="Input.Right":"up"==t?o="Input.Up":"down"==t?o="Input.Down":"home"==t?o="Input.Home":"enter"==t?o="Input.Select":"info"==t?o="Input.Info":"back"==t?o="Input.Back":"menu"==t?o="Input.ContextMenu":"osd"==t?o="Input.ShowOSD":"mute"==t?(o="Application.SetMute",r={mute:"toggle"}):"volumeUp"==t?(o="Application.SetVolume",r={volume:"increment"}):"volumeDown"==t?(o="Application.SetVolume",r={volume:"decrement"}):"shutdown"==t?o="System.Shutdown":"reboot"==t?o="System.Reboot":"suspend"==t?o="System.Suspend":"hibernate"==t&&(o="System.Hibernate"),o?this._doRequest(o,r,a):a&&a();},xnm.aio.rademacher.HomePilot.prototype.executeCommandCreator=function(e,t,a){if(e&&"kodi"==e.type)return t&&t.value?void new xnm.aio.rademacher.Kodi(this.ip,e.port,e.username,e.password).executeCommand(null,t.value,function(){a&&a();}):void(a&&a(new Error("command invalid")));if(e&&e.address){if(t){var o=t.value;switch(o){case"dimTo":case"moveTo":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command invalid")));if("number"==typeof t.ext)o=parseInt(t.ext);else{if(!t.ext.match(/^[-+]?[0-9]+$/))return void(a&&a(new Error("command invalid")));o=parseInt(t.ext);}break;case"tempTo":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command invalid")));if(o=parseFloat(t.ext),isNaN(o))return void(a&&a(new Error("command invalid")));o=Math.round(10*o);}this.executeCommand(e,o,function(){a&&a();});}else a&&a(new Error("command invalid"));}else a&&a(new Error("device invalid"));},xnm.aio.rademacher.HomePilot.prototype.getStatesCreator=function(e,t,a){if(t){for(var o=[],r=[],s=0;s<t.length;s++){var i=t[s];if(i.device&&i.device.address)if("contact"==i.device.type||"env"==i.device.type||"smoke"==i.device.type||"sun"==i.device.type)r.push(i);else{var n={id:i.id,address:i.device.address};o.push(n);}}var d=0,l=[];this._getMeterStates(r,function(e){d++,e&&(l=l.concat(e)),2==d&&a&&(a(null,l),a=null);});var u={setState:function setState(e,a){var o,r=e.lastIndexOf(":"),s="state";if(-1!=r&&r!=e.length-1){var i=e.substr(r+1);i&&(s=i);}for(var n=0;n<t.length;n++){if(t[n].id==e&&t[n].status&&t[n].device)if("thermo"===t[n].device.type){if("state"==s){var d=parseInt(a);isNaN(d)||(o={id:t[n].id,status:(d/10).toFixed(1)},l.push(o));}}else"state"==s&&(o={id:t[n].id,status:a},l.push(o));}}};this.getStates(u,o,function(){2==++d&&a&&(a(null,l),a=null);});}else a&&a(new Error("deviceList is null"));},xnm.aio.rademacher.HomePilot.prototype._getMeterStates=function(e,t){if(e&&0!=e.length){var a,o=0,r=this,s=[];for(a=0;a<e.length;a++){e[a].device&&e[a].device.address&&-1==s.indexOf(e[a].device.address)&&s.push(e[a].device.address);}var i={};for(a=0;a<s.length;a++){s[a]&&this.getMeter(s[a],function(a){if(a&&a.meter&&a.meter.did&&a.data&&(i[a.meter.did]=a.data),++o==s.length){for(var n=[],d=0;d<e.length;d++){if(e[d].id){var l="?";if(e[d].device&&e[d].device.address&&e[d].device.type&&e[d].status&&e[d].status.value&&i[e[d].device.address]){var u=r._resolveMeterDatapointState(e[d].device.type,e[d].status.value,i[e[d].device.address]);void 0!==u&&null!=u&&(l=u);}n.push({id:e[d].id,status:l});}}t&&t(n);}});}}else t&&t(null);},xnm.aio.rademacher.HomePilot.prototype._resolveMeterDatapointState=function(e,t,a){var o=this._resolveMeterStates(e,a);return o?o[t]:null;},xnm.aio.rademacher.HomePilot.prototype._resolveMeterStates=function(e,t){switch(e){case"contact":return this._resolveContactState(t);case"env":return this._resolveEnvState(t);case"smoke":return this._resolveSmokeState(t);case"sun":return this._resolveSunState(t);}return null;},xnm.aio.rademacher.HomePilot.prototype._resolveEnvState=function(e){var t=null,a=null;if(e)if(1==e.length)t={},e[0]&&(a=this._resolveKeyValue(e[0]))&&a.value&&(t.envUpdate=a.value);else if(e.length>=7){if(t={},e[0]&&(a=this._resolveKeyValue(e[0]))&&a.value&&(t.envLum=parseInt(a.value.replace("lx","").trim())),e[1]&&(a=this._resolveKeyValue(e[1]))&&a.value&&(t.envWindS=parseInt(a.value.replace("m/s","").trim())),e[2]&&(a=this._resolveKeyValue(e[2]))&&a.value&&(t.envTemp=parseFloat(a.value.replace("Â°C","").trim())),e[3]&&(a=this._resolveKeyValue(e[3]))&&a.value)switch(a.value){case"Not detected":case"Nicht erkannt":case"Non reconnu":case"Niet herkend":t.envRain="false";break;default:t.envRain="true";}if(e[4]&&(a=this._resolveKeyValue(e[4]))&&a.value&&(t.envSunH=parseInt(a.value.replace("Â°","").trim())),e[5]&&(a=this._resolveKeyValue(e[5]))&&a.value){var o=a.value.indexOf("("),r=a.value.indexOf(")");if(-1!=o&&r>o){var s=a.value.substr(0,o),i=a.value.substr(o+1,r-o-1);t.envSunD=parseInt(i.replace("Â°","").trim()),t.envSunDS=s.trim();}}e[6]&&(a=this._resolveKeyValue(e[6]))&&a.value&&(t.envUpdate=a.value);}return t;},xnm.aio.rademacher.HomePilot.prototype._resolveContactState=function(e){var t=null,a=null;if(e&&e.length>=3){if(t={},e[0]&&(a=this._resolveKeyValue(e[0]))&&a.value)switch(a.value){case"Closed":case"Geschlossen":case"FermÃ©":case"Gesloten":t.contactState="closed";break;default:t.contactState="open";}e[1]&&(a=this._resolveKeyValue(e[1]))&&a.value&&(t.contactBat=parseInt(a.value.replace("%","").trim())),e[2]&&(a=this._resolveKeyValue(e[2]))&&a.value&&(t.contactUpdate=a.value);}return t;},xnm.aio.rademacher.HomePilot.prototype._resolveSmokeState=function(e){var t=null,a=null;if(e&&e.length>=3){if(t={},e[0]&&(a=this._resolveKeyValue(e[0]))&&a.value)switch(a.value){case"Not detected":case"Nicht erkannt":case"Non dÃ©tectÃ©":case"Niet herkend":t.smokeState="ok";break;default:t.smokeState="alarm";}e[1]&&(a=this._resolveKeyValue(e[1]))&&a.value&&(t.smokeBat=parseInt(a.value.replace("%","").trim())),e[2]&&(a=this._resolveKeyValue(e[2]))&&a.value&&(t.smokeUpdate=a.value);}return t;},xnm.aio.rademacher.HomePilot.prototype._resolveSunState=function(e){var t=null,a=null;if(e&&e.length>=2){if(t={},e[0]&&(a=this._resolveKeyValue(e[0]))&&a.value)switch(a.value){case"Not detected":case"Nicht erkannt":case"Non reconnu":case"Niet herkend":t.sunState="no";break;default:t.sunState="yes";}e[1]&&(a=this._resolveKeyValue(e[1]))&&a.value&&(t.sunUpdate=a.value);}return t;},xnm.aio.rademacher.HomePilot.prototype._resolveKeyValue=function(e){for(var t in e){if(e.hasOwnProperty(t))return{key:t,value:e[t]};}return null;},xnm.aio.rademacher.HomePilot.prototype.getSensorTypeFromData=function(e){var t=null;if(e&&e[0]){var a=this._resolveKeyValue(e[0]);if(a&&a.key&&a.value){switch(a.key){case"Closer":case"SchlieÃŸer":case"Contact normalement ouvert":case"Sluitcontact":t="contact";break;case"Smoke":case"Rauch":case"FumÃ©e":case"roken":t="smoke";break;case"Sun":case"Sonne":case"Soleil":case"Zon":t="sun";}-1!=a.value.indexOf("lx")&&(t="env");}}return t;},xnm.aio.rademacher.HomePilot.prototype.toJSON=function(){return{sys:"homepilot1",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid};},xnm.aio.rademacher.HomePilot.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rademacher.HomePilot&&this.ip==e.ip&&this.port==e.port&&this._uid==e._uid;},xnm.aio.rademacher.HomePilot2=function(e,t,a,o,r){xnm.aio.rademacher.HomePilot.call(this,e,t,a,o,r);},xnm.aio.rademacher.HomePilot2.prototype=xnm.aio.rademacher.HomePilot.prototype,xnm.aio.rademacher.HomePilot2.constructor=xnm.aio.rademacher.HomePilot2,xnm.aio.rademacher.HomePilot2.prototype.toJSON=function(){return{sys:"homepilot2",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid};},xnm.aio.rademacher.HomePilot2.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.rademacher.HomePilot2&&this.ip==e.ip&&this.port==e.port&&this._uid==e._uid;},xnm.aio.rademacher.HomePilot2V5=function(){var HP2V5=function HP2V5(e,t,a,o,r){this._logger=require("x.logger.js").getLogger("xnm.aio.rademacher.HomePilot2V5"),this.ip=e,this.port=80,t&&(this.port=t),this._user=a,this._password=o,this._uid=r,this._loginCookie=null,this._loginCBs=[];};return HP2V5.prototype.executeCommandCreator=function(e,t,a){if(e&&e.address&&"kodi"!=e.type){if(t){switch(t.value){case"dimTo":case"moveTo":case"tempTo":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command invalid")));var o=parseFloat(t.ext);if(isNaN(o))return void(a&&a(new Error("command invalid")));}this.executeCommand(e,t,function(e){a&&a(e);});}else a&&a(new Error("command invalid"));}else a&&a(new Error("device invalid"));},HP2V5.prototype.getStatesCreator=function(e,t,a){t?this.getStates(function(e,o){if(e)a&&a(e);else{for(var r=[],s=0;s<t.length;s++){var i=t[s];if(i.id&&i.device&&i.device.address&&i.status&&i.status.value){var n=o[i.device.address],d=null;n&&(d=n[i.status.value]),null==d&&(d="?"),r.push({id:i.id,status:d});}}a&&a(null,r);}}):a&&a(new Error("deviceList is null"));},HP2V5.prototype.executeCommand=function(e,t,a){var o=this;"on"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"TURN_ON_CMD"},a):"off"==t.value?"dimmer"==e.type?this.executeCommand(e,{value:"dimTo",ext:0},a):this._doRestReq("PUT","/devices/"+e.address,{name:"TURN_OFF_CMD"},a):"toggle"==t.value?this.getStates(function(t,r){if(t)a&&a(t);else{var s=r[e.address];s&&"on"==s.state||s&&!isNaN(s.state)&&0!=s.state?o.executeCommand(e,{value:"off"},a):o.executeCommand(e,{value:"on"},a);}}):"up"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"POS_UP_CMD"},a):"down"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"POS_DOWN_CMD"},a):"stop"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"STOP_CMD"},a):"dimUp"==t.value||"stepUp"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"INC_CMD"},a):"dimDown"==t.value||"stepDown"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"DEC_CMD"},a):"dimTo"==t.value||"moveTo"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"GOTO_POS_CMD",value:parseInt(t.ext)},a):"tempTo"==t.value?this._doRestReq("PUT","/devices/"+e.address,{name:"TARGET_TEMPERATURE_CFG",value:parseInt(t.ext)},a):a&&a(new Error("unknown command"));},HP2V5.prototype.getStates=function(e){var t=this;this._doRestReq("GET","/devices",null,function(a,o){if(a)e&&e(a);else if(o.payload&&o.payload.devices){var r={};o.payload.devices.forEach(function(e){if(e&&e.capabilities){var a=t._evalDevice(e);a&&a.address&&a.states&&(r[a.address]=a.states);}}),e&&e(null,r);}else e&&e(null,[]);});},HP2V5.prototype.getDevices=function(e){var t=this;this._doRestReq("GET","/devices",null,function(a,o){if(a)e&&e(a);else if(o.payload&&o.payload.devices){var r=[];o.payload.devices.forEach(function(e){if(e&&e.capabilities){var a=t._evalDevice(e);a&&(delete a.states,r.push(a));}}),e&&e(null,r);}else e&&e(null,[]);});},HP2V5.prototype.login=function(e){var _this=this;var t=this._loginCBs.length;if(e&&-1===this._loginCBs.indexOf(e)&&this._loginCBs.push(e),0===t){var a=this,handleCallbacks=function handleCallbacks(e){var t=_this._loginCBs;_this._loginCBs=[],t.forEach(function(t){return t&&t(e);});};a._getPasswordSalt(function(e,t){if(e)return a._logger.log("error",e.message),void handleCallbacks(e);var o=a._encodePassword(t);a._login(o,t,function(e,t){if(e)return a._logger.log("error",e.message),void handleCallbacks(e);a._loginCookie=t,handleCallbacks();});});}else this._logger.log("debug","/login already pending. Adding callback to list.");},HP2V5.prototype.equalsTo=function(e){return!!e&&e instanceof HP2V5&&this.ip==e.ip&&this.port==e.port&&this._user==e._user&&this._password==e._password;},HP2V5.prototype.toJSON=function(){return{sys:"homepilot2v5",ip:this.ip,port:this.port,username:this._user,password:this._password,uid:this._uid};},HP2V5.prototype._evalDevice=function(e){var t={sys:"homepilot2v5",name:null,type:null,address:null,caps:[],states:{}};if(!e||!e.capabilities)return null;for(var a=[],o=0;o<e.capabilities.length;o++){var r=e.capabilities[o];if("NAME_DEVICE_LOC"==r.name)t.name=r.value;else if("ID_DEVICE_LOC"==r.name)t.address=r.value;else if("DEVICE_TYPE_LOC"==r.name)switch(r.value){case"1":t.type="switch";break;case"2":t.type="blind";break;case"3":t.type="sensor";break;case"4":t.type="dimmer";break;case"5":t.type="thermo";break;case"8":t.type="gate";}else if("REACHABILITY_EVT"==r.name)t.states.reachable=r.value,-1!=r.timestamp&&(t.states.update=new Date(1e3*r.timestamp).toString());else if("CURR_SWITCH_POS_CFG"==r.name)t.states.state="false"==r.value?"off":"on";else if("CURR_POS_CFG"==r.name)t.states.state=parseInt(r.value);else if("TARGET_TEMPERATURE_CFG"==r.name)t.states.state=parseFloat(r.value),t.caps.push(r);else if("BATTERY_LVL_PCT_MEA"==r.name)t.states.battery=parseInt(r.value);else if("BATT_VALUE_EVT"==r.name)t.states.thermoBat=parseInt(r.value);else if("SMOKE_DETECTION_MEA"==r.name)t.states.smokeState="false"==r.value?"ok":"alarm",-1!=r.timestamp&&(t.states.smokeUpdate=new Date(1e3*r.timestamp).toString()),a.push(r.name);else if("CLOSE_CONTACT_MEA"==r.name)t.states.contactState="2"==r.value?"tilted":"1"==r.value?"open":"closed",-1!=r.timestamp&&(t.states.contactUpdate=new Date(1e3*r.timestamp).toString()),a.push(r.name);else if("LIGHT_VAL_LUX_MEA"==r.name)t.states.envLum=parseFloat(r.value),a.push(r.name);else if("WIND_SPEED_MS_MEA"==r.name)t.states.envWindS=parseFloat(r.value),a.push(r.name);else if("TEMP_CURR_DEG_MEA"==r.name)t.states.envTemp=parseFloat(r.value),a.push(r.name);else if("RAIN_DETECTION_MEA"==r.name)t.states.envRain=r.value,-1!=r.timestamp&&(t.states.envUpdate=new Date(1e3*r.timestamp).toString()),a.push(r.name);else if("SUN_DIRECTION_MEA"==r.name){var s=parseFloat(r.value);t.states.envSunD=s;var i=null;s<22.5||s>=337.5?i="N":s>=22.5&&s<67.5?i="NE":s>=67.5&&s<112.5?i="E":s>=112.5&&s<157.5?i="SE":s>=157.5&&s<202.5?i="S":s>=202.5&&s<247.5?i="SW":s>=247.5&&s<292.5?i="W":s>=292.5&&s<337.5&&(i="NW"),t.states.envSunDS=i,a.push(r.name);}else"SUN_HEIGHT_DEG_MEA"==r.name?(t.states.envSunH=parseFloat(r.value),a.push(r.name)):"SUN_DETECTION_MEA"==r.name?(t.states.sunState="false"==r.value?"no":"yes",t.states.envSunS="false"==r.value?"no":"yes",-1!=r.timestamp&&(t.states.sunUpdate=new Date(1e3*r.timestamp).toString()),a.push(r.name)):r.name&&a.push(r.name);}return t.type&&t.address?("sensor"==t.type&&(-1!=a.indexOf("CLOSE_CONTACT_MEA")?(t.type="contact",void 0!==t.states.battery&&null!=t.states.battery&&(t.states.contactBat=t.states.battery)):-1!=a.indexOf("SMOKE_DETECTION_MEA")?(t.type="smoke",void 0!==t.states.battery&&null!=t.states.battery&&(t.states.smokeBat=t.states.battery),!t.states.smokeUpdate&&t.states.update&&(t.states.smokeUpdate=t.states.update)):-1!=a.indexOf("SUN_DETECTION_MEA")&&-1==a.indexOf("RAIN_DETECTION_MEA")?t.type="sun":-1!=a.indexOf("RAIN_DETECTION_MEA")&&(t.type="env")),t):null;},HP2V5.prototype._encodePassword=function(e){var t=require("x.crypt.js"),a=t.SHA256(this._password);return t.SHA256(e+a);},HP2V5.prototype._getPasswordSalt=function(e){this._doRequest("POST","/authentication/password_salt",null,null,function(t,a,o){if(t)e&&e(t);else{var r=null,s=null;if(200==o){if(a)try{if(!(r=JSON.parse(a)))return void(e&&e(new Error("invalid get password salt response: "+a)));if(r.error_description&&"OK"!==r.error_description)return(s=new Error(r.error_description)).code=r.error_code,void(e&&e(s));if(!r.password_salt)return void(e&&e(new Error("invalid get password salt response: "+a)));e&&e(null,r.password_salt);}catch(t){e&&e(new Error("invalid get password salt response: "+a));}else e&&e(new Error("get password salt response empty"));}else{if(!a)return void(e&&e(new Error("get password salt failed, response status code: "+o)));try{(r=JSON.parse(a))&&r.error_description&&"OK"!==r.error_description?((s=new Error(r.error_description)).code=r.error_code,e&&e(s)):e&&e(new Error("get password salt failed, response status code: "+o+", response: "+a));}catch(t){e&&e(new Error("get password salt failed, response status code: "+o+", response: "+a));}}}});},HP2V5.prototype._login=function(e,t,a){var _this2=this;var o={password:e,password_salt:t};this._doRequest("POST","/authentication/login",null,JSON.stringify(o),function(e,t,o,r){if(e)a&&a(e);else{var s=null,i=null;if(200==o)r&&r["set-cookie"]?(_this2._logger.log("trace",'[_login] Received header with "set-cookie" value.'),a&&a(null,r["set-cookie"])):a&&a(new Error('login failed, no "set-cookie" in headers'));else{if(!t)return void(a&&a(new Error("login failed, response status code: "+o)));try{(s=JSON.parse(t))&&s.error_description&&"OK"!==s.error_description?((i=new Error(s.error_description)).code=s.error_code,a&&a(i)):a&&a(new Error("login failed, response status code: "+o+", response: "+t));}catch(e){a&&a(new Error("login failed (JSON parse error), response status code: "+o+", response: "+t));}}}});},HP2V5.prototype._doRestReq=function(e,t,a,o){var r=this;if(!this._loginCookie&&this._password)this._logger.log("trace","No cookie, need to login again."),this.login(function(s){s?o&&o(s):r._doRestReq(e,t,a,o);});else{var s=null;this._loginCookie&&this._password&&(s={Cookie:this._loginCookie});var i=null;a&&(i=JSON.stringify(a)),this._doRequest(e,t,s,i,function(s,i,n){if(s)o&&o(s);else{if(401==n&&r._password)return r._loginCookie=null,void r._doRestReq(e,t,a,o);if(200==n){if(i)try{var d=JSON.parse(i);if(!d)return void(o&&o(new Error("invalid HTTP response: "+i)));if(d.error_description&&"OK"!==d.error_description){var l=new Error(d.error_description);return l.code=d.error_code,void(o&&o(l));}o&&o(null,d);}catch(e){o&&o(new Error("invalid HTTP response: "+i));}else o&&o(new Error("HTTP response empty"));}else o&&o(new Error("HTTP request failed, response status code: "+n));}});}},HP2V5.prototype._doRequest=function(e,t,a,o,r){"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var s={host:this.ip,port:this.port,path:t,method:e,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8",Connection:"close",rejectUnauthorized:!1,requestCert:!0}};if(a)for(var i in a){s.headers[i]=a[i];}var n=this;this._logger.log("trace","send HTTP req: "+JSON.stringify(xnm.aio.rademacher.Util.clearHttpOptionForLog(s))),o&&this._logger.log("trace","with data: "+o);var d=require("http").request(s,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){n._logger.log("trace","receive HTTP rsp status code: "+e.statusCode),n._logger.log("trace","receive HTTP rsp: "+t),r&&(r(null,t,e.statusCode,e.headers),r=null);});});d.setTimeout(6e3,function(){n._logger.log("error","send HTTP req timeout (6s)"),r&&(r(new Error("HTTP timeout")),r=null),d.abort();}),d.on("error",function(e){n._logger.log("error","send HTTP req err: "+e.message),r&&(r(e),r=null);}),o&&d.write(o),d.end();},HP2V5;}(),xnm.aio.rademacher.Handler=function(){},xnm.aio.rademacher.Handler.prototype.HomePilot=xnm.aio.rademacher.HomePilot,xnm.aio.rademacher.Handler.prototype.Kodi=xnm.aio.rademacher.Kodi,xnm.aio.rademacher.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.rademacher.HomePilot().getStateValues(e.type,t);},xnm.aio.rademacher.Handler.prototype.devicemanager=null,xnm.aio.rademacher.Handler.prototype.registModule=function(e){e.register("homepilot1","rademacher"),e.register("homepilot2","rademacher"),e.register("homepilot2v5","rademacher");},xnm.aio.rademacher.Handler.prototype.resolveGateway=function(e){if(!e||!e.ip||!e.sys)return null;switch(e.sys){case"homepilot1":return new xnm.aio.rademacher.HomePilot(e.ip,e.port,e.username,e.password,e.uid);case"homepilot2":return new xnm.aio.rademacher.HomePilot2(e.ip,e.port,e.username,e.password,e.uid);case"homepilot2v5":return new xnm.aio.rademacher.HomePilot2V5(e.ip,e.port,e.username,e.password,e.uid);default:return null;}},xnm.aio.rademacher.Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=a?a.command:[];t&&t(null,o);},xnm.aio.rademacher.Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=a?a.status:[];t&&t(null,o);},xnm.aio.rademacher.Handler.prototype.doCommand=function(e,t,a,o){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},xnm.aio.rademacher.Handler.prototype.doStatus=function(e,t,a,o,r){var s=this.resolveGateway(t);if(s){var i=[{id:e,device:a,status:o}];s.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},xnm.aio.rademacher.Handler.prototype.discover=function(e,t,a){var o=require("x.mdns.js");o.clearRecordBuffer(),"homepilot2v5"==e?o.discoverServiceWithTimeout("_http._tcp.local",t,function(e,t){if(e)a&&a(e);else{for(var o=[],r=0;r<t.length;r++){var s=t[r];if(s.domain&&s.ip&&s.ip.length>0)if(-1!=s.domain.toLowerCase().indexOf("homepilot")){var i=new xnm.aio.rademacher.HomePilot2V5(s.ip[0]);o.push(i);}}a&&a(e,o);}}):o.discoverServiceWithTimeout("_workstation._tcp.local",t,function(t,o){if(t)a&&a(t);else{for(var r=[],s=0;s<o.length;s++){var i,n=o[s];if(n.target&&n.ip&&n.ip.length>0)if(-1!=n.target.toLowerCase().indexOf("homepilot"))i="homepilot1"==e?new xnm.aio.rademacher.HomePilot(n.ip[0]):new xnm.aio.rademacher.HomePilot2(n.ip[0]),r.push(i);}a&&a(t,r);}});},xnm.aio.rademacher.Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);if(a){if(a instanceof xnm.aio.rademacher.HomePilot2V5)a.getDevices(function(e,a){t&&t(e,a);});else{var o=this,r=!1,s=!1,i=[],cb=function cb(){r&&s&&t&&t(null,i);};a.getDevices(function(e){var t;if(r=!0,e)for(var s in e){e.hasOwnProperty(s)&&(t=o._device2json(a,e[s],s))&&i.push(t);}a instanceof xnm.aio.rademacher.HomePilot2&&i.push({sys:"homepilot2",type:"kodi",port:8080}),cb();}),a.getMeters(function(e){s=!0;var t,o="homepilot1";if(a instanceof xnm.aio.rademacher.HomePilot2&&(o="homepilot2"),e)for(var r in e){if(e.hasOwnProperty(r)&&(t=e[r])){if(t.data){var n=a.getSensorTypeFromData(t.data);t.type=n||"",t.sys=o;}i.push(t);}}cb();});}}else t&&t(new Error("gateway json format invalid"));},xnm.aio.rademacher.Handler.prototype._device2json=function(e,t,a){var o=t.type,r="homepilot1";switch(e instanceof xnm.aio.rademacher.HomePilot2&&(r="homepilot2"),o){case 1:o="switch";break;case 3:o="sensor";break;case 2:o="blind";break;case 5:o="thermo";break;case 4:o="dimmer";break;case 8:o="gate";break;default:return null;}return t.sys=r,t.address=a,t.type=o,t;},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rademacher.Handler());