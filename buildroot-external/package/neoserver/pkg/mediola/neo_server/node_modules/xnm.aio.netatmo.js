function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.netatmo=xnm.aio.netatmo||{},xnm.aio.netatmo.Cloud=function(){var e="564b2c5245a1e3173cb21d3b",t="n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",a={},r={},o={},s={},getRefreshToken=function getRefreshToken(e){return e.refreshToken?e.refreshToken:e.user?r[e.user]:null;},getCred=function getCred(e){var t=getRefreshToken(e);return t?(a[t]||(a[t]={cloud:e}),a[t].cred?a[t].cred:{refresh_token:t}):null;},setCred=function setCred(e,t){var o=t.refresh_token;e.refreshToken||(e.refreshToken=o),e.user&&(r[e.user]=o),a[o]||(a[o]={cloud:e}),a[o].cred=t,t.expires_in&&(t._expireTime=new Date().getTime()+1e3*t.expires_in-6e5);},getWeatherBuffer=function getWeatherBuffer(e){var t=getRefreshToken(e);return t?(a[t]||(a[t]={cloud:e}),a[t].weather||(a[t].weather={updateData:{running:!1,error:null}}),a[t].weather):null;},updateWeatherFinish=function updateWeatherFinish(e,t,r){var o=getRefreshToken(e),s=getWeatherBuffer(e);s.updateData={running:!1,error:t};try{if(!t&&r){var n=require("xnm.aio.netatmo.js")._updateListener;if(n&&n.length>0)for(var i=0;i<n.length;i++){n[i]&&n[i].updateWeather&&n[i].updateWeather(e,s.data,r);}}}catch(e){}s.timer&&clearTimeout(s.timer);var u=getLastWeatherMessure(e);t?s.data=null:r&&(s.data=r);var m,d=s.tmpCBs;if(s.tmpCBs=[],d)for(var l=0;l<d.length;l++){t?d[l](t):e.getWeatherStatus(d[l]);}if(t)s.timer=setTimeout(function(){a[o].cloud.getStationsData(null);},6e4);else{var h=getLastWeatherMessure(e);if(u&&h&&u==h&&s.retry<1)s.retry=s.retry?s.retry+1:1,m=60*s.retry,s.delay=m,s.timer=setTimeout(function(){a[o].cloud.getStationsData(null);},1e3*m);else{s.retry=0;var p=s.delay;if(p||(p=0),m=6e5,h){var c=Math.round(new Date().getTime()/1e3);c>h&&(m=600-(c-h)%600+30);}require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud").log("debug","weather station next poll in t:"+m/60+" min delay:"+p),s.timer=setTimeout(function(){a[o].cloud.getStationsData(null);},1e3*m+1e3*p);}}},getLastWeatherMessure=function getLastWeatherMessure(e){var t=getWeatherBuffer(e);if(!t.data)return 0;for(var a=0;a<t.data.length;a++){if(t.data[a]&&t.data[a].dashboard_data&&t.data[a].dashboard_data.time_utc)return t.data[a].dashboard_data.time_utc;}return 0;},getHomeCoachBuffer=function getHomeCoachBuffer(e){var t=getRefreshToken(e);return t?(a[t]||(a[t]={cloud:e}),a[t].homecoach||(a[t].homecoach={updateData:{running:!1,error:null}}),a[t].homecoach):null;},updateHomeCoachFinish=function updateHomeCoachFinish(e,t,r){var o=getRefreshToken(e),s=getHomeCoachBuffer(e);s.updateData={running:!1,error:t};try{if(!t&&r){var n=require("xnm.aio.netatmo.js")._updateListener;if(n&&n.length>0)for(var i=0;i<n.length;i++){n[i]&&n[i].updateHomeCoach&&n[i].updateHomeCoach(e,s.data,r);}}}catch(e){}s.timer&&clearTimeout(s.timer);var u=getLastHomeCoachMessure(e);t?s.data=null:r&&(s.data=r);var m,d=s.tmpCBs;if(s.tmpCBs=[],d)for(var l=0;l<d.length;l++){t?d[l](t):e.getWeatherStatus(d[l]);}if(t)s.timer=setTimeout(function(){a[o].cloud.getHomeCoachsData(null);},6e4);else{var h=getLastHomeCoachMessure(e);if(u&&h&&u==h&&s.retry<1)s.retry=s.retry?s.retry+1:1,m=60*s.retry,s.delay=m,s.timer=setTimeout(function(){a[o].cloud.getHomeCoachsData(null);},1e3*m);else{s.retry=0;var p=s.delay;if(p||(p=0),m=6e5,h){var c=Math.round(new Date().getTime()/1e3);c>h&&(m=600-(c-h)%600+30);}s.timer=setTimeout(function(){a[o].cloud.getHomeCoachsData(null);},1e3*m+1e3*p);}}},getLastHomeCoachMessure=function getLastHomeCoachMessure(e){var t=getHomeCoachBuffer(e);if(!t.data)return 0;for(var a=0;a<t.data.length;a++){if(t.data[a]&&t.data[a].dashboard_data&&t.data[a].dashboard_data.time_utc)return t.data[a].dashboard_data.time_utc;}return 0;},getThermoBuffer=function getThermoBuffer(e){var t=getRefreshToken(e);return t?(a[t]||(a[t]={cloud:e}),a[t].thermo||(a[t].thermo={updateData:{running:!1,error:null}}),a[t].thermo):null;},updateThermoFinish=function updateThermoFinish(e,t,r){var o=getRefreshToken(e),s=getThermoBuffer(e);try{if(!t&&r){var n=require("xnm.aio.netatmo.js")._updateListener;if(n&&n.length>0)for(var i=0;i<n.length;i++){n[i]&&n[i].updateThermo&&n[i].updateThermo(e,s.data,r);}}}catch(e){}s.timer&&clearTimeout(s.timer),s.updateData={running:!1,error:t},t?s.data=null:r&&(s.data=r);var u=s.tmpCBs;if(s.tmpCBs=[],u)for(var m=0;m<u.length;m++){t?u[m](t):e.getThermoStatus(u[m]);}s.timer=t?setTimeout(function(){a[o].cloud.getThermostatsData(null);},6e4):setTimeout(function(){a[o].cloud.getThermostatsData(null);},18e5);},getThermoTempDuration=function getThermoTempDuration(e,t){var r=getRefreshToken(e);if(!t.module)return 60;var o=getThermoBuffer(e);o.duration||(a[r].thermo.duration={});var s=o.duration[t.module];return s||(s=function(e,t){if(t.module&&XC&&XC.localStorage){var a=XC.localStorage.getItem("netatmo");if(a)try{a=JSON.parse(a);}catch(e){}if(a&&a.duration)return a.duration[t.module];}return null;}(0,t),o.duration[t.module]=s),s||(s=60),s;},updateThermoTempDuration=function updateThermoTempDuration(e,t,a){var r=getThermoBuffer(e);r.duration||(r.duration={}),t.module&&(r.duration[t.module]=a,function(e,t,a){if(t.module&&XC&&XC.localStorage){var r=XC.localStorage.getItem("netatmo");if(r)try{r=JSON.parse(r);}catch(e){}r&&"object"==_typeof(r)||(r={}),r.duration||(r.duration={}),r.duration[t.module]=a,XC.localStorage.setItem("netatmo",JSON.stringify(r));}}(0,t,a));},Cloud=function Cloud(e,t,a){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Cloud"),this.user=e,this.password=t,this.refreshToken=a,this._scope=["read_station","read_thermostat","read_homecoach","write_thermostat","read_camera","access_camera","read_presence","access_presence"],this._scopeFallback=["read_station","read_thermostat","read_homecoach","write_thermostat","read_camera","access_camera","read_presence"];};return Cloud.prototype.executeCommandCreator=function(e,t,a){if(t&&t.value){var r=this,o={},s=getThermoTempDuration(this,e);(function(e,t){var a=getThermoBuffer(e);if(a.data)for(var r=0;r<a.data.length;r++){var o=a.data[r];if(o&&o._id==t.address&&o.modules)for(var s=0;s<o.modules.length;s++){var n=o.modules[s];if(n&&n._id==t.module)return n.setpoint;}}})(this,e);switch(t.value){case"thermoAuto":o.setpoint_mode="program";break;case"thermoAway":o.setpoint_mode="away";break;case"thermoHg":o.setpoint_mode="hg";break;case"thermoOff":o.setpoint_mode="off";break;case"thermoMax":o.setpoint_mode="max",o.setpoint_endtime=Math.round((new Date().getTime()+6e4*s)/1e3);break;case"thermoManu":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command ext invalid")));var n=t.ext;"string"==typeof t.ext&&(n=parseFloat(t.ext)),n<5.5&&(n=5.5),n>30&&(n=30),o.setpoint_mode="manual",o.setpoint_endtime=Math.round((new Date().getTime()+6e4*s)/1e3),o.setpoint_temp=n;break;case"tempDuration":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command ext invalid")));var i=t.ext;return"string"==typeof t.ext&&(i=parseFloat(t.ext)),i<15&&(i=15),i>720&&(i=720),updateThermoTempDuration(this,e,i),void(a&&a());default:a&&a(new Error("unknow command"));}this.setThermPoint(e,o,function(t){t?a&&a(t):(!function(e,t,a){var r,o,s,n=getThermoBuffer(e);for(n.data||(n.data=[]),r=0;r<n.data.length;r++){if(n.data[r]&&n.data[r]._id==t.address){o=n.data[r];break;}}for(o||(o={_id:t.address,modules:[]},n.data.push(o)),r=0;r<o.modules.length;r++){if(o.modules[r]&&o.modules[r]._id==t.module){s=o.modules[r];break;}}s||(s={_id:t.module},o.modules.push(s)),s.setpoint=a;}(r,e,o),a&&a());});}else a&&a(new Error("command format invalid"));},Cloud.prototype.getStatesCreator=function(e,t,a){t?this.getAllStatus(function(e,r){for(var n=[],i=0;i<t.length;i++){var u=t[i];if(u.id){var m,d,l="?";if(!e&&r&&u.device&&u.device.type)if((d="NAMain"==u.device.type||"NHC"==u.device.type?u.device.address:u.device.address+"|"+u.device.module)&&u.status&&u.status.value&&(m=r[d]))if("tempFelt"==u.status.value){var h=m.temp,p=m.hum;l=void 0!==h&&void 0!==p?"NHC"==u.device.type?xnm.aio.netatmo.DM.calcFeltTemp(h,p,s):xnm.aio.netatmo.DM.calcFeltTemp(h,p,o):"?";}else"winDName"==u.status.value?null==(l=m.winD)?l="?":(l=Number(l),l=isNaN(l)?"?":l>23&&l<=68?"NO":l>68&&l<=113?"O":l>113&&l<=158?"SO":l>158&&l<=203?"S":l>203&&l<=248?"SW":l>248&&l<=293?"W":l>293&&l<=338?"NW":"N"):null!=(l=m[u.status.value])&&void 0!==l||(l="?");n.push({id:u.id,status:l});}}a&&a(null,n);}):a&&a(new Error("deviceList is null"));},Cloud.prototype.getAllStatus=function(e){var t=this,a={};this.getWeatherStatus(function(r,o){r?e&&e(r):t.getThermoStatus(function(r,s){r?e&&e(r):t.getHomeCoachStatus(function(t,r){if(t)e&&e(t);else{var n;for(n in o){o.hasOwnProperty(n)&&(a[n]=o[n]);}for(n in s){s.hasOwnProperty(n)&&(a[n]=s[n]);}for(n in r){r.hasOwnProperty(n)&&(a[n]=r[n]);}e&&e(null,a);}});});});},Cloud.prototype.getDeviceList=function(e){var t=this;this.getStationsData(function(a,r){a?e&&e(a):t.getThermostatsData(function(a,o){a?e&&e(a):t.getHomeCoachsData(function(t,a){if(t)e&&e(t);else{var s={weather:[],thermostat:[]};r&&(s.weather=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];if(r&&r._id&&r.type){var o=r.station_name,s=r.module_name,n={address:r._id,type:r.type,name:o+" ("+s+")"};if(n.dashboard_data=r.dashboard_data,n.modules=[],r.modules)for(var i=0;i<r.modules.length;i++){r.modules[i]&&r.modules[i]._id&&r.modules[i].type&&(s=r.modules[i].module_name,n.modules.push({address:r._id,module:r.modules[i]._id,type:r.modules[i].type,name:o+" ("+s+")",dashboard_data:r.modules[i].dashboard_data}));}t.push(n);}}return t;}(r)),o&&(s.thermostat=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];if(r&&r._id&&r.type){var o,s=r.station_name;if(r.modules)for(var n=0;n<r.modules.length;n++){r.modules[n]&&r.modules[n]._id&&r.modules[n].type&&(o=r.modules[n].module_name,t.push({address:r._id,module:r.modules[n]._id,type:r.modules[n].type,name:s+" ("+o+")"}));}}}return t;}(o)),a&&(s.homecoach=function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];if(r&&r._id&&r.type){var o=r.name,s=r.module_name,n={address:r._id,type:r.type,name:o};s&&(n.name+=" ("+s+")"),n.dashboard_data=r.dashboard_data,n.modules=[],t.push(n);}}return t;}(a)),e&&e(null,s);}});});});},Cloud.prototype.getCamList=function(e){var t=this;this.getCamsData(function(a,r){if(a)e&&e(a);else{var o={cam:[]};r&&(o.cam=function(e){for(var t=[],a=0;a<e.length;a++){if(e[a]&&e[a].id){var r=e[a].name,o=e[a].cameras;if(o)for(var s=0;s<o.length;s++){if(o[s]&&o[s].id){var n="welcome";if("NACamera"==o[s].type?n="welcome":"NOC"==o[s].type&&(n="presence"),n){var i={sys:"cam",type:"system",manufacturer:"netatmo",model:n,address:o[s].id};o[s].name&&(i.name=o[s].name+(r?" ("+r+")":"")),t.push(i);}}}}}return t;}(r));var s=getCred(t);if(o.cam&&o.cam.length>0){for(var n=0;n<o.cam.length;n++){o.cam[n].refreshToken=s.refresh_token;}e&&e(null,o);}else e&&e(null,o);}});},Cloud.prototype.getWeatherStatus=function(e){this._logger.log("debug","getWeatherStatus");var t=getWeatherBuffer(this),a=this,r=e,o=null;t&&t.data?(o=function(e,t){var a={};if(t)for(var r=0;r<t.length;r++){var o=t[r];if(o&&o._id){var s=e._resolveStationStatus(o);if(s&&(a[o._id]=s),o.modules)for(var n=0;n<o.modules.length;n++){(s=e._resolveModuleStatus(o.modules[n]))&&(a[o._id+"|"+o.modules[n]._id]=s);}}}return a;}(this,t.data),r&&r(null,o),r=null):this.getStationsData(function(e){if(e)return r&&r(e),void(r=null);r&&a.getWeatherStatus(r);});},Cloud.prototype.getHomeCoachStatus=function(e){this._logger.log("debug","getHomeCoachStatus");var t=getHomeCoachBuffer(this),a=this,r=e,o=null;t&&t.data?(o=function(e,t){var a={};if(t)for(var r=0;r<t.length;r++){var o=t[r];if(o&&o._id){var s=e._resolveHomeCoachStatus(o);s&&(a[o._id]=s);}}return a;}(this,t.data),r&&r(null,o),r=null):this.getHomeCoachsData(function(e){if(e)return r&&r(e),void(r=null);r&&a.getHomeCoachStatus(r);});},Cloud.prototype.getThermoStatus=function(e){var t=getThermoBuffer(this),a=this,r=e,o=null;t.updateData.running?(t.tmpCBs||(t.tmpCBs=[]),t.tmpCBs.push(e)):t.data?(o=function(e,t){for(var a={},r=0;r<t.length;r++){var o=t[r];if(o&&o._id&&o.modules)for(var s=0;s<o.modules.length;s++){var n=e._resolveModuleStatus(o.modules[s]);n&&(a[o._id+"|"+o.modules[s]._id]=n);}}return a;}(this,t.data),r&&r(null,o),r=null):this.getThermostatsData(function(e){if(e)return r&&r(e),void(r=null);r&&a.getThermoStatus(r);});},Cloud.prototype.getCamUrl=function(e,t){var a=this;this._refreshToken(this.refreshToken,function(r,o){if(r)return o&&o.error&&((r=new Error(o.error))._code="auth_error"),void(t&&t(r));var s;o&&o.access_token&&(s=o.access_token),s?o&&o.scope&&-1==o.scope.indexOf("access_camera")?t&&t(null,"scop_error"):a._getCamsData(s,function(r,o){if(r)return o&&o.error&&((r=new Error(o.error))._code="api_error"),void(t&&t(r));var s=null;if(o.body&&o.body.homes&&(s=o.body.homes),s){for(var n,i=0;i<s.length;i++){if(s[i]&&s[i].cameras){for(var u=s[i].cameras,m=0;m<u.length;m++){if(u[m]&&u[m].id==e&&u[m].vpn_url){n=u[m];break;}}if(n)break;}}n?1==n.is_local?a._getLocalCamUrl(n.vpn_url,function(e,a){t&&t(e,a);}):t&&t(null,n.vpn_url+"/live/index.m3u8"):t&&t("no cam with address:"+e);}else t&&t("get cams data reponse invalid");}):t&&t(new Error("auth response invalid"));});},Cloud.prototype._resolveStationStatus=function(e){var t={};if(null!=e.wifi_status&&void 0!==e.wifi_status&&(t.wifi=e.wifi_status,t.wifi>=86?t.wifiStatus="bad":t.wifi>=71?t.wifiStatus="middle":t.wifi>=56?t.wifiStatus="good":t.wifiStatus="very_good"),e.dashboard_data){var a=this._resolveDashboard(e.dashboard_data);if(a)for(var r in a){a.hasOwnProperty(r)&&(t[r]=a[r]);}}return t;},Cloud.prototype._resolveModuleStatus=function(e){var t,a,r={};if(null!=e.rf_status&&void 0!==e.rf_status&&(r.rf=e.rf_status,r.rf>=90?r.rfStatus="very_low":r.rf>=80?r.rfStatus="low":r.rf>=70?r.rfStatus="medium":r.rf>=60?r.rfStatus="high":r.rfStatus="full"),null!=e.battery_vp&&void 0!==e.battery_vp)switch(r.bat=e.battery_vp,e.type){case"NAModule4":r.bat>=5640?r.batStatus="full":r.bat>=5280?r.batStatus="high":r.bat>=4920?r.batStatus="medium":r.bat>=4560?r.batStatus="low":r.batStatus="very_low";break;case"NAModule1":case"NAModule3":r.bat>=5500?r.batStatus="full":r.bat>=5e3?r.batStatus="high":r.bat>=4500?r.batStatus="medium":r.bat>=4e3?r.batStatus="low":r.batStatus="very_low";break;case"NAModule2":r.bat>=5900?r.batStatus="full":r.bat>=5180?r.batStatus="high":r.bat>=4770?r.batStatus="medium":r.bat>=4360?r.batStatus="low":r.batStatus="very_low";break;case"NATherm1":r.bat>=4100?r.batStatus="full":r.bat>=3600?r.batStatus="high":r.bat>=3300?r.batStatus="medium":r.bat>=3e3?r.batStatus="low":r.batStatus="very_low";}if("NATherm1"==e.type&&(t=this._resolveThermoStat(e)))for(a in t){t.hasOwnProperty(a)&&(r[a]=t[a]);}if(e.dashboard_data&&(t=this._resolveDashboard(e.dashboard_data)))for(a in t){t.hasOwnProperty(a)&&(r[a]=t[a]);}return r;},Cloud.prototype._resolveHomeCoachStatus=function(e){var t={};if(null!=e.wifi_status&&void 0!==e.wifi_status&&(t.wifi=e.wifi_status,t.wifi>=86?t.wifiStatus="bad":t.wifi>=71?t.wifiStatus="middle":t.wifi>=56?t.wifiStatus="good":t.wifiStatus="very_good"),e.dashboard_data){var a=this._resolveDashboard(e.dashboard_data);if(a)for(var r in a){a.hasOwnProperty(r)&&(t[r]=a[r]);}}return t;},Cloud.prototype._resolveThermoStat=function(e){var t={};if(e.setpoint){var a;switch(e.setpoint.setpoint_mode){case"program":a="auto";break;case"away":a="away";break;case"hg":a="frost-guard";break;case"manual":a="manu";break;case"off":a="off";break;case"max":a="boost";}if(a&&(t.mode=a),null!=e.setpoint.setpoint_temp&&void 0!==e.setpoint.setpoint_temp&&(t.manuT=e.setpoint.setpoint_temp),null!=e.setpoint.setpoint_endtime&&void 0!==e.setpoint.setpoint_endtime){t.tempEnd=e.setpoint.setpoint_endtime;var r=1e3*e.setpoint.setpoint_endtime;if(t.tempEndStr=new Date(r).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{t.tempEndStr=dateFormat(t.tempEndStr,"dd mm yyyy, HH:MM:ss");}catch(e){}else t.tempEndStr=t.tempEndStr.toLocaleString();}}return e.measured&&(null!=e.measured.time&&void 0!==e.measured.time&&(t.mesureT=e.measured.time),null!=e.measured.temperature&&void 0!==e.measured.temperature&&(t.currentTemp=e.measured.temperature)),t.tempDuration=getThermoTempDuration(this,{module:e._id}),t;},Cloud.prototype._resolveDashboard=function(e){var t,_hasKey=function _hasKey(e,t){return null!=e[t]&&void 0!==e[t];},a={};if(_hasKey(e,"AbsolutePressure")&&(a.absPres=e.AbsolutePressure),_hasKey(e,"CO2")&&(a.co2=e.CO2),_hasKey(e,"Humidity")&&(a.hum=e.Humidity),_hasKey(e,"Noise")&&(a.noise=e.Noise),_hasKey(e,"Pressure")&&(a.pres=e.Pressure),_hasKey(e,"Rain")&&(a.rain=e.Rain),_hasKey(e,"sum_rain_1")&&(a.rain1h=e.sum_rain_1),_hasKey(e,"sum_rain_24")&&(a.rain24h=e.sum_rain_24),_hasKey(e,"Temperature")&&(a.temp=e.Temperature),_hasKey(e,"date_max_temp")&&(a.timeMaxTemp=e.date_max_temp,t=1e3*e.date_max_temp,a.timeMaxTempStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMaxTempStr=dateFormat(a.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):a.timeMaxTempStr=a.timeMaxTempStr.toLocaleString()),_hasKey(e,"date_min_temp")&&(a.timeMinTemp=e.date_min_temp,t=1e3*e.date_min_temp,a.timeMinTempStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMinTempStr=dateFormat(a.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):a.timeMinTempStr=a.timeMinTempStr.toLocaleString()),_hasKey(e,"max_temp")&&(a.maxTemp=e.max_temp),_hasKey(e,"min_temp")&&(a.minTemp=e.min_temp),_hasKey(e,"WindAngle")&&(a.winD=e.WindAngle),_hasKey(e,"WindStrength")&&(a.winS=e.WindStrength),_hasKey(e,"GustAngle")&&(a.gwinD=e.GustAngle),_hasKey(e,"GustStrength")&&(a.gwinS=e.GustStrength),_hasKey(e,"time_utc")&&(a.mesureT=e.time_utc,t=1e3*e.time_utc,a.mesureTStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.mesureTStr=dateFormat(a.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):a.mesureTStr=a.mesureTStr.toLocaleString()),_hasKey(e,"date_max_wind_str")&&(a.timeMaxWind=e.date_max_wind_str,t=1e3*e.date_max_wind_str,a.timeMaxWindStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMaxWindStr=dateFormat(a.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):a.timeMaxWindStr=a.timeMaxWindStr.toLocaleString()),_hasKey(e,"max_wind_angle")&&(a.maxWinD=e.max_wind_angle),_hasKey(e,"max_wind_str")&&(a.maxWinS=e.max_wind_str),_hasKey(e,"temp_trend")&&(a.tempTrend=e.temp_trend),_hasKey(e,"pressure_trend")&&(a.presTrend=e.pressure_trend),_hasKey(e,"health_idx"))switch(a.healthIdxLvl=e.health_idx,parseInt(a.healthIdx)){case 0:a.healthIdx="healthy";break;case 1:a.healthIdx="fine";break;case 2:a.healthIdx="fair";break;case 3:a.healthIdx="poor";break;case 4:a.healthIdx="unhealthy";}return a;},Cloud.prototype.auth=function(e){this._logger.log("debug","auth");var t=getCred(this),a=this;t?t.access_token&&!function(e){var t=getCred(e);return!!t&&!!t._expireTime&&new Date().getTime()>t._expireTime;}(this)?e&&e(null,t):this._refreshToken(t.refresh_token,function(t,r){if(t)return r&&r.error&&((t=new Error(r.error))._code="refresh_token_error"),void(e&&e(t));setCred(a,r),e&&e(null,r);}):this._auth(this._scope.join(" "),function(t,r){if(t){if(r)try{if((r=JSON.parse(r)).error&&((t=new Error(r.error))._code="auth_error","invalid_request"==r.error&&-1!=a._scope.indexOf("access_presence")))return a._scope=a._scopeFallback,void a.auth(e);}catch(e){}e&&e(t);}else setCred(a,r),e&&e(null,r);});},Cloud.prototype.setThermPoint=function(e,t,a){if(e&&e.address&&e.module){if(t&&t.setpoint_mode){if("max"!=t.setpoint_mode||t.setpoint_endtime){if("manual"!=t.setpoint_mode||t.setpoint_endtime&&t.setpoint_temp){var r=this;this.auth(function(o){o?a&&a(o):r._setThermPoint(getCred(r).access_token,e.address,e.module,t.setpoint_mode,t.setpoint_endtime,t.setpoint_temp,function(e,t){if(e)return t&&t.error&&((e=new Error(t.error))._code="api_error"),void(a&&a(e));a&&a(null,t);});});}else a&&a(new Error("param format invalid"));}else a&&a(new Error("param format invalid"));}else a&&a(new Error("param format invalid"));}else a&&a(new Error("device format invalid"));},Cloud.prototype.getStationsData=function(e){this._logger.log("debug","getStationsData");var t=this;this.auth(function(a){if(a)e&&e(a);else{var r=getWeatherBuffer(t);r&&r.updateData&&r.updateData.running?(r.tmpCBs||(r.tmpCBs=[]),r.tmpCBs.push(e)):(!function(e){var t=getWeatherBuffer(e);t.timer&&clearTimeout(t.timer),t.updateData={running:!0,error:null};}(t),t._getStationsData(getCred(t).access_token,null,function(a,r){if(a)return r&&r.error&&((a=new Error(r.error))._code="api_error"),updateWeatherFinish(t,a,null),void(e&&e(a));var s=null;r.body&&r.body.devices&&(s=r.body.devices),r.body&&r.body.user&&r.body.user.administrative&&(o=r.body.user.administrative),updateWeatherFinish(t,null,s),e&&e(null,s);}));}});},Cloud.prototype.getThermostatsData=function(e){var t=this;this.auth(function(a){if(a)e&&e(a);else{var r=getThermoBuffer(this);r&&r.updateData&&r.updateData.running?(r.tmpCBs||(r.tmpCBs=[]),r.tmpCBs.push(e)):(!function(e){var t=getThermoBuffer(e);t.timer&&clearTimeout(t.timer),t.updateData={running:!0,error:null};}(t),t._getThermostatsData(getCred(t).access_token,null,function(a,r){if(a)return r&&r.error&&((a=new Error(r.error))._code="api_error"),updateThermoFinish(t,a,null),void(e&&e(a));var o=null;r.body&&r.body.devices&&(o=r.body.devices),updateThermoFinish(t,null,o),e&&e(null,o);}));}});},Cloud.prototype.getHomeCoachsData=function(e){this._logger.log("debug","getHomeCoachsData");var t=this;this.auth(function(a){if(a)e&&e(a);else{var r=getHomeCoachBuffer(this);r&&r.updateData&&r.updateData.running?(r.tmpCBs||(r.tmpCBs=[]),r.tmpCBs.push(e)):(!function(e){var t=getHomeCoachBuffer(e);t.timer&&clearTimeout(t.timer),t.updateData={running:!0,error:null};}(t),t._getHomeCoachsData(getCred(t).access_token,null,function(a,r){if(a)return r&&r.error&&((a=new Error(r.error))._code="api_error"),updateHomeCoachFinish(t,a,null),void(e&&e(a));var o=null;r.body&&r.body.devices&&(o=r.body.devices),r.body&&r.body.user&&r.body.user.administrative&&(s=r.body.user.administrative),updateHomeCoachFinish(t,null,o),e&&e(null,o);}));}});},Cloud.prototype.getCamsData=function(e){this._logger.log("debug","getCamsData");var t=this;this.auth(function(a){a?e&&e(a):t._getCamsData(getCred(t).access_token,function(t,a){if(t)return a&&a.error&&((t=new Error(a.error))._code="api_error"),void(e&&e(t));var r=null;a.body&&a.body.homes&&(r=a.body.homes),e&&e(null,r);});});},Cloud.prototype._auth=function(a,r){this._logger.log("trace","_auth");var o={grant_type:"password",client_id:e,client_secret:t,username:this.user,password:this.password,scope:a};this._doRequest("POST","/oauth2/token",o,r);},Cloud.prototype._refreshToken=function(a,r){this._logger.log("trace","_refreshToken");var o={grant_type:"refresh_token",client_id:e,client_secret:t,refresh_token:a};this._doRequest("POST","/oauth2/token",o,r);},Cloud.prototype._setThermPoint=function(e,t,a,r,o,s,n){var i={access_token:e,device_id:t,module_id:a,setpoint_mode:r};o&&(i.setpoint_endtime=o),s&&(i.setpoint_temp=s),this._doRequest("GET","/api/setthermpoint",i,n);},Cloud.prototype._getStationsData=function(e,t,a){this._logger.log("debug","_getStationsData");var r={access_token:e};t&&(r.device_id=t),this._doRequest("GET","/api/getstationsdata",r,a);},Cloud.prototype._getHomeCoachsData=function(e,t,a){this._logger.log("debug","_getHomeCoachsData");var r={access_token:e};t&&(r.device_id=t),this._doRequest("GET","/api/gethomecoachsdata",r,a);},Cloud.prototype._getThermostatsData=function(e,t,a){var r={access_token:e};t&&(r.device_id=t),this._doRequest("GET","/api/getthermostatsdata",r,a);},Cloud.prototype._getCamsData=function(e,t){var a={access_token:e};this._doRequest("GET","/api/gethomedata",a,t);},Cloud.prototype._getLocalCamUrl=function(e,t){var a=this;this._logger.log("trace","ping cam "+e),this._doUrlRequest("get",e+"/command/ping",null,function(r,o){!r&&o&&o.local_url?a._doUrlRequest("get",o.local_url+"/command/ping",null,function(a,r){!a&&r&&r.local_url==o.local_url?t&&t(null,r.local_url+"/live/index.m3u8"):t&&t(null,e+"/live/index.m3u8");}):t&&t(null,e+"/live/index.m3u8");});},Cloud.prototype._doRequest=function(e,t,a,r){var o="https://api.netatmo.net"+t;this._doUrlRequest(e,o,a,r);},Cloud.prototype._doUrlRequest=function(e,t,a,r){var o=this,s=r,n=null;try{(n=JSON.parse(JSON.stringify(a))).username&&(n.username="xxxxxx"),n.password&&(n.password="xxxxxx");}catch(e){n=a;}this._logger.log("trace","send "+e+" req to:"+t+" data:"+JSON.stringify(n)),$.ajax({url:t,type:e,timeout:1e4,dataType:"json",data:a,cache:!1,success:function success(e){o._logger.log("trace","http request success:"+JSON.stringify(e)),r&&r(null,e);},error:function error(e,t,a){var r="http request error:"+(e?e.status:"0")+"-"+t;o._logger.log("warn","http request error:"+r);var n=new Error(r);a&&(o._logger.log("warn","http request http error:"+a),n.httpError=!0,n.statusCode=e?e.status:0),s&&(s(n,e?e.responseText:null),s=null);}});},Cloud.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.user,password:this.password};},Cloud.prototype.equalsTo=function(e){return!!e&&e instanceof Cloud&&this.user==e.user&&this.password==e.password;},Cloud.pause=function(e){for(var t in a){if(a.hasOwnProperty(t)){var r=a[t];r&&r.weather&&r.weather.timer&&clearTimeout(r.weather.timer),r&&r.thermo&&r.thermo.timer&&clearInterval(r.thermo.timer);}}a={},e&&e();},Cloud;}(),xnm.aio.netatmo.MNetatmo=function(){var Netatmo=function Netatmo(e){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.MNetatmo"),this._interval=0,this._on={},this._updateInterval=12e4,this._url=null,this._username=e?e.username:null,this._password=e?e.password:null,this._basicAuth=e?e.basicAuth:null;};return Netatmo.CLOUD_URL="cloud.mediola.com",Netatmo.prototype={_doUpdate:function _doUpdate(e){var t=this;APP.isInDemoMode||this.getStates(null,function(a,r){if(r&&r.XC_SUC){for(var o in XC.debugf("[MNetatmo] Received update."),r.XC_SUC){var s=r.XC_SUC[o];for(var n in s){var i=s[n],u=o+"_"+n;if(i.states)for(var m in i.states){CommandHandler.setState(u+":"+m,i.states[m],!0);}}}if(e&&e(),Array.isArray(t._on.update))for(var d={type:"update"},l=0;l<t._on.update.length;l++){var h=t._on.update[l];h&&h(d);}}});},_sendRequest:function _sendRequest(e,t){"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var a=require("https"),r=this._getURL(),o={host:r=r.replace("https://",""),method:"GET",path:e||"/",headers:{}},s=this._getBasicAuthHeader();s&&(o.headers.Authorization=s);var n=this,i=t,u=a.request(o,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(n._logger.log("trace","http reponse:"+t+" statusCode:"+e.statusCode),200==e.statusCode)try{var a=JSON.parse(t);a&&a.XC_SUC?i&&i(null,a.XC_SUC):a&&a.XC_ERR?i&&i(new Error(a.XC_ERR.msg)):i&&i(new Error("http reponse format valid")),i=null;}catch(e){return n._logger.log("trace","http reponse is not valid json:"+e.message),i&&i(e,null),void(i=null);}else i&&i(new Error("http response with code:"+e.statusCode),null);});});u.setTimeout(1e4,function(){n._logger.log("trace","http request timeout"),u.abort(),i&&i(new Error("http timeout")),i=null;}),u.on("error",function(e){n._logger.log("trace","http request error:"+e.message),i&&i(e),i=null;}),u.end();},_getURL:function _getURL(){return this._url?this._url:Netatmo.CLOUD_URL;},_getBasicAuthHeader:function _getBasicAuthHeader(){return this._basicAuth?this._basicAuth:this._username?"Basic "+new Buffer(this._username+":"+(this._password?this._password:"")).toString("base64"):null;},_getStates:function _getStates(e){this._sendRequest("/netatmo/getStates",e);},addEventListener:function addEventListener(e,t){this._on[e]||(this._on[e]=[]),this._on[e].push(t);},setUrl:function setUrl(e){this._url=e;},getDevices:function getDevices(e){this._sendRequest("/netatmo/getDevices",e);},getStates:function getStates(e,t,a){this._getStates(function(r,o){if(r)a&&a(null);else if(t){var s={};for(var n in o){var i=o[n];if(i)for(var u in i){if(t&&t.address==u){var m=i[u];if(m&&m.states){s=m.states;break;}}}}if(e)for(var d in s){e.setState(t.id+":"+d,s[d]);}a&&a(s);}else a&&a(o);});},removeEventListener:function removeEventListener(e,t){if(this._on[e])for(var a=0;a<this._on[e].length;a++){if(this._on[e][a]===t){this._on[e].splice(a,1);break;}}},startUpdating:function startUpdating(e){if(!this._interval)if(APP.isInDemoMode)XC.debugf("[MNetatmo.startUpdating] Ignored. App is in demo mode.");else{var t=this;XC.debugf("[MNetatmo.startUpdating] Start."),this._doUpdate(),this._interval=setInterval(function(){t._doUpdate();},this._updateInterval);}},stopUpdating:function stopUpdating(){clearInterval(this._interval),XC.debugf("[MNetatmo.stopUpdating] Stop.");}},Netatmo;}(),xnm.aio.netatmo.Client=function(){var e="564b2c5245a1e3173cb21d3b",t="n62nZVLAohyP0PQGS0rteCe7iNDVBufjRGCKdqHk6x",a=function(){var Buffer=function Buffer(){this._homes={},this._weather={},this._thermo={},this._coach={},this._states={},this._smartThermoDuraion={};};return Buffer.prototype.getStates=function(){return this._states;},Buffer.prototype.areStatesExpired=function(){var e={weather:!1,thermo:!1,coach:!1,hasWeatherDevice:!1,hasThermoDevice:!1,hasCoachDevice:!1};this._homes.lastReqTime?this._homes.lastReqOk?(e.weather=!(!this._homes.weather||!this._homes.weather.length),e.hasWeatherDevice=e.weather,e.thermo=!(!this._homes.thermo||!this._homes.thermo.length),e.hasThermoDevice=e.thermo):Math.round(new Date().getTime()/1e3)-this._homes.lastReqTime>300&&(e.weather=!0,e.thermo=!0):(e.weather=!0,e.thermo=!0);return this._coach&&(e.coach=!0),e.weather&&(e.weather=this._isWeatherExpired()),e.thermo&&(e.thermo=this._isThermoExpired()),e.coach&&(e.coach=this._isCoachExpired()),e;},Buffer.prototype._isWeatherExpired=function(){if(!this._weather.lastReqTime)return!0;var e=Math.round(new Date().getTime()/1e3);return this._weather.lastReqOk?this._weather.weatherTimeChanged?this._weather.expired:e-this._weather.lastReqTime>660:e-this._weather.lastReqTime>300;},Buffer.prototype._isThermoExpired=function(){if(!this._thermo.lastReqTime)return!0;var e=Math.round(new Date().getTime()/1e3);return this._thermo.lastReqOk?e-this._thermo.lastReqTime>660:e-this._thermo.lastReqTime>300;},Buffer.prototype._isCoachExpired=function(){if(!this._coach.lastReqTime)return!0;var e=Math.round(new Date().getTime()/1e3);return this._coach.lastReqOk?this._coach.coachTimeChanged?this._coach.expired:e-this._coach.lastReqTime>660:e-this._coach.lastReqTime>300;},Buffer.prototype.updateReqTime=function(e,t){switch(e){case"weather":this._weather.lastReqTime=t;break;case"thermo":this._thermo.lastReqTime=t;break;case"coach":this._coach.lastReqTime=t;break;case"homes":this._homes.lastReqTime=t;}},Buffer.prototype.updateReqOK=function(e,t){switch(e){case"weather":this._weather.lastReqOk=t;break;case"thermo":this._thermo.lastReqOk=t;break;case"coach":this._coach.lastReqOk=t;break;case"homes":this._homes.lastReqOk=t;}},Buffer.prototype.updateHomesInfo=function(e,t){if(e&&t)for(var a in this._homes.weather=t.weather,this._homes.thermo=t.thermo,this._homes.coach=t.coach,e){this._states[a]=e[a];}},Buffer.prototype.updateWeatherStatus=function(e,t,a){if(e&&t&&a){var r=t!=this._weather.weatherTime;if(this._weather.weatherTime=t,this._weather.weatherTimeChanged=r,this._weather.expired=a-t>660,!this._weather.expired){this._weather.expireTo&&clearTimeout(this._weather.expireTo);var o=this;this._weather.expireTo=setTimeout(function(){o._weather.expired=!0;},1e3*(t+660-a));}for(var s in e){this._states[s]=e[s];}}},Buffer.prototype.updateThermoStatus=function(e){if(e)for(var _t in e){if(this._states[_t]&&"object"==_typeof(this._states[_t]))for(var _a in e[_t]){this._states[_t][_a]=e[_t][_a];}else this._states[_t]=e[_t];}},Buffer.prototype.updateCoachStatus=function(e,t,a){if(e&&t&&a){var r=t!=this._coach.coachTime;if(this._coach.coachTime=t,this._coach.coachTimeChanged=r,this._coach.expired=a-t>660,!this._coach.expired){this._coach.expireTo&&clearTimeout(this._coach.expireTo);var o=this;this._coach.expireTo=setTimeout(function(){o._coach.expired=!0;},1e3*(t+660-a));}for(var s in e){this._states[s]=e[s];}}},Buffer.prototype.thermoStatusChanged=function(){this._thermo.lastReqTime=null;},Buffer.prototype.setSmartThermoDuration=function(e,t){e&&e.module&&(this._smartThermoDuraion[e.module]=t);},Buffer.prototype.getSmartThermoDuration=function(e){if(e&&e.module)return this._smartThermoDuraion[e.module];},Buffer;}(),Client=function Client(e,t,r){this._logger=require("x.logger.js").getLogger("xnm.aio.netatmo.Client"),this.username=e,this.password=t,this.refreshToken=r,this.accessToken=null,this._scope=["read_station","read_thermostat","read_homecoach","write_thermostat","read_camera","access_camera","read_presence","access_presence"],this._stateBuffer=new a(),this._renewTokenCBs=[],this._getHomesInfoCBs=[],this._getWeatherStatusCBs=[],this._getThermoStatusCBs=[],this._getCoachStatusCBs=[];};return Client.prototype.toJSON=function(){return{sys:xnm.aio.netatmo.DM.SYS,username:this.username,password:this.password,refreshToken:this.refreshToken};},Client.prototype.equalsTo=function(e){return!!(e&&e instanceof Client)&&(this.refreshToken?this.refreshToken===e.refreshToken:this.user==e.user&&this.password==e.password);},Client.prototype.executeCommandCreator=function(e,t,a){t&&t.value?"NATherm1"!=e.type?"home"!=e.type?"room"!=e.type?a&&a(new Error("device has no command")):this._setRoomTherm(e,t,function(e){a&&a(e);}):this._setHomeThermMode(e,t,function(e){a&&a(e);}):this._setSmartThermostat(e,t,function(e){a&&a(e);}):a&&a(new Error("command format invalid"));},Client.prototype.getStatesCreator=function(e,t,a){t?this.getAllStatus(function(e,r){for(var o=[],s=0;s<t.length;s++){var n=t[s];if(n.id){var i,u,m="?";if(!e&&r&&n.device&&n.device.type)(u="NAMain"==n.device.type||"NHC"==n.device.type||"NAPlug"==n.device.type||"room"==n.device.type||"home"==n.device.type?n.device.address:n.device.module)&&n.status&&n.status.value&&(i=r[u])&&(null!=(m=i[n.status.value])&&void 0!==m||(m="?"));o.push({id:n.id,status:m});}}a&&a(null,o);}):a&&a(new Error("deviceList is null"));},Client.prototype._setHomeThermMode=function(e,t,a){if(e&&e.address&&"home"==e.type){var r,o,s=this,n=e.address;switch(t.value){case"thermoAuto":r="schedule";break;case"thermoAway":r="away";break;case"thermoAwayUntil":if(!t.ext)return void a(new Error("invalid command"));r="away",o=parseInt(t.ext);break;case"thermoHg":r="hg";break;case"thermoHgUntil":if(!t.ext)return void a(new Error("invalid command"));r="hg",o=parseInt(t.ext);break;default:a(new Error("unknown command"));}this._setThermMode(n,r,o,null,function(e,t){e?a(e):(s._stateBuffer.thermoStatusChanged(),a());});}else a(new Error("invalid device"));},Client.prototype._setRoomTherm=function(e,t,a){if(e&&e.address&&e.homeId&&"room"==e.type){var r,o,s,n=this,i=e.homeId,u=e.address;switch(t.value){case"thermoAuto":r="home";break;case"thermoManu":if(!t.ext)return void a(new Error("invalid command"));r="manual",(o=parseFloat(t.ext))<7&&(o=7),o>30&&(o=30);break;case"thermoManuUntil":if(!t.ext)return void a(new Error("invalid command"));r="manual";for(var m=0;m<t.ext.length;m++){var d=t.ext[m];if(d)switch(d.value){case"temp":o=parseFloat(d.ext);break;case"endtime":s=parseInt(d.ext);}}if(!o||!s)return void a(new Error("invalid command"));o<7&&(o=7),o>30&&(o=30);break;case"thermoUp":case"thermoDown":return void this.getAllStatus(function(e,m){if(e)a(e);else{var d=m?m[u]:null;d?(s=d.tempEnd,o=parseFloat(d.manuT),isNaN(o)?a(new Error("unknown current room setpoint")):("thermoUp"==t.value?o+=.5:o-=.5,o<7&&(o=7),o>30&&(o=30),r="manual",n._setRoomThermPoint(i,u,r,o,s,function(e,t){e?a(e):(n._stateBuffer.thermoStatusChanged(),a());}))):a(new Error("unknown current room status"));}});default:a(new Error("unknown command"));}this._setRoomThermPoint(i,u,r,o,s,function(e,t){e?a(e):(n._stateBuffer.thermoStatusChanged(),a());});}else a(new Error("invalid device"));},Client.prototype._setSmartThermostat=function(e,t,a){var r=this,o=this._stateBuffer.getSmartThermoDuration(e);o||(o=60);var s={};switch(t.value){case"thermoAuto":s.setpoint_mode="program";break;case"thermoAway":s.setpoint_mode="away";break;case"thermoHg":s.setpoint_mode="hg";break;case"thermoOff":s.setpoint_mode="off";break;case"thermoMax":s.setpoint_mode="max",s.setpoint_endtime=Math.round((new Date().getTime()+6e4*o)/1e3);break;case"thermoManu":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command ext invalid")));var n=t.ext;"string"==typeof t.ext&&(n=parseFloat(t.ext)),n<5.5&&(n=5.5),n>30&&(n=30),s.setpoint_mode="manual",s.setpoint_endtime=Math.round((new Date().getTime()+6e4*o)/1e3),s.setpoint_temp=n;break;case"tempDuration":if(null==t.ext||void 0===t.ext)return void(a&&a(new Error("command ext invalid")));var i=t.ext;return"string"==typeof t.ext&&(i=parseFloat(t.ext)),i<15&&(i=15),i>720&&(i=720),this._stateBuffer.setSmartThermoDuration(e,i),void(a&&a());default:a&&a(new Error("unknow command"));}var u=e;u&&u.address&&u.module?s&&s.setpoint_mode&&("max"!=s.setpoint_mode||s.setpoint_endtime)&&("manual"!=s.setpoint_mode||s.setpoint_endtime&&s.setpoint_temp)?this._setThermPoint(u.address,u.module,s.setpoint_mode,s.setpoint_endtime,s.setpoint_temp,function(e,t){e?a&&a(e):(r._stateBuffer.thermoStatusChanged(),a&&a(null,t));}):a&&a(new Error("param format invalid")):a&&a(new Error("device format invalid"));},Client.prototype.auth=function(e){this._logger.log("debug","auth"),this.username&&this.password?this._auth(function(t,a){e&&e(t,a);}):this.refreshToken?this._refreshToken(function(t,a){e&&e(t,a);}):e&&e(new Error(""));},Client.prototype.getDeviceList=function(e){var t=this,a=[];this._getHomeCoachsData(null,function(r,o){r?t._logger.log("error","getHomeCoachsData error: "+r.message):o&&Array.isArray(o.devices)&&o.devices.forEach(function(e){var t=e.name||e.type;e.station_name&&(t+=" ("+e.station_name+")");var r={address:e._id,type:e.type,name:t,room:null,home:null,dashboard_data:e.dashboard_data};a.push(r);}),t._getHomesData(null,null,function(t,r){t?0===a.length?e&&e(t):e&&e(null,a):r&&r.length?(r.forEach(function(e){if(e&&e.modules&&e.modules.length){var t={};e.rooms&&e.rooms.forEach(function(e){t[e.id]={name:e.name,hasThermo:!1};});var r=!1;for(var o in e.modules.forEach(function(o){if(o&&o.id&&o.type){var s=null;switch(o.type){case"NAMain":s={address:o.id,type:o.type,name:o.name?o.name:null,room:null,home:e.name},o.room_id&&t[o.room_id]&&(s.room=t[o.room_id].name),a.push(s);break;case"NAModule1":case"NAModule2":case"NAModule3":case"NAModule4":s={module:o.id,address:o.bridge,type:o.type,name:o.name?o.name:null,room:null,home:e.name},o.room_id&&t[o.room_id]&&(s.room=t[o.room_id].name),a.push(s);break;case"NAPlug":r=!0,s={address:o.id,type:o.type,name:o.name?o.name:null,room:null,home:e.name},o.room_id&&t[o.room_id]&&(s.room=t[o.room_id].name,t[o.room_id].hasThermo=!0),a.push(s);break;case"NATherm1":case"NRV":r=!0,s={address:o.bridge,module:o.id,type:o.type,name:o.name?o.name:null,room:null,home:e.name},o.room_id&&t[o.room_id]&&(s.room=t[o.room_id].name,t[o.room_id].hasThermo=!0),a.push(s);break;case"NHC":s={address:o.id,type:o.type,name:o.name?o.name:e.name,room:null,home:e.name},o.room_id&&t[o.room_id]&&(s.room=t[o.room_id].name),a.push(s);}}}),t){var s=t[o];s.hasThermo&&a.push({address:o,type:"room",name:s.name,home:e.name,homeId:e.id});}r&&a.push({address:e.id,type:"home",name:e.name});}}),e&&e(null,a)):e&&e(null,a);});});},Client.prototype.getCamList=function(e){var t=this;this._getHomeData(null,null,function(a,r){if(a)e&&e(a);else{var o={cam:[]};if(r&&(o.cam=function(e){for(var t=[],a=0;a<e.length;a++){if(e[a]&&e[a].id){var r=e[a].name,o=e[a].cameras;if(o)for(var s=0;s<o.length;s++){if(o[s]&&o[s].id){var n="welcome";if("NACamera"==o[s].type?n="welcome":"NOC"==o[s].type&&(n="presence"),n){var i={sys:"cam",type:"system",manufacturer:"netatmo",model:n,address:o[s].id};o[s].name&&(i.name=o[s].name+(r?" ("+r+")":"")),t.push(i);}}}}}return t;}(r)),o.cam&&o.cam.length>0){for(var s=0;s<o.cam.length;s++){o.cam[s].refreshToken=t.refreshToken;}e&&e(null,o);}else e&&e(null,o);}});},Client.prototype.getCamUrl=function(e,t){var a=this;this._getHomeData(null,null,function(r,o){if(r)t&&t(r);else if(o){for(var s,n=0;n<o.length;n++){if(o[n]&&o[n].cameras){for(var i=o[n].cameras,u=0;u<i.length;u++){if(i[u]&&i[u].id==e&&i[u].vpn_url){s=i[u];break;}}if(s)break;}}s?1==s.is_local?a._getLocalCamUrl(s.vpn_url,function(e,a){t&&t(e,a);}):t&&t(null,s.vpn_url+"/live/index.m3u8"):t&&t("no cam with address:"+e);}else t&&t("get cams data reponse invalid");});},Client.prototype._getLocalCamUrl=function(e,t){var a=this;this._logger.log("trace","ping cam "+e),this._doUrlRequest("get",e+"/command/ping",null,function(r,o){!r&&o&&o.local_url?a._doUrlRequest("get",o.local_url+"/command/ping",null,function(a,r){!a&&r&&r.local_url==o.local_url?t&&t(null,r.local_url+"/live/index.m3u8"):t&&t(null,e+"/live/index.m3u8");}):t&&t(null,e+"/live/index.m3u8");});},Client.prototype.getAllStatus=function(e){var t=this,a=this._stateBuffer.areStatesExpired();a.weather||a.thermo||a.coach?this._getAllStatus(a,function(a){a?e&&e(a):e&&e(null,t._stateBuffer.getStates());}):e&&e(null,this._stateBuffer.getStates());},Client.prototype._getAllStatus=function(e,t){var a=this;this._getHomesInfo(function(r,o,s){r?t(r):(!("object"!=_typeof(s)||!s)?(e.weather=s.weather&&s.weather.length>0,e.thermo=s.thermo&&s.thermo.length>0,s.coach&&s.coach.length>0&&(e.coach=!0),e.thermo&&(e.home=s.home)):(e.weather=!1,e.thermo=!1),function(e,t){e&&e.weather?a._getWeatherStatus(t):t();}(e,function(r){r?t(r):function(e,t){e&&e.thermo?a._getThermoStatus(e.home,t):t();}(e,function(r){r?t(r):function(e,t){e&&e.coach?a._getHomeCoachStatus(t):t();}(e,function(e){t(e);});});}));});},Client.prototype._getHomesInfo=function(e){var t=this._getHomesInfoCBs.length;if(-1==this._getHomesInfoCBs.indexOf(e)&&this._getHomesInfoCBs.push(e),0==t){var a=this;this._stateBuffer.updateReqTime("homes",Math.round(new Date().getTime()/1e3)),this._getHomesData(null,null,function(e,t,r){a._stateBuffer.updateReqOK("homes",!e);var o=a._getHomesInfoCBs;if(a._getHomesInfoCBs=[],e&&o.forEach(function(t){try{t&&t(e);}catch(e){}}),!t||!t.length)return a._stateBuffer.updateHomesInfo({},{}),void o.forEach(function(e){try{e&&e(null,{});}catch(e){}});var s=[],n=[],i=[],u=[],m={};t.forEach(function(e){if(e&&e.modules&&e.modules.length){e.modules.forEach(function(t){if(t&&t.id&&t.type)switch(t.type){case"NAMain":case"NAModule1":case"NAModule2":case"NAModule3":case"NAModule4":n.push(t.id);break;case"NATherm1":case"NAPlug":case"NRV":-1==s.indexOf(e.id)&&s.push(e.id),i.push(t.id);break;case"NHC":u.push(t.id);}});var t=a._resolveHomeStatus(e);if(t)for(var r in t){m[r]=t[r];}}}),a._stateBuffer.updateHomesInfo(m,{weather:n,thermo:i,coach:u}),o.forEach(function(e){try{e&&e(null,m,{weather:n,thermo:i,coach:u,home:s});}catch(e){}});});}},Client.prototype._resolveHomeStatus=function(e){if(!e)return null;var t={};if(t.mode=e.therm_mode,t.tempEnd=e.therm_mode_endtime,t.tempEnd)if(t.tempEndStr=new Date(1e3*t.tempEnd).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{t.tempEndStr=dateFormat(t.tempEndStr,"dd mm yyyy, HH:MM:ss");}catch(e){}else t.tempEndStr=t.tempEndStr.toLocaleString();var a={};return a[e.id]=t,a;},Client.prototype._getWeatherStatus=function(e){var t=this._getWeatherStatusCBs.length;if(-1==this._getWeatherStatusCBs.indexOf(e)&&this._getWeatherStatusCBs.push(e),0==t){var a=this;this._stateBuffer.updateReqTime("weather",Math.round(new Date().getTime()/1e3)),this._getStationsData(null,!1,function(e,t,r){a._stateBuffer.updateReqOK("weather",!e);var o=a._getWeatherStatusCBs;if(a._getWeatherStatusCBs=[],e)o.forEach(function(t){try{t&&t(e,homes,r);}catch(e){}});else{var s=null,n={};t.devices&&t.devices.length&&t.devices.forEach(function(e){if(e&&"NAMain"==e.type){e.last_status_store&&(s=Math.max(e.last_status_store,s));var r=a._resolveWeatherStatus(e,t.user?t.user.administrative:null);if(r)for(var o in r){n[o]=r[o];}}}),s&&a._stateBuffer.updateWeatherStatus(n,s,r),o.forEach(function(e){try{e&&e(null,n);}catch(e){}});}});}},Client.prototype._resolveWeatherStatus=function(e,t){if(!e||"NAMain"!=e.type)return null;var a={};if(e._id){var r={};if(null!=e.wifi_status&&void 0!==e.wifi_status&&(r.wifi=e.wifi_status,r.wifi>=86?r.wifiStatus="bad":r.wifi>=71?r.wifiStatus="middle":r.wifi>=56?r.wifiStatus="good":r.wifiStatus="very_good"),e.dashboard_data){var o=this._resolveDashboard(e.dashboard_data);if(o)for(var s in o){o.hasOwnProperty(s)&&(r[s]=o[s]);}}r.tempFelt=null,void 0!==r.temp&&void 0!==r.hum&&t&&(r.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(r.temp,r.hum,t)),a[e._id]=r;}var n=this;return e.modules&&e.modules.forEach(function(e){var r=n._resolveModuleStatus(e,t);e&&e._id&&r&&(a[e._id]=r);}),a;},Client.prototype._resolveModuleStatus=function(e,t){var a,r,o={};if(null!=e.rf_status&&void 0!==e.rf_status&&(o.rf=e.rf_status,o.rf>=90?o.rfStatus="very_low":o.rf>=80?o.rfStatus="low":o.rf>=70?o.rfStatus="medium":o.rf>=60?o.rfStatus="high":o.rfStatus="full"),null!=e.battery_vp&&void 0!==e.battery_vp)switch(o.bat=e.battery_vp,e.type){case"NAModule4":o.bat>=5640?o.batStatus="full":o.bat>=5280?o.batStatus="high":o.bat>=4920?o.batStatus="medium":o.bat>=4560?o.batStatus="low":o.batStatus="very_low";break;case"NAModule1":case"NAModule3":o.bat>=5500?o.batStatus="full":o.bat>=5e3?o.batStatus="high":o.bat>=4500?o.batStatus="medium":o.bat>=4e3?o.batStatus="low":o.batStatus="very_low";break;case"NAModule2":o.bat>=5900?o.batStatus="full":o.bat>=5180?o.batStatus="high":o.bat>=4770?o.batStatus="medium":o.bat>=4360?o.batStatus="low":o.batStatus="very_low";break;case"NATherm1":o.bat>=4100?o.batStatus="full":o.bat>=3600?o.batStatus="high":o.bat>=3300?o.batStatus="medium":o.bat>=3e3?o.batStatus="low":o.batStatus="very_low";}if("NATherm1"==e.type&&(a=this._resolveThermoStat(e)))for(r in a){a.hasOwnProperty(r)&&(o[r]=a[r]);}if(e.dashboard_data){if(a=this._resolveDashboard(e.dashboard_data))for(r in a){a.hasOwnProperty(r)&&(o[r]=a[r]);}if(void 0!==o.winD&&null!=o.winD){var s=Number(o.winD);isNaN(s)||(s=s>23&&s<=68?"NO":s>68&&s<=113?"O":s>113&&s<=158?"SO":s>158&&s<=203?"S":s>203&&s<=248?"SW":s>248&&s<=293?"W":s>293&&s<=338?"NW":"N",o.winDName=s);}void 0!==o.temp&&void 0!==o.hum&&t&&(o.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(o.temp,o.hum,t));}return o;},Client.prototype._resolveDashboard=function(e){var t,_hasKey=function _hasKey(e,t){return null!=e[t]&&void 0!==e[t];},a={};if(_hasKey(e,"AbsolutePressure")&&(a.absPres=e.AbsolutePressure),_hasKey(e,"CO2")&&(a.co2=e.CO2),_hasKey(e,"Humidity")&&(a.hum=e.Humidity),_hasKey(e,"Noise")&&(a.noise=e.Noise),_hasKey(e,"Pressure")&&(a.pres=e.Pressure),_hasKey(e,"Rain")&&(a.rain=e.Rain),_hasKey(e,"sum_rain_1")&&(a.rain1h=e.sum_rain_1),_hasKey(e,"sum_rain_24")&&(a.rain24h=e.sum_rain_24),_hasKey(e,"Temperature")&&(a.temp=e.Temperature),_hasKey(e,"date_max_temp")&&(a.timeMaxTemp=e.date_max_temp,t=1e3*e.date_max_temp,a.timeMaxTempStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMaxTempStr=dateFormat(a.timeMaxTempStr,"dd mm yyyy, HH:MM:ss"):a.timeMaxTempStr=a.timeMaxTempStr.toLocaleString()),_hasKey(e,"date_min_temp")&&(a.timeMinTemp=e.date_min_temp,t=1e3*e.date_min_temp,a.timeMinTempStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMinTempStr=dateFormat(a.timeMinTempStr,"dd.mm.yyyy, HH:MM:ss"):a.timeMinTempStr=a.timeMinTempStr.toLocaleString()),_hasKey(e,"max_temp")&&(a.maxTemp=e.max_temp),_hasKey(e,"min_temp")&&(a.minTemp=e.min_temp),_hasKey(e,"WindAngle")&&(a.winD=e.WindAngle),_hasKey(e,"WindStrength")&&(a.winS=e.WindStrength),_hasKey(e,"GustAngle")&&(a.gwinD=e.GustAngle),_hasKey(e,"GustStrength")&&(a.gwinS=e.GustStrength),_hasKey(e,"time_utc")&&(a.mesureT=e.time_utc,t=1e3*e.time_utc,a.mesureTStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.mesureTStr=dateFormat(a.mesureTStr,"dd.mm.yyyy, HH:MM:ss"):a.mesureTStr=a.mesureTStr.toLocaleString()),_hasKey(e,"date_max_wind_str")&&(a.timeMaxWind=e.date_max_wind_str,t=1e3*e.date_max_wind_str,a.timeMaxWindStr=new Date(t),"undefined"!=typeof dateFormat&&dateFormat?a.timeMaxWindStr=dateFormat(a.timeMaxWindStr,"dd.mm.yyyy, HH:MM:ss"):a.timeMaxWindStr=a.timeMaxWindStr.toLocaleString()),_hasKey(e,"max_wind_angle")&&(a.maxWinD=e.max_wind_angle),_hasKey(e,"max_wind_str")&&(a.maxWinS=e.max_wind_str),_hasKey(e,"temp_trend")&&(a.tempTrend=e.temp_trend),_hasKey(e,"pressure_trend")&&(a.presTrend=e.pressure_trend),_hasKey(e,"health_idx"))switch(a.healthIdxLvl=e.health_idx,parseInt(a.healthIdx)){case 0:a.healthIdx="healthy";break;case 1:a.healthIdx="fine";break;case 2:a.healthIdx="fair";break;case 3:a.healthIdx="poor";break;case 4:a.healthIdx="unhealthy";}return a;},Client.prototype._getThermoStatus=function(e,t){if(e&&e.length){var a=this._getThermoStatusCBs.length;if(-1==this._getThermoStatusCBs.indexOf(t)&&this._getThermoStatusCBs.push(t),0==a){var r=this;this._stateBuffer.updateReqTime("thermo",Math.round(new Date().getTime()/1e3));var o=0,s={},cb=function cb(t,a){var n=r._getThermoStatusCBs;if(t)return r._stateBuffer.updateReqOK("thermo",!1),r._getThermoStatusCBs=[],void n.forEach(function(e){try{e&&e(t);}catch(e){}});a&&(a.modules&&a.modules.forEach(function(e){if(e&&e.id){var t=r._resolveThermoModuleStatus(e);t&&(s[e.id]=t);}}),a.rooms&&a.rooms.forEach(function(e){if(e&&e.id){var t=r._resolveThermoRoomStatus(e);t&&(s[e.id]=t);}})),++o<e.length?r._getHomeStatus(e[o],null,cb):(r._stateBuffer.updateReqOK("thermo",!0),r._stateBuffer.updateThermoStatus(s),r._getThermoStatusCBs=[],n.forEach(function(e){try{e&&e(null,s);}catch(e){}}));};this._getHomeStatus(e[o],null,cb);}}else t(null,null);},Client.prototype._resolveThermoModuleStatus=function(e){if(!e)return null;var _hasKey=function _hasKey(e,t){return null!=e[t]&&void 0!==e[t];},t={};return _hasKey(e,"rf_strength")&&(t.rf=e.rf_strength,t.rf>90?t.rfStatus="very_low":t.rf>80?t.rfStatus="low":t.rf>70?t.rfStatus="medium":t.rf>60?t.rfStatus="high":t.rfStatus="full"),_hasKey(e,"wifi_strength")&&(t.wifi=e.wifi_status,t.wifi>=86?t.wifiStatus="bad":t.wifi>=71?t.wifiStatus="middle":t.wifi>=56?t.wifiStatus="good":t.wifiStatus="very_good"),_hasKey(e,"battery_level")&&(t.bat=e.battery_level),_hasKey(e,"battery_state")&&(t.batStatus=e.battery_state),t;},Client.prototype._resolveThermoRoomStatus=function(e){if(!e)return null;var t={};if(t.mode=e.therm_setpoint_mode,t.manuT=e.therm_setpoint_temperature,t.tempEnd=e.therm_setpoint_end_time,t.tempEnd)if(t.tempEndStr=new Date(1e3*t.tempEnd).toLocaleString(),"undefined"!=typeof dateFormat&&dateFormat)try{t.tempEndStr=dateFormat(t.tempEndStr,"dd mm yyyy, HH:MM:ss");}catch(e){}else t.tempEndStr=t.tempEndStr.toLocaleString();return t.currentTemp=e.therm_measured_temperature,t;},Client.prototype._getHomeCoachStatus=function(e){var t=this._getCoachStatusCBs.length;if(-1==this._getCoachStatusCBs.indexOf(e)&&this._getCoachStatusCBs.push(e),0==t){var a=this;this._stateBuffer.updateReqTime("coach",Math.round(new Date().getTime()/1e3)),this._getHomeCoachsData(null,function(e,t,r){a._stateBuffer.updateReqOK("coach",!e);var o=a._getCoachStatusCBs;if(a._getCoachStatusCBs=[],e)o.forEach(function(a){try{a&&a(e,t,r);}catch(e){}});else{var s=null,n={};t.devices&&t.devices.length&&t.devices.forEach(function(e){if(e&&"NHC"==e.type){e.last_status_store&&(s=Math.max(e.last_status_store,s));var r=a._resolveCoachStatus(e,t.user?t.user.administrative:null);if(r)for(var o in r){n[o]=r[o];}}}),s&&a._stateBuffer.updateCoachStatus(n,s,r),o.forEach(function(e){try{e&&e(null,n);}catch(e){}});}});}},Client.prototype._resolveCoachStatus=function(e,t){var a={};if(a.wifi=e.wifi_status,a.wifi>=86?a.wifiStatus="bad":a.wifi>=71?a.wifiStatus="middle":a.wifi>=56?a.wifiStatus="good":a.wifiStatus="very_good",e.dashboard_data){var r=this._resolveDashboard(e.dashboard_data);if(r)for(var o in r){r.hasOwnProperty(o)&&(a[o]=r[o]);}}a.tempFelt=null,void 0!==a.temp&&void 0!==a.hum&&t&&(a.tempFelt=xnm.aio.netatmo.DM.calcFeltTemp(a.temp,a.hum,t));var s={};return s[e._id]=a,s;},Client.prototype._renewAccessToken=function(e){var t=this._renewTokenCBs.length;if(e&&-1==this._renewTokenCBs.indexOf(e)&&this._renewTokenCBs.push(e),0==t){var a=this,cb=function cb(e,t){var r=!1;!e&&t&&(t.access_token&&(a.accessToken=t.access_token,r=!0),t.refresh_token&&(a.refreshToken=t.refresh_token)),e||r||(e=new Error("invalid token response"));var o=a._renewTokenCBs;a._renewTokenCBs=[];for(var s=0;s<o.length;s++){try{o[s](e);}catch(e){}}};this.refreshToken?this._refreshToken(cb):this.username&&this.password?this._auth(cb):cb(new Error("no refresh token or username/password"));}},Client.prototype._auth=function(a){this._logger.log("trace","_auth");var r={grant_type:"password",client_id:e,client_secret:t,username:this.username,password:this.password,scope:this._scope.join(" ")},o=[];for(var s in r){o.push(s+"="+encodeURIComponent(r[s]));}var n=o.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},n,function(e,t,r){if(e)a(e);else if(t)try{var o=JSON.parse(t);if(200!=r)return e=new Error(o.error),void a(e);a(null,o);}catch(e){a(e);}else a(new Error("invalid response"));});},Client.prototype._refreshToken=function(a){this._logger.log("trace","_refreshToken");var r={grant_type:"refresh_token",client_id:e,client_secret:t,refresh_token:this.refreshToken},o=[];for(var s in r){o.push(s+"="+encodeURIComponent(r[s]));}var n=o.join("&");this._doRequest("POST","/oauth2/token",{"Content-Type":"application/x-www-form-urlencoded"},n,function(e,t,r){if(e)a(e);else if(t)try{var o=JSON.parse(t);if(200!=r)return e=new Error(o.error),void a(e);a(null,o);}catch(e){a(e);}else a(new Error("invalid response"));});},Client.prototype._getStationsData=function(e,t,a){this._logger.log("debug","_getStationsData");var r="/api/getstationsdata",o=[];e&&o.push("device_id="+e),t&&o.push("get_favorites="+get_favorites),o.length&&(r+="?"+o.join("&")),this._doAPIRequest("GET",r,null,function(e,t){e?a(e):t&&t.body?a(null,t.body,t.time_server):a(new Error("invalid get stations data response"));});},Client.prototype._getHomesData=function(e,t,a){this._logger.log("debug","_getHomesData");var r="/api/homesdata",o=[];e&&o.push("home_id="+e),t&&o.push("gateway_types="+t),o.length&&(r+="?"+o.join("&")),this._doAPIRequest("GET",r,null,function(e,t){e?a(e):t&&t.body&&t.body.homes?a(null,t.body.homes,t.time_server):a(new Error("invalid get homes data response"));});},Client.prototype._getHomeStatus=function(e,t,a){this._logger.log("debug","_getHomeStatus");var r="/api/homestatus",o=[];e&&o.push("home_id="+e),t&&t.length&&t.forEach(function(e){o.push("device_types="+e);}),o.length&&(r+="?"+o.join("&")),this._doAPIRequest("GET",r,null,function(e,t){e?a(e):t&&t.body&&t.body.home?a(null,t.body.home,t.time_server):a(new Error("invalid get home status response"));});},Client.prototype._getHomeCoachsData=function(e,t){this._logger.log("debug","_getHomeCoachsData");var a="/api/gethomecoachsdata",r=[];e&&r.push("device_id="+e),r.length&&(a+="?"+r.join("&")),this._doAPIRequest("GET",a,null,function(e,a){e?t(e):a&&a.body?t(null,a.body,a.time_server):t(new Error("invalid get stations data response"));});},Client.prototype._setThermPoint=function(e,t,a,r,o,s){var n="/api/setthermpoint",i=[];e&&i.push("device_id="+e),t&&i.push("module_id="+t),a&&i.push("setpoint_mode="+a),r&&i.push("setpoint_endtime="+r),o&&i.push("setpoint_temp="+o),i.length&&(n+="?"+i.join("&")),this._doAPIRequest("GET",n,null,s);},Client.prototype._setThermMode=function(e,t,a,r,o){this._logger.log("debug","_setThermMode");var s="/api/setthermmode",n=[];e&&n.push("home_id="+e),t&&n.push("mode="+t),a&&n.push("endtime="+a),r&&n.push("schedule_id="+r),n.length&&(s+="?"+n.join("&")),this._doAPIRequest("GET",s,null,function(e,t){o(e);});},Client.prototype._setRoomThermPoint=function(e,t,a,r,o,s){this._logger.log("debug","_setRoomThermPoint");var n="/api/setroomthermpoint",i=[];e&&i.push("home_id="+e),t&&i.push("room_id="+t),a&&i.push("mode="+a),r&&i.push("temp="+r),o&&i.push("endtime="+o),i.length&&(n+="?"+i.join("&")),this._doAPIRequest("GET",n,null,function(e,t){s(e);});},Client.prototype._getHomeData=function(e,t,a){this._logger.log("debug","_getHomeData");var r="/api/gethomedata",o=[];e&&o.push("home_id="+e),t&&o.push("size="+t),o.length&&(r+="?"+o.join("&")),this._doAPIRequest("GET",r,null,function(e,t){e?a(e):t&&t.body&&t.body.homes?a(null,t.body.homes,t.time_server):a(new Error("invalid get homes data response"));});},Client.prototype._doAPIRequest=function(e,t,a,r){var o=this;this.accessToken?this._doJsonRequest(e,t,a,function(s,n){!s||2!=s.code&&3!=s.code||401!=s.status&&403!=s.status?r(s,n):o._renewAccessToken(function(s){s?r(s):o._doJsonRequest(e,t,a,function(e,t){r(e,t);});});}):this._renewAccessToken(function(s){s?r(s):o._doJsonRequest(e,t,a,function(e,t){r(e,t);});});},Client.prototype._doJsonRequest=function(e,t,a,r){var o={Authorization:"Bearer "+this.accessToken},s=this;this._doRequest(e,t,o,a?JSON.stringify(a):null,function(e,t,a){if(e)r(e);else if(t)try{var o=JSON.parse(t);if(200!=a){s._logger.log("error","[_doJsonRequest] Status: "+a+". Error: "+t);var n=o.error&&o.error.message?o.error.message:"invalid error response",i=o.error&&o.error.code?o.error.code:0;return(e=new Error(n)).code=i,e.status=a,void r(e);}r(null,o);}catch(e){r(e);}else r(new Error("invalid response"));});},Client.prototype._doRequest=function(e,t,a,r,o){var s={host:"api.netatmo.net",port:443,path:t,method:e,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};if(a)for(var n in a){s.headers[n]=a[n];}var i=require("https"),u=JSON.parse(JSON.stringify(s));u.headers&&(u.headers.auth&&(u.headers.auth="*********"),u.headers.Authorization&&(u.headers.Authorization="*********")),u.auth&&(u.auth="********"),this._logger.log("trace","do request:"+JSON.stringify(u));var m=this,d=o,l=i.request(s,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){m._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),d&&(d(null,t,e.statusCode),d=null);});});if(l.on&&l.on("error",function(e){m._logger.log("trace","do request error:"+e.message),d&&(d(e),d=null);}),l.setTimeout&&l.setTimeout(1e4,function(){m._logger.log("trace","do request timeout"),l.abort(),d&&(d(new Error("timeout")),d=null);}),r){var h=r;h=h.replace(/(client_id|client_secret|username|password)=[a-zA-Z0-9%*!()._-]+/g,"$1=*****"),this._logger.log("trace","send body:"+h),l.write(r);}l.end();},Client.prototype._doUrlRequest=function(e,t,a,r){var o=this,s=r,n=null;try{(n=JSON.parse(JSON.stringify(a))).username&&(n.username="xxxxxx"),n.password&&(n.password="xxxxxx");}catch(e){n=a;}this._logger.log("trace","send "+e+" req to:"+t+" data:"+JSON.stringify(n)),$.ajax({url:t,type:e,timeout:1e4,dataType:"json",data:a,cache:!1,success:function success(e){o._logger.log("trace","http request success:"+JSON.stringify(e)),r&&r(null,e);},error:function error(e,t,a){var r="http request error:"+(e?e.status:"0")+"-"+t;o._logger.log("warn","http request error:"+r);var n=new Error(r);a&&(o._logger.log("warn","http request http error:"+a),n.httpError=!0,n.statusCode=e?e.status:0),s&&(s(n,e?e.responseText:null),s=null);}});},Client;}(),xnm.aio.netatmo.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="NetatmoDmError",DMError.prototype.code=0;var e=DMError,t=DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},a=[{type:"float",name:"absolute pressure",ref:{value:"absPres",value_t:"pressureAbsolute"}},{type:"int",name:"co2",ref:{value:"co2"}},{type:"int",name:"humidity",ref:{value:"hum"}},{type:"int",name:"noise",ref:{value:"noise"}},{type:"float",name:"pressure",ref:{value:"pres",value_t:"pressure"}},{type:"float",name:"rain",ref:{value:"rain"}},{type:"float",name:"rain last hour",ref:{value:"rain1h"}},{type:"float",name:"rain last 24 hours",ref:{value:"rain24h"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"time max temperatue",ref:{value:"timeMaxTemp"}},{type:"int",name:"time min temperatue",ref:{value:"timeMinTemp"}},{type:"float",name:"max temperatue",ref:{value:"maxTemp"}},{type:"float",name:"min temperatue",ref:{value:"minTemp"}},{type:"int",name:"wind direction",ref:{value:"winD"}},{type:"float",name:"wind speed",ref:{value:"winS"}},{type:"int",name:"gust wind direction",ref:{value:"gwinD"}},{type:"float",name:"gust wind speed",ref:{value:"gwinS"}},{type:"int",name:"last measure time",ref:{value:"mesureT",value_t:"lastMeasureTime"}},{type:"int",name:"time max wind",ref:{value:"timeMaxWind"}},{type:"int",name:"max wind direction",ref:{value:"maxWinD"}},{type:"float",name:"max wind speed",ref:{value:"maxWinS"}},{type:"float",name:"rf level",ref:{value:"rf"}},{type:"enum",name:"rf status",ref:{value:"rfStatus",options:["very_low","low","medium","high","full"]}},{type:"float",name:"battery level",ref:{value:"bat",value_t:"battery_level",extMeta:"3000-6000"}},{type:"enum",name:"battery status",ref:{value:"batStatus",value_t:"battery_state",options:["very_low","low","medium","high","full"]}},{type:"float",name:"wifi level",ref:{value:"wifi"}},{type:"enum",name:"wifi status",ref:{value:"wifiStatus",options:["bad","middle","good","very_good"]}},{type:"enum",name:"mode",ref:{value:"mode",options:["auto","away","frost-guard","manu","off","boost"]}},{type:"float",name:"manual temperature",ref:{value:"manuT",extMeta:"5.5-30",scale:"0.5"}},{type:"int",name:"manual/boost endtime",ref:{value:"tempEnd"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",extMeta:"15-720",scale:"15"}},{type:"string",name:"manual/boost endtime string",ref:{value:"tempEndStr"}},{type:"string",name:"time string max temperatue",ref:{value:"timeMaxTempStr"}},{type:"string",name:"time string min temperatue",ref:{value:"timeMinTempStr"}},{type:"string",name:"last measure time string",ref:{value:"mesureTStr",value_t:"lastMeasureTimeStr"}},{type:"string",name:"time string max wind",ref:{value:"timeMaxWindStr"}},{type:"float",name:"felt temperature",ref:{value:"tempFelt"}},{type:"string",name:"wind direction named",ref:{value:"winDName",options:["N","NO","O","SO","S","SW","W","NW"]}},{type:"enum",name:"temperature trend",ref:{value:"tempTrend",options:["up","down","stable"]}},{type:"enum",name:"pressure trend",ref:{value:"presTrend",value_t:"pressureTrend",options:["up","down","stable"]}},{type:"enum",name:"health index",ref:{value:"healthIdx",options:["healthy","fine","fair","poor","unhealthy"]}},{type:"int",name:"health index level",ref:{value:"healthIdxLvl",extMeta:"0-4"}}],r=[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"enum",name:"off",ref:{value:"thermoOff"}},{type:"enum",name:"max",ref:{value:"thermoMax"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"5.5-30",scale:"0.5"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"int",name:"manual/boost duration",ref:{value:"tempDuration",ext:"%d",extMeta:"15-720",scale:"15"}}],o={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"up",ref:{value:"thermoUp"}},{type:"enum",name:"down",ref:{value:"thermoDown"}},{type:"float",name:"manu",ref:{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"multi",name:"manu until",ref:{value:"thermoManuUntil",ext:"%multi",extMeta:[{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"7-30",scale:"0.5"}},{type:"time",name:"end time",ref:{value:"endtime",ext:"%time"}}]}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["manual","max","off","schedule","away","hg"]}},{type:"float",name:"setpoint temperature",ref:{value:"manuT",value_t:"setTemperature",extMeta:"7-30",scale:"0.5"}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}},{type:"float",name:"measured temperature",ref:{value:"currentTemp"}}]},s={command:[{type:"enum",name:"auto",ref:{value:"thermoAuto"}},{type:"enum",name:"away",ref:{value:"thermoAway"}},{type:"time",name:"away until",ref:{value:"thermoAwayUntil",ext:"%time"}},{type:"enum",name:"frost-guard",ref:{value:"thermoHg"}},{type:"time",name:"frost-guard until",ref:{value:"thermoHgUntil",ext:"%time"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["schedule","away","frost_guard"]}},{type:"int",name:"mode end time",ref:{value:"tempEnd"}},{type:"string",name:"mode end time string",ref:{value:"tempEndStr"}}]};return{SYS:"netatmo",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Netatmo (Online)",port:443}];},getGatewayDeviceType:function getGatewayDeviceType(e){return[{sys:this.SYS,type:"NAMain",name:"Base Station"},{sys:this.SYS,type:"NAModule1",name:"Outdoor module"},{sys:this.SYS,type:"NAModule4",name:"Additional indoor module"},{sys:this.SYS,type:"NAModule3",name:"Rain gauge module"},{sys:this.SYS,type:"NAModule2",name:"Wind gauge module"},{sys:this.SYS,type:"NATherm1",name:"Thermostat"},{sys:this.SYS,type:"NHC",name:"Home Coach"}];},_checkInfo:function _checkInfo(a,r,o){if(a){if(a.gateway){if(a.type){if(a.address){if(r.data&&r.data.gateways&&0!==r.data.gateways.length){var s,n,i=r.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===a.gateway){n=i[s];break;}}n?o():o(new e(t.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));}else o(new e(t.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));}else o(new e(t.INVALID,"address is invalid"));}else o(new e(t.INVALID,"type is invalid"));}else o(new e(t.INVALID,"gateway is invalid"));}else o(new e(t.INVALID,"info is invalid"));},createGateway:function createGateway(a,r,o){a?a.refreshToken||a.username&&a.password?o(null,a):o(new e(t.INVALID,"refreshToken is invalid")):o(new e(t.INVALID,"info is invalid"));},updateGateway:function updateGateway(a,r,o,s){r?r.refreshToken||r.username&&r.password?s(null,r):s(new e(t.INVALID,"refreshToken is invalid")):s(new e(t.INVALID,"info is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){this._checkInfo(e,t,function(t){a(t,e);});},updateDevice:function updateDevice(e,t,a){this._checkInfo(e,t,function(t){a(t,e);});},deleteDevice:function deleteDevice(e,t,a){a(null,e);},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,r=0;r<e.length;r++){if(e[r]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var a=[],r=null,o=this.getCommandStatusMap(e);return o&&(r=function(e,t,a){var r=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(o,0,t),a=a.concat(r)),a;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter.call(this,e,t),a.command=r;break;case"status":r=_filter.call(this,e,t),a.status=r;break;default:return null;}return r&&0!=r.length?a:null;},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),r=this.getIPevtMap(e);return r?(a.ipevt=r.ipevt,a):a;},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[],status:[]};switch(e.type){case"NAMain":case"NHC":t.status.push(a[25]),t.status.push(a[26]);break;case"NAModule1":case"NAModule2":case"NAModule3":case"NAModule4":case"NATherm1":t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]),"NATherm1"==e.type&&(t.status.push(a[27]),t.status.push(a[28]),t.status.push(a[29]),t.status.push(a[30]),t.status.push(a[31]),t.status.push(a[32]));}if("NATherm1"==e.type&&(t.command=r),e.dashboard_data)for(var o in e.dashboard_data){if(e.dashboard_data.hasOwnProperty(o))switch(o){case"AbsolutePressure":t.status.push(a[0]);break;case"CO2":t.status.push(a[1]);break;case"Humidity":t.status.push(a[2]),t.status.push(a[37]);break;case"Noise":t.status.push(a[3]);break;case"Pressure":t.status.push(a[4]);break;case"Rain":t.status.push(a[5]);break;case"sum_rain_1":t.status.push(a[6]);break;case"sum_rain_24":t.status.push(a[7]);break;case"Temperature":t.status.push(a[8]);break;case"date_max_temp":t.status.push(a[9]),t.status.push(a[33]);break;case"date_min_temp":t.status.push(a[10]),t.status.push(a[34]);break;case"max_temp":t.status.push(a[11]);break;case"min_temp":t.status.push(a[12]);break;case"WindAngle":t.status.push(a[13]),t.status.push(a[38]);break;case"WindStrength":t.status.push(a[14]);break;case"GustAngle":t.status.push(a[15]);break;case"GustStrength":t.status.push(a[16]);break;case"time_utc":t.status.push(a[17]),t.status.push(a[35]);break;case"date_max_wind_str":t.status.push(a[18]),t.status.push(a[36]);break;case"max_wind_angle":t.status.push(a[19]);break;case"max_wind_str":t.status.push(a[20]);break;case"temp_trend":t.status.push(a[39]);break;case"pressure_trend":t.status.push(a[40]);break;case"health_idx":t.status.push(a[41]),t.status.push(a[42]);}}return t;},getCommandStatusMap2:function getCommandStatusMap2(e){var t={command:[],status:[]},r=null;switch(e.type){case"NAMain":r=["time_utc","Temperature","CO2","Humidity","Noise","Pressure","AbsolutePressure","min_temp","max_temp","date_min_temp","date_max_temp","temp_trend","pressure_trend"],t.status.push(a[25]),t.status.push(a[26]);break;case"NAModule1":r=["time_utc","Temperature","Humidity","min_temp","max_temp","date_min_temp","date_max_temp","temp_trend"],t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]);break;case"NAModule2":r=["time_utc","WindStrength","WindAngle","GustStrength","GustAngle","max_wind_str","max_wind_angle","date_max_wind_str"],t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]);break;case"NAModule3":r=["time_utc","Rain","sum_rain_24","sum_rain_1"],t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]);break;case"NAModule4":r=["time_utc","Temperature","CO2","Humidity","Pressure","AbsolutePressure","min_temp","max_temp","date_min_temp","date_max_temp","temp_trend"],t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]);break;case"NATherm1":case"NRV":t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[23]),t.status.push(a[24]);break;case"NAPlug":t.status.push(a[21]),t.status.push(a[22]),t.status.push(a[25]),t.status.push(a[26]);break;case"NHC":r=["time_utc","Temperature","CO2","Humidity","Noise","Pressure","AbsolutePressure","health_idx","min_temp","max_temp","date_min_temp","date_max_temp"],t.status.push(a[25]),t.status.push(a[26]);break;case"room":t=o;break;case"home":t=s;}return r&&r.forEach(function(e){switch(e){case"AbsolutePressure":t.status.push(a[0]);break;case"CO2":t.status.push(a[1]);break;case"Humidity":t.status.push(a[2]),t.status.push(a[37]);break;case"Noise":t.status.push(a[3]);break;case"Pressure":t.status.push(a[4]);break;case"Rain":t.status.push(a[5]);break;case"sum_rain_1":t.status.push(a[6]);break;case"sum_rain_24":t.status.push(a[7]);break;case"Temperature":t.status.push(a[8]);break;case"date_max_temp":t.status.push(a[9]),t.status.push(a[33]);break;case"date_min_temp":t.status.push(a[10]),t.status.push(a[34]);break;case"max_temp":t.status.push(a[11]);break;case"min_temp":t.status.push(a[12]);break;case"WindAngle":t.status.push(a[13]),t.status.push(a[38]);break;case"WindStrength":t.status.push(a[14]);break;case"GustAngle":t.status.push(a[15]);break;case"GustStrength":t.status.push(a[16]);break;case"time_utc":t.status.push(a[17]),t.status.push(a[35]);break;case"date_max_wind_str":t.status.push(a[18]),t.status.push(a[36]);break;case"max_wind_angle":t.status.push(a[19]);break;case"max_wind_str":t.status.push(a[20]);break;case"temp_trend":t.status.push(a[39]);break;case"pressure_trend":t.status.push(a[40]);break;case"health_idx":t.status.push(a[41]),t.status.push(a[42]);}}),t;},getIPevtMap:function getIPevtMap(e){var t=this.getCommandStatusMap(e);return t?{ipevt:t.status}:null;},calcFeltTemp:function calcFeltTemp(e,t,a){var r=0,o=0;if(a&&"object"==_typeof(a)&&0===a.feel_like_algo){o=243.5;var s=Math.log(.01*t)+17.67*e/(o+e),n=o*s/(17.67-s),i=5417.753*(1/273.16-1/(n+=273.15));r=e+.5555*(6.11*Math.exp(i)-10);}else{var u=9*e/5+32,m=u*u,d=t*t;r=5*((r=(o=[-42.379,2.04901523,10.14333127,-.22475541,-.00683783,-.05481717,.00122874,85282e-8,-199e-8])[0]+o[1]*u+o[2]*t+o[3]*u*t+o[4]*m+o[5]*d+o[6]*m*t+o[7]*u*d+o[8]*m*d)-32)/9;}return Math.round(10*r)/10;},supportSmartWidget:function supportSmartWidget(e){if(!e||!e.type)return!1;return["home","room"].indexOf(e.type)>=0;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,r,o){if(!t||!t.type)return!1;var s=null,n=null,i=[];if("home"===t.type)s={"%auto%":{value:"thermoAuto"},"%away%":{value:"thermoAway"},"%awayUntil%":{value:"thermoAwayUntil",ext:"%time"},"%frostGuard%":{value:"thermoHg"},"%frostGuardUntil%":{value:"thermoHgUntil",ext:"%time"}},n={"%mode%":{value:"mode",options:["schedule","away","frost_guard"]}},i.push("netatmo_thermo");else{if("room"!==t.type)return!1;s={"%auto%":{value:"thermoAuto"},"%thermoUp%":{value:"thermoUp"},"%thermoDown%":{value:"thermoDown"},"%thermoManu%":{value:"thermoManu",ext:"%f",extMeta:"7-30",scale:.5}},n={"%mode%":{value:"mode",options:["manual","max","off","schedule","away","hg"]},"%setTemp%":{value:"manuT",extMeta:"7-30",scale:.5},"%currentTemp%":{value:"currentTemp"}},i.push("netatmo_thermo");}return e._injectToSmartWidgetTemplate(r,i,o,s,n);}};}(),xnm.aio.netatmo.DM.getCommandStatusMap=xnm.aio.netatmo.DM.getCommandStatusMap2,xnm.aio.netatmo.Cloud=xnm.aio.netatmo.Client,xnm.aio.netatmo.Handler=function(){var Handler=function Handler(){this._updateListener=[];};return Handler.prototype.Client=xnm.aio.netatmo.Client,Handler.prototype.Cloud=xnm.aio.netatmo.Cloud,Handler.prototype.MNetatmo=xnm.aio.netatmo.MNetatmo,Handler.prototype.devicemanager=xnm.aio.netatmo.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"netatmo");},Handler.prototype.resolveGateway=function(e){return e.refreshToken||e.username&&e.password?new xnm.aio.netatmo.Cloud(e.username,e.password,e.refreshToken):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.netatmo.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=a?a.command:[];t&&t(null,r);},Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.netatmo.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),r=a?a.status:[];t&&t(null,r);},Handler.prototype.login=function(e,t){var a=this.resolveGateway(e);a?a.auth(function(e,a){e?t&&t(e):t&&t(e,{refreshToken:a.refresh_token});}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.doCommand=function(e,t,a,r){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,a,function(e){r&&r(e);}):r&&r(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,r,o){var s=this.resolveGateway(t);if(s){var n=[{id:e,device:a,status:r}];s.getStatesCreator(null,n,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDeviceList(t):t&&t(new Error("gateway json format invalid"));},Handler.prototype.getCamList=function(e,t){var a=this.resolveGateway(e);a?a.getCamList(t):t&&t(new Error("gateway json format invalid"));},Handler.prototype.pause=function(e){xnm.aio.netatmo.Cloud.pause(e);},Handler.prototype.addUpdateListener=function(e){e&&-1==this._updateListener.indexOf(e)&&this._updateListener.push(e);},Handler.prototype.getDevice=function(e){return new this.MNetatmo(e);},Handler.prototype.setMNetatmoCloudUrl=function(e){this.MNetatmo.CLOUD_URL=e;},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.netatmo.Handler());