var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.fgsm14=xnm.aio.fgsm14||{},xnm.aio.fgsm14.Gateway=function(){var Gateway=function Gateway(e,t){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.sample.Gateway"),this.ip=e,this.port=t,this.port||(this.port=80),this.CommandHandler=null;};return Gateway.prototype._doRequest=function(e,t,n,a,i){var o={host:this.ip,port:this.port,path:t,method:e,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(n)for(var r in n){n.hasOwnProperty(r)&&(o.headers[r]=n[r]);}a&&(o.headers["Content-Length"]=a.length),this._logger.log("trace","do request:"+JSON.stringify(o));var s=require("https"),u=this,l=i,m=s.request(o,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){u._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),l&&(l(null,t,e),l=null);});});m.on&&m.on("error",function(e){u._logger.log("trace","do request error:"+e.message),l&&(l(e),l=null);}),m.setTimeout&&m.setTimeout(2e3,function(){u._logger.log("trace","do request timeout"),m.abort(),l&&(l(new Error("timeout")),l=null);}),a&&(this._logger.log("trace","do request send body:"+a),m.write(a)),m.end();},Gateway.prototype.getDevices=function(e){e(null,[{sys:"fgsm14",type:"swtich",address:1},{sys:"fgsm14",type:"dimmer",address:2}]);},Gateway.prototype.executeCommandCreator=function(e,t,n){n(e?t?null:new Error("invalid command json"):new Error("invalid device json"));},Gateway.prototype.getStatesCreator=function(e,t,n){if(t){for(var a=[],i=0;i<t.length;i++){var o=t[i];o&&"switch"==o.device.type&&o.id&&o.status&&"state"==o.status.value?a.push({id:o.id,status:"on"}):o&&"dimmer"==o.device.type&&o.id&&o.status&&"level"==o.status.value&&a.push({id:o.id,level:70});}n(null,a);}else n(new Error("invalid device list"));},Gateway.prototype.toJSON=function(){return{sys:"sample",ip:this.ip,port:this.port};},Gateway.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.sample.Gateway&&this.ip==e.ip;},Gateway.parseJSON=function(e){return e.ip?new Gateway(e.ip,e.port):null;},Gateway;}(),xnm.aio.fgsm14.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="FGSM14DMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"dim up",ref:{value:"dimUp"}},{type:"enum",name:"dim down",ref:{value:"dimDown"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"state",ref:{value:"state",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"move up",ref:{value:"moveUp"}},{type:"enum",name:"move down",ref:{value:"moveDown"}},{type:"enum",name:"stop",ref:{value:"stop"}}]}};return{SYS:"fgsm14",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Sample",subtypes:[{id:"Switch",type:"switch"},{id:"Dimmer",type:"dimmer"},{id:"Blind",type:"blind"}]}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"switch",name:"Switch"},{sys:this.SYS,type:"dimmer",name:"Dimmer"},{sys:this.SYS,type:"blind",name:"Blind"}];},createGateway:function createGateway(e,t,n){var a=DMError,i=DMError.ERROR_CODE;e?e.ip?e.port?e.type?n(null,e):n(new a(i.INVALID,"type is invalid")):n(new a(i.INVALID,"port is invalid")):n(new a(i.INVALID,"ip is invalid")):n(new a(i.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,a){var i=DMError,o=DMError.ERROR_CODE;t?t.ip?t.port?t.type?a(null,t):a(new i(o.INVALID,"type is invalid")):a(new i(o.INVALID,"port is invalid")):a(new i(o.INVALID,"ip is invalid")):a(new i(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var a=DMError,i=DMError.ERROR_CODE;if(e){if(e.address){if(e.type){if(e.gateway){var o,r,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){r=s[o];break;}}r?n&&n(null,e):n(new a(i.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(i.INVALID,"gateway is invalid"));}else n(new a(i.INVALID,"type is invalid"));}else n(new a(i.INVALID,"address is invalid"));}else n(new a(i.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var a=DMError,i=DMError.ERROR_CODE;if(e){if(e.address){if(e.type){if(e.gateway){var o,r,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){r=s[o];break;}}r?n(null,e):n(new a(i.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(i.INVALID,"gateway is invalid"));}else n(new a(i.INVALID,"type is invalid"));}else n(new a(i.INVALID,"address is invalid"));}else n(new a(i.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _contains=function _contains(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++){if(e[a]==t){n=!0;break;}}return n;},_filter=function _filter(e,t){var a=[],i=null,o=xnm.aio.feller.DM.getCommandStatusMap(e,n);return o&&(i=function(e,t,n){var a=[];return"command"==n.catagory?e.command&&e.command.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}}):"status"==n.catagory&&e.status&&e.status.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}}),a;}(o,0,t),a=a.concat(i)),a;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),i=null;if("command"==t.catagory)i=_filter(e,t),a.command=i;else{if("status"!=t.catagory)return null;i=_filter(e,t),a.status=i;}return i&&0!=i.length?a:null;},getCommandStatusMap:function getCommandStatusMap(t){return t.type?e[t.type]:null;}};}(),xnm.aio.fgsm14.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.fgsm14.DM,Handler.prototype.Gateway=xnm.aio.fgsm14.Gateway,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"fgsm14");},Handler.prototype.resolveGateway=function(e){return e?this.Gateway.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},Handler.prototype.doCommand=function(e,t,n,a){var i=this.resolveGateway(e);i?i.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,n,a,i){var o=this.resolveGateway(t);if(o){var r=[{id:e,device:n,status:a}];o.getStatesCreator(null,r,function(e,t){e?i&&i(e):i&&i(null,t[0]);});}else i&&i(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(t):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fgsm14.Handler());