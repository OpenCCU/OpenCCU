var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.webhook=xnm.aio.webhook||{},xnm.aio.webhook.SERVER="wss://mediola-samsung.eu-central-1.elasticbeanstalk.com/notification",xnm.aio.webhook.Hook=function(){var Hook=function Hook(o){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.webhook.Hook"),this._serverURL=o,this._subscriptions=[],this._handlers={},this._running=!1,this._reConnectTO=null,this._wssocket=null,this._connectionTO=null;};return Hook.prototype.start=function(o){this._running&&o&&o(),this._running=!0;var n=this;this._connect(function(o){o?n._reconnect():n._regist();}),o&&o();},Hook.prototype.stop=function(o){this._running||o&&o(),this._running=!1,this._reConnectTO&&clearTimeout(this._reConnectTO),this._connectionTO&&clearTimeout(this._connectionTO),this._wssocket&&(this._wssocket.close(),this._wssocket=null);},Hook.prototype.addHandler=function(o,n){o&&n&&(this._handlers[o]=n);},Hook.prototype.subscribe=function(o,n,t){if(n){var e=this._handlers[o];if(e){if(e.isUniqueSubscribe){for(var s=[],i=0;i<n.length;i++){var r=n[i];e.isUniqueSubscribe(r,this._subscriptions)&&(s.push(r),this._subscriptions.push(r));}this._logger.log("trace","hook subscribe"+JSON.stringify(s)),this._wssocket?(this._wssocket.sendJSON({subscriptions:s}),t&&t()):t&&t();}else t&&t(new Error("no handler has (isUniqueSubscribe) "));}else t&&t(new Error("no handler for this type"));}else t&&t(new Error("subscribtions is null"));},Hook.prototype.unsubscribeAll=function(o){if(this._wssocket){var n=this._subscriptions;this._subscriptions=[],this._wssocket.sendJSON({unsubscriptions:n}),o&&o();}else o&&o();},Hook.prototype.unsubscribeType=function(o,n){if(this._wssocket){for(var t=[],e=[],s=0;s<this._subscriptions.length;s++){this._subscriptions[s]&&this._subscriptions[s].type==o?t.push(this._subscriptions[s]):e.push(this._subscriptions[s]);}this._subscriptions=e,this._wssocket.sendJSON({unsubscriptions:t}),n&&n();}else n&&n();},Hook.prototype._regist=function(o){this._wssocket?(this._wssocket.sendJSON({subscriptions:this._subscriptions}),o&&o()):o&&o(new Error("websocket not started"));},Hook.prototype._connect=function(o){if(this._wssocket)o&&o();else{var n=o,t=require("websocket").createWebSocket(this._serverURL),e=this;t.onclose=function(){e._logger.log("trace","hook closed"),e._wssocket=null,e._reconnect();},t.onerror=function(o){e._logger.log("trace","hook error:"+o),e._wssocket&&e._wssocket.close(),e._wssocket=null,n&&(n(new Error("hook connection error:"+o)),n=null);},t.onopen=function(){e._logger.log("trace","hook connected"),e._connectionTO&&(clearTimeout(e._connectionTO),e._connectionTO=null),e._wssocket=t,n&&(n(),n=null);},t.onmessage=function(o){e._logger.log("trace","hook receive message:"),e._logger.log("trace",o),e._onMessage(o);},this._connectionTO||(this._connectionTO=setTimeout(function(){t.close(),e._connectionTO=null,e._wssocket=null,n&&(n(new Error("hook connection timeout")),n=null);},2e3)),t.open();}},Hook.prototype._reconnect=function(){if(this._running&&!this._reConnectTO){this._logger.log("trace","try to reconnect hook");var o=this;this._reConnectTO=setTimeout(function(){o._running&&(o._logger.log("trace","reconnect hook"),o._connect(function(n){o._reConnectTO&&(clearTimeout(o._reConnectTO),o._reConnectTO=null),n?o._reconnect():o._regist();}));},5e3);}},Hook.prototype._onMessage=function(o){try{if((o=JSON.parse(o)).constructor===Array)for(var n=0;n<o.length;n++){var t=o[n];this._onEvent(t);}else this._onEvent(o);}catch(o){}},Hook.prototype._onEvent=function(o){try{if(o.type&&o.event){var n=this._handlers[o.type];n&&n.onNotification&&n.onNotification(o.event);}}catch(o){}},Hook;}(),xnm.aio.webhook.Handler=function(){var Handler=function Handler(){this._hook=new xnm.aio.webhook.Hook(xnm.aio.webhook.SERVER);};return Handler.prototype.start=function(o){this._hook.start(o);},Handler.prototype.addHandler=function(o,n){this._hook.addHandler(o,n);},Handler.prototype.subscribe=function(o,n,t){this._hook.subscribe(o,n,t);},Handler.prototype.unsubscribeAll=function(o){this._hook.unsubscribeAll(o);},Handler.prototype.unsubscribeType=function(o,n){this._hook.unsubscribeType(o,n);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.webhook.Handler());