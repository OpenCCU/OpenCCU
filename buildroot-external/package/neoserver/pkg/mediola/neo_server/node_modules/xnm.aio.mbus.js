var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.mbus=xnm.aio.mbus||{},xnm.aio.mbus.TYPE_REQ=1,xnm.aio.mbus.TYPE_RES=2,xnm.aio.mbus.TYPE_STA=3,xnm.aio.mbus.TYPE_TST=4,xnm.aio.mbus.MediolaBus=function(e){this._port=e,this._serialPort=null,this._checkInterval=1e3,this._timeout=200,this._maxRetries=1,this._timeoutTimer=null,this._sending=!1,this._retries=0,this._messages=[],this._onError=null,this._onData=null,this._state=0;},xnm.aio.mbus.MediolaBus.prototype.open=function(){this._state||(this._state=1,this._checkPort());},xnm.aio.mbus.MediolaBus.prototype.close=function(){this._state&&(this._state=0,this._serialPort&&(this._serialPort.close(),this._serialPort=null));},xnm.aio.mbus.MediolaBus.prototype.on=function(e,t){"error"==e?this._onError=t:"data"==e&&(this._onData=t);},xnm.aio.mbus.MediolaBus.prototype._checkPort=function(){if(this._state){var e=this._checkInterval,t=this;if(null!=this._serialPort){var s=!0;try{this._serialPort.drain();}catch(e){s=!1;}if(!s){try{t._serialPort.close();}catch(e){}t._serialPort=null,e*=2,t._connect();}}else e*=2,this._connect();setTimeout(function(){t._checkPort();},e);}},xnm.aio.mbus.MediolaBus.prototype._onTimeout=function(){this._sending=!1,this._retries<this._maxRetries?this._retries+=1:(this._messages.shift(),this._retries=0),this._sendNextMessage();},xnm.aio.mbus.MediolaBus.prototype._resetSendingState=function(){this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null),this._sending=!1,this._retries=0;},xnm.aio.mbus.MediolaBus.prototype._sendNextMessage=function(){if(null!=this._serialPort&&!this._sending&&this._messages.length>0){var e=this._messages[0],t=new(require("xnm.aio.m10T.js").STMUSBSerial)().generateCommandMessage(e,113),s=new Buffer.from(t);this._sending=!0,this._serialPort.write(s),this._serialPort.drain();var a=this;this._timeoutTimer=setTimeout(function(){a._onTimeout();},this._timeout);}},xnm.aio.mbus.MediolaBus.prototype._sendMessage=function(e,t,s){var a=[];a[0]=e>>8,a[1]=255&e,a[2]=1,a[3]=1,a[4]=t,a[5]=s.length>>8,a[6]=255&s.length,a[7]=0,a[8]=0;for(var i=0;i<s.length;i++){a[9+i]=s[i];}var r=this._computeCRC(s);a[7]=r>>8,a[8]=255&r,this._messages.push(a),this._sendNextMessage();},xnm.aio.mbus.MediolaBus.prototype._computeCRC=function(e){for(var t=0,s=0;s<e.length;s++){t^=e[s]<<8;for(var a=0;a<8;a++){32768&t?t=t<<1^4129:t<<=1,t&=65535;}}return t;},xnm.aio.mbus.MediolaBus.prototype._connect=function(e){var t=this;t._resetSendingState(),t._messages=[],t._sending=!0;var s=Buffer.from([]),a=null,i=!1,r=!1,n=require("serialport");n.SerialPort?this._serialPort=new n.SerialPort(this._port,{baudrate:115200}):this._serialPort=new n(this._port,{baudRate:115200}),this._serialPort.on("open",function(){XC.debugf("opened port: "+t._port),e&&(e(!0),e=null),t._sending=!1,t._sendNextMessage();}),this._serialPort.on("error",function(s){if(XC.debugf("port error: "+s.message),null!=t._serialPort){try{t._serialPort.close();}catch(e){}t._serialPort=null;}e&&(e(!1),e=null);}),this._serialPort.on("close",function(e){t._serialPort=null;}),this._serialPort.on("data",function(e){s=Buffer.concat([s,e]),r=!1,a=null,i=!1;for(var n=0;n<s.length;n++){var o=s[n];if(27==o||4==o||31==o?r?(a&&a.push(o),r=!1):27==o?r=!0:4==o?(i=!0,s=s.slice(n+1)):31==o&&(a=[],r=!1):(a&&a.push(o),r=!1),a&&i)if(1==a[0]);else if(0==a[0]);else if(113==a[0]){a.shift(),a.pop();var u=Buffer.from(a);if(u.length>9&&u.length==(u[5]<<8)+u[6]+9&&(u[4]==xnm.aio.mbus.TYPE_RES&&t._messages.length>0&&t._messages[0][0]==u[2]&&t._messages[0][1]==u[3]&&(t._resetSendingState(),t._messages.shift(),setTimeout(function(){t._sendNextMessage();},10)),t._onData)){var l=[];for(n=9;n<(u[5]<<8)+u[6]+9;n++){l.push(u[n]);}var m={source:u[2]+"."+u[3],type:u[4],data:l};t._onData(m);}}}});},xnm.aio.mbus.MediolaBus.prototype._getAddressFromString=function(e){var t=null,s=e.split(".");2==s.length&&(t=((255&parseInt(s[0]))<<8)+(255&parseInt(s[1])));return t;},xnm.aio.mbus.MediolaBus.prototype._getBitmaskFromString=function(e){for(var t=0,s=0;s<e.length;s++){"1"==e[s]&&(t+=128>>s);}return t;},xnm.aio.mbus.MediolaBus.prototype._getBitmaskFromID=function(e){var t=0,s=parseInt(e);if(s<1||s>26)return t;switch(s){case 1:t=65536;break;case 2:t=1<<17;break;case 3:t=1<<18;break;case 4:t=1<<19;break;case 5:t=1<<20;break;case 6:t=1<<24;break;case 7:t=1<<25;break;case 8:t=1<<26;break;case 9:t=1<<27;break;case 10:t=1<<28;break;case 11:t=1<<29;break;case 12:t=1<<30;break;case 13:t=1<<31;break;case 14:t=32768;break;case 15:t=16384;break;case 16:t=8192;break;case 17:t=4096;break;case 18:t=2048;break;case 19:t=1024;break;case 20:t=512;break;case 21:t=256;break;case 22:t=128;break;case 23:t=8;break;case 24:t=16;break;case 25:t=32;break;case 26:t=64;}return t;},xnm.aio.mbus.MediolaBus.prototype.updateStates=function(e){for(var t in e){var s=this._getAddressFromString(e[t]);null!=s&&this._sendMessage(s,1,[5]);}},xnm.aio.mbus.MediolaBus.prototype.evalState=function(e,t){var s=null;if(null!=e&&null!=t&&(t.type==xnm.aio.mbus.TYPE_RES||t.type==xnm.aio.mbus.TYPE_STA))if("srswitch"==e.type.toLowerCase()){var a=null;if(t.type==xnm.aio.mbus.TYPE_STA&&1==t.data.length?a=t.data[0]:t.type==xnm.aio.mbus.TYPE_RES&&2==t.data.length&&(a=t.data[1]),null!=a)s=a&(r=this._getBitmaskFromString(e.data))?"on":"off";}else if("feedback"==e.type.toLowerCase()){var i=null;if(t.type==xnm.aio.mbus.TYPE_STA&&4==t.data.length?i=t.data:t.type==xnm.aio.mbus.TYPE_RES&&5==t.data.length&&(i=t.data.slice(1)),null!=i){var r,n=(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+i[3];0!=(r=this._getBitmaskFromID(e.data))&&(s=n&r?"on":"off");}}else if("n26shutter"==e.type.toLowerCase()||"n26shuttergroup"==e.type.toLowerCase()){i=null;if(t.type==xnm.aio.mbus.TYPE_STA&&17==t.data.length?i=t.data:t.type==xnm.aio.mbus.TYPE_RES&&18==t.data.length&&(i=t.data.slice(1)),null!=i){for(var o=null,u=!0,l=e.data.split(";"),m=0;m<l.length;m++){var h=l[m].split(".");if(2==h.length){var _=parseInt(h[0]),p=parseInt(h[1]);if(_>0&&_<18&&p>0&&p<5){var c=i[_-1];if(c>>=2*(p-1),c&=3,u)o=c,u=!1;else if(c!=o){o=0;break;}}}}null!=o&&(1==o?s="up":2==o?s="down":3==o?s="angle":0==o&&(s="undefined"));}}return s;},xnm.aio.mbus.MediolaBus.prototype.executeCommand=function(e,t){if(null!=e){var s=this._getAddressFromString(e.address);if(null!=s)if("srswitch"==e.type.toLowerCase()){var a=this._getBitmaskFromString(e.data),i=null;"on"==t?i=[1,a]:"off"==t?i=[2,a]:"toggle"==t&&(i=[3,a]),null!=i&&this._sendMessage(s,1,i);}else if("n26shutter"==e.type.toLowerCase()||"n26shuttergroup"==e.type.toLowerCase()){var r=0;"up"==t?r=1:"down"==t?r=2:"angle"==t?r=3:"stop"==t&&(r=4);for(var n=e.data.split(";"),o=0;o<n.length;o++){i=[r];var u=n[o].split(".");if(2==u.length){var l=parseInt(u[0]),m=parseInt(u[1]);l>0&&l<18&&m>0&&m<5&&(i.push(3),i.push(l),i.push(1<<m-1));}else{var h=parseInt(u);"0"==u?i.push(1):(i.push(3),i.push(h),i.push(31));}i.length>1&&this._sendMessage(s,1,i);}}else if("n26shutterfunction"==e.type.toLowerCase()){i=null;i="up"==t?[1,2]:"down"==t?[2,2]:"angle"==t?[3,2]:"stop"==t?[4,2]:[0,2],"A"==e.data?i.push(1):"D"==e.data&&i.push(2),i.length>2&&this._sendMessage(s,1,i);}}},xnm.aio.mbus.Handler=function(){var Handler=function Handler(){};return Handler.prototype.MediolaBus=xnm.aio.mbus.MediolaBus,Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.mbus.Handler());