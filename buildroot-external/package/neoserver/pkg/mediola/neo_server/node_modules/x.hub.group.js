var util=require("util"),commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{},x.hub.group=x.hub.group||{},x.hub.group.GroupManager=function(){var Group=function Group(e,t,r){this._id=e,this._type=t,this._logger=require("x.logger.js").getLogger("x.hub.group.Group.["+e+"]"),this._devices=r;};Group.prototype.getId=function(){return this._id;},Group.prototype.executeCommand=function(e,t,r){if(this._devices&&this._devices.length)for(var i=this._devices.length,cb=function cb(){0==--i&&t&&t();},o=0;o<this._devices.length;o++){this._doDeviceCommand(this._devices[o],e,cb,r);}else t&&t();},Group.prototype._doDeviceCommand=function(e,t,r,i){if(this._logger.log("trace","execute command:"+JSON.stringify(t)+" for device:"+JSON.stringify(e)),e){var o=JSON.parse(JSON.stringify(e));for(var n in t){"group"!=n&&(o[n]=t[n]);}var u=this;commandman.commandHandlerV6.executeCommandWithCommandInfo(o,function(i){var o=i?"error":"trace";u._logger.log(o,"execute command finish:"+JSON.stringify(t)+" for device:"+JSON.stringify(e)+(i?" failed:"+i.message:" success")),r&&r(i);},i);}else r&&r();},Group.parse=function(e,t){return e&&t&&t.type?new Group(e,t.type,t.devices):null;};var GM=function GM(){this._logger=require("x.logger.js").getLogger("x.hub.group.GroupManager"),this._dataFolder=null,this._groups=null,this._writing=!1,this._writeCallbacks=[];};return GM.FILE_NAME="group.json",GM.prototype.init=function(e,t){this._logger.log("info","init group manager"),this._dataFolder=e.getUserRootDataPath(),this._loadGroups(function(e){t&&t(e);});},GM.prototype.getGroups=function(){return this._groups;},GM.prototype.getGroup=function(e){return this._groups?this._groups[e]:null;},GM.prototype.setGroup=function(e,t,r){null!=e&&null!=e?(t?this._groups[e]=t:delete this._groups[e],this._writeGroups(function(e){r&&r(e,t);})):r&&r(new Error("invalid group id"));},GM.prototype.executeGroupCommand=function(e,t,r,i){if(null!=e&&null!=e&&this._groups[e]){if(t){var o=this._groups[e],n=Group.parse(e,o);n?(this._logger.log("trace","execute group#"+e+" command:"+JSON.stringify(t)),n.executeCommand(t,r,i)):r&&r(new Error("invalid group"));}else r&&r(new Error("invalid command"));}else r&&r(new Error("invalid group id"));},GM.prototype._loadGroups=function(e){var t=require("fs-extra"),r=this._getFile(),i=this;t.ensureFile(r,function(t){t?e(t):i._loadFile(function(t,r){t?e(t):(i._groups=r||{},e());});});},GM.prototype._writeGroups=function(e){if(e&&-1==this._writeCallbacks.indexOf(e)&&this._writeCallbacks.push(e),!this._writing&&this._writeCallbacks.length){this._writing=!0;var t=this._writeCallbacks;this._writeCallbacks=[];var r=this;this._writeFile(this._groups,function(e){r._writing=!1,t.forEach(function(t){try{t&&t(e);}catch(e){}}),r._writeGroups();});}},GM.prototype._getFile=function(){return require("path").resolve(this._dataFolder,GM.FILE_NAME);},GM.prototype._loadFile=function(e){var t=require("fs"),r=this._getFile();t.readFile(r,"utf8",function(t,r){if(t)e(t);else if(r)try{var i=JSON.parse(r);e(null,i);}catch(t){e(null,{});}else e(null,{});});},GM.prototype._writeFile=function(e,t){var r=require("fs"),i=this._getFile();r.writeFile(i,JSON.stringify(e,null,2),function(e){t&&t(e);});},GM;}(),x.hub.group.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.group.Handler"),this._groupManager=new x.hub.group.GroupManager();};return Handler.prototype.init=function(e,t,r){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(e),this._groupManager.init(t,function(e){e&&r(e);});},Handler.prototype.getGroupManager=function(){return this._groupManager;},Handler.prototype._initHttpApi=function(){var e=this,t=require("x.hub.js").getServer();t.addRoute("/api/groups",{method:"GET"},function(t,r,i){var o=e._groupManager.getGroups();r.json({XC_SUC:o||{}});}),t.addRoute("/data/grp/",{method:"GET"},function(t,r,i){var o=t.path.substr(10),n=e._groupManager.getGroup(o);n?r.json({XC_SUC:n}):r.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),t.addRoute("/data/grp/",{method:"POST"},function(t,r){var i=t.path.substr(10);try{var o=t.json;e._groupManager.setGroup(i,o,function(e,i){e?r.json({XC_ERR:{code:"000101",msg:"failed to set group:"+e.message}}):i?r.json({XC_SUC:{bytes:t.size}}):r.json({XC_SUC:{bytes:0}});});}catch(e){r.json({XC_ERR:{code:"000101",msg:"failed to set group:"+e.message}});}});},Handler;}(),module.exports=new x.hub.group.Handler();