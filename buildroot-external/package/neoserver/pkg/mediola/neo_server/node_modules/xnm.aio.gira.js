"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e12){throw _e12;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e13){didErr=true;err=_e13;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function _regeneratorRuntime(){return exports;};var exports={},Op=Object.prototype,hasOwn=Op.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key];}try{define({},"");}catch(err){define=function define(obj,key,value){return obj[key]=value;};}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return generator._invoke=function(innerFn,self,context){var state="suspendedStart";return function(method,arg){if("executing"===state)throw new Error("Generator is already running");if("completed"===state){if("throw"===method)throw arg;return doneResult();}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult;}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if("suspendedStart"===state)throw state="completed",context.arg;context.dispatchException(context.arg);}else"return"===context.method&&context.abrupt("return",context.arg);state="executing";var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?"completed":"suspendedYield",record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done};}"throw"===record.type&&(state="completed",context.method="throw",context.arg=record.arg);}};}(innerFn,self,context),generator;}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)};}catch(err){return{type:"throw",arg:err};}}exports.wrap=wrap;var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,function(){return this;});var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){define(prototype,method,function(arg){return this._invoke(method,arg);});});}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==_typeof(value)&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject);},function(err){invoke("throw",err,resolve,reject);}):PromiseImpl.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result);},function(error){return invoke("throw",error,resolve,reject);});}reject(record.arg);}var previousPromise;this._invoke=function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl(function(resolve,reject){invoke(method,arg,resolve,reject);});}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();};}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(undefined===method){if(context.delegate=null,"throw"===context.method){if(delegate.iterator["return"]&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method");}return ContinueSentinel;}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel);}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry);}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record;}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0);}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;){if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;}return next.value=undefined,next.done=!0,next;};return next.next=next;}}return{next:doneResult};}function doneResult(){return{value:undefined,done:!0};}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(Gp,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name));},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun;},exports.awrap=function(arg){return{__await:arg};},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,function(){return this;}),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next();});},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,function(){return this;}),define(Gp,"toString",function(){return"[object Generator]";}),exports.keys=function(object){var keys=[];for(var key in object){keys.push(key);}return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next;}return next.done=!0,next;};},exports.values=values,Context.prototype={constructor:Context,reset:function reset(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this){"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined);}},stop:function stop(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval;},dispatchException:function dispatchException(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught;}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}}}},abrupt:function abrupt(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break;}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record);},complete:function complete(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel;},finish:function finish(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel;}},"catch":function _catch(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry);}return thrown;}}throw new Error("illegal catch attempt");},delegateYield:function delegateYield(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel;}},exports;}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.gira=xnm.aio.gira||{},xnm.aio.gira={_logger:{log:function log(){}},parseJSON:function parseJSON(e){return new xnm.aio.gira.GiraServer(e);}},xnm.aio.gira.GiraServer=function(){var GiraServer=/*#__PURE__*/function(){function GiraServer(e,t){_classCallCheck(this,GiraServer);if("undefined"==typeof require||null==require)this._logger={log:function log(e,t){console&&console.log&&(e&&"error"!=e?console.log(e,t):console.log("error",t,t.stack));}};else{var _e="xnm.aio.gira.GiraServer";this._logger=require("x.logger.js").getLogger(_e),require("x.logger.js").setLogToConsole(!0,_e);}this.REQUESTS_TIMEOUT_MS=t||1e4,this.gwInfo=e,this.CommandHandler=null,this.cachedConfiguration=null;}_createClass(GiraServer,[{key:"_doRequest",value:function _doRequest(e,t,a,r,n){var i={host:this.gwInfo.ip,port:this.gwInfo.port,path:t,method:String(e).toUpperCase(),timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json"},rejectUnauthorized:!1};if(a)for(var o in a){a.hasOwnProperty(o)&&(i.headers[o]=a[o]);}r&&(i.headers["Content-Length"]=r.length),this._logger.log("debug","call gira server on ".concat(t," with ").concat(JSON.stringify(i)));var s=require("https"),u=this,l=n,c=s.request(i,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(u._logger.log("debug","receive code:"+e.statusCode+" response:"+t),l){if(e.statusCode&&(e.statusCode<200||e.statusCode>399)){var _e2=new Error("request error");try{_e2.message=JSON.stringify(t);}catch(e){}return void l(_e2);}l(null,t,e),l=null;}});});c.on&&c.on("error",function(e){u._logger.log("error","do request error:"+e.message),l&&(l(e),l=null);}),c.setTimeout&&c.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){u._logger.log("error","do request timeout"),c.abort(),l&&(l(new Error("timeout")),l=null);}),r&&(this._logger.log("debug","do request send body:"+r),c.write(r)),c.end();}},{key:"get",value:function(){var _get=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(e,t,a){var _this=this;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt("return",new Promise(function(r,n){return _this._doRequest("get",e,t,a,function(e,t){return e?n(e):r(t);});}));case 1:case"end":return _context.stop();}}},_callee);}));function get(_x,_x2,_x3){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(e,t,a){var _this2=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new Promise(function(r,n){return _this2._doRequest("post",e,t,a,function(e,t){return e?n(e):r(t);});}));case 1:case"end":return _context2.stop();}}},_callee2);}));function post(_x4,_x5,_x6){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(e,t,a){var _this3=this;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise(function(r,n){return _this3._doRequest("put",e,t,a,function(e,t){return e?n(e):r(t);});}));case 1:case"end":return _context3.stop();}}},_callee3);}));function put(_x7,_x8,_x9){return _put.apply(this,arguments);}return put;}()},{key:"delete",value:function(){var _delete2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(e,t,a){var _this4=this;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:return _context4.abrupt("return",new Promise(function(r,n){return _this4._doRequest("delete",e,t,a,function(e,t){return e?n(e):r(t);});}));case 1:case"end":return _context4.stop();}}},_callee4);}));function _delete(_x10,_x11,_x12){return _delete2.apply(this,arguments);}return _delete;}()},{key:"isGiraServer",value:function(){var _isGiraServer=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(){var _e3,e;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!GiraServer.serversCache[this.gwInfo.ip]){_context5.next=4;break;}_e3=GiraServer.serversCache[this.gwInfo.ip];if(!(Date.now()-_e3.time<GiraServer.cacheTime&&_e3.serverInfo)){_context5.next=4;break;}return _context5.abrupt("return",(this._logger.log("debug","is gira server based on cached data"),_e3.serverInfo));case 4:_context5.next=6;return this.get("/api/").then(function(e){var t=JSON.parse(e);return!(!e||!t.info)&&t;})["catch"](function(e){return!1;});case 6:e=_context5.sent;return _context5.abrupt("return",(GiraServer.serversCache[this.gwInfo.ip]={time:Date.now(),serverInfo:e},e));case 8:case"end":return _context5.stop();}}},_callee5,this);}));function isGiraServer(){return _isGiraServer.apply(this,arguments);}return isGiraServer;}()},{key:"getToken",value:function(){var _getToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(e,t,a){var r,n,i,o,s;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:r={client:"com.mediola.creator".concat(a||"")};n="".concat(e,":").concat(t);i={Authorization:"Basic ".concat(Buffer.from(n).toString("base64"))};_context6.next=5;return this.post("/api/clients",i,JSON.stringify(r));case 5:o=_context6.sent;if(o){_context6.next=8;break;}throw this.generateGiraError("can not get token, no result",3);case 8:s=JSON.parse(o);if(s.token){_context6.next=11;break;}throw this.generateGiraError("no token : ".concat(o),3);case 11:return _context6.abrupt("return",(this.gwInfo.token=s.token,s.token));case 12:case"end":return _context6.stop();}}},_callee6,this);}));function getToken(_x13,_x14,_x15){return _getToken.apply(this,arguments);}return getToken;}()},{key:"registerCallbackUrls",value:function(){var _registerCallbackUrls=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(){var e,t,a;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:e="".concat(this.gwInfo.eventsCallbackUrl,"/gira/events/value");e.startsWith("https://")||(e="https://".concat(e));t={valueCallback:e,testCallbacks:!0},a="/api/clients/".concat(this.gwInfo.token,"/callbacks");return _context7.abrupt("return",this.post(a,null,JSON.stringify(t)).then(function(e){return e.body;}));case 4:case"end":return _context7.stop();}}},_callee7,this);}));function registerCallbackUrls(){return _registerCallbackUrls.apply(this,arguments);}return registerCallbackUrls;}()},{key:"unregisterClient",value:function(){var _unregisterClient=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(){var e;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:e="/api/clients/".concat(this.gwInfo.token);return _context8.abrupt("return",this["delete"](e).then(function(e){return e.body;}));case 2:case"end":return _context8.stop();}}},_callee8,this);}));function unregisterClient(){return _unregisterClient.apply(this,arguments);}return unregisterClient;}()},{key:"getDevices",value:function(){var _getDevices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(e){var t;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return this.isGiraServer();case 2:if(_context9.sent){_context9.next=4;break;}return _context9.abrupt("return",void e(new Error("server is unreachable")));case 4:_context9.next=6;return this._getServerConfiguration();case 6:t=_context9.sent;if(!(!t||!t.functions||!t.locations)){_context9.next=9;break;}return _context9.abrupt("return",void e(new Error("ui configuration is invalid")));case 9:e(null,this._convertConfigurationToMediolaDevices(t));case 10:case"end":return _context9.stop();}}},_callee9,this);}));function getDevices(_x16){return _getDevices.apply(this,arguments);}return getDevices;}()},{key:"_convertConfigurationToMediolaDevices",value:function _convertConfigurationToMediolaDevices(e){var _this5=this;var t=[];var _iterator=_createForOfIteratorHelper(e.functions),_step;try{var _loop=function _loop(){var a=_step.value;var r={name:void 0,room:void 0,sys:"gira",address:void 0,type:void 0,supportedDataPoints:void 0};a.displayName&&(r.name=a.displayName),a.uid&&(r.address=a.uid),a.dataPoints&&(r.supportedDataPoints=[],a.dataPoints.forEach(function(e){r.supportedDataPoints.push({dataPointUid:e.uid,dataPointName:e.name});})),r.room=_this5._findDeviceRoom(e.locations,a.uid,""),r.type=_this5._findDeviceType(a.channelType),r.type&&"undefined"!==r.type&&t.push(r);};for(_iterator.s();!(_step=_iterator.n()).done;){_loop();}}catch(err){_iterator.e(err);}finally{_iterator.f();}return t;}},{key:"_findDeviceRoom",value:function _findDeviceRoom(e,t,a){var r=!1,n=a;var _iterator2=_createForOfIteratorHelper(e),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var i=_step2.value;if(i.functions&&i.functions.includes(t)){r=!0,n=a&&a.length>0?"".concat(a,"::"):"",n+=i.displayName,r=!0;break;}if(i.locations&&!r&&(n=this._findDeviceRoom(i.locations,t,i.displayName),n)){r=!0;break;}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}return r?n:null;}},{key:"_findDeviceType",value:function _findDeviceType(e){var t="undefined";switch(e){case"de.gira.schema.channels.Switch":t="switch";break;case"de.gira.schema.channels.KNX.Dimmer":t="dimmer";break;case"de.gira.schema.channels.BlindWithPos":t="blind";break;case"de.gira.schema.channels.KNX.HeatingCoolingSwitchable":case"de.gira.schema.channels.RoomTemperatureSwitchable":t="heater";break;case"de.gira.schema.channels.DimmerRGBW":t="dimmerrgbw";break;case"de.gira.schema.channels.SceneControl":t="scene";}return this._logger.log("debug","[GiraServer._findDeviceType] Assigned channel type \"".concat(e,"\" as device type \"").concat(t,"\".")),t;}},{key:"executeCommandCreator",value:function(){var _executeCommandCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(e,t,a){var r,_e4,n,_e5,_n,i,o,s,u,l,c,m,_e6;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:this._logger.log("debug","executing ".concat(JSON.stringify(t)," on ").concat(JSON.stringify(e)));_context10.prev=1;_context10.next=4;return this.isGiraServer();case 4:if(_context10.sent){_context10.next=6;break;}return _context10.abrupt("return",void a(this.generateGiraError("server is unreachable",5)));case 6:_context10.t0=this.cachedConfiguration;if(_context10.t0){_context10.next=10;break;}_context10.next=10;return this._getServerConfiguration();case 10:r=this.cachedConfiguration.functions.find(function(t){return t.uid==e.address;}).dataPoints;if(!(!t||"color"!==t.value&&"color_white"!==t.value)){_context10.next=27;break;}_e4=this._whichDataPoint(t,r);if(_e4){_context10.next=15;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 15:_context10.next=17;return this._getDesiredValue(t,_e4);case 17:n=_context10.sent;if(!(void 0===n||null==n)){_context10.next=20;break;}return _context10.abrupt("return",void a(this.generateGiraError("Invalid value command",3)));case 20:_context10.t1=a;_context10.next=23;return this.setDataPointValue(_e4.uid,n);case 23:_context10.t2=_context10.sent;(0,_context10.t1)(null,_context10.t2);_context10.next=56;break;case 27:_e5="color_white"===t.value,_n=this._whichDataPoint({value:"Red"},r),i=this._whichDataPoint({value:"Green"},r),o=this._whichDataPoint({value:"Blue"},r);if(!(!_n||!i||!o)){_context10.next=30;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 30:s=null;if(!(_e5&&(s=this._whichDataPoint({value:"White"},r),!s))){_context10.next=33;break;}return _context10.abrupt("return",void a(this.generateGiraError("Unsupported command",5)));case 33:_context10.next=35;return this._getDesiredValue(t,{});case 35:u=_context10.sent;if(!(!Array.isArray(u)||u.length<3)){_context10.next=38;break;}return _context10.abrupt("return",void a(this.generateGiraError("Invalid value command",3)));case 38:_context10.next=40;return this.setDataPointValue(_n.uid,u[0]);case 40:l=_context10.sent;_context10.next=43;return this.setDataPointValue(i.uid,u[1]);case 43:c=_context10.sent;_context10.t3=l;_context10.t4=c;_context10.next=48;return this.setDataPointValue(o.uid,u[2]);case 48:_context10.t5=_context10.sent;m={red:_context10.t3,green:_context10.t4,blue:_context10.t5};if(!_e5){_context10.next=55;break;}_context10.next=53;return this.setDataPointValue(s.uid,u[3]);case 53:_e6=_context10.sent;m.white=_e6;case 55:a(null,m);case 56:_context10.next=61;break;case 58:_context10.prev=58;_context10.t6=_context10["catch"](1);this._logger.log("error",_context10.t6),a(_context10.t6);case 61:case"end":return _context10.stop();}}},_callee10,this,[[1,58]]);}));function executeCommandCreator(_x17,_x18,_x19){return _executeCommandCreator.apply(this,arguments);}return executeCommandCreator;}()},{key:"_getDesiredValue",value:function(){var _getDesiredValue2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(e,t){var a,_e7;return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:a=e.ext;_context11.t0=e.value;_context11.next=_context11.t0==="on"?4:_context11.t0==="StepUp"?4:_context11.t0==="Up"?4:_context11.t0==="off"?6:_context11.t0==="StepDown"?6:_context11.t0==="Down"?6:_context11.t0==="color"?8:_context11.t0==="color_white"?10:_context11.t0==="toggle"?12:16;break;case 4:a=1;return _context11.abrupt("break",16);case 6:a=0;return _context11.abrupt("break",16);case 8:a=String(a).replace("#","").trim(),6===a.length||8===a.length?(a=[a.substring(0,2),a.substring(2,4),a.substring(4,6)],a.forEach(function(e,t){a[t]=Math.round(parseInt(e,16)/2.55);}),(isNaN(a[0])||isNaN(a[1])||isNaN(a[2]))&&(a=null)):a=null;return _context11.abrupt("break",16);case 10:a=String(a).replace("#","").trim(),8===a.length?(a=[a.substring(0,2),a.substring(2,4),a.substring(4,6),a.substring(6,8)],a.forEach(function(e,t){a[t]=Math.round(parseInt(e,16)/2.55);}),(isNaN(a[0])||isNaN(a[1])||isNaN(a[2])||isNaN(a[3]))&&(a=null)):a=null;return _context11.abrupt("break",16);case 12:_context11.next=14;return this._getCurrentValueOfDataPoint(t.uid);case 14:_e7=_context11.sent;a=_e7>0?0:1;case 16:return _context11.abrupt("return",a);case 17:case"end":return _context11.stop();}}},_callee11,this);}));function _getDesiredValue(_x20,_x21){return _getDesiredValue2.apply(this,arguments);}return _getDesiredValue;}()},{key:"_getCurrentValueOfDataPoint",value:function(){var _getCurrentValueOfDataPoint2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(e){var t;return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:t="/api/values/".concat(e,"?token=").concat(this.gwInfo.token);return _context12.abrupt("return",this.get(t).then(function(e){return JSON.parse(e).values[0].value;}));case 2:case"end":return _context12.stop();}}},_callee12,this);}));function _getCurrentValueOfDataPoint(_x22){return _getCurrentValueOfDataPoint2.apply(this,arguments);}return _getCurrentValueOfDataPoint;}()},{key:"_whichDataPoint",value:function _whichDataPoint(e,t){var a=e.value;return a=this._nameOfCommandInKnx(a),t.find(function(e){return e.name==a;});}},{key:"_nameOfCommandInKnx",value:function _nameOfCommandInKnx(e){switch(e){case"on":case"off":case"toggle":e="OnOff";break;case"StepUp":case"StepDown":e="Step-Up-Down";break;case"Up":case"Down":e="Up-Down";}return e;}},{key:"setDataPointValue",value:function(){var _setDataPointValue=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(e,t){var _this6=this;var a,r;return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:a="/api/values/".concat(e,"?token=").concat(this.gwInfo.token),r={value:t};return _context13.abrupt("return",this.put(a,null,JSON.stringify(r))["catch"](function(e){return _this6._logger.log("error",e),!1;}));case 2:case"end":return _context13.stop();}}},_callee13,this);}));function setDataPointValue(_x23,_x24){return _setDataPointValue.apply(this,arguments);}return setDataPointValue;}()},{key:"getStatesCreator",value:function(){var _getStatesCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(e,t,a){var _this7=this;var _e8,r,n,i,_iterator3,_step3,_loop2,_ret;return _regeneratorRuntime().wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:_context14.prev=0;_e8=[];_context14.next=4;return this.isGiraServer();case 4:if(_context14.sent){_context14.next=6;break;}return _context14.abrupt("return",(t.forEach(function(t){_e8.push({id:t.id,status:"server unreachable"});}),void a(null,_e8)));case 6:_context14.t0=this.cachedConfiguration;if(_context14.t0){_context14.next=10;break;}_context14.next=10;return this._getServerConfiguration();case 10:r=[];t.forEach(function(e){var t=e.device;r.includes(t.address)||r.push(t.address);});n=[];r.forEach(function(e){n.push(_this7._getFunctionDataPointsValues(e));});_context14.next=16;return Promise.all(n);case 16:i=_context14.sent;_iterator3=_createForOfIteratorHelper(t);_context14.prev=18;_loop2=function _loop2(){var a=_step3.value;var t=a.status,r=a.device,n=i.find(function(e){return e[r.address];})[r.address];var o=r.supportedDataPoints.find(function(e){return(e.dataPointName||e.dataPontName)==t.value;});if(!o){_e8.push({id:a.id,status:"undefined"});return"continue";}var s=n.find(function(e){return e.uid==o.dataPointUid;});if(s){var _t=s.value;switch(o.dataPointName){case"OnOff":_t=s.value?"on":"off";break;case"Movement":_t=s.value?"moving":"idle";}_e8.push({id:a.id,status:_t});}else _this7._logger.log("error","No datapoint \"".concat(o.dataPointUid,"\" found in result for \"").concat(a.id,"\"."));};_iterator3.s();case 21:if((_step3=_iterator3.n()).done){_context14.next=27;break;}_ret=_loop2();if(!(_ret==="continue")){_context14.next=25;break;}return _context14.abrupt("continue",25);case 25:_context14.next=21;break;case 27:_context14.next=32;break;case 29:_context14.prev=29;_context14.t1=_context14["catch"](18);_iterator3.e(_context14.t1);case 32:_context14.prev=32;_iterator3.f();return _context14.finish(32);case 35:a(null,_e8);_context14.next=41;break;case 38:_context14.prev=38;_context14.t2=_context14["catch"](0);this._logger.log("error",_context14.t2),a(_context14.t2);case 41:case"end":return _context14.stop();}}},_callee14,this,[[0,38],[18,29,32,35]]);}));function getStatesCreator(_x25,_x26,_x27){return _getStatesCreator.apply(this,arguments);}return getStatesCreator;}()},{key:"_getFunctionDataPointsValues",value:function(){var _getFunctionDataPointsValues2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(e){var t,a,r;return _regeneratorRuntime().wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:t={};t[e]=[];_context15.prev=2;_context15.next=5;return this._prepareToken();case 5:a=_context15.sent;_context15.next=8;return this.get("/api/values/".concat(e,"?token=").concat(a));case 8:r=_context15.sent;if(!(r=JSON.parse(r),!r||!r.values)){_context15.next=11;break;}throw Error("server response is not valid");case 11:return _context15.abrupt("return",(t[e]=r.values,t));case 14:_context15.prev=14;_context15.t0=_context15["catch"](2);return _context15.abrupt("return",(this._logger.log("error","error in getting data points values of ".concat(e)),this._logger.log("error",_context15.t0),t));case 17:case"end":return _context15.stop();}}},_callee15,this,[[2,14]]);}));function _getFunctionDataPointsValues(_x28){return _getFunctionDataPointsValues2.apply(this,arguments);}return _getFunctionDataPointsValues;}()},{key:"_getDataPointUid",value:function _getDataPointUid(e,t){var _iterator4=_createForOfIteratorHelper(t.dataPoints),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var a=_step4.value;if(a.name==e)return a.uid;}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}return null;}},{key:"_getServerConfiguration",value:function(){var _getServerConfiguration2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){var e,t,a;return _regeneratorRuntime().wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:_context16.prev=0;_context16.t0="/api/uiconfig?token=";_context16.next=4;return this._prepareToken();case 4:_context16.t1=_context16.sent;e=_context16.t0.concat.call(_context16.t0,_context16.t1,"&expand=dataPointFlags,parameters,locations,trades");_context16.next=8;return this.get(e);case 8:t=_context16.sent;a=JSON.parse(t);if(!(a.error&&"invalidAuth"==a.error.code)){_context16.next=16;break;}_context16.next=13;return this._patchForCachedInvalidTokens();case 13:_context16.t2=_context16.sent;_context16.next=17;break;case 16:_context16.t2=(this.cachedConfiguration=a,this.cachedConfiguration);case 17:return _context16.abrupt("return",_context16.t2);case 20:_context16.prev=20;_context16.t3=_context16["catch"](0);return _context16.abrupt("return",(this._logger.log("error","can not get configuration",_context16.t3),this.cachedConfiguration));case 23:case"end":return _context16.stop();}}},_callee16,this,[[0,20]]);}));function _getServerConfiguration(){return _getServerConfiguration2.apply(this,arguments);}return _getServerConfiguration;}()},{key:"_prepareToken",value:function(){var _prepareToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee17(){var e;return _regeneratorRuntime().wrap(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:if(!this.gwInfo.token){_context17.next=2;break;}return _context17.abrupt("return",this.gwInfo.token);case 2:_context17.next=4;return this.getToken(this.gwInfo.username,this.gwInfo.password);case 4:e=_context17.sent;return _context17.abrupt("return",(this.gwInfo.token=e,e));case 6:case"end":return _context17.stop();}}},_callee17,this);}));function _prepareToken(){return _prepareToken2.apply(this,arguments);}return _prepareToken;}()},{key:"_patchForCachedInvalidTokens",value:function(){var _patchForCachedInvalidTokens2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee18(){var e,t,a,r,n;return _regeneratorRuntime().wrap(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:e=this._getRandomIntInclusive(1,5);_context18.next=3;return this.getToken(this.gwInfo.username,this.gwInfo.password,e);case 3:t=_context18.sent;a="/api/uiconfig?token=".concat(t,"&expand=dataPointFlags,parameters,locations,trades");_context18.next=7;return this.get(a);case 7:r=_context18.sent;n=JSON.parse(r);if(!(n.error&&"invalidAuth"==n.error.code)){_context18.next=11;break;}throw Error("we can not get configuration in second try!");case 11:return _context18.abrupt("return",(this.gwInfo.token=t,n));case 12:case"end":return _context18.stop();}}},_callee18,this);}));function _patchForCachedInvalidTokens(){return _patchForCachedInvalidTokens2.apply(this,arguments);}return _patchForCachedInvalidTokens;}()},{key:"_getRandomIntInclusive",value:function _getRandomIntInclusive(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e+1)+e);}},{key:"toJSON",value:function toJSON(){return{sys:"gira",ip:this.gwInfo.ip,port:this.gwInfo.port};}},{key:"equalsTo",value:function equalsTo(e){return!!e&&e instanceof xnm.aio.gira.GiraServer&&this.gwInfo.ip==e.gwInfo.ip;}},{key:"generateGiraError",value:function generateGiraError(e,t){var a=xnm.aio.gira.DM;return a||a.Error?new a.Error(t,e):Error(e);}}],[{key:"parseJSON",value:function parseJSON(e){return e.ip?new GiraServer(e.ip,e.port):null;}}]);return GiraServer;}();return GiraServer.serversCache={},GiraServer.cacheTime=3e5,GiraServer;}(),xnm.aio.gira.DM={MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"shift",ref:{value:"Shift",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness"}}]},blind:{command:[{type:"enum",name:"step up",ref:{value:"StepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown"}},{type:"enum",name:"move up",ref:{value:"Up"}},{type:"enum",name:"move down",ref:{value:"Down"}},{type:"int",name:"position",ref:{value:"Position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"Slat-Position",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"position",ref:{value:"Position"}},{type:"int",name:"slat position",ref:{value:"Slat-Position"}},{type:"enum",name:"movement status",ref:{value:"Movement",options:["idle","moving"]}}]},heater:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"float",name:"set point",ref:{value:"Set-Point",value_t:"setpointTemp",ext:"%f",scale:.5}}],status:[{type:"float",name:"current temperature",ref:{value:"Current",value_t:"currentTemperature"}},{type:"float",name:"set temperature",ref:{value:"Set-Point",value_t:"setTemperature"}}]},dimmerrgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"red",ref:{value:"Red",value_t:"red",ext:"%d",extMeta:"0-100"}},{type:"int",name:"blue",ref:{value:"Blue",value_t:"blue",ext:"%d",extMeta:"0-100"}},{type:"int",name:"green",ref:{value:"Green",value_t:"green",ext:"%d",extMeta:"0-100"}},{type:"int",name:"White",ref:{value:"White",value_t:"white",ext:"%d",extMeta:"0-100"}},{type:"rgb",name:"color",ref:{value:"color",ext:"%rgb"}},{type:"rgbw",name:"color_white",ref:{value:"color_white",ext:"%rgbw"}}],status:[{type:"enum",name:"switch status",ref:{value:"OnOff",options:["off","on"]}},{type:"int",name:"brightness",ref:{value:"Brightness",value_t:"brightness"}},{type:"int",name:"red",ref:{value:"Red",value_t:"red"}},{type:"int",name:"blue",ref:{value:"Blue",value_t:"blue"}},{type:"int",name:"green",ref:{value:"Green",value_t:"green"}},{type:"int",name:"white",ref:{value:"White",value_t:"white"}}]},scene:{command:[{type:"int",name:"scene",ref:{value:"Scene",value_t:"scene",ext:"%d",extMeta:"1-64"}}]}},SYS:"gira",applyIPEventFilter:function applyIPEventFilter(e,t,a,r,n){if(!e||!e.type)return null;var i=xnm.aio.gira.DM.getIPevtMap(e);return i&&n!==null&&n!==void 0&&n.eventsCallbackUrl?{ipevt:i}:null;},applyUIFilter:function applyUIFilter(e,t,a){if(!e.sys)return null;var _contains=function _contains(e,t){if("*"===e||"*"===e[0])return!0;for(var a=0;a<e.length;a++){if(e[a]==t)return!0;}return!1;},_filter=function _filter(e,t){var r=[],n=null,i=xnm.aio.gira.DM.getCommandStatusMap(e,a);return i&&(n=function(e,t,a){var r=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(i,0,t),r=r.concat(n)),r;},r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),r.command=n;break;case"status":n=_filter(e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;},supportSmartWidget:function supportSmartWidget(e,t){return!(!e||!e.type)&&"undefined"!==e.type;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,r,n){if(!t||!t.type)return null;var i=function(e){var t=[];switch(e.type){case"blind":t.push("blind");break;case"dimmer":case"dimmerrgbw":t.push("dimmer","switch"),"dimmerrgbw"===e.type&&t.push("rgb");break;case"switch":t.push("switch");break;case"heater":t.push("thermostat");}return t;}(t),o=function(e){var t={};switch(e.type){case"blind":t["%moveTo%"]={value:"Position",ext:"%d",extMeta:"0-100"},t["%moveDown%"]={value:"Down"},t["%moveUp%"]={value:"Up"},t["%lamellaTo%"]={value:"Slat-Position",ext:"%d",extMeta:"0-100"};break;case"dimmer":case"dimmerrgbw":case"switch":t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"},t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"},t["%toggle%"]={value:"toggle"},"dimmer"===e.type?t["%dimTo%"]={value:"Brightness",ext:"%d",extMeta:"0-100"}:"dimmerrgbw"===e.type&&(t["%dimTo%"]={value:"Brightness",ext:"%d",extMeta:"0-100"},t["%red%"]={value:"Red",ext:"%d",extMeta:"0-100"},t["%green%"]={value:"Green",ext:"%d",extMeta:"0-100"},t["%blue%"]={value:"Blue",ext:"%d",extMeta:"0-100"},t["%white%"]={value:"White",ext:"%d",extMeta:"0-100"});break;case"heater":t["%thermoOff%"]={value:"off"},t["%thermoOn%"]={value:"off"},t["%thermoTempTo%"]={value:"Set-Point",ext:"%d"};}return t;}(t),s=function(e){var t={};switch(e.type){case"blind":t["%blindState%"]={value:"Position",extMeta:"0-100"},t["%lamellaState%"]={value:"Slat-Position",extMeta:"0-100"};break;case"dimmer":case"dimmerrgbw":case"switch":t["%switchState%"]={value:"OnOff"},"dimmer"===e.type?t["%dimmerState%"]={value:"Brightness",extMeta:"0-100"}:"dimmerrgbw"===e.type&&(t["%dimmerState%"]={value:"Brightness",extMeta:"0-100"},t["%red%"]={value:"Red",extMeta:"0-100"},t["%green%"]={value:"Green",extMeta:"0-100"},t["%blue%"]={value:"Blue",extMeta:"0-100"},t["%white%"]={value:"White",extMeta:"0-100"});break;case"heater":t["%thermoCurrentTemp%"]={value:"Current"},t["%thermoSetTemp%"]={value:"Set-Point"};}return t;}(t);return e._injectToSmartWidgetTemplate(r,i,n,o,s);},createDevice:function createDevice(e,t,a){var r=xnm.aio.gira.DM;e?a(null,e):a(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},createGateway:function createGateway(e,t,a){var _this8=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee19(){var _t2,_a;return _regeneratorRuntime().wrap(function _callee19$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:_context19.prev=0;_this8._checkGwInfo(e);_t2=new xnm.aio.gira.GiraServer(e);_context19.next=5;return _t2.isGiraServer();case 5:if(_context19.sent){_context19.next=7;break;}throw new _this8.Error(_this8.Error.ERROR_CODE.NOT_FOUND,"no gira server");case 7:if(!(e.username&&e.password)){_context19.next=12;break;}_context19.next=10;return _t2.getToken(e.username,e.password);case 10:_a=_context19.sent;e.token=_a;case 12:_context19.t0=e.eventsCallbackUrl;if(!_context19.t0){_context19.next=16;break;}_context19.next=16;return _t2.registerCallbackUrls();case 16:a(null,e);_context19.next=22;break;case 19:_context19.prev=19;_context19.t1=_context19["catch"](0);_this8._handleError(_context19.t1,a);case 22:case"end":return _context19.stop();}}},_callee19,null,[[0,19]]);}))();},deleteDevice:function deleteDevice(e,t,a){a();},deleteGateway:function deleteGateway(e,t,a){new xnm.aio.gira.GiraServer(e).unregisterClient().then(function(t){console.log("".concat(e.name," is deleted"),t);})["catch"](function(e){console.log(e);}),a();},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e.type)return null;if(!xnm.aio.gira.DM.MAP[e.type])return null;var a=JSON.parse(JSON.stringify(xnm.aio.gira.DM.MAP[e.type])),r=e.supportedDataPoints;return a.command&&(a.command=this._filterCommandsOrStatuses(a.command,r)),a.status&&(a.status=this._filterCommandsOrStatuses(a.status,r)),a;},_filterCommandsOrStatuses:function _filterCommandsOrStatuses(e,t){var _this9=this;return e.filter(function(e){var a=e.ref.value;return a=_this9._fixNameOfCommand(a),t.find(function(e){return(e.dataPointName||e.dataPontName)==a;});});},_fixNameOfCommand:function _fixNameOfCommand(e){switch(e){case"on":case"off":case"toggle":e="OnOff";break;case"StepUp":case"StepDown":e="Step-Up-Down";break;case"Up":case"Down":e="Up-Down";break;case"color":e="Red";break;case"color_white":e="White";}return e;},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Gira"}];},getIPDeviceType:function getIPDeviceType(){return[{sys:xnm.aio.gira.DM.SYS,name:"Gira"}];},getIPevtMap:function getIPevtMap(e){return e.type&&xnm.aio.gira.DM.MAP[e.type]&&xnm.aio.gira.DM.MAP[e.type].status||null;},toGeneralDevice:function toGeneralDevice(e){return e?"blind"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},rotation:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100},rotation:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"Position",ext:"%d",extMeta:"0-100"},rotation:{value:"Slat-Position",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"Position",ext:"%d",extMeta:"0-100"},rotation:{value:"Slat-Position",ext:"%d",extMeta:"0-100"}}}}:"dimmer"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"}},states:{brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},state:{value:"OnOff"}}}}:"dimmerrgbw"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}},red:{value:{type:"INT",min:0,max:100}},green:{value:{type:"INT",min:0,max:100}},blue:{value:{type:"INT",min:0,max:100}},white:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]},red:{type:"INT",min:0,max:100},green:{type:"INT",min:0,max:100},blue:{type:"INT",min:0,max:100},white:{type:"INT",min:0,max:100}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},red:{value:"Red",extMeta:"0-100"},green:{value:"Green",extMeta:"0-100"},blue:{value:"Blue",extMeta:"0-100"},white:{value:"White",extMeta:"0-100"}},states:{state:{value:"OnOff"},brightness:{value:"Brightness",ext:"%d",extMeta:"0-100"},red:{value:"Red",extMeta:"0-100"},green:{value:"Green",extMeta:"0-100"},blue:{value:"Blue",extMeta:"0-100"},white:{value:"White",extMeta:"0-100"}}}}:"heater"===e.type?{type:"heater",commands:{on:{},off:{},tempTo:{value:{type:"FLOAT",step:.5}}},states:{setpoint:{value:{type:"FLOAT",step:.5}},temperature:{value:{type:"FLOAT",step:.5}}},details:{commands:{on:{value:"on"},off:{value:"off"},tempTo:{value:"Set-Point",ext:"%f"}},states:{setpoint:{value:"Set-Point"},temperature:{value:"Current"}}}}:"switch"===e.type?{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"OnOff"}}}}:null:null;},updateDevice:function updateDevice(e,t,a){var r=xnm.aio.gira.DM;e?a(null,e):a(new r.Error(r.Error.ERROR_CODE.INVALID,"info is missing"));},updateGateway:function(){var _updateGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee20(e,t,a,r){return _regeneratorRuntime().wrap(function _callee20$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:t?this.createGateway(t,a,r):r(new this.Error(this.Error.ERROR_CODE.INVALID,"no new info"));case 1:case"end":return _context20.stop();}}},_callee20,this);}));function updateGateway(_x29,_x30,_x31,_x32){return _updateGateway.apply(this,arguments);}return updateGateway;}(),_checkGwInfo:function _checkGwInfo(e){if(!e)throw new this.Error(this.Error.ERROR_CODE.INVALID,"info is invalid");if(!e.ip)throw new this.Error(this.Error.ERROR_CODE.INVALID,"ip is invalid");},_handleError:function _handleError(e,t){console.log(e),e.code?t(e,null):t(new this.Error(this.Error.ERROR_CODE.UNKNOWN,e.message?e.message:"unknown error"),null);}},xnm.aio.gira.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.gira.DM.Error.prototype=new Error(),xnm.aio.gira.DM.Error.prototype.name="GiraDMError",xnm.aio.gira.DM.Error.prototype.code=0,xnm.aio.gira.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.gira.Handler=function(){var e=require("x.logger.js");if(e){var t="xnm.aio.gira.Handler";this._logger=e.getLogger(t),require("x.logger.js").setLogToConsole(!0,t);}},xnm.aio.gira.Handler.prototype={devicemanager:xnm.aio.gira.DM,discoverWithTimeout:function(){var _discoverWithTimeout=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee21(e,t){return _regeneratorRuntime().wrap(function _callee21$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:_context21.prev=0;_context21.t0=t;_context21.next=4;return this._findServersLocatedInNetwork();case 4:_context21.t1=_context21.sent;(0,_context21.t0)(null,_context21.t1);_context21.next=11;break;case 8:_context21.prev=8;_context21.t2=_context21["catch"](0);this._logger.log("error","discoverWithTimeout"),this._logger.log("error",_context21.t2),t(_context21.t2,null);case 11:case"end":return _context21.stop();}}},_callee21,this,[[0,8]]);}));function discoverWithTimeout(_x33,_x34){return _discoverWithTimeout.apply(this,arguments);}return discoverWithTimeout;}(),doCommand:function doCommand(e,t,a){var r=this.resolveGateway(e.gateway);r?r.executeCommandCreator(e,t,function(e){a&&a(e);}):a&&a(new Error("device format invalid"));},doStatus:function doStatus(e,t,a,r){var n=this.resolveGateway(t);if(!n)return void(r&&r(new Error("device format invalid")));var i=[{id:e,status:a}];n.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});},getDeviceCommands:function getDeviceCommands(e,t){console.log("getDeviceCommands","deviceData",e);var a=xnm.aio.gira.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=a?a.command:[];t&&t(null,r);},getDeviceList:function(){var _getDeviceList=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee22(e,t){var a;return _regeneratorRuntime().wrap(function _callee22$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:_context22.prev=0;if(e.username){_context22.next=3;break;}return _context22.abrupt("return",void t(new Error("gateway does not have username")));case 3:if(e.password){_context22.next=5;break;}return _context22.abrupt("return",void t(new Error("gateway does not have password")));case 5:if(e.token){_context22.next=7;break;}return _context22.abrupt("return",void t(new Error("gateway does not have any token, try to connect to server again")));case 7:a=new xnm.aio.gira.GiraServer(e);if(a.isGiraServer()){_context22.next=10;break;}return _context22.abrupt("return",void t(new Error("server is not reachable")));case 10:_context22.next=12;return a.getDevices(t);case 12:_context22.next=17;break;case 14:_context22.prev=14;_context22.t0=_context22["catch"](0);t(_context22.t0);case 17:case"end":return _context22.stop();}}},_callee22,null,[[0,14]]);}));function getDeviceList(_x35,_x36){return _getDeviceList.apply(this,arguments);}return getDeviceList;}(),getDeviceStatus:function getDeviceStatus(e,t){t&&t(new Error("not implemented"),null);},registModule:function registModule(e){e.register(xnm.aio.gira.DM.SYS,"gira");},resolveGateway:function resolveGateway(e){return e?xnm.aio.gira.parseJSON(e):null;},_findServersLocatedInNetwork:function _findServersLocatedInNetwork(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee23(){var e,t,a,r,n,_i,_r,_e9,_t3,_iterator5,_step5,_e10,_loop3,_i2,_n2;return _regeneratorRuntime().wrap(function _callee23$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:e=[],t=require("os");if(t){_context24.next=3;break;}throw Error("it is not node environment");case 3:a=t.networkInterfaces(),r=Object.keys(a);if(!(!a||0==r.length)){_context24.next=6;break;}throw Error("msg:no_interfaces");case 6:n=[];for(_i=0,_r=r;_i<_r.length;_i++){_e9=_r[_i];_t3=a[_e9];_iterator5=_createForOfIteratorHelper(_t3);try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){_e10=_step5.value;"IPv4"==_e10.family&&1!=_e10.internal&&n.push(_e10);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}if(!(n.length>5)){_context24.next=10;break;}throw Error("msg:max_interfaces|5");case 10:_loop3=/*#__PURE__*/_regeneratorRuntime().mark(function _loop3(){var t,a,r,_e11,_t4,_n3;return _regeneratorRuntime().wrap(function _loop3$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:t=_n2[_i2];a=/(\d{1,3}\.\d{1,3}\.\d{1,3})/gm.exec(t.address)[0],r=[];for(_e11=1;_e11<253;_e11++){_t4="".concat(a,".").concat(_e11),_n3=new xnm.aio.gira.GiraServer({sys:"gira",ip:_t4,port:443},5e3);r.push(_n3.isGiraServer());}_context23.next=5;return Promise.all(r);case 5:_context23.sent.forEach(function(t,r){t&&e.push({sys:"gira",deviceType:t.deviceType,deviceVersion:t.deviceVersion,ip:"".concat(a,".").concat(r+1),port:443,name:t.deviceName});});case 6:case"end":return _context23.stop();}}},_loop3);});_i2=0,_n2=n;case 12:if(!(_i2<_n2.length)){_context24.next=17;break;}return _context24.delegateYield(_loop3(),"t0",14);case 14:_i2++;_context24.next=12;break;case 17:return _context24.abrupt("return",e);case 18:case"end":return _context24.stop();}}},_callee23);}))();}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gira.Handler());