var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.hue=x.hub.m.hue||{},x.hub.m.hue.HUE_MODULE=require("xnm.aio.hue.js"),x.hub.m.hue.Monitor=function(){var Monitor=function Monitor(e){this._logger=require("x.logger.js").getLogger("x.hub.m.hue.Monitor");this._running=!1,this._bridge=e,this._devices={},this._sensors={};};return Monitor.prototype.start=function(e){this._logger.log("debug","start monitor for:"+this._bridge.ip),this._running||(this._running=!0,this._getAllSensors()),e&&e();},Monitor.prototype.addStateDevice=function(e,t){e&&e.address&&(this._devices[e.address]=e),t&&t();},Monitor.prototype._getAllSensors=function(){var e=this;this._logger.log("trace","get all sensors for:"+this._bridge.ip),x.hub.m.hue.HUE_MODULE.Sensor.getAllSensors(this._bridge,function(t,r){t?(e._logger.log("trace","get all sensors for:"+e._bridge.ip+" error:"+t.message),setTimeout(function(){e._getAllSensors();},1e3)):(!t&&r&&e._receiveSensors(r),e._running&&e._getAllSensors());});},Monitor.prototype._receiveSensors=function(e){var _retreiveSensorStates=function _retreiveSensorStates(e){for(var t={},r=0;r<e.length;r++){var n=e[r].getAddress(),i=e[r].getStates();t[n]=i;}return t;},t=_retreiveSensorStates(this._sensors),r=_retreiveSensorStates(e);this._sensors=e;for(var n=0;n<e.length;n++){var i=e[n],s=i.getAddress();if(this._devices[s]){var o=i.getType(),a=t[s],u=r[s],v=!1;if(u)switch(o){case"ZLLLightLevel":this._produceEvent(this._devices[s],"lightlevel",a?a.lightlevel:null,u.lightlevel),this._produceEvent(this._devices[s],"dark",a?a.dark:null,u.dark),this._produceEvent(this._devices[s],"daylight",a?a.daylight:null,u.daylight),this._produceEvent(this._devices[s],"battery",a?a.battery:null,u.battery);break;case"ZLLTemperature":this._produceEvent(this._devices[s],"temperature",a?a.temperature:null,u.temperature),this._produceEvent(this._devices[s],"battery",a?a.battery:null,u.battery);break;case"ZLLPresence":this._produceEvent(this._devices[s],"motion",a?a.motion:null,u.motion);break;case"ZLLSwitch":a&&(v=!1,u.ltime!=a.ltime&&(v=!0),this._produceEvent(this._devices[s],"levent",a?a.levent:null,u.levent),u.btn1event&&this._produceEvent(this._devices[s],"btn1event",a.btn1event,u.btn1event,v),u.btn2event&&this._produceEvent(this._devices[s],"btn2event",a.btn2event,u.btn2event,v),u.btn3event&&this._produceEvent(this._devices[s],"btn3event",a.btn3event,u.btn3event,v),u.btn4event&&this._produceEvent(this._devices[s],"btn4event",a.btn4event,u.btn4event,v),this._produceEvent(this._devices[s],"battery",a.battery,u.battery));break;case"ZGPSwitch":a&&(v=!1,u.ltime!=a.ltime&&(v=!0),this._produceEvent(this._devices[s],"levent",a?a.levent:null,u.levent,v));}}}},Monitor.prototype._produceEvent=function(e,t,r,n,i){if(r!=n||i){this._logger.log("debug","receive new status:"+JSON.stringify({address:e.address,key:t,value:n}));var s=r;r==n&&(s=null);var o={key:t,value:n,oldvalue:s,changed:!0};require("x.hub.eventbus.js").emit("status",{module:"hue",device:e,gateway:e.gateway,data:o});}},Monitor;}(),x.hub.m.hue.Handler=function(){var Handler=function Handler(){this._monitors={};};return util.inherits(Handler,EventEmitter),Handler.prototype.init=function(e){e&&e();},Handler.prototype.getSystems=function(){return["hue"];},Handler.prototype.addStateDevice=function(e,t){e?e.gateway?this._startMonitor(e.gateway,function(r,n){r?t&&t({error:r}):n.addStateDevice(e,function(e){t&&t({error:e});});}):t&&t(new Error("device gateway format invalid")):t&&t({error:new Error("device json format invalid")});},Handler.prototype.getAllStates=function(){return[];},Handler.prototype.getStates=function(e){return e&&e.gateway&&e.gateway.ip,null;},Handler.prototype.getState=function(e,t,r){e?e.gateway?x.hub.m.hue.HUE_MODULE.doStatus("xhub",e.gateway,e,{value:t},function(e,t){e?r&&r({error:e}):t?r&&r({data:{value:t.status}}):r&&r({error:new Error("do status failed")});}):r&&r(new Error("device gateway format invalid")):r&&r({error:new Error("device json format invalid")});},Handler.prototype.executeCommand=function(e,t,r){x.hub.m.hue.HUE_MODULE.doCommand(e.gateway,e,t,r);},Handler.prototype.checkDeviceMatch=function(e,t){return!!(t&&t.device&&e&&e.device)&&!(!t.gateway||!e.gateway)&&t.gateway.ip==e.gateway.ip&&t.device.address==e.device.address;},Handler.prototype._startMonitor=function(e,t){if(e&&e.ip){var r=e.ip;if(this._monitors[r])t&&t(null,this._monitors[r]);else{var n=x.hub.m.hue.HUE_MODULE.resolveGateway(e);if(n){var i=new x.hub.m.hue.Monitor(n);this._monitors[r]=i,i.start(),t&&t(null,i);}else t&&t(new Error("hue gateway format invalid"));}}else t&&t(new Error("harmony hub format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.hue.Handler());