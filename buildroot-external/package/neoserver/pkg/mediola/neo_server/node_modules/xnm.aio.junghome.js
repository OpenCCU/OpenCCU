"use strict";function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e10){throw _e10;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e11){didErr=true;err=_e11;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function _regeneratorRuntime(){return exports;};var exports={},Op=Object.prototype,hasOwn=Op.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key];}try{define({},"");}catch(err){define=function define(obj,key,value){return obj[key]=value;};}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return generator._invoke=function(innerFn,self,context){var state="suspendedStart";return function(method,arg){if("executing"===state)throw new Error("Generator is already running");if("completed"===state){if("throw"===method)throw arg;return doneResult();}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult;}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if("suspendedStart"===state)throw state="completed",context.arg;context.dispatchException(context.arg);}else"return"===context.method&&context.abrupt("return",context.arg);state="executing";var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?"completed":"suspendedYield",record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done};}"throw"===record.type&&(state="completed",context.method="throw",context.arg=record.arg);}};}(innerFn,self,context),generator;}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)};}catch(err){return{type:"throw",arg:err};}}exports.wrap=wrap;var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,function(){return this;});var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){define(prototype,method,function(arg){return this._invoke(method,arg);});});}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==_typeof(value)&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject);},function(err){invoke("throw",err,resolve,reject);}):PromiseImpl.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result);},function(error){return invoke("throw",error,resolve,reject);});}reject(record.arg);}var previousPromise;this._invoke=function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl(function(resolve,reject){invoke(method,arg,resolve,reject);});}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();};}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(undefined===method){if(context.delegate=null,"throw"===context.method){if(delegate.iterator["return"]&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method");}return ContinueSentinel;}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel);}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry);}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record;}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0);}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;){if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;}return next.value=undefined,next.done=!0,next;};return next.next=next;}}return{next:doneResult};}function doneResult(){return{value:undefined,done:!0};}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(Gp,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name));},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun;},exports.awrap=function(arg){return{__await:arg};},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,function(){return this;}),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next();});},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,function(){return this;}),define(Gp,"toString",function(){return"[object Generator]";}),exports.keys=function(object){var keys=[];for(var key in object){keys.push(key);}return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next;}return next.done=!0,next;};},exports.values=values,Context.prototype={constructor:Context,reset:function reset(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this){"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined);}},stop:function stop(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval;},dispatchException:function dispatchException(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught;}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}}}},abrupt:function abrupt(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break;}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record);},complete:function complete(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel;},finish:function finish(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel;}},"catch":function _catch(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry);}return thrown;}}throw new Error("illegal catch attempt");},delegateYield:function delegateYield(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel;}},exports;}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.junghome=xnm.aio.junghome||{},xnm.aio.junghome={_logger:{log:function log(){}},parseJSON:function parseJSON(e){return new xnm.aio.junghome.JungGateway(e);}},xnm.aio.junghome.Helpers={normalizeValue:function normalizeValue(e,t){switch(e.key){case"switch":case"status_led":e.value="heater"==t?"1"==e.value?"auto":"manual":"1"==e.value?"on":"off";break;case"up_request":case"down_request":case"trigger_request":e.value="1"==e.value?"pressed":"released";case"level_move":"1"==e.value&&(e.value="closing"),"0"==e.value&&(e.value="stopped"),"-1"==e.value&&(e.value="opening");}}},xnm.aio.junghome.JungGateway=/*#__PURE__*/function(){function JungGateway(e,t){_classCallCheck(this,JungGateway);"undefined"==typeof require||null==require?this._logger={log:function log(e,t){console&&console.log&&(e&&"error"!=e?console.log(e,t):console.log("error",t,t.stack));}}:this._logger=require("x.logger.js").getLogger("xnm.aio.junghome.JungGateway"),this.REQUESTS_TIMEOUT_MS=t||1e4,this.gwInfo=e,this.CommandHandler=null,this.cachedFunctions=null;}_createClass(JungGateway,[{key:"_doRequest",value:function _doRequest(e,t,a,n,o){var r={host:this.gwInfo.ip,port:this.gwInfo.port,path:t,method:e,timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json"},rejectUnauthorized:!1};if(this.gwInfo.token&&(r.headers.token=this.gwInfo.token),a)for(var s in a){a.hasOwnProperty(s)&&(r.headers[s]=a[s]);}n&&n.length&&(r.headers["Content-Length"]=n.length);var i=require("https"),u=this,l=o,m=i.request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(u._logger.log("debug","request on ".concat(r.path," ==> receive code: ").concat(e.statusCode)),e.statusCode>299)return u._logger.log("error","response:"+e.statusMessage),void(l&&(l(new Error(e.statusMessage),t,e),l=null));try{t=JSON.parse(t);}catch(e){}l&&(l(null,t,e),l=null);});});m.on&&m.on("error",function(e){u._logger.log("error","do request error:"+e.message),l&&(l(e),l=null);}),m.setTimeout&&m.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){u._logger.log("error","do request timeout"),m.abort(),l&&(l(new Error("timeout")),l=null);}),n&&(this._logger.log("debug","request body: "+n),m.write(n)),m.end();}},{key:"get",value:function(){var _get=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(e,t,a){var _this=this;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt("return",new Promise(function(n,o){_this._doRequest("GET",e,t,a,function(e,t){e&&o(e),n(t);});}));case 1:case"end":return _context.stop();}}},_callee);}));function get(_x,_x2,_x3){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(e,t,a){var _this2=this;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new Promise(function(n,o){_this2._doRequest("POST",e,t,a,function(e,t){e&&o(e),n(t);});}));case 1:case"end":return _context2.stop();}}},_callee2);}));function post(_x4,_x5,_x6){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(e,t,a){var _this3=this;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt("return",new Promise(function(n,o){_this3._doRequest("PUT",e,t,a,function(e,t){e&&o(e),n(t);});}));case 1:case"end":return _context3.stop();}}},_callee3);}));function put(_x7,_x8,_x9){return _put.apply(this,arguments);}return put;}()},{key:"patch",value:function(){var _patch=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(e,t,a){var _this4=this;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:return _context4.abrupt("return",new Promise(function(n,o){_this4._doRequest("PATCH",e,t,a,function(e,t){e&&o(e),n(t);});}));case 1:case"end":return _context4.stop();}}},_callee4);}));function patch(_x10,_x11,_x12){return _patch.apply(this,arguments);}return patch;}()},{key:"isJungGateway",value:function(){var _isJungGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(){var _e,e;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!JungGateway.gatewaysCache[this.gwInfo.ip]){_context5.next=4;break;}_e=JungGateway.gatewaysCache[this.gwInfo.ip];if(!(Date.now()-_e.time<JungGateway.cacheTime&&_e.gwInfo)){_context5.next=4;break;}return _context5.abrupt("return",(this._logger.log("debug","is Jung Home gateway based on cached data"),_e.gwInfo));case 4:_context5.next=6;return this._hasGatewayHomePage();case 6:if(_context5.sent){_context5.next=8;break;}return _context5.abrupt("return",!1);case 8:e={ip:this.gwInfo.ip};return _context5.abrupt("return",(JungGateway.gatewaysCache[this.gwInfo.ip]={time:Date.now(),gwInfo:e},e));case 10:case"end":return _context5.stop();}}},_callee5,this);}));function isJungGateway(){return _isJungGateway.apply(this,arguments);}return isJungGateway;}()},{key:"_hasGatewayHomePage",value:function(){var _hasGatewayHomePage2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(){return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt("return",this.get("/").then(function(e){return!(!e||!e.includes("JUNG HOME Gateway"));})["catch"](function(e){return!1;}));case 1:case"end":return _context6.stop();}}},_callee6,this);}));function _hasGatewayHomePage(){return _hasGatewayHomePage2.apply(this,arguments);}return _hasGatewayHomePage;}()},{key:"getToken",value:function(){var _getToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(e){var t,a;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:e&&"string"==typeof e||(e="Mediola Creator Neo"),e.startsWith("Mediola")||(e="Mediola ".concat(e));t={user_name:e};_context7.next=4;return this.post("/api/junghome/register",null,JSON.stringify(t));case 4:a=_context7.sent;if(a){_context7.next=7;break;}throw this.generateJungError("can not get token, no result",3);case 7:if(a.token){_context7.next=9;break;}throw this.generateJungError("no token : ".concat(a),3);case 9:return _context7.abrupt("return",a.token);case 10:case"end":return _context7.stop();}}},_callee7,this);}));function getToken(_x13){return _getToken.apply(this,arguments);}return getToken;}()},{key:"getDevices",value:function(){var _getDevices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(e){var t,a,n,o,r;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;_context8.next=3;return this.isJungGateway();case 3:if(_context8.sent){_context8.next=5;break;}throw this.generateJungError("gateway is unreachable");case 5:_context8.next=7;return this.getGatewayFunctions();case 7:t=_context8.sent;_context8.next=10;return this.getGatewayScenes();case 10:a=_context8.sent;if(!(!t||!t.length)){_context8.next=13;break;}throw this.generateJungError("functions are empty");case 13:_context8.next=15;return this.getGatewayGroups();case 15:n=_context8.sent;o=this._convertFunctionsToMediolaDevices(t,n);r=this._convertScenesToMediolaDevices(a);e(null,o.concat(r));_context8.next=24;break;case 21:_context8.prev=21;_context8.t0=_context8["catch"](0);xnm.aio.junghome.DM._handleError(_context8.t0,e);case 24:case"end":return _context8.stop();}}},_callee8,this,[[0,21]]);}));function getDevices(_x14){return _getDevices.apply(this,arguments);}return getDevices;}()},{key:"_convertFunctionsToMediolaDevices",value:function _convertFunctionsToMediolaDevices(e,t){var a=[],n=[];var o=1;var _iterator=_createForOfIteratorHelper(e),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var r=_step.value;try{var _e2={name:void 0,roomName:void 0,sys:"junghome",address:void 0,type:void 0,jungInfo:void 0};if(_e2.jungInfo=r,r.label&&(_e2.name=r.label,n.includes(_e2.name)&&(_e2.name="".concat(_e2.name),o>=1&&(_e2.name+=" - ".concat(o)),o++),n.push(_e2.name)),r.id&&(_e2.address=r.id),r.parent_groups){var _a="";r.parent_groups.forEach(function(e){var n=t.find(function(t){return t.id==e;});if(!n)return;var o=n.name;_a+=o+" ";}),_e2.roomName=_a.trim().replace(/\s/,"-");}_e2.type=this._findDeviceType(r.type),_e2.type&&"undefined"!==_e2.type&&a.push(_e2);}catch(e){this._logger.log("error","problematic function: ".concat(JSON.stringify(r))),this._logger.log("error",e);}}}catch(err){_iterator.e(err);}finally{_iterator.f();}return a;}},{key:"_convertScenesToMediolaDevices",value:function _convertScenesToMediolaDevices(e){var t=[],a=[];var n=1;var _iterator2=_createForOfIteratorHelper(e),_step2;try{for(_iterator2.s();!(_step2=_iterator2.n()).done;){var o=_step2.value;try{var _e3={name:void 0,roomName:void 0,sys:"junghome",address:void 0,type:void 0,jungInfo:void 0};_e3.jungInfo=o,o.label&&(_e3.name=o.label,a.includes(_e3.name)&&(_e3.name="".concat(_e3.name),n>1&&(_e3.name+=" - ".concat(n)),n++),a.push(_e3.name)),o.id&&(_e3.address=o.id),_e3.type="scene",t.push(_e3);}catch(e){this._logger.log("error","problematic scene: ".concat(JSON.stringify(o))),this._logger.log("error",e);}}}catch(err){_iterator2.e(err);}finally{_iterator2.f();}return t;}},{key:"_findDeviceType",value:function _findDeviceType(e){var t="undefined";switch(e){case"OnOff":t="switch";break;case"DimmerLight":t="dimmer";break;case"ColorLight":t="dimmerrgbw";break;case"Position":t="shutter";break;case"PositionAndAngle":t="blind";break;case"Thermostat":t="heater";break;case"Socket":t="socket";break;case"Measurement":t="measurement";break;case"RockerSwitch":t="rocker_switch";break;case"Trigger":t="trigger";}return this._logger.log("debug","[JungGateway._findDeviceType] Assigned function type \"".concat(e,"\" as device type \"").concat(t,"\".")),t;}},{key:"executeCommandCreator",value:function(){var _executeCommandCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(e,t,a){var n,o,r,s,i,u,l;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:this._logger.log("debug","executing ".concat(t.value," on ").concat(e.address));_context9.prev=1;_context9.next=4;return this.isJungGateway();case 4:if(_context9.sent){_context9.next=6;break;}return _context9.abrupt("return",void a(this.generateJungError("gateway is unreachable",5)));case 6:n=e.jungInfo;if(n){_context9.next=9;break;}throw this.generateJungError("function or scene info is not valid",3);case 9:if(!("scene"==t.value)){_context9.next=13;break;}_context9.next=12;return this.runScene(n.id);case 12:return _context9.abrupt("return",void a(null));case 13:o=this.getDataPointValueKeyType(t);r=this.getDataPointType(t);s=n.datapoints.find(function(e){return e.type==r;});if(s){_context9.next=18;break;}throw this._logger.log("error","device ".concat(JSON.stringify(e)," for running commands has problem - command : ").concat(t)),this.generateJungError("problem with data",3);case 18:i=n.id;u=s.id;_context9.next=22;return this.getDataPointKeyTypeValue(t,i,u,o);case 22:l=_context9.sent;_context9.next=25;return this.setDataPoint(i,u,{key:o,value:l});case 25:a(null);_context9.next=31;break;case 28:_context9.prev=28;_context9.t0=_context9["catch"](1);this._logger.log("error",_context9.t0),a(_context9.t0);case 31:case"end":return _context9.stop();}}},_callee9,this,[[1,28]]);}));function executeCommandCreator(_x15,_x16,_x17){return _executeCommandCreator.apply(this,arguments);}return executeCommandCreator;}()},{key:"getDataPointType",value:function getDataPointType(e){var t=e.value;return e.value.includes("::")&&(t=e.value.split("::")[0]),this.getDataPointValueKeyType({value:t});}},{key:"getDataPointKeyTypeValue",value:function(){var _getDataPointKeyTypeValue=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(e,t,a,n){var o,r;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:r=e.value;_context10.t0=(r.includes("::")&&(r=e.value.split("::")[1]),r);_context10.next=_context10.t0==="on"?4:_context10.t0==="off"?6:_context10.t0==="level_move"?6:_context10.t0==="Up"?6:_context10.t0==="toggle"?8:_context10.t0==="brightness"?13:_context10.t0==="level"?13:_context10.t0==="angle"?13:_context10.t0==="temperature_ctrl"?13:_context10.t0==="temperature_ctrl_preset"?13:_context10.t0==="color_temperature"?13:_context10.t0==="Down"?15:_context10.t0==="StepUp"?17:_context10.t0==="StepDown"?22:_context10.t0==="mode"?27:28;break;case 4:o=1;return _context10.abrupt("break",28);case 6:o=0;return _context10.abrupt("break",28);case 8:_context10.next=10;return this.getCurrentValueOfKey(t,a,n);case 10:o=_context10.sent;o=1==o?0:1;return _context10.abrupt("break",28);case 13:o=e.ext;return _context10.abrupt("break",28);case 15:o=100;return _context10.abrupt("break",28);case 17:_context10.next=19;return this.getCurrentValueOfKey(t,a,n);case 19:o=_context10.sent;o<100&&o++;return _context10.abrupt("break",28);case 22:_context10.next=24;return this.getCurrentValueOfKey(t,a,n);case 24:o=_context10.sent;o>0&&o--;return _context10.abrupt("break",28);case 27:"auto"==e.ext&&(o=1),"manual"==e.ext&&(o=0);case 28:return _context10.abrupt("return","".concat(o));case 29:case"end":return _context10.stop();}}},_callee10,this);}));function getDataPointKeyTypeValue(_x18,_x19,_x20,_x21){return _getDataPointKeyTypeValue.apply(this,arguments);}return getDataPointKeyTypeValue;}()},{key:"getDataPointValueKeyType",value:function getDataPointValueKeyType(e){var t,a=e.value;switch(a.includes("::")&&(a=e.value.split("::")[1]),a){case"on":case"off":case"toggle":case"mode":t="switch";break;case"brightness":t="brightness";break;case"level":case"Up":case"Down":case"StepUp":case"StepDown":t="level";break;case"level_move":t="level_move";break;case"angle":t="angle";break;case"temperature_ctrl":t="temperature_ctrl";break;case"temperature_ctrl_preset":t="temperature_ctrl_preset";break;case"color_temperature":t="color_temperature";}return t;}},{key:"getStatesCreator",value:function(){var _getStatesCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(e,t,a){var _this5=this;var _e4,n,_iterator3,_step3,_loop,_ret;return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.prev=0;_e4=[];_context11.next=4;return this.isJungGateway();case 4:if(_context11.sent){_context11.next=6;break;}return _context11.abrupt("return",(t.forEach(function(t){_e4.push({id:t.id,status:"gateway unreachable"});}),void a(null,_e4)));case 6:_context11.next=8;return this.getGatewayFunctions();case 8:n=_context11.sent;_iterator3=_createForOfIteratorHelper(t);_context11.prev=10;_loop=function _loop(){var a=_step3.value;var t=a.device,o=n.find(function(e){return e.id==t.address;});if(!o||!o.datapoints)return"continue";var r=o.datapoints,s=a.status;var i=void 0,u=void 0,l=s.value,m=s.value;if(l.includes("::")){var _e5=l.split("::");l=_e5[0],m=_e5[1],3==_e5.length&&"quantity"==l&&(i=_e5[2]);}if(u="quantity"==l?r.find(function(e){return e.type==l&&e.id==i;}):r.find(function(e){return e.type==l;}),!u)return"continue";var c=u.values.find(function(e){return e.key==m;});null==c||null==c?(_this5._logger.log("warn","unavailable state for ".concat(l," : ").concat(m)),_e4.push({id:a.id,status:"undefined"})):(xnm.aio.junghome.Helpers.normalizeValue(c,t.type),_e4.push({id:a.id,status:c.value}));};_iterator3.s();case 13:if((_step3=_iterator3.n()).done){_context11.next=19;break;}_ret=_loop();if(!(_ret==="continue")){_context11.next=17;break;}return _context11.abrupt("continue",17);case 17:_context11.next=13;break;case 19:_context11.next=24;break;case 21:_context11.prev=21;_context11.t0=_context11["catch"](10);_iterator3.e(_context11.t0);case 24:_context11.prev=24;_iterator3.f();return _context11.finish(24);case 27:a(null,_e4);_context11.next=33;break;case 30:_context11.prev=30;_context11.t1=_context11["catch"](0);this._logger.log("error",_context11.t1),a(_context11.t1);case 33:case"end":return _context11.stop();}}},_callee11,this,[[0,30],[10,21,24,27]]);}));function getStatesCreator(_x22,_x23,_x24){return _getStatesCreator.apply(this,arguments);}return getStatesCreator;}()},{key:"getGatewayFunctions",value:function(){var _getGatewayFunctions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(){return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:return _context12.abrupt("return",this.get("/api/junghome/functions/"));case 1:case"end":return _context12.stop();}}},_callee12,this);}));function getGatewayFunctions(){return _getGatewayFunctions.apply(this,arguments);}return getGatewayFunctions;}()},{key:"getGatewayFunction",value:function(){var _getGatewayFunction=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(e){return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:return _context13.abrupt("return",this.get("/api/junghome/functions/".concat(e)));case 1:case"end":return _context13.stop();}}},_callee13,this);}));function getGatewayFunction(_x25){return _getGatewayFunction.apply(this,arguments);}return getGatewayFunction;}()},{key:"getDataPoint",value:function(){var _getDataPoint=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(e,t){return _regeneratorRuntime().wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:return _context14.abrupt("return",this.get("/api/junghome/functions/".concat(e,"/datapoints/").concat(t)));case 1:case"end":return _context14.stop();}}},_callee14,this);}));function getDataPoint(_x26,_x27){return _getDataPoint.apply(this,arguments);}return getDataPoint;}()},{key:"getCurrentValueOfKey",value:function(){var _getCurrentValueOfKey=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(e,t,a){var n,o;return _regeneratorRuntime().wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:_context15.next=2;return this.getDataPoint(e,t);case 2:n=_context15.sent;if(n.values){_context15.next=5;break;}throw this.generateJungError("can not get current value of ".concat(e,"/").concat(t,"/").concat(a));case 5:o=n.values.find(function(e){return e.key==a;});if(!(null==o||null==o)){_context15.next=8;break;}throw this.generateJungError("".concat(a," is not in values of ").concat(e,"/").concat(t));case 8:return _context15.abrupt("return",o.value);case 9:case"end":return _context15.stop();}}},_callee15,this);}));function getCurrentValueOfKey(_x28,_x29,_x30){return _getCurrentValueOfKey.apply(this,arguments);}return getCurrentValueOfKey;}()},{key:"getGatewayScenes",value:function(){var _getGatewayScenes=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){return _regeneratorRuntime().wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:return _context16.abrupt("return",this.get("/api/junghome/scenes/"));case 1:case"end":return _context16.stop();}}},_callee16,this);}));function getGatewayScenes(){return _getGatewayScenes.apply(this,arguments);}return getGatewayScenes;}()},{key:"runScene",value:function(){var _runScene=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee17(e){return _regeneratorRuntime().wrap(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:return _context17.abrupt("return",this.post("/api/junghome/scenes/".concat(e)));case 1:case"end":return _context17.stop();}}},_callee17,this);}));function runScene(_x31){return _runScene.apply(this,arguments);}return runScene;}()},{key:"setDataPoint",value:function(){var _setDataPoint=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee18(e,t,a){var n;return _regeneratorRuntime().wrap(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:n={data:[a]};return _context18.abrupt("return",this.patch("/api/junghome/functions/".concat(e,"/datapoints/").concat(t),null,JSON.stringify(n)));case 2:case"end":return _context18.stop();}}},_callee18,this);}));function setDataPoint(_x32,_x33,_x34){return _setDataPoint.apply(this,arguments);}return setDataPoint;}()},{key:"getGatewayGroups",value:function(){var _getGatewayGroups=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee19(){return _regeneratorRuntime().wrap(function _callee19$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:return _context19.abrupt("return",this.get("/api/junghome/groups/"));case 1:case"end":return _context19.stop();}}},_callee19,this);}));function getGatewayGroups(){return _getGatewayGroups.apply(this,arguments);}return getGatewayGroups;}()},{key:"getLatestFunctionDefinitions",value:function(){var _getLatestFunctionDefinitions=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee20(){return _regeneratorRuntime().wrap(function _callee20$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:return _context20.abrupt("return",this.get("/api/junghome/types/functions"));case 1:case"end":return _context20.stop();}}},_callee20,this);}));function getLatestFunctionDefinitions(){return _getLatestFunctionDefinitions.apply(this,arguments);}return getLatestFunctionDefinitions;}()},{key:"_prepareToken",value:function(){var _prepareToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee21(){var e;return _regeneratorRuntime().wrap(function _callee21$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:if(!this.gwInfo.token){_context21.next=2;break;}return _context21.abrupt("return",this.gwInfo.token);case 2:_context21.next=4;return this.getToken(this.gwInfo.username);case 4:e=_context21.sent;return _context21.abrupt("return",(this.gwInfo.token=e,e));case 6:case"end":return _context21.stop();}}},_callee21,this);}));function _prepareToken(){return _prepareToken2.apply(this,arguments);}return _prepareToken;}()},{key:"equalsTo",value:function equalsTo(e){return!!e&&e instanceof JungGateway&&this.gwInfo.ip==e.gwInfo.ip;}},{key:"generateJungError",value:function generateJungError(e,t){return new xnm.aio.junghome.DM.Error(t,e);}}]);return JungGateway;}(),xnm.aio.junghome.JungGateway.gatewaysCache={},xnm.aio.junghome.JungGateway.cacheTime=3e5,xnm.aio.junghome.DM={MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}]},dimmer:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}}]},shutter:{command:[{type:"enum",name:"step up",ref:{value:"StepUp",value_t:"stepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown",value_t:"stepDown"}},{type:"enum",name:"move up",ref:{value:"Up",value_t:"moveUp"}},{type:"enum",name:"move down",ref:{value:"Down",value_t:"moveDown"}},{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"stop",ref:{value:"level::level_move",value_t:"stop"}}],status:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"state",ref:{value:"level::level_move",options:["stopped","closing","opening"]}}],ipevt:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}}]},blind:{command:[{type:"enum",name:"step up",ref:{value:"StepUp",value_t:"stepUp"}},{type:"enum",name:"step down",ref:{value:"StepDown",value_t:"stepDown"}},{type:"enum",name:"move up",ref:{value:"Up",value_t:"moveUp"}},{type:"enum",name:"move down",ref:{value:"Down",value_t:"moveDown"}},{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"stop",ref:{value:"level::level_move",value_t:"stop"}}],status:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle"}},{type:"enum",name:"state",ref:{value:"level::level_move",options:["stopped","closing","opening"]}}],ipevt:[{type:"int",name:"position",ref:{value:"level::level",value_t:"position",ext:"%d",extMeta:"0-100"}},{type:"int",name:"slat position",ref:{value:"angle"}}]},heater:{command:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",ext:"%d",extMeta:"5-30"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",ext:"%e",extMeta:["frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"mode",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}],status:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",unit:"degrees Celsius"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",options:["none","frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"switch",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}],ipevt:[{type:"float",name:"set temperature",ref:{value:"temperature_ctrl::temperature_ctrl",value_t:"setpointTemp",unit:"degrees Celsius"}},{type:"enum",name:"preset mode",ref:{value:"temperature_ctrl::temperature_ctrl_preset",options:["none","frost","eco","comfort"]}},{type:"enum",name:"mode",ref:{value:"switch",value_t:"mode",ext:"%e",extMeta:["auto","manual"]}}]},dimmerrgbw:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness",ext:"%d",extMeta:"0-100"}},{type:"int",name:"color temperature",ref:{value:"color_temperature",value_t:"color_temperature",ext:"%d",extMeta:"800-20000"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness"}},{type:"int",name:"color temperature",ref:{value:"color_temperature",value_t:"color_temperature",unit:"Kelvin"}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"brightness",value_t:"brightness"}}]},socket:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}],ipevt:[{type:"enum",name:"state",ref:{value:"switch",options:["on","off"]}}]},measurement:{command:[],status:[]},rocker_switch:{command:[],status:[],ipevt:[{type:"enum",name:"led status",ref:{value:"status_led",options:["on","off"]}},{type:"enum",name:"up long pressed",ref:{value:"up_request",options:["pressed","released"]}},{type:"enum",name:"down long pressed",ref:{value:"down_request",options:["pressed","released"]}},{type:"enum",name:"pressed",ref:{value:"trigger_request",options:["pressed","released"]}}]},trigger:{command:[],status:[],ipevt:[{type:"enum",name:"led status",ref:{value:"status_led",options:["on","off"]}},{type:"enum",name:"pressed",ref:{value:"trigger_request",options:["pressed","released"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"scene"}}],status:[],ipevt:[]}},SYS:"junghome",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"JUNG HOME"}];},getIPDeviceType:function getIPDeviceType(){return[{sys:xnm.aio.junghome.DM.SYS,name:"JUNG HOME"}];},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e||!e.type)return null;var a=this.getIPevtMap(e);return a?{ipevt:a}:null;},applyUIFilter:function applyUIFilter(e,t,a){if(!e.sys)return null;var _contains=function _contains(e,t){if("*"===e||"*"===e[0])return!0;for(var a=0;a<e.length;a++){if(e[a]==t)return!0;}return!1;},_filter=function _filter(e,t){var n=[],o=null,r=xnm.aio.junghome.DM.getCommandStatusMap(e,a);return r&&(o=function(e,t,a){var n=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(r,0,t),n=n.concat(o)),n;},n=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),n.command=o;break;case"status":o=_filter(e,t),n.status=o;break;default:return null;}return o&&0!=o.length?n:null;},supportSmartWidget:function supportSmartWidget(e,t){return!(!e||!e.type)&&"undefined"!==e.type;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,n,o){if(!t||!t.type)return null;var r=function(e){var t=[];switch(e.type){case"blind":t.push("blind");break;case"shutter":t.push("shutter");break;case"dimmer":t.push("dimmer","switch");break;case"dimmerrgbw":t.push("dimmer","rgb","switch");break;case"socket":case"switch":t.push("switch");break;case"heater":t.push("thermostat");}return t;}(t),s=function(e){var t={};switch(e.type){case"blind":case"shutter":t["%moveTo%"]={value:"level::level",ext:"%d",extMeta:"0-100"},t["%moveDown%"]={value:"Down"},t["%moveUp%"]={value:"Up"},t["%stop%"]={value:"level::level_move"},"blind"===e.type&&(t["%lamellaTo%"]={value:"angle",ext:"%d",extMeta:"0-100"});break;case"dimmer":case"dimmerrgbw":case"socket":case"switch":t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"},t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"},t["%toggle%"]={value:"toggle"},"dimmer"!==e.type&&"dimmerrgbw"!==e.type||(t["%dimTo%"]={value:"brightness",ext:"%d",extMeta:"0-100"}),"dimmerrgbw"===e.type&&(t["%colorTemp%"]={value:"color_temperature",ext:"%d",extMeta:"800-20000"});break;case"heater":t["%thermoTempTo%"]={value:"temperature_ctrl::temperature_ctrl",ext:"%d",extMeta:"5-30"},t["%thermoAuto%"]={value:"mode",ext:"auto"},t["%thermoManu%"]={value:"mode",ext:"manual"};}return t;}(t),i=function(e){var t={};switch(e.type){case"blind":case"shutter":t["%blindState%"]={value:"level::level",extMeta:"0-100"},t["%shutterState%"]={value:"level::level",extMeta:"0-100"},"blind"===e.type&&(t["%lamellaState%"]={value:"angle",extMeta:"0-100"});break;case"dimmer":case"dimmerrgbw":case"socket":case"switch":t["%switchState%"]={value:"switch"},"dimmer"!==e.type&&"dimmerrgbw"!==e.type||(t["%dimmerState%"]={value:"brightness",extMeta:"0-100"}),"dimmerrgbw"===e.type&&(t["%colorTempState%"]={value:"color_temperature",extMeta:"800-20000"});break;case"heater":t["%thermoSetTemp%"]={value:"temperature_ctrl::temperature_ctrl"},t["%thermoMode%"]={value:"switch"};}return t;}(t);return e._injectToSmartWidgetTemplate(n,r,o,s,i);},createDevice:function createDevice(e,t,a){var n=xnm.aio.junghome.DM;e?a(null,e):a(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));},createGateway:function createGateway(e,t,a){var _this6=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee22(){var _t,_a2;return _regeneratorRuntime().wrap(function _callee22$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:_context22.prev=0;_this6._checkGwInfo(e);_t=new xnm.aio.junghome.JungGateway(e,3e4);_context22.next=5;return _t.isJungGateway();case 5:if(_context22.sent){_context22.next=7;break;}throw new xnm.aio.junghome.DM.Error(_this6.Error.ERROR_CODE.NOT_FOUND,"no jung home gateway");case 7:if(!e.username){_context22.next=12;break;}_context22.next=10;return _t.getToken(e.username)["catch"](function(e){if("timeout"==e.message)throw _t.generateJungError("did you press the jung home button?",5);throw e;});case 10:_a2=_context22.sent;e.token=_a2;case 12:a(null,e);_context22.next=18;break;case 15:_context22.prev=15;_context22.t0=_context22["catch"](0);_this6._handleError(_context22.t0,a);case 18:case"end":return _context22.stop();}}},_callee22,null,[[0,15]]);}))();},deleteDevice:function deleteDevice(e,t,a){a();},deleteGateway:function deleteGateway(e,t,a){a();},getCommandStatusMap:function getCommandStatusMap(e,t){var _e$jungInfo;if(!e.type)return null;if(!xnm.aio.junghome.DM.MAP[e.type])return null;var a=JSON.parse(JSON.stringify(xnm.aio.junghome.DM.MAP[e.type]));if(e!==null&&e!==void 0&&(_e$jungInfo=e.jungInfo)!==null&&_e$jungInfo!==void 0&&_e$jungInfo.datapoints){var _t2=e.jungInfo.datapoints.filter(function(e){return"quantity"==e.type;});var _iterator4=_createForOfIteratorHelper(_t2),_step4;try{for(_iterator4.s();!(_step4=_iterator4.n()).done;){var _e6=_step4.value;var _t3={type:"enum",name:"quantity",ref:{value:"quantity::quantity"}};_t3.ref.value="quantity::quantity::".concat(_e6.id);var _n=_e6.values.find(function(e){return"quantity_label"==e.key;});_n&&"NaN"!=_n.value&&(_t3.name=_n.value);var o=_e6.values.find(function(e){return"quantity_unit"==e.key;});o&&(_t3.ref.unit=o.value),a.status.push(_t3);}}catch(err){_iterator4.e(err);}finally{_iterator4.f();}}return a;},getIPevtMap:function getIPevtMap(e){return e.type&&xnm.aio.junghome.DM.MAP[e.type]&&xnm.aio.junghome.DM.MAP[e.type].ipevt||null;},toGeneralDevice:function toGeneralDevice(e){return e?"blind"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},rotation:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100},rotation:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"level",ext:"%d",extMeta:"0-100"},rotation:{value:"angle",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"level",ext:"%d",extMeta:"0-100"},rotation:{value:"angle",ext:"%d",extMeta:"0-100"}}}}:"shutter"===e.type?{type:"blind",commands:{position:{value:{type:"INT",min:0,max:100}},up:{},down:{}},states:{position:{type:"INT",min:0,max:100}},details:{commands:{position:{value:"level",ext:"%d",extMeta:"0-100"},up:{value:"Up"},down:{value:"Down"}},states:{position:{value:"level",ext:"%d",extMeta:"0-100"}}}}:"dimmer"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"}},states:{brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},state:{value:"switch"}}}}:"dimmerrgbw"===e.type?{type:"dimmer",commands:{on:{},off:{},toggle:{},brightness:{value:{type:"INT",min:0,max:100}},color_temperature:{value:{type:"INT",min:800,max:2e4}}},states:{brightness:{type:"INT",min:0,max:100},state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},color_temperature:{value:"color_temperature",ext:"%d",extMeta:"800-20000"}},states:{state:{value:"switch"},brightness:{value:"brightness",ext:"%d",extMeta:"0-100"},color_temperature:{value:"color_temperature",ext:"%d",extMeta:"800-20000"}}}}:"heater"===e.type?{type:"heater",commands:{tempTo:{value:{type:"INT",step:1}}},states:{temperature:{value:{type:"INT",step:1}}},details:{commands:{tempTo:{value:"temperature_ctrl",ext:"%d"}},states:{temperature:{value:"temperature_ctrl"}}}}:"switch"===e.type?{type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"switch"}}}}:null:null;},updateDevice:function updateDevice(e,t,a){var n=xnm.aio.junghome.DM;e?a(null,e):a(new n.Error(n.Error.ERROR_CODE.INVALID,"info is missing"));},updateGateway:function(){var _updateGateway=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee23(e,t,a,n){return _regeneratorRuntime().wrap(function _callee23$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:if(!t){_context23.next=5;break;}_context23.next=3;return this.createGateway(t,a,n);case 3:_context23.next=6;break;case 5:n(new this.Error(this.Error.ERROR_CODE.INVALID,"no new info"));case 6:case"end":return _context23.stop();}}},_callee23,this);}));function updateGateway(_x35,_x36,_x37,_x38){return _updateGateway.apply(this,arguments);}return updateGateway;}(),_checkGwInfo:function _checkGwInfo(e){if(!e)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"info is invalid");if(!e.ip)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"ip is invalid");if(!e.port)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"port is invalid");if(!e.sys||"junghome"!=e.sys)throw new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.INVALID,"sys is invalid");},_handleError:function _handleError(e,t){console.log(e),e.code?t(e,null):t(new xnm.aio.junghome.DM.Error(xnm.aio.junghome.DM.Error.ERROR_CODE.UNKNOWN,e.message?e.message:"unknown error"),null);}},xnm.aio.junghome.DM.Error=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.junghome.DM.Error.prototype=new Error(),xnm.aio.junghome.DM.Error.prototype.name="JungDMError",xnm.aio.junghome.DM.Error.prototype.code=4,xnm.aio.junghome.DM.Error.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.junghome.Handler=function(){var e=require("x.logger.js");e&&(this._logger=e.getLogger("xnm.aio.junghomehome"));},xnm.aio.junghome.Handler.prototype={devicemanager:xnm.aio.junghome.DM,helpers:xnm.aio.junghome.Helpers,discoverWithTimeout:function discoverWithTimeout(e,t){var _this7=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee24(){var a,_n2;return _regeneratorRuntime().wrap(function _callee24$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:_context24.prev=0;a=setTimeout(function(){t&&t(new xnm.aio.junghome.DM.Error(0,"timeout")),t=null;},e);_context24.next=4;return _this7._findGatewaysLocatedInNetwork();case 4:_n2=_context24.sent;t&&t(null,_n2),clearTimeout(a);_context24.next=11;break;case 8:_context24.prev=8;_context24.t0=_context24["catch"](0);_this7._logger.log("error","discoverWithTimeout"),_this7._logger.log("error",_context24.t0),t&&t(_context24.t0,null);case 11:case"end":return _context24.stop();}}},_callee24,null,[[0,8]]);}))();},getDeviceCommands:function getDeviceCommands(e,t){console.log("getDeviceCommands","deviceData",e);var a=xnm.aio.junghome.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=a?a.command:[];t&&t(null,n);},getDeviceList:function getDeviceList(e,t){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee25(){var a;return _regeneratorRuntime().wrap(function _callee25$(_context25){while(1){switch(_context25.prev=_context25.next){case 0:_context25.prev=0;if(e.username){_context25.next=3;break;}return _context25.abrupt("return",void t(new Error("gateway does not have username")));case 3:if(e.token){_context25.next=5;break;}return _context25.abrupt("return",void t(new Error("gateway does not have any token, try to connect to gateway again")));case 5:a=new xnm.aio.junghome.JungGateway(e);if(a.isJungGateway()){_context25.next=8;break;}return _context25.abrupt("return",void t(new Error("gw is not reachable")));case 8:_context25.next=10;return a.getDevices(t);case 10:_context25.next=15;break;case 12:_context25.prev=12;_context25.t0=_context25["catch"](0);t(_context25.t0);case 15:case"end":return _context25.stop();}}},_callee25,null,[[0,12]]);}))();},registModule:function registModule(e){e.register(xnm.aio.junghome.DM.SYS,"junghome");},resolveGateway:function resolveGateway(e){return e?xnm.aio.junghome.parseJSON(e):null;},_findGatewaysLocatedInNetwork:function _findGatewaysLocatedInNetwork(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee26(){var e,t,a,n,o,_i,_n3,_e7,_t4,_iterator5,_step5,_e8,_loop2,_i2,_o;return _regeneratorRuntime().wrap(function _callee26$(_context27){while(1){switch(_context27.prev=_context27.next){case 0:e=[],t=require("os");if(t){_context27.next=3;break;}throw new xnm.aio.junghome.DM.Error(0,"it is not node environment");case 3:a=t.networkInterfaces(),n=Object.keys(a);if(!(!a||0==n.length)){_context27.next=6;break;}throw new xnm.aio.junghome.DM.Error(0,"msg:no_interfaces");case 6:o=[];for(_i=0,_n3=n;_i<_n3.length;_i++){_e7=_n3[_i];_t4=a[_e7];_iterator5=_createForOfIteratorHelper(_t4);try{for(_iterator5.s();!(_step5=_iterator5.n()).done;){_e8=_step5.value;"IPv4"==_e8.family&&1!=_e8.internal&&o.push(_e8);}}catch(err){_iterator5.e(err);}finally{_iterator5.f();}}if(!(o.length>5)){_context27.next=10;break;}throw new xnm.aio.junghome.DM.Error(0,"msg:max_interfaces|5");case 10:_loop2=/*#__PURE__*/_regeneratorRuntime().mark(function _loop2(){var t,a,n,_e9,_t5,_o2,o,r;return _regeneratorRuntime().wrap(function _loop2$(_context26){while(1){switch(_context26.prev=_context26.next){case 0:t=_o[_i2];a=/(\d{1,3}\.\d{1,3}\.\d{1,3})/gm.exec(t.address)[0],n=[];for(_e9=1;_e9<254;_e9++){_t5="".concat(a,".").concat(_e9),_o2=new xnm.aio.junghome.JungGateway({sys:"junghome",ip:_t5,port:443},5e3);n.push(_o2.isJungGateway());}_context26.next=5;return Promise.all(n);case 5:o=_context26.sent;r=1;o.forEach(function(t,a){if(t){var _a3={sys:"junghome",ip:t.ip,port:443,name:"JUNG HOME ".concat(r)};e.push(_a3),r++;}});case 8:case"end":return _context26.stop();}}},_loop2);});_i2=0,_o=o;case 12:if(!(_i2<_o.length)){_context27.next=17;break;}return _context27.delegateYield(_loop2(),"t0",14);case 14:_i2++;_context27.next=12;break;case 17:return _context27.abrupt("return",e);case 18:case"end":return _context27.stop();}}},_callee26);}))();},doCommand:function doCommand(e,t,a,n){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,a,function(e){n&&n(e);}):n&&n(new Error("gateway json format invalid"));},doStatus:function doStatus(e,t,a,n,o){var r=this.resolveGateway(t);if(r){var s=[{id:e,device:a,status:n}];r.getStatesCreator(null,s,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.junghome.Handler());