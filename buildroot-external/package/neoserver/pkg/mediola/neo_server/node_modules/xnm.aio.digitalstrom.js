var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.digitalstrom=xnm.aio.digitalstrom||{},xnm.aio.digitalstrom.Server=function(){var e={0:"Broadcast",1:"Light",2:"Shading",3:"Heating",4:"Audio",5:"Video",6:"Security",7:"Access",8:"Joker",9:"Cooling",10:"Room ventilation",11:"Window",12:"Recirculation",48:"Temperature control",64:"Apartment ventilation"},t={0:"Preset 0",1:"Area 1 Off",2:"Area 2 Off",3:"Area 3 Off",4:"Area 4 Off",5:"Preset 1",6:"Area 1 On",7:"Area 2 On",8:"Area 3 On",9:"Area 4 On",10:"Area Stepping Continue",11:"Decrement",12:"Increment",13:"Minimum",14:"Maximum",15:"Stop",17:"Preset 2",18:"Preset 3",19:"Preset 4",20:"Preset 12",21:"Preset 13",22:"Preset 14",23:"Preset 22",24:"Preset 23",25:"Preset 24",26:"Preset 32",27:"Preset 33",28:"Preset 34",29:"Preset 42",30:"Preset 43",31:"Preset 44",32:"Preset 10",33:"Preset 11",34:"Preset 20",35:"Preset 21",36:"Preset 30",37:"Preset 31",38:"Preset 40",39:"Preset 41",40:"Auto Off",41:"Impulse",42:"Area 1 Decrement",43:"Area 1 Increment",44:"Area 2 Decrement",45:"Area 2 Increment",46:"Area 3 Decrement",47:"Area 3 Increment",48:"Area 4 Decrement",49:"Area 4 Increment",50:"Device Off",51:"Device On",52:"Area 1 Stop",53:"Area 2 Stop",54:"Area 3 Stop",55:"Area 4 Stop",56:"Sun protection"},n={64:"Auto Standby",65:"Panic",67:"Standby",68:"Deep Off",69:"Sleeping",70:"Wakeup",71:"Present",72:"Absent",73:"Door Bell",74:"Alarm",75:"Zone Active",76:"Fire",77:"Smoke",78:"Water",79:"Gas",80:"Bell 2",81:"Bell 3",82:"Bell 4",83:"Alarm 2",84:"Alarm 3",85:"Alarm 4",86:"Wind",87:"No Wind",88:"Rain",89:"No Rain",90:"Hail",91:"No Hail"},_System=function _System(e){this._server=e;};_System.prototype._requestApplicationToken=function(e,t){this._doSystemRequest("requestApplicationToken",{applicationName:e},function(e,n){e?t&&t(e):t&&t(null,n.applicationToken);});},_System.prototype._login=function(e,t,n){this._doSystemRequest("login",{user:e,password:t},function(e,t){e?n&&n(e):n&&n(null,t.token);});},_System.prototype._enableToken=function(e,t,n){this._doSystemRequest("enableToken",{applicationToken:e,token:t},function(e){n&&n(e);});},_System.prototype._loginApplication=function(e,t){e?this._doSystemRequest("loginApplication",{loginToken:e},function(e,n){e?t&&t(e):t&&t(null,n.token);}):t&&t(new Error("loginToken is empty"));},_System.prototype._doSystemRequest=function(e,t,n){this._server._doJsonRequest("/system/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var _Apartment=function _Apartment(e){this._server=e;};_Apartment.prototype._getName=function(e){this._doApartmentRequest("getName",null,function(t,n){t?e&&e(t):n?e&&e(null,n.name):e&&e(new Error("apartment getName result invalid"));});},_Apartment.prototype._getSensorValues=function(e){this._doApartmentRequest("getSensorValues",null,function(t,n){t?e&&e(t):n?e&&e(null,n):e&&e(new Error("apartment getSensorValues result invalid"));});},_Apartment.prototype._getTemperatureControlStatus=function(e){this._doApartmentRequest("getTemperatureControlStatus",null,function(t,n){t?e&&e(t):n?e&&e(null,n):e&&e(new Error("apartment getTemperatureControlStatus result invalid"));});},_Apartment.prototype._getStructure=function(e){this._doApartmentRequest("getStructure",null,function(t,n){t?e&&e(t):e&&e(null,n);});},_Apartment.prototype._callScene=function(e,t){e?void 0!==e.sceneNumber&&null!=e.sceneNumber?this._doApartmentRequest("callScene",e,function(e,n){e?t&&t(e):t&&t(null,n);}):t&&t(new Error("sceneNumber invalid")):t&&t(new Error("params invalid"));},_Apartment.prototype._doApartmentRequest=function(e,t,n){this._server._doJsonRequest("/apartment/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var _Zone=function _Zone(e){this._server=e;};_Zone.prototype._getReachableScenes=function(e,t,n){if(void 0!==e&&null!=e){if(void 0!==t&&null!=t){var a={id:e,groupID:t};this._doZoneRequest("getReachableScenes",a,n);}else n&&n(new Error("groupID invalid"));}else n&&n(new Error("id invalid"));},_Zone.prototype._callScene=function(e,t,n){t?void 0!==t.sceneNumber&&null!=t.sceneNumber?void 0!==e&&null!=e?(t.id=e,this._doZoneRequest("callScene",t,n)):n&&n(new Error("id invalid")):n&&n(new Error("sceneNumber invalid")):n&&n(new Error("params invalid"));},_Zone.prototype._doZoneRequest=function(e,t,n){this._server._doJsonRequest("/zone/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var _Device=function _Device(e){this._server=e;};_Device.prototype._turnOn=function(e,t){this._doDeviceRequest("turnOn",e,t);},_Device.prototype._turnOff=function(e,t){this._doDeviceRequest("turnOff",e,t);},_Device.prototype._increaseValue=function(e,t){this._doDeviceRequest("increaseValue",e,t);},_Device.prototype._decreaseValue=function(e,t){this._doDeviceRequest("decreaseValue",e,t);},_Device.prototype._callScene=function(e,t){e?void 0!==e.sceneNumber&&null!=e.sceneNumber?this._doDeviceRequest("callScene",e,t):t&&t(new Error("sceneNumber invalid")):t&&t(new Error("params invalid"));},_Device.prototype._doDeviceRequest=function(e,t,n){t?void 0!==t.dsid&&null!=t.dsid||t.name?this._server._doJsonRequest("/device/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);}):n&&n(new Error("no dsid or name")):n&&n(new Error("params invalid"));};var _Property=function _Property(e){this._server=e;};_Property.prototype._getMeters=function(e){this._query("/apartment/dSMeters/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n.dSMeters&&(a=n.dSMeters),e&&e(null,a);}});},_Property.prototype._getUsrEvent=function(e){this._query("/usr/events/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n.events&&(a=n.events),e&&e(null,a);}});},_Property.prototype._getUsrDefinedStates=function(e){this._query("/usr/addon-states/system-addon-user-defined-states/*(*)",function(t,n){if(t)e&&e(t);else{var a=[];n&&n["system-addon-user-defined-states"]&&(a=n["system-addon-user-defined-states"]),e&&e(null,a);}});},_Property.prototype._query=function(e,t){this._doPropertyRequest("query",{query:e},function(e,n){e?t&&t(e):t&&t(null,n);});},_Property.prototype._query2=function(e,t){this._doPropertyRequest("query2",{query:e},function(e,n){e?t&&t(e):t&&t(null,n);});},_Property.prototype._doPropertyRequest=function(e,t,n){this._server._doJsonRequest("/property/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);});};var _Event=function _Event(e){this._server=e;};_Event.prototype._raise=function(e,t){e?e.name?this._doEventRequest("raise",e,t):t&&t(new Error("name invalid")):t&&t(new Error("params invalid"));},_Event.prototype._doEventRequest=function(e,t,n){t?void 0!==t.dsid&&null!=t.dsid||t.name?this._server._doJsonRequest("/event/"+e,t,function(e,t){e?n&&n(e):n&&n(null,t);}):n&&n(new Error("no dsid or name")):n&&n(new Error("params invalid"));};var Server=function Server(e,t,n){var a=require("x.logger.js");this._logger=a?a.getLogger("xnm.aio.digitalstrom.Server"):{log:function log(){}},this.ip=e,this.port=t,t||(this.port=8080),this.applicationToken=n,this.sessionToken=null,this._getSessionTokenCBs=[],this._system=new _System(this),this._apartment=new _Apartment(this),this._zone=new _Zone(this),this._device=new _Device(this),this._property=new _Property(this),this._event=new _Event(this);};return Server.HEAT_CONTROL_MODE=["off","pid_control","zone_follower","fixed_value","manual"],Server.HEAT_OP_MODE=["off","comfort","economy","not_used","night","holiday","cooling","cooling_off"],Server.prototype._doRequest=function(e,t,n){if(e||(e="/"),t||(t={}),this.sessionToken&&(t.token=this.sessionToken),t)for(var a in e+="?",t){e+=a+"="+encodeURI(t[a])+"&";}"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var r={host:this.ip,port:this.port,path:e,method:"GET",headers:{"Content-Type":'text/html; charset="UTF-8"',"Content-Length":0,Connection:"close",rejectUnauthorized:!1,requestCert:!0}},o=this;this._logger.log("trace","do https request:"+JSON.stringify(r));var i=require("https").request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){o._logger.log("trace","receive https response:"+t+" with code:"+e.statusCode),n&&n(null,t,e.statusCode),n=null;});});i.on("error",function(e){o._logger.log("warn","do https request error:"+e.message),n&&n(e),n=null;}),i.setTimeout(1e4,function(){o._logger.log("warn","do https request timeout");var e=new Error("timeout");e.reason="timeout",n&&n(e),n=null;}),i.end();},Server.prototype._doJsonRequest=function(e,t,n){var a=this,r=e;r||(r="/"),r="/json"+r,this._doRequest(r,t,function(r,o,i){if(r)n&&n(r);else if(403==i)a.getSessionToken(function(r){r?n&&n(r):a._doJsonRequest(e,t,n);});else try{var s=JSON.parse(o);if(!s.ok)return void(n&&n(new Error("json response error:"+s.message)));n&&n(null,s.result);}catch(e){n&&n(e);}});},Server.prototype._getReachableScenes=function(e,t){var n=null,a=0,r=this,cb=function cb(o,i){!o&&i&&(n||(n={}),n[e[a].zoneID+"."+e[a].groupID]=i),++a>=e.length?t&&t(null,n):r._zone._getReachableScenes(e[a].zoneID,e[a].groupID,cb);};this._zone._getReachableScenes(e[a].zoneID,e[a].groupID,cb);},Server.prototype.getSessionToken=function(e){if(this.applicationToken){var t=this._getSessionTokenCBs.length;if(e&&-1==this._getSessionTokenCBs.indexOf(e)&&this._getSessionTokenCBs.push(e),0==t){var n=this;this._system._loginApplication(this.applicationToken,function(t,a){if(t)e&&e(t);else{n.sessionToken=a;var r=n._getSessionTokenCBs;n._getSessionTokenCBs=[];for(var o=0;o<r.length;o++){r[o](null,a);}}});}}else e&&e(new Error("applicationToken is empty"));},Server.prototype.getDevices=function(t){var _getSceneNames=function _getSceneNames(e,t,n){if(!n)return null;var a=n[e+"."+t];if(!a||!a.userSceneNames)return null;for(var r=null,o=0;o<a.userSceneNames.length;o++){var i=a.userSceneNames[o];i&&i.sceneNr&&i.sceneName&&(r||(r={}),r[i.sceneNr]=i.sceneName);}return r;},_getReachableScenes=function _getReachableScenes(e,t,n){if(!n)return null;var a=n[e+"."+t];return a?a.reachableScenes:null;},_getZoneSensors=function _getZoneSensors(e,t){if(!t||!t.zones)return null;for(var n=0;n<t.zones.length;n++){var a=t.zones[n];if(a&&a.id==e)return a.values;}return null;},_getZoneHeating=function _getZoneHeating(e,t){if(!t||!t.zones)return null;for(var n=0;n<t.zones.length;n++){var a=t.zones[n];if(a&&a.id==e&&0!=a.IsConfigured){var r=[];for(var o in a){"ControlMode"!=o&&"OperationMode"!=o&&"TemperatureValue"!=o&&"NominalValue"!=o&&"ControlValue"!=o||r.push(o);}return r;}}return null;},n=this,a={apartment:null};this._apartment._getName(function(r,o){if(r)t&&t(r);else{o||(o="Apartment"),a.apartment={type:"apartment",name:o,meters:[],devices:[],zones:[],events:[],uds:[]};var i=0,cb=function cb(e){i++,e?(t&&t(e),t=null):4==i&&(t&&t(null,a),t=null);};n._apartment._getTemperatureControlStatus(function(t,r){n._apartment._getSensorValues(function(t,o){!t&&o&&o.outdoor&&(a.apartment.outdoor=o.outdoor),n._apartment._getStructure(function(t,i){if(t)cb(t);else{var s=[];if(i&&i.apartment&&i.apartment.zones)for(var u=0;u<i.apartment.zones.length;u++){for(var l=i.apartment.zones[u],p=0;p<l.groups.length;p++){var c=l.groups[p];0!=c.id&&c.devices.length>0&&s.push({zoneID:l.id,groupID:c.id});}}n._getReachableScenes(s,function(t,n){if(t)cb(t);else{if(i&&i.apartment&&i.apartment.zones)for(var s=0;s<i.apartment.zones.length;s++){var u=i.apartment.zones[s],l={type:"zone",zoneID:u.id,name:u.name,groups:[]},p=_getZoneSensors(u.id,o);p&&(l.sensorValues=p);var c=_getZoneHeating(u.id,r);if(c&&(l.heating=c),0==u.id){u.name||(l.name="All Devices");for(var d=0;d<u.devices.length;d++){var f=u.devices[d],m={type:"device",name:f.name,dsid:f.id,zoneID:f.zoneID,groups:f.groups};a.apartment.devices.push(m);}}for(var v=0;v<u.groups.length;v++){var g=u.groups[v];if(0!=g.id&&g.applicationType&&g.devices.length>0){var y={type:"group",name:e[g.id],zoneID:u.id,groupID:g.id,applicationType:g.applicationType,reachableScenes:_getReachableScenes(u.id,g.id,n),sceneNames:_getSceneNames(u.id,g.id,n)};l.groups.push(y);}}a.apartment.zones.push(l);}cb();}});}});});}),n._property._getMeters(function(e,t){if(e)cb(e);else{if(t)for(var n=0;n<t.length;n++){if(t[n].dSID){var r={type:"meter",name:t[n].name,dsid:t[n].dSID};a.apartment.meters.push(r);}}cb();}}),n._property._getUsrEvent(function(e,t){if(e)cb(e);else{if(t)for(var n=0;n<t.length;n++){if(t[n].id){var r={type:"event",name:t[n].name,id:t[n].id};a.apartment.events.push(r);}}cb();}}),n._property._getUsrDefinedStates(function(e,t){if(e)cb(e);else{if(t)for(var n=0;n<t.length;n++){if(t[n].name){var r={type:"uds",name:t[n].displayName,id:t[n].name,setName:t[n].setName,resetName:t[n].resetName};a.apartment.uds.push(r);}}cb();}});}});},Server.prototype.registApplication=function(e,t,n){var a=this;this._system._requestApplicationToken("mediola",function(r,o){r?n&&n(r):a._system._login(e,t,function(e,t){e?n&&n(e):a._system._enableToken(o,t,function(e){n&&n(e,o);});});});},Server.prototype.executeCommand=function(e,t,n){var a;if(e&&e.type){if(t&&t.value)switch(e.type){case"apartment":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._apartment._callScene({sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"zone":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._zone._callScene(e.zoneID,{sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"group":if("callScene"===t.value){if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._zone._callScene(e.zoneID,{groupID:e.groupID,sceneNumber:a},n);}else n&&n(new Error("unknown command:"+t.value));break;case"device":switch(t.value){case"callScene":if(a=parseInt(t.ext),isNaN(a)||a<0||a>128)return void(n&&n(new Error("scene number invalid")));this._device._callScene({dsid:e.dsid,sceneNumber:a},n);break;case"turnOn":this._device._turnOn({dsid:e.dsid},n);break;case"turnOff":this._device._turnOff({dsid:e.dsid},n);break;case"decreaseValue":this._device._decreaseValue({dsid:e.dsid},n);break;case"increaseValue":this._device._increaseValue({dsid:e.dsid},n);break;default:n&&n(new Error("unknown command:"+t.value));}break;case"event":if("run"===t.value){if(!e.id)return void(n&&n(new Error("device id invalid")));this._event._raise({name:"highlevelevent",parameter:"id="+e.id},n);}else n&&n(new Error("unknown command:"+t.value));break;default:n&&n(new Error("unknown device type:"+e.type));}else n&&n(new Error("command format invalid"));}else n&&n(new Error("device format invalid"));},Server.prototype.executeCommandCreator=function(e,a,r){if(a&&a.value){if(e&&e.type){var o={value:"callScene",ext:0},i=null;if("turnOn"==a.value||"turnOff"==a.value||"increaseValue"==a.value||"decreaseValue"==a.value||"run"==a.value)o.value=a.value;else if("callScene"==a.value){if(i=parseInt(a.ext),isNaN(i))return void(r&&r(new Error("callScene value invalid")));o.ext=i;}else if("doActivity"==a.value){if(!a.ext)return void(r&&r(new Error("doActivity value invalid")));var s=!1;for(var u in t){if(a.ext==t[u]){i=parseInt(u),s=!0;break;}}if(!s)for(var u in n){if(a.ext==n[u]){i=parseInt(u),s=!0;break;}}if(!s)return void(r&&r(new Error("unknown doActivity:"+a.ext)));o.ext=i;}else{if("doScene"!=a.value.substr(0,7))return void(r&&r(new Error("unknown command:"+a.value)));if(i=parseInt(a.value.substr(7)),isNaN(i))return void(r&&r(new Error("doScene value invalid")));o.ext=i;}var l=null;switch(e.type){case"apartment":case"zone":case"group":case"device":case"event":l=e;break;default:r&&r(new Error("unknown device type:"+e.type));}this.executeCommand(l,o,function(e){r&&r(e);});}else r&&r(new Error("device json invalid"));}else r&&r(new Error("command json invalid"));},Server.prototype.getStatesCreator=function(e,t,n){var _unescape=function _unescape(e){return e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");};if(t){if(0!=t.length){if(t){var a=[],r={},o={},i={},s={},u=this;this._property._getUsrDefinedStates(function(e,l){var p,c;if(!e&&l)for(p=0;p<l.length;p++){(c=l[p]).name&&(s[c.name]={stateTxt:1==c.value?_unescape(c.setName):_unescape(c.resetName),stateF:1==c.value?parseFloat(c.setName):parseFloat(c.resetName)});}u._property._getMeters(function(e,l){var p,c,d;if(!e&&l)for(p=0;p<l.length;p++){(d=l[p]).dSID&&(r[d.dSID]=d);}u._apartment._getSensorValues(function(e,l){if(!e&&l&&(l.outdoor&&(i=l.outdoor),l.zones))for(p=0;p<l.zones.length;p++){var f=l.zones[p];if(o[f.id]={},f.values)for(c=0;c<f.values.length;c++){for(var m in f.values[c]){o[f.id][m]=f.values[c][m];}}}u._apartment._getTemperatureControlStatus(function(e,u){if(!e&&u&&u.zones)for(p=0;p<u.zones.length;p++){var l=u.zones[p];o[l.id]||(o[l.id]={}),void 0!==l.ControlMode&&null!=l.ControlMode&&(o[l.id].ControlMode=Server.HEAT_CONTROL_MODE[l.ControlMode]),void 0!==l.OperationMode&&null!=l.OperationMode&&(o[l.id].OperationMode=Server.HEAT_OP_MODE[l.OperationMode]),void 0!==l.TemperatureValue&&null!=l.TemperatureValue&&(o[l.id].TemperatureValue=l.TemperatureValue),void 0!==l.NominalValue&&null!=l.NominalValue&&(o[l.id].NominalValue=l.NominalValue),void 0!==l.ControlValue&&null!=l.ControlValue&&(o[l.id].ControlValue=l.ControlValue);}var c;for(p=0;p<t.length;p++){if(t[p]){var f=t[p].id,m=t[p].device,v=t[p].status;f&&v&&v.value&&m&&m.type&&("meter"==m.type&&m.dsid?(d=r[m.dsid])&&(c=d[v.value]):"uds"==m.type&&m.id?(d=s[m.id])&&(c=d[v.value]):"apartment"==m.type?(d=i[v.value])&&(c=d.value):"zone"==m.type&&m.zoneID&&(d=o[m.zoneID])&&(c=d[v.value]),void 0!==c&&null!=c||(c="?"),a.push({id:f,status:c}));}}n&&n(null,a);});});});});}else n&&n(new Error("deviceList is null"));}else n&&n(null,[]);}else n&&n(new Error("deviceList is null"));},Server.prototype.toJSON=function(){return{sys:"digitalstrom",ip:this.ip,port:this.port,token:this.applicationToken};},Server.prototype.equalsTo=function(e){return!!e&&e instanceof Server&&this.ip==e.ip&&this.port==e.port&&this.applicationToken==e.applicationToken;},Server.GROUP_NAMES=e,Server.GROUP_SCENE=t,Server.NON_GROUP_SCENE=n,Server.GROUP_DEFAULT_SCENES={1:[0,5,17,18,19,40],2:[0,5,15,17,18,19],3:[0,1,2,4,5],4:[0,5,17,18,19],5:[0,5,17,18,19],9:[6,7,8,10,11],10:[0,5,17,18,19,33,35,36,37],11:[0,5,17,18,19,33,35,36,37],12:[0,5,17,18,19,33,35,36,37],48:[0,1,2,4,5,6,7,8,10,11],64:[0,5,17,18,19,33,35,36,37]},Server.GROUP_SPECIAL_SCENE_NAME={1:{0:"Off",40:"Fade Off"},2:{0:"Up",5:"Down"},3:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night"},4:{0:"Off"},5:{0:"Off"},9:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday"},10:{0:"Off",5:"Level 1",17:"Level 2",18:"Level 3",19:"Level 4",33:"Automatic (air flow intensity)",35:"Auto (louver swing mode)",36:"Boost",37:"Noise Reduction"},48:{0:"Heating Off",1:"Heating Comfort",2:"Heating Economy",3:"Heating Not Used",4:"Heating Night",5:"Heating Holiday",6:"Cooling Off",7:"Cooling Comfort",8:"Cooling Economy",9:"Cooling Not Used",10:"Cooling Night",11:"Cooling Holiday"}},Server;}(),xnm.aio.digitalstrom.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="DigitalStromDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"digitalstrom",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"digitalSTROM"}];},getGatewayDeviceType:function getGatewayDeviceType(){return[];},createGateway:function createGateway(e,t,n){var a=DMError,r=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new a(r.INVALID,"ip is invalid")):n(new a(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,a){var r=DMError,o=DMError.ERROR_CODE;t?t.ip?t.username?t.password?a(null,t):a(new r(o.INVALID,"password is invalid")):a(new r(o.INVALID,"username is invalid")):a(new r(o.INVALID,"ip is invalid")):a(new r(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var a=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,i,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){i=s[o];break;}}i?n(null,e):n(new a(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(r.INVALID,"type is invalid"));}else n(new a(r.INVALID,"gateway is invalid"));}else n(new a(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var a=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,i,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){i=s[o];break;}}i?n(null,e):n(new a(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new a(r.INVALID,"type is invalid"));}else n(new a(r.INVALID,"gateway is invalid"));}else n(new a(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t){var n=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var n=!1,a=0;a<e.length;a++){if(e[a]==t){n=!0;break;}}return n;},_filter=function _filter(e,t){var a=[],r=null,o=n.getCommandStatusMap(e);return o&&(r=function(e,t,n){var a=[];switch(n.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(n.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});}return a;}(o,0,t),a=a.concat(r)),a;};if(!e||null==e.type||void 0===e.type)return null;var a=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),a.command=r;break;case"status":r=_filter(e,t),a.status=r;break;default:return null;}return r&&0!=r.length?a:null;},getCommandStatusMap:function getCommandStatusMap(e){var t,_getGroupRelatedScene=function _getGroupRelatedScene(){var e=xnm.aio.digitalstrom.Server.GROUP_SCENE,t=[];for(var n in e){e[n]&&t.push(e[n]);}return t;},n={command:[],status:[]};if(!e||!e.type)return null;if("event"==e.type)return n.command=[{type:"enum",name:"run",ref:{value:"run"}}],n;if("uds"==e.type)return n.status=[{type:"string",name:"state (string)",ref:{value:"stateTxt"}},{type:"float",name:"state (float)",ref:{value:"stateF"}}],n;switch(e.type){case"apartment":n.command=[{type:"enum",name:"Absent",ref:{value:"doScene72"}},{type:"enum",name:"Present",ref:{value:"doScene71"}},{type:"enum",name:"Door Bell",ref:{value:"doScene73"}},{type:"enum",name:"Rain",ref:{value:"doScene88"}},{type:"enum",name:"No Rain",ref:{value:"doScene89"}},{type:"enum",name:"Wind",ref:{value:"doScene86"}},{type:"enum",name:"No Wind",ref:{value:"doScene87"}},{type:"enum",name:"Hail",ref:{value:"doScene90"}},{type:"enum",name:"No Wind",ref:{value:"doScene91"}},{type:"enum",name:"Panic",ref:{value:"doScene65"}},{type:"enum",name:"Fire",ref:{value:"doScene76"}},{type:"enum",name:"Alarm 1",ref:{value:"doScene74"}},{type:"enum",name:"Alarm 2",ref:{value:"doScene83"}},{type:"enum",name:"Alarm 3",ref:{value:"doScene84"}},{type:"enum",name:"Alarm 4",ref:{value:"doScene85"}}];break;case"zone":n.command=[{type:"enum",name:"Standby",ref:{value:"doScene67"}},{type:"enum",name:"Deep off",ref:{value:"doScene68"}},{type:"enum",name:"Sleeping",ref:{value:"doScene69"}},{type:"enum",name:"Wake up",ref:{value:"doScene70"}}];break;case"group":var a=xnm.aio.digitalstrom.Server.GROUP_DEFAULT_SCENES[e.applicationType];if(a||(a=[]),e.reachableScenes)for(var r=0;r<e.reachableScenes.length;r++){-1==a.indexOf(e.reachableScenes[r])&&a.push(e.reachableScenes[r]);}if(e.sceneNames)for(var o in e.sceneNames){-1==a.indexOf(parseInt(o))&&a.push(parseInt(o));}for(var i=0;i<a.length;i++){var s=a[i],u=null;if(e.sceneNames&&(u=e.sceneNames[s]),!u){var l=xnm.aio.digitalstrom.Server.GROUP_SPECIAL_SCENE_NAME[e.applicationType];l&&(u=l[s]);}u||(u=xnm.aio.digitalstrom.Server.GROUP_SCENE[s]),u&&n.command.push({type:"enum",name:u,ref:{value:"doScene"+s}});}break;case"device":if(e.groups)for(var p=[],c=0;c<e.groups.length;c++){var d=[];switch(e.groups[c]){case 1:d=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}},{type:"enum",name:"up",ref:{value:"increaseValue"}},{type:"enum",name:"down",ref:{value:"decreaseValue"}}];break;case 2:d=[{type:"enum",name:"move down",ref:{value:"turnOn"}},{type:"enum",name:"move up",ref:{value:"turnOff"}},{type:"enum",name:"step down",ref:{value:"increaseValue"}},{type:"enum",name:"step up",ref:{value:"decreaseValue"}}];break;case 4:case 5:d=[{type:"enum",name:"on",ref:{value:"turnOn"}},{type:"enum",name:"off",ref:{value:"turnOff"}}];}for(var f=0;f<d.length;f++){var m=d[f];-1==p.indexOf(m.ref.value)&&(n.command.push(m),p.push(m.ref.value));}}}switch(e.type){case"apartment":case"zone":t=(t=_getGroupRelatedScene()).concat(function(){var e=xnm.aio.digitalstrom.Server.NON_GROUP_SCENE,t=[];for(var n in e){e[n]&&t.push(e[n]);}return t;}()),n.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:t}});break;case"group":case"device":t=_getGroupRelatedScene(),n.command.push({type:"enum",name:"do activity",ref:{value:"doActivity",ext:"%e",extMeta:t}});}n.command.push({type:"int",name:"call scene",ref:{value:"callScene",ext:"%d",extMeta:"0-127"}});var v=null;switch(e.type){case"apartment":if(e.outdoor)for(var o in e.outdoor){switch(o){case"temperature":n.status.push({type:"float",name:"temperature",ref:{value:"temperature"}});break;case"humidity":n.status.push({type:"float",name:"humidity",ref:{value:"humidity"}});break;case"windspeed":n.status.push({type:"float",name:"wind speed",ref:{value:"windspeed"}});break;case"winddirection":n.status.push({type:"float",name:"wind direction",ref:{value:"winddirection"}});break;case"gustspeed":n.status.push({type:"float",name:"gust speed",ref:{value:"gustspeed"}});break;case"gustdirection":n.status.push({type:"float",name:"gust direction",ref:{value:"gustdirection"}});break;case"precipitation":n.status.push({type:"float",name:"precipitation",ref:{value:"precipitation"}});break;case"airpressure":n.status.push({type:"float",name:"air pressure",ref:{value:"airpressure"}});}}break;case"zone":var g=!1;if(e.sensorValues)for(r=0;r<e.sensorValues.length;r++){(v=e.sensorValues[r])&&(void 0!==v.TemperatureValue&&null!=v.TemperatureValue&&(g=!0,n.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}})),void 0!==v.HumidityValue&&null!=v.HumidityValue&&n.status.push({type:"float",name:"humidity",ref:{value:"HumidityValue"}}),void 0!==v.CO2ConcentrationValue&&null!=v.CO2ConcentrationValue&&n.status.push({type:"float",name:"co2",ref:{value:"CO2ConcentrationValue"}}),void 0!==v.BrightnessValue&&null!=v.BrightnessValue&&n.status.push({type:"float",name:"brightness",ref:{value:"BrightnessValue"}}));}if(e.heating)for(r=0;r<e.heating.length;r++){switch(v=e.heating[r]){case"ControlMode":n.status.push({type:"enum",name:"control mode",ref:{value:"ControlMode",options:["off","pid_control","zone_follower","fixed_value","manual"]}});break;case"OperationMode":n.status.push({type:"enum",name:"operation mode",ref:{value:"OperationMode",options:["off","comfort","economy","not_used","night","holiday","cooling","cooling_off"]}});break;case"TemperatureValue":g||n.status.push({type:"float",name:"temperature",ref:{value:"TemperatureValue"}});break;case"NominalValue":n.status.push({type:"float",name:"target temperature",ref:{value:"NominalValue"}});break;case"ControlValue":n.status.push({type:"float",name:"control value",ref:{value:"ControlValue"}});}}break;case"meter":n.status.push({type:"float",name:"power",ref:{value:"powerConsumption",unit:"W"}}),n.status.push({type:"float",name:"energy meter",ref:{value:"energyMeterValue",unit:"Wh"}});}return n;}};}(),xnm.aio.digitalstrom.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Server=xnm.aio.digitalstrom.Server,Handler.prototype.devicemanager=xnm.aio.digitalstrom.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"digitalstrom");},Handler.prototype.resolveGateway=function(e){return e&&e.ip&&e.token?new this.Server(e.ip,e.port,e.token):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),a=n?n.command:[];t&&t(null,a);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),a=n?n.status:[];t&&t(null,a);},Handler.prototype.doCommand=function(e,t,n,a){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,n,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,n,a,r){var o=this.resolveGateway(t);if(o){var i=[{id:e,device:n,status:a}];o.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.discover=function(e,t){var n=require("x.mdns.js");n.clearRecordBuffer(),n.discoverServiceWithTimeout("_http._tcp.local",e,function(e,n){if(e)t&&t(e);else{for(var a=[],r=0;r<n.length;r++){var o=n[r];if(o.target&&o.ip&&o.ip.length>0)if("dss.local"==o.target.toLowerCase()){var i=new xnm.aio.digitalstrom.Server(o.ip[0],8080);a.push(i);}}t&&t(e,a);}});},Handler.prototype.registApplication=function(e,t,n,a){if(!e||!e.ip)return null;new this.Server(e.ip,e.port).registApplication(t,n,function(e,t){a&&a(e,t);});},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.digitalstrom.Handler());