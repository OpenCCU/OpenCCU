var util=require("util"),EventEmitter=require("events");var x=x||{};x.hub=x.hub||{},x.hub.peripheralman=x.hub.peripheralman||{},x.hub.peripheralman.PeripheralManager=function(){var PM=function PM(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.PeripheralManager"),this._peripherals=[];};return PM.FILE_NAME="pm.json",PM.prototype.init=function(e){var r=this;this._load(function(i){i?e&&e(i):(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION||global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM||r._initUdevMonitor(),e&&e());});},PM.prototype.getUSBDevices=function(){return this._peripherals;},PM.prototype._load=function(e){var r=this,i=require("fs-extra"),t=require("x.hub.fileman.js").fileManager,n=require("path"),a=t.getUserRootDataPath(),o=n.resolve(a,PM.FILE_NAME);i.ensureFile(o,function(i){i?e&&e(i):r._loadData(o,function(i,t){i?e&&e(i):(r._peripherals=t,e&&e());});});},PM.prototype._loadData=function(e,r){require("fs").readFile(e,"utf8",function(e,i){if(e)r&&r(e);else if(i)try{var t=JSON.parse(i);r&&r(null,t);}catch(e){r&&r(e);}else r&&r(null,[]);});},PM.prototype._initUdevMonitor=function(){var e=require("udev").monitor();e.on("add",this._onAdd.bind(this)),e.on("remove",this._onRemove.bind(this)),e.on("change",this._onChange.bind(this));var r=this._listSerialDev(),i=this;r&&r.forEach(function(e){var r=i._udev2dev(e);r&&i._onFindUsbDevice(r);});},PM.prototype._listSerialDev=function(){if(global&&"EA"!=global.HARDWARE_VERSION&&"CA"!=global.HARDWARE_VERSION)return null;if(global&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM)return null;var e=require("udev"),r=e.list("tty"),i=e.list("net"),t=[];return r&&(t=t.concat(r)),i&&(t=t.concat(i)),t;},PM.prototype._isSameDev=function(e,r){var i;for(i in e){if(e.hasOwnProperty(i)&&e[i]!=r[i])return!1;}for(i in r){if(r.hasOwnProperty(i)&&e[i]!=r[i])return!1;}return!0;},PM.prototype._onAdd=function(e){this._logger.log("trace","add: "+JSON.stringify(e));var r=this._udev2dev(e);r&&this._onFindUsbDevice(r);},PM.prototype._onRemove=function(e){this._logger.log("trace","remove: "+JSON.stringify(e));var r=this._udev2dev(e);r&&this._onRemoveUsbDevice(r);},PM.prototype._onChange=function(e){this._logger.log("trace","changed: "+JSON.stringify(e));},PM.prototype._udev2dev=function(e){if(!e||"usb"!=e.ID_BUS)return null;var r=e.DEVNAME,i={};for(var t in e){e.hasOwnProperty(t)&&"ID"==t.substr(0,2)&&(i[t]=e[t]);}if("wlan"==e.DEVTYPE&&e.INTERFACE&&(r=e.INTERFACE),!r)return null;var n={port:r,info:i};return"EnOcean_GmbH"==i.ID_VENDOR&&i.ID_USB_DRIVER?n.type="enocean":"0658"==i.ID_VENDOR&&i.ID_USB_DRIVER?n.type="zwave":"0451"==i.ID_VENDOR_ID&&"16a8"==i.ID_MODEL_ID&&i.ID_USB_DRIVER?n.type="zigbee":"2341"==i.ID_VENDOR_ID&&"8036"==i.ID_MODEL_ID&&i.ID_USB_DRIVER?n.type="mbus":"wlan0"!=n.port&&"wlan1"!=n.port||(n.type="wlan"),n;},PM.prototype._onFindUsbDevice=function(e){for(var r=this._peripherals.length,i=!1,t=null;r;){if(r--,t=this._peripherals[r],this._isSameDev(t.info,e.info)){i=!0,t.port=e.port;break;}}i||((t=e).type||t.info&&t.info.ID_USB_DRIVER)&&this._peripherals.push(t);var n=require("x.hub.eventbus.js");switch(t.type){case"enocean":this._logger.log("debug","add enocean stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.ADD_ENOCEAN",t);break;case"zwave":this._logger.log("debug","add zwave stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.ADD_ZWAVE",t);break;case"zigbee":this._logger.log("debug","add zigbee stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.ADD_ZIGBEE",t);break;case"wlan":this._logger.log("debug","add wlan stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.ADD_WLAN",t);break;case"mbus":this._logger.log("debug","add mbus port: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.ADD_MBUS",t);}t&&t.info&&t.info.ID_USB_DRIVER&&n.emit("x.hub.peripheralman.ADD_SEIRAL",t);},PM.prototype._onRemoveUsbDevice=function(e){for(var r=this._peripherals.length,i=!1,t=null;r;){if(r--,t=this._peripherals[r],this._isSameDev(t.info,e.info)){i=!0;break;}}i&&this._peripherals.splice(r,1);var n=require("x.hub.eventbus.js");switch(t.type){case"enocean":this._logger.log("debug","remove enocean stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.REMOVE_ENOCEAN",t);break;case"zwave":this._logger.log("debug","remove zwave stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.REMOVE_ZWAVE",t);break;case"zigbee":this._logger.log("debug","remove zigbee stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.REMOVE_ZIGBEE",t);break;case"wlan":this._logger.log("debug","remove wlan stick: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.REMOVE_WLAN",t);break;case"mbus":this._logger.log("debug","remove mbus port: "+JSON.stringify(t)),n.emit("x.hub.peripheralman.REMOVE_MBUS",t);}t&&t.info&&t.info.ID_USB_DRIVER&&n.emit("x.hub.peripheralman.REMOVE_SEIRAL",t);},PM;}(),x.hub.peripheralman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.peripheralman.Handler"),this.peripheralManager=new x.hub.peripheralman.PeripheralManager();};return Handler.prototype.PeripheralManager=x.hub.peripheralman.PeripheralManager,Handler.prototype.init=function(e,r,i){this.peripheralManager.init(i);},Handler.prototype.getUSBDevices=function(e){var r=this.peripheralManager.getUSBDevices();e&&e({data:r});},Handler.prototype.getUSBDevicesShortInfo=function(e){for(var r=this.peripheralManager.getUSBDevices(),i=[],t=0;t<r.length;t++){var n=r[t];if(n.type){var a={port:n.port,type:n.type,model:n.info?n.info.ID_MODEL:null,serial:n.info?n.info.ID_SERIAL:null,vendor:n.info?n.info.ID_VENDOR:null};i.push(a);}}e&&e({data:i});},Handler;}(),module.exports=new x.hub.peripheralman.Handler();