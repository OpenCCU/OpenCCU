var m=m||{};m.aio=m.aio||{},m.aio.smartwidget=m.aio.smartwidget||{},m.aio.smartwidget.Handler=function(){this._supportedGeneralDeviceType=["switch","light","dimmer","blind","shutter","motion","smoke","door","contact","powermeter","temperature","weatherstation","powerswitch","heater","water","window","co2","rain","brightness","home"],this.supportSmartWidget=function(e,t){if(!e||!e.sys)return!1;var a=null;if("hm"==e.sys)return(a=require("xnm.aio.hm.js").devicemanager).supportSmartWidget(e);if("hue"==e.sys)return(a=require("xnm.aio.hue.js").devicemanager).supportSmartWidget(e);if(["bose","heos","raumfeld","sonos"].includes(e.sys))return!0;if(!(a=require("m.aio.modulemanager.js").getModule(e.sys).devicemanager))return!1;if(a.toGeneralDevice){var o=a.toGeneralDevice(e);if(o&&o.type&&-1!=this._supportedGeneralDeviceType.indexOf(o.type))return!0;}return!!a.supportSmartWidget&&a.supportSmartWidget(e,t);},this.applySmartWidgetFilter=function(e,t,a,o){if(!e||!e.sys)return!1;var r,s,n;if("hm"==e.sys)return(r=require("xnm.aio.hm.js").devicemanager).applySmartWidgetFilter(e,a,o);if("hue"==e.sys)return(r=require("xnm.aio.hue.js").devicemanager).applySmartWidgetFilter(e,a,o);if(!(r=require("m.aio.modulemanager.js").getModule(e.sys).devicemanager))return!1;if(r.toGeneralDevice){var i=r.toGeneralDevice(e,null,null,t);if(i){var c=this._getSupportWidgetTypes(i),u=this._getCommandMap(i),l=this._getStatusMap(i),p=this._getIconMap(i);s=this._injectToSmartWidgetTemplate(a,c,o,u,l,p);}}if(r.applySmartWidgetFilter&&(n=r.applySmartWidgetFilter(this,e,t,a,o)),!s)return n;if(!n)return s;for(var d=s,h=0,f=n.length;h<f;h++){for(var g=n[h],w=null,v=!1,S=0;S<s.length;S++){if(w=s[S],g.meta&&w.meta&&g.meta.id==w.meta.id){v=!0;break;}}!v&&g&&d.push(g);}return d;},this._getSupportWidgetTypes=function(e){var t=[];switch(e.type){case"switch":case"light":t.push("switch"),e.states&&(e.states.power||e.states.consumption)&&t.push("powermeter");break;case"dimmer":t.push("switch"),t.push("dimmer"),e.commands&&(e.commands.color||e.commands.colorTemperature)&&t.push("rgb");break;case"blind":case"shutter":e.commands&&(e.commands.rotation||e.commands.lamellaUp||e.commands.lamellaDown)?(t.push("blind"),t.push("shutter")):t.push("shutter");break;case"motion":t.push("motion");break;case"smoke":t.push("smoke");break;case"door":case"contact":t.push("contact");break;case"powermeter":t.push("powermeter");break;case"temperature":t.push("climate");break;case"weatherstation":t.push("weather_station"),t.push("climate");break;case"powerswitch":t.push("switch"),t.push("powermeter");break;case"heater":t.push("thermostat");break;case"water":t.push("sensor_water");break;case"window":t.push("window");break;case"co2":t.push("sensor_co2");break;case"rain":t.push("rain");break;case"brightness":t.push("generic_state");}return t;},this._getCommandMap=function(e){var t={},a=e.details?e.details.commands:null;if(!a)return null;switch(e.type){case"switch":case"light":case"powerswitch":a.on&&(t["%on%"]=a.on),a.off&&(t["%off%"]=a.off),a.toggle&&(t["%toggle%"]=a.toggle);break;case"dimmer":a.on&&(t["%on%"]=a.on,t["%dimOn%"]=a.on),a.off&&(t["%dimOff%"]=a.off,t["%off%"]=a.off),a.toggle&&(t["%toggle%"]=a.toggle),a.up&&(t["%dimUp%"]=a.up),a.down&&(t["%dimDown%"]=a.down),a.brightness&&(t["%dimTo%"]=a.brightness),a.color&&(t["%rgb%"]=a.color),a.white?t["%white%"]=a.white:a.color&&a.color.ext&&e.commands.color&&"RGB"==e.commands.color.type&&(t["%white%"]=JSON.parse(JSON.stringify(a.color)),t["%white%"].ext="FFFFFF"),a.colorTemperature&&(t["%colorTemp%"]=a.colorTemperature);break;case"blind":case"shutter":a.up&&(t["%moveUp%"]=a.up),a.down&&(t["%moveDown%"]=a.down),a.stop&&(t["%stop%"]=a.stop),a.stepUp&&(t["%stepUp%"]=a.stepUp),a.stepDown&&(t["%stepDown%"]=a.stepDown),a.position&&(t["%moveTo%"]=a.position),a.lamellaUp&&(t["%lamellaUp%"]=a.lamellaUp),a.lamellaDown&&(t["%lamellaDown%"]=a.lamellaDown),a.rotation&&(t["%lamellaTo%"]=a.rotation);break;case"heater":a.auto&&(t["%thermoAuto%"]=a.auto),a.manu&&(t["%thermoManu%"]=a.manu),a.boost&&(t["%thermoBoost%"]=a.boost),a.up&&(t["%thermoTempUp%"]=a.up),a.down&&(t["%thermoTempDown%"]=a.down),a.temperature&&(t["%thermoTempTo%"]=a.temperature),a.tempTo&&(t["%thermoTempTo%"]=a.tempTo);}return t;},this._getStatusMap=function(e){var _chainConvS=function _chainConvS(e,t){if(e&&!t)return e;if(!e&&t)return t;if(!e&&!t)return null;var a={};for(var o in e){var r=e[o];r&&t[r]&&(a[o]=t[r]);}return a;},t={},a=e.details?e.details.states:null;if(!a)return null;switch(e.type){case"switch":case"light":a.state&&(t["%switchState%"]=a.state,t["%switchState%"].conv_s=_chainConvS(a.state.conv_s,null)),a.consumption&&(t["%meterEnergyCounter%"]=a.consumption),a.power&&(t["%meterPower%"]=a.power);break;case"dimmer":a.state&&(t["%switchState%"]=a.state,t["%switchState%"].conv_s=_chainConvS(a.state.conv_s,null)),a.brightness&&(t["%dimmerState%"]=a.brightness,t["%dimmerState%"].conv_s=_chainConvS(a.brightness.conv_s,null)),a.colorTemperature&&(t["%colorTempState%"]=a.colorTemperature,t["%colorTempState%"].conv_s=_chainConvS(a.colorTemperature.conv_s,null));break;case"blind":a.position&&(t["%blindState%"]=a.position,t["%shutterState%"]=a.position),a.rotation&&(t["%lamellaState%"]=a.rotation);break;case"heater":a.state&&(t["%thermoSetTemp%"]=a.state),a.setpoint&&(t["%thermoSetTemp%"]=a.setpoint),a.temperature&&(t["%thermoCurrentTemp%"]=a.temperature),a.humidity&&(t["%thermoHum%"]=a.humidity),a.mode&&(t["%thermoMode%"]=a.mode,e.states&&e.states.mode&&e.states.mode.values&&-1!=e.states.mode.values.indexOf("boost")&&(t["%thermoBoostMode%"]=JSON.parse(JSON.stringify(a.mode)),t["%thermoBoostMode%"].conv_s=_chainConvS(a.mode.conv_s,{auto:"off",manu:"off",boost:"on"}))),a.boostMode&&(t["%thermoBoostMode%"]=a.boostMode,t["%thermoBoostMode%"].conv_s=_chainConvS(a.boostMode.conv_s,null));break;case"motion":a.motion&&(t["%motionState%"]=a.motion,t["%motionState%"].conv_s=_chainConvS(a.motion.conv_s,{on:"true",off:"false"}));break;case"smoke":a.smoke&&(t["%smokeState%"]=a.smoke,t["%smokeState%"].conv_s=_chainConvS(a.smoke.conv_s,{on:"true",off:"false"}));break;case"rain":a.rain&&(t["%rainState%"]=a.rain,t["%rainState%"].conv_s=_chainConvS(a.rain.conv_s,{on:"true",off:"false"}));break;case"water":a.water&&(t["%waterState%"]=a.water,t["%waterState%"].conv_s=_chainConvS(a.water.conv_s,{on:"water",off:"dry"}));break;case"contact":case"door":a.state&&(t["%contactState%"]=a.state,t["%contactState%"].conv_s=_chainConvS(a.state.conv_s,null));break;case"powermeter":case"powerswitch":a.state&&(t["%switchState%"]=a.state,t["%switchState%"].conv_s=_chainConvS(a.state.conv_s,null)),a.consumption&&(t["%meterEnergyCounter%"]=a.consumption,t["%meterEnergyCounter%"].conv_s=_chainConvS(a.consumption.conv_s,null)),a.power&&(t["%meterPower%"]=a.power,t["%meterPower%"].conv_s=_chainConvS(a.power.conv_s,null)),a.voltage&&(t["%meterVoltage%"]=a.voltage,t["%meterVoltage%"].conv_s=_chainConvS(a.voltage.conv_s,null));break;case"temperature":a.temperature&&(t["%tempState%"]=a.temperature),a.humidity&&(t["%humState%"]=a.humidity);break;case"weatherstation":a.temperature&&(t["%tempState%"]=a.temperature),a.humidity&&(t["%humState%"]=a.humidity),a.brightness&&(t["%brightnessState%"]=a.brightness),a.windSpeed&&(t["%windspeedState%"]=a.windSpeed),a.windDirection&&(t["%windDirection%"]=a.windDirection,t["%windDirection%"].conv_i=a.windDirection.conv_i),a.rain&&(t["%rainingState%"]=a.rain,t["%rainingState%"].conv_s=_chainConvS(a.rain.conv_s,null)),a.rainCount&&(t["%rainingCounterState%"]=a.rainCount),a.sunshine&&(t["%sunshineState%"]=a.sunshine);break;case"window":a.state&&(t["%windowState%"]=a.state,t["%windowState%"].conv_s=_chainConvS(a.state.conv_s,null));break;case"co2":a.co2&&(t["%co2State%"]=a.co2,t["%co2State%"].conv_s=_chainConvS(a.co2.conv_s,{normal:"normal",medium:"added",high:"added_strong"}));break;case"brightness":a.brightness&&(t["%state%"]=a.brightness);}return t;},this._getIconMap=function(e){var t={};if(!(e.details?e.details.states:null))return null;if("brightness"===e.type)t["%icon%"]="sun";return t;},this._injectToSmartWidgetTemplate=function(e,t,a,o,r,s){var n=[];if(!t)return n;e||(e={}),o||(o={}),r||(r={}),console.log("support widgets",t);for(var i=0;i<e.length;i++){var c=e[i];if(c.meta&&-1!=t.indexOf(c.meta.type)&&c.elements){var u=JSON.parse(JSON.stringify(c));console.log("check widget",u.meta.id,u.meta.type);var l=!1,p=!1;for(var d in u.elements){var h=u.elements[d];if(h&&Array.isArray(h))for(var f=0;f<h.length;f++){var g=h[f];if(g){if(g.action&&("command"==g.action.type||"camera"==g.action.type)&&g.action.ref&&g.action.ref.value){var w=g.action.ref.ext;if(o[g.action.ref.value]){if(g.action.ref=JSON.parse(JSON.stringify(o[g.action.ref.value])),void 0!==w&&null!=w&&(g.action.ref.ext=w),g.action.device=a,("sliders"==d||"roundsliders"==d)&&g.action.ref.extMeta){var v=g.action.ref.extMeta.indexOf("-",1);if(-1!=v){var S=g.action.ref.extMeta.substr(0,v);S=parseFloat(S);var b=g.action.ref.extMeta.substr(v+1);b=parseFloat(b),isNaN(S)||(g.min=S),isNaN(b)||(g.max=b);}}l=!0;}else console.log("no match action",g.action),p=!0,g.action=null;}g.status&&g.status.ref&&g.status.ref.value&&(r[g.status.ref.value]?(g.status.ref=JSON.parse(JSON.stringify(r[g.status.ref.value])),g.status.device=a,l=!0):(console.log("no match status",g.status),p=!0,g.status=null)),g.maxValFromStatus&&g.maxValFromStatus.ref&&g.maxValFromStatus.ref.value&&(r[g.maxValFromStatus.ref.value]?(g.maxValFromStatus.ref=JSON.parse(JSON.stringify(r[g.maxValFromStatus.ref.value])),g.maxValFromStatus.device=a,l=!0):(console.log("no match maxValFromStatus",g.maxValFromStatus),p=!0,g.maxValFromStatus=null)),g.widget&&"%icon%"==g.widget.key_img&&s&&(g.widget.key_img=s["%icon%"]);}}}l&&!p&&(console.log("find match widget",u.meta.id,u.meta.type),n.push(u));}}return n;};},"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.smartwidget.Handler());