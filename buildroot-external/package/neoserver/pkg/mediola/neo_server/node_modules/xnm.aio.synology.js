var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.synology=xnm.aio.synology||{},xnm.aio.synology.Syno=function(){var t={},o={};o.Auth={path:"/auth.cgi",api:"SYNO.API.Auth",version:3,login:function login(t,o){var i={path:this.path,api:this.api,version:this.version,method:"login",account:t.username,passwd:t.password};t._doApiReq(i,function(t,i){if(!t)return i&&i.sid?void(o&&o(null,i.sid)):((t=new Error("login response format invalid")).code=-1,void(o&&o(t)));o&&o(t);});},logout:function logout(t,o){var i={path:this.path,api:this.api,version:this.version,method:"logout",account:t.username,passwd:t.password};t._doApiReq(i,function(t){o&&o(t);});}};var i={};i.Playlist={path:"/AudioStation/playlist.cgi",api:"SYNO.AudioStation.Playlist",version:2,list:function list(t,o){var i={path:this.path,api:this.api,version:this.version,method:"list"};t._doApiReq(i,function(t,i){if(!t)return i&&i.playlists?void(o&&o(null,i.playlists)):((t=new Error("playlist list response format invalid")).code=-1,void(o&&o(t)));o&&o(t);});}},i.RemotePlayer={path:"/AudioStation/remote_player.cgi",api:"SYNO.AudioStation.RemotePlayer",version:2,updateplaylist:function updateplaylist(t,o,i,n){var e={path:this.path,api:this.api,version:this.version,method:"updateplaylist"};for(var r in i){i.hasOwnProperty(r)&&(e[r]=i[r]);}e.containers_json=JSON.stringify(o),t._doApiReq(e,function(t){n&&n(t);});},control:function control(t,o,i){var n={path:this.path,api:this.api,version:this.version,method:"control"};for(var e in o){o.hasOwnProperty(e)&&(n[e]=o[e]);}t._doApiReq(n,function(t){i&&i(t);});},getstatus:function getstatus(t,o,i){var n={path:this.path,api:this.api,version:this.version,method:"getstatus"};for(var e in o){o.hasOwnProperty(e)&&(n[e]=o[e]);}t._doApiReq(n,function(t,o){t?i&&i(t):i&&i(null,o);});}};var Syno=function Syno(t,o,i,n){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.synology.Syno"),this.ip=t,this.port=o,this.port||(this.port=5e3),this.username=i,this.password=n;};return Syno.prototype.getPlaylist=function(t){var o=this;this._login(function(i){i?t&&t(i):Syno.AudioStation.Playlist.list(o,function(i,n){o._logout(function(){t&&t(i,n);});});});},Syno.prototype.playPlaylist=function(t,o,i){var n=this;this._login(function(e){if(e)i&&i(e);else{var r=[{type:"playlist",id:t.id}],a={library:t.library,offset:0,limit:1,play:!0,id:o};Syno.AudioStation.RemotePlayer.updateplaylist(n,r,a,function(t){t?i&&i(t):(a={action:"play",value:0,id:o},Syno.AudioStation.RemotePlayer.control(n,a,function(t){n._logout(function(){i&&i(t);});}));});}});},Syno.prototype.getPlayerStatus=function(t,o){var i=this;this._login(function(n){if(n)o&&o(n);else{var e={id:t};Syno.AudioStation.RemotePlayer.getstatus(i,e,function(t,n){i._logout(function(){o&&o(t,n);});});}});},Syno.prototype.stop=function(t,o){var i=this;this._login(function(n){if(n)o&&o(n);else{var e={action:"stop",value:0,id:t};Syno.AudioStation.RemotePlayer.control(i,e,function(t){i._logout(function(){o&&o(t);});});}});},Syno.prototype._getSid=function(){return t[this.ip];},Syno.prototype._setSid=function(o){t[this.ip]=o;},Syno.prototype._login=function(t){var i=this;o.Auth.login(this,function(o,n){o?t&&t(o):(i._setSid(n),t&&t());});},Syno.prototype._logout=function(t){var i=this;o.Auth.logout(this,function(o){i._setSid(null),t&&t(o);});},Syno.prototype._doApiReq=function(t,o){var i=this,n=this._getSid();if(n||"SYNO.API.Auth"==t.api||"login"==t.method){var e=[];for(var r in n&&e.push("_sid="+n),t){t.hasOwnProperty(r)&&"path"!=r&&e.push(r+"="+encodeURIComponent(t[r]));}e=e.join("&"),this._doRequest("GET","/webapi"+t.path+"?"+e,null,function(t,i){if(t)return t.code=-1,void(o&&o(t));try{var n=JSON.parse(i);n.success?o&&o(null,n.data):((t=new Error("api error")).code=n.error?n.error.code:-1,o&&o(t));}catch(t){t.code=-1,o&&o(t);}});}else this._login(function(n){n?o&&o(n):i._doApiReq(t,o);});},Syno.prototype._doRequest=function(t,o,i,n){var e=this,r="http://"+this.ip+":"+this.port+o;this._logger.log("trace","send "+t+" to url:"+r+" data:"+i);var a=n;$.ajax({url:r,type:t,timeout:this.timeout,data:i,dataType:"text",cache:!0,success:function success(t){e._logger.log("trace","http request success:"+t),a&&(a(null,t),a=null);},error:function error(t,o){var i="http request error:"+(t?t.status:"0")+"-"+o;e._logger.log("trace",i),a&&(a(new Error(i)),a=null);}});},Syno.API=o,Syno.AudioStation=i,Syno;}(),xnm.aio.synology.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Syno=xnm.aio.synology.Syno,Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.synology.Handler());