var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.warema=xnm.aio.warema||{},xnm.aio.warema.WebControl=function(){var e={_buffer:[],addComm:function addComm(e){this._buffer.push(e);},removeComm:function removeComm(e){var t=this._buffer.indexOf(e);-1!=t&&this._buffer.splice(t);},finalize:function finalize(){for(var e=0;e<this._buffer.length;e++){this._buffer[e]&&this._buffer[e].close();}this._buffer=[];}},Comm=function Comm(e){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl.Comm"),this._listener=e,this._connectCallbacks=[],this._host=null,this._port=null,this._packetBuffer=[],this._status=0,this._timeout=1e3,this._responseTimeout=2e3,this._idleTimeout=15e3,this._idleTO=null,this._cnt=0,this._socket=null;};Comm.prototype.connect=function(e,t,n){if(2!=this._status){if(n&&-1==this._connectCallbacks.indexOf(n)&&this._connectCallbacks.push(n),1!=this._status){this._host=e,this._port=t,this._logger.log("trace","connect socket:"+this._host);var o=this,a={port:this._port,host:this._host},i=require("net").connect(a);i.setTimeout(this._timeout),this._status=1,i.on("connect",function(){o._logger.log("trace","connected to warema:"+o._host),i.__disconnected||o._onSocketConnect();}),i.on("data",function(e){o._logger.log("trace","receive from warema "+(i.__disconnected?"(closed)":"")+":"+o._host+" data:"+e.toString("hex")),i.__disconnected||o._onSocketData(e);}),i.on("error",function(e){o._logger.log("trace","warema gateway:"+o._host+" error:"+e.message),i.__disconnected||(1==o._status?o._onSocketConnect(e):(i.destroy&&i.destroy(),i.end(),o._onSocketClose(e)));}),i.on("timeout",function(){i.__disconnected||1==o._status&&(o._logger.log("trace","warema connect:"+o._host+" timeout"),i.destroy&&i.destroy(),o._onSocketConnect(new Error("connect timeout")));}),i.on("close",function(){o._logger.log("trace","warema gateway:"+(i.__disconnected?"(closed)":"")+":"+o._host+" close socket"),i.__disconnected||o._onSocketClose();}),i._doConnect&&"function"==typeof i._doConnect&&i._doConnect(),this._socket=i;}}else n&&n();},Comm.prototype.close=function(){this._logger.log("trace","close socket"),this._socket&&(this._socket.__disconnected=!0,this._socket.end()),this._onSocketClose();},Comm.prototype.sendPacket=function(e,t){if(2==this._status){var n=this;this._cnt++,this._cnt>255&&(this._cnt=0);var o={cnt:this._cnt,data:e,callback:t};this._packetBuffer.push(o),o.timeout=setTimeout(function(){n._logger.log("trace","response timeout for packet:"+o.cnt);var e=n._packetBuffer.indexOf(o);-1!=e&&n._packetBuffer.splice(e,1),t&&t(new Error("reponse timeout"));},this._responseTimeout),this._send(o.cnt,e);}else t&&t(new Error("socket not connected"));},Comm.prototype._send=function(e,t){this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null);var n=this;this._idleTO=setTimeout(function(){n._logger.log("trace","idle timeout"),n.close();},this._idleTimeout);var o=[144,this._cnt,t.length].concat(t);this._logger.log("trace","send data:"+new Buffer(o).toString("hex")),this._socket&&this._socket.write(new Buffer(o));},Comm.prototype._onSocketConnect=function(t){this._status=t?0:2;var n=this._connectCallbacks;this._connectCallbacks=[];for(var o=0;o<n.length;o++){var a=n[o];a&&a(t);}if(!t){var i=this;this._idleTO&&clearTimeout(this._idleTO),this._idleTO=setTimeout(function(){i._logger.log("trace","connection idle timeout"),i.close();},this._idleTimeout);}t||e.addComm(this);},Comm.prototype._onSocketClose=function(t){this._logger.log("trace","socket closed with err:"+(t?t.message:null)),e.removeComm(this),this._idleTO&&(clearTimeout(this._idleTO),this._idleTO=null),this._socket&&(this._socket.__disconnected=!0),this._status=0,this._socket=null;var n=this._packetBuffer;this._packetBuffer=[];for(var o=0;o<n.length;o++){var a=n[o];a.timeout&&clearTimeout(a.timeout),t||(t=new Error("socket closed")),a.callback&&a.callback(t);}},Comm.prototype._onSocketData=function(e){var t=-1;if(e.length>2)for(var n=e[1],o=0;o<this._packetBuffer.length;o++){var a=this._packetBuffer[o];if(a&&a.cnt==n){a.timeout&&clearTimeout(a.timeout),t=o,a.callback&&a.callback(null,e.slice(2));break;}}-1!=t&&this._packetBuffer.splice(t,1);};var WebControl=function WebControl(e,t){this._logger=require("x.logger.js").getLogger("xnm.aio.warema.WebControl"),this._host=e,this._port=t,this._port||(this._port=5e4),this._comm=new Comm(this),this.CommandHandler=null,this._reqBuffer=[],this._positionReqCallbacks={},this._blackList=[];};return WebControl.prototype._setPersistantData=function(e){},WebControl.prototype._getString=function(e){for(var t="",n=0;n<e.length;n++){t+=String.fromCharCode(e[n]);}return t;},WebControl.prototype._adr2id=function(e){var t=e.split(".");return{roomid:parseInt(t[0]),deviceid:parseInt(t[1])};},WebControl.prototype._sendRequest=function(e,t){var n=this;this._comm.connect(this._host,this._port,function(o){o?t&&t(o):n._comm.sendPacket(e,function(e,n){e?t&&t(e):n?t&&t(e,n):t&&t(new Error("response is null"));});});},WebControl.prototype.POLL_MAP={33:0,35:1,103:11},WebControl.prototype._doRequest=function(e,t){var n=this;this._sendRequest(e,function(o,a){if(o)t&&t(o);else{if(3==a[0]&&52==a[1])return(o=new Error("error message")).requestID=a[2],o.errorCode=a[3],void(t&&t(o));if(3!=a[0]||51!=a[1])t&&t(null,a);else{var i=n.POLL_MAP[e[0]];a[2],a[3];if(2==a[3])return(o=new Error("gateway stack timeout")).errorCode=-2,void(t&&t(o));var cb=function cb(o,a){if(!o)return 51==a[1]||50==a[1]?51==a[1]&&2==a[3]||50==a[1]&&2==a[5]?((o=new Error("gateway stack timeout")).errorCode=-2,void(t&&t(o))):void setTimeout(function(){n._poll(e[1],e[2],i,cb);},50):void(t&&t(null,a));t&&t(o);};n._poll(e[1],e[2],i,cb);}}});},WebControl.prototype._executeNextRequest=function(){if(0!=this._reqBuffer.length){for(var e=-1,t=0;t<this._reqBuffer.length;t++){var n=this._reqBuffer[t];if(n&&n.data&&35!=n.data[0]){e=t;break;}}-1==e&&(e=0);var o=this,a=this._reqBuffer[e];a.timeout&&(clearTimeout(a.timeout),a.timeout=null),this._doRequest(a.data,function(e,t){a.callback&&a.callback(e,t);var n=o._reqBuffer.indexOf(a);-1!=n&&o._reqBuffer.splice(n,1),o._executeNextRequest();});}},WebControl.prototype._executeRequest=function(e,t){var n=this,o=this._reqBuffer.length,a={data:e,callback:t};a.timeout=setTimeout(function(){var e=n._reqBuffer.indexOf(a);-1!=e&&n._reqBuffer.splice(e,1),t&&t(new Error("queue busy"));},1e4),this._reqBuffer.push(a),0==o&&this._executeNextRequest();},WebControl.prototype._closeSocket=function(){this._comm.close();},WebControl.prototype._getRoomDevice=function(e,t,n){var o=this;this._doRequest([13,e,t],function(e,a){if(e)n&&n(e);else if(!a||a[0]<6||14!=a[1])n&&n(new Error("response invalid"));else if(6!=a[0]){var i={};i.name=o._getString(a.slice(7)),i.id=t,0==a[4]?(i.type="device",7==a[6]?i.type="switch":2==a[6]?i.type="blind":3==a[6]?i.type="shutter":4==a[6]?i.type="awning":4==a[5]&&5==a[6]||6==a[5]&&5==a[6]?i.type="awning_valance":22==a[5]&&5==a[6]||23==a[5]&&5==a[6]?i.type="awning_valance2":15==a[5]&&1==a[6]?i.type="window":26==a[5]&&6==a[6]&&(i.type="dimmer"),i.data=[a[5],a[6]]):(i.type="scene",i.data=[a[4]]),n&&n(null,i);}else n&&n(null,null);});},WebControl.prototype._getRoomDevices=function(e,t){var n=this,o=0,a=[],cb=function cb(i,r){i?2==i.errorCode?t&&t(null,a):t&&t(i):r?(r.address=e+"."+r.id,a.push(r),n._getRoomDevice(e,++o,cb)):t&&t(null,a);};this._getRoomDevice(e,o,cb);},WebControl.prototype._getRoom=function(e,t){var n=this;this._doRequest([3,e],function(o,a){if(o)t&&t(o);else if(!a||a[0]<2||4!=a[1])t&&t(new Error("response invalid"));else if(2!=a[0]){var i=n._getString(a.slice(3));n._getRoomDevices(e,function(n,o){t&&t(n,n?null:{name:i,id:e,devices:o});});}else t&&t(null,null);});},WebControl.prototype._poll=function(e,t,n,o){this._sendRequest([49,e,t,n],function(e,t){e?o&&o(e):t?o&&o(null,t):o&&o(new Error("response invalid"));});},WebControl.prototype._getPosition=function(e,t,n){this._executeRequest([35,e,t],function(e,t){if(e)n&&n(e);else if(!t||t[0]<8||36!=t[1])n&&n(new Error("response invalid"));else{var o={};o.roomid=t[2],o.deviceid=t[3],o.fahrt=t[4],o.position=t[5],o.winkel=t[6],o.pos_volant1=t[7],o.pos_volant2=t[8],n&&n(null,o);}});},WebControl.prototype._control=function(e,t,n,o,a){var i=[33,e,t,n];o||(o=[255,255,255,255]),i=i.concat(o),this._executeRequest(i,function(e,t){if(e)a&&a(e);else if(t){var n=null;4==t[0]&&34==t[1]&&(n={code:t[1],roomid:t[2],deviceid:t[3],feedback:t[4]}),n||(e=new Error("unknow response")),a&&a(e,n);}else a&&a(new Error("response is null"));});},WebControl.prototype._comfort=function(e,t,n,o){var a=[103,e,t,n];this._executeRequest(a,function(e,t){if(e)o&&o(e);else if(t){var n=null;4==t[0]&&104==t[1]&&(n={code:t[1],roomid:t[2],deviceid:t[3],execution:t[4]}),n||(e=new Error("unknow response")),o&&o(e,n);}else o&&o(new Error("response is null"));});},WebControl.prototype._resolveStates=function(e,t){var n=null;if(null==e)return{timeout:!0};switch(t.type){case"switch":200==e.position?n={state:"on"}:0==e.position&&(n={state:"off"});break;case"dimmer":(n={}).state=e.position/2;break;case"blind":case"shutter":case"awning":case"window":case"awning_valance":case"awning_valance2":(n={}).position=e.position/2,n.position<=30?n.positionT="top":n.position>=70?n.positionT="bottom":n.positionT="middle",n.winkel=e.winkel-127,n.posVolant1=e.pos_volant1/2,n.posVolant2=e.pos_volant2/2;break;default:return null;}return n&&(n.timeout=!1),n;},WebControl.prototype._getStates=function(e,t){if(-1!=this._blackList.indexOf(e)){var n=new Error("device unreachable");return n.errorCode=-2,void(t&&t(n));}var o=this._positionReqCallbacks[e];o||(o=[],this._positionReqCallbacks[e]=o);var a=o.length;if(t&&-1==o.indexOf(t)&&o.push(t),0==a){var i=this._adr2id(e),r=this;this._getPosition(i.roomid,i.deviceid,function(t,n){t&&-2==t.errorCode&&r._blackList.push(e);var o=r._positionReqCallbacks[e];r._positionReqCallbacks[e]=[];for(var a=0;a<o.length;a++){o[a]&&o[a](t,n);}});}},WebControl.prototype.getDevices=function(e){var t=this,n=0,o=[],cb=function cb(a,i){a?1==a.errorCode?e&&e(null,o):e&&e(a):i?(o.push(i),t._getRoom(++n,cb)):e&&e(null,o);};this._getRoom(n,cb);},WebControl.prototype.executeCommandCreator=function(e,t,n){if(e&&e.address){if(t){var o=e.address.split(".");if(2==o.length){var a,i=parseInt(o[0]),r=parseInt(o[1]),s=null,u=this;if("reset"==t.value){var l=this._blackList.indexOf(e.address);return-1!=l?(this._blackList.splice(l,1),void(n&&n())):void 0;}switch(e.type){case"switch":switch(t.value){case"on":a=21;break;case"off":a=22;break;case"toggle":a=10;break;default:return void(n&&n(new Error("no such command")));}break;case"dimmer":switch(t.value){case"on":a=28,s=[0,0,0,0];break;case"off":a=24,s=[0,0,0,0];break;case"dimTo":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command ext invalid")));a=3,s=[2*parseFloat(t.ext),255,255,255];break;default:return void(n&&n(new Error("no such command")));}break;case"awning":case"shutter":case"window":switch(t.value){case"stepUp":return void this._getStates(e.address,function(t,o){if(t)n&&n(t);else{var a=u._resolveStates(o,e);if(a){var i=a.position;0!=i?(i-=.5,u.executeCommandCreator(e,{value:"moveTo",ext:i},n)):n&&n();}else n&&n(new Error("get rolladen states return invalid"));}});case"stepDown":return void this._getStates(e.address,function(t,o){if(t)n&&n(t);else{var a=u._resolveStates(o,e);if(a){var i=a.position;0!=i?(i+=.5,u.executeCommandCreator(e,{value:"moveTo",ext:i},n)):n&&n();}else n&&n(new Error("get rolladen states return invalid"));}});}case"blind":case"awning_valance":case"awning_valance2":switch(t.value){case"moveTo":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command ext invalid")));a=2,s=[2*parseFloat(t.ext),255,255,255];break;case"winkelTo":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command ext invalid")));a=3,s=[255,parseFloat(t.ext)+127,255,255];break;case"valanceTo":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command ext invalid")));var c=parseFloat(t.ext);a=3,"awning_valance"==e.type?s=[255,255,2*c,255]:"awning_valance2"==e.type&&(s=[255,255,2*c,2*c]);break;case"stepUp":a=4;break;case"stepDown":a=5;break;case"up":a=6;break;case"down":a=7;break;case"stop":a=1;break;case"comfort":return void this._comfort(i,r,1,n);default:return void(n&&n(new Error("no such command")));}break;case"scene":if("run"!==t.value)return void(n&&n(new Error("no such command")));a=8;}this._control(i,r,a,s,function(e,t){n&&n(e,t);});}else n&&n(new Error("device address invalid"));}else n&&n(new Error("command is null"));}else n&&n(new Error("device format invalid"));},WebControl.prototype.getStatesCreator=function(e,t,n){var resolveState=function resolveState(e,t){for(var n=e.roomid+"."+e.deviceid,a=[],i=0;i<t.length;i++){if(t[i]&&t[i].id){var r="?";if(t[i]&&t[i].device&&t[i].status&&t[i].status.value){var s,u=t[i].status.value,l=t[i].device;if(l.address&&l.address==n)(s=e.timeout?{timeout:!0}:o._resolveStates(e,l))&&(r=s[u]),void 0!==r&&null!=r||(r="?"),a.push({id:t[i].id,status:r});}}}return a;},o=this;this.CommandHandler=e;for(var a=[],i=0;i<t.length;i++){if(t[i]&&t[i].device){var r=t[i].device;r.address&&-1==a.indexOf(r.address)&&a.push(r.address);}}var s=0,u=[],cb=function cb(e,i){if(e&&-2==e.errorCode){var r=o._adr2id(a[s]);r.timeout=!0,(l=resolveState(r,t))&&(u=u.concat(l));}var l;!e&&i&&(l=resolveState(i,t))&&(u=u.concat(l));++s!=a.length?o._getStates(a[s],cb):n&&n(null,u);};this._getStates(a[s],cb);},WebControl.prototype.toJSON=function(){return{sys:"warema",ip:this._host,port:this._port};},WebControl.prototype.equalsTo=function(e){return!!e&&e instanceof WebControl&&this._host==e._host&&this._port==e._port;},WebControl.finalize=function(){e.finalize();},WebControl;}(),xnm.aio.warema.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="WaremaDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},dimmer:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"state",ref:{value:"state",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},blind:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"winkel to",ref:{value:"winkelTo",ext:"%d",extMeta:"-80-80"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"winkel",ref:{value:"winkel",ext:"%d",extMeta:"-80-80"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},shutter:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},awning_valance2:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"valance to",ref:{value:"valanceTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"int",name:"valance",ref:{value:"valance",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},window:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"step up",ref:{value:"stepUp"}},{type:"enum",name:"step down",ref:{value:"stepDown"}},{type:"enum",name:"comfort position",ref:{value:"comfort"}},{type:"int",name:"position to",ref:{value:"moveTo",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"zurücksetzen blacklist",ref:{value:"reset"}}],status:[{type:"int",name:"position",ref:{value:"position",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"position text",ref:{value:"positionT",options:["top","middle","bottom"]}},{type:"enum",name:"timeout",ref:{value:"timeout",options:["true","false"]}}]},scene:{command:[{type:"enum",name:"run",ref:{value:"run"}}]}};return{SYS:"warema",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"warema WebControl",port:5e4}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,name:"Switch",type:"switch"},{sys:this.SYS,name:"Dimmer",type:"dimmer"},{sys:this.SYS,name:"Blind",type:"blind"},{sys:this.SYS,name:"Shutter",type:"shutter"},{sys:this.SYS,name:"Awning",type:"awning"},{sys:this.SYS,name:"Awning with Valance",type:"awning_valance"},{sys:this.SYS,name:"Awning with 2 Valance",type:"awning_valance2"},{sys:this.SYS,name:"Scene",type:"scene"}];},createGateway:function createGateway(e,t,n){var o=DMError,a=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(a.INVALID,"ip is invalid")):n(new o(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,n,o){var a=DMError,i=DMError.ERROR_CODE;t?t.ip?o(null,t):o(new a(i.INVALID,"ip is invalid")):o(new a(i.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,n){n();},createDevice:function createDevice(e,t,n){var o=DMError,a=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,r,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){r=s[i];break;}}r?n(null,e):n(new o(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new o(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new o(a.INVALID,"type is invalid"));}else n(new o(a.INVALID,"address is invalid"));}else n(new o(a.INVALID,"gateway is invalid"));}else n(new o(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var o=DMError,a=DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var i,r,s=t.data.gateways;for(i=0;i<s.length;i++){if(s[i].index===e.gateway){r=s[i];break;}}r?n(null,e):n(new o(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new o(a.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else n(new o(a.INVALID,"type is invalid"));}else n(new o(a.INVALID,"address is invalid"));}else n(new o(a.INVALID,"gateway is invalid"));}else n(new o(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _doFilterArr=function _doFilterArr(e,t,n){var o=[];return e.forEach(function(e){if("root"==e.type){var a=JSON.parse(JSON.stringify(e)),i=_doFilterArr(a.children,t,n);i&&i.length>0&&(a.children=i,o.push(a));}else if(function(e,t){if("*"==e)return!0;for(var n=!1,o=0;o<e.length;o++){if(e[o]==t){n=!0;break;}}return n;}(n.elems,e.type)){var r=JSON.parse(JSON.stringify(e));o.push(r);}}),o;},_filter=function _filter(e,t){var o=[],a=null,i=xnm.aio.warema.DM.getCommandStatusMap(e,n);return i&&(a=function(e,t,n){var o=[];switch(n.catagory){case"command":e.command&&(o=_doFilterArr(e.command,t,n));break;case"status":e.status&&(o=_doFilterArr(e.status,t,n));}return o;}(i,e,t),o=o.concat(a)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),o.command=a;break;case"status":a=_filter(e,t),o.status=a;break;default:return null;}return a&&0!=a.length?o:null;},getCommandStatusMap:function getCommandStatusMap(t){return t&&t.type?e[t.type]:null;}};}(),xnm.aio.warema.Handler=function(){this.detectedWebControls={};},xnm.aio.warema.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.warema.WebControl().getStateValues(e.type,t);},xnm.aio.warema.Handler.prototype.getDeviceCommandList=function(e,t,n){var o=[];return"Switch"==e.type&&(o.push({id:"on",cmd:"ON"}),o.push({id:"off",cmd:"OFF"})),o;},xnm.aio.warema.Handler.prototype.WebControl=xnm.aio.warema.WebControl,xnm.aio.warema.Handler.prototype.devicemanager=xnm.aio.warema.DM,xnm.aio.warema.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"warema");},xnm.aio.warema.Handler.prototype.resolveGateway=function(e){return e&&e.ip?new this.WebControl(e.ip,e.port):null;},xnm.aio.warema.Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=n?n.command:[];t&&t(null,o);},xnm.aio.warema.Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=n?n.status:[];t&&t(null,o);},xnm.aio.warema.Handler.prototype.doCommand=function(e,t,n,o){var a=this.resolveGateway(e);a?a.executeCommandCreator(t,n,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},xnm.aio.warema.Handler.prototype.doStatus=function(e,t,n,o,a){var i=this.resolveGateway(t);if(i){var r=[{id:e,device:n,status:o}];i.getStatesCreator(null,r,function(e,t){e?a&&a(e):a&&a(null,t[0]);});}else a&&a(new Error("gateway json format invalid"));},xnm.aio.warema.Handler.prototype.discoveryWithTimeout=function(e,t){var n=this,o=require("x.mdns.js");o.clearRecordBuffer(),o.discoverServiceWithTimeout("_ipp._tcp.local",e,function(e,o){if(e)t&&t(e);else{for(var a=[],i=0;i<o.length;i++){var r=o[i];if(r.target&&r.ip&&r.ip.length>0)if(-1!=r.target.toLowerCase().indexOf("webcontrol")){var s=new n.WebControl(r.ip[0]);a.push(s);}}t&&t(e,a);}});},xnm.aio.warema.Handler.prototype.getDeviceList=function(e,t){var n=this.resolveGateway(e);n?n.getDevices(function(e,n){t&&t(e,n);}):t&&t(new Error("gateway json format invalid"));},xnm.aio.warema.Handler.prototype.finalize=function(e){var t=e;setTimeout(function(){t&&(t(),t=null);},3e3),this.WebControl.finalize(function(){t&&(t(),t=null);});},xnm.aio.warema.Handler.prototype.pause=function(e){this.finalize(e);},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.warema.Handler());