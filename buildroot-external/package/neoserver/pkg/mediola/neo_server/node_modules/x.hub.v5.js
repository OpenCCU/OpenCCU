function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var x=x||{};x.hub=x.hub||{},x.hub.v5=x.hub.v5||{},x.hub.v5.LocalSPIBus=function(e,t){this._device=t,this._openspi=null,this._timeout=2e3,this._callback=null;},x.hub.v5.LocalSPIBus.prototype._transferChunked=function(e,t,r,o){var n=e;e.length>r&&(n=e.slice(0,r));var i=new Buffer(n.length),s=this;this._openspi.transfer(n,i,function(n,i){t=Buffer.concat([t,i]),e.length>r?s._transferChunked(e.slice(r),t,r,o):o(t);});},x.hub.v5.LocalSPIBus.prototype._openDevice=function(e){var t=e,r=require("spi"),o=this,n={device:this._device};null==this._openspi&&(this._openspi=new r.Spi(n.device,{mode:r.MODE.MODE_0,chipSelect:r.CS.low,bitOrder:r.ORDER.msb}),this._openspi.maxSpeed(1e6),this._openspi.open()),this._transferChunked(new Buffer(t),new Buffer([]),63,function(e){for(var t="",r=0;r<e.length;r++){t=t+e[r]+" ";}o._callback&&o._callback({error:null,data:e});});},x.hub.v5.LocalSPIBus.prototype.send=function(e,t,r){this._callback=r,this._openDevice(e);},x.hub.v5.LocalSPIBus.prototype.receive=function(e,t,r){for(var o=[],n=0;n<e;n++){o.push(0);}this.send(o,null,function(e){r&&r(e);});},x.hub.v5.LocalSPIBus.prototype.end=function(){},x.hub.v5.STMSPISerial=function(){this._port=null,this._pin=null,this._spiPort=null,this._timeoutTimer=null,this._onError=null,this._onData=null,this._onTimeout=null;},x.hub.v5.STMSPISerial.prototype.on=function(e,t){"error"==e?this._onError=t:"data"==e?this._onData=t:"timeout"==e&&(this._onTimeout=t);},x.hub.v5.STMSPISerial.prototype.open=function(e,t,r,o){var n;r||(r=1e6),this._port=e,this._pin=o,this._baudrate=r;try{n=require("spi");}catch(e){}n?(this._spiPort=new n.Spi(this._port,{mode:n.MODE.MODE_0,chipSelect:n.CS.low,bitOrder:n.ORDER.msb}),this._spiPort.maxSpeed(this._baudrate),this._spiPort.open(),t&&t(),this._read()):this._onError&&this._onError();},x.hub.v5.STMSPISerial.prototype._writeChunked=function(e,t,r,o){var n=e;e.length>r&&(n=e.slice(0,r));new Buffer(n.length);var i=this;this._spiPort.write(n,function(n,s){e.length>r?i._writeChunked(e.slice(r),t,r,o):o();});},x.hub.v5.STMSPISerial.prototype.write=function(e,t){if(this._spiPort){var r=this;XC.debugf("WRITE SPI:"),XC.debugf(e),r._writeChunked(new Buffer(e),new Buffer([]),63,function(e){t&&(r._timeoutTimer&&clearTimeout(r._timeoutTimer),r._timeoutTimer=setTimeout(function(){r._spiPort=null,r._onTimeout&&r._onTimeout();},t));});}},x.hub.v5.STMSPISerial.prototype.flush=function(){},x.hub.v5.STMSPISerial.prototype.close=function(){this._spiPort&&this._spiPort.close(),this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null),this._onError=null,this._onData=null,this._onTimeout=null;},x.hub.v5.STMSPISerial.prototype.generateCommandMessage=function(e,t){var r=e;if(t){(r=[31]).push(t);for(var o=0;o<e.length;o++){if("string"==typeof e)r.push(e.charCodeAt(o));else{var n=e[o];31!=n&&4!=n&&27!=n||r.push(27),r.push(n);}}r.push(0),r.push(4);}return r;},x.hub.v5.STMSPISerial.prototype._read=function(){if(this._spiPort){var e=this,t=(0,require("child_process").exec)("cat /sys/class/gpio/"+this._pin+"/value");t.stdout.on("data",function(t){if(1==t.trim()&&e._spiPort){for(var r=new Buffer(63),o=0;o<63;o++){r[o]="0x00";}var n=new Buffer(r.length);setTimeout(function(){e._spiPort.transfer(r,n,function(t,r){for(var o=!1,n=0;n<63;n++){if(4!=r[n]){o=!0;break;}}o&&e._timeoutTimer&&(clearTimeout(e._timeoutTimer),e._timeoutTimer=null),o&&e._onData&&e._onData(r);});},50);}}),t.on("error",function(e){}),t.on("close",function(t){e._readTimeout=setTimeout(function(){e._read();},50);});}},x.hub.v5.USBSerial=function(e,t,r){this._logger=require("x.logger.js").getLogger("x.hub.v5.USBSerial"),this._port=e,this._pin=t,this._pin||(this._pin="gpio228"),this._stmUSBSerial=null,this._receiveBuffer=new Buffer([]),this._onData=null,this._useAck=!0,this._reqFifo=[],this.REQ_FIFO_MAX_LEN=10,this.ACK_TO=200,this.RSP_TO=1e4,this.MAX_RSP_TO=3e4,this.RSP_END_TO=2e3,this._openSTMUSB(r);},x.hub.v5.USBSerial.prototype.on=function(e,t){"data"==e&&(this._onData=t);},x.hub.v5.USBSerial.prototype.reset=function(e){this._logger.log("info","reset st fifo");var t=this._reqFifo;this._reqFifo=[];for(var r=0;r<t.length;r++){var o=t[r];this._onRequestCancel(o);}e&&e();},x.hub.v5.USBSerial.prototype._getNextDataPackage=function(){for(var e=!1,t=!1,r=!1,o=!1,n=0,i=[],s=0;s<this._receiveBuffer.length;s++){if(o=!1,27==this._receiveBuffer[s]||4==this._receiveBuffer[s]||31==this._receiveBuffer[s]){if(e)o=!0;else if(27==this._receiveBuffer[s])e=!0;else if(4==this._receiveBuffer[s]){var a=!1;if(t&&(a=!0),t=!1,r=!0,a){this._receiveBuffer=this._receiveBuffer.slice(s+1);break;}r=!1;}else 31==this._receiveBuffer[s]&&(t=!0,n=0);}else t&&(o=!0);o&&(i[n++]=this._receiveBuffer[s],e=!1);}var u=null;return r&&n>=2&&(u=new Buffer(i.slice(0,n))),u;},x.hub.v5.USBSerial.prototype._openSTMUSB=function(e){if(this._stmUSBSerial)e&&e(!0);else{var t,r=this,o=e,n=require("xnm.aio.m10T.js"),i=null,s=!1;-1!=this._port.indexOf("spi")?(s=!0,i=new x.hub.v5.STMSPISerial(),t=1e6):(i=new n.STMUSBSerial(),t=115200),i.on("error",function(){r._logger.log("trace","st port error");try{r._stmUSBSerial.close();}catch(e){}r._stmUSBSerial=null,o&&o(!1),o=null;}),i.on("timeout",function(){if(r._logger.log("trace","st port timeout"),s){try{r._stmUSBSerial.close();}catch(e){}r._stmUSBSerial=null,setTimeout(function(){r._openSTMUSB(e);},500);}}),i.on("data",function(e){r._logger.log("trace","st data:"+e.toString("hex")),r._receiveBuffer=Buffer.concat([r._receiveBuffer,e]);for(var t=r._getNextDataPackage();t;){r._logger.log("trace","st package:"+t.toString("hex"));var o=t.slice(1,t.length-1);switch(t[0]){case 80:r._logger.log("info","receive st event:"+o.toString()),r._sendAck();break;case 0:r._onNak();break;case 1:r._onAck();break;case 34:r._sendAck(),r._onRspError(o);break;case 32:r._sendAck(),r._onRsp(o);break;case 33:r._sendAck(),r._onRspEnd(o);break;default:r._sendAck();}r._onData&&r._onData({type:t[0],data:o}),t=r._getNextDataPackage();}}),i.open(this._port,function(){r._logger.log("trace","st connected"),r._stmUSBSerial=i,o&&o(!0),o=null;},t,this._pin);}},x.hub.v5.USBSerial.prototype.sendCommand=function(e,t,r,o){if(144!=e){this._logger.log("info","add st (0x"+e.toString(16)+") request:"+(t&&t instanceof Buffer?t.toString("hex"):t));var n=this._reqFifo.length,i={type:e,req:t,ackTo:null,ackToRetry:0,rspTo:null,state:0,callback:r,responseBuffer:null};if(this._reqFifo.length==this.REQ_FIFO_MAX_LEN){var s=this._reqFifo[1];this._onRequestCancel(s),this._reqFifo.splice(1,1);}this._reqFifo.push(i),0==n&&this._sendNextReq();}else{this._logger.log("info","send st (0x"+e.toString(16)+") request directly:"+(t?t.toString("hex"):t));var a=this;this._openSTMUSB(function(o){if(!o)return a._logger.log("debug","open st failed"),void a._onRequestFinish("st not open");var n=a._stmUSBSerial.generateCommandMessage(t,e);a._stmUSBSerial.write(n,0,function(){r&&r({});});});}},x.hub.v5.USBSerial.prototype._sendNextReq=function(){var e=this._reqFifo[0];if(e){var t=this;!this._useAck||16!=e.type&&17!=e.type&&18!=e.type&&19!=e.type&&20!=e.type&&21!=e.type&&32!=e.type&&33!=e.type?53==e.type?e.state=0:e.state=2:e.state=1,2==e.state&&(e.rspTo=setTimeout(function(){t._onRspTimeout();},this.RSP_TO)),this._logger.log("debug","send st (0x"+e.type.toString(16)+") request:"+(e.req&&e.req instanceof Buffer?e.req.toString("hex"):e.req)),this._openSTMUSB(function(r){if(!r)return t._logger.log("debug","open st failed"),void t._onRequestFinish("st not open");var o=t._stmUSBSerial.generateCommandMessage(e.req,e.type);t._stmUSBSerial.write(o,0,function(){1==e.state?e.ackTo=setTimeout(function(){t._onAckTimeout();},t.ACK_TO):0==e.state&&t._onRequestFinish(null);});});}},x.hub.v5.USBSerial.prototype._sendAck=function(){if(this._useAck){this._logger.log("debug","send ack to st");var e=this._stmUSBSerial.generateCommandMessage("",1);this._stmUSBSerial.write(e);}},x.hub.v5.USBSerial.prototype._onAckTimeout=function(){var e=this._reqFifo[0];if(e)if(e.ackToRetry+=1,e.ackToRetry>3)this._onRequestFinish("response ack timeout 3 times");else{this._logger.log("debug","st ack timeout, re-send "+e.ackToRetry+". request:"+this._reqToString(e));var t=this;e.state=1,e.ackTo=setTimeout(function(){t._onAckTimeout();},this.ACK_TO*e.ackToRetry),this._logger.log("debug","re-send st (0x"+e.type.toString(16)+") request:"+this._reqToString(e));var r=this._stmUSBSerial.generateCommandMessage(e.req,e.type);this._stmUSBSerial.write(r);}},x.hub.v5.USBSerial.prototype._onNak=function(){var e=this._reqFifo[0];e&&(this._logger.log("debug","receive st nak:"+this._reqToString(e)),this._onRequestFinish("response nak"));},x.hub.v5.USBSerial.prototype._onAck=function(){var e=this._reqFifo[0];if(e&&(1==e.state||2==e.state)){var t=this;if(2!=e.state)this._logger.log("debug","receive st ack:"+this._reqToString(e)),e.state=2,e.ackTo&&(clearTimeout(e.ackTo),e.ackTo=null),e.rspTo&&(clearTimeout(e.rspTo),e.rspTo=null),e.startTS=new Date().getTime(),e.rspTo=setTimeout(function(){t._onRspTimeout();},this.RSP_TO);else{this._logger.log("debug","receive st ack");var r=new Date().getTime(),o=r+this.RSP_TO-e.startTS;o<this.MAX_RSP_TO?(e.rspTo&&(clearTimeout(e.rspTo),e.rspTo=null),e.rspTo=setTimeout(function(){t._onRspTimeout();},this.RSP_TO)):1!=e.useMaxRspTo&&(o=this.MAX_RSP_TO+e.startTS-r,e.useMaxRspTo=!0,e.rspTo=setTimeout(function(){t._onRspTimeout();},o));}}},x.hub.v5.USBSerial.prototype._onRspTimeout=function(){var e=this._reqFifo[0];e&&(this._logger.log("debug","receive st ack:"+this._reqToString(e)),1==e.state?this._onRequestFinish("no ack"):2==e.state?this._onRequestFinish("response timeout"):3==e.state&&this._onRequestFinish("response end timeout"));},x.hub.v5.USBSerial.prototype._onRspError=function(e){var t=this._reqFifo[0];t&&0!=t.state&&1!=t.state&&(this._logger.log("debug","receive st response_error:"+this._reqToString(t)+" --\x3e "+(e?e.toString():"")),t.responseBuffer=e,this._onRequestFinish("response error:"+(e?e.toString():"")));},x.hub.v5.USBSerial.prototype._onRsp=function(e){var t=this._reqFifo[0];if(t&&0!=t.state&&1!=t.state){this._logger.log("debug","receive st response:"+this._reqToString(t)+" --\x3e "+e.toString());var r=this;t.state=3,t.rspTo&&clearTimeout(t.rspTo),t.rspTo=setTimeout(function(){r._onRspTimeout();},this.RSP_END_TO),t.responseBuffer?t.responseBuffer=Buffer.concat([t.responseBuffer,e]):t.responseBuffer=e;}},x.hub.v5.USBSerial.prototype._onRspEnd=function(e){var t=this._reqFifo[0];if(t&&0!=t.state&&1!=t.state){16==t.type||17==t.type||18==t.type||19==t.type||20==t.type||21==t.type?this._logger.log("debug","receive st response_end:"+this._reqToString(t)+" --\x3e "+e.toString()):this._logger.log("debug","receive st response_end:"+this._reqToString(t)+" --\x3e "+e.toString("hex"));t.state=0,t.rspTo&&(clearTimeout(t.rspTo),t.rspTo=null),t.responseBuffer?t.responseBuffer=Buffer.concat([t.responseBuffer,e]):t.responseBuffer=e,this._onRequestFinish(null);}},x.hub.v5.USBSerial.prototype._onRequestFinish=function(e){var t=this._reqFifo[0];if(t){t.ackTo&&(clearTimeout(t.ackTo),t.ackTo=null),t.rspTo&&(clearTimeout(t.rspTo),t.rspTo=null);var r="request finish:";16==t.type||17==t.type||18==t.type||19==t.type||20==t.type||21==t.type?r+=t.req+" --\x3e ":r+=t.req.toString("hex")+" --\x3e ",e?(r+=e,this._logger.log("warn",r)):(t.responseBuffer&&(r+=t.responseBuffer.toString()),this._logger.log("info",r));try{t.callback&&t.callback({error:e,data:t.responseBuffer});}catch(e){}this._reqFifo.splice(0,1),this._sendNextReq();}},x.hub.v5.USBSerial.prototype._onRequestCancel=function(e){if(e){e.ackTo&&(clearTimeout(e.ackTo),e.ackTo=null),e.rspTo&&(clearTimeout(e.rspTo),e.rspTo=null);var t="request cancelled:"+this._reqToString(e);this._logger.log("warn",t),e.callback&&e.callback({error:"request cancelled"});}},x.hub.v5.USBSerial.prototype._reqToString=function(e){return e.req&&e.req instanceof Buffer?e.req.toString("hex"):e.req;},x.hub.v5.PK=null,x.hub.v5.getHWSerial=function(e){var t=(0,require("child_process").exec)("cat /proc/cpuinfo | grep Serial | cut -d ':' -f 2");t.stdout.on("data",function(t){e(t.trim()),e=null;}),t.on("error",function(t){e&&e(""),e=null;}),t.on("close",function(t){e&&e(""),e=null;});},x.hub.v5.getPrivateKey=function(e){x.hub.v5.PK?e(x.hub.v5.PK):x.hub.v5.getHWSerial(function(t){var r="";if(!localStorage.getItem("x.hub.v5.PK")){for(var o=0;o<64;o++){r+=Math.floor(15*Math.random()).toString(16);}localStorage.setItem("x.hub.v5.PK",r);}r=localStorage.getItem("x.hub.v5.PK");var n=require("x.crypt.js");x.hub.v5.PK=n.SHA256(r+t),e(x.hub.v5.PK);});},x.hub.v5.CloudConnect=function(){var CloudConnect=function CloudConnect(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect"),this._cloudServer=null,this._cloudPort=null,this._sid=null,this._at=null,this._cloudKey=null,this._cloudEnabled=!1,this._client=null;};return CloudConnect.prototype.CLOUD_SERVER="v5ws.mediola.com",CloudConnect.prototype.CLOUD_SERVER_PORT=443,CloudConnect.prototype.init=function(e){this._client&&(this._client.stop(),this._client=null);var t=this;this._cloudServer=localStorage.getItem("x.hub.v5.cloudServer"),this._cloudServer||(this._cloudServer=this.CLOUD_SERVER),this._cloudPort=localStorage.getItem("x.hub.v5.cloudPort"),this._cloudPort||(this._cloudPort=this.CLOUD_SERVER_PORT),this._sid=localStorage.getItem("x.hub.v5.SID"),this._at=localStorage.getItem("x.hub.Server.pwd"),this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");var r=localStorage.getItem("x.hub.v5.config");r=r?parseInt(r,16):255,this._cloudEnabled=0==(64&r),this._cloudEnabled&&this._at&&this._buildClient(function(r){t._client=r,t._client.init(e);});},CloudConnect.prototype.getCloudServer=function(){return this._cloudServer;},CloudConnect.prototype.setCloudServer=function(e){localStorage.setItem("x.hub.v5.cloudServer",e),this._cloudServer=e||this.CLOUD_SERVER;},CloudConnect.prototype.getCloudPort=function(){return this._cloudPort;},CloudConnect.prototype.setCloudPort=function(e){localStorage.setItem("x.hub.v5.cloudPort",e),this._cloudPort=e||this.CLOUD_SERVER_PORT;},CloudConnect.prototype.setCloudKey=function(e){localStorage.setItem("x.hub.v5.cloudKey",e),this._cloudKey=e;},CloudConnect.prototype.isCloudEnabled=function(){return this._cloudEnabled;},CloudConnect.prototype.isConnected=function(){return!!this._client&&!(this._client instanceof x.hub.v5.CloudConnectHTTP)&&this._client.isConnected();},CloudConnect.prototype.sendMessage=function(e,t){this._client&&this._client.sendMessage(e,t);},CloudConnect.prototype.sendMessageActive=function(e,t){this._client?this._client.sendMessageActive(e,t):t&&t(new Error("no cloud connection client"));},CloudConnect.prototype.sendMessageWithType=function(e,t,r){this._client?this._client.sendMessageWithType(e,t,r):r&&r(new Error("no cloud connection client"));},CloudConnect.prototype._buildClient=function(e){if("CA"!=global.HARDWARE_VERSION&&"A1"!=global.HARDWARE_VERSION){if("v5ws.mediola.com"!=this._cloudServer){var t=this._cloudServer,r=this._cloudPort,o=this._sid;443==r&&(r=80);var n=new(require("ws"))("ws://"+t+":"+r+"/ws/"+o),i=this;n.on("upgrade",function(t){e&&(i._logger.log("trace","support ws"),e(new x.hub.v5.CloudConnectWS(i._cloudServer,i._cloudPort,i._sid,i._at,i._cloudKey,i._cloudEnabled)),e=null,n.close());}),n.on("error",function(t){e&&(i._logger.log("trace","not support ws"),e(new x.hub.v5.CloudConnectHTTP()),e=null,n.close());}),n.on("close",function(t,r){e&&(i._logger.log("trace","not support ws"),e(new x.hub.v5.CloudConnectHTTP()),e=null,n.close());});}else e(new x.hub.v5.CloudConnectWS(this._cloudServer,this._cloudPort,this._sid,this._at,this._cloudKey,this._cloudEnabled));}else e(new x.hub.v5.CloudConnectWS(this._cloudServer,this._cloudPort,this._sid,this._at,this._cloudKey,this._cloudEnabled));},CloudConnect;}(),x.hub.v5.CloudConnectHTTP=function(){var DnsChecker=function DnsChecker(){};DnsChecker.prototype.check=function(){if("EA"==global.HARDWARE_VERSION){var e=require("dns").getServers();require("fs").readFile("/etc/resolv.conf",{encoding:"utf8"},function(t,r){if(!t){var o=r.split("\n"),n=!1;if(o&&o.length>0)for(var i=0;i<o.length;i++){var s=o[i].trim();if("#"!=s.charAt(0)&&"nameserver"==s.substr(0,10)){var a=s.replace("nameserver","").trim();if(a&&-1==e.indexOf(a)){n=!0;break;}}}if(n)(0,require("child_process").exec)("/etc/init.d/S60_v5plus_daemon restart");}});}};var ConnectHTTP=function ConnectHTTP(){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.HTTP"),this._request=null,this._timeout=3e5,this._error_count=0,this._run=!1,this._dns_error_count=0;};return ConnectHTTP.prototype.CLOUD_SERVER="v5ws.mediola.com",ConnectHTTP.prototype.CLOUD_SERVER_PORT=443,ConnectHTTP.prototype.init=function(e){e&&(this._server=e),this._run=!0,this._liveResponse=null,this._messages=[],this._challenge=[],this._cloudToken=[0,0,0,0,0,0,0,0];var t=require("x.crypt.js");this._cloudServer=localStorage.getItem("x.hub.v5.cloudServer"),this._cloudServer||(this._cloudServer=this.CLOUD_SERVER),this._cloudPort=localStorage.getItem("x.hub.v5.cloudPort"),this._cloudPort||(this._cloudPort=this.CLOUD_SERVER_PORT),localStorage.getItem("x.hub.v5.SID")&&(this._SID=t.AES.h2a(localStorage.getItem("x.hub.v5.SID"))),this._cloudKey=localStorage.getItem("x.hub.v5.cloudKey");var r=this;this._computeKeys(function(){r._request?r._disconnect(!0):r.checkConnection();});},ConnectHTTP.prototype.stop=function(){this._run=!1,this._disconnect(!0);},ConnectHTTP.prototype.checkConnection=function(){if(this._run){if(localStorage&&localStorage.getItem("x.hub.v5.config"))0==(64&parseInt(localStorage.getItem("x.hub.v5.config"),16))&&this._cloudServer&&localStorage.getItem("x.hub.v5.SID")?this._connect():this._disconnect();}},ConnectHTTP.prototype.sendMessage=function(e,t){t?this._messages.push(e):this._messages.unshift(e);},ConnectHTTP.prototype.sendMessageActive=function(e,t){this._messages.unshift(e),this._request&&this._request.abort(),t&&t();},ConnectHTTP.prototype._computeKeys=function(e){var t=this;this._iv&&this._key?e():x.hub.v5.getPrivateKey(function(r){for(var o=require("x.crypt.js"),n=o.Curve25519.curve25519(r,t._cloudKey),i="",s=0;s<n.length;s++){i+=XC.getHexVal(n[s],2);}t._key=o.AES.h2a(i.substr(0,32)),t._iv=o.AES.h2a(i.substr(32)),e();});},ConnectHTTP.prototype._handleServerResponse=function(e){var t=this,r=[],o=null;if(e.length>=4)if(e.length>=4&&240==e[1])e.splice(0,4);else if(e.length>=4&&255==e[1])e.splice(0,4),this._request&&this._request.abort();else{var n=(e[2]<<8)+e[3];e.length>=n+4&&(o=e[1],r=e.slice(4,n+4),e.splice(0,n+4));}if(r.length>0){for(var i=[],s=0;s<r.length;s++){i.push(r[s]);}var a=require("x.crypt.js");a.AES.setSize(128);var u=a.AES.a2a(a.AES.decrypt(i,this._key,this._iv,!1));if(u.length>=16){if(u.slice(8,16).toString()!=this._challenge.toString())return 1;this._cloudToken=u.slice(0,8);for(var c=u.length-1;c>16&&0!=u[c];){c--;}var l=new Buffer(u.slice(16,c)).toString("utf8");if(0!=o&&(this._liveResponse?this._liveResponse=null:this._messages.length>0&&this._messages.pop()),0==o||1==o){var h=null;localStorage&&localStorage.getItem("x.hub.Server.pwd")&&(h=localStorage.getItem("x.hub.Server.pwd")),null==h&&(h="null"),l!=h?(this.sendMessage("0101"+h,!0),this._request&&this._request.abort()):0==o?this._request&&this._request.abort():this._messages.length>0&&this._request&&this._request.abort();}else if((5==o||3==o)&&l.length>8){var p=null;5==o&&(p=l.substr(0,8),l=l.substr(8));var _=t._parseTunnelUrl(l);t=this;if("/"==_.pathname||"/info"==_.pathname||"/set"==_.pathname||"/cmd"==_.pathname||"/executeCommand"==_.pathname||"/getStates"==_.pathname){if(_.query&&_.query.json)try{JSON.parse(_.query.json);}catch(e){"?json="==(g=l.replace(_.pathname,"")).substr(0,6)&&(g=g.substr(6),_.query={json:g});}if(this._logger.log("trace","Remote Request Query:"+JSON.stringify(_.query)),_.query&&_.query.json&&1==Object.keys(_.query).length)try{for(var f in _.query=JSON.parse(_.query.json),_.path="",_.query){_.path+="&"+f+"="+_.query[f];}_.path=_.pathname+"?"+_.path.substr(1);}catch(e){}this._server.doRequest(_.pathname,{query:_.query,url:_.path},function(e){p&&(t._liveResponse=p+e),t._request&&t._request.abort();});}else{if(_.query&&_.query.json)try{JSON.parse(_.query.json);}catch(e){var g;"?json="==(g=l.replace(_.pathname,"")).substr(0,6)&&(g=g.substr(6),_.query={json:g});}if(this._logger.log("trace","Remote Request Query:"+JSON.stringify(_.query)),_.query&&_.query.json&&1==Object.keys(_.query).length)try{for(var f in _.query=JSON.parse(_.query.json),_.path="",_.query){_.path+="&"+f+"="+_.query[f];}_.path=_.pathname+"?"+_.path.substr(1);}catch(e){}this._server.doRequest(_.pathname,{query:_.query,url:_.path,pathname:_.pathname},function(e){p&&(t._liveResponse=p+e),t._request&&t._request.abort();});}}}}return 0;},ConnectHTTP.prototype._disconnect=function(e){this._request&&(this._request.abort(),e&&(this._request=null));},ConnectHTTP.prototype._connect=function(){var e=225,t="";this._liveResponse?(t=this._liveResponse,e=226):this._messages.length>0&&(t=this._messages[this._messages.length-1]);var r=require("x.crypt.js");r.AES.setSize(128),t=r.AES.s2a(t);var o=[];o=o.concat(this._cloudToken),this._challenge=[];for(var n=0;n<8;n++){this._challenge.push(Math.floor(255*Math.random()));}o=(o=o.concat(this._challenge)).concat(t);var i=r.AES.encrypt(o,this._key,this._iv);i=r.AES.a2a(i);r.AES.a2a(r.AES.decrypt(i,this._key,this._iv,!1));var s=[0,e];s=(s=s.concat(this._SID)).concat(i),s=new Buffer(s);var a=this._cloudPort;80==a&&(a=443);var u=require("x.hub.v5.js"),c="";u.server&&("CCU3"==u.server.hostType?c+=u.server.HWV+"-CCU3/"+u.server.VERSION+"/"+u.server._vid:c+=u.server.HWV+"/"+u.server.VERSION+"/"+u.server._vid);var l={host:this._cloudServer,port:a,path:"/msmt",method:"POST",headers:{"Content-Type":"application/octet-stream","Content-Length":s.length,Connection:"keep-alive","X-MG-Info":c}},h=require("https"),p=this;p._logger.log("trace","Remote Access Start: "+JSON.stringify(l)),this._request=h.request(l,function(e){if(p._logger.log("trace","Remote Access Response:"+e.statusCode),p._dns_error_count=0,200==e.statusCode){e.setEncoding("binary");var t=[],r=0;e.on("data",function(e){for(var o=new Buffer(e,"binary"),n=0;n<o.length;n++){t.push(o[n]);}r=p._handleServerResponse(t);}),e.on("end",function(){p._logger.log("trace","Remote Access End"),p._error_count=0,p._disconnect(),1==r?setTimeout(function(){p._iv=null,p._key=null,p._request=null,p.init();},1e3):p.checkConnection();});}else XC.debugf("Failed to post request to "+p.ip);}),this._request.setTimeout(this._timeout,function(){p._logger.log("warn","Remote Access Timeout"),p._request.abort();}),this._request.on("close",function(e){XC.debugf("close");}),this._request.on("error",function(e){(p._logger.log("warn","Remote Access ERROR: "+e),"EAI_AGAIN"==e.code)&&(p._dns_error_count++,p._dns_error_count>5&&(p._dns_error_count=0,new DnsChecker().check()));p._error_count++,p._disconnect();var t=p._error_count*p._error_count*100;t>2e3&&(t=2e3),setTimeout(function(){p.checkConnection();},t);}),s&&this._request.write(s),this._request.end();},ConnectHTTP.prototype._parseTunnelUrl=function(e){for(var t=null,r=-1;r<e.length&&(r++,"?"!=e.charAt(r));){;}return-1==r?{pathname:e}:(t=0==r?"/":e.substr(0,r),"json="==e.substr(r+1,5)?{pathname:t,query:{json:e.substr(r+6)}}:require("url").parse(e,!0));},ConnectHTTP;}(),x.hub.v5.CloudConnectWS=function(){var e=require("util"),t=require("events"),Socket=function Socket(e,t,r,o,n,i,s,a){this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS.Socket"),this._host=e,this._port=t,this._sid=r,this._token=o,this._hwv=n,this._server=i,this._ckey=s,this._civ=a,this._client_key=null,this._server_key=null,this._communication_key=null,this._hmac_key=null,this._ws=null,this._state=0,this._reqBuf="",this._pingInterval=null,this._pongTO=null,this._pongTOCount=0;};e.inherits(Socket,t),Socket.prototype.open=function(){var e=require("x.hub.v5.js"),t="";e.server&&("CCU3"==e.server.hostType?t+=e.server.HWV+"-CCU3/"+e.server.VERSION+"/"+e.server._vid:t+=e.server.HWV+"/"+e.server.VERSION+"/"+e.server._vid);var r=require("x.crypt.js"),o=require("crypto"),n=new(require("ws"))("ws://"+this._host+":"+this._port+"/ws/"+this._sid,null,{headers:{"X-MG-Info":t}});if(n._req&&n._req._headers&&n._req._headers["sec-websocket-key"]){this._logger.log("trace","Sec-WebSocket-Key: "+n._req._headers["sec-websocket-key"]);var i=new Buffer(n._req._headers["sec-websocket-key"],"base64");this._client_key=r.AES.a2a(r.AES.decrypt(i,this._ckey,this._civ,!1)),this._logger.log("trace","client_key: "+this._client_key);}var s=this;this._state=1,n.on("upgrade",function(e){s._logger.log("trace","upgrade"),s._state=2;var t=!1;if(e&&e.headers&&e.headers["x-sec-websocket-token"]&&(s._logger.log("trace","X-Sec-WebSocket-Token: "+e.headers["x-sec-websocket-token"]),104==e.headers["x-sec-websocket-token"].length)){var n=e.headers["x-sec-websocket-token"].substr(0,64),i=e.headers["x-sec-websocket-token"].substr(64);s._logger.log("trace","hmac: "+i),s._server_key=r.AES.a2a(r.AES.decrypt(r.AES.h2a(n),s._ckey,s._civ,!1)),s._logger.log("trace","server_key: "+s._server_key),s._communication_key=s._client_key.slice(0,16).concat(s._server_key.slice(0,16)),s._logger.log("trace","communication_key: "+s._communication_key),s._hmac_key=s._server_key.slice(16,32),s._logger.log("trace","hmac_key: "+s._hmac_key);for(var a="",u=0;u<s._communication_key.length;u++){a+=XC.getHexVal(s._communication_key[u],2);}for(var c="",l=0;l<s._hmac_key.length;l++){c+=XC.getHexVal(s._hmac_key[l],2);}var h=o.createHmac("sha1",c);h.update(a);var p=h.digest("hex").toUpperCase();s._logger.log("trace","hmac_check: "+p+" hmac:"+i),p==i&&(t=!0);}t||(s._state=5);}),n.on("open",function(){s._logger.log("trace","open"),2==s._state?(s._state=3,s._logger.log("trace","connected"),s._sendMessage({token:s._token,server:s._server,hwv:s._hwv},1),s._startPeriodicPing(),s.emit("open")):5==s._state&&(s._logger.log("trace","key exchange failed"),s.emit("error",new Error("key exchange failed")),s.close());}),n.on("message",function(e){s._logger.log("trace","message ("+e.length+"):"+e.toString("hex"));var t=s._communication_key.slice(0,16),o=s._communication_key.slice(16,32),n=r.AES.a2a(r.AES.decrypt(e,t,o,!1));if(n.length>8){var i=n.slice(0,8);s._logger.log("trace","head: "+i);var a=!0;128&i[0]&&(a=!1,i[0]-=128);e=r.AES.a2s([n.splice(8)]);s._logger.log("trace","data:"+e),s._reqBuf+=e;var u=null;if(5==i[0]){u="";for(var c=4;c<8;c++){u+=XC.getHexVal(i[c],2);}s._logger.log("trace","liveID: "+u);}if(a){var l=s._reqBuf;s._reqBuf="",s._onReq(l,i,u);}}}),n.on("close",function(e,t){s._logger.log("trace","socket closed #"+e+":"+t),s._onClose("close");}),n.on("error",function(e){s._logger.log("warn","socket error:"+e.message),s._onError(e);}),n.on("pong",function(){s._logger.log("trace","PONG!"),s._pongTO&&clearTimeout(s._pongTO),s._pongTO=null,s._pongTOCount=0;}),this._ws=n;},Socket.prototype.abort=function(){this._state=4,this.removeAllListeners("open"),this.removeAllListeners("error"),this.removeAllListeners("close"),this.removeAllListeners("message"),this._pingInterval&&clearInterval(this._pingInterval),this._pingInterval=null,this._pongTO&&clearTimeout(this._pingTO),this._pingTO=null,this._ws&&this._ws.terminate(),this._ws=null;},Socket.prototype.close=function(){this._state=4,this._pingInterval&&clearInterval(this._pingInterval),this._pingInterval=null,this._pongTO&&clearTimeout(this._pingTO),this._pingTO=null,this._ws&&this._ws.close(),this._ws=null;},Socket.prototype.send=function(e,t,r,o){3==this._state?this._sendMessage(e,t,r,null,o):o&&o(new Error("scoket not connected"));},Socket.prototype._sendMessage=function(e,t,r,o,n){var i,s=require("x.crypt.js");i="string"==typeof e?e:JSON.stringify(e),this._logger.log("trace","send message:"+i+" type:"+t+" messageId:"+r);var a=this._communication_key.slice(0,16),u=this._communication_key.slice(16,32),c=[255&t,0,0,0];c=(c=r?c.concat(s.AES.h2a(r)):c.concat([0,0,0,0])).concat(s.AES.s2a(i)),o&&(c[0]|=128);var l=s.AES.a2a(s.AES.encrypt(c,a,u));this._ws.send(l,{binary:!0,mask:!0},function ack(e){n&&n(e);});},Socket.prototype._onError=function(e){this.emit("error",e);},Socket.prototype._onClose=function(){this._state=4,this._pingInterval&&clearInterval(this._pingInterval),this._pingInterval=null,this._pongTO&&clearTimeout(this._pingTO),this._pingTO=null,this.emit("close");},Socket.prototype._onReq=function(e,t,r){this.emit("message",e,t,r);},Socket.prototype._startPeriodicPing=function(){var e=this;this._pingInterval=setInterval(function(){e._logger.log("trace","PING WS"),e._ws.ping(),e._pongTO&&clearTimeout(e._pongTO),e._pongTO=setTimeout(function(){e._pongTOCount++,e._pongTOCount>=3&&e._onPingPongFailed();},5e3);},2e4);},Socket.prototype._onPingPongFailed=function(){this.emit("error",new Error("ping-pong failed")),this.close();};var ConnectWS=function ConnectWS(e,t,r,o,n,i){if(this._logger=require("x.logger.js").getLogger("x.hub.v5.CloudConnect.WS"),this._server=null,this._host=e,!e)throw new Error("host invalid");if(this._port=t,!t)throw new Error("port invalid");443==this._port&&(this._port=80),this._sid=r,this._at=o,this._cloudKey=n,this._enabled=i,this._hwv=null,this._localIP=null,this._civ=null,this._ckey=null,this._socket=null,this._state=0,this._reconnTO=null;};return ConnectWS.prototype.isConnected=function(){return 2==this._state;},ConnectWS.prototype.init=function(e){if(e&&(this._server=e),this._hwv=e.HWV,this._abort(),this._state=1,this._sid&&this._at&&this._cloudKey&&this._enabled){var t=this;this._ckey=null,this._civ=null,this._computeKeys(function(){t._connect();});}},ConnectWS.prototype.stop=function(){this._abort();},ConnectWS.prototype.sendMessageWithType=function(e,t,r){this._socket.send(e,t,null,function(){r&&r();});},ConnectWS.prototype.sendMessage=function(e,t){this._socket.send(e,2,null,function(){t&&t();});},ConnectWS.prototype.sendMessageActive=function(e,t){this.sendMessage(e,t);},ConnectWS.prototype._connect=function(){this._logger.log("info","connect socket");var e=this,t=new Socket(this._host,this._port,this._sid,this._at,this._hwv,this._localIP,this._ckey,this._civ);t.on("open",function(){e._logger.log("trace","socket open"),e._onSocketOpen();}),t.on("error",function(t){e._logger.log("trace","socket error:"+t.message),e._onSocketError(t);}),t.on("close",function(){e._logger.log("trace","socket close"),e._onSocketClose();}),t.on("message",function(t,r,o){e._logger.log("trace","socket message type:"+r[0]),o&&e._logger.log("trace","socket message liveID:"+o),e._logger.log("trace","socket message:"+t),e._onSocketMessage(t,r,o);}),t.open(),this._socket=t;},ConnectWS.prototype._abort=function(){0!=this._state&&this._socket&&this._socket.abort(),this._reconnTO&&clearTimeout(this._reconnTO),this._reconnTO=null,this._socket=null,this._state=0;},ConnectWS.prototype._onSocketOpen=function(){this._logger.log("info","successfully connect to cloud:"),this._state=2;},ConnectWS.prototype._onSocketError=function(e){var t=this;switch(this._state){case 1:this._logger.log("warn","failed to connect to cloud:"+e.message),this._logger.log("trace","re-connect after 30 seconds"),this._state=1,this._socket.abort(),this._reconnTO=setTimeout(function(){t._logger.log("trace","re-try connect to cloud after connection failed"),t._reconnTO=null,t._connect();},3e4);break;case 2:this._logger.log("warn","cloud connection err:"+e.message),this._logger.log("trace","re-connect after 30 seconds"),this._state=1,this._socket.abort(),this._reconnTO=setTimeout(function(){t._logger.log("trace","re-try connect to cloud after connection error"),t._reconnTO=null,t._connect();},3e4);}},ConnectWS.prototype._onSocketClose=function(){if(this._logger.log("trace","cloud connection closed"),2==this._state&&(this._state=1,!this._reconnTO)){var e=this;this._logger.log("trace","re-connect after 30 seconds"),this._reconnTO=setTimeout(function(){e._logger.log("trace","re-try connect to cloud after connection closed"),e._reconnTO=null,e._connect();},3e4);}},ConnectWS.prototype._onSocketMessage=function(e,t,r){var o=this;if("CA"==global.HARDWARE_VERSION||"A1"==global.HARDWARE_VERSION){var n=this._parseTunnelUrl2(e);n.source="cloud",this._server._dispatcher.doRequest(n,{send:function send(e){o._logger.log("trace","Remote Request Response:"+e),r&&e&&o._socket.send(e,t[0],r);},json:function json(e){o._logger.log("trace","Remote Request Response:"+JSON.stringify(e)),r&&e&&o._socket.send(e,t[0],r);},end:function end(){}},function(){var e={XC_ERR:{code:"000000",msg:"invalid request"}};o._logger.log("trace","Remote Request Response:"+JSON.stringify(e)),r&&e&&o._socket.send(e,t[0],r);});}else{var i=this._parseTunnelUrl(e);if(i.query&&i.query.json)try{var s=decodeURIComponent(i.query.json);JSON.parse(s);}catch(t){var a=e.replace(i.pathname,"");"?json="==a.substr(0,6)&&(a=a.substr(6),i.query={json:a});}if(this._logger.log("trace","Remote Request Path:"+JSON.stringify(i.pathname)),this._logger.log("trace","Remote Request Query:"+JSON.stringify(i.query)),i.query&&i.query.json&&1==Object.keys(i.query).length)try{s=decodeURIComponent(i.query.json);for(var u in i.query=JSON.parse(s),i.path="",i.query){i.path+="&"+u+"="+i.query[u];}i.path=i.pathname+"?"+i.path.substr(1);}catch(e){}o=this;this._server.doRequest(i.pathname,{query:i.query,url:i.path,pathname:i.pathname,source:"cloud"},function(e){o._logger.log("trace","Remote Request Response:"+e),r&&e&&o._socket.send(JSON.parse(e),t[0],r);});}},ConnectWS.prototype._computeKeys=function(e){if(this._ckey&&this._civ)e();else{var t=this;x.hub.v5.getPrivateKey(function(r){for(var o=require("x.crypt.js").Curve25519.curve25519(r,t._cloudKey),n=0;n<o.length;n++){XC.getHexVal(o[n],2);}t._ckey=o.slice(0,16),t._civ=o.slice(16,32),e();});}},ConnectWS.prototype._parseTunnelUrl=function(e){for(var t=null,r=-1;r<e.length&&(r++,"?"!=e.charAt(r));){;}return-1==r?{pathname:e}:(t=0==r?"/":e.substr(0,r),"json="==e.substr(r+1,5)?{pathname:t,query:{json:e.substr(r+6)}}:require("url").parse(e,!0));},ConnectWS.prototype._parseTunnelUrl2=function(e){for(var t=null,r=-1;r<e.length&&(r++,"?"!=e.charAt(r));){;}if(-1==r)return{method:"GET",url:e,path:e,hasValidAuth:!0};t=0==r?"/":e.substr(0,r);var o=e.substr(r+1),n=require("querystring").parse(o),i="GET",s=null,a=null,u=null;if(null!=n.json&&null!=n.json){i="POST",s=n.json,u=new Buffer(s,"utf8").length,delete n.json;try{a=JSON.parse(s);}catch(e){}}var c=t;return n&&(c+="?"+require("querystring").stringify(n)),{method:i,url:c,path:t,query:n,body:s,json:a,size:u,hasValidAuth:!0};},ConnectWS.prototype._getLocalIP=function(){var e=require("os").networkInterfaces();for(var t in e){for(var r=e[t],o=0;o<r.length;o++){var n=r[o];if(n&&!n.internal&&"IPv4"==n.family&&n.address)return n.address;}}return null;},ConnectWS;}(),x.hub.v5.DownloadFile=function(e,t,r){var o=require("http"),n=require("fs");n.existsSync(e)&&n.unlinkSync(e);var i=n.createWriteStream(e);o.get(t,function(t){t&&200==t.statusCode?(t.pipe(i),i.on("finish",function(){i.close(function(){r&&r(!0);});}),i.on("error",function(t){n.unlink(e),r&&r(!1);})):r&&r(!1);}).on("error",function(t){n.unlink(e),r&&r(!1);});},x.hub.v5.BackupSTData=function(e,t,r){if(e._stmPort){var writeSTMDataToFile=function writeSTMDataToFile(t,r,o){e.doSTMCommand(t,function(e){e&&e.XC_SUC?require("fs").writeFile(r,JSON.stringify(e.XC_SUC),function(e){o(!e);}):o(!1);});};writeSTMDataToFile("XC_FNC=GetStates&config=1",t+"/states.json",function(e){e?writeSTMDataToFile("XC_FNC=GetSI",t+"/si.json",function(e){e&&r?r(!0):r&&r(!1);}):r&&r(!1);});}else r&&r(!0);},x.hub.v5.ResetSTData=function(e,t){e.doSTMRequest(53,[],function(e){t&&t();});},x.hub.v5.RestoreSTData=function(e,t,r){var o,_n,i=require("fs-extra"),s=require("querystring");e._stmPort?(o=function o(e){e?r&&r(!0):r&&r(!1);},_n=function n(t){if(t.length>0){var r=t.pop();if(r.type&&r.adr){var i=s.stringify(r);i="XC_FNC=AddSensor&"+i,e.doSTMCommand(i,function(e){_n(t);});}else _n(t);}else o(!0);},i.existsSync(t+"/states.json")?i.readFile(t+"/states.json",function(e,t){if(e)o(!1);else{var r=null;try{r=JSON.parse(t.toString());}catch(e){}r?r.length>0?_n(r):o(!0):o(!1);}}):o(!0)):r&&r(!0);},x.hub.v5.NativeWrapper=function(){this._mconfigPath="../../sbin/mconfig",this._stserPath="../../bin/stser",this._resetPin=236,this._hmPort="/dev/hmip-uart",this._usbMountPath="/media/usb0",this._resetPinState="1",this._getIpCbs=[],this._getIpTiemout=null;},x.hub.v5.NativeWrapper.prototype._execMConfig=function(e,t){var r=(0,require("child_process").exec)(this._mconfigPath+" "+e),o="";r.stdout.on("data",function(e){var t=String(e).trim();t=(t=t.replace(/[\n\r]/g,"")).replace(/\\x00/g,""),o+=t;}),r.on("error",function(e){t&&t({XC_ERR:{code:"000001",msg:"Error when executing mconfig."}});}),r.on("close",function(e){var r=null;if(o.length>0)try{r=JSON.parse(o);}catch(e){r={XC_ERR:{code:"000001",msg:e.message},res:String(o)};}t&&t(r);});},x.hub.v5.NativeWrapper.prototype._exec=function(e,t,r){var o=(0,require("child_process").exec)(e);o.stdout.on("data",function(e){var r=String(e).trim();t&&t(r);}),o.on("error",function(e){r&&r(e);}),o.on("close",function(e){r&&r();});},x.hub.v5.NativeWrapper.prototype.checkHMSerial=function(e){var t=(0,require("child_process").exec)("eq3configcmd update-coprocessor -p "+this._hmPort+" -c -v -d /srv/hm-root/opt/hm/firmware/"),r="";t.stdout.on("data",function(e){r+=e.trim().replace(/[\n\r]/g,"");}),t.stderr.on("data",function(e){r+=e.trim().replace(/[\n\r]/g,"");}),t.on("error",function(e){}),t.on("close",function(t){r.indexOf("<Info> Version:")>-1&&(r="OK"),e&&e(r);});},x.hub.v5.NativeWrapper.prototype.getIPData=function(e){var t=this._getIpCbs.length;if(e&&-1==this._getIpCbs.indexOf(e)&&this._getIpCbs.push(e),0==t){var r=this;this._getIpTiemout=setTimeout(function(){if(r._getIpTiemout=null,(e=r._getIpCbs).length){var e=r._getIpCbs;r._getIpCbs=[];for(var t=0;t<e.length;t++){try{e[t]&&e[t]({});}catch(e){}}}},5e3),this._execMConfig("config network show",function(e){r._getIpTiemout&&(clearTimeout(r._getIpTiemout),r._getIpTiemout=null);var t=r._getIpCbs;r._getIpCbs=[];var o={};if(e){for(var n in e){var i=e[n];o[n]=[];for(a=0;a<i.length;a++){var s=i[a];"object"==_typeof(i[a])&&null!==i[a]&&(s.IPV4&&(s.IP=s.IPV4,delete s.IPV4),s.MAC&&(s.MAC=s.MAC.replace(/\:/g,"-")),s.DNS&&Array.isArray(s.DNS)&&s.DNS[0]&&(s.DNS=s.DNS[0]),s.DHCP=s.DHCP&&"TRUE"==s.DHCP,o[n].push(s));}}for(a=0;a<t.length;a++){try{t[a]&&t[a](o);}catch(e){}}}else for(var a=0;a<t.length;a++){try{t[a]&&t[a](o);}catch(e){}}});}},x.hub.v5.NativeWrapper.prototype._setNTP=function(e,t){e?this._execMConfig("config network ntp server "+e,function(e){t&&t(!0);}):t&&t(!1);},x.hub.v5.NativeWrapper.prototype.scanWiFi=function(e){this._execMConfig("config network wlan scan",function(t){var r=null,o=[];if(Array.isArray(t))for(var n=0;n<t.length;n++){"string"==typeof t[n].ssid&&t[n].ssid.length>0&&o.push(t[n]);}else"string"==typeof t?r=new Error(JSON.stringify({XC_ERR:{msg:t}})):t.XC_ERR&&(r=new Error(JSON.stringify(t)));e&&e(r,o);});},x.hub.v5.NativeWrapper.prototype.connectWiFi=function(e,t,r){var o="config network wlan connect ";o+='"'+String(e).replace(/"/g,'\\"')+'"',o+='"'+String(t).replace(/"/g,'\\"')+'"';var n=this;this._execMConfig(o,function(e){var t=e&&"done"==e.status;r&&r(t),setTimeout(function(){n.reboot();},1e3);});},x.hub.v5.NativeWrapper.prototype.resetNetwork=function(e){this._execMConfig("config network reset",function(t){var r=!1;t&&"done"==t.status&&(r=!0),e&&e(r);});},x.hub.v5.NativeWrapper.prototype.resetHM=function(e){this._execMConfig("system resetHM",function(t){var r=!1;t&&"done"==t.status&&(r=!0),e&&e(r);});},x.hub.v5.NativeWrapper.prototype.resetZway=function(e){this._execMConfig("system resetZWAY",function(t){var r=!1;t&&"done"==t.status&&(r=!0),e&&e(r);});},x.hub.v5.NativeWrapper.prototype.resetZigbee=function(e){this._execMConfig("system resetZigbee",function(t){var r=!1;t&&"done"==t.status&&(r=!0),e&&e(r);});},x.hub.v5.NativeWrapper.prototype._setIPData=function(e,t){var r=null;1==e.DHCP?r="config network lan dhcp":e.IP&&e.SN&&e.GW&&e.DNS&&(r="config network lan static "+e.IP+" "+e.SN+" "+e.GW+" "+e.DNS);var o=this;this._setNTP(e.NTP,function(){t&&t(!0),r&&o._execMConfig(r,function(e){XC.debugf("setIPData:"),XC.debugf(e),setTimeout(function(){o._execMConfig("config network restart eth0",function(e){XC.debugf(e);});},1500);});});},x.hub.v5.NativeWrapper.prototype._setMAC=function(e,t,r){t.MAC?e.doSTMRequest(57,XC.getBytes(t.MAC,!0),function(o){o||XC.debugf("set st mac error"),e.doSTMRequest(58,[],function(e){e&&XC.debugf("new mac: "+e.toString("hex")),r&&(e&&e.toString("hex")==t.MAC.toLowerCase()?r(!0):r(!1));});}):r&&r(!0);},x.hub.v5.NativeWrapper.prototype.setIPData=function(e,t,r){var o=this;this._setMAC(e,t,function(e){e?o._setIPData(t,r):r&&r(!1);});},x.hub.v5.NativeWrapper.prototype.setWLANData=function(e,t){var r=null;!0===e.DHCP?r="config network wlan dhcp":e.IP&&e.SN&&e.GW&&e.DNS&&(r="config network wlan static ",r+='"'+e.IP+'" "'+e.SN+'" "'+e.GW+'" "'+e.DNS+'"');var o=this;this._setNTP(e.NTP,function(){r?o._execMConfig(r,function(e){t&&t(!0),setTimeout(function(){o._execMConfig("config network restart wlan0",function(e){XC.debugf(e);});},1500);}):t&&t(!0);});},x.hub.v5.NativeWrapper.prototype.updateFirmware=function(e,t,r,o){var n=require("http"),i=require("fs"),s="/tmp/firmware_update.iopk";i.existsSync(s)&&i.unlinkSync(s);var a=i.createWriteStream(s),u=this;n.get("http://"+e+":"+t+r,function(e){e&&200==e.statusCode?(e.pipe(a),a.on("finish",function(){a.close(function(){u._execMConfig("system update",function(e){XC.debugf(e),o&&o('{"XC_SUC":{}}');});});}),a.on("error",function(e){i.unlink(s),o&&o('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');})):o&&o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}).on("error",function(e){i.unlink(s),o&&o('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});},x.hub.v5.NativeWrapper.prototype.updateSTFirmware=function(e,t,r,o,n){var i=require("http"),s=require("fs"),a="/tmp/st.bin";s.existsSync(a)&&s.unlinkSync(a);var u=s.createWriteStream(a);i.get("http://"+e+":"+t+r,function(e){e&&200==e.statusCode?(e.pipe(u),u.on("finish",function(){u.close(function(){var e=new(require("xnm.aio.m10T.js").STMUpdater)(a);e.hostType="A20";var t=0;e.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(r){r.error?(XC.debugf("\r\nfailed to flash ST ("+r.error+")"),e.resetST(!1),n?n('{"XC_SUC":{}}'):o&&o.send("ERROR.")):100==r.state?(XC.debugf("\r\nflashed ST!"),e.resetST(!1),n?n('{"XC_SUC":{}}'):o&&o.end("100.")):o&&t!=r.state&&(o.write(r.state+"."),t=r.state);});});}),u.on("error",function(e){s.unlink(a),n?n('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):o&&o.send("ERROR.");})):n?n('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):o&&o.send("ERROR.");}).on("error",function(e){s.unlink(a),n?n('{"XC_ERR":{"code":"000000", "msg":"internal error"}}'):o&&o.send("ERROR.");});},x.hub.v5.NativeWrapper.prototype.updateV5PFirmware=function(e,t,r){var o=this;this._saveFirmware(e,function(n,i){if(n)return t.end("ERROR.["+n.message+"]"),void(r&&r(n));o._splitFirmwareV5PlusFile(i,"/tmp",e.query.filename,function(e,n,i){if(e)return t.end("ERROR.["+e.message+"]"),void(r&&r(e));n&&i?o._updateSTFirmware(i,t,function(e){if(e)return t.end("ERROR.["+e.message+"]"),void(r&&r(e));o._updateA20Firmware(n,function(e){if(e)return t.end("ERROR.["+e.message+"]"),void(r&&r(e));t.end('{"XC_SUC":{}}',function(){r&&(r(),r=null);}),setTimeout(function(){r&&(r(),r=null);},5e3);});}):i?o._updateSTFirmware(i,t,function(e){if(e)return t.end("ERROR.["+e.message+"]"),void(r&&r(e));t.end('{"XC_SUC":{}}',function(){r&&(r(),r=null);}),setTimeout(function(){r&&(r(),r=null);},5e3);}):n&&o._updateA20Firmware(n,function(e){if(e)return t.end("ERROR.["+e.message+"]"),void(r&&r(e));var o=0,n=setInterval(function(){++o<=100?t.write(o+"."):(clearInterval(n),t.end('{"XC_SUC":{}}',function(){r&&(r(),r=null);}),setTimeout(function(){r&&(r(),r=null);},5e3));},10);});});});},x.hub.v5.NativeWrapper.prototype._saveFirmware=function(e,t){var r=require("fs"),o=(require("os"),require("path")),n=o.join("/tmp","/firmware_update.v5pfw");r.existsSync(o)&&r.unlinkSync(o);var i=r.createWriteStream(n);e.pipe(i),i.on("finish",function(){i.close(function(){t&&t(null,n);});}),i.on("error",function(e){r.unlink(n),t&&t(e);});},x.hub.v5.NativeWrapper.prototype._splitFirmwareV5PlusFile=function(e,t,r,o){var n=require("fs"),i=require("os"),s=require("path");t=t||i.tmpdir();var fnExtractFile=function fnExtractFile(t,r,o,i){var s=n.createWriteStream(t);s.on("finish",function(){i&&i(null);});var a={flags:"r",start:r,end:o},u=n.createReadStream(e,a);u.on("error",function(e){i&&i(e),i=null,u.end();}),u.pipe(s);};n.readFileLine(e,1,function(n,i){if(n)return"string"==typeof n&&(n=new Error(n)),void(o&&o(n,null,null));var a=new(require("xnm.aio.m10T.js").V5Updater)().parseHeader(i),u=!1,c=!1;if(!a&&(r&&-1!=r.indexOf(".iopk")?u=!0:r&&-1!=r.indexOf(".bin")&&(c=!0),!u&&!c))return n=new Error("Could not parse header section of file."),void(o&&o(n,null,null));Date.now();var l=s.join(t,"firmware_update.iopk"),h=s.join(t,"st.bin");if(a){var p=a.offset+a.esp[3],_=p+a.esp[4];fnExtractFile(l,p,_,function(e){p=a.offset+a.st[3],_=p+a.st[4];var t=a.st[2].split("."),r=parseInt(t[0]),n=parseInt(t[1]);r>1||1==r&&n>=1?o&&o(null,l,null):fnExtractFile(h,p,_,function(e){o&&o(null,l,h);});});}else u?o&&o(null,e,null):c?o&&o(null,null,e):o&&o(new Error("invalid firmware data"),null,null);});},x.hub.v5.NativeWrapper.prototype._updateA20Firmware=function(e,t){var r=global.FIRMWARE_VERSION;console.log("update system "+r),"1.0"!=r.substr(0,3)&&t&&t();var o=this;setTimeout(function(){o._execMConfig("system update",function(e){console.log("update system finish "+r.substr(0,3)),"1.0"==r.substr(0,3)&&t&&t();});},1500);},x.hub.v5.NativeWrapper.prototype._updateSTFirmware=function(e,t,r){var o=new(require("xnm.aio.m10T.js").STMUpdater)(e);o.hostType="A20";var n=0;o.startSPIUpdate(new x.hub.v5.LocalSPIBus("SPI","/dev/spidev0.0"),function(e){console.log("!!!!!!!",e?JSON.stringify(e):"null"),e.error?(XC.debugf("\r\nfailed to flash ST ("+e.error+")"),o.resetST(!1),t&&t.write("ERROR.["+e.error+"]"),r&&r(new Error(e.error))):100==e.state?(XC.debugf("\r\nflashed ST!"),o.resetST(!1),t&&t.write("100."),r&&r()):t&&n!=e.state&&(t.write(e.state+"."),n=e.state);});},x.hub.v5.NativeWrapper.prototype.backup=function(e,t){var r="/tmp/firmware_backup.iopk",o=require("fs-extra");o.existsSync(r)&&o.removeSync(r);var n=this;x.hub.v5.BackupSTData(e,"./data",function(e){e?n._execMConfig("system backup "+(Math.floor(49*Math.random())+1),function(e){if(e&&"done"==e.status&&o.existsSync(r)){var n=new Date().toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"");t.setHeader("Content-disposition","attachment; filename=backup_"+n+".iopk"),t.sendFile(r,null,function(e){o.removeSync("./data/states.json"),o.removeSync("./data/si.json"),o.removeSync(r),e&&t.status(500).end();});}else t.status(500).end();}):t.status(500).end();});},x.hub.v5.NativeWrapper.prototype.restore=function(e,t,r){var o="/tmp/firmware_backup.iopk",n=require("fs-extra");n.existsSync(o)&&n.removeSync(o);var i=this;x.hub.v5.DownloadFile(o,t,function(t){t&&n.existsSync(o)?i._execMConfig("system restore",function(t){t&&"done"==t.status?x.hub.v5.RestoreSTData(e,"./data",function(e){e?(n.removeSync(o),r&&r('{"XC_SUC":{}}')):r&&r('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');}):r&&r('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');}):r&&r('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});},x.hub.v5.NativeWrapper.prototype.reboot=function(){this._execMConfig("system reboot",function(e){});},x.hub.v5.NativeWrapper.prototype._checkResetPin=function(e,t,r){var o=2e3;if(0==e.readSync()){var n=Date.now()-this._resetPinPressBegin;n>8e3?(this._resetPinPressBegin=Date.now(),this._resetMode="reboot",t&&t.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000")):n>6e3?(this._resetMode="factory",t&&t.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0003")):n>4e3?(this._resetMode="passwords",t&&t.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0004")):n>o&&(this._resetMode="network",t&&t.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0001"));}},x.hub.v5.NativeWrapper.prototype.watchResetPin=function(e,t){var r=require("onoff").Gpio,o=new r(this._resetPin,"in","both");o.unexport(),o=new r(this._resetPin,"in","both");var n=this,i=null;o.watch(function(r,s){i&&(clearInterval(i),i=null),e&&e.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0000"),0==s?(n._resetPinPressBegin=Date.now(),n._resetMode=null,i=setInterval(function(){n._checkResetPin(o,e,t);},200)):t&&t(n._resetMode);});},x.hub.v5.NativeWrapper.prototype.checkResetPin=function(){return new(0,require("onoff").Gpio)(this._resetPin,"in","both").readSync();},x.hub.v5.NativeWrapper.prototype.mountUSB=function(e){var t=e,r=setTimeout(function(){t&&t(new Error("execute setUSBmount start timeout")),t=null;},2e4),o=this,n=(0,require("child_process").exec)("../../sbin/setUSBmount start"),i="",s="";n.stdout.on("data",function(e){i+=e,XC.debugf("setUSBmount start: "+i);}),n.stderr.on("data",function(e){s+=e,XC.debugf("setUSBmount start error: "+s);}),n.on("error",function(e){r&&(clearTimeout(r),r=null),t&&t(new Error("execute setUSBmount start error")),t=null;}),n.on("close",function(e){var n;XC.debugf("exec close"),XC.debugf("setUSBmount start: "+i),r&&(clearTimeout(r),r=null),s&&(s=(s=(s=s.replace("/dev/sda","")).replace("on","")).replace("/media/usb0",""),n=new Error(s)),t&&t(n,o._usbMountPath),t=null;});},x.hub.v5.NativeWrapper.prototype.unmountUSB=function(e){var t=e,r=setTimeout(function(){t&&t(new Error("execute setUSBmount stop timeout")),t=null;},2e4),o=(0,require("child_process").exec)("../../sbin/setUSBmount stop"),n="";o.stdout.on("data",function(e){e;}),o.stderr.on("data",function(e){n+=e,XC.debugf("setUSBmount stop error: "+n);}),o.on("error",function(e){r&&(clearTimeout(r),r=null),t&&t(new Error("execute setUSBmount stop error")),t=null;}),o.on("close",function(e){var r;n&&(n=(n=(n=n.replace("/dev/sda","")).replace("on","")).replace("/media/usb0",""),r=new Error(n)),t&&t(r),t=null;});},x.hub.v5.NativeWrapper.prototype.setDateTime=function(e,t,r,o,n,i){var s=t+"";s.length<2&&(s="0"+s);var a=r+"";a.length<2&&(a="0"+a);var u=o+"";u.length<2&&(u="0"+u);var c=n+"";c.length<2&&(c="0"+c);var l=s+a+u+c+e;console.log("set system time:"+l),this._execMConfig("system set time "+l,function(e){console.log("set system time finish",e),i&&i(!0);});},x.hub.v5.NativeWrapper.prototype.runMdev=function(e){this._exec("mdev -s",null,e);},x.hub.v5.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.v5.Handler"),this.server=null,this._serial=null,this._pk=null,this._usbPath=null;},x.hub.v5.Handler.prototype.setRGBColor=function(e){if(this.server&&"A20"==this.server.hostType)this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=00"+e);else{var t=parseInt(e,16);16711680&t&&(t|=1048576),65280&t&&(t|=4096),255&t&&(t|=16);try{var r=require("rpi-ws281x-native/lib/ws281x-native");r&&(r.init(1),r.render([t]),setTimeout(function(){r.render([t]);},100));}catch(e){}}},x.hub.v5.Handler.prototype.getPublicKey=function(e){x.hub.v5.getPrivateKey(function(t){for(var r=require("x.crypt.js").Curve25519.curve25519(t),o="",n=0;n<r.length;n++){o+=XC.getHexVal(r[n],2);}o=o.toLowerCase(),e(o);});},x.hub.v5.Handler.prototype.backup=function(e,t,r){var o=require("fs"),n=require("fs-extra"),i="/tmp/backup";o.existsSync(i)&&o.rmdirRecursiveSync(i),o.mkdirSync(i),this._backup(e,i,r,function(e,r,o){e?t.status(500).end():(t.setHeader("Content-disposition","attachment; filename="+o),t.sendFile(r,null,function(e){n.removeSync(i),n.removeSync(r),e&&t.status(500).end();}));});},x.hub.v5.Handler.prototype.restore=function(e,t,r,o){var n=require("fs"),i=(require("fs-extra"),"/tmp/restore.zip"),s="/tmp/restore/",a=this;x.hub.v5.DownloadFile(i,t,function(t){t?(n.existsSync(s)&&n.rmdirRecursiveSync(s),a._extractBackupZip(i,s,r,function(t){t?o&&o('{"XC_ERR":{"msg":"'+t.message+'"}}'):n.existsSync(s+"backup")?a._restore(e,s,"backup",function(e){e?o&&o('{"XC_ERR":{"code":"000000", "msg":"'+e.message+'"}}'):o('{"XC_SUC":{}}');}):o&&o('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');})):o&&o('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});},x.hub.v5.Handler.prototype.mountUSB=function(e){var t=this;this.Native.mountUSB(function(r,o){r?e&&e({error:r}):t.setBackupUsbPath(o,e);});},x.hub.v5.Handler.prototype.unmountUSB=function(e){try{var t=require("fs-extra");t.remove("./backup_local");}catch(e){}this._usbPath=null;this.Native.unmountUSB(function(t){e&&e({error:t});});},x.hub.v5.Handler.prototype.setBackupUsbPath=function(e,t){this._usbPath=e;var r=require("fs-extra"),o="./backup_local";r.existsSync(o)?r.emptyDirSync(o):r.ensureDirSync(o),r.existsSync(e)||r.ensureDirSync(e),t&&t({});},x.hub.v5.Handler.prototype.saveDeviceXMLforBackup=function(e,t){require("fs-extra").writeFile("./backup_local/devices.xml",e,function(e){t&&t({error:e});});},x.hub.v5.Handler.prototype.saveMacrosXMLforBackup=function(e,t){require("fs-extra").writeFile("./backup_local/macros.xml",e,function(e){t&&t({error:e});});},x.hub.v5.Handler.prototype.saveIrcodesXMLforBackup=function(e,t){require("fs-extra").writeFile("./backup_local/ircodes.xml",e,function(e){t&&t({error:e});});},x.hub.v5.Handler.prototype.backupLocal=function(e,t,r){if(this._usbPath){var o=require("fs-extra"),n="./backup_local",i=this;this._backup(e,n,t,function(e,t,s){o.emptyDir(n),e?r&&r({error:e}):o.move(t,i._usbPath+"/"+s,{overwrite:!0},function(e){r&&r({error:e,data:s});});});}else r&&r({error:new Error("please choose the usb storage")});},x.hub.v5.Handler.prototype.listUsbBackups=function(e){this._usbPath?require("fs-extra").readdir(this._usbPath,function(t,r){if(t)e&&e({error:t});else{for(var o=[],n=0;n<r.length;n++){var i=r[n],s=i.indexOf(".xbp");if(-1!=s){var a={filename:r[n],time:null},u=i.substr(0,s);"backup_"==u.substr(0,7)&&(u=u.substr(7));var c=u.substr(0,4),l=u.substr(4,2),h=u.substr(6,2),p=u.substr(8,2),_=u.substr(10,2),f=u.substr(12,2);a.time=c+"-"+l+"-"+h+" "+p+":"+_+":"+f,o.push(a);}}e&&e({data:o});}}):e&&e({error:new Error("please choose the usb storage")});},x.hub.v5.Handler.prototype.deleteBackup=function(e,t){if(this._usbPath){require("fs-extra").remove(this._usbPath+"/"+e,function(e){t&&t({error:e});});}else t&&t({error:new Error("please mount the usb storage")});},x.hub.v5.Handler.prototype.loadBackup=function(e,t,r){if(this._usbPath){var o=require("fs-extra"),n="./restore_local/",i=this;o.ensureDirSync(n),o.emptyDirSync(n),o.copy(this._usbPath+"/"+e,"./"+e,function(o){o?r&&r({error:o}):i._extractBackupZip("./"+e,n,t,function(e){r&&r({error:e});});});}else r&&r({error:new Error("please choose the usb storage")});},x.hub.v5.Handler.prototype.loadDeviceXML=function(e){require("fs-extra").readFile("./restore_local/backup_local/devices.xml",{encoding:"utf8"},function(t,r){e&&e({error:t,data:r});});},x.hub.v5.Handler.prototype.loadMacroXML=function(e){require("fs-extra").readFile("./restore_local/backup_local/macros.xml",{encoding:"utf8"},function(t,r){e&&e({error:t,data:r});});},x.hub.v5.Handler.prototype.loadIrcodesXML=function(e){require("fs-extra").readFile("./restore_local/backup_local/ircodes.xml",{encoding:"utf8"},function(t,r){e&&e({error:t,data:r});});},x.hub.v5.Handler.prototype.restoreLocal=function(e,t){this._restore(e,"./restore_local/","backup_local",function(e){t&&t({error:e});});},x.hub.v5.Handler.prototype.testReadOnly=function(e){var t=require("fs-extra"),r="./read_only_test_"+new Date().getTime();t.ensureFile(r,function(o){o?e&&e(o):t.remove(r,function(t){e&&e(t);});});},x.hub.v5.Handler.prototype.fixReadOnly=function(e,t){e.writeHead(200,{"Content-Type":"text/plain"}),this.Native._exec("/etc/init.d/S99_checkfs manual",function(t){e.write(t);},function(t){t?e.write('{"XC_ERR":{"code":"01001", "message":"'+t.message+'"}}'):e.write('{"XC_SUC":{}}'),e.end();});},x.hub.v5.Handler.prototype._backup=function(e,t,r,o){var n=this;x.hub.v5.BackupSTData(e,t,function(e){if(e){var i=require("fs-extra");i.copySync("./data",t+"/data"),i.existsSync(t+"/data/localstorage/x.hub.Server.pwd")&&i.removeSync(t+"/data/localstorage/x.hub.Server.pwd"),i.existsSync("/srv/hm-root/opt/hm/etc/config")&&i.copySync("/srv/hm-root/opt/hm/etc/config",t+"/config"),i.existsSync("/srv/z-way-server/config")&&i.copySync("/srv/z-way-server/config",t+"/zway/config"),i.existsSync("/srv/z-way-server/automation/storage")&&i.copySync("/srv/z-way-server/automation/storage",t+"/zway/automation/storage"),i.existsSync("/srv/Apps/zigbee/SYSTEM/data")&&i.copySync("/srv/Apps/zigbee/SYSTEM/data",t+"/zigbee/data");var s=require("archiver"),a=new Date(),u=a.getFullYear()+"",c=a.getMonth()+1+"";1==c.length&&(c="0"+c);var l=a.getDate()+"";1==l.length&&(l="0"+l);var h=a.getHours()+"";1==h.length&&(h="0"+h);var p=a.getMinutes()+"";1==p.length&&(p="0"+p);var _=a.getSeconds()+"";1==_.length&&(_="0"+_);var f="backup_"+(u+c+l+h+p+_)+".xbp",g="/tmp/"+f,v=i.createWriteStream(g),d=s("zip");v.on("close",function(){if(r){var e=require("crypto").createCipher("aes-256-cbc",r),t=i.createReadStream(g),n=i.createWriteStream(g+".enc");n.on("finish",function(){i.removeSync(g),o&&o(null,g+".enc",f);}),t.pipe(e).pipe(n);}else o&&o(null,g,f);}),v.on("error",function(e){n._logger.log("warn","write backup zip file failed:"+e.message),o&&o(e),o=null;}),d.on("error",function(e){n._logger.log("warn","zip backup data failed:"+e.message),o&&o(e),o=null;}),d.pipe(v),d.directory(t+"/","backup"),d.finalize();}else n._logger.log("warn","backup st data failed"),o&&o(new Error("backup st data failed")),o=null;});},x.hub.v5.Handler.prototype._extractBackupZip=function(e,t,r,o){var n=require("fs"),i=require("fs-extra"),s=require("adm-zip"),a=null;try{new s(e).extractAllTo(t,!0);}catch(e){a="invalid backup file/password";}if(a){if(r){var u=require("crypto").createDecipher("aes-256-cbc",r),c=n.createReadStream(e),l=n.createWriteStream(e+".dec.zip");u.on("error",function(){i.removeSync(e),i.removeSync(e+".dec.zip"),o&&o(new Error(a));}),l.on("finish",function(){a=null;try{new s(e+".dec.zip").extractAllTo(t,!0);}catch(e){a="invalid backup file/password";}i.removeSync(e),i.removeSync(e+".dec.zip"),o&&o(a?new Error(a):null);}),c.pipe(u).pipe(l);}else i.removeSync(e),o&&o(new Error(a)),o=null;}else i.removeSync(e),o&&o(),o=null;},x.hub.v5.Handler.prototype._restore=function(e,t,r,o){var n=require("fs"),i=require("fs-extra"),s=t+r;if(n.existsSync(s+"/zigbee/data"))try{i.ensureDirSync("/srv/Apps/zigbee/SYSTEM"),i.copySync(s+"/zigbee/data","/srv/Apps/zigbee/SYSTEM/data");}catch(e){}if(n.existsSync(s+"/zway/config")&&n.existsSync("/srv/z-way-server"))try{i.copySync(s+"/zway/config","/srv/z-way-server/config");}catch(e){}if(n.existsSync(s+"/zway/automation/storage")&&n.existsSync("/srv/z-way-server/automation"))try{i.copySync(s+"/zway/automation/storage","/srv/z-way-server/automation/storage");}catch(e){}this._restoreHM(s,function(){x.hub.v5.RestoreSTData(e,s,function(e){e?i.copy(s+"/data","./data",function(e){i.removeSync(t),e&&o?o(new Error("internal error")):o&&o();}):o&&o(new Error("internal error"));});});},x.hub.v5.Handler.prototype._restoreHM=function(e,t){var r=require("fs"),o=require("fs-extra"),n=require("path");function extension(e){var t=n.extname(e);return".ap"===t||".apkx"===t;}r.existsSync(e+"/config")&&r.existsSync("/srv/hm-root/opt/hm/etc")?this.Native.resetHM(function(n){XC.debugf("reset HM:"+n);try{o.copySync(e+"/config","/srv/hm-root/opt/hm/etc/config");var i=[];r.readdirSync("/srv/hm-root/opt/hm/etc/config/crRFD/data").filter(extension).forEach(function(e){i.push(e);});for(var s=0;s<i.length;s++){;}}catch(e){console.error(e);}t&&t();}):t&&t();},x.hub.v5.Handler.prototype.getSerialPorts=function(e){var t=null;try{t=require("serialport");}catch(e){t=null;}t?this.Native.runMdev(function(r){console.log("run mdev finish",r),r?e(JSON.stringify({XC_ERR:{code:"00000",msg:"run mdev error:"+r.message}})):t.list(function(t,r){console.log("list serial port finish",t,JSON.stringify(r)),null==r&&(r=[]);for(var o=[],n=0;n<r.length;n++){r[n]&&o.push(r[n].comName);}e('{"XC_SUC":'+JSON.stringify(o)+"}");});}):e('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');},x.hub.v5.Handler.prototype.getLogs=function(e){var t=require("fs-extra"),r=require("archiver"),o="logs_"+new Date().toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",n="/tmp/"+o,i=t.createWriteStream(n),s=r("zip");i.on("close",function(){e.setHeader("Content-disposition","attachment; filename="+o),e.sendFile(n,null,function(r){t.removeSync(n),r&&e.status(500).end();});}),i.on("error",function(t){e.status(500).end();}),s.on("error",function(t){e.status(500).end();}),s.pipe(i),s.directory("/var/log"),s.finalize();},x.hub.v5.Handler.prototype.getNeoServerLogs=function(e){var t=require("path"),r=require("x.hub.fileman.js").fileManager,o=r.getUserRootDataPath(),n=t.dirname(r.getLogFile()),i=r.getTmpDir(),s=require("fs-extra"),a=require("archiver"),u="logs_"+new Date().toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",c=i+t.sep+u,l=s.createWriteStream(c),h=a("zip");l.on("close",function(){var t=c;e.setHeader("Content-disposition","attachment; filename="+u),e.sendFile(t,null,function(r){s.removeSync(t),r&&e.status(500).end();});}),l.on("error",function(t){e.status(500).end();}),h.on("error",function(t){e.status(500).end();}),h.pipe(l),h.directory(o),h.directory(n),h.finalize();},x.hub.v5.Handler.prototype.clearLogs=function(e){require("fs-extra").emptyDir("/var/log",function(t){e&&e();});},x.hub.v5.Handler.prototype.reset=function(e,t,r){var o=require("fs"),n=require("fs-extra");"passwords"==t?(o.existsSync("./data/localstorage/x.hub.Server.pwd")&&n.removeSync("./data/localstorage/x.hub.Server.pwd"),r&&r()):"factory"==t?(o.existsSync("./data")&&n.emptyDirSync("./data"),x.hub.v5.ResetSTData(e,function(){r&&r();})):r&&r();},x.hub.v5.Handler.prototype.resetST=function(e){this._logger.log("info","reset st"),this._logger.log("trace","set st led to permant white");var t=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(r){var o;if(!r||!r.XC_SUC)return o=r&&r.XC_ERR?new Error(r.XC_ERR):new Error("set led white failed"),t._logger.log("trace","set led white error:"+o.message),void(e&&e(o));t._logger.log("trace","reset st data"),x.hub.v5.ResetSTData(t.server,function(){t._logger.log("trace","reboot st");var r=new(require("xnm.aio.m10T.js").STMUpdater)();r.hostType=t.server.hostType,r.resetST(),t._logger.log("info","reset st finish"),e&&e();});});},x.hub.v5.Handler.prototype.rebootST=function(e){this._logger.log("info","reboot st"),this._logger.log("trace","set st led to permant white");var t=this;this.server.doSTMCommand("XC_FNC=SendSC&type=RGB&data=0105",function(r){var o;if(!r||!r.XC_SUC)return o=r&&r.XC_ERR?new Error(r.XC_ERR):new Error("set led white failed"),t._logger.log("trace","set led white error:"+o.message),void(e&&e(o));t._logger.log("trace","now reboot st");var n=new(require("xnm.aio.m10T.js").STMUpdater)();n.hostType=t.server.hostType,n.resetST(),t._logger.log("info","reboot st finish"),e&&e();});},x.hub.v5.Handler.prototype.USBSerial=x.hub.v5.USBSerial,x.hub.v5.Handler.prototype.CloudConnect=x.hub.v5.CloudConnect,x.hub.v5.Handler.prototype.LocalSPIBus=x.hub.v5.LocalSPIBus,x.hub.v5.Handler.prototype.Native=new x.hub.v5.NativeWrapper(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.v5.Handler());