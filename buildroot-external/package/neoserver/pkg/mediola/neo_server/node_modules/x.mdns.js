var x=x||{};x.mdns=x.mdns||{},x.mdns.DNS_SD=function(){var RR=function RR(){this.name=null,this.type=null,this["class"]=null,this.ttl=null,this.length=null,this.data=null;};RR.prototype.resolveData=function(t){this.data=t;},RR.prototype.toJSON=function(){return this;};var TXT_RR=function TXT_RR(){this._info={};};TXT_RR.prototype.resolveData=function(t,e,r,s){for(var n=0;n<t.length-1;){var a,i=2*parseInt(t.substr(n,2),16);if(a=n+2+i>t.length?t.substr(n+2,t.length-n-2):t.substr(n+2,i)){var o=(a=DNS_Packet._hex2a(a)).indexOf("=");if(-1!=o&&o!=a.length-1){var h=a.substr(0,o),u=a.substr(o+1);this._info[h]=u;}}n+=2+i;}},TXT_RR.prototype.toJSON=function(){};var PTR_RR=function PTR_RR(){};PTR_RR.prototype.resolveData=function(t,e,r,s){this.domain=DNS_Packet._parseName(e,r,s).name;},PTR_RR.prototype.getNameTxt=function(){return this.name?DNS_Packet._hex2name(this.name):null;},PTR_RR.prototype.getDomainTxt=function(){return this.domain?DNS_Packet._hex2name(this.domain):null;},PTR_RR.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,domain:this.getDomainTxt()};};var SRV_RR=function SRV_RR(){};SRV_RR.prototype.resolveData=function(t,e,r,s){this.priority=parseInt(t.substr(0,4),16),this.weight=parseInt(t.substr(4,4),16),this.port=parseInt(t.substr(8,4),16),this.target=DNS_Packet._parseName(e+12,r,s).name;},SRV_RR.prototype.getNameTxt=function(){return this.name?DNS_Packet._hex2name(this.name):null;},SRV_RR.prototype.getTargetTxt=function(){return this.target?DNS_Packet._hex2name(this.target):null;},SRV_RR.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,priority:this.priority,weight:this.weight,port:this.port,target:this.getTargetTxt()};};var A_RR=function A_RR(){};A_RR.prototype.resolveData=function(t){this.addr=t;},A_RR.prototype.getNameTxt=function(){return this.name?DNS_Packet._hex2name(this.name):null;},A_RR.prototype.getAddrTxt=function(){return A_RR._hex2ipv4(this.addr);},A_RR.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,addr:this.getAddrTxt()};},A_RR._hex2ipv4=function(t){if(!t||t.length<8)return null;var e="";return e+=parseInt(t.substr(0,2),16)+".",e+=parseInt(t.substr(2,2),16)+".",e+=parseInt(t.substr(4,2),16)+".",e+=parseInt(t.substr(6,2),16);};var AAAA_RR=function AAAA_RR(){};AAAA_RR.prototype.resolveData=function(t){this.addr=t;},AAAA_RR.prototype.getNameTxt=function(){return this.name?DNS_Packet._hex2name(this.name):null;},AAAA_RR.prototype.getAddrTxt=function(){if(!this.addr||this.addr.length<32)return null;var t="";return t+=this.addr.substr(0,4)+":",t+=this.addr.substr(4,4)+":",t+=this.addr.substr(8,4)+":",t+=this.addr.substr(12,4)+":",t+=this.addr.substr(16,4)+":",t+=this.addr.substr(20,4)+":",t+=this.addr.substr(24,4)+":",t+=this.addr.substr(28,4);},AAAA_RR.prototype.toJSON=function(){return{name:this.getNameTxt(),type:this.type,"class":this["class"],ttl:this.ttl,length:this.length,addr:this.getAddrTxt()};};var Query=function Query(t,e){this.name=t,this.type=e;};Query.prototype._name2Array=function(){if(!this.name)return null;for(var t=[],e=0;e<this.name.length-1;e+=2){var r=this.name.substr(e,2);t.push(parseInt(r,16));}return t;},Query.prototype.toArray=function(){var t=[];t.push(0),t.push(0),t.push(0),t.push(0),t.push(0),t.push(1),t.push(0),t.push(0),t.push(0),t.push(0),t.push(0),t.push(0);var e=this._name2Array(this.name);if(!e)return null;for(var r=0;r<e.length;r++){t.push(e[r]);}switch(t.push(0),this.type){case 12:t.push(0),t.push(12);break;case 33:t.push(0),t.push(33);break;case 1:t.push(0),t.push(1);break;default:return null;}return t.push(0),t.push(1),t;};var DNS_Packet=function DNS_Packet(){this.id=0,this.flag=0,this.qdCount=0,this.anCount=0,this.nsCount=0,this.arCount=0,this.querys=[],this.answers=[],this.authorities=[],this.additionals=[];};DNS_Packet.prototype.isResponse=function(){return this.flag>>15==1;},DNS_Packet.prototype.toJSON=function(){var t,e={id:this.id,flag:this.flag,qdCount:this.qdCount,anCount:this.anCount,nsCount:this.nsCount,arCount:this.arCount,querys:[],answers:[],authorities:[],additionals:[]};for(t=0;t<this.querys.length;t++){e.querys.push(this.querys[t].toJSON());}for(t=0;t<this.answers.length;t++){e.answers.push(this.answers[t].toJSON());}for(t=0;t<this.additionals.length;t++){e.additionals.push(this.additionals[t].toJSON());}return e;},DNS_Packet.parse=function(t){var e=new DNS_Packet();t.length>4&&(e.id=parseInt(t.substr(0,4),16)),t.length>8&&(e.flag=parseInt(t.substr(4,4),16)),t.length>12&&(e.qdCount=parseInt(t.substr(8,4),16)),t.length>16&&(e.anCount=parseInt(t.substr(12,4),16)),t.length>20&&(e.nsCount=parseInt(t.substr(16,4),16)),t.length>24&&(e.arCount=parseInt(t.substr(20,4),16));var r,s=24;if(e.qdCount>0)for(r=0;r<e.qdCount;r++){var n=DNS_Packet._parseQuery(s,t);s=n.queryEnd,e.querys.push(n.query);}if(e.anCount>0)for(r=0;r<e.anCount;r++){var a=DNS_Packet._parseAnswer(s,t);s=a.answerEnd,e.answers.push(a.answer);}if(e.nsCount>0)for(r=0;r<e.arCount;r++){var i=DNS_Packet._parseAuthority(s,t);s=i.nsEnd,e.authorities.push(i.ns);}if(e.arCount>0)for(r=0;r<e.arCount;r++){var o=DNS_Packet._parseAdditional(s,t);s=o.addiEnd,e.additionals.push(o.addi);}return e;},DNS_Packet._parseName=function(t,e,r,s){if((s=s?s+1:1)>10)return{index:t,name:""};for(var n,a,i=t,o=t,h=!1;r.length>o+2&&"00"!=r.substr(o,2)&&!(e&&o-i>=2*e);){if(parseInt(r.substr(o,2),16)>>7==1){var u=16383&parseInt(r.substr(o,4),16);a=DNS_Packet._parseName(2*u,null,r,s).name,h=!0,o+=4;break;}o+=2+2*parseInt(r.substr(o,2),16);}return h?(n=r.substr(i,o-i-4),n+=a):(n=r.substr(i,o-i),o+=2),{index:o,name:n};},DNS_Packet._name2hex=function(t){for(var e="",r=t.split("."),s=0;s<r.length;s++){for(var n=r[s].length.toString(16);n.length<2;){n="0"+n;}e+=n;for(var a=0;a<r[s].length;a++){for(var i=r[s].charCodeAt(a).toString(16);i.length<2;){i="0"+i;}e+=i;}}return e;},DNS_Packet._hex2name=function(t){for(var e="",r=0;r<t.length;){var s=parseInt(t.substr(r,2),16),n=t.substr(r+2,2*s);e&&(e+="."),e+=DNS_Packet._hex2a(n),r+=2+2*s;}return e;},DNS_Packet._hex2a=function(t){for(var e=t.toString(),r="",s=0;s<e.length;s+=2){r+=String.fromCharCode(parseInt(e.substr(s,2),16));}return r;},DNS_Packet._parseRR=function(t,e){var r,s={},n=DNS_Packet._parseName(t,null,e),a=n.index,i=a;switch(s.name=n.name,e.length>a+4&&(i=a+4,s.type=parseInt(e.substr(a,4),16)),e.length>a+4+4&&(i=a+8,s["class"]=parseInt(e.substr(a+4,4),16)),e.length>a+8+8&&(i=a+16,s.ttl=parseInt(e.substr(a+8,8),16)),e.length>a+16+4&&(i=a+20,s.length=parseInt(e.substr(a+16,4),16)),s.length>0&&e.length>=a+20+2*s.length&&(i=a+20+2*s.length,s.data=e.substr(a+20,2*s.length)),s.type){case 12:r=new PTR_RR();break;case 16:r=new TXT_RR();break;case 33:r=new SRV_RR();break;case 1:r=new A_RR();break;case 28:r=new AAAA_RR();break;default:r=new RR();}return r&&(r.name=s.name,r.type=s.type,r["class"]=s["class"],r.ttl=s.ttl,r.length=s.length,r.dataRaw=s.data,s.data&&r.resolveData(s.data,a+20,s.length,e)),{end:i,rr:r};},DNS_Packet._parseQuery=function(t,e){var r=new Query(),s=DNS_Packet._parseName(t,null,e),n=s.index;return r.name=s.name,e.length>n+4&&(r.type=parseInt(e.substr(n,4),16)),e.length>=n+4+4&&(r["class"]=parseInt(e.substr(n+4,4),16)),{queryEnd:n+8,query:r};},DNS_Packet._parseAnswer=function(t,e){var r=DNS_Packet._parseRR(t,e);return{answerEnd:r.end,answer:r.rr};},DNS_Packet._parseAuthority=function(t,e){var r=DNS_Packet._parseRR(t,e);return{nsEnd:r.end,ns:r.rr};},DNS_Packet._parseAdditional=function(t,e){var r=DNS_Packet._parseRR(t,e);return{addiEnd:r.end,addi:r.rr};};var DNS_SD=function DNS_SD(){this._sockets=[],this._searchCallbacks={},this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}};};return DNS_SD.prototype.startListener=function(t){var e="undefined"!=typeof console&&"function"==typeof console.error;function createSocket(t,r,s){var n,a=this,i=s,o=require("dgram");try{n=o.createSocket({type:"udp4",reuseAddr:!0});}catch(t){n=o.createSocket("udp4");}n.on("message",function(t,e){a._onReceiveDNSPacket(t,e);}),n.on("listening",function(){try{n.setBroadcast(!0),n.addMembership("224.0.0.251"),i&&(i(null,n),i=null);}catch(s){e&&console.error("Caught error:",s),e&&console.error("Address causing the error: "+r,t),i&&(i(s),i=null);}}),n.on("error",function(t){e&&console.error("Socket on error:",t),i&&(i(t),i=null);}),n.bind(t,r);}var r=this,s=require("os");if(s&&s.networkInterfaces){var n=s.networkInterfaces(),a=[];for(var i in n){if(n.hasOwnProperty(i))for(var o=n[i],h=0;h<o.length;h++){"IPv4"==o[h].family&&0==o[h].internal&&a.push(o[h].address);}}(function(t,r){var s,n=this,a=r,i=require("dgram");try{s=i.createSocket({type:"udp4",reuseAddr:!0});}catch(t){s=i.createSocket("udp4");}s.on("message",function(t,e){n._onReceiveDNSPacket(t,e);}),s.on("listening",function(){var r=null;try{s.setBroadcast(!0);for(var n=0;n<t.length;n++){r=t[n],s.addMembership("224.0.0.251",r);}a&&(a(null,s),a=null);}catch(s){e&&console.error("Caught error:",s),e&&console.error("Address causing the error: "+r,"| All: "+t.join(", ")),a&&(a(s),a=null);}}),s.on("error",function(t){e&&console.error("Socket on error:",t),a&&(a(t),a=null);}),s.bind(5353);}).call(this,a,function(e,s){if(e)t&&t(e);else{s&&r._sockets.push(s);for(var n=0,i=0;i<a.length;i++){createSocket.call(r,5353,a[i],function(e,s){n++,!e&&s&&(s._isSendSocket=!0,r._sockets.push(s)),n==a.length&&t&&t();});}}});}else createSocket.call(this,5353,null,function(e,s){e?t&&t(e):(s&&(s._isSendSocket=!0,r._sockets.push(s)),t&&t());});},DNS_SD.prototype.stopListener=function(t){if(this._sockets)for(var e=0;e<this._sockets.length;e++){var r=this._sockets[e];r&&r.close();}t&&t();},DNS_SD.prototype.removeDiscoverServiceCallback=function(t,e){if(t&&e){var r=this._searchCallbacks[t];if(r){for(var s=-1,n=0;n<r.length;n++){if(r[n]===e){s=n;break;}}-1!=s&&r.splice(s,1);}}},DNS_SD.prototype.clearRecordBuffer=function(){this._rrBuffer={_txtRecords:{},_ptrRecords:{},_srvRecords:{},_aRecords:{},_aaaaRecords:{}};},DNS_SD.prototype.discoverService=function(t,e){if(t){var r=this._searchCallbacks[t];r||(this._searchCallbacks[t]=[],r=this._searchCallbacks[t]),e&&-1==r.indexOf(e)&&r.push(e),e._targets=[],e._domains=[];var s=DNS_Packet._name2hex(t),n=new Query(s,12).toArray();n&&this._sendQuery(new Buffer(n));}else e&&e(new Error("serviceType is empty"));},DNS_SD.prototype._sendQuery=function(t){for(var e=0;e<this._sockets.length;e++){var r=this._sockets[e];r._isSendSocket&&r.send(t,0,t.length,5353,"224.0.0.251");}},DNS_SD.prototype._searchRecords=function(){var t;for(var e in this._searchCallbacks){if(this._searchCallbacks.hasOwnProperty(e)){var r=DNS_Packet._name2hex(e);if(this._rrBuffer._ptrRecords[r])for(var s=0;s<this._rrBuffer._ptrRecords[r].length;s++){var n=this._rrBuffer._ptrRecords[r][s],a=this._rrBuffer._txtRecords[n];if(this._rrBuffer._srvRecords[n])for(var i=0;i<this._rrBuffer._srvRecords[n].length;i++){var o=this._rrBuffer._srvRecords[n][i];if(this._rrBuffer._aRecords[o]){if(this._rrBuffer._aRecords[o].length>0){for(var h=[],u=0;u<this._rrBuffer._aRecords[o].length;u++){var l=this._rrBuffer._aRecords[o][u],c=A_RR._hex2ipv4(l);c&&h.push(c);}if(h.length>0){var d=this._searchCallbacks[e];if(d)for(var f=DNS_Packet._hex2name(o),p=DNS_Packet._hex2name(n),_=0;_<d.length;_++){var v=d[_];if(v){var g=v._domains;g||(v._domains=[],g=v._domains),-1==g.indexOf(p)&&(v._domains.push(p),v(null,{target:f,domain:p,ip:h,info:a}));}}}}}else(t=new Query(o,1).toArray())&&this._sendQuery(new Buffer(t));}else(t=new Query(n,33).toArray())&&this._sendQuery(new Buffer(t));}}}},DNS_SD.prototype._handleRR=function(t){var e,r,s,n;switch(t.type){case 12:e=t.name;var a=t.domain,i=this._rrBuffer._ptrRecords[e];for(i||(this._rrBuffer._ptrRecords[e]=[],i=this._rrBuffer._ptrRecords[e]),r=!1,s=0;s<i.length;s++){if(i[s]==a){r=!0;break;}}r||i.push(a);break;case 16:e=t.name,this._rrBuffer._txtRecords[e]=t._info;break;case 33:e=t.name;var o=t.target,h=this._rrBuffer._srvRecords[e];for(h||(this._rrBuffer._srvRecords[e]=[],h=this._rrBuffer._srvRecords[e]),r=!1,s=0;s<h.length;s++){if(h[s]==o){r=!0;break;}}r||h.push(o);break;case 1:e=t.name,n=t.addr;var u=this._rrBuffer._aRecords[e];for(u||(this._rrBuffer._aRecords[e]=[],u=this._rrBuffer._aRecords[e]),r=!1,s=0;s<u.length;s++){if(u[s]==n){r=!0;break;}}r||u.push(n);break;case 28:e=t.name,n=t.addr;var l=this._rrBuffer._aaaaRecords[e];for(l||(this._rrBuffer._aaaaRecords[e]=[],l=this._rrBuffer._aaaaRecords[e]),r=!1,s=0;s<l.length;s++){if(l[s]==n){r=!0;break;}}r||l.push(n);}},DNS_SD.prototype._onReceiveDNSPacket=function(t,e){var r=t.toString("hex"),s=DNS_Packet.parse(r);if(s&&s.isResponse()){var n,a;if(s.answers)for(n=0;n<s.answers.length;n++){(a=s.answers[n])&&this._handleRR(a);}if(s.authorities)for(n=0;n<s.authorities.length;n++){(a=s.authorities[n])&&this._handleRR(a);}if(s.additionals)for(n=0;n<s.additionals.length;n++){(a=s.additionals[n])&&this._handleRR(a);}this._searchRecords();}},DNS_SD;}(),x.mdns.Handler=function(){var NodeHandler=function NodeHandler(){this._mDns=null;};NodeHandler.prototype.start=function(t){if(this._mDns)t&&t();else{var e=this,r=new x.mdns.DNS_SD();r.startListener(function(s){s||(e._mDns=r),t&&t(s);});}},NodeHandler.prototype.stop=function(t){if(this._mDns){var e=this;this._mDns.stopListener(function(){e._mDns=null,t&&t();});}else t&&t(new Error("mDns not started"));},NodeHandler.prototype.clearRecordBuffer=function(){this._mDns&&this._mDns.clearRecordBuffer();},NodeHandler.prototype.discoverServiceWithTimeout=function(t,e,r){var s=this,n=[];this.discoverService(t,function(t,e){!t&&e&&n.push(e);}),setTimeout(function(){s._mDns&&s._mDns.removeDiscoverServiceCallback(t,r),r&&r(null,n);},e);},NodeHandler.prototype.discoverService=function(t,e){if(t){-1==t.indexOf(".local")&&(t+=".local");var r=this;this._mDns?this._mDns.discoverService(t,e):this.start(function(s){s?e&&e(s):r._mDns.discoverService(t,e);});}else e&&e(new Error("serviceType is empty"));},NodeHandler.prototype.stopDiscover=function(t,e){this._mDns?this._mDns.removeDiscoverServiceCallback(t,e):e&&e();};var t=function(){var ServiceHandler=function ServiceHandler(t,e,r){this._serviceType=t,this._domain=e,this._ios=r,this._running=!1,this._callbacks=[],this._services=[];};ServiceHandler.prototype.discover=function(t){if(t&&-1==this._callbacks.indexOf(t)&&this._callbacks.push(t),this._running)for(var e=0;e<this._services.length;e++){t&&t(null,this._services[e]);}else if(!this._running){this._running=!0;var r=this;XC.callHost("mdns","search",{service:this._serviceType},function(t){if(t.error){for(var e=0;e<r._callbacks.length;e++){r._callbacks[e](new Error(t.error));}return r._callbacks=[],void r._stop();}t.target&&"."==t.target.charAt(t.target.length-1)&&(t.target=t.target.substr(0,t.target.length-1)),t.domain&&"."==t.domain.charAt(t.domain.length-1)&&(t.domain=t.domain.substr(0,t.domain.length-1)),r._services.push(t);for(var s=0;s<r._callbacks.length;s++){r._callbacks[s](null,t);}});}},ServiceHandler.prototype.removeCallback=function(t){var e=!1;if(t&&this._callbacks.length>0){var r=this._callbacks.indexOf(t);-1!=r&&this._callbacks.splice(r,1);}return 0==this._callbacks.length&&(this._stop(),e=!0),e;},ServiceHandler.prototype._stop=function(){XC.callHost("mdns","stop",{service:this._serviceType},function(t){});};var iOS=function iOS(){this._serviceHandlers={};};return iOS.prototype.start=function(t){t&&t();},iOS.prototype.stop=function(t){t&&t();},iOS.prototype.clearRecordBuffer=function(){},iOS.prototype.discoverServiceWithTimeout=function(t,e,r){var s=this,n=[],cb=function cb(t,e){!t&&e&&n.push(e);};this.discoverService(t,cb),setTimeout(function(){s._removeDiscoverServiceCallback(t,cb),r&&r(null,n);},e);},iOS.prototype.discoverService=function(t,e){if(t){-1!=t.indexOf(".local")&&(t=t.replace(".local",""));var r=this._serviceHandlers[t];r||(r=new ServiceHandler(t,"local",this),this._serviceHandlers[t]=r),r.discover(e);}else e&&e(new Error("serviceType is empty"));},iOS.prototype.stopDiscover=function(t,e){if(t){-1!=t.indexOf(".local")&&(t=t.replace(".local",""));var r=this._serviceHandlers[t];if(r)r.removeCallback(e)&&delete this._serviceHandlers[t];else e&&e();}else e&&e(new Error("serviceType is empty"));},iOS.prototype._removeDiscoverServiceCallback=function(t,e){-1!=t.indexOf(".local")&&(t=t.replace(".local",""));var r=this._serviceHandlers[t];r&&r.removeCallback(e)&&delete this._serviceHandlers[t];},iOS;}(),e=t,Handler=function Handler(){this._nativeHandler=null;};return Handler.prototype.start=function(t){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.start(t);},Handler.prototype.stop=function(t){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.stop(t);},Handler.prototype.clearRecordBuffer=function(){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.clearRecordBuffer();},Handler.prototype.discoverServiceWithTimeout=function(t,e,r){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.discoverServiceWithTimeout(t,e,r);},Handler.prototype.discoverService=function(t,e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.discoverService(t,e);},Handler.prototype.stopDiscover=function(t,e){this._nativeHandler||(this._nativeHandler=this._getNativeHandler()),this._nativeHandler.stopDiscover(t,e);},Handler.prototype._getNativeHandler=function(){var r=null;return"undefined"!=typeof window&&null!=window&&window.XCHost||(r="node-webkit"),"undefined"!=typeof window&&null!=window&&window.XCHost&&window.XCHost.getType&&(r=window.XCHost.getType()),"Android"==r?new e():"node-webkit"==r||"undefined"!=typeof process&&null!=process&&"node"==process.title?new NodeHandler():new t();},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new x.mdns.Handler());