var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.bose=xnm.aio.bose||{},xnm.aio.bose.SoundTouch=function(){var SoundTouch=function SoundTouch(e){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.bose.SoundTouch"):this._logger={log:{}},this._renderer=null,this.mac=e?e.mac:null,this.name=e?e.name:null,this.bass=e?e.base:null,this.sources=e?e.sources:null,this.isMaster=!1,this.members=null,e&&e.ip&&e.port&&e.uuid&&(this._renderer=this._getRenderer(e.ip,e.port,e.uuid));};return SoundTouch.PLAY_STATUS=["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"],SoundTouch.prototype.getIP=function(){return this._renderer?this._renderer.ip:null;},SoundTouch.prototype.setIP=function(e){this._renderer&&(this._renderer.ip=e);},SoundTouch.prototype.getPort=function(){return this._renderer?this._renderer.port:null;},SoundTouch.prototype.setPort=function(e){this._renderer&&(this._renderer.port=e);},SoundTouch.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null;},SoundTouch.prototype.getName=function(){return this.name?this.name:this._renderer?this._renderer.name:null;},SoundTouch.prototype.getMac=function(){return this.mac?this.mac:this._renderer?this._renderer.serialNumber:null;},SoundTouch.prototype.getInfos=function(e){var t=4,r={},cb=function cb(n){t--,n?e&&e(n):0==t&&e&&e(null,r);};this._getInfo(function(e,t){t&&(r.name=t.name,r.mac=t.mac),cb&&cb(e),e&&(cb=null);}),this._getBassCap(function(e,t){t&&(r.bass=t.bass),cb&&cb(e),e&&(cb=null);}),this._getSources(function(e,t){t&&(r.sources=t),cb&&cb(e),e&&(cb=null);}),this._getZone(function(e,t){t&&(r.zoneInfo=t),cb&&cb(e),e&&(cb=null);});},SoundTouch.prototype.getRooms=function(e){var t=require("xnm.aio.bose.js").master,r=this;t.getZones(function(t,n){if(t)e&&e(t);else{for(var s={},a=0;a<n.length;a++){var o=n[a];if(o&&o.masterMac==r.mac){for(var i=0;i<o.players.length;i++){var u=o.players[i];u&&u.mac&&u.name&&(s[u.mac]=u.name);}break;}}e&&e(null,s);}});},SoundTouch.prototype.getPlayInfo=function(e){this._getNowPlaying(function(t,r){if(t)e&&e(t);else{var n={trackMetaData:r};n.trackMetaData.albumArtURI=r.art,n.trackMetaData.title=r.track,e&&e(null,n);}});},SoundTouch.prototype.play=function(e,t,r){if(e&&t&&t["class"]&&t.id){if(this._renderer){var n=this;e.browseMetaData(t.id,function(s,a){if(s)r&&r(s);else if(0!=t["class"].indexOf("object.container")||t.res&&t.res.url){if(!t.res||!t.res.url)return void(r&&r(new Error("resource url invalid")));n._renderer.playResource({url:t.res.url},a.result,r);}else{if(!e.uuid)return void(r&&r(new Error("media server uuid invalid")));n._renderer.playContainer({containerID:t.id,server_uuid:e.uuid},a.result,r);}});}else r&&r(new Error("renderer not inited"));}else r&&r(new Error("play obj invalid"));},SoundTouch.prototype.playUrl=function(e,t){if(e){var r=this;this._renderer._setAVTransportURI(0,e,null,function(e){e?t&&t(e):r._renderer.play(t);});}else t&&t(new Error("url is null"));},SoundTouch.prototype.browser=function(e,t,r,n,s){if(e){t||(t=0),r||(r=0),n||(n=0);e.browseChildren(t,r,n,null,function(e,t,r){s&&s(e,t,r);});}else s&&s(new Error("play obj invalid"));},SoundTouch.prototype.executeCommandCreator=function(e,t,r){t&&t.value?this._executeCommand(t.value,t.ext,function(e){r&&r(e);}):r&&r(new Error("command value is empty"));},SoundTouch.prototype.getStatesCreator=function(e,t,r){this._getStates(function(e,n){if(e)r&&r(e);else{for(var s=[],a=0;a<t.length;a++){var o=t[a];if(o&&o.id&&o.status){var i="?";switch(o.status.value){case"power":case"muted":case"volume":case"repeatMode":case"shuffleMode":case"playState":case"durationS":case"positionS":case"bass":i=n[o.status.value];break;case"artist":case"title":case"album":case"radio":(i=n[o.status.value])||(i="");}void 0!==i&&null!=i||(i="?"),s.push({id:o.id,status:i});}}r&&r(null,s);}});},SoundTouch.prototype._executeCommand=function(e,t,r){if(this._renderer){var n,s=this;switch(e){case"play":this._clickKey("PLAY",r);break;case"pause":this._clickKey("PAUSE",r);break;case"tooglePlay":this._clickKey("PLAY_PAUSE",r);break;case"stop":this._clickKey("STOP",r);break;case"previous":this._clickKey("PREV_TRACK",r);break;case"next":this._clickKey("NEXT_TRACK",r);break;case"togglePower":this._clickKey("POWER",r);break;case"toggleMute":this._clickKey("MUTE",r);break;case"volumeUp":this._clickKey("VOLUME_UP",r);break;case"volumeDown":this._clickKey("VOLUME_DOWN",r);break;case"setVolume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));var a=parseInt(t);a>100&&(a=100),a<0&&(a=0),this._setVolume(a,r);break;case"thumbUp":this._clickKey("THUMBS_UP",r);break;case"thumbDown":this._clickKey("THUMBS_DOWN",r);break;case"bookmark":this._clickKey("BOOKMARK",r);break;case"preset":if(!t)return void(r&&r(new Error("preset value invalid")));this._clickKey("PRESET_"+t,r);break;case"shuffleOn":this._clickKey("SHUFFLE_ON",r);break;case"shuffleOff":this._clickKey("SHUFFLE_OFF",r);break;case"toggleShuffle":this._getNowPlaying(function(e,t){if(e)r&&r(e);else if(t&&t.shuffleSetting){var n="SHUFFLE_ON";"SHUFFLE_ON"==t.shuffleSetting&&(n="SHUFFLE_OFF"),s._clickKey(n,r);}else r&&r(new Error("no shuffle setting"));});break;case"setRepeatMode":if(!t)return void(r&&r(new Error("play mode value invalid")));this._clickKey(t,r);break;case"addFav":this._clickKey("ADD_FAVORITE",r);break;case"removeFav":this._clickKey("REMOVE_FAVORITE",r);break;case"bassUp":case"bassDown":if(void 0===t||null==t)return void(r&&r(new Error("seek value invalid")));this._getBass(function(t,a){if(t)r&&r(t);else if(a&&void 0!==a.actualbass&&null!=a.actualbass){var o=a.actualbass;if("bassUp"==e?o+=1:o-=1,this.bass&&-1!=(n=this.bass.indexOf("-",1))){var i=this.bass.substring(0,n),u=this.bass.substr(n+1);o<(i=parseInt(i))&&(o=i),o>(u=parseInt(u))&&(o=u);}s._setBass(o,r);}else r&&r(new Error("no bass info"));});break;case"setBass":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));var o=parseInt(t);if(this.bass&&-1!=(n=this.bass.indexOf("-",1))){var i=this.bass.substring(0,n),u=this.bass.substr(n+1);o<(i=parseInt(i))&&(o=i),o>(u=parseInt(u))&&(o=u);}this._setBass(o,r);break;case"playUrl":if(!t)return void(r&&r(new Error("url value invalid")));this.playUrl(t,r);break;default:if(e&&"select:"==e.substr(0,7)){var l=e.substr(7);n=l.indexOf("@");var c=l.substring(0,n),p=l.substr(n+1);s._setSource(c,p,r);}else r&&r(new Error("unknown command"));}}else r&&r(new Error("renderer not initialized"));},SoundTouch.prototype._getStates=function(e){var cb=function cb(){0==--r&&e&&e(null,t);},t={},r=3;this._getBass(function(e,r){!e&&r&&(t.bass=r.actualbass),cb();}),this._getVolume(function(e,r){!e&&r&&(t.volume=r.actualvolume,t.muted=r.muteenabled),cb();}),this._getNowPlaying(function(e,r){!e&&r&&("STANDBY"==r.source?t.power="off":t.power="on",r.repeatSetting&&(t.repeatMode=r.repeatSetting),r.shuffleSetting&&(t.shuffleMode=r.shuffleSetting),r.playStatus&&(t.playState=r.playStatus),r.duration&&(t.durationS=r.duration),r.position&&(t.positionS=r.position),r.position&&(t.positionS=r.position),r.track&&(t.title=r.track),r.stationName&&(t.radio=r.stationName),r.artist&&(t.artist=r.artist),r.album&&(t.album=r.album)),cb();});},SoundTouch.prototype._getRenderer=function(e,t,r){var n=new(require("x.upnp.js").MediaRenderer)();return n.init(e,t,r,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/UD/"+r+"?2"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/UD/"+r+"?1"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/UD/"+r+"?0"}}),n;},SoundTouch.prototype._clickKey=function(e,t){var r=this;this._pressKey(e,function(n){n?t&&t(n):r._releaseKey(e,function(e){t&&t(e);});});},SoundTouch.prototype._getInfo=function(e){var t=this;this._sendRequest("GET","/info",null,function(r,n){if(r)e&&e(r);else{var s=n.find("info");if(s&&s[0]){var a=$(s[0]);t.mac=a.attr("deviceID");var o=a.find("name");o&&o[0]&&(t.name=$(o[0]).text()),e&&e(null,{name:t.name,mac:t.mac});}else e&&e(new Error("get info xml invalid"));}});},SoundTouch.prototype._pressKey=function(e,t){var r='<key state="press" sender="Gabbo">'+e+"</key>";this._sendRequest("POST","/key",r,t);},SoundTouch.prototype._releaseKey=function(e,t){var r='<key state="release" sender="Gabbo">'+e+"</key>";this._sendRequest("POST","/key",r,t);},SoundTouch.prototype._getSources=function(e){var t=this;this._sendRequest("GET","/sources",null,function(r,n){if(r)e&&e(r);else{var s=[];n.find("sourceItem").each(function(){var e=$(this);s.push({source:e.attr("source"),sourceAccount:e.attr("sourceAccount")?e.attr("sourceAccount"):null,isLocal:e.attr("isLocal"),name:e.text()?e.text():null});}),t.sources=s,e&&e(null,s);}});},SoundTouch.prototype._setSource=function(e,t,r){var n='<ContentItem source="'+e+'"';t&&(n+=' sourceAccount="'+t+'"'),n+="></ContentItem>",this._sendRequest("POST","/select",n,r);},SoundTouch.prototype._setBass=function(e,t){var r="<bass>"+e+"</bass>";this._sendRequest("POST","/bass",r,t);},SoundTouch.prototype._getBass=function(e){this._sendRequest("GET","/bass",null,function(t,r){if(t)e&&e(t);else{var n={},s=r.find("targetbass");s&&s[0]&&(n.targetbass=parseInt($(s[0]).text())),(s=r.find("actualbass"))&&s[0]&&(n.actualbass=parseInt($(s[0]).text())),e&&e(t,n);}});},SoundTouch.prototype._getBassCap=function(e){var t=this;this._sendRequest("GET","/bassCapabilities",null,function(r,n){if(r)e&&e(r);else{var s=n.find("bassAvailable");if(s&&s[0]){var a=$(s[0]).text();if(a&&"false"!=a.toLowerCase()){var o=0,i=n.find("bassMin");i&&i[0]&&(o=$(i[0]).text());var u=100,l=n.find("bassMax");l&&l[0]&&(u=$(l[0]).text()),t.bass=o+"-"+u,e&&e(null,{bass:t.bass});}else e&&e(null,null);}else e&&e(new Error("get bass cap xml invalid"));}});},SoundTouch.prototype._getZone=function(e){var t=this;this._sendRequest("GET","/getZone",null,function(r,n){if(r)e&&e(r);else{var s={isMaster:!1},a=n.find("zone");if(a&&a[0]){var o=$(a[0]).attr("master");if(!o)return s.isMaster=!0,s.master=t.getMac(),s.members={},s.members[t.getMac()]=t.getIP(),t.isMaster=!0,t.members=s.members,void(e&&e(null,s));s.master=o,o==t.getMac()&&(s.isMaster=!0);}$(a[0]).find("member").each(function(){var e=$(this),t=e.attr("ipaddress"),r=e.text();t&&r&&(s.members||(s.members={}),s.members[r]=t);}),t.isMaster=s.isMaster,t.members=s.members,e&&e(null,s);}});},SoundTouch.prototype._setZone=function(e,t,r){var n='<zone master="'+e+'" senderIPAddress="0.0.0.0">';for(var s in t){t.hasOwnProperty(s)&&t[s]&&(n+='<member ipaddress="'+t[s]+'">'+s+"</member>");}n+="</zone>",this._sendRequest("POST","/setZone",n,r);},SoundTouch.prototype._getVolume=function(e){this._sendRequest("GET","/volume",null,function(t,r){if(t)e&&e(t);else{var n={},s=r.find("targetvolume");s&&s[0]&&(n.targetvolume=parseInt($(s[0]).text())),(s=r.find("actualvolume"))&&s[0]&&(n.actualvolume=parseInt($(s[0]).text())),(s=r.find("muteenabled"))&&s[0]&&(n.muteenabled=$(s[0]).text()),e&&e(t,n);}});},SoundTouch.prototype._setVolume=function(e,t){var r="<volume>"+e+"</volume>";this._sendRequest("POST","/volume",r,t);},SoundTouch.prototype._getNowPlaying=function(e){this._sendRequest("GET","/now_playing",null,function(t,r){if(t)e&&e(t);else{var n={},s=null,a=r.find("nowPlaying");if(a&&a[0]&&(s=$(a[0]).getAttributes(),n=JSON.parse(JSON.stringify(s))),(a=r.find("ContentItem"))&&a[0]){s=$(a[0]).getAttributes(),n.content=JSON.parse(JSON.stringify(s));var o=$(a[0]).find("itemName");o&&o[0]&&(n.content.itemName=$(o[0]).text());}(a=r.find("track"))&&a[0]&&(n.track=$(a[0]).text()),(a=r.find("artist"))&&a[0]&&(n.artist=$(a[0]).text()),(a=r.find("album"))&&a[0]&&(n.album=$(a[0]).text()),(a=r.find("stationName"))&&a[0]&&(n.stationName=$(a[0]).text()),(a=r.find("art"))&&a[0]&&(n.artImageStatus=$(a[0]).attr("artImageStatus"),n.art=$(a[0]).text()),(a=r.find("playStatus"))&&a[0]&&(n.playStatus=$(a[0]).text()),(a=r.find("description"))&&a[0]&&(n.description=$(a[0]).text()),(a=r.find("stationLocation"))&&a[0]&&(n.description=$(a[0]).text()),(a=r.find("time"))&&a[0]&&(n.duration=$(a[0]).attr("total"),n.position=$(a[0]).text()),(a=r.find("shuffleSetting"))&&a[0]&&(n.shuffleSetting=$(a[0]).text()),(a=r.find("repeatSetting"))&&a[0]&&(n.repeatSetting=$(a[0]).text()),e&&e(null,n);}});},SoundTouch.prototype._sendRequest=function(e,t,r,n){this._doRequest(this.getIP(),8090,e,t,r,function(e,t){if(e)n&&n(e);else try{var r=$($.parseXML(t)),s=r.find("error");if(s&&s[0]){var a=$(s[0]),o=a.text(),i=a.attr("name");n&&n(new Error(o+":"+i));}else n&&n(null,r);}catch(e){n&&n(e);}});},SoundTouch.prototype._doRequest=function(e,t,r,n,s,a){var o=this,i="http://"+e+":"+t+n;this._logger.log("trace","send "+r+" to url:"+i),s&&this._logger.log("trace","with data "+s);var u=a,l={url:i,type:r,timeout:2e3,contentType:"text/xml",dataType:"text",cache:!0,success:function success(e){o._logger.log("trace","http request success:"+e),u&&(u(null,e),u=null);},error:function error(e,t){var r="http request error:"+(e?e.status:"0")+"-"+t;o._logger.log("trace",r),u&&(u(new Error(r)),u=null);}};"post"==r.toLowerCase()&&s&&(l.data=s),$.ajax(l);},SoundTouch.prototype.toJSON=function(){return{sys:"bose",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"SoundTouch",model:this._renderer?this._renderer.modelName:null,mac:this.getMac(),bass:this.bass,sources:this.sources,name:this.getName()};},SoundTouch.prototype.equalsTo=function(e){return!!e&&e instanceof SoundTouch&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},SoundTouch;}(),xnm.aio.bose.Master=function(){var Master=function Master(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.bose.Master"):this._logger={log:{}},this._mediaServer={},this._soundTouchs={},this._currentZone=null;var e=this;this._discovery=new xnm.aio.bose.Discovery(),this._discoveryListener=function(t,r){t&&r&&("mediaServer"==t?e._mediaServer[r.uuid]=r:"soundTouch"==t&&e._onFindSoundTouch(r));},this._discovery.addListener(this._discoveryListener),this._discoveryCB=[],this._autoSearchTO=null,this.searchSoundTouch();};return Master.prototype._onFindSoundTouch=function(e){var t=e.getUUID();if(this._soundTouchs[t]){var r=this._soundTouchs[t];r.dummy=!1,r.player.setIP(e.getIP()),r.player.setPort(e.getPort()),r.player.isMaster=e.isMaster,r.player.members=e.members;}else this._soundTouchs[t]={missCount:0,dummy:!1,player:e};this._currentZone?e.getMac()!=this._currentZone||e.isMaster||this.setCurrentZone():e.isMaster&&(this._currentZone=e.getMac());},Master.prototype.searchSoundTouch=function(e){var t=this._discoveryCB.length;if(e||(e=function e(){}),e&&-1==this._discoveryCB.indexOf(e)&&this._discoveryCB.push(e),0==t){this._autoSearchTO&&(clearTimeout(this._autoSearchTO),this._autoSearchTO=null),this._search();var r=this;setTimeout(function(){r._autoSearchTO=setTimeout(function(){r.searchSoundTouch(null);},3e4);var e=r._discoveryCB;r._discoveryCB=[],e.forEach(function(e){e(null,r._getFoundSoundTouchs());});},5e3);}},Master.prototype._search=function(){for(var e in this._soundTouchs){if(this._soundTouchs.hasOwnProperty(e)){var t=this._soundTouchs[e];t.missCount>=5?delete this._soundTouchs[e]:t.missCount++;}}this._discovery.searchSoundTouch();},Master.prototype.getCurrentZone=function(e){var t=this,r=this._getFoundSoundTouchs();if(r&&0!=r.length){if(this._currentZone){var n=this._findPlayerWithMac(this._currentZone);if(n){var s=n.members,a={masterPlayer:n,masterMac:this._currentZone,players:[]};for(var o in s){if(s.hasOwnProperty(o)){var i=this._findPlayerWithMac(o);i&&a.players.push(i);}}e&&e(null,a);}else e&&e(new Error("no player with mac:"+this._currentZone));}else this.setCurrentZone(null,function(r){r?e&&e(r):t.getCurrentZone(e);});}else this.searchSoundTouch(function(r,n){r?e&&e(r):n&&0!=n.length?t.getCurrentZone(e):e&&e(new Error("find no sound touch player"));});},Master.prototype._findPlayerWithMac=function(e){for(var t in this._soundTouchs){if(this._soundTouchs.hasOwnProperty(t)){var r=this._soundTouchs[t];if(r&&r.player&&r.player.getMac()==e)return r.player;}}return null;},Master.prototype.setCurrentZone=function(e,t){var r=null;if(e)(r=this._findPlayerWithMac(e))&&!r.isMaster&&(r=null);else for(var n in this._soundTouchs){if(this._soundTouchs.hasOwnProperty(n)){var s=this._soundTouchs[n];if(s&&s.player&&s.player.isMaster){r=s.player;break;}}}r?(this._currentZone=r.getMac(),t&&t()):t&&t(new Error("no such master"));},Master.prototype.getZones=function(e){var t=this,r=this._getFoundSoundTouchs();if(r&&0!=r.length)for(var n=0,s={},cb=function cb(a,o){if(n++,!a&&o&&o.isMaster&&o.master&&o.members&&(s[o.master]=o.members),n==r.length){var i=[];for(var u in s){if(s.hasOwnProperty(u)){var l={masterMac:u,players:[]},c=s[u];for(var p in c){if(c.hasOwnProperty(p)){var f=t._findPlayerWithMac(p);f&&-1==l.players.indexOf(f)&&l.players.push(f);}}i.push(l);}}e&&e(null,i);}},a=0;a<r.length;a++){r[a]._getZone(cb);}else this.searchSoundTouch(function(r,n){r?e&&e(r):n&&0!=n.length?t.getZones(e):e&&e(new Error("find no sound touch player"));});},Master.prototype.createZone=function(e,t){if(e&&0!=e.length){var r={},n=e[0],s=n.getMac();if(e.length>1)for(var a=0;a<e.length;a++){var o=e[a];r[o.getMac()]=o.getIP();}var i=this;n._setZone(s,r,function(e){e?t&&t(e):i.getZones(function(e){t&&t(e);});});}else t&&t();},Master.prototype._getFoundSoundTouchs=function(){var e=[];for(var t in this._soundTouchs){if(this._soundTouchs.hasOwnProperty(t)){var r=this._soundTouchs[t];r&&!r.dummy&&r.player&&e.push(r.player);}}return e;},Master.prototype.getSoundTouch=function(e){if(!e.uuid)return null;if("master"==e.uuid)return this;var t=this._soundTouchs[e.uuid];if(t&&t.player)return t.player;var r=new xnm.aio.bose.SoundTouch(e);return this._soundTouchs[e.uuid]={missCount:0,dummy:!0,player:r},r;},Master.prototype.executeCommandCreator=function(e,t,r){if(this._currentZone){var n=this._findPlayerWithMac(this._currentZone);n?n.executeCommandCreator(e,t,r):r&&r(new Error("current zone not found"));}else r&&r(new Error("current zone not set"));},Master.prototype.getStatesCreator=function(e,t,r){if(this._currentZone){var n=this._findPlayerWithMac(this._currentZone);n?n.getStatesCreator(e,t,r):r&&r(new Error("current zone not found"));}else r&&r(new Error("current zone not set"));},Master.prototype.toJSON=function(){return{sys:"bose",ip:"xxxxxxx",port:0,uuid:"master",type:"master"};},Master;}(),xnm.aio.bose.Discovery=function(){var Discover=function Discover(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.bose.Discovery"):this._logger={log:{}},this._upnpCB=null,this._searchCB=[],this._searching=!1;};return Discover.prototype.addListener=function(e){e&&-1==this._searchCB.indexOf(e)&&this._searchCB.push(e);},Discover.prototype.removeListener=function(e){if(e){var t=this._searchCB.indexOf(e);-1!=t&&this._searchCB.splice(t,1);}},Discover.prototype.searchSoundTouch=function(){if(!this._searching){this._searching=!0,this._search();var e=this;setTimeout(function(){e._searching=!1;},5e3);}},Discover.prototype._search=function(){if(!this._upnpCB){var e=this;this._upnpCB=function(t){e._findUpnpDevice(t);};}var t=require("x.upnp.js").getDiscoveryService();t.addCallback("upnp:rootdevice",this._upnpCB),t.discoverTarget("upnp:rootdevice");},Discover.prototype._findUpnpDevice=function(e){if(e){var t=this;switch(e.deviceType){case"urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+e.name+" @"+e.ip),this._searchCB.forEach(function(t){t&&t("mediaServer",e);});break;case"urn:schemas-upnp-org:device:MediaRenderer:1":if(e.modelName&&-1!=e.modelName.indexOf("SoundTouch")){this._logger.log("trace","find SoundTouch:"+e.name+" @"+e.ip),(n=e)._setAVTransportURI=function(e,t,r,n){var s="<InstanceID>"+e+"</InstanceID><CurrentURI>"+this._maskMetaData('<TrackInfo index="0" byteOffsetIntoTrack="0" timeOffsetIntoTrack="0" url="'+this._maskMetaData(t)+'" trackData="" sourceId="0" />')+"</CurrentURI><CurrentURIMetaData>"+(r?this._maskMetaData(r):"")+"</CurrentURIMetaData>";this._doSOAPBodyRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",s,n);},n._doSOAPBodyRequest=function(e,t,r,n,s){var a="<u:"+r+' xmlns:u="'+t+'">';a+=n,a+="</u:"+r+">";var o='"'+t+"#"+r+'"',i=this;this._doRequest(e,o,a,function(e,t){if(e)s&&s(e);else{var n=i._parseSOAPResponse(t,r+"Response");n?s&&s(null,n):s&&s(new Error(r+" reponse format invalid"));}});},e=n;var r=new xnm.aio.bose.SoundTouch();r._renderer=e,r.getInfos(function(e){e||t._searchCB.forEach(function(e){e&&e("soundTouch",r);});});}}}var n;},Discover;}(),xnm.aio.bose.DM=function(){var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"play/pause",ref:{value:"tooglePlay",value_t:"playPause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle power",ref:{value:"togglePower"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"thumb up",ref:{value:"thumbUp"}},{type:"enum",name:"thumb down",ref:{value:"thumbDown"}},{type:"enum",name:"bookmark",ref:{value:"bookmark"}},{type:"enum",name:"preset",ref:{value:"preset",ext:"%e",extMeta:["1","2","3","4","5","6"]}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"toggleShuffle"}},{type:"enum",name:"set repeat mode",ref:{value:"setRepeatMode",ext:"%e",extMeta:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"add to favorite",ref:{value:"addFav"}},{type:"enum",name:"remove from favorite",ref:{value:"removeFav"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",value_t:"volumeAudio",extMeta:"0-100"}},{type:"enum",name:"repeat mode",ref:{value:"repeatMode",options:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"shuffle mode",ref:{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]}},{type:"string",name:"play state",ref:{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"radio station",ref:{value:"radio"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]},DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="RaumfeldDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"bose",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Bose SoundTouch"}];},createDevice:function createDevice(e,t,r){var n=DMError,s=DMError.ERROR_CODE;e?e.type?e.ip?e.port?e.uuid?r(null,e):r(new n(s.INVALID,"uuid is invalid")):r(new n(s.INVALID,"port is invalid")):r(new n(s.INVALID,"ip is invalid")):r(new n(s.INVALID,"type is invalid")):r(new n(s.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=DMError,s=DMError.ERROR_CODE;e?e.type?e.ip?e.port?e.uuid?r(null,e):r(new n(s.INVALID,"uuid is invalid")):r(new n(s.INVALID,"port is invalid")):r(new n(s.INVALID,"ip is invalid")):r(new n(s.INVALID,"type is invalid")):r(new n(s.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},applyUIFilter:function applyUIFilter(e,t,r){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,n=0;n<e.length;n++){if(e[n]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var n=[],s=null,a=xnm.aio.bose.DM.getCommandStatusMap(e,r);return a&&(s=function(e,t,r){var n=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(a,0,t),n=n.concat(s)),n;};if(!e.sys)return null;var n=JSON.parse(JSON.stringify(e)),s=null;switch(t.catagory){case"command":s=_filter(e,t),n.command=s;break;case"status":s=_filter(e,t),n.status=s;break;default:return null;}return s&&0!=s.length?n:null;},getCommandStatusMap:function getCommandStatusMap(t,r){var n=JSON.parse(JSON.stringify(e));return t&&t.bass&&(n.command.push({type:"enum",name:"bass up",ref:{value:"bassUp"}}),n.command.push({type:"enum",name:"bass down",ref:{value:"bassDown"}}),n.command.push({type:"int",name:"set bass",ref:{value:"setBass",value_t:"bass",ext:"%d",extMeta:t.bass}}),n.status.push({type:"int",name:"bass",ref:{value:"bass",extMeta:t.bass}})),t&&t.sources&&t.sources.forEach(function(e){if(e&&"true"==e.isLocal){var t=e.source;e.name&&(t=e.name);var r=e.sourceAccount?e.sourceAccount:"";if(e.source){var s="select:"+e.source+"@"+r;n.command.push({type:"enum",name:"select "+t,ref:{value:s}});}}}),n;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,r,n,s){var a={"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%shuffleToggle%":{value:"toggleShuffle"},"%stop%":{value:"stop"},"%toggleMute%":{value:"toggleMute"},"%volume%":{value:"setVolume",ext:"%d",extMeta:"0-100"}},o={"%durationState%":{value:"durationS"},"%mutedState%":{value:"muted",options:["true","false"]},"%playState%":{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]},"%positionState%":{value:"positionS"},"%shuffleState%":{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]},"%volumeState%":{value:"volume",extMeta:"0-100"}};t.bass&&(a["%bass%"]={value:"setBass",value_t:"bass",ext:"%d",extMeta:t.bass},o["%bassState%"]={value:"bass",extMeta:t.bass});return e._injectToSmartWidgetTemplate(n,["media"],s,a,o,null);}};}(),xnm.aio.bose.Handler=function(){var Handler=function Handler(){this.master=new xnm.aio.bose.Master();};return Handler.prototype.devicemanager=xnm.aio.bose.DM,Handler.prototype.SoundTouch=xnm.aio.bose.SoundTouch,Handler.prototype.registModule=function(e){e.register(xnm.aio.bose.DM.SYS,"bose");},Handler.prototype.resolveDevice=function(e){return e?this.master.getSoundTouch(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),n=r?r.command:[];t&&t(null,n);},Handler.prototype.getDeviceStatus=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),n=r?r.status:[];t&&t(null,n);},Handler.prototype.doCommand=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(e,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,r,n){var s=this.resolveDevice(t);if(s){var a=[{id:e,device:t,status:r}];s.getStatesCreator(null,a,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("device json format invalid"));},Handler.prototype.discover=function(e){var t=this;this.master.searchSoundTouch(function(r,n){!r&&n&&n.push(t.master),e&&e(r,n);});},Handler.prototype.getPlayer=function(e,t){if(e&&e.uuid){if("master"!=e.uuid){var r=this.master.getSoundTouch(e);if(r)t&&t(null,r);else{var n=this;this.master.searchSoundTouch(function(){r=n.master.getSoundTouch(e),t&&t(null,r);});}}else t&&t(null,this.master);}else t&&t(new Error("device json invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.bose.Handler());