var m=m||{};m.aio=m.aio||{},m.aio.backupmanager=m.aio.backupmanager||{},m.aio.backupmanager.BackupManager=function(){var Manager=function Manager(){this._logger=require("x.logger.js").getLogger("m.aio.backupmanager.BackupManager"),this._fm=null,this._restoreListener=null;};return Manager.prototype.BACKUP_DIR="backups",Manager.prototype.init=function(e,r,t){this._fm=e,this._restoreListener=r,t&&t();},Manager.prototype.getBackups=function(e){var r=require("fs-extra"),t=require("path"),o=require("async"),n=this._getBackupDir(),a=[];r.ensureDir(n,function(i){i?e&&e(i):r.readdir(n,function(r,n){r?e&&e(r):o.eachLimit(n,10,function(e,r){var o=t.extname(e),n=t.basename(e);if(n=n.substr(0,n.length-o.length).toLowerCase(),o&&".zip"==o.toLowerCase()){if(!n||n.length<=6||"backup"!=n.substr(0,6))r();else{var i=n.indexOf("_");if(-1!=i&&i!=n.length-1){var u=n.substr(i+1);u.match(/^\d+$/)?(u=parseInt(u,10),a.push({file:e,name:n.substr(0,i),time:u}),r()):r();}else r();}}else r();}.bind(this),function(r){e&&e(r,a);});});});},Manager.prototype.restoreBackup=function(e,r){var t=require("fs-extra"),o=require("path"),n=this._getBackupDir(),a=this._fm.getUserRootDataPath(),i=this,u=o.join(n,e),s=o.basename(e),g=o.extname(e),c=s.substr(0,s.length-g.length);t.stat(u,function(e){if(e)return i._logger.log("warn","restore backup 1 error:"+e.message),void(r&&r(e));i._unzip(u,c,function(e,n){if(e)return i._logger.log("warn","restore backup 2 error:"+e.message),void(r&&r(e));var u=i._getBackupContentDirs();i._deleteCurrentFolders(u,function(e){if(e)return i._logger.log("warn","restore backup 3 error:"+e.message),void(r&&r(e));try{for(var s=0;s<u.length;s++){t.copySync(o.join(n,u[s]),o.join(a,u[s]));}i._restoreListener?i._restoreListener(function(e){if(e)return i._logger.log("warn","restore backup 5 error:"+e.message),void(r&&r(e));t.remove(n,function(){r&&r();});}):t.remove(n,function(){r&&r();});}catch(e){i._logger.log("warn","restore backup 4 error:"+e.message),r&&r(e);}});});});},Manager.prototype.createBackup=function(e){var r=require("fs-extra"),t=require("path"),o=this._getBackupDir(),n=this;n._logger.log("debug","Backup dir: "+o),r.ensureDir(o,function(a){if(a)return n._logger.log("warn","create backup 1 error:"+a.message),void(e&&e(a));r.readdir(o,function(a,i){if(a)return n._logger.log("warn","create backup 2 error:"+a.message),void(e&&e(a));var u=n._findBackupPrefix(i),s=n._getBackupContentDirs(),g=n._fm.getUserRootDataPath(),c=u+"_"+Math.round(new Date().getTime()/1e3)+".zip";n._logger.log("debug","ZIP file to create: "+c);var l=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(l,function(a){if(n._logger.log("debug","Checked CPU for features: "+l.join(", ")+". Result: "+a),a){var i=require("archiver"),u=r.createWriteStream(t.join(o,c)),p=i("zip");u.on("error",function(r){n._logger.log("warn","create backup 3 error:"+r.message),e&&(e(r),e=null);}),u.on("close",function(){e&&(e(),e=null);}),p.on("error",function(r){n._logger.log("warn","create backup 4 error:"+r.message),e&&(e(r),e=null);}),p.pipe(u);for(var f=0;f<s.length;f++){n._logger.log("debug","Adding directory: "+s[f]),p.directory(t.join(g,s[f]),s[f]);}n._logger.log("debug","Calling ZIP finalize."),p.finalize();}else{var h=new(require("jszip"))(),d=Date.now(),addRecursive=function addRecursive(e){h.folder(e);for(var o=r.readdirSync(t.join(g,e),{withFileTypes:!0}),n=0;n<o.length;n++){var a=o[n];if(a.isFile()){var i=a.name.toLowerCase();if(".ds_store"!==i&&"thumbs.db"!==i){var u=t.join(g,e,a.name),s=r.readFileSync(u),c=a.name;e&&(c=e+"/"+c),h.file(c,s);}}else if(a.isDirectory()){var l=e+"/"+a.name;addRecursive(l);}}};for(f=0;f<s.length;f++){var _=s[f];addRecursive(_);}n._logger.log("debug","Listed all folders and files in "+(Date.now()-d)+" ms."),d=Date.now(),h.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(r.createWriteStream(t.join(o,c))).on("finish",function(){n._logger.log("debug","Backup ZIP has been created: "+c),n._logger.log("debug","Creating the ZIP took "+(Date.now()-d)+" ms."),e&&(e(),e=null);});}});});});},Manager.prototype.deleteBackup=function(e,r){var t=require("fs-extra"),o=require("path"),n=this._getBackupDir();t.ensureDir(n,function(a){a?r&&r(a):t.remove(o.join(n,e),function(e){r&&r(e);});});},Manager.prototype._getBackupDir=function(){return require("path").join(this._fm.getUserRootDataPath(),this.BACKUP_DIR);},Manager.prototype._getBackupContentDirs=function(){return["tenants","resources"];},Manager.prototype._findBackupPrefix=function(e){for(var r=0,t="backup"+r;this._hasBackupWithPrefix(t,e);){t="backup"+ ++r;}return t;},Manager.prototype._hasBackupWithPrefix=function(e,r){for(var t=0;t<r.length;t++){if(r[t]&&r[t].substr(0,e.length)==e)return!0;}return!1;},Manager.prototype._unzip=function(e,r,t){var o=this._fm.getTmpDir(),n=require("path"),a=require("fs-extra"),i=n.join(o,r);try{a.existsSync(i)&&a.removeSync(i),a.ensureDirSync(i);}catch(e){return void(t&&t(e));}var u=this,s=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(s,function(r){if(u._logger.log("debug","Checked CPU for features: "+s.join(", ")+". Result: "+r),r){u._logger.log("debug","Unzipping backup file with ADM-ZIP.");var o=Date.now(),n=new(require("adm-zip"))(e);try{n.extractAllTo(i,!0),u._logger.log("debug","Finished unzipping after "+(Date.now()-o)+" ms."),t&&t(null,i);}catch(e){t&&t(e);}}else XC.unzip(e,i,u._logger,t);});},Manager.prototype._deleteCurrentFolders=function(e,r){var t=require("fs-extra"),o=require("path"),n=this._fm.getUserRootDataPath();try{for(var a=0;a<e.length;a++){t.removeSync(o.join(n,e[a]));}r();}catch(e){r(e);}},Manager;}(),m.aio.backupmanager.Handler=m.aio.backupmanager.BackupManager,"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.backupmanager.Handler());