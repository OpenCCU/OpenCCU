var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.pioneer=xnm.aio.pioneer||{},xnm.aio.pioneer.AVReceiver=function(){var e=[1,2,3,4,5],StatusTask=function StatusTask(e,t,n,o){this._taskBuffer=e,this._avr=t,this._datapoints=n,this._callback=o;};StatusTask.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var e=this,t={},n=0,cb=function cb(o,a){if(o&&4!=o.errorCode&&5!=o.errorCode)1==o.errorCode||2==o.errorCode||3==o.errorCode?e._taskBuffer._finishAllTask(o):e._taskBuffer._finishLastTask(o);else{var i=e._datapoints[n],r=null,u=i.indexOf(":");u>0&&(r=i.substr(0,u),i=i.substr(u+1));var s="?";if(a&&(r||null==a[i]||void 0===a[i]?r&&a[r]&&null!=a[r][i]&&void 0!==a[r][i]&&(s=a[r][i]):s=a[i]),t[e._datapoints[n]]=s,(n+=1)<e._datapoints.length){var f=e._avr._getStateQuest(e._datapoints[n]);e._avr._doStateReq(f,cb);}else e._taskBuffer._finishLastTask(null,t);}},o=this._avr._getStateQuest(this._datapoints[n]);this._avr._doStateReq(o,cb);},StatusTask.prototype.merge=function(e){e&&e._datapoints&&(this._datapoints?this._datapoints=function(e){for(var t=0;t<e.length;++t){for(var n=t+1;n<e.length;++n){e[t]===e[n]&&e.splice(n,1);}}return e;}(this._datapoints.concat(e._datapoints)):this._datapoints=e._datapoints);};var CommandTask=function CommandTask(e,t,n,o){this._taskBuffer=e,this._avr=t,this._commandTxt=n,this._callback=o;};CommandTask.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var e=this,t=this._avr._getCommandQuest(this._commandTxt);this._avr._doCommandReq(t,function(t){!t||1!=t.errorCode&&2!=t.errorCode&&3!=t.errorCode?e._taskBuffer._finishLastTask(t):e._taskBuffer._finishAllTask(t);});};var TaskBuffer=function TaskBuffer(e){this._avr=e,this._buffer=[];};TaskBuffer.prototype.executeTask=function(e){if(0==this._buffer.length)this._buffer.push(e),this._doNextTask();else if(e instanceof CommandTask)this._buffer.push(e);else if(e instanceof StatusTask){var t=[];if(this._buffer.length>1){for(var n=1;n<this._buffer.length;n++){this._buffer[n]&&this._buffer[n]instanceof StatusTask&&(t.push(n),e.merge(this._buffer[n]));}for(var o=0;o<t.length;o++){this._buffer.splice(t[o],1);}}this._buffer.push(e);}else this._buffer.push(e);},TaskBuffer.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run();},TaskBuffer.prototype._finishLastTask=function(e,t){if(this._buffer.length>0){var n=this._buffer[0];n&&n._callback&&(n._callback(e,t),n._callback=null),this._buffer.splice(0,1);}this._doNextTask();},TaskBuffer.prototype._finishAllTask=function(e){var t=this._buffer;this._buffer=[];for(var n=0;n<t.length;n++){t[n]&&t[n]._callback&&(t[n]._callback(e),t[n]._callback=null);}};var PacketBuffer=function PacketBuffer(e){this._avr=e,this._buffer=[],this._bufferEmptyTo=null;};PacketBuffer.prototype.RESPONSE_TO=500,PacketBuffer.prototype.sendPacket=function(e,t,n){if(e){var o={packet:e,ignoreRsp:t,callback:n},a=this._buffer.length;this._buffer.push(o),this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null),0==a&&this._sendNextPacket();}else n&&n(new Error("ISCP message is null"));},PacketBuffer.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var t=this,n=this._buffer[0];this._avr._sendPacket(n.packet,function(o){if(o)return o.errorCode=e[0],void t._finishAllPacket(o);n.ignoreRsp?t._finishLastPacket():n.timeout=setTimeout(function(){t._avr._logger.log("warn","packet response timeout");var n=new Error("packet reponse timeout");n.errorCode=e[3],t._finishLastPacket(n);},t.RESPONSE_TO);});}},PacketBuffer.prototype._finishLastPacket=function(e,t){if(this._buffer.length>0&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(e,t),this._buffer[0].callback=null)),this._buffer.splice(0,1)),0==this._buffer.length){var n=this;this._bufferEmptyTo=setTimeout(function(){n._bufferEmptyTo=null,0==n._buffer.length&&n._avr._disconnect();},500);}else this._sendNextPacket();},PacketBuffer.prototype._finishAllPacket=function(e){var t=this._buffer;this._buffer=[],this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var n=0;n<t.length;n++){t[n]&&(t[n].timeout&&(clearTimeout(t[n].timeout),t[n].timeout=null),t[n].callback&&(t[n].callback(e),t[n].callback=null));}},PacketBuffer.prototype._onSocketData=function(t){t=(t=new Buffer(t)).toString("hex");var n=(t=new Buffer(t,"hex")).toString();if(this._buffer.length>0&&this._buffer[0]&&this._buffer[0].packet)if("?"==this._buffer[0].packet.substr(0,1)){var o=n.split("\r");-1!=n.indexOf("\n")&&(o=n.split("\n"));for(var a=this._avr._getRspPrefix(this._buffer[0].packet),i=!1,r="",u=0;u<o.length;u++){if(a&&o[u]&&0==o[u].indexOf(a)){this._finishLastPacket(null,o[u].trim());break;}0==o[u].indexOf("E")&&(i=!0,r=o[u]);}if(i){var s=new Error("pioneer response error code:"+r);s.errorCode=e[4],this._finishLastPacket(s);}}else this._finishLastPacket(null,n);},PacketBuffer.prototype._onSocketTimeout=function(){},PacketBuffer.prototype._onSocketError=function(t){t.errorCode=e[1],this._finishAllPacket(t);},PacketBuffer.prototype._onSocketClose=function(t){var n=new Error("socket closed");n.errorCode=e[2],this._finishAllPacket(n);};var AVReceiver=function AVReceiver(e,t,n,o,a){this._ip=e,this._port=t,this._port||(this._port=23),this._uuid=n,this._name=o,this._model=a,this._logger=require("x.logger.js").getLogger("xnm.aio.pioneer.AVReceiver"),this._socket=null,this._taskBuffer=new TaskBuffer(this),this._packetBuffer=new PacketBuffer(this);};return AVReceiver.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if("openNative"==t.value)return window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"icontrolav5://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM","startApp",{scheme:"jp.pioneer.avsoft.android.icontrolav2014"})),void(n&&n());var o="";t.path&&t.path[0]&&"global"!=t.path[0]&&(o=t.path[0]+":");var a=o+t.value;if("setTo"==t.value||"tuner"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command setTo ext format invalid")));a+=t.ext;}else if("audioMode"==t.value){if(!t.ext)return void(n&&n(new Error("command audioMode ext format invalid")));a=o+t.ext;}else if("setInput"==t.value){if(!t.ext)return void(n&&n(new Error("command setInput ext format invalid")));a=o+t.ext;}else if("setTone"==t.value){if(!t.ext)return void(n&&n(new Error("command setTone ext format invalid")));a+=t.ext;}else if("bassTo"==t.value||"trebleTo"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command ext format invalid")));a+=t.ext;}else if("customCMD"==t.value){if(!t.ext)return void(n&&n(new Error("command customCMD ext format invalid")));a=o+t.ext;}this._executeCommand(a,function(e){e?n&&n(e):!t.path||!t.path[0]||"mainzone"!=t.path[0]||"on"!=t.value&&"off"!=t.value&&"toggle"!=t.value?n&&n():setTimeout(function(){n&&n();},5e3);});}else n&&n(new Error("command json format invalid"));},AVReceiver.prototype.getStatesCreator=function(e,t,n){for(var _contains=function _contains(e,t){for(var n=0;n<t.length;n++){if(t[n]===e)return!0;}return!1;},o=[],a=[],i=0;i<t.length;i++){if(t[i]&&t[i].id&&t[i].status&&t[i].status.value){var r="";t[i].status.path&&t[i].status.path[0]&&"global"!=t[i].status.path[0]&&(r=t[i].status.path[0]+":");var u=t[i].status.value;o.push({id:t[i].id,datapoint:r+u}),_contains(r+u,a)||a.push(r+u);}}this._getStates(a,function(e,t){if(e)n&&n(e);else{for(var a=[],i=0;i<o.length;i++){var r="?",u=o[i].id,s=o[i].datapoint;t&&null!=t[s]&&void 0!==t[s]&&(r=t[s]),a.push({id:u,status:r});}n&&n(null,a);}});},AVReceiver.prototype.executeCommand=function(e,t){this._executeCommand(e,t);},AVReceiver.prototype.getStates=function(e){var t=Object.keys(AVReceiver.STATUS_DPT_QUEST);this._getStates(t,function(t,n){e&&e(t,n);});},AVReceiver.prototype._executeCommand=function(e,t){this._logger.log("debug","execute command: "+e);var n=new CommandTask(this._taskBuffer,this,e,t);this._taskBuffer.executeTask(n);},AVReceiver.prototype._getStates=function(e,t){this._logger.log("debug","get states: "+JSON.stringify(e));var n=new StatusTask(this._taskBuffer,this,e,t);this._taskBuffer.executeTask(n);},AVReceiver.prototype._getCommandQuest=function(e){console.log("pionner",e);var t,n=e,o=null,a=e.indexOf(":");if(a>0&&(o=e.substr(0,a),e=e.substr(a+1)),"on"==e)n="zoneHD"==o?"ZEO":"zone3"==o?"BPO":"zone2"==o?"APO":"PO";else if("off"==e)n="zoneHD"==o?"ZEF":"zone3"==o?"BPF":"zone2"==o?"APF":"PF";else if("toggle"==e)n="zoneHD"==o?"ZEZ":"zone3"==o?"BPZ":"zone2"==o?"APZ":"PZ";else if("mute"==e)n="zoneHD"==o?"HZMO":"zone3"==o?"Z3MO":"zone2"==o?"Z2MO":"MO";else if("unmute"==e)n="zoneHD"==o?"HZMF":"zone3"==o?"Z3MF":"zone2"==o?"Z2MF":"MF";else if("toggleMute"==e)n="zoneHD"==o?"HZMZ":"zone3"==o?"Z3MZ":"zone2"==o?"Z2MZ":"MZ";else if("volumeUp"==e)n="zoneHD"==o?"HZU":"zone3"==o?"YU":"zone2"==o?"ZU":"VU";else if("volumeDown"==e)n="zoneHD"==o?"HZD":"zone3"==o?"YD":"zone2"==o?"ZD":"VD";else if("BD"==e||"DVD"==e||"SAT/CBL"==e||"DVR/BDR"==e||"HDMI1"==e||"HDMI2"==e||"HDMI3"==e||"HDMI4"==e||"HDMI5"==e||"HDMI6"==e||"HDMI7"==e||"NETRADIO"==e||"Spotify"==e||"MEDIASERVER"==e||"FAVORITES"==e||"iPod/USB"==e||"TV"==e||"TUNER"==e||"BTAUDIO"==e||"CD"==e){switch(e){case"BD":n="25";break;case"DVD":n="04";break;case"SAT/CBL":n="06";break;case"DVR/BDR":n="15";break;case"HDMI1":n="19";break;case"HDMI2":n="20";break;case"HDMI3":n="21";break;case"HDMI4":n="22";break;case"HDMI5":n="23";break;case"HDMI6":n="24";break;case"HDMI7":n="34";break;case"NETRADIO":n="38";break;case"Spotify":n="53";break;case"MEDIASERVER":n="44";break;case"FAVORITES":n="45";break;case"iPod/USB":n="17";break;case"TV":n="05";break;case"TUNER":n="02";break;case"BTAUDIO":n="33";break;case"CD":n="01";}n+="zoneHD"==o?"ZEA":"zone3"==o?"ZT":"zone2"==o?"ZS":"FN";}else if("AUTO"==e||"MOVIE"==e||"MUSIC"==e||"GAME"==e||"ALC"==e||"DIRECT"==e||"PURE_DIRECT"==e||"F.S.SURR_FOCUS"==e||"DRAMA"==e||"ACTION"==e||"CLASSICAL"==e||"ROCK/POP"==e||"EXT_STEREO"==e||"ADV_GAME"==e||"SPORT"==e)"AUTO"==e?n="0006SR":"MOVIE"==e?n="0101SR":"MUSIC"==e?n="0041SR":"GAME"==e?n="0118SR":"ALC"==e?n="0151SR":"DIRECT"==e?n="0007SR":"PURE_DIRECT"==e?n="0008SR":"F.S.SURR_FOCUS"==e?n="0003SR":"DRAMA"==e?n="0103SR":"ACTION"==e?n="0101SR":"CLASSICAL"==e?n="0107SR":"ROCK/POP"==e?n="0110SR":"EXT_STEREO"==e?n="0041SR":"ADV_GAME"==e?n="0118SR":"SPORT"==e&&(n="0117SR");else if("play"==e){if("net"===o)n="10NW";}else if("pause"==e){if("net"===o)n="11NW";}else if("stop"==e){if("net"===o)n="20NW";}else if("previous"==e){if("net"===o)n="12NW";}else if("next"==e){if("net"===o)n="13NW";}else if("enter"==e){if("net"===o)n="30NW";}else if("return"==e){if("net"===o)n="31NW";}else if("up"==e){if("net"===o)n="26NW";}else if("down"==e){if("net"===o)n="27NW";}else if("right"==e){if("net"===o)n="28NW";}else if("left"==e){if("net"===o)n="29NW";}else if(0==e.indexOf("setTone")){if(e=e.replace(/setTone/g,""),"mainzone"===o)"ON"==e?n="1TO":"BYPASS"==e&&(n="0TO");}else if(0==e.indexOf("tuner"))n="Up"==(e=e.replace(/tuner/g,""))?"TPI":"Down"==e?"TPD":2==e.length?e.charAt(0)+"0"+e.charAt(1)+"PR":3==e.length?e+"PR":e.charAt(0)+"TP";else if(0==e.indexOf("bass")){if("Up"==(e=e.replace(/bass/g,""))){if("mainzone"===o)n="BI";}else if("Down"==e){if("mainzone"===o)n="BD";}else{for(e=(e=e.replace(/To/g,"")).replace(/%/g,""),(t=parseInt(e))<-6?t=-6:t>6&&(t=6),t=(t=6-t).toString();t.length<2;){t="0"+t;}n=t+"BA";}}else if(0==e.indexOf("treble")){if("Up"==(e=e.replace(/treble/g,""))){if("mainzone"===o)n="TI";}else if("Down"==e){if("mainzone"===o)n="TD";}else{for(e=(e=e.replace(/To/g,"")).replace(/%/g,""),(t=parseInt(e))<-6?t=-6:t>6&&(t=6),t=(t=6-t).toString();t.length<2;){t="0"+t;}n=t+"TR";}}else if(0==e.indexOf("setTo")||/^\d+$/.test(e))if(0==e.indexOf("setTo")&&(e=e.replace(/setTo/g,"")),e=e.replace(/%/g,""),"zone2"==o||"zone3"==o||"zoneHD"==o){var i="ZV";for("zone3"==o?i="YV":"zoneHD"==o&&(i="HZV"),(t=parseInt(e))<-81?t=-81:t>0&&(t=0),t=(t+=81).toString();t.length<2;){t="0"+t;}n=t+i;}else{for((t=parseFloat(e))<-80.5?t=-80.5:t>12&&(t=12),t=(t=(t+80.5)/.5).toString();t.length<3;){t="0"+t;}n=t+"VL";}return console.log("cmd",n),n;},AVReceiver.STATUS_DPT_QUEST={audioMode:"?S","mainzone:power":"?P","mainzone:volume":"?V","mainzone:mute":"?M","mainzone:input":"?F","mainzone:tone":"?TO","mainzone:bass":"?BA","mainzone:treble":"?TR","zone2:power":"?AP","zone2:volume":"?ZV","zone2:mute":"?Z2M","zone2:input":"?ZS","zone3:power":"?BP","zone3:volume":"?YV","zone3:mute":"?Z3M","zone3:input":"?ZT","zoneHD:power":"?ZEP","zoneHD:volume":"?HZV","zoneHD:mute":"?HZM","zoneHD:input":"?ZEA"},AVReceiver.prototype._getStateQuest=function(e){return e?AVReceiver.STATUS_DPT_QUEST[e]:null;},AVReceiver.STATUS_RSP_PREFIX={"?S":"SR","?V":"VOL","?P":"PWR","?M":"MUT","?F":"FN","?TO":"TO","?BA":"BA","?TR":"TR","?AP":"APR","?ZV":"ZV","?ZS":"Z2F","?Z2M":"Z2MUT","?BP":"BPR","?YV":"YV","?ZT":"Z3F","?Z3M":"Z3MUT","?ZEP":"ZEP","?HZV":"XV","?HZM":"HZMUT","?ZEA":"ZEA"},AVReceiver.prototype._getRspPrefix=function(e){return e?AVReceiver.STATUS_RSP_PREFIX[e]:null;},AVReceiver.prototype._buildData=function(e){for(var t=[],n=0;n<e.length;n++){t.push(e.charCodeAt(n));}return t.push(13),new Buffer(t);},AVReceiver.prototype._resolveStatus=function(e){var t,__parseInt=function __parseInt(e){if("string"==typeof e){var t=e;if(t){for(;"0"==t.charAt(0)&&t.length>1;){t=t.substr(1);}return parseInt(t);}return parseInt(t);}return parseInt(e);},n=e,o={};if(o.mainzone={},o.zone2={},o.zone3={},o.zoneHD={},0==n.indexOf("VOL"))o.mainzone.volume=.5*__parseInt(n.substr(3,3))-80.5;else if(0==n.indexOf("BA"))o.mainzone.bass=6-__parseInt(n.substr(2,2));else if(0==n.indexOf("TR"))o.mainzone.treble=6-__parseInt(n.substr(2,2));else if(0==n.indexOf("ZV")||0==n.indexOf("YV")||0==n.indexOf("XV"))t=o.zone2,0==n.indexOf("YV")?t=o.zone3:0==n.indexOf("XV")&&(t=o.zoneHD),t.volume=__parseInt(n.substr(2,2))-81;else if(0==n.indexOf("PWR")||0==n.indexOf("APR")||0==n.indexOf("BPR")||0==n.indexOf("ZEP"))t=o.mainzone,0==n.indexOf("APR")?t=o.zone2:0==n.indexOf("BPR")?t=o.zone3:0==n.indexOf("ZEP")&&(t=o.zoneHD),"0"==n.substr(3,1)?t.power="on":t.power="off";else if(0==n.indexOf("MUT")||0==n.indexOf("Z2MUT")||0==n.indexOf("Z3MUT")||0==n.indexOf("HZMUT")){t=o.mainzone;var a=n.substr(3,1);0==n.indexOf("Z2MUT")?(t=o.zone2,a=n.substr(5,1)):0==n.indexOf("Z3MUT")?(t=o.zone3,a=n.substr(5,1)):0==n.indexOf("HZMUT")&&(t=o.zoneHD,a=n.substr(5,1)),t.mute="0"==a?"on":"off";}else if(0==n.indexOf("SR")){switch((n=n.trim()).substr(2)){case"0006":o.audioMode="AUTO";break;case"0101":o.audioMode="MOVIE";break;case"0041":o.audioMode="MUSIC";break;case"0118":o.audioMode="GAME";break;case"0151":o.audioMode="ALC";break;case"0007":o.audioMode="DIRECT";break;case"0008":o.audioMode="PURE_DIRECT";break;case"0003":o.audioMode="F.S.SURR_FOCUS";break;case"0103":o.audioMode="DRAMA";break;case"0107":o.audioMode="CLASSICAL";break;case"0110":o.audioMode="ROCK/POP";break;case"0117":o.audioMode="SPORT";}}else if(0==n.indexOf("FN")||0==n.indexOf("Z2F")||0==n.indexOf("Z3F")||0==n.indexOf("ZEA")){t=o.mainzone;var i=n.substr(2);switch(0==n.indexOf("Z2F")?(t=o.zone2,i=n.substr(3)):0==n.indexOf("Z3F")?(t=o.zone3,i=n.substr(3)):0==n.indexOf("ZEA")&&(t=o.zoneHD,i=n.substr(3)),i){case"25":t.input="BD";break;case"04":t.input="DVD";break;case"06":t.input="SAT/CBL";break;case"15":t.input="DVR/BDR";break;case"19":t.input="HDMI1";break;case"20":t.input="HDMI2";break;case"21":t.input="HDMI3";break;case"22":t.input="HDMI4";break;case"23":t.input="HDMI5";break;case"24":t.input="HDMI6";break;case"34":t.input="HDMI7";break;case"38":t.input="NETRADIO";break;case"53":t.input="Spotify";break;case"44":t.input="MEDIASERVER";break;case"45":t.input="FAVORITES";break;case"17":t.input="iPod/USB";break;case"05":t.input="TV";break;case"01":t.input="CD";break;case"02":t.input="TUNER";break;case"33":t.input="BTAUDIO";}}else 0==n.indexOf("TO")&&(t=o.mainzone,"0"==n.substr(2,1)?t.tone="BYPASS":"1"==n.substr(2,1)&&(t.tone="ON"));return o;},AVReceiver.prototype._doCommandReq=function(e,t){this._packetBuffer.sendPacket(e,!0,t);},AVReceiver.prototype._doStateReq=function(e,t){var n=this;this._packetBuffer.sendPacket(e,!1,function(e,o){if(e)t(e);else{var a=n._resolveStatus(o);t(null,a);}});},AVReceiver.prototype._sendPacket=function(e,t){if(this._socket){this._logger.log("trace","send packet:"+e);var n=this._buildData(e);this._socket.write(n,"binary"),t();}else{var o=this;this._connect(function(n){n?t(n):o._sendPacket(e,t);});}},AVReceiver.prototype._connect=function(e){this._socket&&(this._socket.end(),this._socket=null);var t=this,n={port:this._port,host:this._ip},o=require("net").connect(n);return o.setTimeout(1e3),o.__connected=!1,o.on("connect",function(){t._logger.log("trace","connect to pioneer avr:"+t._ip),o.__connected=!0,t._socket=o,e();}),o.on("data",function(e){t._logger.log("trace","receive from pioneer avr "+(o.__disconnected?"(closed)":"")+":"+t._ip+" data:"+e),o.__disconnected||t._packetBuffer._onSocketData(e);}),o.on("error",function(n){o.__connected?(t._logger.log("trace","pioneer avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" error:"+n.message),o.destroy(),o.__disconnected||(o.__disconnected=!0,t._socket=null,t._packetBuffer._onSocketError(n))):(t._logger.log("trace","pioneer avr:"+t._ip+" connection error:"+n.message),e(n));}),o.on("timeout",function(){o.__connected?(t._logger.log("trace","pioneer avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" data timeout"),o.__disconnected||t._packetBuffer._onSocketTimeout()):(t._logger.log("trace","pioneer avr:"+t._ip+" connection timeout"),o.destroy&&o.destroy(),e(new Error("timeout")));}),o.on("close",function(){t._logger.log("trace","pioneer avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" close socket"),o.__disconnected||(o.__disconnected=!0,t._socket=null,t._packetBuffer._onSocketClose(o));}),o._doConnect&&"function"==typeof o._doConnect&&o._doConnect(),o;},AVReceiver.prototype._disconnect=function(){this._logger.log("debug","disconnect socket"),this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null);},AVReceiver.prototype.toJSON=function(){var e={sys:xnm.aio.pioneer.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid};return this._name&&(e.name=this._name),this._model&&(e.model=this._model),e;},AVReceiver.prototype.equalsTo=function(e){return!!e&&e instanceof AVReceiver&&this._ip==e._ip&&this._port==e._port;},AVReceiver.parseJSON=function(e){return e.ip?new AVReceiver(e.ip,e.port,e.uuid,e.name,e.model):null;},AVReceiver;}(),xnm.aio.pioneer.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="PioneerDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"open pioneer iControlAV5",ref:{value:"openNative",value_t:"open_app_pioneer"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"enum",name:"set tuner to preset",ref:{value:"tuner",ext:"%e",extMeta:["A1","A2","A3","A4","A5","A6","A7","A8","A9","B1","B2","B3","B4","B5","B6","B7","B8","B9","C1","C2","C3","C4","C5","C6","C7","C8","C9","D1","D2","D3","D4","D5","D6","D7","D8","D9","E1","E2","E3","E4","E5","E6","E7","E8","E9","F1","F2","F3","F4","F5","F6","F7","F8","F9","G1","G2","G3","G4","G5","G6","G7","G8","G9"]}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","AUTO","ALC","DIRECT","PURE_DIRECT","F.S.SURR_FOCUS","DRAMA","CLASSICAL","ROCK/POP","SPORT"]}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}}]},{type:"root",name:"NET Radio",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"enter",ref:{value:"enter"}},{type:"enum",name:"return",ref:{value:"return"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"left",ref:{value:"left"}},{type:"enum",name:"right",ref:{value:"right"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",unit:"db",ext:"%f",extMeta:"-80.5-12.0",scale:"0.5"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:["BYPASS","ON"]}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"bass to",ref:{value:"bassTo",unit:"db",ext:"%d",extMeta:"-6-6",scale:"1"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"treble to",ref:{value:"trebleTo",unit:"db",ext:"%d",extMeta:"-6-6",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]},{type:"root",name:"zone HD",value:"zoneHD",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["MOVIE","MUSIC","GAME","AUTO"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",unit:"db",extMeta:"-80.5-12.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}},{type:"enum",name:"tone",ref:{value:"tone",options:["ON","BYPASS"]}},{type:"int",name:"bass",ref:{value:"bass",unit:"db",extMeta:"-6-6",scale:"1"}},{type:"int",name:"treble",ref:{value:"treble",unit:"db",extMeta:"-6-6",scale:"1"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]},{type:"root",name:"zone HD",value:"zoneHD",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"-81-0",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["BD","DVD","SAT/CBL","DVR/BDR","HDMI1","HDMI2","HDMI3","HDMI4","HDMI5","HDMI6","HDMI7","NETRADIO","Spotify","MEDIASERVER","FAVORITES","iPod/USB","TV","TUNER","BTAUDIO","CD"]}}]}]}};return{SYS:"pioneer",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Pioneer AV Receiver",type:"avr"}];},createDevice:function createDevice(e,t,n){var o=DMError,a=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(a.INVALID,"ip is invalid")):n(new o(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var o=DMError,a=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(a.INVALID,"ip is invalid")):n(new o(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _doFilterArr=function _doFilterArr(e,t,n){var o=[];return e.forEach(function(e){if("root"==e.type){var a=JSON.parse(JSON.stringify(e)),i=_doFilterArr(a.children,t,n);i&&i.length>0&&(a.children=i,o.push(a));}else if(function(e,t){if("*"==e)return!0;for(var n=!1,o=0;o<e.length;o++){if(e[o]==t){n=!0;break;}}return n;}(n.elems,e.type)){var r=JSON.parse(JSON.stringify(e));o.push(r);}}),o;},_filter=function _filter(e,t){var o=[],a=null,i=xnm.aio.pioneer.DM.getCommandStatusMap(e,n);return i&&(a=function(e,t,n){var o=[];switch(n.catagory){case"command":e.command&&(o=_doFilterArr(e.command,t,n));break;case"status":e.status&&(o=_doFilterArr(e.status,t,n));}return o;}(i,e,t),o=o.concat(a)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),o.command=a;break;case"status":a=_filter(e,t),o.status=a;break;default:return null;}return a&&0!=a.length?o:null;},getCommandStatusMap:function getCommandStatusMap(t){return t&&t.type?e[t.type]:null;}};}(),xnm.aio.pioneer.Handler=function(){var Handler=function Handler(){this.detected={};};return Handler.prototype.devicemanager=xnm.aio.pioneer.DM,Handler.prototype.AVReceiver=xnm.aio.pioneer.AVReceiver,Handler.prototype.registModule=function(e){e.register(xnm.aio.pioneer.DM.SYS,"pioneer");},Handler.prototype.resolveDevice=function(e){return e&&"avr"===e.type?xnm.aio.pioneer.AVReceiver.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=xnm.aio.pioneer.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),o=n?n.command:[];t&&t(null,o);},Handler.prototype.getDeviceStatus=function(e,t){var n=xnm.aio.pioneer.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),o=n?n.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,n){var o=this.resolveDevice(e);o?o.executeCommandCreator(e,t,function(e){n&&n(e);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,n,o){var a=this.resolveDevice(t);if(a){var i=[{id:e,device:t,status:n}];a.getStatesCreator(null,i,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("device json format invalid"));},Handler.prototype.getDeviceCommandList=function(e,t,n){var o=[];if(t)o.push({id:window.XC_Text.on,cmd:"on"}),o.push({id:window.XC_Text.off,cmd:"off"});else if(n&&"avr"==e.type){var a=[];a.push({id:"on",cmd:"on"}),a.push({id:"off",cmd:"off"}),a.push({id:"toggle",cmd:"toggle"}),a.push({id:"volumeDown",cmd:"volumeDown"}),a.push({id:"volumeUp",cmd:"volumeUp"}),a.push({id:"set volume",cmd:"setTo",step:"1",max:"80"}),a.push({id:"mute",cmd:"mute"}),a.push({id:"unmute",cmd:"unmute"}),a.push({id:"toggleMute",cmd:"toggleMute"}),a.push({id:"CBLSAT",cmd:"CBLSAT"}),a.push({id:"BDDVD",cmd:"BDDVD"}),a.push({id:"STRMBOX",cmd:"STRMBOX"}),a.push({id:"GAME",cmd:"GAME"}),a.push({id:"AUX",cmd:"AUX"}),a.push({id:"PC",cmd:"PC"}),a.push({id:"CD",cmd:"CD"}),a.push({id:"TV",cmd:"TV"}),a.push({id:"NET",cmd:"NET"}),a.push({id:"BLUETOOTH",cmd:"BLUETOOTH"}),a.push({id:"FM",cmd:"FM"}),a.push({id:"AM",cmd:"AM"}),a.push({id:"tunerUp",cmd:"tunerUp"}),a.push({id:"tunerDown",cmd:"tunerDown"}),a.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"40"}),cl=a.length;for(var i=0;i<cl;i++){var r=JSON.parse(JSON.stringify(a[i]));r.ch="mainzone",o.push(r),(r=JSON.parse(JSON.stringify(a[i]))).ch="zone2",o.push(r);}o.push({id:"MOVIE",cmd:"MOVIE"}),o.push({id:"MUSIC",cmd:"MUSIC"}),o.push({id:"GAME",cmd:"GAME"}),o.push({id:"STEREO",cmd:"STEREO"}),o.push({id:"play",cmd:"play"}),o.push({id:"pause",cmd:"pause"}),o.push({id:"stop",cmd:"stop"}),o.push({id:"previous",cmd:"previous"}),o.push({id:"next",cmd:"next"});}return o;},Handler.prototype.discover=function(e){var t=require("x.upnp.js");if(t){var n=this;t.discoverDevicesWithTimeout(3e3,function(t){if(t.manufacturer&&-1!=t.manufacturer.toLowerCase().indexOf("pioneer")&&t.modelName&&(-1!=t.modelName.toLowerCase().indexOf("vsx")||-1!=t.modelName.toLowerCase().indexOf("sc"))){var o=t.modelName,a=o.indexOf("/");-1!=a&&(o=o.substr(0,a));var i=new xnm.aio.pioneer.AVReceiver(t.ip,0,t.uuid,t.name,o);n.detected[t.uuid]=i,e(i);}});}},Handler.prototype.discoverWithTimeout=function(e,t){var n={};this.discover(function(e){e&&e._uuid&&!n[e._uuid]&&(n[e._uuid]=e);}),setTimeout(function(){var e=[];for(var o in n){n.hasOwnProperty(o)&&e.push(n[o]);}t&&t(null,e);},e);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.pioneer.Handler());