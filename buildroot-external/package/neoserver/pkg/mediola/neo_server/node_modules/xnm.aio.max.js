var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.max=xnm.aio.max||{},xnm.aio.max.Task=function(e,t,a){this.type=e,this.data=t,this.callback=a,this._taskFinishCallback=null;},xnm.aio.max.Task.prototype.run=function(e,t){if(e){this._taskFinishCallback=t;var a=this,o="",n=!1,s=!1,i={},r={_onSocketData:function _onSocketData(t){var r;for(o+=t;(r=o.indexOf("\r\n"))>0;){var u=e._evalBlock(i,o.substr(0,r));u&&u.l&&(s=!0),u&&u.s&&(n=!0),o=o.substr(r+2);}if("command"==a.type&&n)a._finish(null,null,1500),e._disconnect();else if(s){if("command"==a.type)a._executeCommand(e,a.data,i)||(a._finish(new Error("execute command invalid")),e._disconnect());else if("status"==a.type){var l=a._resolveStatus(a.data,i);a._finish(null,l),e._disconnect();}else a._finish(null,i),e._disconnect();}},_onSocketTimeout:function _onSocketTimeout(){a._finish(new Error("socket data timeout")),e._disconnect();},_onSocketError:function _onSocketError(e){a._finish(e);},_onSocketClose:function _onSocketClose(){}};e._connect(r,function(e){e&&a._finish(e);});}else t&&t(new Error("cube is null"));},xnm.aio.max.Task.prototype._executeCommand=function(e,t,a){var o=t.device,n=t.command;if(o&&n){var s=e._getDeviceByAddress(a,o.address);if(s){var i;if("temp"===n.value)i=n.ext;else i=n.value;if(null!=i&&void 0!==i){var r=e._buidCommand(s,i);return e._sendMessage(r),!0;}}}},xnm.aio.max.Task.prototype._resolveStatus=function(e,t){var a={};for(var o in t){if(t.hasOwnProperty(o)&&t[o]&&t[o].devices&&t[o].devices.length>0)for(var n=t[o].devices,s=0;s<n.length;s++){n[s]&&n[s].address&&n[s].state&&(a[n[s].address]=n[s].state);}}for(var i,r=[],u=0;u<e.length;u++){if(e[u]&&e[u].id&&e[u].device&&e[u].status){var l=e[u].device.address;if(l&&a[l]){switch(e[u].status.value){case"tempC":(i=a[l].current)&&(i=parseFloat(i).toFixed(1));break;case"temp":(i=a[l].val)&&(i=parseFloat(i).toFixed(1));break;case"state":"switch"==e[u].device.data?(i=a[l].val,i=(i=parseFloat(i))<=15?"off":"on"):i=a[l].val;break;case"mode":i=a[l].mode;break;case"battery":i="OK"==(i=a[l].battery)?"ok":"low"==i?"low_bat":null;}var c=null;if(e[u].status.extra&&"battery"==e[u].status.extra&&"low"==a[l].battery&&(c="battery"),null!=i&&void 0!==i){var m={id:e[u].id,status:i};c&&(m.info=c),r.push(m);}}}}return r;},xnm.aio.max.Task.prototype._finish=function(e,t,a){if(this.callback){var o=this.callback;a?setTimeout(function(){o(e,t);},a):o(e,t),this.callback=null;}this._taskFinishCallback&&(this._taskFinishCallback(e),this._taskFinishCallback=null);},xnm.aio.max.Cube=function(e,t,a){var o=require("x.logger.js");this._logger=o?o.getLogger("xnm.aio.max.Cube"):{log:function log(){}},this.ip=e,this.port=t,this.port||(this.port=62910),this.uuid=a,this._socket=null,this._tasks=[];},xnm.aio.max.Cube.SO_TIMEOUT=1e3,xnm.aio.max.Cube.prototype.executeCommandCreator=function(e,t,a){var o=new xnm.aio.max.Task("command",{device:e,command:t},a),n=0==this._tasks.length;this._tasks.push(o),n&&this._doNextTask();},xnm.aio.max.Cube.prototype.getStatesCreator=function(e,t,a){if(t){if(0!=t.length){var o=new xnm.aio.max.Task("status",t,a),n=0==this._tasks.length;this._tasks.push(o),n&&this._doNextTask();}else a&&a(null,[]);}else a&&a(new Error("deviceList is null"));},xnm.aio.max.Cube.prototype.getDevices=function(e){var t=new xnm.aio.max.Task("devices",null,e),a=0==this._tasks.length;this._tasks.push(t),a&&this._doNextTask();},xnm.aio.max.Cube.prototype._doNextTask=function(){if(0!=this._tasks.length){var e=this,t=this._tasks[0];t.run(this,function(){e._removeTask(t),e._doNextTask();});}},xnm.aio.max.Cube.prototype._removeTask=function(e){for(var t=-1,a=0;a<this._tasks.length;a++){if(this._tasks[a]===e){t=a;break;}}-1!=t&&this._tasks.splice(t,1);},xnm.aio.max.Cube.prototype._getDeviceByAddress=function(e,t){for(var a in e){if(e.hasOwnProperty(a))for(var o=0;o<e[a].devices.length;o++){if(e[a].devices[o].address==t)return e[a].devices[o];}}return null;},xnm.aio.max.Cube.prototype._evalState=function(e,t,a){var o=this._getDeviceByAddress(e,t);if(o&&(o.state={val:"?"},a.length>2&&16&a[1]&&!(8&a[1])&&2&a[1])){if(4==o.type&&3==a.length)2&a[2]?o.state={val:"open"}:o.state={val:"closed"};else if((1==o.type||2==o.type||3==o.type)&&a.length>=8){var n="auto";switch(3&a[2]){case 0:n="auto";break;case 1:n="manu";break;case 2:n="vacation";break;case 3:n="boost";}var s=((63&a[4])/2).toFixed(1);o.state={val:s,mode:n,valve:a[3]},o.state.current=(((1&a[5])<<8|a[6])/10).toFixed(1),9==a.length&&(delete o.state.valve,o.state.current=(((a[4]>>7&1)<<8|a[8])/10).toFixed(1));}128&a[2]?o.state.battery="low":o.state.battery="OK";}},xnm.aio.max.Cube.prototype._evalLData=function(e,t){for(var a=new Buffer(t,"base64"),o=0;o<a.length;){var n=a[o];if(0==n)break;var s=XC.getHexVal(a[o+1],2)+XC.getHexVal(a[o+2],2)+XC.getHexVal(a[o+3],2),i=a.slice(o+4,o+n+1);this._evalState(e,s,i),o+=n+1;}return{l:e};},xnm.aio.max.Cube.prototype._evalMData=function(e,t){var a,o,n=t.split(",");if(3==n.length){var s=new Buffer(n[2],"base64");if(86==s[0]&&2==s[1]){var i=s[2],r=3;for(a=0;a<i;a++){var u=e[s[r]]={};o=s[r+1],u.name=s.slice(r+2,r+2+o).toString(),u.address=XC.getHexVal(s[r+2+o],2)+XC.getHexVal(s[r+3+o],2)+XC.getHexVal(s[r+4+o],2),u.devices=[],r=r+5+o;}var l=s[r];for(a=0;a<l;a++){var c={};c.type=s[r+1],c.address=XC.getHexVal(s[r+2],2)+XC.getHexVal(s[r+3],2)+XC.getHexVal(s[r+4],2),r+=5,c.serial=s.slice(r,r+10).toString(),o=s[r+10],c.name=s.slice(r+11,r+11+o).toString(),c.room=s[r+11+o],e[s[r+11+o]]||(e[s[r+11+o]]={},e[s[r+11+o]].devices=[]),e[s[r+11+o]].devices.push(c),r=r+11+o;}}}},xnm.aio.max.Cube.prototype._evalCData=function(e,t){var a=t.split(",");if(2==a.length){var o=new Buffer(a[1],"base64");if(210==o[0]){var n=XC.getHexVal(o[1],2)+XC.getHexVal(o[2],2)+XC.getHexVal(o[3],2),s=this._getDeviceByAddress(e,n);s&&(s.comfort=(o[18]/2).toFixed(1),s.eco=(o[19]/2).toFixed(1));}}},xnm.aio.max.Cube.prototype._evalBlock=function(e,t){if(t.length>2){if("M:"==t.substr(0,2))return this._evalMData(e,t.substr(2));if("L:"==t.substr(0,2))return this._evalLData(e,t.substr(2));if("C:"==t.substr(0,2))return this._evalCData(e,t.substr(2));if("H:"==t.substr(0,2)){var a=t.split(",");11==a.length&&(this.uuid=a[0]);}else if("S:"==t.substr(0,2))return{s:t};}},xnm.aio.max.Cube.prototype._connect=function(e,t){if(e){this._socket&&(this._socket.end(),this._socket=null);var a=this,o={port:this.port,host:this.ip},n=require("net").connect(o);return n.setTimeout(xnm.aio.max.Cube.SO_TIMEOUT),n.setEncoding("utf8"),n.on("connect",function(){a._logger.log("trace","connect to max cube:"+a.ip),a._socket=n,t();}),n.on("data",function(t){a._logger.log("trace","receive from max cube:"+a.ip+" data:"+t),e._onSocketData(t);}),n.on("error",function(o){a._socket?(a._logger.log("trace","max cube:"+a.ip+" error:"+o.message),n.destroy(),e._onSocketError(o)):(a._logger.log("trace","max cube:"+a.ip+" connection error:"+o.message),t(o));}),n.on("timeout",function(){a._socket?(a._logger.log("trace","max cube:"+a.ip+" data timeout"),e._onSocketTimeout()):(a._logger.log("trace","max cube:"+a.ip+" connection timeout"),n.destroy&&n.destroy(),t(new Error("timeout")));}),n.on("close",function(){a._logger.log("trace","max cube:"+a.ip+" close socket"),e._onSocketClose();}),n._doConnect&&"function"==typeof n._doConnect&&n._doConnect(),n;}t&&t(new Error("handler is null"));},xnm.aio.max.Cube.prototype._disconnect=function(){this._socket&&(this._socket.end(),this._socket=null);},xnm.aio.max.Cube.prototype._buidCommand=function(e,t){if(!t||!e||!e.address||null==e.room||void 0===e.room)return null;var a=[0,4,64,0,0,0,0,0,0,0,0];return a[6]=parseInt(e.address.substr(0,2),16),a[7]=parseInt(e.address.substr(2,2),16),a[8]=parseInt(e.address.substr(4,2),16),a[9]=e.room,"auto"==t?a[10]=0:"manu"==t?a[10]=64:"boost"==t?a[10]=192:"on"==t?a[10]=114:"off"==t?a[10]=94:(a[10]=Math.round(2*parseFloat(t)),a[10]<9&&(a[10]=9),a[10]>60&&(a[10]=60),e.state&&"manu"==e.state.mode&&(a[10]+=64)),"s:"+new Buffer(a).toString("base64")+"\r\n";},xnm.aio.max.Cube.prototype._sendMessage=function(e){this._socket&&(this._logger.log("trace","send to max cube "+this.ip+": "+e),this._socket.write(e,"utf8"));},xnm.aio.max.Cube.prototype.toJSON=function(){return{sys:xnm.aio.max.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},xnm.aio.max.Cube.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.max.Cube&&this.ip==e.ip&&this.port==e.port;},xnm.aio.max.Discovery=function(){this.Cubes={},this.callback=null,this._sockets=[];var e=require("os");require("dgram");if(e&&e.networkInterfaces){var t=e.networkInterfaces();for(var a in t){if(t.hasOwnProperty(a))for(var o=t[a],n=0;n<o.length;n++){this._addDiscoverSocket(23272,o[n]);}}}else this._addDiscoverSocket(23272,null);},xnm.aio.max.Discovery.prototype._receivedData=function(e,t){if(t=t.toString("hex"),26==(t=new Buffer(t,"hex")).length){var a=new xnm.aio.max.Cube(e);a.uuid=new Buffer(t.slice(8,18)).toString(),this.Cubes[a.uuid]=a,this.callback&&this.callback(this.Cubes[a.uuid]);}},xnm.aio.max.Discovery.prototype._addDiscoverSocket=function(e,t){var a,o=this,n=require("dgram");try{a=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){a=n.createSocket("udp4");}a.on("listening",function(){a.setBroadcast(!0);}),a.on("message",function(e,t){o._receivedData(t.address,e);}),t?"IPv4"==t.family&&0==t.internal&&(a.bind(e,t.address),this._sockets.push(a)):(a.bind(e),this._sockets.push(a));},xnm.aio.max.Discovery.prototype._sendDiscoveryMessages=function(){for(var e=new Buffer([101,81,51,77,97,120,42,0,42,42,42,42,42,42,42,42,42,42,73]),t=0;t<this._sockets.length;t++){this._sockets[t].send(e,0,e.length,23272,"255.255.255.255");}},xnm.aio.max.Discovery.prototype.discoverCubes=function(e){e&&(this.Cubes={}),this._sendDiscoveryMessages();},xnm.aio.max.DMError=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.max.DMError.prototype=new Error(),xnm.aio.max.DMError.prototype.name="MaxDMError",xnm.aio.max.DMError.prototype.code=0,xnm.aio.max.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.max.DM={SYS:"max",MAP:{"switch":{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}}]},thermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}},{type:"float",name:"current temperature",ref:{value:"tempC",extMeta:"4.5-30",scale:"0.5"}}]},wallthermo:{command:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"manu",ref:{value:"manu"}},{type:"enum",name:"boost",ref:{value:"boost"}},{type:"float",name:"temperature",ref:{value:"temp",ext:"%f",extMeta:"4.5-30",scale:"0.5"}}],status:[{type:"enum",name:"mode",ref:{value:"mode",options:["auto","manu","boost","vacation"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}},{type:"float",name:"temperature",ref:{value:"temp",extMeta:"4.5-30",scale:"0.5"}},{type:"float",name:"current temperature",ref:{value:"tempC",extMeta:"4.5-30",scale:"0.5"}}]},contact:{status:[{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},{type:"enum",name:"battery",ref:{value:"battery",options:["ok","low_bat"]}}]}},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"MAX! Cube",port:62910}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:1,name:"Switch"},{sys:this.SYS,type:1,name:"Thermostat"},{sys:this.SYS,type:2,name:"Thermostat Plus"},{sys:this.SYS,type:3,name:"Wall Thermostat"},{sys:this.SYS,type:4,name:"Shutter contact"},{sys:this.SYS,type:5,name:"Push Button"}];},createGateway:function createGateway(e,t,a){var o=xnm.aio.max.DMError,n=xnm.aio.max.DMError.ERROR_CODE;e?e.ip?a(null,e):a(new o(n.INVALID,"ip is invalid")):a(new o(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,o){var n=xnm.aio.max.DMError,s=xnm.aio.max.DMError.ERROR_CODE;t?t.ip?o(null,t):o(new n(s.INVALID,"ip is invalid")):o(new n(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var o=xnm.aio.max.DMError,n=xnm.aio.max.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(null!=e.room&&void 0!==e.room){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,i,r=t.data.gateways;for(s=0;s<r.length;s++){if(r[s].index===e.gateway){i=r[s];break;}}i?a(null,e):a(new o(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(n.INVALID,"room is invalid"));}else a(new o(n.INVALID,"type is invalid"));}else a(new o(n.INVALID,"address is invalid"));}else a(new o(n.INVALID,"gateway is invalid"));}else a(new o(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var o=xnm.aio.max.DMError,n=xnm.aio.max.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(null!=e.type&&void 0!==e.type){if(null!=e.room&&void 0!==e.room){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,i,r=t.data.gateways;for(s=0;s<r.length;s++){if(r[s].index===e.gateway){i=r[s];break;}}i?a(null,e):a(new o(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(n.INVALID,"room is invalid"));}else a(new o(n.INVALID,"type is invalid"));}else a(new o(n.INVALID,"address is invalid"));}else a(new o(n.INVALID,"gateway is invalid"));}else a(new o(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,o=0;o<e.length;o++){if(e[o]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var a=[],o=null,n=null,s=e.type;switch("string"==typeof s&&(s=parseInt(s)),s){case 1:n=e.data&&"switch"==e.data?xnm.aio.max.DM.MAP["switch"]:xnm.aio.max.DM.MAP.thermo;break;case 2:n=xnm.aio.max.DM.MAP.thermo;break;case 3:n=xnm.aio.max.DM.MAP.wallthermo;break;case 4:n=xnm.aio.max.DM.MAP.contact;break;default:return null;}if(!n)return null;if((n=JSON.parse(JSON.stringify(n))).status)for(var i=0;i<n.status.length;i++){"battery"!=n.status[i].ref.value&&(n.status[i].ref.extra="battery");}return n&&(o=function(e,t,a){var o=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(n,0,t),a=a.concat(o)),a;};if(!e||null==e.type||void 0===e.type)return null;var a=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),a.command=o;break;case"status":o=_filter(e,t),a.status=o;break;default:return null;}return o&&0!=o.length?a:null;}},xnm.aio.max.Handler=function(){this._Discovery=null;},xnm.aio.max.Handler.prototype.Cube=xnm.aio.max.Cube,xnm.aio.max.Handler.prototype.discoverCubes=function(e){this._disConCbs||(this._disConCbs=[]),this._Discovery||this._createDiscovery(),e&&-1==this._getIndex(e,this._disConCbs)&&this._disConCbs.push(e),this._Discovery.discoverCubes();},xnm.aio.max.Handler.prototype.getDetectedCubes=function(){return this._Discovery||this._createDiscovery(),this._Discovery.Cubes;},xnm.aio.max.Handler.prototype.discoverCubeWithTimeout=function(e,t){if(t&&e){this._disTimeCbs||(this._disTimeCbs=[]),this._Discovery||this._createDiscovery();var a=this,o=this._disTimeCbs.length;t&&-1==this._getIndex(t,this._disTimeCbs)&&this._disTimeCbs.push(t),setTimeout(function(){var e=a._getIndex(t,a._disTimeCbs);-1!=e&&-2!=e&&a._disTimeCbs.splice(e,1);var o=a.getDetectedCubes(),n=[];for(var s in o){o.hasOwnProperty(s)&&o[s]&&n.push(o[s]);}t(null,n);},1e3*e),this._Discovery.discoverCubes(!!o);}},xnm.aio.max.Handler.prototype._discoverCb=function(e){if(this._disConCbs)for(var t=0;t<this._disConCbs.length;t++){this._disConCbs[t]&&this._disConCbs[t](e);}},xnm.aio.max.Handler.prototype._createDiscovery=function(){if(!this._Discovery){this._Discovery=new xnm.aio.max.Discovery();var e=this;this._Discovery.callback=function(t){e._discoverCb(t);};}},xnm.aio.max.Handler.prototype._getIndex=function(e,t){if(!e||!t)return-2;for(var a=0;a<t.length;a++){if(e===t[a])return a;}return-1;},xnm.aio.max.Handler.prototype.devicemanager=xnm.aio.max.DM,xnm.aio.max.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"max");},xnm.aio.max.Handler.prototype.resolveGateway=function(e){return e&&e.ip?new xnm.aio.max.Cube(e.ip,e.port,e.uuid):null;},xnm.aio.max.Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.max.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),o=a?a.command:[];t&&t(null,o);},xnm.aio.max.Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.max.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),o=a?a.status:[];t&&t(null,o);},xnm.aio.max.Handler.prototype.doCommand=function(e,t,a,o){var n=this.resolveGateway(e);n?n.executeCommandCreator(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},xnm.aio.max.Handler.prototype.doStatus=function(e,t,a,o,n){var s=this.resolveGateway(t);if(s){var i=[{id:e,device:a,status:o}];s.getStatesCreator(null,i,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json format invalid"));},xnm.aio.max.Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDevices(function(e,a){if(e)t&&t(e);else{var o=[];if(a)for(var n in a){if(a.hasOwnProperty(n)&&a[n]){if(a[n].devices){var s=a[n].devices,i=[];s.forEach(function(e){if(e){e.sys=xnm.aio.max.DM.SYS;var t=e.type;switch(null!=t&&void 0!==t&&(t=parseInt(t)),t){case 1:e.data="thermo";break;case 2:e.data="thermoplus";break;case 3:e.data="wallthermo";break;case 4:e.data="contact";break;case 5:e.data="button";break;default:return;}i.push(e);}}),a[n].devices=i;}o.push(a[n]);}}t&&t(null,o);}}):t&&t(new Error("gateway json format invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.max.Handler());