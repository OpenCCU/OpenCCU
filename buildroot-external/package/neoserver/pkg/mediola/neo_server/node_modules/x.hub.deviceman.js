var x=x||{};x.hub=x.hub||{},x.hub.deviceman=x.hub.deviceman||{},x.hub.deviceman.DeviceManager=function(){var DM=function DM(e,t){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManager"),this._tenant=null,this._folder=e,this._folder||(this._folder="db"),this._tenantIdx=t,this._tenantIdx||(this._tenantIdx=1);};return DM.prototype.init=function(e,t){this._logger.log("info","init device managaer:"+this._folder);var n=require("m.aio.configmanager.js"),i=this._generateTenantParent(e);this._tenant=new n.Tenant(i),this._tenant.index=this._tenantIdx,this._tenant.license="dummy",this._tenant.folder=this._folder;var a=require("fs-extra"),o=this;a.ensureDir(this._tenant.getFolderPath(),function(){o._load(t);});},DM.prototype.reload=function(e){var t=this;require("m.aio.devicemanager.js").reloadTenant(this._tenant,function(n){n&&t._logger.log("warn","reload device error:"+n.message),e&&e(n);});},DM.prototype.execute=function(e,t,n,i,a){try{require("m.aio.devicemanager.js").execute(e,this._tenant.index,n,i,a);}catch(e){console.error(e.stack);}},DM.prototype.getDeviceInfo=function(){var e=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return e?e.getDeviceInfo():null;},DM.prototype.findDevice=function(e,t){var n=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return n?n.findDeviceIgnoreLicense(e,t):null;},DM.prototype.findGateway=function(e){var t=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return t?t.findGatewayIgnoreLicense(e):null;},DM.prototype.findGatewayWithIndex=function(e){var t=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return t?t.findGatewayWithIndexIngnoreLicense(e):null;},DM.prototype.findDeviceWithIndex=function(e){var t=require("m.aio.devicemanager.js").getIntHandler(this._tenant.index);return t?t.findDeviceWithIndexIngnoreLicense(e):null;},DM.prototype.getAllGeneralDevice=function(e){var t=this;require("m.aio.devicemanager.js").execute("readWithoutLicense",this._tenant.index,"device",{filter:"prop","cloud.enabled":!0},function(n,i){if(n)e&&e(n);else{var a=[];if(i&&0!=i.length){var o=0,cb=function cb(n,r){!n&&r&&(r._origin=i[o],a.push(r)),++o<i.length?t.toGeneralDevice(i[o].index,cb):e&&e(null,a);};t.toGeneralDevice(i[o].index,cb);}else e&&e(null,a);}});},DM.prototype.toGeneralDevice=function(e,t){require("m.aio.devicemanager.js").toGeneralDevice(this._tenant.index,e,!0,function(e,n){t&&t(e,n);});},DM.prototype.getOwnIdx=function(){return localStorage?localStorage.getItem("x.hub.m.gateway.DB"+this._tenantIdx+"NeoIdx"):-1;},DM.prototype._load=function(e){var t=this;require("m.aio.devicemanager.js")._loadTenant(this._tenant,function(n){n&&t._logger.log("warn","init device error:"+n.message),e&&e(n);});},DM.prototype._generateTenantParent=function(e){return{fileManager:e,getFolderPath:function getFolderPath(){return this.fileManager.getUserRootDataPath();},getFolder:function getFolder(){return"";}};},DM;}(),x.hub.deviceman.DeviceManagerV6=function(){var DM_V6=function DM_V6(){this._logger=require("x.logger.js").getLogger("x.hub.deviceman.DeviceManagerV6"),this._dataFolder=null,this._devices=null,this._statesBuffer={};};return DM_V6.FILE_NAME="db_v6.enc",DM_V6.prototype.getGateways=function(){return this._devices&&this._devices.gateways?this._devices.gateways:{};},DM_V6.prototype.getGateway=function(e){return this._devices&&this._devices.gateways&&this._devices.gateways[e]?this._devices.gateways[e]:null;},DM_V6.prototype.setGateway=function(e,t,n){e?(t?this._devices.gateways[e]=t:delete this._devices.gateways[e],this._writeDB(function(e){n&&n(e,t);})):n&&n(new Error("invalid gateway id"));},DM_V6.prototype.getDevices=function(){return this._devices&&this._devices.devices?this._devices.devices:{};},DM_V6.prototype.getDevice=function(e){return this._devices&&this._devices.devices&&this._devices.devices[e]?this._devices.devices[e]:null;},DM_V6.prototype.setDevice=function(e,t,n){e?(t?this._devices.devices[e]=t:(delete this._devices.devices[e],delete this._statesBuffer[e]),this._writeDB(function(e){n&&n(e,t);})):n&&n(new Error("invalid device id"));},DM_V6.prototype.setBufferedStates=function(e,t){e&&(t?this._statesBuffer[e]=t:delete this._statesBuffer[e]);},DM_V6.prototype.getAllBufferedStates=function(){return this._statesBuffer;},DM_V6.prototype.init=function(e,t,n){var i=require("path"),a=t.getUserRootDataPath();this._dataFolder=i.resolve(a,"db_v6"),this._logger.log("info","init device manager v6:"+this._dataFolder),"CA"==global.HARDWARE_VERSION?this._initHttpApi(e):this._initHttpApiOld(e),this._loadDB(function(e){n&&n(e);});},DM_V6.prototype._initHttpApi=function(e){var t=this,n=require("x.hub.js").getServer();n.addRoute("/api/gateways",{method:"GET"},function(e,n,i){var a=t.getGateways();n.json({XC_SUC:a||{}});}),n.addRoute("/data/gtw/",{method:"GET"},function(e,n,i){var a=e.path.substr(10),o=t.getGateway(a);o?n.json({XC_SUC:o}):n.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),n.addRoute("/data/gtw/",{method:"POST"},function(e,n){var i=e.path.substr(10);try{var a=e.json;t.setGateway(i,a,function(t,i){t?n.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+t.message}}):i?n.json({XC_SUC:{bytes:e.size}}):n.json({XC_SUC:{bytes:0}});});}catch(e){n.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+e.message}});}}),n.addRoute("/api/devices",{method:"GET"},function(e,n,i){var a=t.getDevices();n.json({XC_SUC:a||{}});}),n.addRoute("/data/dev/",{method:"GET"},function(e,n,i){var a=e.path.substr(10),o=t.getDevice(a);o?n.json({XC_SUC:o}):n.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),n.addRoute("/data/dev/",{method:"POST"},function(e,n){var i=e.path.substr(10);try{var a=e.json;t.setDevice(i,a,function(t,i){t?n.json({XC_ERR:{code:"000101",msg:"failed to set device:"+t.message}}):i?n.json({XC_SUC:{bytes:e.size}}):n.json({XC_SUC:{bytes:0}});});}catch(e){n.json({XC_ERR:{code:"000101",msg:"failed to set device:"+e.message}});}});},DM_V6.prototype._initHttpApiOld=function(e){var t=this,n=require("x.hub.js").getServer();e.get("/api/gateways",function(e,i,a){if(n.auth(e)){var o=t.getGateways();i.json({XC_SUC:o||{}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.get("/data/gtw/:id",function(e,i,a){if(n.auth(e)){var o=e.params.id,r=t.getGateway(o);r?i.json({XC_SUC:r}):i.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.post("/data/gtw/:id",function(e,i){if(n.auth(e)){var a=new Buffer(0);e.on("data",function(e){a=Buffer.concat([a,e]);}),e.on("end",function(){var n=e.params.id,o=a.toString("utf8");try{var r=null;o&&(r=JSON.parse(o)),t.setGateway(n,r,function(e,t){e?i.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+e.message}}):t?i.json({XC_SUC:{bytes:a.length}}):i.json({XC_SUC:{bytes:0}});});}catch(e){i.json({XC_ERR:{code:"000101",msg:"failed to set gateway:"+e.message}});}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.get("/api/devices",function(e,i,a){if(n.auth(e)){var o=t.getDevices();i.json({XC_SUC:o||{}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.get("/data/dev/:id",function(e,i,a){if(n.auth(e)){var o=e.params.id,r=t.getDevice(o);r?i.json({XC_SUC:r}):i.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});}),e.post("/data/dev/:id",function(e,i){if(n.auth(e)){var a=new Buffer(0);e.on("data",function(e){a=Buffer.concat([a,e]);}),e.on("end",function(){var n=e.params.id,o=a.toString("utf8");try{var r=null;o&&(r=JSON.parse(o)),t.setDevice(n,r,function(e,t){e?i.json({XC_ERR:{code:"000101",msg:"failed to set device:"+e.message}}):t?i.json({XC_SUC:{bytes:a.length}}):i.json({XC_SUC:{bytes:0}});});}catch(e){i.json({XC_ERR:{code:"000101",msg:"failed to set device:"+e.message}});}});}else i.json({XC_ERR:{code:"000007",msg:"access denied"}});});},DM_V6.prototype._loadDB=function(e){var t=require("fs-extra"),n=this._getFile(),i=this;t.ensureFile(n,function(t){t?e(t):i._loadFile(function(t,n){if(t)return i._devices={gateways:{},devices:{}},void e(t);i._devices=n||{gateways:{},devices:{}},e();});});},DM_V6.prototype._writeDB=function(e){this._writeFile(this._devices,function(t){e(t);});},DM_V6.prototype._getFile=function(){return require("path").resolve(this._dataFolder,DM_V6.FILE_NAME);},DM_V6.prototype._loadFile=function(e){var t=require("fs"),n=this._getFile(),i=this;t.readFile(n,"utf8",function(t,n){if(t)e(t);else if(n)try{n=require("x.crypt").AES.decodeString(n,i._ml_v1_info());var a=JSON.parse(n);e(null,a);}catch(t){e(null,{});}else e(null,"");});},DM_V6.prototype._writeFile=function(e,t){var n=require("fs"),i=require("x.crypt.js"),a=this._getFile();try{var o=i.AES.encodeString(JSON.stringify(e),this._ml_v1_info());n.writeFile(a,o,function(e){t&&t(e);});}catch(e){t&&t(e);}},DM_V6.prototype._ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3");},DM_V6;}(),x.hub.deviceman.Handler=function(){this.deviceManager=new x.hub.deviceman.DeviceManager("db",1),this.deviceManager2=new x.hub.deviceman.DeviceManager("db2",2),this.deviceManagerV6=new x.hub.deviceman.DeviceManagerV6();},x.hub.deviceman.Handler.prototype.DeviceManager=x.hub.deviceman.DeviceManager,x.hub.deviceman.Handler.prototype.init=function(e,t,n){this._config(e);var i=0;this.deviceManager.init(t,function(e){3==++i&&n&&n(e);}),this.deviceManager2.init(t,function(e){3==++i&&n&&n(e);}),this.deviceManagerV6.init(e,t,function(e){3==++i&&n&&n(e);});},x.hub.deviceman.Handler.prototype._config=function(e){var t=this;e.use("/xhub/devicemanager/:id/:type",function(e,t,n){if(e._body)return n();if(e.body=e.body||{},"GET"==e.method||"HEAD"==e.method)return n();if(!e.is("text/xml"))return n();e._body=!0;var i="";e.setEncoding("utf8"),e.on("data",function(e){i+=e;}),e.on("end",function(){e.body=i,n();});}),e.use("/xhub/devicemanager/:id/:type",function(e,n){var i=e.method.toLowerCase(),a=e.params.id,o=e.params.type,r=null,s=null;switch(i){case"get":s="readWithoutLicense",r=e.query;break;case"post":s="create",r=e.body;break;case"put":s="update",r=e.body;break;case"delete":s="delete",r=e.query.index;}if(s)t.deviceManager.execute(s,a,o,r,function(e,t){e?n.send(this.error2json(e)):t.toJSON&&"function"==typeof t.toJSON?n.send(t.toJSON()):o&&"deviceinfo"==o?(n.set("Content-Type","text/xml"),n.send(t)):n.send(t);}.bind(this));else{var d=new Error("invalid http method");d.code=500,n.send(this.error2json(d));}}.bind(this));},module.exports=new x.hub.deviceman.Handler();