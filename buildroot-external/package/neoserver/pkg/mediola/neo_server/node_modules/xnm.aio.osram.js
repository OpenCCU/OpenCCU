var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.osram=xnm.aio.osram||{},xnm.aio.osram.DMError=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="OsramDmError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},DMError;}(),xnm.aio.osram.Lightify=function(){var Util__arr2str=function Util__arr2str(e){for(var t="",a=0,o=0,r=0,n=0;a<e.length&&0!=e[a];){(o=e[a])<128?(t+=String.fromCharCode(o),a++):o>191&&o<224?(r=e[a+1],t+=String.fromCharCode((31&o)<<6|63&r),a+=2):(r=e[a+1],n=e[a+2],t+=String.fromCharCode((15&o)<<12|(63&r)<<6|63&n),a+=3);}return t;},Util__hex2arr=function Util__hex2arr(e){for(var t=[],a=0;a<e.length;a+=2){t.push(parseInt(e.substr(a,2),16));}return t;},Util__arr2hex=function Util__arr2hex(e){for(var t="",a=0;a<e.length;a++){for(var o=e[a].toString(16);o.length<2;){o="0"+o;}t+=o.toUpperCase();}return t;},Lightify=function Lightify(e,t,a){this._logger=require("x.logger.js").getLogger("xnm.aio.osram.Lightify"),this.uuid=a,this.ip=e,this.port=t,(!t||t<0)&&(this.port=4e3),Lightify._SB.addBuffer(this),this._socket=null;};return Lightify.SO_TIMEOUT=5e3,Lightify._SB={_buffer:{},addBuffer:function addBuffer(e){var t=this.getBuffer(e);return t||(t={lightify:e,dataBuffer:"",packetBuffer:[],reqId:0,status:0},this._buffer[e.ip+":"+e.port]=t),t;},getBuffer:function getBuffer(e){return this._buffer[e.ip+":"+e.port];},_getNextReqId:function _getNextReqId(e){var t=this.getBuffer(e);return t.reqId+=1,t.reqId;},addPacket:function addPacket(e,t,a){var o=this.addBuffer(e),r=this._getNextReqId(e);t.reqId=r;var n={reqId:r,frame:t,callback:a,timeout:null},i=o.packetBuffer.length;switch(o.status){case 0:o.packetBuffer.push(n),o.status=1,o.lightify._connect();break;case 1:o.packetBuffer.push(n);break;case 2:o.packetBuffer.push(n),0==i&&this._sendNextPacket(e);break;case 3:a(new Error("socket is closing"));}},removePacket:function removePacket(e,t){t.timeout&&(clearTimeout(t.timeout),t.timeout=null);var a=this.getBuffer(e);if(a&&a.packetBuffer){for(var o=-1,r=0;r<a.packetBuffer.length;r++){if(a.packetBuffer[r]===t){o=r;break;}}-1!=o&&a.packetBuffer.splice(o,1);}},_sendNextPacket:function _sendNextPacket(e){var t=this.getBuffer(e);t&&t.packetBuffer&&t.packetBuffer[0]&&this._sendPacket(e,t.packetBuffer[0]);},_sendPacket:function _sendPacket(e,t){var a=this.getBuffer(e);if(a&&a.lightify){var o=this;t.timeout=setTimeout(function(){t.timeout=null,o.removePacket(e,t),o._sendNextPacket(e),t.callback&&t.callback(new Error("frame response timeout"));},5e3),a.lightify._logger.log("debug","send frame:"+JSON.stringify(t.frame)),a.lightify._send(t.frame.flag,t.frame.cmd,t.frame.reqId,t.frame.payload);}},_clearPackets:function _clearPackets(e,t){var a=this.getBuffer(e);if(a&&a.packetBuffer){var o,r=[];for(o=0;o<a.packetBuffer.length;o++){r.push(a.packetBuffer[o]);}for(a.packetBuffer=[],o=0;o<r.length;o++){r[o]&&r[o].callback&&(r[o].timeout&&clearTimeout(r[o].timeout),r[o].callback(t),r[o].callback=null);}}},_resolveData:function _resolveData(e){var t=this.getBuffer(e);if(t&&t.dataBuffer&&t.dataBuffer.length>4){var a=parseInt(t.dataBuffer.substr(0,2),16),o=(parseInt(t.dataBuffer.substr(2,2),16)<<8)+a;if(t.dataBuffer.length>=4+2*o){var r=t.dataBuffer.substr(0,4+2*o);t.dataBuffer=t.dataBuffer.substr(4+2*o);var n=e._hex2frame(r);n&&this._onFrame(e,n),t.dataBuffer&&this._resolveData(e);}}},_onFrame:function _onFrame(e,t){var a=this.getBuffer(e);if(a&&a.packetBuffer){for(var o=null,r=0;r<a.packetBuffer.length;r++){if(a.packetBuffer[r]&&a.packetBuffer[r].reqId==t.reqId){o=a.packetBuffer[r];break;}}o&&(this.removePacket(e,o),this._sendNextPacket(e),o.callback&&o.callback(null,t));}},_onSocketConnect:function _onSocketConnect(e){var t=this.getBuffer(e);t&&(t.status=2,this._sendNextPacket(e));},_onSocketTimeout:function _onSocketTimeout(e){var t=this.getBuffer(e);t&&1==t.status&&(t.status=0,this._clearPackets(e,new Error("socket connection timeout")));},_onSocketError:function _onSocketError(e,t){var a=this.getBuffer(e);if(a)switch(a.status){case 0:case 1:case 3:a.status=0;break;case 2:a.status=3,e._close();}this._clearPackets(e,t);},_onSocketClose:function _onSocketClose(e){var t=this.getBuffer(e);t&&(t.status=0,this._clearPackets(e,new Error("socket closed")));},_onSocketData:function _onSocketData(e,t){var a=this.getBuffer(e);a&&(a.dataBuffer+=t),this._resolveData(e);}},Lightify.prototype.executeCommandCreator=function(e,t,a){e?t?this._doCommand(e,t,a):a&&a(new Error("command is null")):a&&a(new Error("device is null"));},Lightify.prototype.executeCommand=function(e,t,a){var o={};6==t.length||8==t.length?(o.value="rgbw",o.ext=t):4==t.length?(o.value="ct",o.ext=parseInt(t)):2==t.length&&parseInt(t)>=0&&parseInt(t)<=100?(o.value="bri",o.ext=t):o.value=t,this.executeCommandCreator(e,o,a);},Lightify.prototype.getStateValues=function(e,t){var a={};return t&&(t.onoff?a.state="on":a.state="off",t.level&&(a.bri=t.level)),a;},Lightify.prototype.getStates=function(e,t,a){this.getStatesCreator(e,t,a);},Lightify.prototype.getStatesCreator=function(e,t,a){var o=this;this.CommandHandler=e,this._getAllNodeState(function(e,r){!e&&r&&o._logger.log("debug","get all node state response:"+JSON.stringify(r));var n={};if(r)for(var i=Object.keys(r),s=0;s<i.length;s++){n[i[s]]=o._resolveRawState(r[i[s]]);}if(r&&o.CommandHandler&&o.CommandHandler.receivedState)for(var c in r){o.CommandHandler.receivedState("lightify",c,r[c]);}if(t){for(var u=[],l=0;l<t.length;l++){var f=t[l];if(f&&f.id){var d="?";f.device&&f.device.address&&f.status&&f.status.value&&!e&&n&&(n[f.device.address]&&(d=n[f.device.address][f.status.value]),null==d&&void 0===d&&(d="?")),u.push({id:f.id,status:d});}}a&&a(null,u);}else a&&a(new Error("deviceList is null"));});},Lightify.prototype.listNodes=function(e){this._networkListNodes(function(t,a){if(t)e&&e(t);else{var o=[];if(a)for(var r=0;r<a.length;r++){if(a[r]&&a[r].id64){var n={type:"light",data:a[r].type,name:a[r].name,address:a[r].id64};"10"==a[r].type&&(n.type="plug"),o.push(n);}}e&&e(null,o);}});},Lightify.prototype.listZones=function(e){this._networkListZones(function(t,a){if(t)e&&e(t);else{var o=[];if(a)for(var r=0;r<a.length;r++){a[r]&&a[r].id&&o.push({type:"group",data:"00",address:a[r].id,name:a[r].name});}e&&e(null,o);}});},Lightify.prototype._doCommand=function(e,t,a){if(e&&t){if(t.value){var o=this;switch(t.value){case"toggle":case"up":case"down":this._getAllNodeState(function(r,n){if(r)a&&a(r);else{var i=n[e.address];if(i)switch(t.value){case"toggle":o._doCommand(e,{value:i.onoff?"off":"on"},function(e,t){a&&a(e,t);});break;case"up":case"down":var s=i.level;if("up"==t.value)0==i.onoff?s=10:s+=10;else{if(0==i.onoff)return void(a&&a(null));s-=10;}s>100&&(s=100),s<0&&(s=0),o._doCommand(e,{value:"bri",ext:s},function(e,t){a&&a(e,t);});break;default:a&&a(null);}else a&&a(new Error("no such device in network"));}});break;case"bri":if(0==parseInt(t.ext)){this._doCommand(e,{value:"bri",ext:1},function(t,r){t?a&&a(t):o._doCommand(e,{value:"off"},function(e,t){a&&a(e,t);});});break;}default:this._buildCommandReq(e,t,function(e,t){e?a&&a(e):(o._logger.log("debug","send command frame:"+JSON.stringify(t)),Lightify._SB.addPacket(o,t,function(e,r){return e?(o._logger.log("debug","receive command response error:"+e.message),void(a&&a(e))):(o._logger.log("debug","receive command response:"+JSON.stringify(r)),(e=o._statusError(r.status))?(o._logger.log("debug","receive command response status error:"+e.message),void(a&&a(e))):void(a&&a(null,t)));}));});}}else a&&a(new Error("command invalid"));}else a&&a(new Error("invalid parameters"));},Lightify.prototype._getAllNodeState=function(e){this._networkListNodes(function(t,a){if(t)e&&e(t);else{var o={};if(a)for(var r=0;r<a.length;r++){a[r]&&a[r].id64&&(o[a[r].id64]={online:parseInt(a[r].online,16),onoff:parseInt(a[r].onoff,16),level:parseInt(a[r].level,16),colorTemp:parseInt(a[r].cct.substr(2,2)+a[r].cct.substr(0,2),16),red:parseInt(a[r].red,16),green:parseInt(a[r].green,16),blue:parseInt(a[r].blue,16),white:parseInt(a[r].white,16)});}e&&e(null,o);}});},Lightify.prototype._networkListNodes=function(e){this._logger.log("debug","send network list node request");var t=this;Lightify._SB.addPacket(this,{flag:0,cmd:19,payload:[1]},function(a,o){if(a)return t._logger.log("debug","receive network list node response error:"+a.message),void(e&&e(a));t._logger.log("debug","receive network_list_nodes response:"+JSON.stringify(o)),a=t._statusError(o.status),e&&e(a,o.nodes);});},Lightify.prototype._networkListZones=function(e){this._logger.log("debug","send network list zones request");var t=this;Lightify._SB.addPacket(this,{flag:2,cmd:30,payload:[]},function(a,o){if(a)return t._logger.log("debug","receive network list zones response error:"+a.message),void(e&&e(a));t._logger.log("debug","receive network_list_zones response:"+JSON.stringify(o)),a=t._statusError(o.status),e&&e(a,o.zones);});},Lightify.prototype._buildCommandReq=function(e,t,a){if(e&&e.address&&t&&t.value){var o=!1;4==e.address.length&&(o=!0);var r,n,i=o?2:0;switch(t.value){case"on":case"off":n=e.address,o&&(n+="000000000000"),(n=Util__hex2arr(n)).push("on"==t.value?1:0),r=50;break;case"bri":if(null==t.ext||void 0===t.ext)return void a(new Error("command invalid"));i|=128;var s=parseInt(t.ext);s>100&&(s=100),s<0&&(s=0),n=e.address,o&&(n+="000000000000"),(n=Util__hex2arr(n)).push(s),n=n.concat([1,0]),r=49;break;case"ct":if(null==t.ext||void 0===t.ext)return void a(new Error("command invalid"));i|=128;var c=parseInt(t.ext);c>6500&&(s=6500),c<2e3&&(c=2e3),n=e.address,o&&(n+="000000000000"),(n=Util__hex2arr(n)).push(255&c),n.push(c>>8&255),n=n.concat([1,0]),r=51;break;case"rgbwS":case"rgbw":if(!t.ext)return void a(new Error("command invalid"));var u=Util__hex2arr(t.ext);u.length<4&&u.push(0),u.length>4&&(u=u.slice(0,4)),n=e.address,o&&(n+="000000000000"),n=(n=(n=Util__hex2arr(n)).concat(u)).concat([1,0]),r=54;break;case"effect":if(!t.ext)return void a(new Error("command invalid"));if(n=e.address,o&&(n+="000000000000"),n=Util__hex2arr(n),"none"==t.ext)n.push(0),n=n.concat([0,0]);else{if("colorloop"!=t.ext)return void a(new Error("command invalid"));n.push(1),n=n.concat([15,0]);}r=55;break;default:return void a(new Error("unknow command:"+t.value),null);}a(null,{flag:i,cmd:r,payload:n});}else a(new Error("build command req parameters invalid"));},Lightify.prototype._resolveRawState=function(e){var t=e.red.toString(16);2!=t.length&&(t="0"+t);var a=e.green.toString(16);2!=a.length&&(a="0"+a);var o=e.blue.toString(16);2!=o.length&&(o="0"+o);var r=e.white.toString(16);return 2!=r.length&&(r="0"+r),{power:e.onoff?"on":"off",bri:e.onoff?e.level:0,ct:e.colorTemp,rgbw:(t+a+o+r).toUpperCase()};},Lightify.prototype._statusError=function(e){var t=null;switch(e){case 16:case 17:case 18:case 21:case 255:t=new Error("error code:"+e);}return t;},Lightify.prototype._buildFrame=function(e,t,a,o){var r=[],n=6+o.length;return r.push(255&n),r.push(n>>8&255),r.push(e),r.push(t),r.push(255&a),r.push(a>>8&255),r.push(a>>16&255),r.push(a>>24&255),r=r.concat(o);},Lightify.prototype._connect=function(){this._logger.log("trace","connect");var e=this,t=!1,a=require("net"),o={port:this.port,host:this.ip},r=a.connect(o);r.setTimeout(Lightify.SO_TIMEOUT),r.setEncoding("hex"),r.on("connect",function(){e._logger.log("trace","connect to lightify:"+e.ip),t=!0,e._socket=r,Lightify._SB._onSocketConnect(e,r);}),r.on("data",function(t){e._logger.log("trace","receive from lightify:"+e.ip+" data:"+t),Lightify._SB._onSocketData(e,t);}),r.on("error",function(a){t?e._logger.log("trace","lightify:"+e.ip+" error:"+a.message):e._logger.log("trace","lightify:"+e.ip+" connection error:"+a.message),Lightify._SB._onSocketError(e,a);}),r.on("timeout",function(){t?e._logger.log("trace","hub:"+e.ip+" data timeout"):e._logger.log("trace","lightify:"+e.ip+" connection timeout"),Lightify._SB._onSocketTimeout(e);}),r.on("close",function(){e._logger.log("trace","hub:"+e.ip+" close socket"),Lightify._SB._onSocketClose(e);}),r._doConnect&&"function"==typeof r._doConnect&&r._doConnect();},Lightify.prototype._send=function(e,t,a,o,r){var n=this._buildFrame(e,t,a,o);this._sendRaw(n,function(e){r&&r(e,a);});},Lightify.prototype._sendRaw=function(e,t){this._logger.log("trace","send to lightify:"+this.ip+" data:"+Util__arr2hex(e)),this._socket.write(new Buffer(e)),t&&t();},Lightify.prototype._close=function(){this._logger.log("trace","close"),this._socket&&this._socket.end();},Lightify.prototype._hex2frame=function(e){var _resolveNodeInfo=function _resolveNodeInfo(e){var t={};return t.id16=Util__arr2hex(e.slice(0,2)),t.id64=Util__arr2hex(e.slice(2,10)),t.type=Util__arr2hex(e.slice(10,11)),t.majorVer=Util__arr2hex(e.slice(11,12)),t.minorVer=Util__arr2hex(e.slice(12,13)),t.patchVer=Util__arr2hex(e.slice(13,14)),t.buildVer=Util__arr2hex(e.slice(14,15)),t.online=Util__arr2hex(e.slice(15,16)),t.groupMember=Util__arr2hex(e.slice(16,18)),t.onoff=Util__arr2hex(e.slice(18,19)),t.level=Util__arr2hex(e.slice(19,20)),t.cct=Util__arr2hex(e.slice(20,22)),t.red=Util__arr2hex(e.slice(22,23)),t.green=Util__arr2hex(e.slice(23,24)),t.blue=Util__arr2hex(e.slice(24,25)),t.white=Util__arr2hex(e.slice(25,26)),t.name=e.slice(26,42),t.name=Util__arr2str(t.name),t;},t=Util__hex2arr(e);if((t[1]<<8)+t[0]<6)return null;var a,o={flag:t[2],cmd:t[3]};switch(o.reqId=t[4]+(t[5]<<8)+(t[6]<<16)+(t[7]<<24),o.payload=t.slice(8),o.valid=!1,o.cmd){case 19:if(o.payload.length>=3&&(o.valid=!0,o.status=o.payload[0],o.num=o.payload[1]+(o.payload[2]<<8),o.nodes=[],o.num>0))for(a=0;a<o.num&&!(o.payload.length<3+50*(a+1));a++){var r=_resolveNodeInfo(o.payload.slice(3+50*a,3+50*(a+1)));o.nodes.push(r);}break;case 30:if(o.payload.length>=3&&(o.valid=!0,o.status=o.payload[0],o.num=o.payload[1]+(o.payload[2]<<8),o.zones=[],o.num>0))for(a=0;a<o.num&&!(o.payload.length<3+18*(a+1));a++){var n={};n.id=o.payload.slice(3+18*a,3+18*a+2),n.id=Util__arr2hex(n.id),n.name=o.payload.slice(3+18*a+2,3+18*a+2+16),n.name=Util__arr2str(n.name),o.zones.push(n);}break;case 49:case 50:case 51:case 54:case 55:o.payload.length>=12&&(o.valid=!0,o.status=o.payload[0],o.result=o.payload.slice(3));break;case 98:o.payload.length>=13&&(o.valid=!0,o.status=o.payload[0],o.num=o.payload[1]+(o.payload[2]<<8),o.result=o.payload.slice(3,12),o.onoff=o.payload[12]);break;case 104:o.payload.length>=13&&(o.valid=!0,o.status=o.payload[0],o.num=o.payload[1]+(o.payload[2]<<8),o.result=o.payload.slice(3,12),o.online=o.payload[12],o.onoff=o.payload[13],o.level=o.payload[14],o.colorTemp=o.payload[15]+(o.payload[16]<<8),o.red=o.payload[17],o.green=o.payload[18],o.blue=o.payload[19],o.white=o.payload[20]);break;default:o.valid=!0;}return o;},Lightify.prototype.toJSON=function(){return{sys:xnm.aio.osram.Lightify.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid};},Lightify.prototype.equalsTo=function(e){return!!e&&e instanceof Lightify&&this.ip==e.ip&&this.port==e.port;},Lightify.parseJSON=function(e){return e.ip?new Lightify(e.ip,e.port):null;},Lightify.discoveryWithTimeout=function(e,t){var a=require("x.mdns.js");a.clearRecordBuffer(),a.discoverServiceWithTimeout("_http._tcp.local",e,function(e,a){if(e)t&&t(e);else{for(var o=[],r=0;r<a.length;r++){var n=a[r];if(n.target&&n.ip&&n.ip.length>0&&0==n.target.indexOf("Lightify")){var i=n.target.substr(9);i=i.replace(".local","");var s=new Lightify(n.ip[0]);s.uuid=i,o.push(s);}}t&&t(e,o);}});},Lightify;}(),xnm.aio.osram.Lightify.DM=function(){var e=xnm.aio.osram.DMError,t=xnm.aio.osram.DMError.ERROR_CODE,_checkInfo=function _checkInfo(a,o,r){if(a){if(a.gateway){if(a.type){if(null!=a.data&&void 0!==a.data){if(o.data&&o.data.gateways&&0!==o.data.gateways.length){var n,i,s=o.data.gateways;for(n=0;n<s.length;n++){if(s[n].index===a.gateway){i=s[n];break;}}i?r():r(new e(t.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));}else r(new e(t.NOT_FOUND,"gateway with index "+a.gateway+" not exists"));}else r(new e(t.INVALID,"data is invalid"));}else r(new e(t.INVALID,"type is invalid"));}else r(new e(t.INVALID,"gateway is invalid"));}else r(new e(t.INVALID,"info is invalid"));};return{SYS:"lightify",MAP:{onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}}],status:[{type:"int",name:"brightness",ref:{value:"bri",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"2700-6500",scale:"38"}}],status:[{type:"int",name:"color temperature",ref:{value:"ct",extMeta:"2700-6500",scale:"38"}}]},colorlight:{command:[{type:"string",name:"rgbw color",ref:{value:"rgbwS",ext:"%s"}},{type:"rgbw",name:"rgbw color",ref:{value:"rgbw",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}}],status:[{type:"rgbw",name:"rgbw color",ref:{value:"rgbw"}}]},extendcolor:{},group:{command:[{type:"int",name:"do scene",ref:{value:"doScene",ext:"%d"}}]}},registModule:function registModule(e){e.register(this.SYS,"osram");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"OSRAM LIGHTIFY / LEDvance Gateway",port:4e3};},getGatewayDeviceType:function getGatewayDeviceType(){var e={sys:this.SYS,type:"light",name:"Light",subtypes:[]};return e.subtypes.push({id:"OnOff Light",data:1}),e.subtypes.push({id:"Color Dimmer Light",data:2}),e.subtypes.push({id:"Dimmer Light",data:4}),e.subtypes.push({id:"Color Light",data:8}),e.subtypes.push({id:"Extended Color Light",data:10}),[e,{sys:this.SYS,type:"group",name:"Group"}];},createGateway:function createGateway(a,o,r){a?a.ip?r(null,a):r(new e(t.INVALID,"ip is invalid")):r(new e(t.INVALID,"info is invalid"));},updateGateway:function updateGateway(a,o,r,n){o?o.ip?n(null,o):n(new e(t.INVALID,"ip is invalid")):n(new e(t.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){_checkInfo(e,t,function(t){a(t,e);});},updateDevice:function updateDevice(e,t,a){_checkInfo(e,t,function(t){a(t,e);});},deleteDevice:function deleteDevice(e,t,a){a(null,e);},getCommandStatusMap:function getCommandStatusMap(e){var _mapclone=function _mapclone(e){return JSON.parse(JSON.stringify(e));};if(!e)return null;var t={command:[],status:[]},a=0;switch("light"!=e.type&&"plug"!=e.type||(a=10,null!=e.data&&void 0!==e.data&&(a=parseInt(e.data,16))),a){case 0:t.command=t.command.concat(_mapclone(this.MAP.group.command)),t.command=t.command.concat(_mapclone(this.MAP.colorlight.command)),t.command=t.command.concat(_mapclone(this.MAP.colortemp.command)),t.command.push(_mapclone(this.MAP.dimmable.command[2])),t.command.push(_mapclone(this.MAP.onoff.command[1])),t.command.push(_mapclone(this.MAP.onoff.command[2]));break;case 10:case 8:t.command=t.command.concat(_mapclone(this.MAP.colorlight.command)),t.status=t.status.concat(_mapclone(this.MAP.colorlight.status));case 2:var o=_mapclone(this.MAP.colortemp.command),r=_mapclone(this.MAP.colortemp.status);if(10==a){for(var n=0;n<o.length;n++){o[n]&&o[n].ref&&"ct"==o[n].ref.value&&(o[n].ref.extMeta="2000-6500",o[n].ref.scale="15");}for(n=0;n<r.length;n++){r[n]&&r[n].ref&&"ct"==r[n].ref.value&&(o[n].ref.extMeta="2000-6500",o[n].ref.scale="15");}t.command=t.command.concat(o),t.status=t.status.concat(r);}else t.command=t.command.concat(o),t.status=t.status.concat(r);case 4:t.command=t.command.concat(_mapclone(this.MAP.dimmable.command)),t.status=t.status.concat(_mapclone(this.MAP.dimmable.status));case 1:case 16:t.command=t.command.concat(_mapclone(this.MAP.onoff.command)),t.status=t.status.concat(_mapclone(this.MAP.onoff.status));}return 0==a&&delete t.status,t;}};}(),xnm.aio.osram.DM=function(){var e=xnm.aio.osram.DMError,t=xnm.aio.osram.DMError.ERROR_CODE;return{getGatewayType:function getGatewayType(){var e=[];for(var t in xnm.aio.osram){if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];if(a&&a.DM&&a.DM.getGatewayType){var o=a.DM.getGatewayType();o&&e.push(o);}}}return e;},getGatewayDeviceType:function getGatewayDeviceType(e){var t=[];for(var a in xnm.aio.osram){if(xnm.aio.osram.hasOwnProperty(a)){var o=xnm.aio.osram[a];if(o&&o.DM&&o.DM.getGatewayDeviceType){var r=o.DM.getGatewayDeviceType(e);r&&(Array.isArray(r)?t=t.concat(r):t.push(r));}}}return t;},getIPDeviceType:function getIPDeviceType(e,t){var a=[];for(var o in xnm.aio.osram){if(xnm.aio.osram.hasOwnProperty(o)){var r=xnm.aio.osram[o];if(r&&r.DM&&r.DM.getIPDeviceType){var n=r.DM.getIPDeviceType(e,t);n&&a.push(n);}}}return a;},_getSystem:function _getSystem(e){for(var t in xnm.aio.osram){if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];if(a&&a.DM&&a.DM.SYS&&a.DM.SYS==e)return a;}}return null;},_checkSystemMethod:function _checkSystemMethod(a,o,r){if(a){if(a.sys){var n=this._getSystem(a.sys);n&&n.DM&&n.DM[o]?r&&r(null,n):r&&r(new e(t.INVALID,"no such sys:"+a.sys));}else r&&r(new e(t.INVALID,"sys is invalid"));}else r&&r(new e(t.INVALID,"info is invalid"));},createGateway:function createGateway(e,t,a){this._checkSystemMethod(e,"createGateway",function(o,r){o?a&&a(o):r.DM.createGateway(e,t,a);});},updateGateway:function updateGateway(e,t,a,o){this._checkSystemMethod(t,"updateGateway",function(r,n){r?o&&o(r):n.DM.updateGateway(e,t,a,o);});},deleteGateway:function deleteGateway(e,t,a){this._checkSystemMethod(e,"deleteGateway",function(o,r){o?a&&a(o):r.DM.deleteGateway(e,t,a);});},createDevice:function createDevice(e,t,a){this._checkSystemMethod(e,"createDevice",function(o,r){o?a&&a(o):r.DM.createDevice(e,t,a);});},updateDevice:function updateDevice(e,t,a){this._checkSystemMethod(e,"updateDevice",function(o,r){o?a&&a(o):r.DM.updateDevice(e,t,a);});},deleteDevice:function deleteDevice(e,t,a){this._checkSystemMethod(e,"deleteDevice",function(o,r){o?a&&a(o):r.DM.deleteDevice(e,t,a);});},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,o=0;o<e.length;o++){if(e[o]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var a,o=[],r=null;if(e.sys){var n=this._getSystem(e.sys);n&&n.DM&&n.DM.getCommandStatusMap&&(a=n.DM.getCommandStatusMap(e));}return a&&(r=function(e,t,a){var o=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(a,0,t),o=o.concat(r)),o;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter.call(this,e,t),a.command=o;break;case"status":o=_filter.call(this,e,t),a.status=o;break;default:return null;}return o&&0!=o.length?a:null;}};}(),xnm.aio.osram.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.osram.DM,Handler.prototype.Lightify=xnm.aio.osram.Lightify,Handler.prototype.registModule=function(e){for(var t in xnm.aio.osram){if(xnm.aio.osram.hasOwnProperty(t)){var a=xnm.aio.osram[t];a&&a.DM&&a.DM.registModule&&a.DM.registModule(e);}}},Handler.prototype.getStateValues=function(e,t){return new xnm.aio.osram.Lightify().getStateValues(e,t);},Handler.prototype.resolveGateway=function(e){return e.sys===xnm.aio.osram.Lightify.DM.SYS?xnm.aio.osram.Lightify.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.osram.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),o=a?a.command:[];t&&t(null,o);},Handler.prototype.getDeviceCommandList=function(e,t){var a=[];if("color-light"!=e.data&&"ext-color-light"!=e.data&&"group"!=e.data||t||a.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"}),a.push({id:window.XC_Text.on,cmd:"on"}),a.push({id:window.XC_Text.off,cmd:"off"}),("dimmer"==e.data||"color-temp-dimmer"==e.data||"color-light"==e.data||"ext-color-light"==e.data||"group"==e.data)&&!t)for(var o=0;o<=100;o+=5){a.push({id:window.XC_Text.dimTo+o+"%",cmd:""+o});}if(("color-temp-dimmer"==e.data||"color-light"==e.data||"ext-color-light"==e.data||"group"==e.data)&&!t)for(var r=2700;r<=6500;r+=380){a.push({id:window.XC_Text.colortemp+r,cmd:""+r});}return a;},Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.osram.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),o=a?a.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,a,o){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,o,r){var n=this.resolveGateway(t);if(n){var i=[{id:e,device:a,status:o}];n.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.searchLightifyWithTimeout=function(e,t){xnm.aio.osram.Lightify.discoveryWithTimeout(e,t);},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a instanceof xnm.aio.osram.Lightify?a.listNodes(function(e,o){e?t&&t(e):a.listZones(function(e,a){e?t&&t(e):t&&t(null,{lights:o,groups:a});});}):t&&t(new Error("gateway do not support get device list")):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.osram.Handler());