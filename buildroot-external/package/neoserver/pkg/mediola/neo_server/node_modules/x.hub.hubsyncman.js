var util=require("util"),EventEmitter=require("events");var x=x||{};x.hub=x.hub||{},x.hub.hubsyncman=x.hub.hubsyncman||{},x.hub.hubsyncman.Error=function(e,n){Error.call(this,e),this.code=n;},util.inherits(x.hub.hubsyncman.Error,Error),x.hub.hubsyncman.SyncManager=function(){var SM=function SM(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.SyncManager"),this._tenant=null,this._tenant2=null;};return SM.prototype.init=function(e,n){this._logger.log("info","init hub sync managaer");var r=require("m.aio.configmanager.js"),t=this._generateTenantParent(e);this._tenant=new r.Tenant(t),this._tenant.license="dummy",this._tenant.folder="db",this._tenant2=new r.Tenant(t),this._tenant2.license="dummy",this._tenant2.folder="db2",n&&n();},SM.prototype.deploy=function(e,n,r,t,a){var o=this;require("async").waterfall([function(n){o._writeZip(e,n);},function(e,n){var r=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),t=require("path"),a=require("fs-extra"),i=t.resolve(r,"db");if(a.existsSync(i))try{var s=a.lstatSync(i);if(s.isDirectory(i)){var u=t.resolve(i,"device_db");a.existsSync(u)&&((s=a.lstatSync(u)).isFile()||a.removeSync(u));var c=t.resolve(i,"macros_db");a.existsSync(c)&&((s=a.lstatSync(c)).isFile()||a.removeSync(c));}else a.removeSync(i);}catch(e){}o._unzip(e,n);},function(e){o._encryptDeviceDB(e);},function(e){require("x.hub.taskman.js").taskManager.clear(),e();},function(e){require("x.hub.deviceman.js").deviceManager.reload(e);},function(e){require("x.hub.macroman.js").macroManager.reload(e);},function(e){require("x.hub.taskman.js").taskManager.reload(e);},function(e){require("x.hub.scriptman.js").scriptManager.reload(e);},function(e){(localStorage.setItem("x.hub.hubsyncman.SyncManager.TIMESTAMP",new Date().getTime()),localStorage.setItem("x.hub.hubsyncman.SyncManager.USERID",n),localStorage.setItem("x.hub.hubsyncman.SyncManager.APPID",r),t)&&(localStorage.setItem("x.hub.m.gateway.DB1NeoIdx",t),require("x.hub.m.gateway.js").updateGatewayNeoIndex());e();}],function(e){a&&a(e);});},SM.prototype._encryptDeviceDB=function(e){var n=require("path"),r=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),t=n.join(r,"db","device_db"),a=n.join(r,"db2","device_db");this._encryptDeviceDBFileSync(t),this._encryptDeviceDBFileSync(a),e&&e();},SM.prototype._encryptDeviceDBFileSync=function(e){var n=require("fs"),r=require("x.crypt"),t=require("m.aio.devicemanager");try{if(n.existsSync(e)){this._logger.log("trace","[_encryptDeviceDB] Encrypting "+e);var a=n.readFileSync(e,"utf8");a&&(a=r.AES.encodeString(a,t.ml_v1_info()),n.writeFileSync(e+".enc",a),n.unlinkSync(e));}}catch(e){console.error(e),this._logger.log("error","[_encryptDeviceDB] "+e.message);}},SM.prototype.deploy2=function(e,n,r,t,a){var o=this;require("async").waterfall([function(n){o._writeZip(e,n);},function(e,n){var r=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),t=require("path"),a=require("fs-extra"),i=t.resolve(r,"db2");if(a.existsSync(i))try{var s=a.lstatSync(i);if(s.isDirectory(i)){var u=t.resolve(i,"device_db");a.existsSync(u)&&((s=a.lstatSync(u)).isFile()||a.removeSync(u));var c=t.resolve(i,"macros_db");a.existsSync(c)&&((s=a.lstatSync(c)).isFile()||a.removeSync(c));}else a.removeSync(i);}catch(e){}o._unzip(e,n);},function(e){o._encryptDeviceDB(e);},function(e){require("x.hub.deviceman.js").deviceManager2.reload(e);},function(e){require("x.hub.macroman.js").macroManager2.reload(e);},function(e){(localStorage.setItem("x.hub.hubsyncman.SyncManager2.TIMESTAMP",new Date().getTime()),localStorage.setItem("x.hub.hubsyncman.SyncManager2.USERID",n),localStorage.setItem("x.hub.hubsyncman.SyncManager2.APPID",r),t)&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",t),require("x.hub.m.gateway.js").updateGatewayNeoIndex());e();}],function(e){a&&a(e);});},SM.prototype._writeZip=function(e,n){var r=require("os"),t=require("fs"),a=require("path"),o="nam_"+Math.round(new Date().getTime()/1e3)+".zip",i=a.join(r.tmpdir(),o);this._logger.log("trace","create temp deploy zip:"+i);var s=t.createWriteStream(i);e.pipe(s);var u=n;s.on("error",function(e){u&&u(e),u=null;}),s.on("close",function(){u&&u(null,i),u=null;});},SM.prototype._unzip=function(e,n){var r=require("adm-zip"),t=require("x.hub.fileman.js").fileManager.getUserRootDataPath(),a=(require("path"),require("fs-extra"));try{new r(e).extractAllTo(t,!0),n&&n();}catch(e){n&&n(e);}a.remove(e);},SM.prototype.writeFile=function(e,n,r){var t=this._tenant.getFolderPath(),a=require("path"),o=require("fs-extra"),i=t+a.sep+e,s=this;o.writeFile(i,n,function(e){if(e)return s._logger.log("warn","write file:"+i+" error:"+e.message),void(r&&r(e));require("x.hub.deviceman.js").deviceManager.reload(function(e){if(e)return s._logger.log("warn","reload device error:"+e.message),void(r&&r(e));require("x.hub.macroman.js").macroManager.reload(function(e){e&&s._logger.log("warn","reload macro error:"+e.message),r&&r(e);});});});},SM.prototype.writeFile2=function(e,n,r,t){var a=this._tenant2.getFolderPath(),o=require("path"),i=require("fs-extra"),s=a+o.sep+e,u=this;i.writeFile(s,n,function(n){if(n)return u._logger.log("warn","write file:"+s+" error:"+n.message),void(t&&t(n));"device_db"==e&&u._encryptDeviceDBFileSync(s),require("x.hub.deviceman.js").deviceManager2.reload(function(n){if(n)return u._logger.log("warn","reload device error:"+n.message),void(t&&t(n));require("x.hub.macroman.js").macroManager2.reload(function(n){(n&&u._logger.log("warn","reload macro error:"+n.message),r&&"device_db"==e)&&(localStorage.setItem("x.hub.m.gateway.DB2NeoIdx",r),require("x.hub.m.gateway.js").updateGatewayNeoIndex());t&&t(n);});});});},SM.prototype._generateTenantParent=function(e){return{fileManager:e,getFolderPath:function getFolderPath(){return this.fileManager.getUserRootDataPath();},getFolder:function getFolder(){return"";}};},SM;}(),x.hub.hubsyncman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.hubsyncman.Handler"),this.syncManager=new x.hub.hubsyncman.SyncManager();};return Handler.prototype.SyncManager=x.hub.hubsyncman.SyncManager,Handler.prototype.init=function(e,n,r){"CA"==global.HARDWARE_VERSION?this._configNew(e):this._config(e),this.syncManager.init(n,r);},Handler.prototype._configNew=function(e){var n=this,r=require("x.hub.js").getServer();r.addRoute("/xhub/xhubsync/upload2",{method:"POST"},function(e,r){var t=e.query.fileName;if(t){var a=e.query.gatewayid;n.syncManager.writeFile2(t,e.body,a,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")));}),r.addRoute("/xhub/xhubsync/deploy2",{method:"POST",source:1,body:"stream"},function(e,r){var t=e.query.userid;if(t){var a=e.query.appid,o=e.query.gatewayid;n.syncManager.deploy2(e,t,a,o,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")));}),r.addRoute("/xhub/xhubsync/upload",{method:"POST"},function(e,r){var t=e.query.fileName;t?n.syncManager.writeFile(t,e.body,function(e){r.send(n._toRestfulResponse(e,"ok"));}):r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")));}),r.addRoute("/xhub/xhubsync/deploy",{method:"POST",source:1,body:"stream"},function(e,r){var t=e.query.userid;if(t){var a=e.query.appid,o=e.query.gatewayid;n.syncManager.deploy(e,t,a,o,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")));});},Handler.prototype._config=function(e){var n=this,r=require("body-parser");e.use("/xhub/xhubsync/",function(e,n,r){var t=require("x.hub.js").server,a=!0;if(t._pwd&&t._pwd.length>0){if(a=!1,!e.query.at&&e.query.auth){var o=require("x.crypt.js");e.query.at=o.MD5(unescape(encodeURI(e.query.auth+"_SALT!")));}e.query.at&&e.query.at==t._pwd&&(a=!0);}a?r():n.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}');}),e.use("/xhub/xhubsync/upload",r.text({limit:"50mb"})),e.post("/xhub/xhubsync/upload",function(e,r){var t=e.query.fileName;t?n.syncManager.writeFile(t,e.body,function(e){r.send(n._toRestfulResponse(e,"ok"));}):r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")));}.bind(this)),e.post("/xhub/xhubsync/deploy",function(e,r){var t=e.query.userid;if(t){var a=e.query.appid,o=e.query.gatewayid;this.syncManager.deploy(e,t,a,o,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")));}.bind(this)),e.use("/xhub/xhubsync/upload2",r.text({limit:"50mb"})),e.post("/xhub/xhubsync/upload2",function(e,r){var t=e.query.fileName;if(t){var a=e.query.gatewayid;n.syncManager.writeFile2(t,e.body,a,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no file name")));}.bind(this)),e.post("/xhub/xhubsync/deploy2",function(e,r){var t=e.query.userid;if(t){var a=e.query.appid,o=e.query.gatewayid;this.syncManager.deploy2(e,t,a,o,function(e){r.send(n._toRestfulResponse(e,"ok"));});}else r.send(n._toRestfulResponse(new x.hub.hubsyncman.Error("no userid")));}.bind(this));},Handler.prototype._toRestfulResponse=function(e,n){return e?{status:"fail",message:e.message,code:e.code?e.code:0}:{status:"success",data:n};},Handler;}(),module.exports=new x.hub.hubsyncman.Handler();