var x=x||{};x.upnp=x.upnp||{},x.upnp._DeviceCache={_cache:{},setDescLoaded:function setDescLoaded(t,e){this._cache[t]||(this._cache[t]={}),this._cache[t].loaded=e;},addTarget:function addTarget(t,e){this._cache[t]&&(this._cache[t].targets||(this._cache[t].targets=[]),-1==this._cache[t].targets.indexOf(e)&&this._cache[t].targets.push(e));},putDevice:function putDevice(t,e,r){this._cache[t]||(this._cache[t]={loaded:!0}),this._cache[t].device=e,this.addTarget(t,r);},getDevice:function getDevice(t){var e=t?this._cache[t]:null;return e?e.device:null;},getDeviceCache:function getDeviceCache(t){return t?this._cache[t]:null;},removeDevices:function removeDevices(t){for(var e=0;e<t.length;e++){delete this._cache[t[e]];}},getDevices:function getDevices(){return this._cache;},getDevicesWithTarget:function getDevicesWithTarget(t){var e=[];for(var r in this._cache){if(this._cache.hasOwnProperty(r)){var n=this._cache[r];n.targets&&-1!=n.targets.indexOf(t)&&n.device&&e.push(n.device);}}return e;},removeDevicesWithTarget:function removeDevicesWithTarget(t){var e={};for(var r in this._cache){var n=!1,i=this._cache[r];i.targets&&-1!=i.targets.indexOf(t)&&i.device&&(n=!0),n||(e[r]=i);}this._cache=e;}},x.upnp._SSDPCache={_cache:{},putSSDP:function putSSDP(t,e){if(t&&e){var r=e.getUUID();if(r){var n=e.getMaxAge(),i=Math.round(new Date().getTime()/1e3);this._cache[r]={ip:t,expire:i+n,location:e.location};}}},removeExpired:function removeExpired(){var t=[],e=Math.round(new Date().getTime()/1e3);for(var r in this._cache){if(this._cache.hasOwnProperty(r)){var n=this._cache[r].expire;(-1==n||e>n)&&t.push(r);}}x.upnp._DeviceCache.removeDevices(t);for(var i=0;i<t.length;i++){delete this._cache[t[i]];}}},x.upnp.SSDP=function(){var SSDP=function SSDP(){this._usnObj=null;};return SSDP.prototype.getUUID=function(){return this._usnObj?this._usnObj.uuid:null;},SSDP.prototype.getMaxAge=function(){if(!this["cache-control"])return-1;var t=this["cache-control"];t=(t=t.replace("max-age","")).replace("=","");var e=parseInt(t.trim());return e=parseInt(e),isNaN(e)?-1:e;},SSDP.resolve=function(t){if(!t)return null;var e=t.split("\n"),r=new SSDP();switch(e[0].trim()){case"HTTP/1.1 200 OK":r.type="RESULT";break;case"NOTIFY * HTTP/1.1":r.type="NOTIFY";break;case"M-SEARCH * HTTP/1.1":r.type="M-SEARCH";break;default:return null;}for(var n=1;n<e.length&&"\r"!=e[n];n++){var i=e[n].trim(),s=i.indexOf(":");if(-1!=s){var o=i.substr(0,s),a=i.substr(s+1);o&&(r[o.toLowerCase()]=a.trim());}}return r.usn?(r._usnObj=x.upnp.Util.parseUSN(r.usn),r):null;},SSDP;}(),x.upnp.UDPListener=function(){var Listener=function Listener(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("x.upnp.UDPListener"):this._logger={log:{}},this._callbacks=[],this._sockets=[];var t=require("os");require("dgram");if(t&&t.networkInterfaces){var e=t.networkInterfaces();for(var r in e){for(var n=e[r],i=0;i<n.length;i++){this._addDiscoverSocket(n[i]);}}}else this._addDiscoverSocket(null);};return Listener.prototype._addDiscoverSocket=function(t){var e,r=require("dgram"),n=this;t?"IPv4"==t.family&&0==t.internal&&((e=r.createSocket("udp4")).bind(null,t.address),e.on("message",function(t,e){n._onResponse(t,e);}),this._sockets.push(e)):((e=r.createSocket("udp4")).on("message",function(t,e){n._onResponse(t,e);}),this._sockets.push(e));},Listener.prototype.addCallback=function(t){t&&-1==this._callbacks.indexOf(t)&&this._callbacks.push(t);},Listener.prototype.removeCallback=function(t){if(t){var e=this._callbacks.indexOf(t);-1!=e&&this._callbacks.splice(e,1);}},Listener.prototype.sendMessage=function(t,e,r){for(var n=new Buffer(t),i=0;i<this._sockets.length;i++){this._sockets[i].send(n,0,n.length,r,e);}},Listener.prototype._onResponse=function(t,e){var r=t.toString();this._logger.log("trace","receive ssdp from: "+(e?e.address:"unknown address"));var n=x.upnp.SSDP.resolve(r);n&&(this._logger.log("trace","usn:"+(n.usn?n.usn:"")+" location:"+(n.location?n.location:"")),x.upnp._SSDPCache.putSSDP(e.address,n),this._callbacks.forEach(function(t){t&&t(e.address,n);}));},Listener;}(),x.upnp.DescLoader=function(){var Loader=function Loader(t,e){this.ip=t,this.port=80,this.uuid=e,this.name=null,this.type=null,this.subtype=null,"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("x.upnp.DescLoader"):this._logger={log:{}};};return Loader.prototype.load=function(t,e){if("string"==typeof t){var r=null;try{r=require("url").parse(t);}catch(t){return void(e&&e(t));}r.port&&(this.port=r.port);var n=this;this._loadDeviceDesc2(t,function(t,r){if(t)e&&e(t);else{var i=n._parseDesc(r);i?e&&e(null,i):e&&e(new Error("device desc parse error"));}});}else e&&e(new Error('Provided "url" argument is not a string.'));},Loader.prototype._loadDeviceDesc=function(t,e){var r=this;this._logger.log("trace","load device description from URL: "+t);var n=e;$.ajax({url:t,type:"get",timeout:5e3,dataType:"text",cache:!0,success:function success(e){r._logger.log("trace","http request success for: "+t),n&&(n(null,e),n=null);},error:function error(t,e){var i="http request error:"+(t?t.status:"0")+"-"+e;r._logger.log("trace",i),n&&(n(new Error(i)),n=null);}});},Loader.prototype._loadDeviceDesc2=function(t,e){this._logger.log("trace","load device description from URL: "+t);var r=require("url").parse(t),n={host:r.hostname,port:r.port,path:r.path,method:"GET"},i=this,s="",o=require("http"),a=e;try{var u=o.request(n,function(e){e.on("data",function(t){s+=t;}),e.on("end",function(){if(200==e.statusCode)i._logger.log("trace","http request success for: "+t),a&&a(null,s);else{var r="http request error: "+e.statusCode+"-"+s;i._logger.log("trace",r),a&&a(new Error(r));}a=null;});});u.setTimeout&&u.setTimeout(2e3,function(){u.abort();}),u.on&&"function"==typeof u.on&&u.on("error",function(t){t||(t=new Error("http request error")),a&&a(t),a=null;}),u.end();}catch(t){a&&a(t),a=null;}},Loader.prototype._parseDesc=function(t){-1!=t.indexOf('xmlns:ms=" urn:microsoft-com:wmc-1-0"')&&(t=t.replace('xmlns:ms=" urn:microsoft-com:wmc-1-0"','xmlns:ms="urn:microsoft-com:wmc-1-0"'));var e=null;try{e=$($.parseXML(t));}catch(t){}if(!e)return null;var r=e.find("device");if(!r||0==r.length)return null;var n=$(r[0]),i=this._parseDescXml(n);if(!i)return null;i.embeddedDevices=[];var s=this;return e.find("deviceList device").each(function(){var t=$(this),e=s._parseDescXml(t);e&&i.embeddedDevices.push(e);}),i;},Loader.prototype._parseDescXml=function(t){if(!t)return null;var e=null,r=t.find("friendlyName");if(r.length>0){this.name=$(r[0]).text();var _t=String(this.name).toLowerCase();_t.startsWith("wemo switch")||_t.startsWith("wemo insight")?(this.type="wemo",_t.startsWith("wemo insight")&&(this.subtype="insight")):_t.includes("sonos")&&(this.type="sonos");}if(r=t.find("deviceType"),r&&r.length>0&&(this.deviceType=$(r[0]).text()),r=t.find("manufacturer"),r&&r.length>0&&(this.manufacturer=$(r[0]).text()),r=t.find("modelName"),r&&r.length>0){this.modelName=$(r[0]).text();var _t2=String(this.modelName).toLowerCase();_t2.startsWith("philips hue bridge")?this.type="hue":_t2.startsWith("sonos")&&(this.type="sonos");}if(r=t.find("modelDescription"),r&&r.length>0&&(this.modelDescription=$(r[0]).text()),r=t.find("serialNumber"),r&&r.length>0&&(this.serialNumber=$(r[0]).text()),r=t.find("UDN"),r.length>0&&(e=$(r[0]).text()),r=t.find("X_DLNACAP"),r.length>0&&(this.X_DLNACAP=$(r[0]).text()),!this.name||!this.deviceType||!e)return null;e.length>6&&"uuid:"===e.substr(0,5)&&!this.uuid&&(this.uuid=e.substr(5));var n=x.upnp.Util.parseURN(this.deviceType);if(!n)return null;var i=null;return n.device&&"MediaServer"===n.device.type?i=this.parseServer(t):n.device&&"MediaRenderer"===n.device.type?i=this.parseRenderer(t):(i=new x.upnp.Device()).init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),i;},Loader.prototype.parseServer=function(t){var e=null,r=null;if(t.find("serviceList service").each(function(){var t=$(this),n=t.find("serviceType"),i=t.find("controlURL");n.length>0&&i.length>0&&(n=$(n[0]).text(),(i=$(i[0]).text())&&"/"==i.charAt(0)||(i="/"+i),-1!=n.indexOf("ContentDirectory")?e={type:n,url:i}:"urn:schemas-upnp-org:service:ConnectionManager:1"!=n&&"urn:schemas-upnp-org:service:ConnectionManager:2"!=n||(r={type:n,url:i}));}),e&&r){var n=new x.upnp.MediaServer();return n.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),n.contentDirectory=e,n.connectionManager=r,n;}return null;},Loader.prototype.parseRenderer=function(t){var e=null,r=null,n=null,i=null,s=null;if(t.find("serviceList service").each(function(){var t=$(this),o=t.find("serviceType"),a=t.find("controlURL");o.length>0&&a.length>0&&(o=$(o[0]).text(),(a=$(a[0]).text())&&"/"==a.charAt(0)||(a="/"+a),-1!=o.indexOf("GroupRenderingControl")?i={type:o,url:a}:-1!=o.indexOf("RenderingControl")?e={type:o,url:a}:-1!=o.indexOf("ConnectionManager")?r={type:o,url:a}:-1!=o.indexOf("AVTransport")?n={type:o,url:a}:-1!=o.indexOf("Queue")&&(s={type:o,url:a}));}),e&&n){var o=new x.upnp.MediaRenderer();return o.init(this.ip,this.port,this.uuid,{name:this.name,type:this.type,subtype:this.subtype,modelName:this.modelName,manufacturer:this.manufacturer,modelDescription:this.modelDescription,deviceType:this.deviceType,dlnaCap:this.X_DLNACAP,serialNumber:this.serialNumber}),o.renderingControl=e,o.connectionManager=r,o.avTransport=n,o.groupRenderingControl=i,o.queue=s,o;}return null;},Loader;}(),x.upnp.DiscoveryService=function(){var Service=function Service(t){this._udpListener=t,this._callbacks={},this._autoSearchITV=null;var e=this;this._udpListener.addCallback(function(t,r){e._onReceiveSSDP(t,r);});};return Service.prototype.M_SEARCH='M-SEARCH * HTTP/1.1\r\nHost: 239.255.255.250:1900\r\nMan: "ssdp:discover"\r\nMX: 5\r\n',Service.prototype._findDevice=function(t,e){e&&this._callbacks["ssdp:all"]&&this._callbacks["ssdp:all"].forEach(function(t){t&&t(e);}),e&&this._callbacks[t]&&this._callbacks[t].forEach(function(t){t&&t(e);});},Service.prototype.addCallback=function(t,e){t||(t="upnp:rootdevice"),this._callbacks[t]||(this._callbacks[t]=[]),e&&-1==this._callbacks[t].indexOf(e)&&this._callbacks[t].push(e);},Service.prototype.removeCallback=function(t,e){if(t||(t="upnp:rootdevice"),this._callbacks[t]&&e){var r=this._callbacks[t].indexOf(e);-1!=r&&this._callbacks[t].splice(r,1);}},Service.prototype.startAutoSearch=function(){if(!this._autoSearchITV){var t=this;this._autoSearchITV=setInterval(function(){t.discoverTarget("upnp:rootdevice");},3e4),this.discoverTarget("upnp:rootdevice");}},Service.prototype.stopAutoSearch=function(){this._autoSearchITV&&(clearInterval(this._autoSearchITV),this._autoSearchITV=null);},Service.prototype.discoverWithTimeout=function(t,e){this.discoverTargetWithTimeout("upnp:rootdevice",t,e);},Service.prototype.discoverTargetWithTimeout=function(t,e,r){var cb=function cb(t){t&&cb.devices.push(t);};cb.devices=[],this.addCallback(t,cb);var n=this;this.discoverTarget(t),setTimeout(function(){n.removeCallback(t,cb),r&&r(cb.devices);},e);},Service.prototype.discoverTarget=function(t){x.upnp._SSDPCache.removeExpired(),x.upnp._DeviceCache.removeDevicesWithTarget(t);var e=this.M_SEARCH+"ST: "+t+"\r\n\r\n";this._udpListener.sendMessage(e,"239.255.255.250",1900);},Service.prototype._onReceiveSSDP=function(t,e){if("RESULT"==e.type){var r=e.getUUID(),n=e.st,i=x.upnp._DeviceCache.getDeviceCache(r);if(i&&i.device)return void(i.targets&&-1!=i.targets.indexOf(n)||(x.upnp._DeviceCache.addTarget(r,n),this._findDevice(n,i.device)));if(!i||!i.loaded){var s=this;x.upnp._DeviceCache.setDescLoaded(r,!0),new x.upnp.DescLoader(t,r).load(e.location,function(t,e){t||!e?x.upnp._DeviceCache.setDescLoaded(r,!1):(x.upnp._DeviceCache.putDevice(r,e,n),s._findDevice(n,e));});}}},Service;}(),x.upnp.Util={parseUSN:function parseUSN(t){if(!t||t.length<=5||"uuid:"!=t.substr(0,5))return null;var e={},r=t.indexOf("::",5);if(5==r)return null;if(-1==r)return e.uuid=t.substr(5),e;e.uuid=t.substring(5,r);var n=t.substr(r+2);return n&&(e.urn=this.parseURN(n)),e;},parseURN:function parseURN(t){if(!t)return null;if("upnp:rootdevice"==t.substr(0,15))return{domain:"upnp",device:{type:"rootdevice"}};if("urn:"==t.substr(0,4)){var e=null;if(t=t.substr(4)){var r=t.split(":");r[0]&&(e={domain:r[0]},"device"==r[1]&&r[2]&&r[3]?e.device={type:r[2],ver:r[3]}:"service"==r[1]&&r[2]&&r[3]&&(e.service={type:r[2],ver:r[3]}));}return e;}return null;},findTag:function findTag(t,e,r){var n=t.find(e);return n&&n.length>0?n:r?(n=t.find(r+"\\:"+e))&&n.length>0?n:n=this._iterateTag(t,e,r):[];},_iterateTag:function _iterateTag(t,e,r){var n=[],i=t.prop("tagName");i&&(i!=e&&i!=r+":"+e||n.push(t));var s=t.children();if(s&&s.length>0)for(var o=0;o<s.length;o++){var a=s[o],u=this._iterateTag($(a),e,r);u&&u.length>0&&(n=n.concat(u));}return n;}},x.upnp.SOAPClient=function(){var Client=function Client(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("x.upnp.SOAPClient"):this._logger={log:{}};};return Client.prototype._getSOAPMessage=function(t){var e='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"><s:Body>';return e+=t,e+="</s:Body>\n</s:Envelope>";},Client.prototype.doRequest=function(t,e,r,n){var i=this._getSOAPMessage(r),s=require("url").parse(t),o={host:s.hostname,port:s.port,path:s.path,method:"POST",headers:{"Content-Type":'text/xml; charset="utf-8"',"Content-Length":i.length,SOAPACTION:e,"User-Agent":"",Connection:"close"}},a=this,u=require("http");o.port||(o.port=80),"https"==s.protocol&&(u=require("https"),"undefined"!=typeof process&&process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),o.port||(o.port=443)),this._logger.log("trace","send post to url:"+t),this._logger.log("trace","with headers:"+JSON.stringify(o.headers)),this._logger.log("trace","with data:"+i);var c=n,p=u.request(o,function(t){var e="";t.setEncoding("utf8"),t.on("data",function(t){e+=t;}),t.on("end",function(){var r;a._logger.log("trace","http reponse status code:"+t.statusCode),a._logger.log("trace","http reponse:"+e),200!=t.statusCode&&(r=new Error("http reponse status code:"+t.statusCode)),c&&c(r,e,t.statusCode),c=null;});});p.setTimeout&&p.setTimeout(2e4,function(){p.abort();}),p.on&&"function"==typeof p.on&&p.on("error",function(t){t||(t=new Error("soap request error")),a._logger.log("trace","soap request error:"+t.message),c&&c(t),c=null;}),p.write(i),p.end();},Client;}(),x.upnp.Device=function(){var Device=function Device(){this.ip=null,this.port=null,this.uuid=null,this.name=null,this.type=null,this.subtype=null,this.deviceType=null,this.modelName=null,this.manufacturer=null,this.modelDescription=null,this.serialNumber=null;};return Device.prototype.init=function(t,e,r,n){for(var i in this.ip=t,this.port=e,this.uuid=r,n){n.hasOwnProperty(i)&&(this[i]=n[i]);}},Device.prototype._parseItemMetaData=function(t){var e=null,r=null,n=null,i=t.find("container");i&&i[0]&&(n=(r=$(i[0])).getAttributes(),e=JSON.parse(JSON.stringify(n)));var s=t.find("item");if(s&&s[0]&&(n=(r=$(s[0])).getAttributes(),e=JSON.parse(JSON.stringify(n))),r)for(var o=r.children(),a=0;a<o.length;a++){var u=$(o[a]);if(u){var c=u.prop("tagName"),p=c.indexOf(":");-1!=p&&(c=c.substr(p+1)),e[c]=u.text();}}return e;},Device.prototype._maskMetaData=function(t){return t=(t=(t=(t=(t=(t=(t=t.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/'/g,"&apos;")).replace(/\r/g,"")).replace(/\n/g,"")).replace(/\t/g,"");},Device.prototype._unmaskMetaData=function(t){return t?t=(t=(t=(t=(t=t.replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&amp;/g,"&")).replace(/&quot;/g,'"')).replace(/&apos;/g,"'"):t;},Device.prototype._parseSOAPResponse=function(t,e){if(!t)return null;var r;try{r=$($.parseXML(t));}catch(t){return null;}if(!r)return null;try{var n=x.upnp.Util.findTag(r,e,"u");return n&&n.length>0?$(n[0]):null;}catch(t){return null;}},Device.prototype.getURL=function(t){var e="http://"+this.ip;return this.port&&80!=this.port&&(e+=":"+this.port),e+t;},Device.prototype._getDuration=function(t){var e=t.split(":");return 3==e.length&&(t=60*parseInt(e[0])*60+60*parseInt(e[1])+parseInt(e[2])),t;},Device.prototype._doSOAPRequest=function(t,e,r,n,i){var s="<u:"+r+' xmlns:u="'+e+'">';for(var o in n){if(n.hasOwnProperty(o)){var a=n[o]+"";s+="<"+o+">"+(a?this._maskMetaData(a):"")+"</"+o+">";}}s+="</u:"+r+">";var u='"'+e+"#"+r+'"',c=this;this._doRequest(t,u,s,function(t,e,n){if(t)i&&i(t);else if(200==n){var s=c._parseSOAPResponse(e,r+"Response");s?i&&i(null,s):i&&i(new Error(r+" reponse format invalid"));}else i&&i(new Error("http response code:"+n));});},Device.prototype._doRequest=function(t,e,r,n){new x.upnp.SOAPClient().doRequest(t,e,r,function(t,e,r){n&&n(null,e,r);});},Device;}(),x.upnp.MediaServer=function(){var Server=function Server(){this.contentDirectory=null,this.connectionManager=null;};return(Server.prototype=new x.upnp.Device()).constructor=Server,Server.prototype.search=function(t,e,r,n){var i=this;e||(e="dc:title,upnp:artist,upnp:album,upnp:albumArtURI,res,res@protocolInfo,res@duration,res@resolution,res@size");var s='<u:Search xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1">';s+="<ContainerID>0</ContainerID>",s+="<SearchCriteria>"+t+"</SearchCriteria>",s+="<Filter>"+e+"</Filter>",s+="<StartingIndex>"+r+"</StartingIndex>",s+="<RequestedCount>"+this.chunkSize+"</RequestedCount>",s+="<SortCriteria></SortCriteria>",s+="</u:Search>",new XCUPNPSOAPRequest().doRequest(this.getURL(this.contentDirectory),'"urn:schemas-upnp-org:service:ContentDirectory:1#Search"',s,function(s){if(s=i._parseSOAPResponse(s,!0)){var o=0,a=[];try{var u=$($.parseXML(s));a=i._getItems(u),o=$(u.children()[0]).children().length;}catch(t){}o==i.chunkSize?(setTimeout(function(){i.search(t,e,r+i.chunkSize,n);},0),n(a,!1)):n(a,!0);}});},Server.prototype.browseMetaData=function(t,e){this._browseMetaData(t,function(t,r){t?e&&e(t):r&&r?e&&e(t,r):e&&e(new Error("meta data invalid"));});},Server.prototype.browseChildren=function(t,e,r,n,i){this._browseChildren(t,"*",e,r,null,function(t,e){if(t)i&&i(t);else if(e&&e.result){for(var r=[],s=0;s<e.result.length;s++){var o=e.result[s];n&&o["class"]?("object.container"==o["class"]||-1!=n.indexOf(o["class"]))&&r.push(o):r.push(o);}i&&i(null,r,e.totalMatches);}else i&&i(null,[],0);});},Server.prototype._getRes=function(t){var e=null,r=0;return t.find("res").each(function(){var t=$(this),n=t.attr("size");(!e||n&&n>r)&&(e=t,r=n);}),e;},Server.prototype._getItems=function(t){var e=[],r=this;return t.find("container").each(function(){var t=$(this),n=x.upnp.Util.findTag(t,"title","dc"),i=x.upnp.Util.findTag(t,"class","upnp");if(i.length>0&&n.length>0){var s=$(i[0]).text(),o=$(n[0]).text(),a={type:"container","class":s,parentID:t.attr("parentID"),id:t.attr("id"),title:o},u=r._getRes(t);if(u){var c=u.text(),p=null;u.attr("duration")&&(p=r._getDuration(u.attr("duration"))),a.res={url:c,dur:p};}var l=x.upnp.Util.findTag(t,"albumArtURI","upnp");l.length>0&&(a.albumArtURI=$(l[0]).text()),e.push(a);}}),t.find("item").each(function(){var t=$(this),n=x.upnp.Util.findTag(t,"class","upnp"),i=x.upnp.Util.findTag(t,"title","dc");if(n.length>0&&i.length>0){var s=$(n[0]).text(),o=$(i[0]).text(),a={type:"item",parentID:t.attr("parentID"),id:t.attr("id"),"class":s,title:o},u=r._getRes(t,s);if(u){var c=u.text(),p=null;u.attr("duration")&&(p=r._getDuration(u.attr("duration"))),a.res={url:c,dur:p};}if(0==s.indexOf("object.item.audioItem")){a.info={};var l=x.upnp.Util.findTag(t,"genre","upnp");l.length>0&&(a.info.genre=$(l[0]).text());var h=x.upnp.Util.findTag(t,"artist","upnp");h.length>0&&(a.info.artist=$(h[0]).text());var d=x.upnp.Util.findTag(t,"album","upnp");d.length>0&&(a.info.album=$(d[0]).text()),(d=x.upnp.Util.findTag(t,"albumArtURI","upnp")).length>0&&(a.info.albumArtURI=$(d[0]).text());}e.push(a);}}),e;},Server.prototype._browseMetaData=function(t,e){var r=this;this._browse(t,"BrowseMetadata","*",0,0,null,function(t,n){if(t)e&&e(t);else{if(n.result)try{var i=$($.parseXML(n.result));n.meta=r._parseItemMetaData(i);}catch(t){return void(e&&e(t));}e(null,n);}});},Server.prototype._browseChildren=function(t,e,r,n,i,s){var o=this;this._browse(t,"BrowseDirectChildren",e,r,n,i,function(t,e){if(t)s&&s(t);else{if(e.result)try{var r=$($.parseXML(e.result));e.result=o._getItems(r);}catch(t){return void(s&&s(t));}s(null,e);}});},Server.prototype._browse=function(t,e,r,n,i,s,o){e||(e="BrowseDirectChildren"),r||(r=""),s||(s="");var a={ObjectID:t,BrowseFlag:e,Filter:r,StartingIndex:n,RequestedCount:i,SortCriteria:s};this._doSOAPRequest(this.getURL(this.contentDirectory.url),this.contentDirectory.type,"Browse",a,function(t,e){if(t)o&&o(t);else{var r={},n=e.find("Result");n&&n.length>0&&(r.result=$(n[0]).text()),(n=e.find("NumberReturned"))&&n.length>0&&(r.numberReturned=$(n[0]).text()),(n=e.find("TotalMatches"))&&n.length>0&&(r.totalMatches=$(n[0]).text()),(n=e.find("UpdateID"))&&n.length>0&&(r.updateID=$(n[0]).text()),o&&o(null,r);}});},Server;}(),x.upnp.MediaRenderer=function(){var Renderer=function Renderer(){this.renderingControl=null,this.connectionManager=null,this.avTransport=null;};return(Renderer.prototype=new x.upnp.Device()).constructor=Renderer,Renderer.prototype.PLAY_MODE=["NORMAL","SHUFFLE","REPEAT_ONE","REPEAT_ALL","RANDOM","DIRECT_1","INTRO"],Renderer.prototype.TRANSPORT_STATE=["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"],Renderer.prototype.getPlayState=function(t){this.getPlayState_cbs||(this.getPlayState_cbs=[]);var e=this.getPlayState_cbs.length;if(t&&-1==this.getPlayState_cbs.indexOf(t)&&this.getPlayState_cbs.push(t),0==e){var r=this,cb=function cb(t,e){var n=r.getPlayState_cbs;r.getPlayState_cbs=[],n.forEach(function(r){r&&r(t,e);});};this._getTransportInfo(0,function(t,e){cb&&cb(t,e?e.currentTransportState:null);});}},Renderer.prototype.getPlayInfo=function(t){this.getPlayInfo_cbs||(this.getPlayInfo_cbs=[]);var e=this.getPlayInfo_cbs.length;if(t&&-1==this.getPlayInfo_cbs.indexOf(t)&&this.getPlayInfo_cbs.push(t),0==e){var cb=function cb(t,e){var n=r.getPlayInfo_cbs;r.getPlayInfo_cbs=[],n.forEach(function(r){r&&r(t,e);});},r=this;this._getPositionInfo(0,function(t,e){if(t)cb&&cb(t);else{var n={};e.trackDuration&&(n.duration=e.trackDuration,n.durationSec=r._getDuration(e.trackDuration)),e.relTime&&(n.position=e.relTime,n.positionSec=r._getDuration(e.relTime)),n.trackMetaDataRaw=e.trackMetaDataRaw,n.trackMetaData=e.trackMetaData,cb&&cb(null,n);}});}},Renderer.prototype.getMediaInfo=function(t){this.getMediaInfo_cbs||(this.getMediaInfo_cbs=[]);var e=this.getMediaInfo_cbs.length;if(t&&-1==this.getMediaInfo_cbs.indexOf(t)&&this.getMediaInfo_cbs.push(t),0==e){var cb=function cb(t,e){var n=r.getMediaInfo_cbs;r.getMediaInfo_cbs=[],n.forEach(function(r){r&&r(t,e);});},r=this;this._getMediaInfo(0,function(t,e){cb&&cb(t,e);});}},Renderer.prototype.getPlayMode=function(t){this.getPlayMode_cbs||(this.getPlayMode_cbs=[]);var e=this.getPlayMode_cbs.length;if(t&&-1==this.getPlayMode_cbs.indexOf(t)&&this.getPlayMode_cbs.push(t),0==e){var cb=function cb(t,e){var n=r.getPlayMode_cbs;r.getPlayMode_cbs=[],n.forEach(function(r){r&&r(t,e);});},r=this;this._getTransportSettings(0,function(t,e){cb&&cb(t,e?e.playMode:null);});}},Renderer.prototype.playResource=function(t,e,r){var n=this;this._setAVTransportURI(0,t.url,e,function(t){t?r&&r(t):n.play(r);});},Renderer.prototype.playContainer=function(t,e,r){var n="dlna-playcontainer://"+encodeURIComponent("uuid:"+t.server_uuid)+"?sid="+encodeURIComponent("urn:upnp-org:serviceId:ContentDirectory")+"&cid="+encodeURIComponent(t.containerID)+"&md=0";void 0!==t.firstIdx&&null!=t.firstIdx&&(n+="&fii="+t.firstIdx);var i=this;this._setAVTransportURI(0,n,e,function(t){t?r&&r(t):i.play(r);});},Renderer.prototype.play=function(t){this._play(0,1,t);},Renderer.prototype.pause=function(t){this._pause(0,t);},Renderer.prototype.stop=function(t){this._stop(0,t);},Renderer.prototype.previous=function(t){this._previous(0,1,t);},Renderer.prototype.next=function(t){this._next(0,1,t);},Renderer.prototype.seekRelTime=function(t,e){this._seek(0,"REL_TIME",t,e);},Renderer.prototype.seekRelTimeSec=function(t,e){var r=t%60,n=(t-r)/60%60,i=(t-r-60*n)/3600;for(r+="";r.length<2;){r="0"+r;}for(n+="";n.length<2;){n="0"+n;}for(i+="";i.length<2;){i="0"+i;}this._seek(0,"REL_TIME",i+":"+n+":"+r,e);},Renderer.prototype.seekTrack=function(t,e){this._seek(0,"TRACK_NR",t,e);},Renderer.prototype.setPlayMode=function(t,e){this._setPlayMode(0,t,e);},Renderer.prototype.mute=function(t){this._setMute(0,"Master",1,t);},Renderer.prototype.unmute=function(t){this._setMute(0,"Master",0,t);},Renderer.prototype.toggleMute=function(t){var e=this;this.isMuted(function(r,n){r?t&&t(r):n?e.unmute(t):e.mute(t);});},Renderer.prototype.isMuted=function(t){this.isMuted_cbs||(this.isMuted_cbs=[]);var e=this.isMuted_cbs.length;if(t&&-1==this.isMuted_cbs.indexOf(t)&&this.isMuted_cbs.push(t),0==e){var cb=function cb(t,e){var n=r.isMuted_cbs;r.isMuted_cbs=[],n.forEach(function(r){r&&r(t,e);});},r=this;this._getMute(0,"Master",function(t,e){t?cb&&cb(t):cb&&cb(null,"1"==e.mute);});}},Renderer.prototype.setVolume=function(t,e){(t=parseInt(t))<0&&(t=0),t>100&&(t=100),this._setVolume(0,"Master",t,e);},Renderer.prototype.volumeUp=function(t){var e=this;this.getVolume(function(r,n){r||100==n?t&&t(r):(n+=5,e.setVolume(n,t));});},Renderer.prototype.volumeDown=function(t){var e=this;this.getVolume(function(r,n){r||0==n?t&&t(r):(n-=5,e.setVolume(n,t));});},Renderer.prototype.getVolume=function(t){this.getVolume_cbs||(this.getVolume_cbs=[]);var e=this.getVolume_cbs.length;if(t&&-1==this.getVolume_cbs.indexOf(t)&&this.getVolume_cbs.push(t),0==e){var cb=function cb(t,e){var n=r.getVolume_cbs;r.getVolume_cbs=[],n.forEach(function(r){r&&r(t,e);});},r=this;this._getVolume(0,"Master",function(t,e){t?cb&&cb(t):cb&&cb(null,parseInt(e.volume));});}},Renderer.prototype._setAVTransportURI=function(t,e,r,n){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetAVTransportURI",{InstanceID:t,CurrentURI:e,CurrentURIMetaData:r},n);},Renderer.prototype._seek=function(t,e,r,n){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Seek",{InstanceID:t,Unit:e,Target:r},n);},Renderer.prototype._play=function(t,e,r){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Play",{InstanceID:t,Speed:e},r);},Renderer.prototype._pause=function(t,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Pause",{InstanceID:t},e);},Renderer.prototype._stop=function(t,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Stop",{InstanceID:t},e);},Renderer.prototype._previous=function(t,e,r){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Previous",{InstanceID:t,Speed:e},r);},Renderer.prototype._next=function(t,e,r){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"Next",{InstanceID:t,Speed:e},r);},Renderer.prototype._setPlayMode=function(t,e,r){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"SetPlayMode",{InstanceID:t,NewPlayMode:e},r);},Renderer.prototype._getTransportInfo=function(t,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportInfo",{InstanceID:t},function(t,r){if(t)e&&e(t);else{var n={},i=r.find("CurrentTransportState");i.length>0&&(n.currentTransportState=$(i[0]).text()),(i=r.find("CurrentTransportStatus")).length>0&&(n.currentTransportStatus=$(i[0]).text()),(i=r.find("CurrentSpeed")).length>0&&(n.currentSpeed=$(i[0]).text()),e&&e(null,n);}});},Renderer.prototype._getPositionInfo=function(t,e){var r=this;this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetPositionInfo",{InstanceID:t},function(t,n){if(t)e&&e(t);else{var i={},s=n.find("Track");if(s.length>0&&(i.track=$(s[0]).text()),(s=n.find("TrackDuration")).length>0&&(i.trackDuration=$(s[0]).text()),(s=n.find("TrackMetaData")).length>0){var o=$(s[0]).text();if(o)try{var a=$($.parseXML(o));i.trackMetaDataRaw=a,i.trackMetaData=r._parseItemMetaData(a);}catch(t){return void(e&&e(t));}else i.trackMetaDataRaw="",i.trackMetaData=null;}(s=n.find("TrackURI")).length>0&&(i.trackURI=$(s[0]).text()),(s=n.find("RelTime")).length>0&&(i.relTime=$(s[0]).text()),(s=n.find("AbsTime")).length>0&&(i.absTime=$(s[0]).text()),(s=n.find("RelCount")).length>0&&(i.relCount=$(s[0]).text()),(s=n.find("AbsCount")).length>0&&(i.absCount=$(s[0]).text()),e&&e(null,i);}});},Renderer.prototype._getMediaInfo=function(t,e){var r=this;this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetMediaInfo",{InstanceID:t},function(t,n){if(t)e&&e(t);else{var i,s,o={},a=n.find("NrTracks");if(a.length>0&&(o.nrTracks=$(a[0]).text()),(a=n.find("MediaDuration")).length>0&&(o.mediaDuration=$(a[0]).text()),(a=n.find("CurrentURI")).length>0&&(o.currentURI=$(a[0]).text()),(a=n.find("CurrentURIMetaData")).length>0)if((i=$(a[0]).text())&&"null"!=i.toLowerCase())try{s=$($.parseXML(i)),o.currentURIMetaDataRaw=s,o.currentURIMetaData=r._parseItemMetaData(s);}catch(t){return void(e&&e(t));}else o.currentURIMetaDataRaw="",o.currentURIMetaData=null;if((a=n.find("NextURI")).length>0&&(o.nextURI=$(a[0]).text()),(a=n.find("NextURIMetaData")).length>0)if(i=$(a[0]).text())try{s=$($.parseXML(i)),o.nextURIMetaDataRaw=s,o.nextURIMetaData=r._parseItemMetaData(s);}catch(t){return void(e&&e(t));}else o.nextURIMetaDataRaw="",o.nextURIMetaData=null;(a=n.find("PlayMedium")).length>0&&(o.playMedium=$(a[0]).text()),(a=n.find("RecordMedium")).length>0&&(o.ecordMedium=$(a[0]).text()),(a=n.find("WriteStatus")).length>0&&(o.writeStatus=$(a[0]).text()),e&&e(null,o);}});},Renderer.prototype._getTransportSettings=function(t,e){this._doSOAPRequest(this.getURL(this.avTransport.url),this.avTransport.type,"GetTransportSettings",{InstanceID:t},function(t,r){if(t)e&&e(t);else{var n={},i=r.find("PlayMode");i.length>0&&(n.playMode=$(i[0]).text()),(i=r.find("RecQualityMode")).length>0&&(n.recQualityMode=$(i[0]).text()),e&&e(null,n);}});},Renderer.prototype._setMute=function(t,e,r,n){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"SetMute",{InstanceID:t,Channel:e,DesiredMute:r},n);},Renderer.prototype._getMute=function(t,e,r){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetMute",{InstanceID:t,Channel:e},function(t,e){if(t)r&&r(t);else{var n={},i=e.find("CurrentMute");i.length>0&&(n.mute=$(i[0]).text()),r&&r(null,n);}});},Renderer.prototype._setVolume=function(t,e,r,n){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"SetVolume",{InstanceID:t,Channel:e,DesiredVolume:r},n);},Renderer.prototype._getVolume=function(t,e,r){this._doSOAPRequest(this.getURL(this.renderingControl.url),this.renderingControl.type,"GetVolume",{InstanceID:t,Channel:e},function(t,e){if(t)r&&r(t);else{var n={},i=e.find("CurrentVolume");i.length>0&&(n.volume=$(i[0]).text()),r&&r(null,n);}});},Renderer;}(),x.upnp.XCUPNP=function(){var XCUPNP=function XCUPNP(){this._udpListener=new x.upnp.UDPListener(),this._discoveryService=new x.upnp.DiscoveryService(this._udpListener);};return XCUPNP.prototype.MediaServer=x.upnp.MediaServer,XCUPNP.prototype.MediaRenderer=x.upnp.MediaRenderer,XCUPNP.prototype.Device=x.upnp.Device,XCUPNP.prototype.DescLoader=x.upnp.DescLoader,XCUPNP.prototype.discoverDevices=function(t){this.discoverTargetWithTimeout("upnp:rootdevice",5e3,t);},XCUPNP.prototype.discoverDevicesWithTarget=function(t,e){this.discoverTargetWithTimeout(t,5e3,e);},XCUPNP.prototype.discoverDevicesWithTimeout=function(t,e){this.discoverTargetWithTimeout("upnp:rootdevice",t,e);},XCUPNP.prototype.discoverTargetWithTimeout=function(t,e,r){this._discoveryService.addCallback(t,r),this._discoveryService.discoverTarget(t);var n=this;setTimeout(function(){n._discoveryService.removeCallback(t,r);},e);},XCUPNP.prototype.getDiscoveryService=function(){return this._discoveryService;},XCUPNP;}();var XCUPNP=x.upnp.XCUPNP;"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.upnp.XCUPNP());