var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.upnp=xnm.aio.upnp||{},xnm.aio.upnp.Player=function(){var Player=function Player(e){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.bose.SoundTouch"):this._logger={log:{}},this._renderer=null,e&&e.ip&&e.port&&e.uuid&&e.avTransport&&e.renderingControl&&(this._renderer=this._getRenderer(e.ip,e.port,e.uuid,e.avTransport,e.renderingControl));};return Player.prototype.getIP=function(){return this._renderer?this._renderer.ip:null;},Player.prototype.setIP=function(e){this._renderer&&(this._renderer.ip=e);},Player.prototype.getPort=function(){return this._renderer?this._renderer.port:null;},Player.prototype.setPort=function(e){this._renderer&&(this._renderer.port=e);},Player.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null;},Player.prototype.getPlayInfo=function(e){this._renderer?this._renderer.getPlayInfo(function(t,r){e&&e(t,r);}):e&&e(new Error("no renderer"));},Player.prototype.play=function(e,t,r){if(e&&t&&t["class"]&&t.id){if(this._renderer){var n=this;e.browseMetaData(t.id,function(a,s){if(a)r&&r(a);else if(0!=t["class"].indexOf("object.container")||t.res&&t.res.url){if(!t.res||!t.res.url)return void(r&&r(new Error("resource url invalid")));n._renderer.playResource({url:t.res.url},s.result,r);}else{if(!e.uuid)return void(r&&r(new Error("media server uuid invalid")));n._renderer.playContainer({containerID:t.id,server_uuid:e.uuid},s.result,r);}});}else r&&r(new Error("renderer not inited"));}else r&&r(new Error("play obj invalid"));},Player.prototype.browser=function(e,t,r,n,a){if(e){t||(t=0),r||(r=0),n||(n=0);e.browseChildren(t,r,n,null,function(e,t,r){a&&a(e,t,r);});}else a&&a(new Error("play obj invalid"));},Player.prototype.executeCommandCreator=function(e,t,r){t&&t.value?this._executeCommand(t.value,t.ext,function(e){r&&r(e);}):r&&r(new Error("command value is empty"));},Player.prototype.getStatesCreator=function(e,t,r){this._getStates(function(e,n){if(e)r&&r(e);else{for(var a=[],s=0;s<t.length;s++){var i=t[s];if(i&&i.id&&i.status){var o="?";switch(i.status.value){case"power":case"muted":case"volume":case"repeatMode":case"shuffleMode":case"playState":case"durationS":case"positionS":case"bass":o=n[i.status.value];break;case"artist":case"title":case"album":case"radio":(o=n[i.status.value])||(o="");}void 0!==o&&null!=o||(o="?"),a.push({id:i.id,status:o});}}r&&r(null,a);}});},Player.prototype._executeCommand=function(e,t,r){if(this._renderer){var n,a=this;switch(e){case"play":this._clickKey("PLAY",r);break;case"pause":this._clickKey("PAUSE",r);break;case"tooglePlay":this._clickKey("PLAY_PAUSE",r);break;case"stop":this._clickKey("STOP",r);break;case"previous":this._clickKey("PREV_TRACK",r);break;case"next":this._clickKey("NEXT_TRACK",r);break;case"togglePower":this._clickKey("POWER",r);break;case"toggleMute":this._clickKey("MUTE",r);break;case"volumeUp":this._clickKey("VOLUME_UP",r);break;case"volumeDown":this._clickKey("VOLUME_DOWN",r);break;case"setVolume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));var s=parseInt(t);s>100&&(s=100),s<0&&(s=0),this._setVolume(s,r);break;case"thumbUp":this._clickKey("THUMBS_UP",r);break;case"thumbDown":this._clickKey("THUMBS_DOWN",r);break;case"bookmark":this._clickKey("BOOKMARK",r);break;case"preset":if(!t)return void(r&&r(new Error("preset value invalid")));this._clickKey("PRESET_"+t,r);break;case"shuffleOn":this._clickKey("SHUFFLE_ON",r);break;case"shuffleOff":this._clickKey("SHUFFLE_OFF",r);break;case"toggleShuffle":this._getNowPlaying(function(e,t){if(e)r&&r(e);else if(t&&t.shuffleSetting){var n="SHUFFLE_ON";"SHUFFLE_ON"==t.shuffleSetting&&(n="SHUFFLE_OFF"),a._clickKey(n,r);}else r&&r(new Error("no shuffle setting"));});break;case"setRepeatMode":if(!t)return void(r&&r(new Error("play mode value invalid")));this._clickKey(t,r);break;case"addFav":this._clickKey("ADD_FAVORITE",r);break;case"removeFav":this._clickKey("REMOVE_FAVORITE",r);break;case"bassUp":case"bassDown":if(void 0===t||null==t)return void(r&&r(new Error("seek value invalid")));this._getBass(function(t,s){if(t)r&&r(t);else if(s&&void 0!==s.actualbass&&null!=s.actualbass){var i=s.actualbass;if("bassUp"==e?i+=1:i-=1,this.bass&&-1!=(n=this.bass.indexOf("-",1))){var o=this.bass.substring(0,n),u=this.bass.substr(n+1);i<(o=parseInt(o))&&(i=o),i>(u=parseInt(u))&&(i=u);}a._setBass(i,r);}else r&&r(new Error("no bass info"));});break;case"setBass":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));var i=parseInt(t);if(this.bass&&-1!=(n=this.bass.indexOf("-",1))){var o=this.bass.substring(0,n),u=this.bass.substr(n+1);i<(o=parseInt(o))&&(i=o),i>(u=parseInt(u))&&(i=u);}this._setBass(i,r);break;default:if(e&&"select:"==e.substr(0,7)){var l=e.substr(7);n=l.indexOf("@");var c=l.substring(0,n),p=l.substr(n+1);a._setSource(c,p,r);}else r&&r(new Error("unknown command"));}}else r&&r(new Error("renderer not initialized"));},Player.prototype._getStates=function(e){var cb=function cb(){0==--r&&e&&e(null,t);},t={},r=3;this._getBass(function(e,r){!e&&r&&(t.bass=r.actualbass),cb();}),this._getVolume(function(e,r){!e&&r&&(t.volume=r.actualvolume,t.muted=r.muteenabled),cb();}),this._getNowPlaying(function(e,r){!e&&r&&("STANDBY"==r.source?t.power="off":t.power="on",r.repeatSetting&&(t.repeatMode=r.repeatSetting),r.shuffleSetting&&(t.shuffleMode=r.shuffleSetting),r.playStatus&&(t.playState=r.playStatus),r.duration&&(t.durationS=r.duration),r.position&&(t.positionS=r.position),r.position&&(t.positionS=r.position),r.track&&(t.title=r.track),r.stationName&&(t.radio=r.stationName),r.artist&&(t.artist=r.artist),r.album&&(t.album=r.album)),cb();});},Player.prototype._getRenderer=function(e,t,r,n,a){var s=require("xnm.aio.upnp.js");if(s.discovery&&s.discovery._player){var i=s.discovery._player[r];if(i&&i._renderer)return i._renderer;}var o=new(require("x.upnp.js").MediaRenderer)();return o.init(e,t,r,{avTransport:n,renderingControl:a}),o;},Player.prototype._clickKey=function(e,t){var r=this;this._pressKey(e,function(n){n?t&&t(n):r._releaseKey(e,function(e){t&&t(e);});});},Player.prototype._getInfo=function(e){var t=this;this._sendRequest("GET","/info",null,function(r,n){if(r)e&&e(r);else{var a=n.find("info");if(a&&a[0]){var s=$(a[0]);t.mac=s.attr("deviceID");var i=s.find("name");i&&i[0]&&(t.name=$(i[0]).text()),e&&e(null,{name:t.name,mac:t.mac});}else e&&e(new Error("get info xml invalid"));}});},Player.prototype._pressKey=function(e,t){var r='<key state="press" sender="Gabbo">'+e+"</key>";this._sendRequest("POST","/key",r,t);},Player.prototype._releaseKey=function(e,t){var r='<key state="release" sender="Gabbo">'+e+"</key>";this._sendRequest("POST","/key",r,t);},Player.prototype._getSources=function(e){var t=this;this._sendRequest("GET","/sources",null,function(r,n){if(r)e&&e(r);else{var a=[];n.find("sourceItem").each(function(){var e=$(this);a.push({source:e.attr("source"),sourceAccount:e.attr("sourceAccount")?e.attr("sourceAccount"):null,isLocal:e.attr("isLocal"),name:e.text()?e.text():null});}),t.sources=a,e&&e(null,a);}});},Player.prototype._setSource=function(e,t,r){var n='<ContentItem source="'+e+'"';t&&(n+=' sourceAccount="'+t+'"'),n+="></ContentItem>",this._sendRequest("POST","/select",n,r);},Player.prototype._setBass=function(e,t){var r="<bass>"+e+"</bass>";this._sendRequest("POST","/bass",r,t);},Player.prototype._getBass=function(e){this._sendRequest("GET","/bass",null,function(t,r){if(t)e&&e(t);else{var n={},a=r.find("targetbass");a&&a[0]&&(n.targetbass=parseInt($(a[0]).text())),(a=r.find("actualbass"))&&a[0]&&(n.actualbass=parseInt($(a[0]).text())),e&&e(t,n);}});},Player.prototype._getBassCap=function(e){var t=this;this._sendRequest("GET","/bassCapabilities",null,function(r,n){if(r)e&&e(r);else{var a=n.find("bassAvailable");if(a&&a[0]){var s=$(a[0]).text();if(s&&"false"!=s.toLowerCase()){var i=0,o=n.find("bassMin");o&&o[0]&&(i=$(o[0]).text());var u=100,l=n.find("bassMax");l&&l[0]&&(u=$(l[0]).text()),t.bass=i+"-"+u,e&&e(null,{bass:t.bass});}else e&&e(null,null);}else e&&e(new Error("get bass cap xml invalid"));}});},Player.prototype._getZone=function(e){this._sendRequest("GET","/getZone",null,function(t,r){if(t)e&&e(t);else{var n={},a=r.find("zone");if(a&&a[0]){var s=$(a[0]).attr("master");if(!s)return void(e&&e(null,n));n.master=s;}$(a[0]).find("member").each(function(){var e=$(this),t=e.attr("ipaddress"),r=e.text();t&&r&&(n.members||(n.members={}),n.members[r]=t);}),e&&e(null,n);}});},Player.prototype._setZone=function(e,t,r){var n='<zone master="'+e+'" senderIPAddress="0.0.0.0">';for(var a in t){t.hasOwnProperty(a)&&t[a]&&(n+='<member ipaddress="'+t[a]+'">'+a+"</member>");}n+="</zone>",this._sendRequest("POST","/setZone",n,r);},Player.prototype._getVolume=function(e){this._sendRequest("GET","/volume",null,function(t,r){if(t)e&&e(t);else{var n={},a=r.find("targetvolume");a&&a[0]&&(n.targetvolume=parseInt($(a[0]).text())),(a=r.find("actualvolume"))&&a[0]&&(n.actualvolume=parseInt($(a[0]).text())),(a=r.find("muteenabled"))&&a[0]&&(n.muteenabled=$(a[0]).text()),e&&e(t,n);}});},Player.prototype._setVolume=function(e,t){var r="<volume>"+e+"</volume>";this._sendRequest("POST","/volume",r,t);},Player.prototype._getNowPlaying=function(e){this._sendRequest("GET","/now_playing",null,function(t,r){if(t)e&&e(t);else{var n,a={},s=r.find("nowPlaying");if(s&&s[0]&&(n=$(s[0]).getAttributes(),a=JSON.parse(JSON.stringify(n))),(s=r.find("ContentItem"))&&s[0]){n=$(s[0]).getAttributes(),a.content=JSON.parse(JSON.stringify(n));var i=$(s[0]).find("itemName");i&&i[0]&&(a.content.itemName=$(i[0]).text());}(s=r.find("track"))&&s[0]&&(a.track=$(s[0]).text()),(s=r.find("artist"))&&s[0]&&(a.artist=$(s[0]).text()),(s=r.find("album"))&&s[0]&&(a.album=$(s[0]).text()),(s=r.find("stationName"))&&s[0]&&(a.stationName=$(s[0]).text()),(s=r.find("art"))&&s[0]&&(a.artImageStatus=$(s[0]).attr("artImageStatus"),a.art=$(s[0]).text()),(s=r.find("playStatus"))&&s[0]&&(a.playStatus=$(s[0]).text()),(s=r.find("description"))&&s[0]&&(a.description=$(s[0]).text()),(s=r.find("stationLocation"))&&s[0]&&(a.description=$(s[0]).text()),(s=r.find("time"))&&s[0]&&(a.duration=$(s[0]).attr("total"),a.position=$(s[0]).text()),(s=r.find("shuffleSetting"))&&s[0]&&(a.shuffleSetting=$(s[0]).text()),(s=r.find("repeatSetting"))&&s[0]&&(a.repeatSetting=$(s[0]).text()),e&&e(null,a);}});},Player.prototype._sendRequest=function(e,t,r,n){this._doRequest(this.getIP(),8090,e,t,r,function(e,t){if(e)n&&n(e);else try{var r=$($.parseXML(t)),a=r.find("error");if(a&&a[0]){var s=$(a[0]),i=s.text(),o=s.attr("name");n&&n(new Error(i+":"+o));}else n&&n(null,r);}catch(e){n&&n(e);}});},Player.prototype._doRequest=function(e,t,r,n,a,s){var i=this,o="http://"+e+":"+t+n;this._logger.log("trace","send "+r+" to url:"+o),a&&this._logger.log("trace","with data "+a);var u=s,l={url:o,type:r,timeout:2e3,contentType:"text/xml",dataType:"text",cache:!0,success:function success(e){i._logger.log("trace","http request success:"+e),u&&(u(null,e),u=null);},error:function error(e,t){var r="http request error:"+(e?e.status:"0")+"-"+t;i._logger.log("trace",r),u&&(u(new Error(r)),u=null);}};"post"==r.toLowerCase()&&a&&(l.data=a),$.ajax(l);},Player.prototype.toJSON=function(){return{sys:"upnp",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),name:this._renderer?this._renderer.name:null,model:this._renderer?this._renderer.modelName:null,modelDescription:this._renderer?this._renderer.modelDescription:null,manufacturer:this._renderer?this._renderer.manufacturer:null,avTransport:this._renderer?this._renderer.avTransport:null,renderingControl:this._renderer?this._renderer.renderingControl:null,connectionManager:this._renderer?this._renderer.connectionManager:null};},Player.prototype.equalsTo=function(e){return!!e&&e instanceof SoundTouch&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},Player;}(),xnm.aio.upnp.InMemoryPlayList=function(){},xnm.aio.upnp.Discovery=function(){var Discover=function Discover(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.bose.Discovery"):this._logger={log:{}},this._upnpCB=null,this._mediaServer={},this._player={},this._searchCB=[],this._autoSearchTimeout=null,this.search(null);};return Discover.prototype.getBufferedPlayer=function(e){return this._player[e];},Discover.prototype.getBufferedPlayers=function(){var e=[];for(var t in this._player){this._player.hasOwnProperty(t)&&e.push(this._player[t]);}return e;},Discover.prototype.getBufferedMediaServers=function(){var e=[];for(var t in this._mediaServer){if(this._mediaServer.hasOwnProperty(t)){var r=this._mediaServer[t];e.push(r);}}return e;},Discover.prototype.search=function(e){var t=this._searchCB.length;if(e&&-1==this._searchCB.indexOf(e)&&this._searchCB.push(e),0==t){this._autoSearchTimeout&&(clearTimeout(this._autoSearchTimeout),this._autoSearchTimeout=null),this._search();var r=this;setTimeout(function(){r._autoSearchTimeout=setTimeout(function(){r._logger.log("trace","auto search timeout, search again"),r.search(null);},6e4);var e=r._searchCB;r._searchCB=[],e.forEach(function(e){e&&e();});},5e3);}},Discover.prototype._search=function(){if(!this._upnpCB){var e=this;this._upnpCB=function(t){e._findUpnpDevice(t);};}this._mediaServer={},this._player={};var t=require("x.upnp.js").getDiscoveryService();t.addCallback("upnp:rootdevice",this._upnpCB),t.discoverTarget("upnp:rootdevice");},Discover.prototype._findUpnpDevice=function(e){if(e){var t=e.uuid;switch(e.deviceType){case"urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+e.name+" @"+e.ip),this._mediaServer[t]=e;break;case"urn:schemas-upnp-org:device:MediaRenderer:1":this._logger.log("trace","find media renderer:"+e.name+" @"+e.ip);var r=new xnm.aio.upnp.Player();r._renderer=e,this._player[t]=r;}}},Discover;}(),xnm.aio.upnp.DM=function(){var e={command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"paly/pause",ref:{value:"tooglePlay"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle power",ref:{value:"togglePower"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"thumb up",ref:{value:"thumbUp"}},{type:"enum",name:"thumb down",ref:{value:"thumbDown"}},{type:"enum",name:"bookmark",ref:{value:"bookmark"}},{type:"enum",name:"preset",ref:{value:"preset",ext:"%e",extMeta:["1","2","3","4","5","6"]}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"toggleShuffle"}},{type:"enum",name:"set repeat mode",ref:{value:"setRepeatMode",ext:"%e",extMeta:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"add to favorite",ref:{value:"addFav"}},{type:"enum",name:"remove from favorite",ref:{value:"removeFav"}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"repeat mode",ref:{value:"repeatMode",options:["REPEAT_OFF","REPEAT_ONE","REPEAT_ALL"]}},{type:"enum",name:"shuffle mode",ref:{value:"shuffleMode",options:["SHUFFLE_ON","SHUFFLE_OFF"]}},{type:"string",name:"play state",ref:{value:"playState",options:["PLAY_STATE","PAUSE_STATE","STOP_STATE","BUFFERING_STATE","INVALID_PLAY_STATUS"]}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"radio station",ref:{value:"radio"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}}]},DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="UpnpDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"upnp",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"UPnP/DLNA Player"}];},createDevice:function createDevice(e,t,r){var n=DMError,a=DMError.ERROR_CODE;e?e.type?e.ip?e.port?e.uuid?r(null,e):r(new n(a.INVALID,"uuid is invalid")):r(new n(a.INVALID,"port is invalid")):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"type is invalid")):r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=DMError,a=DMError.ERROR_CODE;e?e.type?e.ip?e.port?e.uuid?r(null,e):r(new n(a.INVALID,"uuid is invalid")):r(new n(a.INVALID,"port is invalid")):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"type is invalid")):r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},applyUIFilter:function applyUIFilter(e,t,r){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,n=0;n<e.length;n++){if(e[n]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var n=[],a=null,s=xnm.aio.bose.DM.getCommandStatusMap(e,r);return s&&(a=function(e,t,r){var n=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(s,0,t),n=n.concat(a)),n;};if(!e.sys)return null;var n=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),n.command=a;break;case"status":a=_filter(e,t),n.status=a;break;default:return null;}return a&&0!=a.length?n:null;},getCommandStatusMap:function getCommandStatusMap(t,r){var n=JSON.parse(JSON.stringify(e));return t&&t.bass&&(n.command.push({type:"enum",name:"bass up",ref:{value:"bassUp"}}),n.command.push({type:"enum",name:"bass down",ref:{value:"bassDown"}}),n.command.push({type:"int",name:"set bass",ref:{value:"setBass",ext:"%d",extMeta:t.bass}}),n.status.push({type:"int",name:"bass",ref:{value:"bass",extMeta:t.bass}})),t&&t.sources&&t.sources.forEach(function(e){if(e&&"true"==e.isLocal){var t=e.source;e.name&&(t=e.name);var r=e.sourceAccount?e.sourceAccount:"";if(e.source){var a="select:"+e.source+"@"+r;n.command.push({type:"enum",name:"select "+t,ref:{value:a}});}}}),n;}};}(),xnm.aio.upnp.Handler=function(){var Handler=function Handler(){this.discovery=new xnm.aio.upnp.Discovery();};return Handler.prototype.devicemanager=xnm.aio.upnp.DM,Handler.prototype.Player=xnm.aio.upnp.Player,Handler.prototype.registModule=function(e){e.register(xnm.aio.upnp.DM.SYS,"upnp");},Handler.prototype.resolveDevice=function(e){if(!e)return null;var t=null;return e.uuid&&(t=this.discovery.getBufferedPlayer(e)),t||(e.ip&&e.port&&e.uuid&&e.avTransport&&e.renderingControl?new xnm.aio.upnp.Player(e):null);},Handler.prototype.getDeviceCommands=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),n=r?r.command:[];t&&t(null,n);},Handler.prototype.getDeviceStatus=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),n=r?r.status:[];t&&t(null,n);},Handler.prototype.doCommand=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(e,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,r,n){var a=this.resolveDevice(t);if(a){var s=[{id:e,device:t,status:r}];a.getStatesCreator(null,s,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("device json format invalid"));},Handler.prototype.discover=function(e){var t=this;this.discovery.search(function(){e&&e(null,t.discovery.getBufferedPlayers());});},Handler.prototype.getPlayer=function(e,t){if(e&&e.uuid){var r=this.discovery.getBufferedPlayer(e.uuid);if(r)t&&t(null,r);else{var n=this;this.discovery.search(function(){r=n.discovery.getBufferedPlayer(e.uuid),t&&t(null,r);});}}else t&&t(new Error("device json invalid"));},Handler.prototype.getMediaServer=function(e){var t=this.discovery.getBufferedMediaServers();if(0==t.length){var r=this;this.discovery.search(function(){e&&e(null,r.discovery.getBufferedMediaServers());});}else e&&e(null,t);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.upnp.Handler());