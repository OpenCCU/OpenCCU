function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.rwe=xnm.aio.rwe||{},xnm.aio.rwe.Cache={STATUS_EXPIRE_TO:3e5,_cache:{},_statusBuffer:{},_stateMachine:{},_centralBuffer:{},_getCache:function _getCache(e){return e?this._cache[e]:null;},_ensureCache:function _ensureCache(e){return e?(this._cache[e]||(this._cache[e]={}),this._cache[e]):null;},_getStateMachine:function _getStateMachine(e){return e?this._stateMachine[e]:null;},_ensureStateMachine:function _ensureStateMachine(e){return e?(this._stateMachine[e]||(this._stateMachine[e]={state:0,loginCallbacks:[]}),this._stateMachine[e]):null;},_getStateBuffer:function _getStateBuffer(e){return e?this._statusBuffer[e]:null;},_ensureStateBuffer:function _ensureStateBuffer(e){return e?(this._statusBuffer[e]||(this._statusBuffer[e]={}),this._statusBuffer[e]):null;},setSessionID:function setSessionID(e,t){if(!e)return null;var a=this._ensureCache(e);if(!a)return null;a.sessionID=t;},getSessionID:function getSessionID(e){if(!e)return null;var t=this._getCache(e);return t?t.sessionID:null;},setCurrentConfig:function setCurrentConfig(e,t){if(!e)return null;var a=this._ensureCache(e);if(!a)return null;a.currentConfig=t;},getCurrentConfig:function getCurrentConfig(e){if(!e)return null;var t=this._getCache(e);return t?t.currentConfig:null;},setVersion:function setVersion(e,t){if(!e)return null;var a=this._ensureCache(e);if(!a)return null;a.version=t;},getVersion:function getVersion(e){if(!e)return null;var t=this._getCache(e);return t&&t.version?t.version:"1.70";},setStateMachineState:function setStateMachineState(e,t){if(e){var a=this._ensureStateMachine(e);a&&(a.state=t||0);}},getStateMachineState:function getStateMachineState(e){if(!e)return null;var t=this._getStateMachine(e);return t&&t.state?t.state:0;},addLoginCallback:function addLoginCallback(e,t){if(!e||!t)return null;var a=this._ensureStateMachine(e);a&&(a.loginCallbacks||(a.loginCallbacks=[]),a.loginCallbacks.push(t));},getLoginCallbacks:function getLoginCallbacks(e){if(!e)return null;var t=this._getStateMachine(e);return t?t.loginCallbacks:null;},clearLoginCallbacks:function clearLoginCallbacks(e){if(!e)return null;var t=this._getStateMachine(e);t&&(t.loginCallbacks=[]);},setCentral:function setCentral(e,t){if(!e)return null;this._centralBuffer[e]=t;},getCentral:function getCentral(e){return this._centralBuffer[e];},setStatusBuffer:function setStatusBuffer(e,t){if(!e)return null;var a=this._ensureStateBuffer(e);if(a){var r=this;null==a.timer&&(a.timer=setInterval(function(){var t=r.getCentral(e);t&&t.refreshStates();},2e3)),a.status=t,a.timestamp=new Date().getTime();}},getStatusBuffer:function getStatusBuffer(e){if(!e)return null;var t=new Date().getTime(),a=this._ensureStateBuffer(e);if(!a.status)return a.status={},a.timestamp=t,null;if(a.timestamp&&-a.timestamp>this.STATUS_EXPIRE_TO)return a.timestamp=t,null;var r=this;return null==a.timer&&(a.timer=setInterval(function(){var t=r.getCentral(e);t&&t.refreshStates();},2e3)),a.status;},updateStatusBuffer:function updateStatusBuffer(e,t){if(!e||!t)return null;var a=this._ensureStateBuffer(e);a.status||(a.status={});var r=!1;for(var n in t){t.hasOwnProperty(n)&&t[n]&&(r=!0,a.status[n]=t[n]);}r&&(a.timestamp=new Date().getTime());},getSingleBufferedStatus:function getSingleBufferedStatus(e,t){if(!e||!t)return null;var a=this._ensureStateBuffer(e);return a.status?a.status[t]:null;},finalize:function finalize(e){var t=new Date().getTime()-24e4;for(var a in this._statusBuffer){if(this._statusBuffer.hasOwnProperty(a)){var r=this._statusBuffer[a];r&&(r.timer&&(clearInterval(r.timer),r.timer=null),r.timestamp=t);}}e&&e();}},xnm.aio.rwe.Central=function(){var Central=function Central(e,t,a,r){this._logger=require("x.logger.js").getLogger("xnm.aio.rwe.Central"),this.ip=e,this.port=t,t||(this.port=443),this.user=a,this.password=r,this._clientID=this._generateGUID(),this.CommandHandler=null;};return Central.DEVICE_TYPE_LIST=["SwitchActuator","DimmerActuator","RollerShutterActuator","RoomHumiditySensor","RoomTemperatureSensor","RoomTemperatureActuator","AlarmActuator","WindowDoorSensor","SmokeDetectionSensor","GenericActuator"],Central.prototype._getSessionID=function(){return xnm.aio.rwe.Cache.getSessionID(this.ip);},Central.prototype._setSessionID=function(e){return xnm.aio.rwe.Cache.setSessionID(this.ip,e);},Central.prototype._getCurrentConfig=function(){return xnm.aio.rwe.Cache.getCurrentConfig(this.ip);},Central.prototype._setCurrentConfig=function(e){return xnm.aio.rwe.Cache.setCurrentConfig(this.ip,e);},Central.prototype._getVersion=function(){return xnm.aio.rwe.Cache.getVersion(this.ip);},Central.prototype._setVersion=function(e){return xnm.aio.rwe.Cache.setVersion(this.ip,e);},Central.prototype._getStateMachineState=function(){return xnm.aio.rwe.Cache.getStateMachineState(this.ip);},Central.prototype._setStateMachineState=function(e){xnm.aio.rwe.Cache.setStateMachineState(this.ip,e);},Central.prototype._addLoginCallback=function(e){xnm.aio.rwe.Cache.addLoginCallback(this.ip,e);},Central.prototype._getLoginCallbacks=function(){return xnm.aio.rwe.Cache.getLoginCallbacks(this.ip);},Central.prototype._clearLoginCallbacks=function(){xnm.aio.rwe.Cache.clearLoginCallbacks(this.ip);},Central.prototype._setBufferedCentral=function(){xnm.aio.rwe.Cache.setCentral(this.ip,this);},Central.prototype._getStatusBuffer=function(){return xnm.aio.rwe.Cache.getStatusBuffer(this.ip);},Central.prototype._setStatusBuffer=function(e){xnm.aio.rwe.Cache.setStatusBuffer(this.ip,e);},Central.prototype._updateStatusBuffer=function(e){xnm.aio.rwe.Cache.updateStatusBuffer(this.ip,e);},Central.prototype._getSingleBufferedStatus=function(e){return xnm.aio.rwe.Cache.getSingleBufferedStatus(this.ip,e);},Central.prototype._generateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16);});},Central.prototype._parseDeviceData=function(e){var t,a={},r={},n={},o={};for(var s in e.find("LC").each(function(){var e=$(this),t=e.find("Name"),a=e.find("Id");t&&a&&(r[$(a[0]).text()]={name:$(t[0]).text(),devices:{}});}),e.find("BD").each(function(){var e=$(this).find("Id");e&&(n[$(e[0]).text()]={address:$(e[0]).text(),channels:{}});}),e.find("LD").each(function(){var e=$(this),t=e.attr("xsi:type");if(t){var a=e.attr("Name"),r=e.attr("LCID"),n=e.find("BDId");n=n&&n.length>0?$(n[0]).text():null;var s=e.find("UDvIds");s=s&&s.length>0&&(s=$(s[0]).find("guid"))&&s.length>0?$(s[0]).text():null;var i=e.find("Id"),u={name:a,type:t,address:i=i&&i.length>0?$(i[0]).text():null,bid:n,udvid:s,lid:r},l=e.find("ActCls");l&&l.length>0&&(u.data=$(l[0]).text()),o[i]=u;}}),o){if(o.hasOwnProperty(s)){var i=o[s];if(i.type&&-1!=Central.DEVICE_TYPE_LIST.indexOf(i.type)&&i.lid&&r[i.lid])if("GenericActuator"==i.type&&i.address)r[i.lid].devices[i.address]={address:i.address,channels:{}},t=r[i.lid].devices[i.address],delete i.bid,delete i.udvid,delete i.lid,t.channels[i.address]=i;else{var u=i.bid;u||i.udvid&&o[i.udvid]&&o[i.udvid].bid&&(u=o[i.udvid].bid),u&&n[u]&&i.address&&((t=r[i.lid].devices[u])||(r[i.lid].devices[u]=n[u],t=r[i.lid].devices[u]),delete i.bid,delete i.udvid,delete i.lid,t.channels[i.address]=i);}}}return a.data=r,a;},Central.prototype._parseMessageData=function(e){var t={},a={};return e.find("MessageContainer").each(function(){var e=$(this),t=e.attr("State"),r=e.find("Message");if(r){var n=$(r[0]),o=n.attr("Id"),s=n.attr("Type"),i=n.attr("TimeStamp");if(o&&s&&i){a[o]={type:s,time:i,read:"Read"==t};var u={};n.find("MessageParameter").each(function(){var e=$(this),t=e.attr("Key"),a=e.attr("Value");t&&a&&(u[t]=a);}),a[o].params=u;}}}),t.data=a,t;},Central.prototype._parseDeviceStateData=function(e){var t={},a={};return e.find("LogicalDeviceState").each(function(){var e=$(this),t=e.attr("LID"),r=e.attr("xsi:type");if(t&&r){var n=null;if("SwitchActuatorState"==r)n={state:"?"},"True"==(i=e.attr("IsOn"))?n.state="on":"False"==i&&(n.state="off");else if("DimmerActuatorState"==r){n={state:"?"},"string"==typeof(i=e.attr("DmLvl")||"0")&&i.length>0&&(n.state=parseInt(i));}else if("RollerShutterActuatorState"==r){n={state:"?"};var o=e.find("ShutterLevel");o&&o.length>0&&(n.state=parseInt($(o[0]).text())||0);}else if("RoomHumiditySensorState"==r){n={state:"?"},"string"==typeof(i=e.attr("Humidity"))&&i.length>0&&(n.state=i);}else if("RoomTemperatureSensorState"==r){n={state:"?"},"string"==typeof(i=e.attr("Temperature"))&&i.length>0&&(n.state=parseFloat(i).toFixed(1));}else if("RoomTemperatureActuatorState"==r){n={state:"?"},"string"==typeof(i=e.attr("PtTmp"))&&i.length>0&&(n.state=parseFloat(i).toFixed(1)),"string"==typeof(i=e.attr("OpnMd"))&&i.length>0&&(n.mode=i.toLowerCase());}else if("AlarmActuatorState"==r){n={state:"?"},(i=e.attr("IsOn"))&&(i=i.toLowerCase()),"true"==i?n.state="on":"false"==i&&(n.state="off");}else if("WindowDoorSensorState"==r){n={state:"?"};var s=e.find("IsOpen");if(s&&s.length>0)(i=$(s[0]).text())&&(i=i.toLowerCase()),"true"==i?n.state="open":"false"==i&&(n.state="closed");}else if("SmokeDetectionSensorState"==r){n={state:"?"};var i,u=e.find("IsSmokeAlarm");if(u&&u.length>0)(i=$(u[0]).text())&&(i=i.toLowerCase()),"true"==i?n.state="on":"false"==i&&(n.state="off");}else if("GenericDeviceState"==r){n={state:"?"};var l=e.find("Ppt");if(l&&l.length>0){var c=(l=$(l[0])).attr("xsi:type"),d=l.attr("Name"),f=l.attr("Value");void 0!==f&&null!=f||(f="?"),"string"==typeof c&&c.length>0&&"string"==typeof d&&d.length>0&&"string"==typeof f&&("BooleanProperty"==c?(n.state=f.toLowerCase(),r="BooleanProperty:Value"):(n.state=f,r=c+":"+d));}}n&&(a[t]={state:n,type:r});}}),t.data=a,t;},Central.prototype._parseResult=function(e){var t={};if(!(e=$($($.parseXML(e)).children()[0])))return t.error="invalid reponse",t;if("NotificationList"==e.prop("tagName"))t=this._parseDeviceStateData(e);else switch(e.attr("xsi:type")){case"AuthenticationErrorResponse":t.error=e.attr("Error");break;case"VersionMismatchErrorResponse":var a=e.attr("Version");this._setVersion(a),t.error="VersionMismatch";break;case"AcknowledgeResponse":t.data={result:"ok"};break;case"ControlResultResponse":"Ok"==e.attr("Result")?t.data={result:"ok"}:t.error=e.attr("Result");break;case"LoginResponse":var r=e.attr("SessionId");r&&this._setSessionID(r);var n=e.attr("CurrentConfigurationVersion");n&&this._setCurrentConfig(n),t.data={sessionID:r,currentConfig:n};break;case"GetEntitiesResponse":t=this._parseDeviceData(e);break;case"GetAllLogicalDeviceStatesResponse":"Ok"==e.attr("Result")?t=this._parseDeviceStateData(e):t.error=e.attr("Result");break;case"MessageListResponse":t=this._parseMessageData(e);break;default:e.attr("Error")?t.error=e.attr("Error"):t.error="unknown response type:"+e.attr("xsi:type");}return t;},Central.prototype._doRequest=function(e,t,a,r){var n;if(e||(e="/cmd"),"object"==_typeof(a)&&a&&a.body)n=a.body;else{n='<BaseRequest xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" Version="'+this._getVersion()+'" RequestId="'+this._generateGUID()+'" ';var o=this._getSessionID();o&&(n+='SessionId="'+o+'" ');var s=this._getCurrentConfig();for(var i in n+=s?'BasedOnConfigVersion="'+s+'" ':'BasedOnConfigVersion="0" ',t){n+=i+'="'+t[i]+'" ';}a&&a.length>0?n+=">"+a+"</BaseRequest>":n+="/>";}var u={};"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",u=require("constants"));var l={host:this.ip,port:this.port,path:e,method:"POST",headers:{Referer:"https://smarthome.blob.core.windows.net/silverlight/latest/application/RWE.SmartHome.UI.Shell.xap",ClientId:this._clientID,"Content-Type":"text/xml; charset=UTF-8","cache-control":"no-cache",pragma:"no-cache","User-Agent":"Java/1.7.0_07",Accept:"text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2",Connection:"close","Content-Length":n.length},rejectUnauthorized:!1,secureOptions:u.SSL_OP_NO_TLSv1,strictSSL:!1,secureProtocol:"TLSv1_client_method"};this._logger.log("trace","do request:"+JSON.stringify(l));var c=this,d=r,f=require("https").request(l,function(n){n.setEncoding("utf-8");var o="";n.on("data",function(e){o+=e;}),n.on("end",function(){var s,i;if(c._logger.log("trace","receive code:"+n.statusCode+" headers:"+JSON.stringify(n.headers)+" response:"+o),200==n.statusCode)try{if((i=c._parseResult(o))&&"VersionMismatch"==i.error)return void c._doRequest(e,t,a,r);}catch(e){console.error(e),s=e;}d&&(d(s,i,n),d=null);});});f.on&&f.on("error",function(e){c._logger.log("trace","do request error:"+e.message),d&&(d(e),d=null);}),f.setTimeout&&f.setTimeout(6e4,function(){c._logger.log("trace","do request timeout"),f.abort(),d&&(d(new Error("timeout")),d=null);}),this._logger.log("trace","do request send body:"+n),f.write(n),f.end();},Central.prototype._sendRequest=function(e,t,a,r){var n=this,o=this._getSessionID(),s=this._getCurrentConfig();o&&s?this._doRequest(e,t,a,function(o,s,i){if(o)r&&r(o);else{if(i&&401==i.statusCode)return n._logger.log("debug","http request error with code:"+i.statusCode),n._setSessionID(null),n._setCurrentConfig(null),void n._sendRequest(e,t,a,r);if(i&&200!=i.statusCode)return o=new Error("http request error with code:"+i.statusCode),void(r&&r(o));if(s&&("IllegalSessionId"==s.error||"ConfigurationOutOfDate"==s.error))return n._logger.log("debug","send request response error:"+s.error),n._setSessionID(null),n._setCurrentConfig(null),void n._sendRequest(e,t,a,r);s&&s.error&&(n._logger.log("debug","send request response error:"+s.error),o||(o=new Error(s.error))),r&&r(o,s?s.data:s);}}):this._login(function(o){o?r&&r(o):n._sendRequest(e,t,a,r);});},Central.prototype._login=function(e){if(this._logger.log("debug","LoginRequest"),this.user&&this.password){if(this._addLoginCallback(e),1!=this._getStateMachineState()){this._setStateMachineState(1);var t=require("x.crypt.js"),a=new Buffer(t.SHA256(this.password),"hex").toString("base64"),r=this;this._doRequest(null,{"xsi:type":"LoginRequest",UserName:this.user,Password:a},null,function(e,t,a){var n=r._getLoginCallbacks();if(r._clearLoginCallbacks(),e?r._logger.log("debug","login error:"+e.message):a&&200!=a.statusCode?(r._logger.log("debug","login http error:"+a.statusCode),e=new Error("login http request error with code:"+a.statusCode)):t&&t.error&&(r._logger.log("debug","login response error:"+t.error),e=new Error(t.error)),e)return r._setStateMachineState(0),void(n&&n.forEach(function(t){t&&t(e);}));r._subscribeNotification(function(e){if(e)return r._setStateMachineState(0),void(n&&n.forEach(function(t){t&&t(e);}));r._logger.log("debug","login success:"+JSON.stringify(t)),r._setStateMachineState(2),r._setBufferedCentral(),n&&n.forEach(function(e){e&&e(null,t?t.data:t);});});});}}else e&&e(new Error("username or password in null"));},Central.prototype._subscribeNotification=function(e){this._logger.log("debug","NotificationRequest");var t=this;this._sendRequest(null,{"xsi:type":"NotificationRequest"},"<Action>Subscribe</Action><NotificationType>DeviceStateChanges</NotificationType>",function(a,r){a&&t._logger.log("debug","NotificationRequest error:"+a.message),r&&t._logger.log("debug","NotificationRequest response:"+JSON.stringify(r)),e&&e(a,r);});},Central.prototype._getUpd=function(e){this._logger.log("debug","Get Update Notification");var t=this;this._sendRequest("/upd",null,{body:"upd"},function(a,r){a&&t._logger.log("debug","Update Notification error:"+a.message),r&&t._logger.log("debug","Update Notification response:"+JSON.stringify(r)),e&&e(a,r);});},Central.prototype._getEntities=function(e){this._logger.log("debug","GetEntitiesRequest");var t=this;this._sendRequest(null,{"xsi:type":"GetEntitiesRequest"},"<EntityType>Configuration</EntityType>",function(a,r){a&&t._logger.log("debug","GetEntitiesRequest error:"+a.message),r&&t._logger.log("debug","GetEntitiesRequest response:"+JSON.stringify(r)),e&&e(a,r);});},Central.prototype._getDeviceStates=function(e){this._logger.log("debug","_getDeviceStates");var t=this._getStatusBuffer();if(t)return console.log("status buffer",t),void(e&&e(null,t));this._logger.log("debug","GetAllLogicalDeviceStatesRequest");var a=this;this._sendRequest(null,{"xsi:type":"GetAllLogicalDeviceStatesRequest"},null,function(t,r){if(t)return a._logger.log("debug","GetAllLogicalDeviceStatesRequest error:"+t.message),a._setStatusBuffer(null),void(e&&e(t));r&&(a._logger.log("debug","GetAllLogicalDeviceStatesRequest response:"+JSON.stringify(r)),a._setStatusBuffer(r)),e&&e(null,r);});},Central.prototype._getDeviceState=function(e,t){this._getDeviceStates(function(a,r){if(a)t&&t(a);else{var n=null;r&&r[e]&&(n=r[e].state),t&&t(null,n);}});},Central.prototype._addSpecialTypesFromStates=function(e,t){for(var a in e){var r=[],n=e[a];for(var o in n.devices){var s=n.devices[o];for(var i in s.channels){var u=s.channels[i];u.data&&"Generic"!=u.data||!t[i]||(t[i].type&&-1==t[i].type.indexOf(":")&&"Generic"==u.data?r.push(o):u.data=t[i].type);}}for(var l=0;l<r.length;l++){r[l]&&delete n.devices[r[l]];}}return e;},Central.prototype.getDevices=function(e){var t=this;this._getEntities(function(a,r){a?e&&e(a):t._getDeviceStates(function(a,n){if(a)e&&e(a);else{var o=t._addSpecialTypesFromStates(r,n);e&&e(null,o);}});});},Central.prototype.getMessages=function(e){this._doRequest(null,{"xsi:type":"GetMessageListRequest"},null,function(t){e&&(t&&t.data?e&&e(t.data):e&&e(null));});},Central.prototype.executeCommand=function(e,t,a){if(e&&e.channels){var r=null,n=null;if("on"==t||"off"==t||"toggle"==t?n="SwitchActuator":"auto"==t||"manu"==t||"tempOff"==t||0==t.indexOf("tempTo")?n="RoomTemperatureActuator":"dimUp"==t||"dimDown"==t||0==t.indexOf("dimTo")?n="DimmerActuator":"moveUp"==t||"moveDown"==t||0==t.indexOf("moveTo")?n="RollerShutterActuator":"alarmOn"==t||"alarmOff"==t||"alarmToggle"==t?n="AlarmActuator":"boolTrue"!=t&&"boolFalse"!=t&&"boolToggle"!=t&&0!=t.indexOf("numTo")||(n="GenericActuator"),n){for(var o in e.channels){if(e.channels.hasOwnProperty(o)&&e.channels[o]&&e.channels[o].type==n){r=e.channels[o];break;}}r?this._executeCommand(r,t,a):a&&a(new Error("device has no channel:"+n));}else a&&a(new Error("unknown command"));}else a&&a(new Error("device format invalid"));},Central.prototype._executeCommand=function(e,t,a){if(e&&e.type&&e.address){if(void 0!==t&&null!=t){var r=this,n=null,o=null,s=!0;switch(e.type){case"SwitchActuator":switch(t){case"on":o="True";break;case"off":o="False";break;case"toggle":s=!1,this._getDeviceState(e.address,function(t,n){if(t||!n)return t||(t=new Error("current state rsp of switch is invalid")),void(a&&a(t));"off"==n.state?r._executeCommand(e,"on",a):r._executeCommand(e,"off",a);});}o&&(n='<ActuatorStates><LogicalDeviceState xsi:type="SwitchActuatorState" LID="'+e.address+'" IsOn="'+o+'" /></ActuatorStates>');break;case"DimmerActuator":switch(t){case"dimUp":case"dimDown":s=!1,this._getDeviceState(e.address,function(n,o){if(n||!o)return n||(n=new Error("current state rsp of dimmer is invalid")),void(a&&a(n));var s=parseInt(o.state);isNaN(s)?a&&a(new Error("current dimmer state invalid")):("dimUp"==t?s+=5:s-=5,r._executeCommand(e,"dimTo"+s,a));});break;default:0==t.indexOf("dimTo")&&((o=parseInt(t.replace(/dimTo/g,"")))<0&&(o=0),o>100&&(o=100));}void 0!==o&&null!=o&&(n='<ActuatorStates><LogicalDeviceState xsi:type="DimmerActuatorState" LID="'+e.address+'" DmLvl="'+o+'" /></ActuatorStates>');break;case"RollerShutterActuator":switch(t){case"moveUp":case"moveDown":s=!1,this._getDeviceState(e.address,function(n,o){if(n||!o)return n||(n=new Error("current state rsp of blind is invalid")),void(a&&a(n));var s=parseInt(o.state);isNaN(s)?a&&a(new Error("current blind state invalid")):("moveUp"==t?s+=5:s-=5,r._executeCommand(e,"moveTo"+s,a));});break;default:0==t.indexOf("moveTo")&&((o=parseInt(t.replace(/moveTo/g,"")))<0&&(o=0),o>100&&(o=100));}void 0!==o&&null!=o&&(n='<ActuatorStates><LogicalDeviceState xsi:type="RollerShutterActuatorState" LID="'+e.address+'" ><ShutterLevel>'+o+"</ShutterLevel></LogicalDeviceState></ActuatorStates>");break;case"RoomTemperatureActuator":switch(t){case"manu":n='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+e.address+'" OpnMd="Manu" /></ActuatorStates>';break;case"auto":n='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+e.address+'" OpnMd="Auto" /></ActuatorStates>';break;case"tempOff":n='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+e.address+'" PtTmp="6.0" /></ActuatorStates>';break;default:0==t.indexOf("tempTo")&&(o=t.replace(/tempTo/g,""),o=(parseFloat(o)/2).toFixed(1),n='<ActuatorStates><LogicalDeviceState xsi:type="RoomTemperatureActuatorState" LID="'+e.address+'" PtTmp="'+o+'" /></ActuatorStates>');}break;case"AlarmActuator":switch(t){case"alarmOn":o="True";break;case"alarmOff":o="False";break;case"alarmToggle":s=!1,this._getDeviceState(e.address,function(t,n){t?a&&a(t):n&&"off"==n.state?r._executeCommand(e,"alarmOn",a):r._executeCommand(e,"alarmOff",a);});}o&&(n='<ActuatorStates><LogicalDeviceState xsi:type="AlarmActuatorState" LID="'+e.address+'" IsOn="'+o+'" /></ActuatorStates>');break;case"GenericActuator":var i=null,u=null,l=null;if(e.data){var c=e.data.split(":");if(2==c.length)if(i=c[0],u=c[1],"on"==t||"true"==t||"boolTrue"==t)l="True";else if("off"==t||"false"==t||"boolFalse"==t)l="False";else if(0==t.indexOf("numTo")){o=t.replace(/numTo/g,""),l=parseFloat(o);var d=this._buildCMDStatus(e,t);d&&this._updateStatusBuffer(d);}else if("boolToggle"==t){s=!1,this._getDeviceState(e.address,function(t,n){if(t||!n)return t||(t=new Error("current state rsp of switch is invalid")),void(a&&a(t));"false"==n.state?r._executeCommand(e,"true",a):r._executeCommand(e,"false",a);});break;}}i&&u&&null!=l&&(n='<ActuatorStates><LogicalDeviceState xsi:type="GenericDeviceState" LID="'+e.address+'"><Ppts><Ppt xsi:type="'+i+'" Name="'+u+'" Value="'+l+'" /></Ppts></LogicalDeviceState></ActuatorStates>');}if(s){if(!n)return void(a&&a(new Error("unknow command")));this._sendRequest(null,{"xsi:type":"SetActuatorStatesRequest"},n,function(n){if(!n){var o=r._buildCMDStatus(e,t);o&&r._updateStatusBuffer(o);}a&&a(n);});}}else a&&a(new Error("command invalid"));}else a&&a(new Error("channel format invalid"));},Central.prototype._buildCMDStatus=function(e,t){if(!(e&&e.address&&e.type&&t))return null;var a,r=null;switch(e.type){case"SwitchActuator":"on"!=t&&"off"!=t||((r={})[e.address]={state:{state:t},type:"SwitchActuatorState"});break;case"DimmerActuator":if(0==t.indexOf("dimTo"))r={},(n=parseInt(t.replace(/dimTo/g,"")))<0&&(n=0),n>100&&(n=100),r[e.address]={state:{state:""+n},type:"DimmerActuatorState"};break;case"RollerShutterActuator":if(0==t.indexOf("moveTo"))r={},(n=parseInt(t.replace(/moveTo/g,"")))<0&&(n=0),n>100&&(n=100),r[e.address]={state:{state:""+n},type:"RollerShutterActuatorState"};break;case"RoomTemperatureActuator":if("auto"==t||"manu"==t)(r={})[e.address]={state:{mode:t},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(e.address))&&a.state&&(r[e.address].state.state=a.state.state);else if("tempOff"==t||0==t.indexOf("tempTo")){r={},"tempOff"==t?n="6.0":(n=t.replace(/tempTo/g,""),n=(parseFloat(n)/2).toFixed(1)),r[e.address]={state:{state:n},type:"RoomTemperatureActuatorState"},(a=this._getSingleBufferedStatus(e.address))&&a.state&&(r[e.address].state.mode=a.state.mode);}break;case"AlarmActuator":"alarmOn"!=t&&"alarmOff"!=t||((r={})[e.address]={state:{state:"alarmOn"==t?"on":"off"},type:"AlarmActuatorState"});break;case"GenericActuator":if("boolTrue"==t||"boolFalse"==t)(r={})[e.address]={state:{state:"boolTrue"==t?"true":"false"},type:e.data};else if(0==t.indexOf("numTo")){r={};var n=parseFloat(t.replace(/numTo/g,""));r[e.address]={state:{state:""+n},type:e.data};}break;default:return null;}return r;},Central.prototype.getStates=function(e,t,a){var r=this;this.CommandHandler=e,this._getDeviceStates(function(e,n){for(var o={},s=0;s<t.length;s++){if(n&&n[t[s].address]){var i=t[s],u=n[t[s].address].state,l=r.getStateValues(i.subtype,u);if(r.CommandHandler&&r.CommandHandler.setState)for(var c in l){"state"==c?r.CommandHandler.setState(i.id,l[c]):r.CommandHandler.setState(i.id+":"+c,l[c]);}else r.CommandHandler&&r.CommandHandler.receivedState&&r.CommandHandler.receivedState("rwe",i.address,u);if(a)for(var c in l){"state"==c?o[i.id]=l[c]:o[i.id+":"+c]=l[c];}}}a&&a(e,n);});},Central.prototype.getStateValues=function(e,t){return t;},Central.prototype.executeCommandCreator=function(e,t,a){if(e){if(t&&t.value){var r=t.value;if("tempAuto"==t.value)r="auto";else if("tempManu"==t.value)r="manu";else if("tempTo"==t.value){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command setTo ext format invalid")));var n=parseFloat(t.ext);r=t.value+2*n;}else if("dimTo"==t.value){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command dimTo ext format invalid")));r=t.value+t.ext;}else if("moveTo"==t.value){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command dimTo ext format invalid")));r=t.value+t.ext;}else if("numTo"==t.value){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command numTo ext format invalid")));r=t.value+t.ext;}this.executeCommand(e,r,function(e){a&&a(e);});}else a&&a(new Error("command json format invalid"));}else a&&a(new Error("device json format invalid"));},Central.prototype.getStatesCreator=function(e,t,a){if(t){if(0!=t.length){var r=this;this.getStates(e,[],function(e,n){var o=[];if(n)for(var s=0;s<t.length;s++){if(t[s]&&t[s].id){var i="?",u=r._findStatusChannel(t[s].device,t[s].status);u&&u.address&&t[s].status&&t[s].status.value&&n[u.address]&&(i=r._resolveState(u,t[s].status,n[u.address])),void 0!==i&&null!=i||(i="?"),o.push({id:t[s].id,status:i});}}a&&a(null,o);});}else a&&a(null,[]);}else a&&a(new Error("deviceList is null"));},Central.prototype.refreshStates=function(){var e=this;this._getUpd(function(t,a){!t&&a&&e._updateStatusBuffer(a);});},Central.prototype._findStatusChannel=function(e,t){if(!(e&&e.channels&&t&&t.value))return null;var a=null,r=null;switch(t.value){case"switchState":r="SwitchActuator";break;case"dimLevel":r="DimmerActuator";break;case"blindPos":r="RollerShutterActuator";break;case"humState":r="RoomHumiditySensor";break;case"tempState":r="RoomTemperatureSensor";break;case"tempMode":case"setTempState":r="RoomTemperatureActuator";break;case"alarmState":r="AlarmActuator";break;case"contactState":r="WindowDoorSensor";break;case"smokeState":r="SmokeDetectionSensor";break;case"boolState":case"numState":case"stringState":r="GenericActuator";break;default:return null;}if(!r)return null;for(var n in e.channels){if(e.channels.hasOwnProperty(n)&&e.channels[n]&&e.channels[n].type==r){a=e.channels[n];break;}}return a;},Central.prototype._resolveState=function(e,t,a){if(!(e&&e.type&&t&&t.value&&a&&a.type&&a.state))return null;var r=null;switch(e.type){case"SwitchActuator":"SwitchActuatorState"==a.type&&(r=a.state.state);break;case"DimmerActuator":"DimmerActuatorState"==a.type&&(r=parseInt(a.state.state));break;case"RollerShutterActuator":"RollerShutterActuatorState"==a.type&&(r=parseInt(a.state.state));break;case"RoomHumiditySensor":"RoomHumiditySensorState"==a.type&&(r=parseFloat(a.state.state).toFixed(1));break;case"RoomTemperatureSensor":"RoomTemperatureSensorState"==a.type&&(r=parseFloat(a.state.state).toFixed(1));break;case"RoomTemperatureActuator":"RoomTemperatureActuatorState"==a.type&&("setTempState"==t.value?r=parseFloat(a.state.state).toFixed(1):"tempMode"==t.value&&(r=a.state.mode));break;case"AlarmActuator":"AlarmActuatorState"==a.type&&(r=a.state.state);break;case"WindowDoorSensor":"WindowDoorSensorState"==a.type&&(r=a.state.state);break;case"SmokeDetectionSensor":"SmokeDetectionSensorState"==a.type&&(r=a.state.state);break;case"GenericActuator":a.type==e.data&&(r=a.state.state);break;default:return null;}return r;},Central.prototype.toJSON=function(){return{sys:"rwe",ip:this.ip,port:this.port,username:this.user,password:this.password};},Central.prototype.equalsTo=function(e){return!!e&&e instanceof Central&&this.ip==e.ip&&this.port==e.port&&this.user==e.user&&this.password==e.password;},Central;}(),xnm.aio.rwe.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="RWEDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"rwe",MAP:{SwitchActuator:{command:[{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["on","off"]}}]},DimmerActuator:{command:[{type:"enum",name:"dim down",ref:{value:"dimUp"}},{type:"enum",name:"dim up",ref:{value:"dimDown"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d"}}],status:[{type:"int",name:"dim level",ref:{value:"dimLevel"}}]},RollerShutterActuator:{command:[{type:"enum",name:"move down",ref:{value:"moveUp"}},{type:"enum",name:"move up",ref:{value:"moveDown"}},{type:"int",name:"move to",ref:{value:"moveTo",ext:"%d"}}],status:[{type:"int",name:"blind position",ref:{value:"blindPos"}}]},RoomHumiditySensor:{status:[{type:"float",name:"humidity",ref:{value:"humState"}}]},RoomTemperatureSensor:{status:[{type:"float",name:"temperature",ref:{value:"tempState"}}]},RoomTemperatureActuator:{command:[{type:"enum",name:"auto mode",ref:{value:"tempAuto"}},{type:"enum",name:"manual mode",ref:{value:"tempManu"}},{type:"enum",name:"thermostat off",ref:{value:"tempOff"}},{type:"float",name:"set temperature",ref:{value:"tempTo",ext:"%f",extMeta:"6.0-30.0",scale:"0.5"}}],status:[{type:"enum",name:"thermostat mode",ref:{value:"tempMode",options:["auto","manu"]}},{type:"float",name:"target temperature",ref:{value:"setTempState"}}]},AlarmActuator:{command:[{type:"enum",name:"alarm off",ref:{value:"alarmOff"}},{type:"enum",name:"alarm on",ref:{value:"alarmOn"}},{type:"enum",name:"alarm toggle",ref:{value:"alarmToggle"}}],status:[{type:"enum",name:"alarm status",ref:{value:"alarmState",options:["on","off"]}}]},WindowDoorSensor:{status:[{type:"enum",name:"contact status",ref:{value:"contactState",options:["open","closed"]}}]},SmokeDetectionSensor:{status:[{type:"enum",name:"smoke alarm status",ref:{value:"smokeState",options:["on","off"]}}]},GenericActuator:{BooleanProperty:{command:[{type:"enum",name:"set true",ref:{value:"boolTrue"}},{type:"enum",name:"set false",ref:{value:"boolFalse"}},{type:"enum",name:"boolean toggle",ref:{value:"boolToggle"}}],status:[{type:"enum",name:"boolean state",ref:{value:"boolState",options:["true","false"]}}]},NumericProperty:{command:[{type:"float",name:"set numeric value",ref:{value:"numTo",ext:"%f"}}],status:[{type:"float",name:"numberic state",ref:{value:"numState",options:["true","false"]}}]}}},getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"RWE / innogy SmartHome",port:443}];},getGatewayDeviceType:function getGatewayDeviceType(){return[];},createGateway:function createGateway(e,t,a){var r=DMError,n=DMError.ERROR_CODE;e?e.ip?e.username?e.password?a(null,e):a(new r(n.INVALID,"password is invalid")):a(new r(n.INVALID,"username is invalid")):a(new r(n.INVALID,"ip is invalid")):a(new r(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,r){var n=DMError,o=DMError.ERROR_CODE;t?t.ip?t.username?t.password?r(null,t):r(new n(o.INVALID,"password is invalid")):r(new n(o.INVALID,"username is invalid")):r(new n(o.INVALID,"ip is invalid")):r(new n(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var r=DMError,n=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,s,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){s=i[o];break;}}s?a(null,e):a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.INVALID,"type is invalid"));}else a(new r(n.INVALID,"address is invalid"));}else a(new r(n.INVALID,"gateway is invalid"));}else a(new r(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var r=DMError,n=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,s,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){s=i[o];break;}}s?a(null,e):a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.INVALID,"type is invalid"));}else a(new r(n.INVALID,"address is invalid"));}else a(new r(n.INVALID,"gateway is invalid"));}else a(new r(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var a=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,r=0;r<e.length;r++){if(e[r]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var r=[],n=null,o=a.getCommandStatusMap(e);return o&&(n=function(e,t,a){var r=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(o,0,t),r=r.concat(n)),r;};if(!e)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),r.command=n;break;case"status":n=_filter(e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;},getCommandStatusMap:function getCommandStatusMap(e){if(!e||!e.channels)return null;var t={command:[],status:[]};for(var a in e.channels){var r=e.channels[a];if(r&&r.type&&this.MAP[r.type]){var n=this.MAP[r.type];if("GenericActuator"==r.type&&r.data){var o=r.data.split(":");if(o.length>=2&&n[o[0]])return n[o[0]];}n&&n.command&&(t.command=t.command.concat(n.command)),n&&n.status&&(t.status=t.status.concat(n.status));}}return t;}};}(),xnm.aio.rwe.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Central=xnm.aio.rwe.Central,Handler.prototype.devicemanager=xnm.aio.rwe.DM,Handler.prototype.discoverCentrals=function(e,t){var a=require("x.mdns.js");a.clearRecordBuffer(),a.discoverServiceWithTimeout("_http._tcp.local",e,function(e,a){if(e)t&&t(e);else{for(var r=[],n=0;n<a.length;n++){var o=a[n];if(o.target&&o.ip&&o.ip.length>0&&0==o.target.indexOf("SMARTHOME")){var s=new xnm.aio.rwe.Central(o.ip[0]);r.push(s);}}t&&t(null,r);}});},Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"rwe");},Handler.prototype.resolveGateway=function(e){return e&&e.ip?new this.Central(e.ip,e.port,e.username,e.password):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),r=a?a.command:[];t&&t(null,r);},Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),r=a?a.status:[];t&&t(null,r);},Handler.prototype.doCommand=function(e,t,a,r){var n=this.resolveGateway(e);n?n.executeCommandCreator(t,a,function(e){r&&r(e);}):r&&r(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,r,n){var o=this.resolveGateway(t);if(o){var s=[{id:e,device:a,status:r}];o.getStatesCreator(null,s,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDevices(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.getStateValues=function(e,t){return new xnm.aio.rwe.Central().getStateValues(e.type,t);},Handler.prototype.getDeviceCommandList=function(e,t,a){var r=[];return t?(r.push({id:window.XC_Text.on,cmd:"on"}),r.push({id:window.XC_Text.off,cmd:"off"})):a&&("SwitchActuator"==e.type?(r.push({id:"on",cmd:"on"}),r.push({id:"off",cmd:"off"}),r.push({id:"toggle",cmd:"toggle"})):"DimmerActuator"==e.type?(r.push({id:"off",cmd:"dimTo0"}),r.push({id:"dimTo",cmd:"dimTo",step:"1",min:"0",max:"100"})):"RollerShutterActuator"==e.type?(r.push({id:"moveUp",cmd:"moveTo0"}),r.push({id:"moveDown",cmd:"moveTo100"}),r.push({id:"moveTo",cmd:"moveTo",step:"1",min:"0",max:"100"})):"RoomTemperatureActuator"==e.type?(r.push({id:"setTo",cmd:"tempTo",step:"0.5",min:"6.5",max:"30",fact:"2"}),r.push({id:"off",cmd:"tempTo12"}),r.push({id:"setAuto",cmd:"auto"}),r.push({id:"setManu",cmd:"manu"})):"GenericActuator"==e.type&&("BooleanProperty:Value"==e.data?(r.push({id:"true",cmd:"true"}),r.push({id:"false",cmd:"false"})):"NumericProperty:Brightness"==e.data&&(r.push({id:"off",cmd:"setTo0"}),r.push({id:"setTo",cmd:"setTo",step:"1",min:"0",max:"100"})))),r;},Handler.prototype.finalize=function(e){var t=e;setTimeout(function(){t&&(t(),t=null);},3e3),xnm.aio.rwe.Cache.finalize(function(){t&&(t(),t=null);});},Handler.prototype.pause=function(e){this.finalize(e);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.rwe.Handler());