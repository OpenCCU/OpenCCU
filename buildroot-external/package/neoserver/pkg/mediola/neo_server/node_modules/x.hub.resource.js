function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var x=x||{};x.hub=x.hub||{},x.hub.resource=x.hub.resource||{},x.hub.resource.ResourceManager=function(){var Resource=function Resource(e){this._name=e?e.name:null,this._path=e?e.path:null;};Resource.prototype.getName=function(){return this._name;},Resource.prototype.getPath=function(){return this._path;},Resource.prototype.getURL=function(){},Resource.prototype.toJSON=function(){return{name:this._name,path:this._path};},Resource.parseJSON=function(e){return e&&e.name&&e.path?new Resource(e):null;};var ResourceContainer=function ResourceContainer(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceContainer"),this._rootDataFolder=null,this._resourceFolderName="resources",this._metaFile="resource.json",this._resources=[];};ResourceContainer.prototype.getResourceFolder=function(){return require("path").join(this._rootDataFolder,this._resourceFolderName);},ResourceContainer.prototype.getMetaFilePath=function(){return require("path").join(this.getResourceFolder(),this._metaFile);},ResourceContainer.prototype.init=function(e,t){this._logger.log("info","init resource folder:"+e),this._rootDataFolder=e;var r=this;this._init(function(o){o&&r._logger.log("warn","init resource folder:"+e+" faild:"+o.message),t&&t(o);});},ResourceContainer.prototype.listFiles=function(e){if(!e)return this._resources;for(var t=[],r=0,o=this._resources.length;r<o;r++){var i=this._resources[r];if(i){var s=i.getName();s&&s.substr(0,e.length)==e&&t.push(i);}}return t;},ResourceContainer.prototype.getFilePath=function(e){for(var t=0,r=this._resources.length;t<r;t++){var o=this._resources[t];if(o){var i=o.getName();if(i&&i==e){var s=o.getPath();if(s)return require("path").join(this.getResourceFolder(),s);}}}},ResourceContainer.prototype.getFileURL=function(e,t){for(var r=null,o=0,i=this._resources.length;o<i;o++){var s=this._resources[o];if(s){var n=s.getName();if(n&&n==e){r="http://";var u=this._getLocalIP(t),a=this._getLocalPort();r+=u,a&&(r+=":"+a),r+="/file/"+e;break;}}}return r;},ResourceContainer.prototype.createFile=function(e,t,r){var o=e.split("/"),i=o[o.length-1],s=this._genFilePath(i),n=require("path").relative(this.getResourceFolder(),s),u=this;this._createFile(s,t,function(t,o){if(t)r&&r(t);else{u._logger.log("debug","created : ".concat(e));var i=Resource.parseJSON({name:e,path:n});u._resources.push(i);var s=u._resources2meta(u._resources);u._saveMetaFile(s,function(e){r&&r(e,o);});}});},ResourceContainer.prototype.deleteFile=function(e,t){var r=this.getFilePath(e);if(!r)return this._logger.log("debug","deleted : ".concat(e," is empty ")),void(t&&t());var o=this;this._deleteFile(r,function(r){if(r)t&&t(r);else{for(var i=-1,s=0,n=o._resources.length;s<n;s++){var u=o._resources[s];if(u&&u.getName()==e){i=s;break;}}var a=o._resources.splice(i,1);a&&a[0]&&a[0]._name&&o._logger.log("debug","deleted ".concat(a[0]._name));var l=o._resources2meta(o._resources);o._saveMetaFile(l,function(e){t&&t(e);});}});},ResourceContainer.prototype._init=function(e){var t=this;this._loadMetaFile(function(r,o){r?e&&e(r):(t._resources=t._meta2resources(o),e&&e(null));});},ResourceContainer.prototype._loadMetaFile=function(e){var t=require("fs-extra"),r=this.getMetaFilePath();t.ensureFile(r,function(o){o?e&&e(o):t.readFile(r,{encoding:"utf8"},function(t,r){if(t)e&&e(t);else try{var o=[];r&&(o=JSON.parse(r)),e&&e(null,o);}catch(r){e&&e(t);}});});},ResourceContainer.prototype._meta2resources=function(e){var t=[];if(e)for(var r=0,o=e.length;r<o;r++){if(e[r]){var i=Resource.parseJSON(e[r]);i&&t.push(i);}}return t;},ResourceContainer.prototype._resources2meta=function(e){for(var t=[],r=0,o=e.length;r<o;r++){var i=e[r];i&&t.push(i.toJSON());}return t;},ResourceContainer.prototype._saveMetaFile=function(e,t){var r=require("fs-extra"),o=this.getMetaFilePath(),i=this;r.ensureFile(o,function(s){s?t&&t(s):r.writeFile(o,JSON.stringify(e),function(r){r||e&&"object"==_typeof(e)&&i._logger.log("debug","meta saved ".concat(Object.keys(e).length)),t&&t(r);});});},ResourceContainer.prototype._genFilePath=function(e){for(var t=require("path"),r=t.extname(e),o={},i=0,s=this._resources.length;i<s;i++){var n=this._resources[i];if(n)o[n.getPath()]=!0;}for(var u=1;;){if(!o[u+r])break;u++;}return t.join(this.getResourceFolder(),u+r);},ResourceContainer.prototype._createFile=function(e,t,r){var o=require("fs-extra");o.exists(e,function(i){if(i)try{o.removeSync(e);}catch(e){return void(r&&r(e));}var s=r,n=0,u=o.createWriteStream(e);u.on("error",function(e){s&&(s(e),s=null);}),t.on("data",function(e){n+=e.length;}),t.on("end",function(){s&&(s(null,n),s=null);}),t.on("error",function(e){s&&(s(e),s=null);}),t.pipe(u);});},ResourceContainer.prototype._deleteFile=function(e,t){var r=require("fs-extra");r.exists(e,function(o){o?r.remove(e,function(e){t&&t(e);}):t&&t();});},ResourceContainer.prototype._getLocalIP=function(e){var t=null,r=require("os").networkInterfaces();for(var o in r){for(var i=r[o],s=0;s<i.length;s++){var n=i[s];if(n&&"IPv4"==n.family&&0==n.internal){if(!e)return n.address;if(this._matchSubnetMask(n.address,e,n.netmask))return n.address;t=n.address;}}}return t;},ResourceContainer.prototype._getLocalPort=function(){var e=require("x.hub.js");return e.server?e.server._port:null;},ResourceContainer.prototype._matchSubnetMask=function(e,t,r){var o=this._ip2int(e),i=this._ip2int(t),s=this._ip2int(r);return(o&s)==(i&s);},ResourceContainer.prototype._ip2int=function(e){return e.split(".").reduce(function(e,t){return(e<<8)+parseInt(t,10);},0)>>>0;};var RM=function RM(){this._logger=require("x.logger.js").getLogger("x.hub.resource.ResourceManager"),this._systemDataFolder=null,this._userDataFolder=null,this._sysResourceContainer=null,this._userResourceContainer=null;};return RM.prototype.init=function(e,t){this._logger.log("info","init resource manager"),this._systemDataFolder=e.getAppFolder(),this._userDataFolder=e.getUserRootDataPath(),this._init(t);},RM.prototype.listFiles=function(e){var t={},r=this._sysResourceContainer.listFiles(e);if(r)for(var o=0,i=r.length;o<i;o++){t[r[o].getName()]=!0;}if(r=this._userResourceContainer.listFiles(e))for(o=0,i=r.length;o<i;o++){t[r[o].getName()]=!0;}return Object.keys(t);},RM.prototype.getFilePath=function(e){var t=this._userResourceContainer.getFilePath(e);return t||(t=this._sysResourceContainer.getFilePath(e)),t;},RM.prototype.createFile=function(e,t,r){if("public/system/"!=e.substr(0,14)){if(this.getFilePath(e))return this._logger.log("error","".concat(e," exist, return error")),void(r&&r(new Error("file:"+e+" exists")));this._userResourceContainer.createFile(e,t,r);}else r&&r(new Error("not allow to upload file to public/system/"));},RM.prototype.deleteFile=function(e,t){this._sysResourceContainer.getFilePath(e)?t&&t(new Error("not allow to delete file from system folder")):this._userResourceContainer.deleteFile(e,t);},RM.prototype.getFileURL=function(e,t){var r=this._userResourceContainer.getFileURL(e,t);return r||(r=this._sysResourceContainer.getFileURL(e,t)),r;},RM.prototype._init=function(e){var t=this;this._initSystemResourceContainer(function(r){r?e&&e(r):t._initUserResourceContainer(function(t){e&&e(t);});});},RM.prototype._initSystemResourceContainer=function(e){this._sysResourceContainer=new ResourceContainer(),this._sysResourceContainer.init(this._systemDataFolder,e);},RM.prototype._initUserResourceContainer=function(e){this._userResourceContainer=new ResourceContainer(),this._userResourceContainer.init(this._userDataFolder,e);},RM;}(),x.hub.resource.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.resource.Handler"),this.resourceManager=new x.hub.resource.ResourceManager();};return Handler.prototype.init=function(e,t,r){"CA"==global.HARDWARE_VERSION?this._initHttpApi(e):this._initHttpApiOld(e),this.resourceManager.init(t,function(e){e&&r(e);});},Handler.prototype._initHttpApi=function(e){var t=this,r=require("x.hub.js").getServer();r.addRoute("/file/",{method:"GET",source:1,auth:0},function(e,r,o){var i=e.path.substr(6),s=!1;if(s=!(!i||"public/"!=i.substr(0,7))||e.hasValidAuth,"/"==e.path.charAt(e.path.length-1)){var n;if(i||s){if(i&&"public/"!=i.substr(0,7)&&!s)return void r.json({XC_ERR:{code:"000007",msg:"access denied"}});}else i="public/";n=t.listFiles(i),r.json({XC_SUC:n||[]});}else{if(i&&"public/"!=i.substr(0,7)&&!s)return void r.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});var u=t.getFilePath(i);if(!u)return void r.status(404).json({XC_ERR:{code:"000404",msg:"not found"}});require("fs").exists(u,function(e){e?r.sendFile(u,null,function(e){e&&o(e);}):r.status(404).json({XC_ERR:{code:"000404",msg:"not found"}});});}}),r.addRoute("/file/",{method:"POST",source:1,body:"stream",lock:1},function(e,r){if("/"!=e.path.charAt(e.path.length-1)){var o=e.path.substr(6),i=e.headers["content-length"];i&&parseInt(i)?t.createFile(o,e,function(e,t){e?r.json({XC_ERR:{code:"000101",msg:e.message}}):r.json({XC_SUC:{bytes:t}});}):t.deleteFile(o,function(e){e?r.json({XC_ERR:{code:"000101",msg:e.message}}):r.json({XC_SUC:{}});});}else r.json({XC_ERR:{code:"000101",msg:"no file name"}});});},Handler.prototype._initHttpApiOld=function(e){var t=this,r=require("x.hub.js").getServer();e.get("/file/*",function(e,o,i){var s=e.path.substr(6),n=!1;if(n=!(!s||"public/"!=s.substr(0,7))||r.auth(e),"/"==e.path.charAt(e.path.length-1)){var u;if(s||n){if(s&&"public/"!=s.substr(0,7)&&!n)return void o.json({XC_ERR:{code:"000007",msg:"access denied"}});}else s="public/";u=t.listFiles(s),o.json({XC_SUC:u||[]});}else{if(s&&"public/"!=s.substr(0,7)&&!n)return void o.status(403).json({XC_ERR:{code:"000007",msg:"access denied"}});var a=t.getFilePath(s);if(!a)return void o.status(404).json({XC_ERR:{code:"000404",msg:"not found"}});require("fs").exists(a,function(e){e?o.sendFile(a,null,function(e){e&&i(e);}):o.status(404).json({XC_ERR:{code:"000404",msg:"not found"}});});}}),e.post("/file/*",function(e,o){if(r.auth(e)){if("/"!=e.path.charAt(e.path.length-1)){var i=e.path.substr(6),s=e.headers["content-length"];s&&parseInt(s)?t.createFile(i,e,function(e,t){e?o.json({XC_ERR:{code:"000101",msg:e.message}}):o.json({XC_SUC:{bytes:t}});}):t.deleteFile(i,function(e){e?o.json({XC_ERR:{code:"000101",msg:e.message}}):o.json({XC_SUC:{}});});}else o.json({XC_ERR:{code:"000101",msg:"no file name"}});}else o.json({XC_ERR:{code:"000007",msg:"access denied"}});});},Handler.prototype.listFiles=function(e){return this.resourceManager.listFiles(e);},Handler.prototype.getFilePath=function(e){return this.resourceManager.getFilePath(e);},Handler.prototype.createFile=function(e,t,r){this.resourceManager.createFile(e,t,r);},Handler.prototype.deleteFile=function(e,t){this.resourceManager.deleteFile(e,t);},Handler.prototype.getFileURL=function(e,t){return this.resourceManager.getFileURL(e,t);},Handler;}(),module.exports=new x.hub.resource.Handler();