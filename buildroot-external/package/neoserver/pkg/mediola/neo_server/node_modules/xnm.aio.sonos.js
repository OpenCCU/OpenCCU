var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.sonos=xnm.aio.sonos||{},xnm.aio.sonos.Master=function(){var Master=function Master(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.sonos.Master"):this._logger={log:{}},this._searchCB=[],this._autoSearchTimeout=null,this._tmpPlayers={},this._players={},this._mediaServer={},this._topology=null,this._currentZone=null,this._discovery=new xnm.aio.sonos.Discovery(this),this.search(null);};return Master.prototype.getBufferedPlayers=function(){var e=[];for(var t in this._players){if(this._players.hasOwnProperty(t)){var r=this._players[t];r&&!r.dummy&&r.player&&e.push(r.player);}}return e;},Master.prototype.getBufferedMediaServers=function(){var e,t=[];for(e in this._mediaServer){if(this._mediaServer.hasOwnProperty(e)){var r=this._mediaServer[e];t.push(r);}}for(e in this._players){if(this._players.hasOwnProperty(e)){var n=this._players[e];n&&n.player&&n.player._server&&(n.player._server._sonosServer=!0,t.push(n.player._server));}}return t;},Master.prototype.search=function(e){var t=this._searchCB.length;if(e&&-1==this._searchCB.indexOf(e)&&this._searchCB.push(e),0==t){this._autoSearchTimeout&&(clearTimeout(this._autoSearchTimeout),this._autoSearchTimeout=null),this._search();var r=this;setTimeout(function(){r._autoSearchTimeout=setTimeout(function(){r._logger.log("trace","auto search timeout, search again"),r.search(null);},3e4);var e=r._searchCB;r._searchCB=[],e.forEach(function(e){e&&e();});},5e3);}},Master.prototype._search=function(){for(var e in this._players){if(this._players.hasOwnProperty(e)){var t=this._players[e];t.missCount>=5?delete this._players[e]:t.missCount++;}}this._mediaServer={},this._discovery.search(null);},Master.prototype.findPlayer=function(e){var t=e.uuid;if(t){var r=this._players[t];if(r||(this._players[t]={missCount:0,dummy:!1},r=this._players[t]),r.player)r.player.setIP(e.ip),r.player.setPort(e.port);else{var n,o,a=new xnm.aio.sonos.Player(e.ip,e.port,e.uuid,e.name);if(e.embeddedDevices)for(var u=0;u<e.embeddedDevices.length;u++){var i=e.embeddedDevices[u];i&&"urn:schemas-upnp-org:device:MediaServer:1"==i.deviceType?o=i:i&&"urn:schemas-upnp-org:device:MediaRenderer:1"==i.deviceType&&(n=i);}a._device=e,a._renderer=n,a._server=o,r.player=a;}r.dummy=!1,r.missCount=0;var s=this;r.player.getZoneGroupState(function(e,t,r){!e&&t&&r&&s._updateTopology(t);});}},Master.prototype.findMediaServer=function(e){var t=e.uuid;t&&(this._mediaServer[t]=e);},Master.prototype.getCurrentZone=function(e){if(this._currentZone)e&&e(null,this._currentZone);else{var t=this;this.search(function(r){r?e&&e(r):this._currentZone?t.getCurrentZone(e):e&&e(new Error("no current zone"));});}},Master.prototype.setCurrentZone=function(e,t){if(this._topology){var r=null;for(var n in this._topology){var o=this._topology[n];if(o&&o.id==e){r=o;break;}}if(r&&r.coordinator){var a=this._players[r.coordinator];a?(this._currentZone=JSON.parse(JSON.stringify(r)),this._currentZone.player=a.player,t&&t()):t&&t(new Error("no such player"));}else t&&t(new Error("no such zone"));}else{var u=this;this.search(function(e){e?t&&t(e):this._topology?u.setCurrentZone(t):t&&t(new Error("no player found"));});}},Master.prototype.getZones=function(e){var t=this,r=this.getBufferedPlayers();r&&0!=r.length?e&&e(null,this._topology):this.search(function(r,n){r?e&&e(r):n&&0!=n.length?t.getZones(e):e&&e(new Error("find no sonos player"));});},Master.prototype.getPlayer=function(e){var t=null;if("master"==e.type)return this;if(!e.uuid){if(!e.ip)return null;for(var r in this._players){if(this._players.hasOwnProperty(r)){var n=this._players[r];if(n&&n.player&&n.player.getIP()==e.ip)return n.player;}}return this._tmpPlayers[e.ip]?this._tmpPlayers[e.ip]:(t=new xnm.aio.sonos.Player(e.ip,e.port,e.uuid,e.name),this._tmpPlayers[e.ip]=t,t);}var o=this._players[e.uuid];return o&&o.player?o.player:e.ip?(t=new xnm.aio.sonos.Player(e.ip,e.port,e.uuid,e.name),this._players[e.uuid]={missCount:0,dummy:!0,player:t},t):null;},Master.prototype._updateTopology=function(e){this._topology||(this._topology={});var t=this;e.forEach(function(e){e&&e.id&&(t._topology[e.id]=e);});for(var r,n=!1,o=0;o<e.length;o++){if((r=e[o])&&r.coordinator)if((u=this._players[r.coordinator])&&u.player&&!this._currentZone)return this._currentZone=JSON.parse(JSON.stringify(r)),void(this._currentZone.player=u.player);}if(!n)for(var a=0;a<e.length;a++){var u;if((r=e[o])&&r.coordinator)if((u=this._players[r.coordinator])&&u.player)return this._currentZone=JSON.parse(JSON.stringify(r)),void(this._currentZone.player=u.player);}},Master.prototype.executeCommandCreator=function(e,t,r){if(this._currentZone)this._currentZone.player.executeCommandCreator(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.executeCommandCreator(e,t,r):r&&r(o);});}},Master.prototype.getStatesCreator=function(e,t,r){if(this._currentZone)this._currentZone.player.getStatesCreator(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.getStatesCreator(e,t,r):r&&r(null,[]);});}},Master.prototype.play=function(e,t,r){if(this._currentZone)this._currentZone.player.playObject(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.playObject(e,t,r):r&&r(o);});}},Master.prototype.addToQueueAndPlay=function(e,t,r){if(this._currentZone)this._currentZone.player.addToQueueAndPlay(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.addToQueueAndPlay(e,t,r):r&&r(o);});}},Master.prototype.addToQueue=function(e,t,r){if(this._currentZone)this._currentZone.player.addToQueue(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.addToQueue(e,t,r):r&&r(o);});}},Master.prototype.replaceQueueAndPlay=function(e,t,r){if(this._currentZone)this._currentZone.player.replaceQueueAndPlay(e,t,r);else{var n=this;this.search(function(o){o?r&&r(o):n._currentZone?n._currentZone.player.replaceQueueAndPlay(e,t,r):r&&r(o);});}},Master.prototype.browser=function(e,t,r,n,o){if(this._currentZone)this._currentZone.player.browser(e,t,r,n,o);else{var a=this;this.search(function(u){u?o&&o(u):a._currentZone?a._currentZone.player.browser(e,t,r,n,o):o&&o(u);});}},Master.prototype.clearQueue=function(e,t){if(this._currentZone)this._currentZone.player.clearQueue(t);else{var r=this;this.search(function(n){n?t&&t(n):r._currentZone?r._currentZone.player.clearQueue(e,t):t&&t(n);});}},Master.prototype.toJSON=function(){return{sys:"sonos",type:"master",ip:"xxxxxx",port:0,uuid:"master"};},Master.prototype.equalsTo=function(e){return!!e&&e instanceof Master;},Master;}(),xnm.aio.sonos.Player=function(){var Player=function Player(e,t,r,n){var o=require("x.logger.js");this._logger=o?o.getLogger("xnm.aio.sonos.Player"):{log:function log(){}},this.ip=e,this.port=t,(!t||t<0)&&(this.port=1400),this.uuid=r,this.name=n,this.zoneName=null,this.ip&&this.port&&(this._device=this._getDevice(this.ip,this.port,this.uuid,this.name),this._renderer=this._getRenderer(this.ip,this.port,this.uuid),this._server=this._getServer(this.ip,this.port,this.uuid)),this.CommandHandler=null;};return Player.prototype.PLAY_MODE=["NORMAL","REPEAT_ALL","REPEAT_ONE","SHUFFLE_NOREPEAT","SHUFFLE","SHUFFLE_REPEAT_ONE"],Player.prototype.zoneGroupTopology={type:"urn:schemas-upnp-org:service:ZoneGroupTopology:1",url:"/ZoneGroupTopology/Control"},Player.prototype.groupManagement={type:"urn:schemas-upnp-org:service:GroupManagement:1",url:"/GroupManagement/Control"},Player.prototype._getDevice=function(e,t,r,n){var o=new(require("x.upnp.js").Device)();return o.init(e,t,r,null),o.name=n,o;},Player.prototype._getRenderer=function(e,t,r){if(!e&&this._renderer)return this._renderer;var n=new(require("x.upnp.js").MediaRenderer)();return n.init(e,t,r,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/MediaRenderer/AVTransport/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/MediaRenderer/ConnectionManager/Control"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/MediaRenderer/RenderingControl/Control"},groupRenderingControl:{type:"urn:schemas-upnp-org:service:GroupRenderingControl:1",url:"/MediaRenderer/GroupRenderingControl/Control"},queue:{type:"urn:schemas-sonos-com:service:Queue:1",url:"/MediaRenderer/Queue/Control"}}),n;},Player.prototype._getServer=function(e,t,r){var n=new(require("x.upnp.js").MediaServer)();return n.init(e,t,r,{contentDirectory:{type:"urn:schemas-upnp-org:service:ContentDirectory:1",url:"/MediaServer/ContentDirectory/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/MediaServer/ConnectionManager/Control"}}),n;},Player.prototype.play=function(e){this._getRenderer().play(e);},Player.prototype.pause=function(e){this._getRenderer().pause(e);},Player.prototype.stop=function(e){this._getRenderer().stop(e);},Player.prototype.previous=function(e){this._getRenderer().previous(e);},Player.prototype.next=function(e){this._getRenderer().next(e);},Player.prototype.mute=function(e){this._getRenderer().mute(e);},Player.prototype.unmute=function(e){this._getRenderer().unmute(e);},Player.prototype.isMuted=function(e){this._getRenderer().isMuted(e);},Player.prototype.getVolume=function(e){this._getRenderer().getVolume(e);},Player.prototype.setVolume=function(e,t){this._getRenderer().setVolume(e,t);},Player.prototype.getPlayState=function(e){this._getRenderer().getPlayState(e);},Player.prototype.getInfo=function(e){this._getRenderer().getInfo(e);},Player.prototype.playItem=function(e,t){this._getRenderer().playItem(e,t);},Player.prototype.playPlaylist=function(){var e=require("x.upnp.js"),t=this._getRenderer(),r='<u:SetAVTransportURI xmlns:u="urn:schemas-upnp-org:service:AVTransport:1">';r+="<InstanceID>0</InstanceID>",r+="<CurrentURI>x-rincon-queue:"+t.uuid+"#0</CurrentURI><CurrentURIMetaData></CurrentURIMetaData>",r+="</u:SetAVTransportURI>",new e.SOAPRequest().doRequest(t.getURL(t.AVTransport),'"urn:schemas-upnp-org:service:AVTransport:1#SetAVTransportURI"',r,function(e){t.play();});},Player.prototype.getPlaylist=function(e){var t=require("x.upnp.js"),r=this._getRenderer();new t.SOAPRequest().doRequest(r.getURL("/MediaServer/ContentDirectory/Control"),'"urn:schemas-upnp-org:service:ContentDirectory:1#Browse"','<u:Browse xmlns:u="urn:schemas-upnp-org:service:ContentDirectory:1"><ObjectID>Q:0</ObjectID><BrowseFlag>BrowseDirectChildren</BrowseFlag><Filter>dc:title,res,dc:creator,upnp:artist,upnp:album,upnp:albumArtURI</Filter><StartingIndex>{0}</StartingIndex><RequestedCount>{1}</RequestedCount><SortCriteria></SortCriteria></u:Browse>',function(e){var t=[];e=r._parseSOAPResponse(e,!0);var n=$($.parseXML(e));n&&n.find("item").each(function(){$(this);t.push(r._parseItemMetaData($(this)));});});},Player.prototype.clearPlaylist=function(e){var t=require("x.upnp.js"),r=this._getRenderer();new t.SOAPRequest().doRequest(r.getURL(r.AVTransport),'"urn:schemas-upnp-org:service:AVTransport:1#RemoveAllTracksFromQueue"','<u:RemoveAllTracksFromQueue xmlns:u="urn:schemas-upnp-org:service:AVTransport:1"><InstanceID>0</InstanceID></u:RemoveAllTracksFromQueue>',function(t){e&&e();});},Player.prototype.addToPlaylist=function(e,t){var r=require("x.upnp.js"),n=this._getRenderer(),o='<u:AddURIToQueue xmlns:u="urn:schemas-upnp-org:service:AVTransport:1">';o+="<InstanceID>0</InstanceID>",o+="<EnqueuedURI>"+e+"</EnqueuedURI>",o+="<EnqueuedURIMetaData></EnqueuedURIMetaData><DesiredFirstTrackNumberEnqueued>0</DesiredFirstTrackNumberEnqueued><EnqueueAsNext>1</EnqueueAsNext>",o+="</u:AddURIToQueue>";new r.SOAPRequest().doRequest(n.getURL(n.AVTransport),'"urn:schemas-upnp-org:service:AVTransport:1#AddURIToQueue"',o,function(e){t&&t();});},Player.prototype.setPlaylist=function(e,t){if(e.length>0){var r=e.pop(),n=this;this.addToPlaylist(r.url,function(){n.setPlaylist(e,t);});}else t&&t();},Player.prototype.executeCommand=function(e,t,r){var n=this,o=!0;"play"==t?this.play():"pause"==t?this.pause():"stop"==t?this.stop():"previous"==t?this.previous():"next"==t?this.next():"toggleMute"==t?(o=!1,this.isMuted(function(e){e?n.mute(!1):n.mute(!0),r&&setTimeout(function(){r();},200);})):(o=!1,this.setVolume(Math.floor(parseInt(t)),function(){r&&setTimeout(function(){r();},200);})),o&&r&&setTimeout(function(){r();},200);},Player.prototype.getStates=function(e,t,r){var n=this;this.CommandHandler=e,this.getVolume(function(e){n.isMuted(function(o){n.getPlayState(function(a){var u={volume:e,muted:o,state:a};t&&n.CommandHandler&&n.CommandHandler.setState?(n.CommandHandler.setState(t.id+":volume",e),n.CommandHandler.setState(t.id+":muted",o),n.CommandHandler.setState(t.id+":state",a)):n.CommandHandler&&n.CommandHandler.receivedState&&n.CommandHandler.receivedState("sonos",n.ip,u),n.getInfo(function(e){var t={artist:"",title:""};"PLAYING"==a&&(e.artist?t.artist=e.artist:t.artist="?",e.title?t.title=e.title:t.title="?"),n.CommandHandler&&n.CommandHandler.receivedState&&n.CommandHandler.receivedState("sonos",n.ip,t),r&&(u.title=t.title,u.artist=t.artist,r(u));});});});});},Player.prototype.getStateValues=function(e){return e;},Player.prototype.getIP=function(){return this._device?this._device.ip:null;},Player.prototype.setIP=function(e){this._device&&(this._device.ip=e),this._renderer&&(this._renderer.ip=e),this._server&&(this._server.ip=e);},Player.prototype.getPort=function(){return this._device?this._device.port:null;},Player.prototype.setPort=function(e){this._device&&(this._device.port=e),this._renderer&&(this._renderer.port=e),this._server&&(this._server.port=e);},Player.prototype.getUUID=function(){return this._device?this._device.uuid:null;},Player.prototype.getName=function(){return this._device?this._device.name:null;},Player.prototype.executeCommandCreator=function(e,t,r){t&&t.value?this._executeCommand(t.value,t.ext,function(e){r&&r(e);},t):r&&r(new Error("command value is empty"));},Player.prototype.getStatesCreator=function(e,t,r){for(var n=[],o=this,a=0;a<t.length;a++){var u=t[a];if(u&&u.id&&u.status&&u.status.value){var i=null;switch(u.status.value){case"muted":i="MUTE";break;case"volume":i="VOLUME";break;case"groupMuted":i="GROUP_MUTE";break;case"groupVolume":i="GROUP_VOLUME";break;case"shuffle":case"repeat":i="PLAY_MODE";break;case"loudness":i="LOUDNESS";break;case"bass":i="BASS";break;case"treble":i="TREBLE";break;case"balance":i="BALANCE";break;case"playState":i="PLAY_STATE";break;case"duration":case"durationS":case"position":case"positionS":case"artist":case"title":case"album":case"albumArtURI":i="PLAY_INFO";}i&&-1==n.indexOf(i)&&n.push(i);}}this._getStates(n,function(e,n){if(e&&o._logger.log("trace","["+o.ip+":"+o.port+"]get states error:"+e.stack),n){for(var a=[],u=0;u<t.length;u++){var i=t[u];if(i&&i.id){var s="?";if(i.status)switch(i.status.value){case"muted":null!=n.muted&&void 0!==n.muted&&(s=n.muted);break;case"volume":null!=n.volume&&void 0!==n.volume&&(s=n.volume);break;case"groupMuted":null!=n.groupMuted&&void 0!==n.groupMuted&&(s=n.groupMuted);break;case"groupVolume":null!=n.groupVolume&&void 0!==n.groupVolume&&(s=n.groupVolume);break;case"shuffle":n.playMode&&n.playMode.shuffle&&(s=n.playMode.shuffle);break;case"repeat":n.playMode&&n.playMode.repeat&&(s=n.playMode.repeat);break;case"loudness":n.loudness&&(s=n.loudness);break;case"bass":null!=n.bass&&void 0!==n.bass&&(s=n.bass);break;case"treble":null!=n.treble&&void 0!==n.treble&&(s=n.treble);break;case"balance":null!=n.balance&&void 0!==n.balance&&(s=n.balance);break;case"playState":n.transportState&&(s=n.transportState);break;case"duration":n.playInfo&&n.playInfo.duration&&(s=n.playInfo.duration);break;case"durationS":n.playInfo&&void 0!==n.playInfo.durationSec&&null!=n.playInfo.durationSec&&(s=n.playInfo.durationSec);break;case"position":n.playInfo&&n.playInfo.position&&(s=n.playInfo.position);break;case"positionS":n.playInfo&&void 0!==n.playInfo.positionSec&&null!=n.playInfo.positionSec&&(s=n.playInfo.positionSec);break;case"artist":s=n.playInfo&&n.playInfo.trackMetaData&&n.playInfo.trackMetaData.artist?n.playInfo.trackMetaData.artist:"";break;case"title":s=n.playInfo&&n.playInfo.trackMetaData&&n.playInfo.trackMetaData.title?n.playInfo.trackMetaData.title:"";break;case"album":s=n.playInfo&&n.playInfo.trackMetaData&&n.playInfo.trackMetaData.album?n.playInfo.trackMetaData.album:"";break;case"albumArtURI":s=n.playInfo&&n.playInfo.trackMetaData&&n.playInfo.trackMetaData.albumArtURI?n.playInfo.trackMetaData.albumArtURI:"";}a.push({id:i.id,status:s});}}r&&r(null,a);}else r&&r(new Error("get state error"));});},Player.prototype._executeCommand=function(e,t,r,n){if(this._renderer)switch(e){case"play":this._renderer.play(r);break;case"pause":this._renderer.pause(r);break;case"stop":this._renderer.stop(r);break;case"previous":this._renderer.previous(r);break;case"next":this._renderer.next(r);break;case"mute":this._renderer.mute(r);break;case"unmute":this._renderer.unmute(r);break;case"toggleMute":this._renderer.toggleMute(r);break;case"volume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this._renderer.setVolume(t,r);break;case"volumeUp":this.volumeUp(r);break;case"volumeDown":this.volumeDown(r);break;case"shuffleOn":this.shuffleOn(r);break;case"shuffleOff":this.shuffleOff(r);break;case"shuffleToggle":this.shuffleToggle(r);break;case"repeatOff":this.repeatOff(r);break;case"repeatAll":this.repeatAll(r);break;case"repeatOne":this.repeatOne(r);break;case"repeatSwitch":this.repeatSwitch(r);break;case"groupVolume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this.setGroupVolume(t,r);break;case"groupVolumeUp":this.groupVolumeUp(r);break;case"groupVolumeDown":this.groupVolumeDown(r);break;case"groupMute":this.groupMute(r);break;case"groupUnmute":this.groupUnmute(r);break;case"groupToggleMute":this.groupToggleMute(r);break;case"loudnessOn":this.activateLoudness(r);break;case"loudnessOff":this.deactivateLoudness(r);break;case"toggleLoudness":this.toggleLoudness(r);break;case"bass":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this.setBass(t,r);break;case"bassUp":this.bassUp(r);break;case"bassDown":this.bassDown(r);break;case"treble":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this.setTreble(t,r);break;case"trebleUp":this.trebleUp(r);break;case"trebleDown":this.trebleDown(r);break;case"balance":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this.setBalance(t,r);break;case"balanceLeft":this.balanceToLeft(r);break;case"balanceRight":this.balanceToRight(r);break;case"seekTo":if(void 0===t||null==t)return void(r&&r(new Error("seek value invalid")));this._renderer.seekRelTimeSec(t,r);break;case"playLineIn":this.playLineIn(r);break;case"playUrl":if(void 0===t||null==t)return void(r&&r(new Error("playUrl url invalid")));this.playUrl(t,r);break;default:r&&r(new Error("unknown command"));}else r&&r(new Error("renderer not initialized"));},Player.prototype._getStates=function(e,t){if(this._renderer){if(e&&0!=e.length){var cb=function cb(){0==--n&&t&&t(null,r);},r={},n=e.length;-1!=e.indexOf("PLAY_STATE")&&this._renderer.getPlayState(function(e,t){e||(r.transportState=t),cb();}),-1!=e.indexOf("PLAY_INFO")&&this.getPlayInfo(function(e,t){e||(r.playInfo=t),cb();}),-1!=e.indexOf("MUTE")&&this._renderer.isMuted(function(e,t){e||(r.muted=t),cb();}),-1!=e.indexOf("VOLUME")&&this._renderer.getVolume(function(e,t){e||(r.volume=t),cb();}),-1!=e.indexOf("PLAY_MODE")&&this.getPlayMode(function(e,t){e||(r.playMode=t),cb();}),-1!=e.indexOf("GROUP_MUTE")&&this.isGroupMuted(function(e,t){e||(r.groupMuted=t),cb();}),-1!=e.indexOf("GROUP_VOLUME")&&this.getGroupVolume(function(e,t){e||(r.groupVolume=t),cb();}),-1!=e.indexOf("BALANCE")&&this.getBalance(function(e,t){e||(r.balance=t),cb();}),-1!=e.indexOf("BASS")&&this.getBass(function(e,t){e||(r.bass=t),cb();}),-1!=e.indexOf("TREBLE")&&this.getTeble(function(e,t){e||(r.treble=t),cb();}),-1!=e.indexOf("LOUDNESS")&&this.isLoudnessActive(function(e,t){e||(r.loudness=t?"on":"off"),cb();});}else t&&t(null,{});}else t&&t(new Error("renderer not initialized"));},Player.prototype.playUrl=function(e,t){if(e){var r=this;this._renderer._setAVTransportURI(0,e,null,function(e){e?t&&t(e):r._renderer.play(t);});}else t&&t(new Error("url is null"));},Player.prototype.addUrlToQueueAndPlayThenDelete=function(e,t,r){if(e){t||(t=30);var n=this;this._addURItoQueue(0,e,null,0,!0,function(e,o){e?r&&r(e):o&&void 0!==o.firstTrackNumberEnqueued&&null!=o.firstTrackNumberEnqueued?n._renderer.seekTrack(o.firstTrackNumberEnqueued,function(e){e?r&&r(e):n._renderer.play(function(e){e?r&&r(e):setTimeout(function(){n._removeAllTracks(0,0,function(e){r&&r(e);});},1e3*t);});}):r&&r(new Error("result format invalid"));});}else r&&r(new Error("url is null"));},Player.prototype.playObject=function(e,t,r){if(e&&t&&t["class"]&&t.id){var n=this;e.browseMetaData(t.id,function(e,o){e?r&&r(e):t.res&&t.res.url?n._renderer.playResource({url:t.res.url},o.result,r):r&&r(new Error("resource url invalid"));});}else r&&r(new Error("play obj invalid"));},Player.prototype.addToQueueAndPlay=function(e,t,r){if(e&&t&&t.res&&t.res.url&&t.id){var n=this;t.parentID&&"Q:"==t.parentID.substr(0,2)?this.playFromQueue(e,t,r):e.browseMetaData(t.id,function(e,o){e?r&&r(e):o&&o.meta&&o.meta.res&&"x-sonosapi-stream"==o.meta.res.substr(0,17)?n._renderer.playResource({url:o.meta.res},o.meta.resMD,r):n._addURI(0,0,t.res.url,o.result,0,!0,function(e,t){e?r&&r(e):t&&void 0!==t.firstTrackNumberEnqueued&&null!=t.firstTrackNumberEnqueued?n._renderer.seekTrack(t.firstTrackNumberEnqueued,function(e){e?n.playQueue(r):n._renderer.play(r);}):r&&r(new Error("result format invalid"));});});}else r&&r(new Error("play obj invalid"));},Player.prototype.playQueue=function(e){var t=this;this._renderer._setAVTransportURI(0,"x-rincon-queue:"+this._renderer.uuid+"#0",null,function(r){r?e&&e(r):t._renderer.play(e);});},Player.prototype.playFromQueue=function(e,t,r){if(t.id){var n=t.id.indexOf("/");if(-1!=n){var o=this,a=t.id.substr(n+1);this._renderer.seekTrack(a,function(e){e?o.playQueue(r):o._renderer.play(r);});}else r&&r(new Error("queue object id is invalid"));}else r&&r(new Error("queue object id is null"));},Player.prototype.addToQueue=function(e,t,r){if(e&&t&&t.res&&t.res.url&&t.id){var n=this;e.browseMetaData(t.id,function(e,o){e?r&&r(e):n._addURI(0,0,t.res.url,o.result,0,!0,r);});}else r&&r(new Error("play obj invalid"));},Player.prototype.replaceQueueAndPlay=function(e,t,r){if(e&&t&&t.res&&t.res.url&&t.id){var n=this;e.browseMetaData(t.id,function(e,o){e?r&&r(e):n._removeAllTracks(0,0,function(e){e?r&&r(e):n._addURI(0,0,t.res.url,o.result,0,!0,function(e,t){e?r&&r(e):t&&void 0!==t.firstTrackNumberEnqueued&&null!=t.firstTrackNumberEnqueued?n._renderer.seekTrack(t.firstTrackNumberEnqueued,function(e){e?r&&r(e):n._renderer.play(r);}):r&&r(new Error("result format invalid"));});});});}else r&&r(new Error("play obj invalid"));},Player.prototype.browser=function(e,t,r,n,o){if(e){t||(t=0),r||(r=0),n||(n=0);e.browseChildren(t,r,n,null,function(t,r,n){if(!t&&r)for(var a=0;a<r.length;a++){r[a]&&(r[a].id&&"Q:"==r[a].id.substr(0,2)&&"Q:"==r[a].parentID&&r[a].res&&delete r[a].res,r[a].albumArtURI&&"http://"!=r[a].albumArtURI.substr(0,7)&&(r[a].albumArtURI="http://"+e.ip+":"+e.port+r[a].albumArtURI),r[a].info&&r[a].info.albumArtURI&&"http://"!=r[a].info.albumArtURI.substr(0,7)&&(r[a].info.albumArtURI="http://"+e.ip+":"+e.port+r[a].info.albumArtURI));}o&&o(t,r,n);});}else o&&o(new Error("play obj invalid"));},Player.prototype.getZoneGroupState=function(e){var t=this;this._getZoneGroupState(function(r,n){if(r)e&&e(r);else if(n&&n.zoneGroupState){for(var o=!1,a=0;a<n.zoneGroupState.length;a++){var u=n.zoneGroupState[a];u&&u.coordinator==t.getUUID()&&(o=!0);for(var i=0;i<u.members.length;i++){var s=u.members[i];s&&s.uuid==t.getUUID()&&s.name&&(t.zoneName=s.name);}}e&&e(null,n.zoneGroupState,o);}else e&&e(new Error("unknow zone group state"));});},Player.prototype.getZoneGroupState=function(e){var t=this;this._getZoneGroupState(function(r,n){if(r)e&&e(r);else if(n&&n.zoneGroupState){for(var o=!1,a=0;a<n.zoneGroupState.length;a++){var u=n.zoneGroupState[a];u&&u.coordinator==t.getUUID()&&(o=!0);for(var i=0;i<u.members.length;i++){var s=u.members[i];s&&s.uuid==t.getUUID()&&s.name&&(t.zoneName=s.name);}}e&&e(null,n.zoneGroupState,o);}else e&&e(new Error("unknow zone group state"));});},Player.prototype.playLineIn=function(e){var t=this.getUUID();t?this._renderer.playResource({url:"x-rincon-stream:"+t},"",e):e&&e(new Error("no uuid"));},Player.prototype.clearQueue=function(e,t){var r=0;"Q:1"==e&&(r=1),this._removeAllTracks(r,0,t);},Player.prototype.volumeUp=function(e){this._setRelativeVolume(0,"Master",5,e);},Player.prototype.volumeDown=function(e){this._setRelativeVolume(0,"Master",-5,e);},Player.prototype.getPlayInfo=function(e){if(this._renderer){var t,r,n,cb=function cb(a){o--,a?e&&e(a):0==o&&(t&&"x-sonosapi-stream"==t.substr(0,17)&&r&&n&&n.trackMetaData&&(r["class"]&&(n.trackMetaData["class"]=r["class"]),r.title&&(n.trackMetaData.title=r.title),n.trackMetaData.streamContent&&(n.trackMetaData.artist=n.trackMetaData.streamContent)),n&&n.trackMetaData&&n.trackMetaData.creator&&!n.trackMetaData.artist&&(n.trackMetaData.artist=n.trackMetaData.creator),e&&e(null,n));},o=2,a=this;this._renderer.getPlayInfo(function(e,t){!e&&t&&(t.trackMetaData&&t.trackMetaData.albumArtURI&&"http://"!=t.trackMetaData.albumArtURI.substr(0,7)&&"https://"!=t.trackMetaData.albumArtURI.substr(0,8)&&(t.trackMetaData.albumArtURI="http://"+a._renderer.ip+":"+a._renderer.port+t.trackMetaData.albumArtURI),n=t),cb&&cb(e),e&&(cb=null);}),this._renderer.getMediaInfo(function(e,n){!e&&n&&(t=n.currentURI,r=n.currentURIMetaData),cb&&cb(e),e&&(cb=null);});}else e&&e(new Error("renderer not initialized"));},Player.prototype.getMediaInfo=function(e){this._renderer?this._renderer.getMediaInfo(function(t,r){e&&e(t,r);}):e&&e(new Error("renderer not initialized"));},Player.prototype.getPlayMode=function(e){if(this._renderer){var t=this;this._renderer.getPlayMode(function(r,n){r?e&&e(r):e&&e(null,t._parsePlayMode(n));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.setPlayMode=function(e,t){this._renderer?(e=this._buildPlayMode(e),this._renderer.setPlayMode(e,t)):t&&t(new Error("renderer not initialized"));},Player.prototype._parsePlayMode=function(e){switch(e){case"NORMAL":default:return{shuffle:"off",repeat:"off"};case"REPEAT_ALL":return{shuffle:"off",repeat:"all"};case"REPEAT_ONE":return{shuffle:"off",repeat:"one"};case"SHUFFLE_NOREPEAT":return{shuffle:"on",repeat:"off"};case"SHUFFLE":return{shuffle:"on",repeat:"all"};case"SHUFFLE_REPEAT_ONE":return{shuffle:"on",repeat:"one"};}},Player.prototype._buildPlayMode=function(e){var t=e.shuffle,r=e.repeat;return t||(t="off"),r||(r="off"),"off"==t&&"off"==r?"NORMAL":"off"==t&&"all"==r?"REPEAT_ALL":"off"==t&&"one"==r?"REPEAT_ONE":"on"==t&&"off"==r?"SHUFFLE_NOREPEAT":"on"==t&&"all"==r?"SHUFFLE":"on"==t&&"one"==r?"SHUFFLE_REPEAT_ONE":"NORMAL";},Player.prototype.isGroupMuted=function(e){this._getGroupMute(0,function(t,r){t?e&&e(t):e&&e(null,"1"==r.currentMute);});},Player.prototype.groupMute=function(e){this._setGroupMute(0,!0,function(t,r){t?e&&e(t):e&&e(null,"1"==r.currentMute);});},Player.prototype.groupUnmute=function(e){this._setGroupMute(0,!1,function(t,r){t?e&&e(t):e&&e(null,"1"==r.currentMute);});},Player.prototype.groupToggleMute=function(e){var t=this;this.isGroupMuted(function(r,n){r?e&&e(r):n?t.groupUnmute(e):t.groupMute(e);});},Player.prototype.getGroupVolume=function(e){this._getGroupVolume(0,function(t,r){t?e&&e(t):e&&e(null,parseInt(r.currentVolume));});},Player.prototype.setGroupVolume=function(e,t){(e=parseInt(e))<0&&(e=0),e>100&&(e=100),this._setGroupVolume(0,e,t);},Player.prototype.groupVolumeUp=function(e){this._setRelativeGroupVolume(0,5,e);},Player.prototype.groupVolumeDown=function(e){this._setRelativeGroupVolume(0,-5,e);},Player.prototype.getBalance=function(e){if(this._renderer){var t=100,r=100,n=2,cb=function cb(o){n--,o?e&&e(o):0==n&&e&&e(null,r-t);};this._renderer._getVolume(0,"LF",function(e,r){!e&&r&&(t=parseInt(r.volume)),cb&&cb(e),e&&(cb=null);}),this._renderer._getVolume(0,"RF",function(e,t){!e&&t&&(r=parseInt(t.volume)),cb&&cb(e),e&&(cb=null);});}else e&&e(new Error("renderer not initialized"));},Player.prototype.setBalance=function(e,t){(e=parseInt(e))>100&&(e=100),e<-100&&(e=-100);var r=100,n=100;e<0?n=e+100:e>0&&(r=100-e);var o=2,cb=function cb(e){o--,e?t&&t(e):0==o&&t&&t();};this._renderer._setVolume(0,"LF",r,function(e){cb&&cb(e),e&&(cb=null);}),this._renderer._setVolume(0,"RF",n,function(e){cb&&cb(e),e&&(cb=null);});},Player.prototype.balanceToLeft=function(e){var t=this;this.getBalance(function(r,n){r?e&&e(r):(n=parseInt(n),n-=5,t.setBalance(n,e));});},Player.prototype.balanceToRight=function(e){var t=this;this.getBalance(function(r,n){r?e&&e(r):(n=parseInt(n),n+=5,t.setBalance(n,e));});},Player.prototype.getBass=function(e){this._getBass(0,function(t,r){t?e&&e(t):e&&e(null,parseInt(r.currentBase));});},Player.prototype.setBass=function(e,t){(e=parseInt(e))>10&&(e=10),e<-10&&(e=-10),this._setBass(0,e,t);},Player.prototype.bassUp=function(e){var t=this;this.getBass(function(r,n){r?e&&e(r):(n=parseInt(n),n+=1,t.setBass(n,e));});},Player.prototype.bassDown=function(e){var t=this;this.getBass(function(r,n){r?e&&e(r):(n=parseInt(n),n-=1,t.setBass(n,e));});},Player.prototype.getTeble=function(e){this._getTreble(0,function(t,r){t?e&&e(t):e&&e(null,parseInt(r.currentTreble));});},Player.prototype.setTreble=function(e,t){(e=parseInt(e))>10&&(e=10),e<-10&&(e=-10),this._setTreble(0,e,t);},Player.prototype.trebleUp=function(e){var t=this;this.getTeble(function(r,n){r?e&&e(r):(n=parseInt(n),n+=1,t.setTreble(n,e));});},Player.prototype.trebleDown=function(e){var t=this;this.getTeble(function(r,n){r?e&&e(r):(n=parseInt(n),n-=1,t.setTreble(n,e));});},Player.prototype.isLoudnessActive=function(e){this._getLoudness(0,"Master",function(t,r){t?e&&e(t):e&&e(null,"1"==r.currentLoudness);});},Player.prototype.activateLoudness=function(e){this._setLoudness(0,"Master",!0,e);},Player.prototype.deactivateLoudness=function(e){this._setLoudness(0,"Master",!1,e);},Player.prototype.toggleLoudness=function(e){var t=this;this.isLoudnessActive(function(r,n){r?e&&e(r):n?t.deactivateLoudness(e):t.activateLoudness(e);});},Player.prototype.shuffleOn=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.shuffle="on",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.shuffleOff=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.shuffle="off",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.shuffleToggle=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.shuffle="on"==n.shuffle?"off":"on",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.repeatOff=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.repeat="off",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.repeatOne=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.repeat="one",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.repeatAll=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):(n.repeat="all",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.repeatSwitch=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,n){r?e&&e(r):("off"==n.repeat?n.repeat="all":"all"==n.repeat?n.repeat="one":n.repeat="off",t.setPlayMode(n,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype._setRelativeVolume=function(e,t,r,n){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRelativeVolume",{InstanceID:e,Channel:t,Adjustment:r},function(e,t){if(e)n&&n(e);else{var r={},o=t.find("NewVolume");o.length>0&&(r.newVolume=$(o[0]).text()),n&&n(null,r);}}):n&&n(new Error("renderer not initialized"));},Player.prototype._getGroupMute=function(e,t){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"GetGroupMute",{InstanceID:e},function(e,r){if(e)t&&t(e);else{var n={},o=r.find("CurrentMute");o.length>0&&(n.currentMute=$(o[0]).text()),t&&t(null,n);}}):t&&t(new Error("renderer not initialized"));},Player.prototype._setGroupMute=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"SetGroupMute",{InstanceID:e,DesiredMute:t?"True":"False"},r):r&&r(new Error("renderer not initialized"));},Player.prototype._getGroupVolume=function(e,t){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"GetGroupVolume",{InstanceID:e},function(e,r){if(e)t&&t(e);else{var n={},o=r.find("CurrentVolume");o.length>0&&(n.currentVolume=$(o[0]).text()),t&&t(null,n);}}):t&&t(new Error("renderer not initialized"));},Player.prototype._setGroupVolume=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"SetGroupVolume",{InstanceID:e,DesiredVolume:t},r):r&&r(new Error("renderer not initialized"));},Player.prototype._setRelativeGroupVolume=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.groupRenderingControl.url),this._renderer.groupRenderingControl.type,"SetRelativeGroupVolume",{InstanceID:e,Adjustment:t},function(e,t){if(e)r&&r(e);else{var n={},o=t.find("NewVolume");o.length>0&&(n.newVolume=$(o[0]).text()),r&&r(null,n);}}):r&&r(new Error("renderer not initialized"));},Player.prototype._getBass=function(e,t){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetBass",{InstanceID:e},function(e,r){if(e)t&&t(e);else{var n={},o=r.find("CurrentBass");o.length>0&&(n.currentBase=$(o[0]).text()),t&&t(null,n);}}):t&&t(new Error("renderer not initialized"));},Player.prototype._setBass=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetBass",{InstanceID:e,DesiredBass:t},r):r&&r(new Error("renderer not initialized"));},Player.prototype._getTreble=function(e,t){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetTreble",{InstanceID:e},function(e,r){if(e)t&&t(e);else{var n={},o=r.find("CurrentTreble");o.length>0&&(n.currentTreble=$(o[0]).text()),t&&t(null,n);}}):t&&t(new Error("renderer not initialized"));},Player.prototype._setTreble=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetTreble",{InstanceID:e,DesiredTreble:t},r):r&&r(new Error("renderer not initialized"));},Player.prototype._getLoudness=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetLoudness",{InstanceID:e,Channel:t},function(e,t){if(e)r&&r(e);else{var n={},o=t.find("CurrentLoudness");o.length>0&&(n.currentLoudness=$(o[0]).text()),r&&r(null,n);}}):r&&r(new Error("renderer not initialized"));},Player.prototype._setLoudness=function(e,t,r,n){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetLoudness",{InstanceID:e,Channel:t,DesiredLoudness:r?"True":"False"},n):n&&n(new Error("renderer not initialized"));},Player.prototype._getZoneGroupState=function(e){if(this._renderer){var t=this;this._renderer._doSOAPRequest(this._renderer.getURL(this.zoneGroupTopology.url),this.zoneGroupTopology.type,"GetZoneGroupState",null,function(r,n){if(r)e&&e(r);else{var o={},a=n.find("ZoneGroupState");if(a.length>0){var u=$(a[0]).text();if(u)try{var i=$($.parseXML(u));o.zoneGroupStateRaw=i,o.zoneGroupState=t._parseZoneGroupState(i);}catch(t){return void(e&&e(t));}else o.zoneGroupStateRaw="",o.zoneGroupState=null;}e&&e(null,o);}});}else e&&e(new Error("renderer not initialized"));},Player.prototype._parseZoneGroupState=function(e){var t=[];return e.find("ZoneGroup").each(function(){var e=$(this),r=e.attr("ID"),n=e.attr("Coordinator");if(r&&n){var o={id:r,coordinator:n,members:[]};e.find("ZoneGroupMember").each(function(){var e=$(this),t=e.attr("UUID"),r=e.attr("ZoneName");if(t&&r){var n={uuid:t,name:r};o.members.push(n);}}),t.push(o);}}),t;},Player.prototype._addURItoQueue=function(e,t,r,n,o,a){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.avTransport.url),this._renderer.avTransport.type,"AddURIToQueue",{InstanceID:e,EnqueuedURI:t,EnqueuedURIMetaData:r,DesiredFirstTrackNumberEnqueued:n,EnqueueAsNext:o?"True":"False"},function(e,t){if(e)a&&a(e);else{var r={},n=t.find("FirstTrackNumberEnqueued");n.length>0&&(r.firstTrackNumberEnqueued=$(n[0]).text()),(n=t.find("NumTracksAdded")).length>0&&(r.numTracksAdded=$(n[0]).text()),(n=t.find("NewQueueLength")).length>0&&(r.newQueueLength=$(n[0]).text()),a&&a(null,r);}}):a&&a(new Error("renderer not initialized"));},Player.prototype._addURI=function(e,t,r,n,o,a,u){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.queue.url),this._renderer.queue.type,"AddURI",{QueueID:e,UpdateID:t,EnqueuedURI:r,EnqueuedURIMetaData:n,DesiredFirstTrackNumberEnqueued:o,EnqueueAsNext:a?"True":"False"},function(e,t){if(e)u&&u(e);else{var r={},n=t.find("FirstTrackNumberEnqueued");n.length>0&&(r.firstTrackNumberEnqueued=$(n[0]).text()),(n=t.find("NumTracksAdded")).length>0&&(r.numTracksAdded=$(n[0]).text()),(n=t.find("NewQueueLength")).length>0&&(r.newQueueLength=$(n[0]).text()),u&&u(null,r);}}):u&&u(new Error("renderer not initialized"));},Player.prototype._removeAllTracks=function(e,t,r){this._renderer?this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.queue.url),this._renderer.queue.type,"RemoveAllTracks",{QueueID:e,UpdateID:t},function(e,t){if(e)r&&r(e);else{var n={},o=t.find("NewUpdateID");o.length>0&&(n.newUpdateID=$(o[0]).text()),r&&r(null,n);}}):r&&r(new Error("renderer not initialized"));},Player.prototype.toJSON=function(){return{sys:xnm.aio.sonos.DM.SYS,type:"play",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),model:this._renderer?this._renderer.modelName:null,name:this.getName(),zoneName:this.zoneName};},Player.prototype.equalsTo=function(e){return!!e&&e instanceof Player&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},Player.parseJSON=function(e){return e.ip&&e.port?new Player(e.ip,e.port,e.uuid,e.name):null;},Player;}(),xnm.aio.sonos.Discovery=function(){var Discover=function Discover(e){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.sonos.Discovery"):this._logger={log:{}},this._upnpCB=null,this._listener=e;};return Discover.prototype.search=function(){if(!this._upnpCB){var e=this;this._upnpCB=function(t){e._findUpnpDevice(t);};}var t=require("x.upnp.js").getDiscoveryService();t.addCallback("upnp:rootdevice",this._upnpCB),t.discoverTarget("upnp:rootdevice");},Discover.prototype._findUpnpDevice=function(e){if(e)switch(e.deviceType){case"urn:schemas-upnp-org:device:ZonePlayer:1":this._logger.log("trace","find sonos player"),this._listener&&this._listener.findPlayer(e);break;case"urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+e.name+" @"+e.ip),this._listener&&this._listener.findMediaServer(e);}},Discover;}(),xnm.aio.sonos.DM=function(){var e={master:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"int",name:"group volume",ref:{value:"groupVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"group volume up",ref:{value:"groupVolumeUp"}},{type:"enum",name:"group volume down",ref:{value:"groupVolumeDown"}},{type:"enum",name:"group mute",ref:{value:"groupMute"}},{type:"enum",name:"group unmute",ref:{value:"groupUnmute"}},{type:"enum",name:"group toggle mute",ref:{value:"groupToggleMute"}},{type:"enum",name:"loudness on",ref:{value:"loudnessOn"}},{type:"enum",name:"loudness off",ref:{value:"loudnessOff"}},{type:"enum",name:"toggle loudness",ref:{value:"toggleLoudness"}},{type:"int",name:"set bass",ref:{value:"bass",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"set treble",ref:{value:"treble",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"set balance",ref:{value:"balance",ext:"%d",extMeta:"-100-100",scale:"5"}},{type:"enum",name:"balance to left",ref:{value:"balanceLeft"}},{type:"enum",name:"balance to right",ref:{value:"balanceRight"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",value_t:"seekToSeconds",ext:"%d"}}],status:[{type:"enum",name:"group muted",ref:{value:"groupMuted",options:["true","false"]}},{type:"int",name:"group volume",ref:{value:"groupVolume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"enum",name:"loudness state",ref:{value:"loudness",options:["off","on"]}},{type:"int",name:"bass",ref:{value:"bass",extMeta:"-10-10"}},{type:"int",name:"treble",ref:{value:"treble",extMeta:"-10-10"}},{type:"int",name:"balance",ref:{value:"balance",extMeta:"-100-100"}},{type:"string",name:"play state",ref:{value:"playState",options:["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}},{type:"url",name:"cover",ref:{value:"albumArtURI",type:"url"}}]},play:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"int",name:"volume",ref:{value:"volume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"enum",name:"shuffle on",ref:{value:"shuffleOn"}},{type:"enum",name:"shuffle off",ref:{value:"shuffleOff"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"repeat off",ref:{value:"repeatOff"}},{type:"enum",name:"repeat all",ref:{value:"repeatAll"}},{type:"enum",name:"repeat one",ref:{value:"repeatOne"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}},{type:"int",name:"group volume",ref:{value:"groupVolume",ext:"%d",extMeta:"0-100"}},{type:"enum",name:"group volume up",ref:{value:"groupVolumeUp"}},{type:"enum",name:"group volume down",ref:{value:"groupVolumeDown"}},{type:"enum",name:"group mute",ref:{value:"groupMute"}},{type:"enum",name:"group unmute",ref:{value:"groupUnmute"}},{type:"enum",name:"group toggle mute",ref:{value:"groupToggleMute"}},{type:"enum",name:"loudness on",ref:{value:"loudnessOn"}},{type:"enum",name:"loudness off",ref:{value:"loudnessOff"}},{type:"enum",name:"toggle loudness",ref:{value:"toggleLoudness"}},{type:"int",name:"set bass",ref:{value:"bass",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"bass up",ref:{value:"bassUp"}},{type:"enum",name:"bass down",ref:{value:"bassDown"}},{type:"int",name:"set treble",ref:{value:"treble",ext:"%d",extMeta:"-10-10"}},{type:"enum",name:"treble up",ref:{value:"trebleUp"}},{type:"enum",name:"treble down",ref:{value:"trebleDown"}},{type:"int",name:"set balance",ref:{value:"balance",ext:"%d",extMeta:"-100-100",scale:"5"}},{type:"enum",name:"balance to left",ref:{value:"balanceLeft"}},{type:"enum",name:"balance to right",ref:{value:"balanceRight"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",value_t:"seekToSeconds",ext:"%d"}},{type:"enum",name:"play line-in",ref:{value:"playLineIn"}},{type:"string",name:"play url",ref:{value:"playUrl",ext:"%s"}},{type:"audio",name:"play audio",ref:{value:"playAudio",ext:"%s"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"enum",name:"group muted",ref:{value:"groupMuted",options:["true","false"]}},{type:"int",name:"group volume",ref:{value:"groupVolume",extMeta:"0-100"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}},{type:"enum",name:"loudness state",ref:{value:"loudness",options:["off","on"]}},{type:"int",name:"bass",ref:{value:"bass",extMeta:"-10-10"}},{type:"int",name:"treble",ref:{value:"treble",extMeta:"-10-10"}},{type:"int",name:"balance",ref:{value:"balance",extMeta:"-100-100"}},{type:"enum",name:"play state",ref:{value:"playState",options:["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}},{type:"url",name:"cover",ref:{value:"albumArtURI",type:"url"}}]}},DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="SonosDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"sonos",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Sonos Player",port:1400}];},createDevice:function createDevice(e,t,r){var n=DMError,o=DMError.ERROR_CODE;e?e.type?e.ip?r(null,e):r(new n(o.INVALID,"ip is invalid")):r(new n(o.INVALID,"type is invalid")):r(new n(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=DMError,o=DMError.ERROR_CODE;e?e.type?e.ip?r(null,e):r(new n(o.INVALID,"ip is invalid")):r(new n(o.INVALID,"type is invalid")):r(new n(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},applyUIFilter:function applyUIFilter(e,t,r){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,n=0;n<e.length;n++){if(e[n]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var n=[],o=null,a=xnm.aio.sonos.DM.getCommandStatusMap(e,r);return a&&(o=function(e,t,r){var n=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(a,0,t),n=n.concat(o)),n;};if(!e.sys)return null;var n=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),n.command=o;break;case"status":o=_filter(e,t),n.status=o;break;default:return null;}return o&&0!=o.length?n:null;},getCommandStatusMap:function getCommandStatusMap(t,r){return t.type?e[t.type]:null;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,r,n,o){var a={"%balance%":{value:"balance",ext:"%d",extMeta:"-100-100",scale:"5"},"%bass%":{value:"bass",ext:"%d",extMeta:"-10-10"},"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%seekTo%":{value:"seekTo",value_t:"seekToSeconds",ext:"%d"},"%shuffleToggle%":{value:"shuffleToggle"},"%stop%":{value:"stop"},"%treble%":{value:"treble",ext:"%d",extMeta:"-10-10"}},u={"%balanceState%":{value:"balance",extMeta:"-100-100"},"%bassState%":{value:"bass",extMeta:"-10-10"},"%durationState%":{value:"durationS"},"%durationStringState%":{value:"duration"},"%playState%":{value:"playState",options:["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"]},"%positionState%":{value:"positionS"},"%shuffleState%":{value:"shuffle",options:["on","off"]},"%trebleState%":{value:"treble",extMeta:"-10-10"}};"master"===t.type?(a["%toggleMute%"]={value:"groupToggleMute"},a["%volume%"]={value:"groupVolume",ext:"%d",extMeta:"0-100"},u["%mutedState%"]={value:"groupMuted",options:["true","false"]},u["%volumeState%"]={value:"groupVolume",extMeta:"0-100"}):(a["%toggleMute%"]={value:"toggleMute"},a["%volume%"]={value:"volume",ext:"%d",extMeta:"0-100"},u["%mutedState%"]={value:"muted",options:["true","false"]},u["%volumeState%"]={value:"volume",extMeta:"0-100"});return e._injectToSmartWidgetTemplate(n,["media"],o,a,u,null);}};}(),xnm.aio.sonos.Handler=function(){var Handler=function Handler(){this.detectedPlayers={},this._master=new xnm.aio.sonos.Master();};return Handler.prototype.discoverPlayers=function(e){var t=require("x.upnp.js");if(t){var r=this;t.discoverDevices(function(t){if("sonos"==t.type){var n=new xnm.aio.sonos.Player(t.ip,1400,t.uuid,t.name);r.detectedPlayers[t.uuid]=n,e(n);}});}},Handler.prototype.getStateValues=function(e,t){return new xnm.aio.sonos.Player().getStateValues(t);},Handler.prototype.getDeviceCommandList=function(e,t){var r=[];if(r.push({id:window.XC_Text.pplay,cmd:"play"}),r.push({id:window.XC_Text.ppause,cmd:"pause"}),!t){r.push({id:window.XC_Text.pstop,cmd:"stop"});for(var n=0;n<=100;n+=5){r.push({id:window.XC_Text.volume+" "+n+"%",cmd:""+n});}}return r;},Handler.prototype.getDevice=function(e){return new xnm.aio.sonos.Player(e.address,e.port);},Handler.prototype.devicemanager=xnm.aio.sonos.DM,Handler.prototype.Player=xnm.aio.sonos.Player,Handler.prototype.registModule=function(e){e.register(xnm.aio.sonos.DM.SYS,"sonos");},Handler.prototype.resolveDevice=function(e){return e?this._master.getPlayer(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var r=xnm.aio.sonos.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=r?r.command:[];t&&t(null,n);},Handler.prototype.getDeviceStatus=function(e,t){var r=xnm.aio.sonos.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),n=r?r.status:[];t&&t(null,n);},Handler.prototype.doCommand=function(e,t,r){var n=this.resolveDevice(e);n?n.executeCommandCreator(e,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,r,n){var o=this.resolveDevice(t);if(o){var a=[{id:e,device:t,status:r}];o.getStatesCreator(null,a,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("device json format invalid"));},Handler.prototype.discoverWithTimeout=function(e,t){var r=this;this._master.search(function(){for(var e=r._master.getBufferedPlayers(),n=[],o=0;o<e.length;o++){n.push(e[o]);}n.push(r._master),t&&t(null,n);});},Handler.prototype.getPlayer=function(e,t){if(e&&e.uuid&&e.type){if("master"!=e.type){var r=this._master.getPlayer(e.uuid);if(r)t&&t(null,r);else{var n=this;this._master.search(function(){r=n._master.getPlayer(e.uuid),t&&t(null,r);});}}else t&&t(null,this._master);}else t&&t(new Error("device json invalid"));},Handler.prototype.getMediaServer=function(e){var t=this._master.getBufferedMediaServers();if(0==t.length){var r=this;this._master.search(function(){e&&e(null,r._master.getBufferedMediaServers());});}else e&&e(null,t);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.sonos.Handler());