var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),Logger=require("x.logger.js"),deviceman=require("x.hub.deviceman.js"),fileman=require("x.hub.fileman.js");var x=x||{};x.hub=x.hub||{},x.hub.taskman=x.hub.taskman||{},x.hub.taskman.ERROR_CODE={General_Error:"100000",Pin_Error:"100001"},x.hub.taskman.Cloud=function(){var Cloud=function Cloud(){};return Cloud.prototype.URL="https://webservice.mediola.com",Cloud.prototype._doRequest=function(t,e,r,i,a,s,o){var n=require("url").parse(this.URL+e),l={host:n.hostname,port:n.port,path:n.path,method:t,headers:i};(a||s)&&(l.auth=(a||"")+":"+(s||""));var h=require("http");"https:"==n.protocol?(h=require("https"),process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),l.port||(l.port=443)):l.port||(l.port=80);var u=o,c=h.request(l,function(t){var e="";t.on("data",function(t){e+=t;}),t.on("end",function(){var r=null;200!=t.statusCode&&(r=new Error("http response error")),u&&u(r,e,t.statusCode,t.headers);});});c.setTimeout(5e3,function(){u&&u(new Error("timeout")),u=null;}),c.on("error",function(t){u&&u(t),u=null;}),r&&c.write(r),c.end();},Cloud;}(),x.hub.taskman._Util={TimeZone_MAP:[{utc:0,dst:!1,zone:"Etc/UTC"},{utc:0,dst:!0,zone:"CET"},{utc:1,dst:!1,zone:"Etc/GMT-1"},{utc:1,dst:!0,zone:"Europe/Berlin"},{utc:2,dst:!1,zone:"Etc/GMT-2"},{utc:2,dst:!0,zone:"EET"},{utc:3,dst:!1,zone:"Etc/GMT-3"},{utc:3,dst:!0,zone:"Asia/Tehran"},{utc:4,dst:!1,zone:"Etc/GMT-4"},{utc:4,dst:!0,zone:"Asia/Kabul"},{utc:5,dst:!1,zone:"Etc/GMT-5"},{utc:5,dst:!0,zone:"Etc/GMT-5"},{utc:6,dst:!1,zone:"Etc/GMT-6"},{utc:6,dst:!0,zone:"Etc/GMT-6"},{utc:7,dst:!1,zone:"Etc/GMT-7"},{utc:7,dst:!0,zone:"Asia/Hovd"},{utc:8,dst:!1,zone:"Etc/GMT-8"},{utc:8,dst:!0,zone:"Asia/Ulaanbaatar"},{utc:9,dst:!1,zone:"Etc/GMT-9"},{utc:9,dst:!0,zone:"Australia/Adelaide"},{utc:10,dst:!1,zone:"Etc/GMT-10"},{utc:10,dst:!0,zone:"Australia/Sydney"},{utc:11,dst:!1,zone:"Etc/GMT-11"},{utc:11,dst:!0,zone:"Etc/GMT-11"},{utc:12,dst:!1,zone:"Etc/GMT-12"},{utc:12,dst:!0,zone:"Pacific/Auckland"},{utc:13,dst:!1,zone:"Etc/GMT-13"},{utc:13,dst:!0,zone:"Pacific/Apia"},{utc:14,dst:!1,zone:"Etc/GMT-14"},{utc:14,dst:!0,zone:"Etc/GMT-14"},{utc:-1,dst:!1,zone:"Etc/GMT+1"},{utc:-1,dst:!0,zone:"Etc/GMT+1"},{utc:-2,dst:!1,zone:"Etc/GMT+2"},{utc:-2,dst:!0,zone:"Etc/GMT+2"},{utc:-3,dst:!1,zone:"Etc/GMT+3"},{utc:-3,dst:!0,zone:"America/Sao_Paulo"},{utc:-4,dst:!1,zone:"Etc/GMT+4"},{utc:-4,dst:!0,zone:"America/Santiago"},{utc:-5,dst:!1,zone:"Etc/GMT+5"},{utc:-5,dst:!0,zone:"America/New_York"},{utc:-6,dst:!1,zone:"Etc/GMT+6"},{utc:-6,dst:!0,zone:"CST6CDT"},{utc:-7,dst:!1,zone:"Etc/GMT+7"},{utc:-7,dst:!0,zone:"MST7MDT"},{utc:-8,dst:!1,zone:"Etc/GMT+8"},{utc:-8,dst:!0,zone:"PST8PDT"},{utc:-9,dst:!1,zone:"Etc/GMT+9"},{utc:-9,dst:!0,zone:"America/Anchorage"},{utc:-10,dst:!1,zone:"Etc/GMT+10"},{utc:-10,dst:!0,zone:"America/Adak"},{utc:-11,dst:!1,zone:"Etc/GMT+11"},{utc:-11,dst:!0,zone:"Etc/GMT+11"}],_getTimeZone:function _getTimeZone(){if("CA"==global.HARDWARE_VERSION||"A1"==global.HARDWARE_VERSION)return require("x.hub.js").getServer().getTimezoneSync();var t="8C";localStorage.getItem("x.hub.Server.timezone")&&(t=localStorage.getItem("x.hub.Server.timezone"));var e=0!=(128&(t=parseInt(t,16))),r=(31&t)-11,i=null;return this.TimeZone_MAP.forEach(function(t){t.utc==r&&t.dst==e&&(i=t.zone);}),i||(i="Europe/Berlin"),i;},_getlatlong:function _getlatlong(){if("CA"==global.HARDWARE_VERSION){var t="020D",e="0087";return localStorage.getItem("x.hub.Server.geo.lat")&&(t=localStorage.getItem("x.hub.Server.geo.lat")),localStorage.getItem("x.hub.Server.geo.long")&&(e=localStorage.getItem("x.hub.Server.geo.long")),(t=parseInt(t,16))>32768&&(t=32768-t),t/=10,(e=parseInt(e,16))>32768&&(e=32768-e),{lat:t,"long":e/=10};}t="1392",e="035C";return localStorage.getItem("x.hub.Server.geo.lat")&&(t=localStorage.getItem("x.hub.Server.geo.lat")),localStorage.getItem("x.hub.Server.geo.long")&&(e=localStorage.getItem("x.hub.Server.geo.long")),(t=parseInt(t,16))>32768&&(t=32768-t),t/=100,(e=parseInt(e,16))>32768&&(e=32768-e),{lat:t,"long":e/=100};}},x.hub.taskman._TimerManager=function(){var CronTimer=function CronTimer(t,e){this._logger=require("x.logger.js").getLogger("x.hub.taskman._TimerManager.CronTimer"),this.taskID=t,this.timer=e,this._cronJob=null;};CronTimer.prototype.start=function(){if(this.timer.time){var t=[],e=this.timer.time.indexOf(":"),r=this.timer.time.substr(0,e),i=this.timer.time.substr(e+1);t.push("00"),t.push(i),t.push(r),t.push("*"),t.push("*");var a="0-6";if(this.timer.week&&7==this.timer.week.length){var s=[];"1"==this.timer.week.charAt(6)&&s.push(0);for(var o=0;o<6;o++){"1"==this.timer.week.charAt(o)&&s.push(o+1);}a=s.join(",");}t.push(a);var n=t.join(" "),l=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer)),this._logger.log("trace","start cron job:"+n+" tz:"+l);try{var h=require("cron").CronJob;this._cronJob=new h(n,this.onTick.bind(this),null,!0,l);}catch(t){throw this._logger.log("error",t.message),t;}}},CronTimer.prototype.stop=function(){this._logger.log("debug","#"+this.taskID+" stop timer:"+JSON.stringify(this.timer)),this._cronJob&&(this._cronJob.stop(),this._cronJob=null);},CronTimer.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" timer tick:"+JSON.stringify(this.timer));var t=require("moment-timezone"),e=x.hub.taskman._Util._getTimeZone(),r=new Date().getTime(),i=(r=t.tz(r,e)).year(),a=!1,s=!1,o=null,n=null,l=r.valueOf(),h=this.timer.start;h&&("00"==h.substr(0,2)&&(a=!0,h=i+h.substr(2)),(h=t.tz(h,e)).set({hour:0,minute:0,second:0,millisecond:0}),o=h.valueOf());var u=this.timer.end;if(u&&("00"==u.substr(0,2)&&(s=!0,u=i+u.substr(2)),(u=t.tz(u,e)).set({hour:23,minute:59,second:59,millisecond:999}),n=u.valueOf()),a&&s&&o>n){if(n<l&&o>l)return;}else if(h&&o>l||u&&n<l)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID);},CronTimer.prototype.onLocationChange=function(){this.stop(),this.start();},CronTimer.prototype.onTimeChange=function(){this.stop(),this.start();};var M=function M(){this._timers=[];};return M.prototype.startTimer=function(t,e){var r=new CronTimer(t,e);this._timers.push(r),r.start();},M.prototype.stopTimer=function(t){var e=[];this._timers.forEach(function(r){r.taskID==t?r.stop():e.push(r);}),this._timers=e;},M.prototype.onLocationChange=function(){this._timers.forEach(function(t){t.onLocationChange();});},M.prototype.onTimeChange=function(){this._timers.forEach(function(t){t.onTimeChange();});},M.prototype.clear=function(){var t=this._timers;this._timers=[],t.forEach(function(t){t.stop();});},new M();}(),x.hub.taskman._AstroManager=function(){var AstroTimer=function AstroTimer(t,e){this._logger=require("x.logger.js").getLogger("x.hub.taskman._AstroManager.AstroTimer"),this.taskID=t,this.astro=e,this._job=null;};AstroTimer.prototype.start=function(){this.astro.astro&&(this._logger.log("debug","#"+this.taskID+" start astro:"+JSON.stringify(this.astro)),this._startNextTick());},AstroTimer.prototype.stop=function(){this._logger.log("debug","stop astro:"+JSON.stringify(this.astro)),this._job&&(clearTimeout(this._job),this._job=null);},AstroTimer.prototype._startNextTick=function(){var t=this._getNextTickTime();this._logger.log("debug","#"+this.taskID+" next "+this.astro.astro+":"+new Date(t));var e=new Date().getTime(),r=this;this._job=setTimeout(function(){try{r.onTick();}catch(t){}r._startNextTick();},t-e);},AstroTimer.prototype._getNextTickTime=function(){var t=x.hub.taskman._Util._getlatlong(),e=require("suncalc"),r=new Date(),i=e.getTimes(r,t.lat,t["long"]),a=null;if(a=(a="sunrise"==this.astro.astro?i.sunrise:i.sunset).getTime(),this.astro.delay&&(a+=60*parseInt(this.astro.delay)*1e3),a<=r.getTime()){var s=new Date(r.getTime()+864e5);i=e.getTimes(s,t.lat,t["long"]),a=(a="sunrise"==this.astro.astro?i.sunrise:i.sunset).getTime(),this.astro.delay&&(a+=60*parseInt(this.astro.delay)*1e3);}return a;},AstroTimer.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" astro tick:"+JSON.stringify(this.astro));var t=require("moment-timezone"),e=x.hub.taskman._Util._getTimeZone(),r=new Date().getTime(),i=(r=t.tz(r,e)).year();if(this.astro.offTime){var a=this.astro.offTime.indexOf(":"),s=this.astro.offTime.substr(0,a),o=this.astro.offTime.substr(a+1);if(s=parseInt(s),o=parseInt(o),r.hour()<s)return;if(r.hour()==s&&r.minute()<=o)return;}var n=r.day();if(0==n&&(n=7),!this.astro.week||7!=this.astro.week.length||"0"!=this.astro.week.charAt(n-1)){var l=!1,h=!1,u=null,c=null,g=r.valueOf(),p=this.astro.start;p&&("00"==p.substr(0,2)&&(l=!0,p=i+p.substr(2)),(p=t.tz(p,e)).set({hour:0,minute:0,second:0,millisecond:0}),u=p.valueOf());var m=this.astro.end;if(m&&("00"==m.substr(0,2)&&(h=!0,m=i+m.substr(2)),(m=t.tz(m,e)).set({hour:23,minute:59,second:59,millisecond:999}),c=m.valueOf()),l&&h&&u>c){if(c<g&&u>g)return;}else if(p&&u>g||m&&c<g)return;require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.astro));}},AstroTimer.prototype.onLocationChange=function(){this.stop(),this.start();},AstroTimer.prototype.onTimeChange=function(){this.stop(),this.start();};var M=function M(){this._timers=[];};return M.prototype.startTimer=function(t,e){var r=new AstroTimer(t,e);this._timers.push(r),r.start();},M.prototype.stopTimer=function(t){var e=[];this._timers.forEach(function(r){r.taskID==t?r.stop():e.push(r);}),this._timers=e;},M.prototype.onLocationChange=function(){this._timers.forEach(function(t){t.onLocationChange();});},M.prototype.onTimeChange=function(){this._timers.forEach(function(t){t.onTimeChange();});},M.prototype.clear=function(){var t=this._timers;this._timers=[],t.forEach(function(t){t.stop();});},M.prototype.getSunriseSunset=function(t){var e=require("moment-timezone"),r=x.hub.taskman._Util._getTimeZone(),i=e.tz(t,r);i.set({hour:12,minute:0,second:0,millisecond:0});var a=x.hub.taskman._Util._getlatlong();return require("suncalc").getTimes(i.toDate(),a.lat,a["long"]);},new M();}(),x.hub.taskman._PeriodicTimerManager=function(){var CronTimer=function CronTimer(t,e){this._logger=require("x.logger.js").getLogger("x.hub.taskman._PeriodicTimerManager.CronTimer"),this.taskID=t,this.timer=e,this._starter=null,this._cronJob=null,this._repeater=null;};CronTimer.prototype.start=function(){if(this.timer.interval){var t=this.timer.startTime,e=this.timer.endTime;t||(t="00:00"),e||(e="23:59");var r=[],i=t.indexOf(":"),a=t.substr(0,i),s=t.substr(i+1);r.push("00"),r.push(s),r.push(a),r.push("*"),r.push("*");var o="0-6";if(this.timer.week&&7==this.timer.week.length){var n=[];"1"==this.timer.week.charAt(6)&&n.push(0);for(var l=0;l<6;l++){"1"==this.timer.week.charAt(l)&&n.push(l+1);}o=n.join(",");}r.push(o);var h=r.join(" "),u=x.hub.taskman._Util._getTimeZone();this._logger.log("debug","#"+this.taskID+" start timer:"+JSON.stringify(this.timer)),this._logger.log("trace","start cron job:"+h+" tz:"+u);try{var c=require("cron").CronJob;this._cronJob=new c(h,this.onFirstTick.bind(this),null,!0,u);}catch(t){throw this._logger.log("error",t.message),t;}var g=require("moment-timezone"),p=new Date().getTime(),m=g.tz(p,u),f=m.year(),_=!1,d=!1,v=null,y=null,k=m.valueOf(),T=this.timer.start;T&&("00"==T.substr(0,2)&&(_=!0,T=f+T.substr(2)),(T=g.tz(T,u)).set({hour:0,minute:0,second:0,millisecond:0}),v=T.valueOf());var w=this.timer.end;if(w&&("00"==w.substr(0,2)&&(d=!0,w=f+w.substr(2)),(w=g.tz(w,u)).set({hour:23,minute:59,second:59,millisecond:999}),y=w.valueOf()),_&&d&&v>y){if(y<k&&v>k)return;}else if(T&&v>k||w&&y<k)return;var E=this.timer.week;if(E){var A=m.isoWeekday();if(A-=1,"1"!=E.charAt(A))return;}var S=g.tz(p,u);if(i=t.indexOf(":"),a=t.substr(0,i),s=t.substr(i+1),S.set({hour:parseInt(a),minute:parseInt(s),second:0,millisecond:0}),!(S.valueOf()>m.valueOf())){var b=g.tz(p,u);if(i=e.indexOf(":"),a=e.substr(0,i),s=e.substr(i+1),b.set({hour:parseInt(a),minute:parseInt(s),second:0,millisecond:0}),!(b.valueOf()<m.valueOf())){var O=this.timer.interval;if(O){O=1e3*parseInt(O);var D=Math.ceil((m.valueOf()-S.valueOf())/O)*O+S.valueOf()-m.valueOf();this._logger.log("trace","first tick in "+D/1e3+" seconds");var N=this;this._starter=setTimeout(function(){N.onFirstTick();},D);}}}}},CronTimer.prototype.stop=function(){this._logger.log("debug","stop timer:"+JSON.stringify(this.timer)),this._cronJob&&(this._cronJob.stop(),this._cronJob=null),this._repeater&&(clearInterval(this._repeater),this._repeater=null),this._starter&&(clearTimeout(this._starter),this._starter=null);},CronTimer.prototype.onFirstTick=function(){this._logger.log("debug","periodic timer first tick:"+JSON.stringify(this.timer));var t=this.timer.interval;if(t){t=1e3*parseInt(t);var e=this;this._starter&&(clearTimeout(this._starter),this._starter=null),this._repeater&&(clearInterval(this._repeater),this._repeater=null),this._repeater=setInterval(function(){e.onTick();},t),this.onTick();}},CronTimer.prototype.onTick=function(){this._logger.log("debug","#"+this.taskID+" periodic timer tick:"+JSON.stringify(this.timer));var t=require("moment-timezone"),e=this.timer.interval;e=1e3*parseInt(e);var r=x.hub.taskman._Util._getTimeZone(),i=new Date().getTime(),a=i+e,s=t.tz(i,r),o=(i=t.tz(i,r)).year(),n=!1,l=!1,h=null,u=null,c=i.valueOf(),g=this.timer.start;g&&("00"==g.substr(0,2)&&(n=!0,g=o+g.substr(2)),(g=t.tz(g,r)).set({hour:0,minute:0,second:0,millisecond:0}),h=g.valueOf());var p=this.timer.end;if(p&&("00"==p.substr(0,2)&&(l=!0,p=o+p.substr(2)),(p=t.tz(p,r)).set({hour:23,minute:59,second:59,millisecond:999}),u=p.valueOf()),n&&l&&h>u){if(u<c&&h>c)return;}else if(g&&h>c||p&&u<c)return;var m=this.timer.endTime;m||(m="23:59");var f=m.indexOf(":"),_=m.substr(0,f),d=m.substr(f+1);if(s.set({hour:parseInt(_),minute:parseInt(d),second:59,millisecond:999}),s.valueOf()<i.valueOf())return this._logger.log("trace","repeater exceed end time:"+s.toString()),void(this._repeater&&(clearInterval(this._repeater),this._repeater=null));a>s.valueOf()&&(this._logger.log("trace","repeater next tick will exceed end time:"+s.toString()),this._repeater&&(clearInterval(this._repeater),this._repeater=null)),require("x.hub.taskman.js").taskManager.onTimerTick(this.taskID,JSON.stringify(this.timer));},CronTimer.prototype.onLocationChange=function(){this.stop(),this.start();},CronTimer.prototype.onTimeChange=function(){this.stop(),this.start();};var M=function M(){this._timers=[];};return M.prototype.startTimer=function(t,e){var r=new CronTimer(t,e);this._timers.push(r),r.start();},M.prototype.stopTimer=function(t){var e=[];this._timers.forEach(function(r){r.taskID==t?r.stop():e.push(r);}),this._timers=e;},M.prototype.onLocationChange=function(){this._timers.forEach(function(t){t.onLocationChange();});},M.prototype.onTimeChange=function(){this._timers.forEach(function(t){t.onTimeChange();});},M.prototype.clear=function(){var t=this._timers;this._timers=[],t.forEach(function(t){t.stop();});},new M();}(),x.hub.taskman._Block=function(){var Block=function Block(t){this.type=t,this._parent=null,this._running=!1,this._canceling=!1,this._trace=null;};Block.prototype.isRunning=function(){return this._running;},Block.prototype["do"]=function(t){t&&t();},Block.prototype.cancel=function(t){var e=this._running;this._running=!1,this._canceling=!1,t&&t(null,e);},Block.prototype.toJSON=function(){return{type:this.type};},Block.prototype.fromJSON=function(){},Block.prototype.setTrace=function(t){this._trace=t;};var Condition=function Condition(){Block.call(this),this.type=Condition.TYPE,this.subtype=null,this.flowIf=[],this.flowThen=[],this.flowElse=[];};util.inherits(Condition,Block),Condition.TYPE="condition",Condition.prototype.isRunning=function(){var t=!1;return this.flowIf&&this.flowIf.forEach(function(e){e&&e.isRunning&&(t|=e.isRunning());}),this.flowThen&&this.flowThen.forEach(function(e){e&&e.isRunning&&(t|=e.isRunning());}),this.flowElse&&this.flowElse.forEach(function(e){e&&e.isRunning&&(t|=e.isRunning());}),!!t;},Condition.prototype["do"]=function(t,e){var r=this;this._trace&&this._trace.log('condition | check "if"'),this._checkIfBlocks(function(i,a){r._trace&&r._trace.log('condition | check "if" - '+(i?"error:"+i.message:a)),i?t&&t(i):a?(r._trace&&r._trace.log('condition | do "then"'),r._doThenBlocks(t,e)):(r._trace&&r._trace.log('condition | do "else"'),r._doElseBlocks(t,e));},e);},Condition.prototype.cancel=function(t){this.flowIf&&this.flowIf.length,this.flowThen&&this.flowThen.length,this.flowElse&&this.flowElse.length;this.flowIf&&this.flowIf.forEach(function(t){t&&t.cancel?t.cancel():0;}),this.flowThen&&this.flowThen.forEach(function(t){t&&t.cancel?t.cancel():0;}),this.flowElse&&this.flowElse.forEach(function(t){t&&t.cancel?t.cancel():0;});},Condition.prototype.toJSON=function(){var t={type:this.type,subtype:this.subtype,"if":[],then:[],"else":[]};return this.flowIf&&this.flowIf.forEach(function(e){e&&t["if"].push(e.toJSON());}),this.flowThen&&this.flowThen.forEach(function(e){e&&t.then.push(e.toJSON());}),this.flowElse&&this.flowElse.forEach(function(e){e&&t["else"].push(e.toJSON());}),t;},Condition.prototype.fromJSON=function(t){if(t){var e=this;this.subtype=t.subtype,t["if"]&&t["if"].length>0&&t["if"].forEach(function(t){if(t){var r=Block.parse(t);r&&(r._parent=e,e.flowIf.push(r));}}),t.then&&t.then.length>0&&t.then.forEach(function(t){if(t){var r=Block.parse(t);r&&e.flowThen.push(r);}}),t["else"]&&t["else"].length>0&&t["else"].forEach(function(t){if(t){var r=Block.parse(t);r&&e.flowElse.push(r);}});}},Condition.prototype._checkIfBlocks=function(t,e){var r=[],i=0,a=this;if(this.flowIf&&0!=this.flowIf.length){var cb=function cb(s,o){if(i++,s?r.push(!1):r.push(o),i<a.flowIf.length)a.flowIf[i]["do"](cb,e);else if(0==r.length)t&&t(null,!0);else{for(var n=1,l=r[0];n<r.length&&n+1!=r.length;){"AND"==r[n]?l&=r[n+1]:"OR"==r[n]?l|=r[n+1]:"XOR"==r[n]&&(l=l!=r[n+1]),n+=2;}t&&t(null,l);}};this.flowIf[i]["do"](cb,e);}else t&&t(null,!0);},Condition.prototype._doThenBlocks=function(t,e){var r=0,i=this;if(this.flowThen&&0!=this.flowThen.length){var cb=function cb(){++r<i.flowThen.length?i.flowThen[r]["do"](cb,e):t&&t();};this.flowThen[r]["do"](cb,e);}else t&&t();},Condition.prototype._doElseBlocks=function(t,e){var r=0,i=this;if(this.flowElse&&0!=this.flowElse.length){var cb=function cb(){++r<i.flowElse.length?i.flowElse[r]["do"](cb,e):t&&t();};this.flowElse[r]["do"](cb,e);}else t&&t();},Condition.prototype.setTrace=function(t){this._trace=t,this.flowIf&&this.flowIf.forEach(function(e){e&&e.setTrace&&e.setTrace(t);}),this.flowThen&&this.flowThen.forEach(function(e){e&&e.setTrace&&e.setTrace(t);}),this.flowElse&&this.flowElse.forEach(function(e){e&&e.setTrace&&e.setTrace(t);});},Block.Condition=Condition;var Root=function Root(){Condition.call(this),this.type=Block.Root.TYPE,this._taskID=null,this._lastTiggerTime=null,this.singleton=!1,this.singletonMethod="ignore",this._task=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Root");};util.inherits(Root,Condition),Root.TYPE="root",Root.prototype.init=function(t){this._taskID=t,this.flowIf.forEach(function(e){e&&e.init&&e.init(t);});},Root.prototype.finalize=function(t){this.flowIf.forEach(function(e){e&&e.finalize&&e.finalize(t);});},Root.prototype.getTriggers=function(){return this.flowIf?this.flowIf:[];},Root.prototype._onTriggered=function(t,e){var r=new Date().getTime();if(!(this._lastTiggerTime&&r-this._lastTiggerTime<400)){if(this.singleton&&this._running){if("ignore"==this.singletonMethod)return this._logger.log("debug","task "+this._taskID+" is running and ignore the new trigger"),void(t&&t());this._logger.log("debug","task "+this._taskID+" is running and cancel it"),this.cancel();}this._logger.log("info","task "+this._taskID+" triggered"),this._logger.log("trace","task "+this._taskID+" is "+(this._running?"running":"not running")),this._lastTiggerTime=r,this._trace&&this._trace.log("root | task:"+this._taskID+" triggered"),this._running=!0;var i=this;this._doThenBlocks(function(){i._running=!1,t&&t();},{trigger:e,task:this._task});}},Root.prototype.onStatusEvt=function(t){var e=!1;this._logger.log("trace","check trigger for status event");for(var r=null,i=0;i<this.flowIf.length;i++){var a=this.flowIf[i];if((a.type==DeviceStatus.TYPE||a.type==DominoswissWS.TYPE)&&a.isMatch(t)){this._logger.log("debug","trigger hit:"+JSON.stringify(a.toJSON())),e=!0,r=a;break;}}e&&this._onTriggered(null,r);},Root.prototype.onDedicatedStatusEvt=function(t){var e=!1;this._logger.log("trace","check trigger for status event");for(var r=null,i=0;i<this.flowIf.length;i++){var a=this.flowIf[i];if(a.type==DeviceStatus.TYPE){if(a.isMatch(t)){this._logger.log("debug","trigger hit:"+JSON.stringify(a.toJSON())),e=!0,r=a;break;}}else if(a.type==DominoswissWS.TYPE&&a.isMatch(t)){this._logger.log("debug","trigger hit:"+JSON.stringify(a.toJSON())),e=!0,r=a;break;}}e&&this._onTriggered(null,r);},Root.prototype.onIREvt=function(t){this._trace&&this._trace.log("root | receive ir event:"+JSON.stringify(t));var e=!1;this._logger.log("trace","check trigger for ir event");for(var r=0;r<this.flowIf.length;r++){var i=this.flowIf[r];if(i.type==IRTrigger.TYPE&&i.isMatch(t)){this._logger.log("debug","trigger hit:"+JSON.stringify(i.toJSON())),e=!0;break;}}e&&this._onTriggered();},Root.prototype.onTimerTick=function(t){this._trace&&this._trace.log("root | timer tick:"+t),this._onTriggered();},Root.prototype.onHttpEvt=function(t,e){this._trace&&this._trace.log("root | receive http event:"+JSON.stringify(t));for(var r=!1,i=0;i<this.flowIf.length;i++){var a=this.flowIf[i];if(a.type==HttpTrigger.TYPE&&a.isMatch(t)){this._logger.log("info","trigger hit:"+JSON.stringify(a.toJSON())),r=!0;break;}}r&&this._onTriggered(),e&&e(null,r);},Root.prototype.setTrace=function(t){this._trace=t,this.flowIf&&this.flowIf.forEach(function(e){e&&e.setTrace&&e.setTrace(t);}),this.flowThen&&this.flowThen.forEach(function(e){e&&e.setTrace&&e.setTrace(t);});},Root.prototype.hasCloudTrigger=function(){if(!this.flowIf||0==this.flowIf.length)return!1;for(var t=0;t<this.flowIf.length;t++){if(this.flowIf[t]instanceof CloudDeviceTrigger)return!0;}return!1;},Root.prototype.toCloudRuleFormat=function(){if(!this.flowIf||0==this.flowIf.length)return[];for(var t=[],e=0;e<this.flowIf.length;e++){var r=this.flowIf[e];if(r instanceof CloudDeviceTrigger){var i=r.toCloudRuleFormat();i&&t.push(i);}}return t;},Block.Root=Root;var LogicOP=function LogicOP(t){Block.call(this),this.type=LogicOP.TYPE,t&&(this.op=t.op);};util.inherits(LogicOP,Block),LogicOP.TYPE="logic.operator",LogicOP.prototype["do"]=function(t){t&&t(null,this.op);},LogicOP.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.op=this.op,t;},LogicOP.prototype.fromJSON=function(t){t&&(this.op=t.op);},Block.LogicOP=LogicOP;var Bracket=function Bracket(){Block.call(this),this.type=Bracket.TYPE,this.children=[];};util.inherits(Bracket,Block),Bracket.TYPE="bracket",Bracket.prototype["do"]=function(t){var e=[],r=0,i=this;if(this.children&&0!==this.children.length){var cb=function cb(a,s){if(r++,a?e.push(!1):e.push(s),r<i.children.length)i.children[r]["do"](cb);else if(0===e.length)t&&t(null,!0);else{for(var o=1,n=e[0];o<e.length&&o+1!=e.length;){"AND"==e[o]?n&=e[o+1]:"OR"==e[o]?n|=e[o+1]:"XOR"==e[o]&&(n=n!=e[o+1]),o+=2;}t&&t(null,n);}};this.children[r]["do"](cb);}else t&&t(null,!0);},Bracket.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.children=[],this.children&&this.children.forEach(function(e){e&&t.children.push(e.toJSON());}),t;},Bracket.prototype.fromJSON=function(t){if(t){var e=this;t.children&&t.children.length>0&&t.children.forEach(function(t){if(t){var r=Block.parse(t);r&&e.children.push(r);}});}},Block.Bracket=Bracket;var HttpTrigger=function HttpTrigger(){Block.call(this),this.type=HttpTrigger.TYPE,this.params=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpTrigger");};util.inherits(HttpTrigger,Block),HttpTrigger.TYPE="http.trigger",HttpTrigger.prototype.isMatch=function(t){if(!t||!this.params)return!1;for(var e in this.params){if(e&&this.params[e]!=t[e]&&this.params[e]!=t[encodeURIComponent(e)])return!1;}return this._logger.log("trace","trigger hit:"+JSON.stringify(this.toJSON())),!0;},HttpTrigger.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.params=this.params,t;},HttpTrigger.prototype.fromJSON=function(t){t&&(this.params=t.params);},Block.HttpTrigger=HttpTrigger;var Timer=function Timer(){Block.call(this),this.type=Timer.TYPE,this.time=null,this.week=null,this.start=null,this.end=null,this.op=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Timer");};util.inherits(Timer,Block),Timer.TYPE="timer",Timer.prototype.init=function(t){x.hub.taskman._TimerManager.startTimer(t,this);},Timer.prototype["do"]=function(t){this._trace&&this._trace.log("check time | "+this._getDescription());var e=require("moment-timezone"),r=x.hub.taskman._Util._getTimeZone(),i=new Date().getTime(),a=(i=e.tz(i,r)).year(),s=!1,o=!1,n=null,l=null,h=i.valueOf(),u=this.start;u&&("00"==u.substr(0,2)&&(s=!0,u=a+u.substr(2)),(u=e.tz(u,r)).set({hour:0,minute:0,second:0,millisecond:0}),n=u.valueOf());var c=this.end;if(c&&("00"==c.substr(0,2)&&(o=!0,c=a+c.substr(2)),(c=e.tz(c,r)).set({hour:23,minute:59,second:59,millisecond:999}),l=c.valueOf()),s&&o&&n>l){if(l<h&&n>h)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if(u&&n>h||c&&l<h)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));var g=this.week;if(g){var p=i.day();if(0==p&&(p=7),"1"!=g.charAt(p-1))return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}if(this.time&&this.op){var m=this.time.indexOf(":"),f=this.time.substr(0,m),_=this.time.substr(m+1);f=parseInt(f),_=parseInt(_);var d=i.hour(),v=i.minute();if(">="==this.op){if(d<f||d==f&&v<_)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if(">"==this.op){if(d<f||d==f&&v<=_)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if("<="==this.op){if(d>f||d==f&&v>_)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if("<"==this.op){if(d>f||d==f&&v>=_)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if(("="==this.op||"=="==this.op)&&(d!=f||d==f&&v!=_))return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}this._logger.log("trace","condition match:"+JSON.stringify(this.toJSON())),t&&t(null,!0);},Timer.prototype.finalize=function(t){x.hub.taskman._TimerManager.stopTimer(t);},Timer.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.time=this.time,t.week=this.week,t.start=this.start,t.end=this.end,t.op=this.op,t;},Timer.prototype.fromJSON=function(t){t&&(this.time=t.time,this.week=t.week,this.start=t.start,this.end=t.end,this.op=t.op);},Timer.prototype._getDescription=function(){var t="";return t+="time:"+this.time,t+=" week:"+this.week,t+=" start:"+this.start,t+=" end:"+this.end,t+=" op:"+this.op;},Block.Timer=Timer;var Astro=function Astro(){Block.call(this),this.type=Astro.TYPE,this.astro=null,this.offTime=null,this.delay=null,this.week=null,this.start=null,this.end=null,this.op=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Astro");};util.inherits(Astro,Block),Astro.TYPE="astro",Astro.prototype.init=function(t){x.hub.taskman._AstroManager.startTimer(t,this);},Astro.prototype["do"]=function(t){this._trace&&this._trace.log("check astro | "+this._getDescription());var e=require("moment-timezone"),r=x.hub.taskman._Util._getTimeZone(),i=new Date().getTime(),a=(i=e.tz(i,r)).year(),s=!1,o=!1,n=null,l=null,h=i.valueOf(),u=this.start;u&&("00"==u.substr(0,2)&&(s=!0,u=a+u.substr(2)),(u=e.tz(u,r)).set({hour:0,minute:0,second:0,millisecond:0}),n=u.valueOf());var c=this.end;if(c&&("00"==c.substr(0,2)&&(o=!0,c=a+c.substr(2)),(c=e.tz(c,r)).set({hour:23,minute:59,second:59,millisecond:999}),l=c.valueOf()),s&&o&&n>l){if(l<h&&n>h)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}else if(u&&n>h||c&&l<h)return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));var g=this.week;if(g){var p=i.day();if(0==p&&(p=7),"1"!=g.charAt(p-1))return this._logger.log("trace","condition mismatch:"+JSON.stringify(this.toJSON())),void(t&&t(null,!1));}var m=!1;if(this.astro&&this.op){var f=null,_=x.hub.taskman._AstroManager.getSunriseSunset(i.toDate());f="sunrise"==this.astro?_.sunrise.getTime():_.sunset.getTime(),this.delay&&(f+=60*parseInt(this.delay)*1e3),">="==this.op&&i.valueOf()>=f||">"==this.op&&i.valueOf()>f||"<="==this.op&&i.valueOf()<=f||"<"==this.op&&i.valueOf()<f?m=!0:"="!=this.op&&"=="!=this.op||i.valueOf()==f&&(m=!0);}this._logger.log("trace","condition "+(m?"match":"mismatch")+":"+JSON.stringify(this.toJSON())),t&&t(null,m);},Astro.prototype.finalize=function(t){x.hub.taskman._AstroManager.stopTimer(t);},Astro.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.astro=this.astro,t.offTime=this.offTime,t.delay=this.delay,t.week=this.week,t.start=this.start,t.end=this.end,t.op=this.op,t;},Astro.prototype.fromJSON=function(t){t&&(this.astro=t.astro,this.offTime=t.offTime,this.delay=t.delay,this.week=t.week,this.start=t.start,this.end=t.end,this.op=t.op);},Astro.prototype._getDescription=function(){var t="";return t+="astro:"+this.astro,t+=" offTime:"+this.offTime,t+=" delay:"+this.delay,t+=" week:"+this.week,t+=" start:"+this.start,t+=" end:"+this.end,t+=" op:"+this.op;},Block.Astro=Astro;var Periodic=function Periodic(){Block.call(this),this.type=Periodic.TYPE,this.interval=null,this.startTime=null,this.endTime=null,this.week=null,this.start=null,this.end=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.Periodic");};util.inherits(Periodic,Block),Periodic.TYPE="periodic",Periodic.prototype.init=function(t){x.hub.taskman._PeriodicTimerManager.startTimer(t,this);},Periodic.prototype.finalize=function(t){x.hub.taskman._PeriodicTimerManager.stopTimer(t);},Periodic.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.interval=this.interval,t.startTime=this.startTime,t.endTime=this.endTime,t.week=this.week,t.start=this.start,t.end=this.end,t;},Periodic.prototype.fromJSON=function(t){t&&(this.interval=t.interval,this.startTime=t.startTime,this.endTime=t.endTime,this.week=t.week,this.start=t.start,this.end=t.end);},Block.Periodic=Periodic;var IRTrigger=function IRTrigger(){Block.call(this),this.type=IRTrigger.TYPE,this.ir=null,this._lastTiggerTime=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IRTrigger");};util.inherits(IRTrigger,Block),IRTrigger.TYPE="ir",IRTrigger.prototype.isMatch=function(t){if(!t)return!1;if(!t.code)return!1;if(!this.ir||!this.ir.code)return!1;if(this._getDataCode(this.ir.code)==this._getDataCode(t.code)){var e=new Date().getTime();return this._lastTiggerTime?!(e-this._lastTiggerTime<1e3)&&(this._lastTiggerTime=e,!0):(this._lastTiggerTime=e,!0);}return!1;},IRTrigger.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.ir=this.ir,t;},IRTrigger.prototype.fromJSON=function(t){t&&(this.ir=t.ir);},IRTrigger.prototype._getDataCode=function(t){var e=new Buffer(t,"hex"),r=8;return r=8+4*e.readInt8(r)+1,e.slice(r).toString("hex");},Block.IRTrigger=IRTrigger;var DeviceStatus=function DeviceStatus(){Block.call(this),this.type=DeviceStatus.TYPE,this.device=null,this.gateway=null,this.status=null,this.op=null,this.value=null,this.hysteresis=null,this._lastTiggerTime=null,this._lastStatus=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DeviceStatus"),this._deviceName=null,this._gatewayName=null;};util.inherits(DeviceStatus,Block),DeviceStatus.TYPE="device.status",DeviceStatus.prototype.init=function(t){if((this.device||this.gateway)&&this.status){var e=null;if(this.gateway&&this.gateway.sys&&(e=this.gateway.sys),!e&&this.device&&this.device.sys&&(e=this.device.sys),e){"hm"!=e||this.gateway?"neoserver"==e&&(e="aio"):e="aio";var r=require("x.hub.moduleman.js").modulemanager.getModule(e);if(r&&r.addStateDevice){var i={},a=this._getDevice(),s=this._getGateway();a&&(i=a),delete i.gateway,s&&(i.gateway=s);var o=this.status;o.ref&&o.ref.value?o=o.ref.value:o.value&&(o=o.value),r.addStateDevice(i,null,{taskID:t,statusKey:o,src:"taskman",callback:this});}}}},DeviceStatus.prototype.finalize=function(t){if(this.device||this.gateway){var e=null;if(this.gateway&&this.gateway.sys&&(e=this.gateway.sys),!e&&this.device&&this.device.sys&&(e=this.device.sys),e){"hm"!=e||this.gateway?"neoserver"==e&&(e="aio"):e="aio";var r=require("x.hub.moduleman.js").modulemanager.getModule(e);if(r&&r.removeStateDevice){var i={},a=this._getDevice(),s=this._getGateway();a&&(i=a),delete i.gateway,s&&(i.gateway=s);var o=this.status;o.ref&&o.ref.value?o=o.ref.value:o.value&&(o=o.value),r.removeStateDevice(i,null,{taskID:t,statusKey:o,src:"taskman",callback:this});}}}},DeviceStatus.prototype["do"]=function(t){if(this.device||this.gateway){if(this.status&&this.op){var e=this.status;this.status.ref&&(e=this.status.ref),e.value&&(e=e.value);var r={value:e};this.status&&this.status.value?r=this.status:this.status&&this.status.ref&&(r=this.status.ref);var i=this,a=this._getDevice(),s=this._getGateway();this._logger.log("trace","get states:"+JSON.stringify(this._toBluredJSON())),this._trace&&this._trace.log("get status | "+this._getDescription()),this._running=!0,require("x.hub.commandman.js").commandHandler.getState(a,s,r,function(e){if(i._canceling){i._logger.log("trace","get states canceled:"+JSON.stringify(i._toBluredJSON())),i._canceling=!1;var r=i._running;i._running=!1;var a=i._cancelCB;return i._cancelCB=null,void(a&&a(null,r));}if(i._running=!1,!e||e.error?i._trace&&i._trace.log("get status | "+i._getDescription()+" | error:"+(e?e.error.message:"invalid response")):void 0!==e.data&&null!=e.data||i._trace&&i._trace.log("get status | "+i._getDescription()+" | error:no status"),e&&!e.error){if(void 0!==e.data&&null!=e.data){var s=e.data.value,o=!1;"="==i.op||"=="==i.op?o="true"==i.value?"true"==String(s):"false"==i.value?"false"==String(s):s==i.value:"!="==i.op?o="true"==i.value?"true"!=String(s):"false"==i.value?"false"!=String(s):s!=i.value:">="==i.op?o=parseFloat(s)>=parseFloat(i.value):">"==i.op?o=parseFloat(s)>parseFloat(i.value):"<="==i.op?o=parseFloat(s)<=parseFloat(i.value):"<"==i.op&&(o=parseFloat(s)<parseFloat(i.value)),i._logger.log("trace","condition "+(o?"match":"mismatch")+":"+JSON.stringify(i.toJSON())),i._trace&&i._trace.log("get status | "+i._getDescription()+" | success:"+JSON.stringify(e.data)+" | match="+o),t&&t(null,o);}else t&&t(null,!1);}else t&&t(e?e.error:new Error("get state error"));});}else t&&t(new Error("no status point or operator"));}else t&&t(new Error("no device or gateway"));},DeviceStatus.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t):t&&t(null,this._running);},DeviceStatus.prototype.isMatch=function(t){if(!t)return!1;if(!t.device)return!1;var e=t.device.sys;e&&"neoserver"!=e||(e="aio");var r=require("x.hub.moduleman.js").modulemanager.getModule(e);if(!r||!r.checkDeviceMatch)return!1;var i=this._getDevice(),a=this._getGateway();if(!r.checkDeviceMatch({device:i,gateway:a},t))return!1;var s=this.status;return s.ref&&s.ref.value?s=s.ref.value:s.value&&(s=s.value),s==t.data.key&&this.isValueMatch(t);},DeviceStatus.prototype.isValueMatch=function(t){if(!t||!t.data)return!1;var e=new Date().getTime(),r=!1,i=this._lastStatus,a=t.data.value;this._lastStatus=a,"="==this.op||"changeTo"==this.op?(r="true"==this.value?"true"==String(t.data.value):"false"==this.value?"false"==String(t.data.value):this.value==t.data.value,"changeTo"==this.op&&a==i&&(r=!1)):"!="==this.op?r="true"==this.value?"true"!=String(t.data.value):"false"==this.value?"false"!=String(t.data.value):this.value!=t.data.value:">="==this.op?r=parseFloat(t.data.value)>=parseFloat(this.value):">"==this.op?r=parseFloat(t.data.value)>parseFloat(this.value):"<="==this.op?r=parseFloat(t.data.value)<=parseFloat(this.value):"<"==this.op?r=parseFloat(t.data.value)<parseFloat(this.value):"changed"==this.op?a!=i&&(r=!0):r=!1;var s=this.value;void 0!==this.hysteresis&&null!=this.hysteresis&&(s=this.hysteresis);var o=!1;if(">"==this.op?o=parseFloat(t.data.value)<=parseFloat(s):">="==this.op?o=parseFloat(t.data.value)<parseFloat(s):"<"==this.op?o=parseFloat(t.data.value)>=parseFloat(s):"<="==this.op?o=parseFloat(t.data.value)>parseFloat(s):"="==this.op||"=="==this.op?o=t.data.value!=s:"!="==this.op&&(o=t.data.value==s),o&&(this._lastTiggerTime=null),this._trace&&(this._trace.log("trigger | "+this._getDescription()),this._trace.log("receive event | "+JSON.stringify(t.data)+" | hysteresis="+this.hysteresis+" | hit="+r)),r){if(!this._lastTiggerTime)return this._lastTiggerTime=e,!0;if(e-this._lastTiggerTime<1e3)return!1;if(void 0!==this.hysteresis&&null!=this.hysteresis&&this._lastTiggerTime)return!1;var n=this._getDevice();return(!n||"aio"!=n.sys||"ENOCEAN"!=n.type||"bb-aa-cc"!=n.data&&"d2-06-10"!=n.data||!this._lastTiggerTime)&&(this._lastTiggerTime=e,!0);}return!1;},DeviceStatus.prototype.onEvent=function(t){try{this.isValueMatch(t)&&this._parent&&this._parent._onTriggered&&this._parent._onTriggered(null,this);}catch(t){}},DeviceStatus.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.device=this.device,t.gateway=this.gateway,t.status=this.status,t.op=this.op,t.value=this.value,t.hysteresis=this.hysteresis,t;},DeviceStatus.prototype.fromJSON=function(t){t&&(this.device=t.device,this.gateway=t.gateway,this.status=t.status,this.op=t.op,this.value=t.value,this.hysteresis=t.hysteresis);},DeviceStatus.prototype._toBluredJSON=function(){try{var t=JSON.parse(JSON.stringify(this.toJSON()));return t.device&&(t.device.username&&(t.device.username="xxxxxx"),t.device.password&&(t.device.password="xxxxxx")),t.gateway&&(t.gateway.username&&(t.gateway.username="xxxxxx"),t.gateway.password&&(t.gateway.password="xxxxxx")),t;}catch(t){return this.toJSON();}},DeviceStatus.prototype._getDevice=function(){if(!this.device)return null;var t=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var e=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);e&&e.info&&(this._deviceName=e.name,t=JSON.parse(JSON.stringify(e.info)));}catch(t){}return t||(t=JSON.parse(JSON.stringify(this.device))),t;},DeviceStatus.prototype._getGateway=function(){if(!this.gateway)return null;var t=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var e=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);e&&e.info&&(this._gatewayName=e.name,t=JSON.parse(JSON.stringify(e.info)));}catch(t){}return t||(t=JSON.parse(JSON.stringify(this.gateway))),t&&this.gateway.__neoIndex&&(t.__neoInfo={db:1,index:this.gateway.__neoIndex}),t;},DeviceStatus.prototype._getDescription=function(){var t=null,e=null;if(this._deviceName||this._gatewayName)t=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{(e=JSON.parse(JSON.stringify(this.device))).username&&(e.username="xxxxxx"),e.password&&(e.password="xxxxxx"),t=JSON.stringify(e);}catch(e){t=JSON.stringify(this.device);}else if(this.gateway)try{(e=JSON.parse(JSON.stringify(this.gateway))).username&&(e.username="xxxxxx"),e.password&&(e.password="xxxxxx"),t=JSON.stringify(e);}catch(e){t=JSON.stringify(this.gateway);}var r=this.status;return this.status.ref&&(r=this.status.ref),r.value&&(r=r.value),t+" | "+r+" "+this.op+" "+this.value;},Block.DeviceStatus=DeviceStatus;var CloudDeviceTrigger=function CloudDeviceTrigger(){DeviceStatus.call(this),this.type=CloudDeviceTrigger.TYPE,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudDeviceTrigger"),this._cloudRuleID=null;};util.inherits(CloudDeviceTrigger,DeviceStatus),CloudDeviceTrigger.TYPE="cloud.trigger.device",CloudDeviceTrigger.prototype.init=function(t){},CloudDeviceTrigger.prototype.finalize=function(t){},CloudDeviceTrigger.prototype.toCloudTriggerFormat=function(){var t=this.status;t.ref&&t.ref.value?t=t.ref.value:t.value&&(t=t.value);var e={event:{sys:this.device.module,data:{connection:this.device.connection,id:this.device.id,state:t},comp:{value:this.value,operator:this.op}}};return void 0!==this.hysteresis&&null!=this.hysteresis&&("="==this.op||"=="==this.op?e.event.comp.hyst=.1:">="==this.op||">"==this.op?e.event.comp.hyst=parseFloat(this.value)-parseFloat(this.hysteresis):"<="!=this.op&&"<"!=this.op||(e.event.comp.hyst=parseFloat(this.hysteresis)-parseFloat(this.value))),e;},Block.CloudDeviceTrigger=CloudDeviceTrigger;var DominoswissWS=function DominoswissWS(){Block.call(this),this.type=DominoswissWS.TYPE,this.device=null,this.gateway=null,this.upperThreshold={type:null,op:null,value:null,delay:null,repeat:null},this.lowerThreshold={type:null,op:null,value:null,delay:null,repeat:null},this._upper_threshold_state=0,this._upper_threshold_deley_to=null,this._upper_threshold_repeat_to=null,this._lower_threshold_state=0,this._lower_threshold_deley_to=null,this._lower_threshold_repeat_to=null,this._lastTigger={upperThreshold:!1,lowerThreshold:!1},this._upperMatchCount=0,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.DominoswissWS"),this._lastHit=null;};util.inherits(DominoswissWS,DeviceStatus),DominoswissWS.TYPE="device.dominoswiss.weatherstation",DominoswissWS.prototype.init=function(t){if(this.device||this.gateway){var e=null;if(this.gateway&&this.gateway.sys&&(e=this.gateway.sys),!e&&this.device&&this.device.sys&&(e=this.device.sys),e){var r=require("x.hub.moduleman.js").modulemanager.getModule(e);if(r&&r.addStateDevice){var i={},a=this._getDevice(),s=this._getGateway();a&&(i=a),delete i.gateway,s&&(i.gateway=s),r.addStateDevice(i,null,{taskID:t,statusKey:"*",src:"taskman"});}}}},DominoswissWS.prototype.finalize=function(t){if(this.device||this.gateway){var e=null;if(this.gateway&&this.gateway.sys&&(e=this.gateway.sys),!e&&this.device&&this.device.sys&&(e=this.device.sys),e){var r=require("x.hub.moduleman.js").modulemanager.getModule(e);if(r&&r.removeStateDevice){var i={},a=this._getDevice(),s=this._getGateway();a&&(i=a),delete i.gateway,s&&(i.gateway=s),r.removeStateDevice(i,null,{taskID:t,statusKey:"*",src:"taskman"});}}}},DominoswissWS.prototype.isMatch=function(t){if(!t)return!1;if(!t.device||!t.device.sys)return!1;var e=require("x.hub.moduleman.js").modulemanager.getModule(t.device.sys);if(!e||!e.checkDeviceMatch)return!1;var r=this._getDevice(),i=this._getGateway();if(!e.checkDeviceMatch({device:r,gateway:i},t))return!1;this._logger.log("trace","receive event for device:"+JSON.stringify(t));var a=!1,s=!1,o=this._matchUpperThreshold(t),n=this._matchLowerThreshold(t);if(this._logger.log("trace","upperMatch:"+o+" - lowerMatch:"+n),"upper"==this._lastHit&&!n)return this._logger.log("trace","lastHit:upper - lowerMatch:"+n),!1;if("lower"==this._lastHit&&!o)return this._logger.log("trace","lastHit:lower - upperMatch:"+o),!1;"upper"==this._lastHit&&n&&(this._lastHit=null),"lower"==this._lastHit&&o&&(this._lastHit=null),1==o&&(this._upperMatchCount+=1,this._upperMatchCount>65535&&(this._upperMatchCount=1));switch(this._upper_threshold_state){case 0:1==o&&(void 0!==this.upperThreshold.delay&&null!=this.upperThreshold.delay&&parseInt(this.upperThreshold.delay)>0?this._handleUpperThresholdDelay():(a=!0,this.upperThreshold.repeat&&this._handleUpperThresholdRepeat()));break;case 1:0==o&&(this._logger.log("trace","upper threshold not match, clear delay timeout"),this._upper_threshold_deley_to&&(clearTimeout(this._upper_threshold_deley_to),this._upper_threshold_deley_to=null),this._upper_threshold_state=0);break;case 2:0==o&&(this._logger.log("trace","upper threshold not match, clear repeat timeout"),this._upper_threshold_repeat_to&&(clearTimeout(this._upper_threshold_repeat_to),this._upper_threshold_repeat_to=null),this._upper_threshold_state=0);}switch(this._lower_threshold_state){case 0:1==n&&this._upperMatchCount>0&&(void 0!==this.lowerThreshold.delay&&null!=this.lowerThreshold.delay&&parseInt(this.lowerThreshold.delay)>0?this._handleLowerThresholdDelay():(s=!0,this._upperMatchCount=0,this.lowerThreshold.repeat&&this._handleLowerThresholdRepeat()));break;case 1:0==n&&(this._logger.log("trace","lower threshold not match, clear delay timeout"),this._lower_threshold_deley_to&&(clearTimeout(this._lower_threshold_deley_to),this._lower_threshold_deley_to=null),this._lower_threshold_state=0);break;case 2:0==n&&(this._logger.log("trace","lower threshold not match, clear repeat timeout"),this._lower_threshold_repeat_to&&(clearTimeout(this._lower_threshold_repeat_to),this._lower_threshold_repeat_to=null),this._lower_threshold_state=0);}return this._lastTigger={upperThreshold:a,lowerThreshold:s},this._logger.log("trace","upperHit:"+a+" - lowerHit:"+s),a?this._lastHit="upper":s&&(this._lastHit="lower"),a|s;},DominoswissWS.prototype._matchUpperThreshold=function(t){if(!this.upperThreshold||!this.upperThreshold.type)return null;if(!t||!t.data||!t.data.key||this.upperThreshold.type!=t.data.key)return null;var e=this.upperThreshold.op;e||(e=">=");var r=this.upperThreshold.value;return void 0!==r&&null!=r||(r=0),this._matchThreshold(e,r,t.data.value);},DominoswissWS.prototype._matchLowerThreshold=function(t){if(!this.lowerThreshold||!this.lowerThreshold.type)return null;if(!t||!t.data||!t.data.key||this.lowerThreshold.type!=t.data.key)return null;var e=this.lowerThreshold.op;e||(e=">=");var r=this.lowerThreshold.value;return void 0!==r&&null!=r||(r=0),this._matchThreshold(e,r,t.data.value);},DominoswissWS.prototype._matchThreshold=function(t,e,r){return"="==t||"=="==t?"true"==e?"true"==String(r):"false"==e?"false"==String(r):e==r:">="==t?parseFloat(r)>=parseFloat(e):">"==t?parseFloat(r)>parseFloat(e):"<="==t?parseFloat(r)<=parseFloat(e):"<"==t&&parseFloat(r)<parseFloat(e);},DominoswissWS.prototype._handleUpperThresholdDelay=function(){var t=this;this._upper_threshold_state=1,this._logger.log("trace","start upper threshold hit delay timeout:"+parseInt(this.upperThreshold.delay)),this._upper_threshold_deley_to=setTimeout(function(){if(t._logger.log("trace","upper threshold delay timeout expired"),t._lastTigger={upperThreshold:!0,lowerThreshold:!1},t._parent&&"root"==t._parent.type)try{t._lastHit="upper",t._parent._onTriggered(null,t);}catch(t){}t.upperThreshold.repeat?t._handleUpperThresholdRepeat():t._upper_threshold_state=0;},1e3*parseInt(this.upperThreshold.delay));},DominoswissWS.prototype._handleLowerThresholdDelay=function(){var t=this;this._lower_threshold_state=1,this._logger.log("trace","start lower threshold hit delay timeout:"+parseInt(this.lowerThreshold.delay)),this._lower_threshold_delay_to=setTimeout(function(){if(t._lastTigger={upperThreshold:!1,lowerThreshold:!0},t._upperMatchCount=0,t._logger.log("trace","lower threshold delay timeout expired"),t._parent&&"root"==t._parent.type)try{t._lastHit="lower",t._parent._onTriggered(null,t);}catch(t){}t.lowerThreshold.repeat?t._handleLowerThresholdRepeat():t._lower_threshold_state=0;},1e3*parseInt(this.lowerThreshold.delay));},DominoswissWS.prototype._handleUpperThresholdRepeat=function(){var t=this;this._upper_threshold_state=2;var e=this.upperThreshold.repeat,r=0;if(e&&"string"==typeof e&&e.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){var i=require("moment-timezone"),a=x.hub.taskman._Util._getTimeZone(),s=new Date().getTime();s=i.tz(s,a);var o=parseInt(e.substr(0,e.indexOf(":"))),n=parseInt(e.substr(e.indexOf(":")+1)),l=new Date().getTime();if((l=i.tz(l,a)).set({hour:o,minute:n,second:0,millisecond:0}),(r=l.valueOf()-s.valueOf())<0)return void(this._upper_threshold_state=0);}else{if(!(parseInt(e)>0))return void(this._upper_threshold_state=0);r=1e3*parseInt(e);}this._logger.log("trace","start upper threshold hit repeat timeout:"+Math.round(r/1e3)),this._upper_threshold_repeat_to=setTimeout(function(){if(t._logger.log("trace","upper threshold repeat timeout expired"),t._upper_threshold_state=0,t._lastTigger={upperThreshold:!0,lowerThreshold:!1},t._parent&&"root"==t._parent.type)try{t._lastHit="upper",t._parent._onTriggered(null,t);}catch(t){}},r);},DominoswissWS.prototype._handleLowerThresholdRepeat=function(){var t=this;this._lower_threshold_state=2;var e=this.lowerThreshold.repeat,r=0;if(e&&"string"==typeof e&&e.match(/^([0-1]?[0-9]|2[0-3])(:[0-5][0-9])?$/g)){var i=require("moment-timezone"),a=x.hub.taskman._Util._getTimeZone(),s=new Date().getTime();s=i.tz(s,a);var o=parseInt(e.substr(0,e.indexOf(":"))),n=parseInt(e.substr(e.indexOf(":")+1)),l=new Date().getTime();if((l=i.tz(l,a)).set({hour:o,minute:n,second:0,millisecond:0}),(r=l.valueOf()-s.valueOf())<0)return void(this._lower_threshold_state=0);}else{if(!(parseInt(e)>0))return void(this._lower_threshold_state=0);r=1e3*parseInt(e);}this._logger.log("trace","start lower threshold hit repeat timeout:"+Math.round(r/1e3)),this._lower_threshold_repeat_to=setTimeout(function(){if(t._logger.log("trace","lower threshold repeat timeout expired"),t._upperMatchCount=0,t._lower_threshold_state=0,t._lastTigger={upperThreshold:!1,lowerThreshold:!0},t._parent&&"root"==t._parent.type)try{t._lastHit="lower",t._parent._onTriggered(null,t);}catch(t){}},r);},DominoswissWS.prototype.toJSON=function(){var t=Block.prototype.toJSON.call(this);return t.device=this.device,t.gateway=this.gateway,t.upperThreshold=this.upperThreshold,t.lowerThreshold=this.lowerThreshold,t;},DominoswissWS.prototype.fromJSON=function(t){t&&(this.device=t.device,this.gateway=t.gateway,this.upperThreshold=t.upperThreshold,this.lowerThreshold=t.lowerThreshold);},Block.DominoswissWS=DominoswissWS;var Action=function Action(){Block.call(this),this.type=Action.TYPE;};util.inherits(Action,Block),Action.TYPE="action",Block.Action=Action;var IFTTTMakerAction=function IFTTTMakerAction(){Action.call(this),this.subtype=IFTTTMakerAction.SUBTYPE,this.key=null,this.event=null,this.body=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.IFTTTMakerAction");};util.inherits(IFTTTMakerAction,Action),IFTTTMakerAction.SUBTYPE="iftttmaker",IFTTTMakerAction.prototype["do"]=function(t){if(this.key||this.event){var e=t,r={hostname:"maker.ifttt.com",port:443,path:"/trigger/"+this.event+"/with/key/"+this.key,method:"POST",headers:{"Content-Type":"application/json"}};this._logger.log("trace","send https:"+JSON.stringify(r)),this._logger.log("trace","with data:"+JSON.stringify(this.body));var i=this,a=require("https").request(r,function(t){t.setEncoding("utf8");var r="";t.on("data",function(t){r+=t;}),t.on("end",function(){i._logger.log("trace","action response:"+t.statusCode),i._logger.log("trace","with data:"+r),e&&(e(null,t.statusCode,r),e=null);});});if(a.on("error",function(t){i._logger.log("debug","do action err:"+t.stack),e&&(e(t),e=null);}),a.setTimeout(5e3,function(){i._logger.log("debug","do action timeout"),e&&(e(new Error("timeout")),e=null);}),this.body)try{var s=JSON.stringify(this.body);a.write(s);}catch(t){}a.end();}else t&&t(new Error("no key or event"));},IFTTTMakerAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.key=this.key,t.event=this.event,t.body=this.body,t;},IFTTTMakerAction.prototype.fromJSON=function(t){t&&(this.key=t.key,this.event=t.event,this.body=t.body);},Block.IFTTTMakerAction=IFTTTMakerAction;var HttpAction=function HttpAction(){Action.call(this),this.subtype=HttpAction.SUBTYPE,this.method=null,this.protocol=null,this.auth=null,this.hostname=null,this.port=null,this.pathname=null,this.query=null,this.headers=null,this.body=null,this._doCB=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.HttpAction");};util.inherits(HttpAction,Action),HttpAction.SUBTYPE="http.action",HttpAction.prototype["do"]=function(t){var e=this.method;e||(e="GET");var r=this.protocol;r||(r="http");var i=this.port;(!i||parseInt(i)<=0)&&(i="https"==r?443:80);var a=require("querystring"),s=this.pathname?this.pathname:"/";if(this.query){var o=a.stringify(this.query);s+="?"+(o=(o=o.replace(/%5B/g,"[")).replace(/%5D/g,"]"));}var n={hostname:this.hostname,port:i,path:s,method:e,headers:this.headers};this.auth&&(n.auth=this.auth),this._logger.log("trace","send "+r+" "+e+":"+JSON.stringify(n)),this._logger.log("trace","with data:"+JSON.stringify(this.body)),this._trace&&(this._trace.log("execute http | "+r+" "+e+":"+JSON.stringify(n)),this._trace.log("execute http | with data:"+JSON.stringify(this.body))),this._running=!0,this._doCB=t;var l=this,h=require(r).request(n,function(t){t.setEncoding("utf8");var e="";t.on("data",function(t){e+=t;}),t.on("end",function(){l._logger.log("trace","action response:"+t.statusCode),l._logger.log("trace","with data:"+e),l._trace&&(l._trace.log("execute http | response code:"+t.statusCode),l._trace.log("execute http | response data:"+e)),l._doCB&&(l._running=!1,l._doCB(null,t.statusCode,e),l._doCB=null);});});if(h.on("error",function(t){l._trace&&l._trace.log("execute http | error:"+t.message),l._logger.log("debug","do action err:"+t.stack),l._doCB&&(l._running=!1,l._doCB(t),l._doCB=null);}),h.setTimeout(5e3,function(){l._trace&&l._trace.log("execute http | error:timeout"),l._logger.log("debug","do action timeout"),l._doCB&&(l._running=!1,l._doCB(new Error("timeout")),l._doCB=null);}),this.body&&"GET"!=e&&"DELETE"!=e)if("string"==typeof this.body)h.write(this.body);else try{var u=JSON.stringify(this.body);h.write(u);}catch(t){}h.end();},HttpAction.prototype.cancel=function(t){this._running?(this._logger.log("trace","http action canceled"),this._doCB=null,this._running=!1,t&&t(null,!0)):t&&t(null,this._running);},HttpAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.method=this.method,t.protocol=this.protocol,t.auth=this.auth,t.hostname=this.hostname,t.port=this.port,t.pathname=this.pathname,t.query=this.query,t.headers=this.headers,t.body=this.body,t;},HttpAction.prototype.fromJSON=function(t){t&&(this.subtype=t.subtype,this.method=t.method,this.protocol=t.protocol,this.auth=t.auth,this.hostname=t.hostname,this.port=t.port,this.pathname=t.pathname,this.query=t.query,this.headers=t.headers,this.body=t.body);},Block.HttpAction=HttpAction;var CommandAction=function CommandAction(){Action.call(this),this.subtype=CommandAction.SUBTYPE,this.device=null,this.gateway=null,this.command=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CommandAction"),this._deviceName=null,this._gatewayName=null;};util.inherits(CommandAction,Action),CommandAction.SUBTYPE="command",CommandAction.prototype["do"]=function(t,e){if(this.device||this.gateway){if(this.command){var r=this.command;r.ref&&(r=r.ref);var i=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do command:"+JSON.stringify(this._toBluredJSON()));var a=this._getDevice(),s=this._getGateway();if(!a||"sonos"!=a.sys||!r||"playAlarm"!=r.value||(r=this._buildSonosCommand(r.ext))){this._running=!0,this._trace&&this._trace.log("execute command | "+this._getDescription());var o=this;i.executeCommand(a,s,r,function(e){if(e&&e.error?o._trace&&o._trace.log("execute command | "+o._getDescription()+" | error:"+e.error.message):o._trace&&o._trace.log("execute command | "+o._getDescription()+" | success"),o._canceling){o._logger.log("trace","command action canceled:"+JSON.stringify(o._toBluredJSON())),o._canceling=!1;var r=o._running;o._running=!1;var i=o._cancelCB;return o._cancelCB=null,void(i&&i(null,r));}o._running=!1,t&&t();});}}else t&&t(new Error("no command"));}else t&&t(new Error("no device or gateway"));},CommandAction.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t):t&&t(null,this._running);},CommandAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.device=this.device,t.gateway=this.gateway,t.command=this.command,t;},CommandAction.prototype.fromJSON=function(t){t&&(this.device=t.device,this.gateway=t.gateway,this.command=t.command);},CommandAction.prototype._toBluredJSON=function(){try{var t=JSON.parse(JSON.stringify(this.toJSON()));return t.device&&(t.device.username&&(t.device.username="xxxxxx"),t.device.password&&(t.device.password="xxxxxx")),t.gateway&&(t.gateway.username&&(t.gateway.username="xxxxxx"),t.gateway.password&&(t.gateway.password="xxxxxx")),t;}catch(t){return this.toJSON();}},CommandAction.prototype._getDevice=function(){if(!this.device)return null;var t=null;if(this.device.__neoIndex&&deviceman.deviceManager)try{var e=deviceman.deviceManager.findDeviceWithIndex(this.device.__neoIndex);e&&e.info&&(this._deviceName=e.name,t=JSON.parse(JSON.stringify(e.info)));}catch(t){}return t||(t=JSON.parse(JSON.stringify(this.device))),t;},CommandAction.prototype._getGateway=function(){if(!this.gateway)return null;var t=null;if(this.gateway.__neoIndex&&deviceman.deviceManager)try{var e=deviceman.deviceManager.findGatewayWithIndex(this.gateway.__neoIndex);e&&e.info&&(this._gatewayName=e.name,t=JSON.parse(JSON.stringify(e.info)));}catch(t){}return t||(t=JSON.parse(JSON.stringify(this.gateway))),t&&this.gateway.__neoIndex&&(t.__neoInfo={db:1,index:this.gateway.__neoIndex}),t;},CommandAction.prototype._getDescription=function(){var t=null;if(this._deviceName||this._gatewayName)t=this._deviceName?this._deviceName:this._gatewayName;else if(this.device)try{tmp=JSON.parse(JSON.stringify(this.device)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),t=JSON.stringify(tmp);}catch(e){t=JSON.stringify(this.device);}else if(this.gateway)try{tmp=JSON.parse(JSON.stringify(this.gateway)),tmp.username&&(tmp.username="xxxxxx"),tmp.password&&(tmp.password="xxxxxx"),t=JSON.stringify(tmp);}catch(e){t=JSON.stringify(this.gateway);}var e=this.command;return e.ref&&(e=e.ref),t+" | "+JSON.stringify(e);},CommandAction.prototype._getLocalIP=function(){var t=require("os").networkInterfaces();for(var e in t){for(var r=t[e],i=0;i<r.length;i++){var a=r[i];if(a&&"IPv4"==a.family&&0==a.internal)return a.address;}}return null;},CommandAction.prototype._getLocalPort=function(){var t=require("x.hub.js");return t.server?t.server._port:null;},CommandAction.prototype._buildSonosCommand=function(t){var e=this._getLocalIP(),r=this._getLocalPort();if(!e||!r)return null;var i=null;switch(t){case"alarm_on":i="alarm_on.mp3";break;case"alarm_off":i="alarm_off.mp3";break;case"pre_alarm":i="pre_alarm.mp3";break;case"alarm":i="alarm.mp3";break;default:return null;}return{value:"playUrl",ext:"http://"+e+":"+r+"/resources/rehau_alarm/"+i};},Block.CommandAction=CommandAction;var BrelagUpperThresholdAction=function BrelagUpperThresholdAction(){Action.call(this),this.subtype=BrelagUpperThresholdAction.SUBTYPE,this.device=null,this.gateway=null,this.command=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagUpperThresholdAction");};util.inherits(BrelagUpperThresholdAction,CommandAction),BrelagUpperThresholdAction.SUBTYPE="command.dominoswiss.upperthreshold",BrelagUpperThresholdAction.prototype["do"]=function(t,e){if(e&&e.trigger&&e.trigger.type==DominoswissWS.TYPE){var r=e.trigger._lastTigger;r&&r.upperThreshold?CommandAction.prototype["do"].call(this,t,e):t&&t();}else t&&t();},Block.BrelagUpperThresholdAction=BrelagUpperThresholdAction;var BrelagLowerThresholdAction=function BrelagLowerThresholdAction(){Action.call(this),this.subtype=BrelagLowerThresholdAction.SUBTYPE,this.device=null,this.gateway=null,this.command=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.BrelagLowerThresholdAction");};util.inherits(BrelagLowerThresholdAction,CommandAction),BrelagLowerThresholdAction.SUBTYPE="command.dominoswiss.lowerthreshold",BrelagLowerThresholdAction.prototype["do"]=function(t,e){if(e&&e.trigger&&e.trigger.type==DominoswissWS.TYPE){var r=e.trigger._lastTigger;r&&r.lowerThreshold?CommandAction.prototype["do"].call(this,t,e):t&&t();}else t&&t();},Block.BrelagUpperThresholdAction=BrelagLowerThresholdAction;var CloudAction=function CloudAction(){Action.call(this),this.subtype=CloudAction.SUBTYPE,this.actionID=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.CloudAction");};util.inherits(CloudAction,Action),CloudAction.SUBTYPE="cloud_action",CloudAction.prototype["do"]=function(t){if(this.actionID){this._logger.log("trace","do cloud action:"+this.actionID);var e=require("x.hub.js").server;if(e){var r=e._cloudConnect;if(r){var i=JSON.stringify({type:"ACTION",data:this.actionID}),a=new Buffer("EVT:"+i,"utf8");r.sendMessageActive("0103"+a.toString("hex"),function(e){t&&t(e);});}else t&&t(new Error("no cloud connect"));}else t&&t(new Error("no server in hub"));}else t&&t(new Error("action id is empty"));},CloudAction.prototype.cancel=function(t){t&&t(null,!1);},CloudAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.actionID=this.actionID,t;},CloudAction.prototype.fromJSON=function(t){t&&(this.actionID=t.actionID);};var MacroAction=function MacroAction(){Action.call(this),this.subtype=MacroAction.SUBTYPE,this.groupName=null,this.macroName=null,this._canceling=!1,this._cancelCB=null,this._macroExecutorID=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.MacroAction");};util.inherits(MacroAction,Action),MacroAction.SUBTYPE="macro",MacroAction.prototype["do"]=function(t){if(this.groupName&&this.macroName){var e=require("x.hub.macroman.js");this._logger.log("trace","do macro:"+JSON.stringify(this.toJSON()));var r=this;this._running=!0,this._trace&&this._trace.log("execute macro | "+this._getDescription()),e.execute(this.groupName,this.macroName,function(e){if(r._trace&&r._trace.log("execute macro | "+r._getDescription()+" | return:"+JSON.stringify(e)),r._canceling){r._logger.log("trace","macro action canceled:"+JSON.stringify(r.toJSON())),r._canceling=!1,r._running=!1;var i=r._cancelCB;return r._cancelCB=null,void(i&&i());}r._running=!1,t&&t(e);},function(t){t&&t.id&&(r._macroExecutorID=t.id);});}else t&&t(new Error("no group or macro"));},MacroAction.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t,this._macroExecutorID&&require("x.hub.macroman.js").cancel(this._macroExecutorID)):t&&t(null,this._running);},MacroAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.groupName=this.groupName,t.macroName=this.macroName,t;},MacroAction.prototype.fromJSON=function(t){t&&(this.groupName=t.groupName,this.macroName=t.macroName);},MacroAction.prototype._getDescription=function(){return this.groupName+"."+this.macroName;},Block.MacroAction=MacroAction;var SnsAction=function SnsAction(){Action.call(this),this.token=null,this._cancelCB=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.SnsAction");};util.inherits(SnsAction,Action),SnsAction.prototype["do"]=function(t){if(this.token){var e=this;this._logger.log("trace","do sns:"+JSON.stringify(this.toJSON()));var r=new x.hub.taskman.Cloud();this._running=!0,this._trace&&this._trace.log("execute sns | "+this._getDescription()),r._doRequest("GET","/xhub/sns/dosns?token="+this.token,null,null,null,null,function(r,i){if(e._trace&&e._trace.log("execute sns | "+e._getDescription()+" | "+(r?"error:"+r.message:"response:"+i)),e._canceling){e._logger.log("trace","sns action canceled:"+JSON.stringify(e.toJSON())),e._canceling=!1;var a=e._running;e._running=!1;var s=e._cancelCB;return e._cancelCB=null,void(s&&s(null,a));}e._running=!1,r&&e._logger.log("warn","do sns error:"+r.stack),t&&t(r);});}else t&&t(new Error("token is empty"));},SnsAction.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t):t&&t(null,this._running);},SnsAction.prototype._getDescription=function(){return this.subtype+"."+this.token;};var EmailAction=function EmailAction(){SnsAction.call(this),this.subtype=EmailAction.SUBTYPE,this.token=null;};util.inherits(EmailAction,SnsAction),EmailAction.SUBTYPE="EMAIL",EmailAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.token=this.token,t;},EmailAction.prototype.fromJSON=function(t){t&&(this.token=t.token);},Block.EmailAction=EmailAction;var PushAction=function PushAction(){SnsAction.call(this),this.subtype=PushAction.SUBTYPE,this.token=null;};util.inherits(PushAction,SnsAction),PushAction.SUBTYPE="PUSH",PushAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.token=this.token,t;},PushAction.prototype.fromJSON=function(t){t&&(this.token=t.token);},Block.PushAction=PushAction;var SmsAction=function SmsAction(){SnsAction.call(this),this.subtype=SmsAction.SUBTYPE,this.token=null;};util.inherits(SmsAction,SnsAction),SmsAction.SUBTYPE="SMS",SmsAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.token=this.token,t;},SmsAction.prototype.fromJSON=function(t){t&&(this.token=t.token);},Block.SmsAction=SmsAction;var _ScriptRunTask=function _ScriptRunTask(t,e){this._runCallback=e,this._finishCallback=null,this._action=t;var r=this;this.runCallback=function(t){r._action.removeRunTask(r),r._runCallback&&r._runCallback(t);},this.finishCallback=function(){r._action.removeRunTask(r);};},ScriptAction=function ScriptAction(){Action.call(this),this.subtype=ScriptAction.SUBTYPE,this.id=null,this.name=null,this._scriptRunTasks=[],this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ScriptAction");};util.inherits(ScriptAction,Action),ScriptAction.SUBTYPE="script",ScriptAction.prototype["do"]=function(t){if(this.id){var e=require("x.hub.scriptman.js").scriptManager;this._logger.log("trace","do script:"+JSON.stringify(this.toJSON()));this._running=!0;var r=new _ScriptRunTask(this,t);this._scriptRunTasks.push(r),this._trace&&this._trace.log("execute skript | "+this.id),e.runScript(this.id,r.runCallback,r.finishCallback);}else t&&t(new Error("no script id"));},ScriptAction.prototype.cancel=function(t){if(this._running){var e=require("x.hub.scriptman.js").scriptManager;this._scriptRunTasks=[],this._running=!1,this._logger.log("trace","script action canceled:"+JSON.stringify(this.toJSON())),e.stopScript(this.id,function(){t&&t(null,!0);});}else t&&t(null,this._running);},ScriptAction.prototype.removeRunTask=function(t){var e=this._scriptRunTasks.indexOf(t);-1!=e&&this._scriptRunTasks.splice(e,1),0==this._scriptRunTasks.length&&(this._running=!1);},ScriptAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.id=this.id,t.name=this.name,t;},ScriptAction.prototype.fromJSON=function(t){t&&(this.id=t.id,this.name=t.name);},Block.ScriptAction=ScriptAction;var WaitAction=function WaitAction(){Action.call(this),this.subtype=WaitAction.SUBTYPE,this.value=null,this._to=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.WaitAction");};util.inherits(WaitAction,Action),WaitAction.SUBTYPE="wait",WaitAction.prototype["do"]=function(t){if(this.value){this._running=!0;var e=this;this._trace&&this._trace.log("execute wait | wait "+this.value+" ms"),this._to=setTimeout(function(){e._trace&&e._trace.log("execute wait | wait expired"),e._running=!1,e._to=null,t&&t();},this.value);}else t&&t();},WaitAction.prototype.cancel=function(t){this._running?(this._to&&(this._logger.log("trace","wait action canceled:"+JSON.stringify(this.toJSON())),clearTimeout(this._to),this._to=null),this._running=!1,t&&t(null,!0)):t&&t(null,this._running);},WaitAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.value=this.value,t;},WaitAction.prototype.fromJSON=function(t){t&&(this.value=t.value);},Block.WaitAction=WaitAction;var ChangePageAction=function ChangePageAction(){Action.call(this),this.subtype=ChangePageAction.SUBTYPE,this.remote=null,this.page=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.ChangePageAction"),this._cancelCB=null;};util.inherits(ChangePageAction,Action),ChangePageAction.SUBTYPE="remote.changepage",ChangePageAction.prototype["do"]=function(t){this._trace&&this._trace.log("execute change page | "+this.remote+"."+this.page),this._running=!0;var e=[],r=require("os").networkInterfaces();for(var i in r){for(var a=r[i],s=0;s<a.length;s++){var o=a[s];"IPv4"==o.family&&0==o.internal&&e.push(o.address);}}var n=this,l=0,cb=function cb(){if(n._canceling){n._logger.log("trace","change page action canceled:"+JSON.stringify(n.toJSON())),n._canceling=!1;var r=n._running;n._running=!1;var i=n._cancelCB;return n._cancelCB=null,void(i&&i(null,r));}if(++l>=e.length)return n._running=!1,void(t&&t());n._sendEvent(e[l],cb);};this._sendEvent(e[l],cb);},ChangePageAction.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t):t&&t(null,this._running);},ChangePageAction.prototype._sendEvent=function(t,e){var r=require("dgram"),i=require("unorm"),a={func:"changePage",remote:i.nfc(this.remote),page:i.nfc(this.page),time:Date.now()};a=new Buffer("{XC_EVT}"+JSON.stringify(a),"utf8");var s=r.createSocket({type:"udp4",reuseAddr:!0});s.bind(t,function(){s.setBroadcast(!0),s.send(a,0,a.length,1902,"255.255.255.255"),s.send(a,0,a.length,1902,"255.255.255.255",function(t){s.close(),e&&e(t);});});},ChangePageAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.remote=this.remote,t.page=this.page,t;},ChangePageAction.prototype.fromJSON=function(t){t&&(this.remote=t.remote,this.page=t.page);},Block.ChangePageAction=ChangePageAction;var PopupAction=function PopupAction(){Action.call(this),this.subtype=PopupAction.SUBTYPE,this.remote=null,this.popup=null,this.action=null,this.settings=null,this.template=null,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.PopupAction"),this._cancelCB=null;};util.inherits(PopupAction,Action),PopupAction.SUBTYPE="remote.popup",PopupAction.prototype["do"]=function(t){this._trace&&this._trace.log("execute popup action | "+this.remote+"."+this.popup+"."+this.action),this._running=!0;var e=[],r=require("os").networkInterfaces();for(var i in r){for(var a=r[i],s=0;s<a.length;s++){var o=a[s];"IPv4"==o.family&&0==o.internal&&e.push(o.address);}}var n=this,l=0,cb=function cb(){if(n._canceling){n._logger.log("trace","popup action canceled:"+JSON.stringify(n.toJSON())),n._canceling=!1;var r=n._running;n._running=!1;var i=n._cancelCB;return n._cancelCB=null,void(i&&i(null,r));}if(++l>=e.length)return n._running=!1,void(t&&t());n._sendEvent(e[l],cb);};this._sendEvent(e[l],cb);},PopupAction.prototype.cancel=function(t){this._running?(this._canceling=!0,this._cancelCB=t):t&&t(null,this._running);},PopupAction.prototype._sendEvent=function(t,e){var r=require("dgram"),i=require("unorm"),a={func:"popup",remote:i.nfc(this.remote),action:i.nfc(this.action),time:Date.now()};if(this.popup&&"open"===this.action&&(a.popup=i.nfc(this.popup),this.settings))try{a.settings=i.nfc(JSON.stringify(this.settings));}catch(t){self._logger.log("error",t.message);}a=new Buffer("{XC_EVT}"+JSON.stringify(a),"utf8");var s=r.createSocket({type:"udp4",reuseAddr:!0});s.bind(t,function(){s.setBroadcast(!0),s.send(a,0,a.length,1902,"255.255.255.255"),s.send(a,0,a.length,1902,"255.255.255.255",function(t){s.close(),e&&e(t);});});},PopupAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.remote=this.remote,t.popup=this.popup,t.action=this.action,t.settings=this.settings,t.template=this.template,t;},PopupAction.prototype.fromJSON=function(t){t&&(this.remote=t.remote,this.popup=t.popup,this.action=t.action,this.settings=t.settings,this.template=t.template);},Block.PopupAction=PopupAction;var AudioAction=function AudioAction(){CommandAction.call(this),this.subtype=AudioAction.SUBTYPE,this._logger=require("x.logger.js").getLogger("x.hub.taskman._Block.AudioAction");};return util.inherits(AudioAction,CommandAction),AudioAction.SUBTYPE="audio",AudioAction.prototype["do"]=function(t){if(this.device||this.gateway){if(this.command){var e=this.command;e.ref&&(e=e.ref),this._logger.log("trace","do audio command:"+JSON.stringify(this._toBluredJSON()));var r=this._getDevice(),i=this._getGateway();this._running=!0,this._trace&&this._trace.log("execute audio command | "+this._getDescription());var a=require("x.hub.commandman.js").commandHandler,s=this;a.executeCommand(r,i,e,function(e){e&&e.error?s._trace&&s._trace.log("execute command | "+s._getDescription()+" | error:"+e.error.message):s._trace&&s._trace.log("execute command | "+s._getDescription()+" | success"),s._running=!1,t&&t();});}else t&&t(new Error("no command"));}else t&&t(new Error("no device or gateway"));},AudioAction.prototype.toJSON=function(){var t=Action.prototype.toJSON.call(this);return t.subtype=this.subtype,t.device=this.device,t.gateway=this.gateway,t.command=this.command,t;},AudioAction.prototype.fromJSON=function(t){t&&(this.device=t.device,this.gateway=t.gateway,this.command=t.command);},Block.AudioAction=AudioAction,Block.parse=function(t){if(!t||!t.type)return null;var e=null;switch(t.type){case Root.TYPE:e=Block.Root;break;case Condition.TYPE:e=Condition;break;case Action.TYPE:switch(t.subtype){case CommandAction.SUBTYPE:e=CommandAction;break;case BrelagUpperThresholdAction.SUBTYPE:e=BrelagUpperThresholdAction;break;case BrelagLowerThresholdAction.SUBTYPE:e=BrelagLowerThresholdAction;break;case EmailAction.SUBTYPE:e=EmailAction;break;case PushAction.SUBTYPE:e=PushAction;break;case SmsAction.SUBTYPE:e=SmsAction;break;case ScriptAction.SUBTYPE:e=ScriptAction;break;case WaitAction.SUBTYPE:e=WaitAction;break;case MacroAction.SUBTYPE:e=MacroAction;break;case IFTTTMakerAction.SUBTYPE:e=IFTTTMakerAction;break;case HttpAction.SUBTYPE:e=HttpAction;break;case ChangePageAction.SUBTYPE:e=ChangePageAction;break;case CloudAction.SUBTYPE:e=CloudAction;break;case AudioAction.SUBTYPE:e=AudioAction;break;case PopupAction.SUBTYPE:e=PopupAction;break;default:return null;}break;case DeviceStatus.TYPE:e=DeviceStatus;break;case DominoswissWS.TYPE:e=DominoswissWS;break;case Timer.TYPE:e=Timer;break;case Astro.TYPE:e=Astro;break;case Periodic.TYPE:e=Periodic;break;case LogicOP.TYPE:e=LogicOP;break;case Bracket.TYPE:e=Bracket;break;case HttpTrigger.TYPE:e=HttpTrigger;break;case IRTrigger.TYPE:e=IRTrigger;break;case CloudDeviceTrigger.TYPE:e=CloudDeviceTrigger;break;default:return null;}var r=new e();return r.fromJSON(t),r;},Block;}(),x.hub.taskman.Task=function(){var Task=function Task(t){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Task"),this.id=null,this.name=null,this.root=null,this.active=!0,this.isAlarmTask=!1,this.rehauAlarmTask=!1,this.singleton=!1,this.singletonMethod="ignore",this._trace=null,t&&(this.id=t.id,this.name=t.name,this.active=t.active,this.isAlarmTask=t.isAlarmTask,this.rehauAlarmTask=t.rehauAlarmTask,this.singleton=t.singleton,this.singletonMethod=t.singletonMethod),void 0!==this.active&&null!=this.active||(this.active=!0),void 0!==this.isAlarmTask&&null!=this.isAlarmTask||(this.isAlarmTask=!1),void 0!==this.rehauAlarmTask&&null!=this.rehauAlarmTask||(this.rehauAlarmTask=!1);};return Task.prototype.init=function(){this.root&&this.root.init(this.id);},Task.prototype.getTriggers=function(){return this.root?this.root.getTriggers():[];},Task.prototype.finalize=function(){try{this.root&&this.root.finalize(this.id);}catch(t){this._logger.log("warn","finalize task "+this.id+" error:"+t.message);}},Task.prototype.trigger=function(t){this.root?(this.root._onTriggered(),t&&t()):t&&t(new Error("no content"));},Task.prototype.cancel=function(t){this.root?(this.root.cancel(),t&&t()):t&&t(new Error("no content"));},Task.prototype.isActive=function(){return this.active;},Task.prototype.setActive=function(t){void 0!==t&&null!=t||(t=!0),"string"==typeof t&&(t="false"!=t),this.active=t;},Task.prototype.toggleActive=function(){this.active=!this.active;},Task.prototype.setRehauAlarmTask=function(t){this.rehauAlarmTask=t;},Task.prototype.isRehauAlarmTask=function(){return this.rehauAlarmTask;},Task.prototype.setAlarmTask=function(t){void 0!==t&&null!=t||(t=!1),"string"==typeof t&&(t="false"!=t),this.isAlarmTask=t;},Task.prototype.isRunning=function(){return!!this.root&&this.root.isRunning();},Task.prototype.onStatusEvt=function(t){if(this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+!!this.root+") receive status"),this.active&&this.root){if(this.isAlarmTask)if(!require("x.hub.taskman.js").taskManager._alarmTask._active)return;this.root.onStatusEvt(t);}},Task.prototype.onStatusEvtForTask=function(t){if(this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+!!this.root+") receive dedicated status"),this.active&&this.root){if(this.isAlarmTask)if(!require("x.hub.taskman.js").taskManager._alarmTask._active)return;this.root.onDedicatedStatusEvt(t);}},Task.prototype.onIREvt=function(t){if(this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+!!this.root+") receive ir event"),this.active&&this.root){if(this.isAlarmTask)if(!require("x.hub.taskman.js").taskManager._alarmTask._active)return;this.root.onIREvt(t);}},Task.prototype.onTimerTick=function(t){if(this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+!!this.root+") receive timer tick"),this.active&&this.root){if(this.isAlarmTask)if(!require("x.hub.taskman.js").taskManager._alarmTask._active)return;this.root.onTimerTick(t);}},Task.prototype.onHttpEvt=function(t,e){if(this._logger.log("trace","task "+this.id+" (active:"+this.active+", root:"+!!this.root+") receive http event"),this.active&&this.root){if(this.isAlarmTask&&!require("x.hub.taskman.js").taskManager._alarmTask._active)return void(e&&e(null,!1));this.root.onHttpEvt(t,e);}else e&&e(null,!1);},Task.prototype.toJSON=function(){var t={id:this.id,name:this.name,active:this.active,isAlarmTask:this.isAlarmTask,rehauAlarmTask:this.rehauAlarmTask,singleton:this.singleton,singletonMethod:this.singletonMethod,root:{}};return this.root&&(t.root=this.root.toJSON()),t;},Task.prototype.startTaskTrace=function(t,e){this._trace||(this._trace=new x.hub.taskman.TaskTrace(this),this.root&&this.root.setTrace(this._trace)),this._trace.addListener(t),e&&e();},Task.prototype.stopTaskTrace=function(t,e){this._trace&&(this._trace.removeListener(t),0==this._trace.getListeners().length&&(this.root&&this.root.setTrace(null),this._trace=null)),e&&e();},Task.prototype.toCloudRuleJSON=function(t,e,r,i,a){var s=[],o=this.getTriggers();if(!o||0==o.length)return null;for(var n=0;n<o.length;n++){var l=o[n];if(l&&"cloud.trigger.device"==l.type){var h=l.toCloudTriggerFormat();h&&s.push(h);}}return 0==s.length?null:{name:this.name,owner:e,app:t,action:[{sys:"mediola",data:{data:{XC_FNC:"DoTask",id:this.id},token:a,ccs:r+(i?":"+i:""),cmd:"cmd"}}],trigger:s};},Task.prototype.getCloudDeviceTriggerGateway=function(){if(!this.root)return null;var t=this.root.getTriggers(),e=null;if(!t||t.length<=0)return null;for(var r=0;r<t.length;r++){var i=t[r];if(i&&"cloud.trigger.device"==i.type&&(e=i._getGateway()))break;}return e;},Task.parse=function(t){if(!t||!t.id||!t.name)return null;var e=new Task(t);return t.root&&(e.root=x.hub.taskman._Block.parse(t.root),e.root&&(e.root._task=e,e.root.singleton=e.singleton,e.root.singletonMethod=e.singletonMethod)),e;},Task;}(),x.hub.taskman.AlarmTask=function(){var AlarmTask=function AlarmTask(){this._active=!1,this._delay=0,this._activateDelayTO=null;};return AlarmTask.prototype.init=function(){this._active="true"==localStorage.getItem("x.hub.taskman.TaskManager.alarmActive"),this._delay=parseInt(localStorage.getItem("x.hub.taskman.TaskManager.alarmDelay"));},AlarmTask.prototype.setAlarmActive=function(t,e,r,i){var _activeTasks=function _activeTasks(t,e,r){void 0!==e&&null!=e||(e=!0),"string"==typeof e&&(e="false"!=e),t._tasks.forEach(function(t){t.isAlarmTask&&(t.active=e);}),t._writeData(r);};if(this._getAlarmPin()!=e){var a=new Error("pin error");return a.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(a));}if(this._activateDelayTO&&(clearTimeout(this._activateDelayTO),this._activateDelayTO=null),!this._delay||!t)return localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",t),this._active=t,void _activeTasks(r,t,i);var s=this;this._activateDelayTO=setTimeout(function(){localStorage.setItem("x.hub.taskman.TaskManager.alarmActive",t),s._active=t,s._activateDelayTO=null,_activeTasks(r,t);},1e3*this._delay),i&&i();},AlarmTask.prototype.setAlarmDelay=function(t,e,r){if(this._getAlarmPin()!=e){var i=new Error("pin error");return i.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(i));}localStorage.setItem("x.hub.taskman.TaskManager.alarmDelay",t),this._delay=t,r&&r();},AlarmTask.prototype.getAlarmInfo=function(t){t&&t(null,{active:this._active,delay:this._delay?this._delay:0,pendingActive:null!=this._activateDelayTO});},AlarmTask.prototype.selectAlarmTask=function(t,e,r,i,a){if(t){for(var s=null,o=0;o<i.length;o++){var n=i[o];if(n.id==t){s=n;break;}}if(s){var l=this._getAlarmPin();if(!r||r!=l){var h=new Error("pin error");return h.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(a&&a(h));}this._active?a&&a(new Error("alarm task active")):(s.setAlarmTask(e),a&&a());}else a&&a(new Error("no such task:"+t));}else a&&a(new Error("task id is null"));},AlarmTask.prototype._getAlarmPin=function(){return localStorage.getItem("x.hub.taskman.TaskManager.alarmPin")?localStorage.getItem("x.hub.taskman.TaskManager.alarmPin"):AlarmTask.DEFAULT_PIN;},AlarmTask.prototype.setAlarmPin=function(t,e,r){var i=this._getAlarmPin();if(t){if(e!=i){var a=new Error("pin error");return a.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(a));}localStorage.setItem("x.hub.taskman.TaskManager.alarmPin",t),r&&r();}else r&&r(new Error("new pin invalid"));},AlarmTask.DEFAULT_PIN="0000",AlarmTask;}(),x.hub.taskman.TaskTrace=function(){var Trace=function Trace(t){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskTrace"),this._task=t,this._listeners=[];};return Trace.prototype.addListener=function(t){t&&-1==this._listeners.indexOf(t)&&this._listeners.push(t);},Trace.prototype.removeListener=function(t){if(t){var e=this._listeners.indexOf(t);-1!=e&&this._listeners.splice(e,1);}},Trace.prototype.getListeners=function(t){return this._listeners;},Trace.prototype.log=function(t){this._logger.log("trace","[Task "+this._task.id+"]:"+t),t="["+this._getTimestamp()+"] "+t,this._listeners.forEach(function(e){e&&e(t);});},Trace.prototype._getTimestamp=function(){return new Date().toTimeString();},Trace;}(),x.hub.taskman.rehau={},x.hub.taskman.rehau.AlarmTaskManager=function(){var AlarmDoor=function AlarmDoor(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmDoor"),this._id=null,this._device=null,this._activateEvent=null,this._alarmTask=null;};AlarmDoor.prototype.init=function(){if(this._device){var t=require("x.hub.moduleman.js").modulemanager.getModule("aio");t&&t.addStateDevice&&this._activateEvent&&this._activateEvent.status&&t.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"});}},AlarmDoor.prototype.finalize=function(){if(this._device){var t=require("x.hub.moduleman.js").modulemanager.getModule("aio");t&&t.removeStateDevice&&this._activateEvent&&this._activateEvent.status&&t.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"});}},AlarmDoor.prototype.setAlarmTask=function(t){this._alarmTask=t;},AlarmDoor.prototype.getID=function(){return this._id;},AlarmDoor.prototype.setID=function(t){this._id=t;},AlarmDoor.prototype.setDevice=function(t){this._device=t;},AlarmDoor.prototype.setActivateEvent=function(t){this._activateEvent=t;},AlarmDoor.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent};},AlarmDoor.prototype.matchDevice=function(t){return!(!this._device||!t)&&this._device.type==t.type&&this._device.address==t.address;},AlarmDoor.prototype.onStatusEvt=function(t){t&&t.data&&this._activateEvent&&this._activateEvent.status==t.data.key&&this._activateEvent.value==t.data.value&&(this._logger.log("trace","alarm door:"+this._device.address+" receive event:"+t.data.value+" and trigger door alarm"),this._alarmTask&&this._alarmTask.triggerDoorAlarm());},AlarmDoor.buildDoorfromJSON=function(t){if(!t||!t.device)return null;var e=new AlarmDoor();return e.setID(t.id),e.setDevice(t.device),e.setActivateEvent(t.activateEvent),e;};var AlarmKey=function AlarmKey(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmKey"),this._id=null,this._device=null,this._activateEvent=null,this._deactivateEvent=null,this._alarmTask=null;};AlarmKey.prototype.init=function(){if(this._device){var t=require("x.hub.moduleman.js").modulemanager.getModule("aio");t&&t.addStateDevice&&(this._activateEvent&&this._activateEvent.status&&t.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&t.addStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}));}},AlarmKey.prototype.finalize=function(){if(this._device){var t=require("x.hub.moduleman.js").modulemanager.getModule("aio");t&&t.removeStateDevice&&(this._activateEvent&&this._activateEvent.status&&t.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._activateEvent.status,src:"rehau:alarmTask"}),this._deactivateEvent&&this._deactivateEvent.status&&t.removeStateDevice(this._device,null,{alarmTaskID:this._alarmTask.getID(),statusKey:this._deactivateEvent.status,src:"rehau:alarmTask"}));}},AlarmKey.prototype.setAlarmTask=function(t){this._alarmTask=t;},AlarmKey.prototype.getID=function(){return this._id;},AlarmKey.prototype.setID=function(t){this._id=t;},AlarmKey.prototype.setDevice=function(t){this._device=t;},AlarmKey.prototype.setActivateEvent=function(t){this._activateEvent=t;},AlarmKey.prototype.setDeactivateEvent=function(t){this._deactivateEvent=t;},AlarmKey.prototype.toJSON=function(){return{id:this._id,device:this._device,activateEvent:this._activateEvent,deactivateEvent:this._deactivateEvent};},AlarmKey.prototype.matchDevice=function(t){return!(!this._device||!t)&&this._device.type==t.type&&this._device.address==t.address;},AlarmKey.prototype.onStatusEvt=function(t){if(t&&t.data){if(this._activateEvent&&this._activateEvent.status==t.data.key&&this._activateEvent.value==t.data.value){if(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+t.data.key+" and activate alarm task"),this._alarmTask){var e=this._alarmTask.getManager(),r=this._alarmTask.getID();e._setAlarmActive(r,!0,function(t){});}}else this._deactivateEvent&&this._deactivateEvent.status==t.data.key&&this._deactivateEvent.value==t.data.value&&(this._logger.log("trace","alarm key:"+this._device.address+" receive event:"+t.data.key+" and deactivate alarm task"),this._alarmTask&&this._alarmTask.deactivate());}},AlarmKey.buildKeyfromJSON=function(t){if(!t||!t.device)return null;var e=new AlarmKey();return e.setID(t.id),e.setDevice(t.device),e.setActivateEvent(t.activateEvent),e.setDeactivateEvent(t.deactivateEvent),e;};var AlarmConfirmation=function AlarmConfirmation(){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask.AlarmConfirmation"),this._id=null,this._device=null,this._activateAction=null,this._deactivateAction=null,this._preAlarmNotificationInterval=null,this._alarmTask=null;};AlarmConfirmation.prototype.setAlarmTask=function(t){this._alarmTask=t;},AlarmConfirmation.prototype.getID=function(){return this._id;},AlarmConfirmation.prototype.setID=function(t){this._id=t;},AlarmConfirmation.prototype.setDevice=function(t){this._device=t;},AlarmConfirmation.prototype.setActivateAction=function(t){this._activateAction=t;},AlarmConfirmation.prototype.setDeactivateAction=function(t){this._deactivateAction=t;},AlarmConfirmation.prototype.toJSON=function(){return{id:this._id,device:this._device,activateAction:this._activateAction,deactivateAction:this._deactivateAction};},AlarmConfirmation.prototype.activationBlockedForAlarmKey=function(){if(this._device&&this._activateAction&&"aio"==this._device.sys&&"HM"==this._device.type&&"ip_siren"==this._device.data){var t=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var e=this;t.executeCommand(this._device,null,{value:"triggerAlarm12,6,2,0",ext:[{value:"alarmAudio",ext:"FREQUENCY_FALLING"},{value:"alarmVisual",ext:"BLINKING_ALTERNATELY_REPEATING"},{value:"alarmDur",ext:1},{value:"alarmDurUnit",ext:"S"}]},function(t){t&&t.error&&e._logger.log("trace","do activate confirmation error:"+t.error.message);});}},AlarmConfirmation.prototype.onActivated=function(){if(this._device&&this._activateAction){var t=this._activateAction;if(t.ref&&(t=t.ref),"sonos"!=this._device.sys||(t=this._buildSonosCommand(this._activateAction.ext))){var e=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do activate confirmation:"+JSON.stringify(this.toJSON()));var r=this;e.executeCommand(this._device,null,t,function(t){t&&t.error&&r._logger.log("trace","do activate confirmation error:"+t.error.message);});}}},AlarmConfirmation.prototype.onDeactivated=function(){if(this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null),this._device&&this._deactivateAction){var t=this._deactivateAction;if(t.ref&&(t=t.ref),"sonos"!=this._device.sys||(t=this._buildSonosCommand(this._deactivateAction.ext))){var e=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do deactivate confirmation:"+JSON.stringify(this.toJSON()));var r=this;e.executeCommand(this._device,null,t,function(t){t&&r._logger.log("trace","do deactivate confirmation error:"+t.message);});}}},AlarmConfirmation.prototype.startPreAlarmNotification=function(){if(!this._preAlarmNotificationInterval){var t=this;this._doPreAlarmNotification(),this._preAlarmNotificationInterval=setInterval(function(){t._doPreAlarmNotification();},7e3);}},AlarmConfirmation.prototype.stopPreAlarmNotification=function(){this._preAlarmNotificationInterval&&(clearInterval(this._preAlarmNotificationInterval),this._preAlarmNotificationInterval=null);},AlarmConfirmation.prototype._doPreAlarmNotification=function(){if(this._device&&this._activateAction){var t=this._activateAction;if(t.ref&&(t=t.ref),"sonos"!=this._device.sys||(t=this._buildSonosCommand("pre_alarm"))){var e=require("x.hub.commandman.js").commandHandler;this._logger.log("trace","do pre alarm notification:"+JSON.stringify(this.toJSON()));var r=this;e.executeCommand(this._device,null,t,function(t){t&&t.error&&r._logger.log("trace","do pre alarm notification error:"+t.error.message);});}}},AlarmConfirmation.prototype._getLocalIP=function(){var t=require("os").networkInterfaces();for(var e in t){for(var r=t[e],i=0;i<r.length;i++){var a=r[i];if(a&&"IPv4"==a.family&&0==a.internal)return a.address;}}return null;},AlarmConfirmation.prototype._getLocalPort=function(){var t=require("x.hub.js");return t.server?t.server._port:null;},AlarmConfirmation.prototype._buildSonosCommand=function(t){var e=this._getLocalIP(),r=this._getLocalPort();if(!e||!r)return null;var i=null;switch(t){case"alarm_on":i="alarm_on.mp3";break;case"alarm_off":i="alarm_off.mp3";break;case"pre_alarm":i="pre_alarm.mp3";break;case"alarm":i="alarm.mp3";break;default:return null;}return{value:"playUrl",ext:"http://"+e+":"+r+"/resources/rehau_alarm/"+i,timeout:15};},AlarmConfirmation.buildConfirmationfromJSON=function(t){if(!t||!t.device)return null;var e=new AlarmConfirmation();return e.setID(t.id),e.setDevice(t.device),e.setActivateAction(t.activateAction),e.setDeactivateAction(t.deactivateAction),e;};var AlarmTask=function AlarmTask(t){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTask"),this._id=t,this._pin=null,this._active=!1,this._delay=0,this._doorAlarmDelay=5,this._alarmKeys=[],this._alarmDoors=[],this._alarmConfirmation=null,this._associateTaskId_alarm=null,this._associateTaskId_prealarm=null,this._activateDelayTimer=null,this._doorAlarmDelayTimer=null,this._manager=null;};AlarmTask.DEFAULT_PIN="0000",AlarmTask.prototype.init=function(t){this._logger.log("trace","init rehau alarm task"),this._initAllAlarmKeys(),this._initAllAlarmDoors(),this._initAllAlarmWindowsSensors(),t&&t();},AlarmTask.prototype._initAllAlarmKeys=function(){for(var t=0;t<this._alarmKeys.length;t++){var e=this._alarmKeys[t];e&&e.init();}},AlarmTask.prototype._initAllAlarmDoors=function(){for(var t=0;t<this._alarmDoors.length;t++){var e=this._alarmDoors[t];e&&e.init();}},AlarmTask.prototype._initAllAlarmWindowsSensors=function(){this._active&&require("x.hub.m.enocean.js").setRehauAlarm(this._active);},AlarmTask.prototype.setManager=function(t){this._manager=t;},AlarmTask.prototype.getManager=function(){return this._manager;},AlarmTask.prototype.getID=function(){return this._id;},AlarmTask.prototype.getDelay=function(){return this._delay;},AlarmTask.prototype.setDelay=function(t){this._delay=t;},AlarmTask.prototype.getAssociateTaskIdAlarm=function(){return this._associateTaskId_alarm;},AlarmTask.prototype.setAssociateTaskIdAlarm=function(t){this._associateTaskId_alarm=t;},AlarmTask.prototype.getAssociateTaskIdPreAlarm=function(){return this._associateTaskId_prealarm;},AlarmTask.prototype.setAssociateTaskIdPreAlarm=function(t){this._associateTaskId_prealarm=t;},AlarmTask.prototype.getPin=function(){return this._pin?this._pin:AlarmTask.DEFAULT_PIN;},AlarmTask.prototype.setPin=function(t){this._pin=t;},AlarmTask.prototype.getDoorAlarmDelay=function(){return this._doorAlarmDelay;},AlarmTask.prototype.setDoorAlarmDelay=function(t){this._doorAlarmDelay=t;},AlarmTask.prototype.isActive=function(){return this._active;},AlarmTask.prototype.isWaitForActive=function(){return!(!this._activateDelayTimer||this._active);},AlarmTask.prototype.cancelDelayActive=function(){this._activateDelayTimer&&clearTimeout(this._activateDelayTimer),this._activateDelayTimer=null,this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer),this._doorAlarmDelayTimer=null;},AlarmTask.prototype.activate=function(){var t=require("x.hub.m.enocean.js");if(t.isRehauWindowOpen())return!0;if(require("x.hub.m.hm.js").isWindowOpen())return!0;var e=this;return this._delay?(this._logger.log("trace","activate alarm task:"+this._id+" after "+this._delay+" seconds"),this._activateDelayTimer=setTimeout(function(){e._logger.log("trace","activate alarm task:"+this._id),e._active=!0,e._setAssociateTaskActive(!0),e._manager&&e._manager.save(),t.setRehauAlarm(!0),e._activateDelayTimer=null,e._alarmConfirmation&&e._alarmConfirmation.onActivated();},1e3*this._delay)):(this._logger.log("trace","activate alarm task:"+this._id),this._active=!0,this._setAssociateTaskActive(!0),this._manager&&this._manager.save(),t.setRehauAlarm(!0),this._alarmConfirmation&&this._alarmConfirmation.onActivated()),!1;},AlarmTask.prototype.deactivate=function(){this._active=!1,this._activateDelayTimer&&clearTimeout(this._activateDelayTimer),this._activateDelayTimer=null,this._doorAlarmDelayTimer&&clearTimeout(this._doorAlarmDelayTimer),this._doorAlarmDelayTimer=null,this._logger.log("trace","deactivate alarm task:"+this._id),this._setAssociateTaskActive(!1),this._manager&&this._manager.save(),require("x.hub.m.enocean.js").setRehauAlarm(!1),this._alarmConfirmation&&this._alarmConfirmation.onDeactivated();},AlarmTask.prototype._setAssociateTaskActive=function(t,e){if(this._manager){var r=0;this._associateTaskId_alarm&&(r+=1),this._associateTaskId_prealarm&&(r+=1);var cb=function cb(){0==--r&&e&&e();};this._associateTaskId_alarm&&this._manager.setAssociateTaskActive(this._associateTaskId_alarm,t,cb),this._associateTaskId_prealarm&&this._manager.setAssociateTaskActive(this._associateTaskId_prealarm,t,cb);}else e&&e(new Error("manager is null"));},AlarmTask.prototype.activationBlockedForAlarmKey=function(){this._alarmConfirmation&&this._alarmConfirmation.activationBlockedForAlarmKey();},AlarmTask.prototype.addAlarmKey=function(t,e){if(t){var r=AlarmKey.buildKeyfromJSON(t);if(r){if(r.getID())e&&e(new Error("id for new alarm key is not null "));else{r.setID(this._generateAlarmKeyID()),this._addAlarmKeySync(r);var i=this;this._manager.save(function(t){e&&e(t,i.toJSON());});}}else e&&e(new Error("alarm key json invalid"));}else e&&e(new Error("alarm key json is null"));},AlarmTask.prototype.updateAlarmKey=function(t,e){if(t){var r=AlarmKey.buildKeyfromJSON(t);if(r){var i=r.getID();if(i){var a=this._getAlarmKeySync(i);if(a){this._deleteAlarmKeySync(a),this._addAlarmKeySync(r);var s=this;this._manager.save(function(t){e&&e(t,s.toJSON());});}else e&&e(new Error("no such alarm key with id:"+i));}else e&&e(new Error("id for alarm key is null"));}else e&&e(new Error("alarm key json invalid"));}else e&&e(new Error("alarm key json is null"));},AlarmTask.prototype.deleteAlarmKey=function(t,e){if(t){var r=this._getAlarmKeySync(t.id);if(r){this._deleteAlarmKeySync(r);var i=this;this._manager.save(function(t){e&&e(t,i.toJSON());});}else e&&e(new Error("no such alarm key with id:"+t.id));}else e&&e(new Error("alarm key is null"));},AlarmTask.prototype.addAlarmDoor=function(t,e){if(t){var r=AlarmDoor.buildDoorfromJSON(t);if(r){if(r.getID())e&&e(new Error("id for new alarm door is not null "));else{r.setID(this._generateAlarmDoorID()),this._addAlarmDoorSync(r);var i=this;this._manager.save(function(t){e&&e(t,i.toJSON());});}}else e&&e(new Error("alarm door json invalid"));}else e&&e(new Error("alarm door json is null"));},AlarmTask.prototype.updateAlarmDoor=function(t,e){if(t){var r=AlarmDoor.buildDoorfromJSON(t);if(r){var i=r.getID();if(i){var a=this._getAlarmDoorSync(i);if(a){this._deleteAlarmDoorSync(a),this._addAlarmDoorSync(r);var s=this;this._manager.save(function(t){e&&e(t,s.toJSON());});}else e&&e(new Error("no such alarm door with id:"+i));}else e&&e(new Error("id for alarm door is null"));}else e&&e(new Error("alarm door json invalid"));}else e&&e(new Error("alarm door json is null"));},AlarmTask.prototype.deleteAlarmDoor=function(t,e){if(t){var r=this._getAlarmDoorSync(t.id);if(r){this._deleteAlarmDoorSync(r);var i=this;this._manager.save(function(t){e&&e(t,i.toJSON());});}else e&&e(new Error("no such alarm door with id:"+t.id));}else e&&e(new Error("alarm door is null"));},AlarmTask.prototype.setAlarmConfirmation=function(t,e){if(t){var r=AlarmConfirmation.buildConfirmationfromJSON(t);if(r){r.setAlarmTask(this);var i=this;this._alarmConfirmation=r,this._manager.save(function(t){e&&e(t,i.toJSON());});}else e&&e(new Error("alarm confirmation json invalid"));}else e&&e(new Error("alarm confirmation json is null"));},AlarmTask.prototype.getAlarmTaskSync=function(t){return this._taskmanager.readTaskSync(t);},AlarmTask.prototype.triggerDoorAlarm=function(){if(this._active){if(!this._doorAlarmDelay)return this._logger.log("trace","no door alarm delay, execute associated task:"+this._associateTaskId_alarm),void(this._associateTaskId_alarm&&this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm));if(!this._doorAlarmDelayTimer){this._alarmConfirmation&&(this._logger.log("trace","door alarm start pre-alarm notification"),this._alarmConfirmation.startPreAlarmNotification()),this._logger.log("trace","door alarm execute associated task:"+this._associateTaskId_alarm+" after "+this._doorAlarmDelay+" seconds");var t=this;this._doorAlarmDelayTimer=setTimeout(function(){t._doorAlarmDelayTimer=null,t._alarmConfirmation&&(t._logger.log("trace","door alarm stop pre-alarm notification"),t._alarmConfirmation.stopPreAlarmNotification()),t._associateTaskId_alarm&&(t._logger.log("trace","door alarm execute associated task:"+t._associateTaskId_alarm),t._manager&&t._manager.executeAssociateTask(t._associateTaskId_alarm));},1e3*this._doorAlarmDelay);}}},AlarmTask.prototype.triggerWindowSensorAlarm=function(t){this._active&&(t&&this._associateTaskId_prealarm?this._manager&&this._manager.executeAssociateTask(this._associateTaskId_prealarm):!t&&this._associateTaskId_alarm&&this._manager&&this._manager.executeAssociateTask(this._associateTaskId_alarm));},AlarmTask.prototype.onStatusEvt=function(t){if(t){for(var e=0;e<this._alarmKeys.length;e++){var r=this._alarmKeys[e];r&&r.matchDevice(t.device)&&r.onStatusEvt(t);}for(var i=0;i<this._alarmDoors.length;i++){var a=this._alarmDoors[i];a&&a.matchDevice(t.device)&&a.onStatusEvt(t);}}},AlarmTask.prototype._getAlarmKeySync=function(t){if(!t)return null;var e=this._alarmKeys.length;if(!e)return null;for(;e--;){var r=this._alarmKeys[e];if(r&&r.getID()==t)return r;}return null;},AlarmTask.prototype._addAlarmKeySync=function(t){t.setAlarmTask(this),this._alarmKeys.push(t),t.init();},AlarmTask.prototype._deleteAlarmKeySync=function(t){t.finalize();var e=this._alarmKeys.indexOf(t);-1!=e&&this._alarmKeys.splice(e,1);},AlarmTask.prototype._getAlarmDoorSync=function(t){if(!t)return null;var e=this._alarmDoors.length;if(!e)return null;for(;e--;){var r=this._alarmDoors[e];if(r&&r.getID()==t)return r;}return null;},AlarmTask.prototype._addAlarmDoorSync=function(t){t.setAlarmTask(this),this._alarmDoors.push(t),t.init();},AlarmTask.prototype._deleteAlarmDoorSync=function(t){t.finalize();var e=this._alarmDoors.indexOf(t);-1!=e&&this._alarmDoors.splice(e,1);},AlarmTask.prototype._generateAlarmKeyID=function(){var t=[],e=this._alarmKeys.length;if(0==e)return 1;for(;e--;){var r=this._alarmKeys[e];r&&(t[r.getID()]=!0);}for(var i=1;t[i];){i++;}return i;},AlarmTask.prototype._generateAlarmDoorID=function(){var t=[],e=this._alarmDoors.length;if(0==e)return 1;for(;e--;){var r=this._alarmDoors[e];r&&(t[r.getID()]=!0);}for(var i=1;t[i];){i++;}return i;},AlarmTask.prototype._getActivationDelayTimer=function(t){return this._activateDelayTimer[t];},AlarmTask.prototype._clearActivationDelayTimer=function(t){var e=this._activateDelayTimer[t];e&&clearTimeout(e),delete this._activateDelayTimer[t];},AlarmTask.prototype.toJSON=function(){for(var t={id:this._id,active:this._active,delay:this._delay,doorAlarmDelay:this._doorAlarmDelay,alarmKeys:[],alarmDoors:[],alarmConfirmation:null,associateTaskId_alarm:this._associateTaskId_alarm,associateTaskId_prealarm:this._associateTaskId_prealarm},e=0;e<this._alarmKeys.length;e++){var r=this._alarmKeys[e];if(r){var i=r.toJSON();i&&t.alarmKeys.push(i);}}for(var a=0;a<this._alarmDoors.length;a++){var s=this._alarmDoors[a];if(s){var o=s.toJSON();o&&t.alarmDoors.push(o);}}return this._alarmConfirmation&&(t.alarmConfirmation=this._alarmConfirmation.toJSON()),t;},AlarmTask.buldTaskFromJSON=function(t){if(!t||!t.id)return null;var e=new AlarmTask(t.id);if(e._pin=t.pin,e._active=t.active,e._delay=t.delay,e._doorAlarmDelay=t.doorAlarmDelay,e._associateTaskId_alarm=t.associateTaskId_alarm,e._associateTaskId_prealarm=t.associateTaskId_prealarm,t.alarmKeys)for(var r=0;r<t.alarmKeys.length;r++){var i=t.alarmKeys[r];if(i){var a=AlarmKey.buildKeyfromJSON(i);a&&(a.setAlarmTask(e),e._alarmKeys.push(a));}}if(t.alarmDoors)for(var s=0;s<t.alarmDoors.length;s++){var o=t.alarmDoors[s];if(o){var n=AlarmDoor.buildDoorfromJSON(o);n&&(n.setAlarmTask(e),e._alarmDoors.push(n));}}if(t.alarmConfirmation){var l=AlarmConfirmation.buildConfirmationfromJSON(t.alarmConfirmation);l&&(l.setAlarmTask(e),e._alarmConfirmation=l);}return e;};var Auth=function Auth(t){this._alarmTaskTokenPoll=[],this._manager=t;};Auth.prototype.generateToken=function(t){var e=this._manager._getAlarmTask(t);if(null==e)return null;if(this._alarmTaskTokenPoll.length>100)return null;for(var r=this._generateNonce();this._nonceExist(r);){r=this._generateNonce();}var i=e.getPin(),a=this._hashPin(r,i),s=this,o={nonce:r,hash:a,taskID:t,timeout:null,failedCount:0};return this._alarmTaskTokenPoll.push(o),o.timeout=setTimeout(function(){s._tokenExpired(o);},3e4),r;},Auth.prototype.authenticate=function(t,e){if(null==this._manager._getAlarmTask(t))return!1;if(e.length<=20)return!1;for(var r=e.substr(0,20),i=e.substr(20),a=null,s=0;s<this._alarmTaskTokenPoll.length;s++){var o=this._alarmTaskTokenPoll[s];if(o&&o.nonce==r&&o.hash==i&&o.taskID==t)return this._tokenExpired(o),!0;o&&o.nonce==r&&(a=o);}return a&&(a.failedCount+=1,a.failedCount>=3&&this._tokenExpired(a)),!1;},Auth.prototype.expireAllToken=function(t){var e,r,i=[];for(e=0;e<this._alarmTaskTokenPoll.length;e++){(r=this._alarmTaskTokenPoll[e])&&r.taskID==t&&i.push(r);}if(i&&i.length>0)for(e=0;e<this._alarmTaskTokenPoll.length;e++){r=this._alarmTaskTokenPoll[e],this._tokenExpired(r);}return!1;},Auth.prototype._tokenExpired=function(t){t.timeout&&(clearTimeout(t.timeout),t.timeout=null);var e=this._alarmTaskTokenPoll.indexOf(t);-1!=e&&this._alarmTaskTokenPoll.splice(e,1);},Auth.prototype._nonceExist=function(t){for(var e=0;e<this._alarmTaskTokenPoll.length;e++){var r=this._alarmTaskTokenPoll[e];if(r&&r.nonce==t)return!0;}return!1;},Auth.prototype._generateNonce=function(){return require("crypto").randomBytes(10).toString("hex");},Auth.prototype._hashPin=function(t,e){var r=t.substr(5,4),i=require("crypto").createHash("sha1");return i.update(r+e),i.digest("hex");};var Manager=function Manager(t){this._logger=Logger.getLogger("x.hub.taskman.rehau.AlarmTaskManager"),this._taskmanager=t,this._alarmTasks=[],this._auth=new Auth(this);};return Manager.FILE_NAME="alarm_rehau.json",Manager.prototype.init=function(t){this._logger.log("trace","init rehau alarm task manager");var e=this;this._loadSettings(function(r){r&&e._logger.log("warn","init rehau alarm task manager error:"+r.message),e._setupDefaultAlarmTask(),e._initAllAlarmTasks(),t&&t();});},Manager.prototype.save=function(t){this._saveSettings(t);},Manager.prototype.challenge=function(t,e){if(this._getAlarmTask(t)){var r=this._auth.generateToken(t);e&&e(r?null:new Error("generate token failed"),{token:r});}else e&&e(new Error("no such alarm task with id:"+t));},Manager.prototype.getAlarmInfo=function(t){var e=this._toSettingsJSON();t&&t(null,e);},Manager.prototype.setAlarmDelay=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.setDelay(e),this._saveSettings(function(t){i&&i(t,a.toJSON());});}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.selectAssociateTaskAlarm=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){var s=null;if(!e||(s=this._taskmanager.readTaskSync(e))){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var o=new Error("pin error");return o.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(o));}var n=a.getAssociateTaskIdPreAlarm(),l=a.getAssociateTaskIdAlarm();if(l&&l!=e&&l!=n){var h=this._taskmanager.readTaskSync(l);h&&h.setRehauAlarmTask(!1);}a.setAssociateTaskIdAlarm(e),s&&(s.setRehauAlarmTask(!0),s.setActive(!1));var u=this;this._saveSettings(function(t){t?i&&i(t):u._taskmanager.save(function(t){i&&i(t,a.toJSON());});});}}else i&&i(new Error("no such task with id:"+e));}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.selectAssociateTaskPreAlarm=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){var s=null;if(!e||(s=this._taskmanager.readTaskSync(e))){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var o=new Error("pin error");return o.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(o));}var n=a.getAssociateTaskIdAlarm(),l=a.getAssociateTaskIdPreAlarm();if(l&&l!=e&&l!=n){var h=this._taskmanager.readTaskSync(l);h&&h.setRehauAlarmTask(!1);}a.setAssociateTaskIdPreAlarm(e),s&&(s.setRehauAlarmTask(!0),s.setActive(!1));var u=this;this._saveSettings(function(t){t?i&&i(t):u._taskmanager.save(function(t){i&&i(t,a.toJSON());});});}}else i&&i(new Error("no such task with id:"+e));}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.setAlarmActive=function(t,e,r,i){if(!e&&!this._auth.authenticate(t,r)){var a=new Error("pin error");return a.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(a));}this._setAlarmActive(t,e,i);},Manager.prototype._setAlarmActive=function(t,e,r){for(var i=null,a=0;a<this._alarmTasks.length;a++){if(this._alarmTasks[a])if(this._alarmTasks[a].getID()==t)i=this._alarmTasks[a];else{if(this._alarmTasks[a].isActive())return void(r&&r(new Error("another alarm task with id:"+this._alarmTasks[a].getID()+" is active")));this._alarmTasks[a].isWaitForActive()&&this._alarmTasks[a].cancelDelayActive();}}if(i){if(e&&i.isActive())r&&r(null,i.toJSON());else if(!e||i.isActive())i.deactivate(),r&&r(null,i.toJSON());else if(i.activate()){var s=new Error("rehau window is open");s.code="200002",r&&r(s);}else r&&r(null,i.toJSON());}else r&&r(new Error("no such alarm task with id:"+t));},Manager.prototype.setNewPin=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.getPin()!=e?(a.setPin(e),this._auth.expireAllToken(t),this._saveSettings(function(t){i&&i(t);})):i&&i();}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.setDoorAlarmDelay=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.setDoorAlarmDelay(e),this._saveSettings(function(t){i&&i(t,a.toJSON());});}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.addAlarmKey=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.addAlarmKey(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.updateAlarmKey=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.updateAlarmKey(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.deleteAlarmKey=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.deleteAlarmKey(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.addAlarmDoor=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.addAlarmDoor(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.updateAlarmDoor=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.updateAlarmDoor(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.deleteAlarmDoor=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.deleteAlarmDoor(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.setAlarmConfirmation=function(t,e,r,i){var a=this._getAlarmTask(t);if(a){if(a.isActive())i&&i(new Error("alarm task is active"));else{if(!this._auth.authenticate(t,r)){var s=new Error("pin error");return s.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(s));}a.setAlarmConfirmation(e,i);}}else i&&i(new Error("no such alarm task with id:"+t));},Manager.prototype.setAssociateTaskActive=function(t,e,r){var i=this._taskmanager.readTaskSync(t);i?(i.setActive(e),this._taskmanager.save(r)):r&&r(new Error("no such task with id:"+t));},Manager.prototype.executeAssociateTask=function(t,e){var r=this._taskmanager.readTaskSync(t);r?r.trigger(e):e&&e(new Error("no such task with id:"+t));},Manager.prototype.onStatusEvtForTask=function(t,e){this._logger.log("debug","for task:"+e+" receive status event:"+JSON.stringify(t));var r=this._getAlarmTask(e);r&&r.onStatusEvt(t);},Manager.prototype.onWindowSensorAlarmTriggered=function(t){for(var e=0;e<this._alarmTasks.length;e++){var r=this._alarmTasks[e];r&&r.isActive()&&r.triggerWindowSensorAlarm(t);}},Manager.prototype._getAlarmTask=function(t){for(var e=0;e<this._alarmTasks.length;e++){var r=this._alarmTasks[e];if(r&&r.getID()==t)return r;}return null;},Manager.prototype._isAlarmTaskActive=function(t){},Manager.prototype._setupDefaultAlarmTask=function(){var t=null;if(0==this._alarmTasks.length&&((t=new AlarmTask(1)).setManager(this),this._alarmTasks.push(t)),1==this._alarmTasks.length){var e=1==(t=this._alarmTasks[0]).getID()?2:1;(t=new AlarmTask(e)).setManager(this),this._alarmTasks.push(t);}},Manager.prototype._initAllAlarmTasks=function(){for(var t=0;t<this._alarmTasks.length;t++){var e=this._alarmTasks[t];e&&e.init();}},Manager.prototype._loadSettings=function(t){var e=this,r=this._getFile();fs_extra.ensureFile(r,function(i){i?t&&t(i):e._loadFile(r,function(r,i){r?t&&t(r):(e._fromSettingsJSON(i),t&&t());});});},Manager.prototype._saveSettings=function(t){var e=this._getFile(),r=this._toSettingsJSON();this._saveFile(e,r,function(e){t&&t(e);});},Manager.prototype._fromSettingsJSON=function(t){if(t&&Array.isArray(t))for(var e=0;e<t.length;e++){var r=t[e],i=AlarmTask.buldTaskFromJSON(r);i&&(i.setManager(this),this._alarmTasks.push(i));}},Manager.prototype._toSettingsJSON=function(){for(var t=[],e=0;e<this._alarmTasks.length;e++){var r=this._alarmTasks[e];r&&t.push(r.toJSON());}return t;},Manager.prototype._loadFile=function(t,e){fs.readFile(t,"utf8",function(t,r){if(t)e&&e(t);else if(r)try{var i=JSON.parse(r);e&&e(null,i);}catch(t){e&&e(t);}else e&&e(null,null);});},Manager.prototype._saveFile=function(t,e,r){fs.writeFile(t,JSON.stringify(e,null,2),function(t){r&&r(t);});},Manager.prototype._getFile=function(){var t=fileman.fileManager.getUserRootDataPath();return path.resolve(t,Manager.FILE_NAME);},Manager;}(),x.hub.taskman.TaskManager=function(){var TM=function TM(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.TaskManager"),this.version=TM.TMP_VERSION,this._tasks=[],this._alarmTask=new x.hub.taskman.AlarmTask(),this._mode=31,this._lock=!1;};return TM.TMP_VERSION="1.0.0",TM.NS_VERSION="2.3.2",TM.FILE_NAME="tm.json",TM.prototype.init=function(t){this._alarmTask.init(),this._load(t);},TM.prototype.clear=function(){for(var t=0;t<this._tasks.length;t++){try{this._tasks[t].finalize();}catch(t){}}x.hub.taskman._TimerManager.clear(),x.hub.taskman._AstroManager.clear(),x.hub.taskman._PeriodicTimerManager.clear(),this._tasks=[];},TM.prototype.save=function(t){this._writeData(t);},TM.prototype.reload=function(t){this.clear(),this._load(t);},TM.prototype["import"]=function(t,e){var r=this;this._writeFile(t,function(t){t?e&&e(t):r.reload(e);});},TM.prototype._load=function(t){var e=this,r=require("fs-extra"),i=this._getFile();r.ensureFile(i,function(r){r?t&&t(r):e._loadData(function(r,i){r?t&&t(r):(e._tasks=i,e._sort(),e._lock||i.forEach(function(t){try{t.init();}catch(t){console.error(t);}}),t&&t());});});},TM.prototype.lock=function(){this._lock=!0;},TM.prototype.unlock=function(){this._lock=!1;},TM.prototype.createTask=function(t,e){if(t){for(var r=1,i=-1,a=0;a<this._tasks.length;a++){if(this._tasks[a].id>r){t.id=r,i=a;break;}r++;}-1==i&&(t.id=r,i=this._tasks.length),this._tasks.splice(i,0,t),this._lock||t.init(),this._writeData(function(r){r?e&&e(r):e&&e(null,t.toJSON());});}else e&&e(new Error("task is null"));},TM.prototype.readTask=function(t,e){if(t){for(var r=null,i=0;i<this._tasks.length;i++){var a=this._tasks[i];if(a.id==t){r=a;break;}}r?e&&e(null,r):e&&e(new Error("no such task with id:"+t));}else e&&e(new Error("task id is null"));},TM.prototype.readAllTasks=function(t){t&&t(null,this._tasks);},TM.prototype.updateTask=function(t,e,r){for(var i=null,a=-1,s=0;s<this._tasks.length;s++){var o=this._tasks[s];if(o.id==t.id){i=o,a=s;break;}}if(i){if(i.isAlarmTask){if(this._alarmTask._active)return void(r&&r(new Error("alarm task active")));var n=this._alarmTask._getAlarmPin();if(!e||e!=n){var l=new Error("pin error");return l.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(l));}}i.isRehauAlarmTask()&&i.isActive()?r&&r(new Error("rehau alarm task active")):(i.finalize(),this._tasks.splice(a,1,t),this._lock||t.init(),this._writeData(r));}else r&&r(new Error("no such task with id:"+t.id));},TM.prototype.deleteTask=function(t,e,r){if(t){for(var i=-1,a=null,s=0;s<this._tasks.length;s++){var o=this._tasks[s];if(o.id==t){i=s,a=o;break;}}if(a.isAlarmTask){if(this._alarmTask._active)return void(r&&r(new Error("alarm task active")));var n=this._alarmTask._getAlarmPin();if(!e||e!=n){var l=new Error("pin error");return l.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(l));}}a.isRehauAlarmTask()&&a.isActive()?r&&r(new Error("rehau alarm task active")):(a.finalize(),-1!=i&&this._tasks.splice(i,1),this._writeData(r));}else r&&r(new Error("task id is null"));},TM.prototype.setTaskActive=function(t,e,r,i){if(t){for(var a=null,s=0;s<this._tasks.length;s++){var o=this._tasks[s];if(o.id==t){a=o;break;}}if(a){if(a.isAlarmTask){if(this._alarmTask._active)return void(i&&i(new Error("alarm task active")));var n=this._alarmTask._getAlarmPin();if(!r||r!=n){var l=new Error("pin error");return l.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(i&&i(l));}}a.isRehauAlarmTask()?i&&i(new Error("do not allow to set active state for rehau alarm task")):(a.setActive(e),this._writeData(i));}else i&&i(new Error("no such task:"+t));}else i&&i(new Error("task id is null"));},TM.prototype.doTask=function(t,e,r){if(t){for(var i=null,a=0;a<this._tasks.length;a++){var s=this._tasks[a];if(s.id==t){a,i=s;break;}}if(i.isAlarmTask){if(this._alarmTask._active)return void(r&&r(new Error("alarm task active")));var o=this._alarmTask._getAlarmPin();if(!e||e!=o){var n=new Error("pin error");return n.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(n));}}i.trigger(r);}else r&&r(new Error("task id is null"));},TM.prototype.cancelTask=function(t,e,r){if(t){for(var i=null,a=0;a<this._tasks.length;a++){var s=this._tasks[a];if(s.id==t){a,i=s;break;}}if(i){if(i.isAlarmTask){if(this._alarmTask._active)return void(r&&r(new Error("alarm task active")));var o=this._alarmTask._getAlarmPin();if(!e||e!=o){var n=new Error("pin error");return n.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(n));}}i.cancel(r);}else r&&r(new Error("no such task"));}else r&&r(new Error("task id is null"));},TM.prototype.toggleTaskActive=function(t,e,r){if(t){for(var i=null,a=0;a<this._tasks.length;a++){var s=this._tasks[a];if(s.id==t){i=s;break;}}if(i){if(i.isAlarmTask){var o=this._alarmTask._getAlarmPin();if(!e||e!=o){var n=new Error("pin error");return n.code=x.hub.taskman.ERROR_CODE.Pin_Error,void(r&&r(n));}}i.toggleActive(),this._writeData(r);}else r&&r(new Error("no such task:"+t));}else r&&r(new Error("task id is null"));},TM.prototype.isTaskRunning=function(t,e){if(t){for(var r=null,i=0;i<this._tasks.length;i++){var a=this._tasks[i];if(a.id==t){i,r=a;break;}}r?e&&e(null,r.isRunning()):e&&e(new Error("no such task"));}else e&&e(new Error("task id is null"));},TM.prototype.getCloudDeviceTriggerGateway=function(t){for(var e=null,r=0;r<this._tasks.length;r++){var i=this._tasks[r];if(i&&(e=i.getCloudDeviceTriggerGateway()))break;}t&&t(null,e);},TM.prototype.readTaskSync=function(t){if(!t)return null;for(var e=null,r=0;r<this._tasks.length;r++){var i=this._tasks[r];if(i.id==t){e=i;break;}}return e;},TM.prototype.startTaskTrace=function(t,e,r){this.readTask(t,function(t,i){t?r&&r(t):i.startTaskTrace(e,function(t){r&&r(t);});});},TM.prototype.stopTaskTrace=function(t,e,r){this.readTask(t,function(t,i){t?r&&r(t):i.stopTaskTrace(e,function(t){r&&r(t);});});},TM.prototype.setAlarmActive=function(t,e,r){this._alarmTask.setAlarmActive(t,e,this,r);},TM.prototype.setAlarmDelay=function(t,e,r){this._alarmTask.setAlarmDelay(t,e,r);},TM.prototype.getAlarmInfo=function(t){this._alarmTask.getAlarmInfo(t);},TM.prototype.selectAlarmTask=function(t,e,r,i){var a=this;this._alarmTask.selectAlarmTask(t,e,r,this._tasks,function(t){t?i&&i(t):a._writeData(i);});},TM.prototype._getAlarmPin=function(){return this._alarmTask._getAlarmPin();},TM.prototype.setAlarmPin=function(t,e,r){this._alarmTask.setAlarmPin(t,e,r);},TM.prototype.onStatusEvt=function(t){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","receive status event:"+JSON.stringify(t));for(var e=0;e<this._tasks.length;e++){if(e>=2&&this._mode%31!=0)return;this._tasks[e].onStatusEvt(t);}}},TM.prototype.onStatusEvtForTask=function(t,e){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("debug","for task:"+e+" receive status event:"+JSON.stringify(t));for(var r=0;r<this._tasks.length;r++){if(r>=2&&this._mode%31!=0)return;var i=this._tasks[r];i.id==e&&i.onStatusEvtForTask(t);}}},TM.prototype.onIREvt=function(t){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive ir event:"+JSON.stringify(t));for(var e=0;e<this._tasks.length;e++){if(e>=2&&this._mode%31!=0)return;this._tasks[e].onIREvt(t);}}},TM.prototype.onLocationChange=function(t){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onLocationChange(t),x.hub.taskman._AstroManager.onLocationChange(t),x.hub.taskman._PeriodicTimerManager.onLocationChange(t));},TM.prototype.onTimeChange=function(t){this._lock?this._logger.log("debug","task manager locked"):(x.hub.taskman._TimerManager.onTimeChange(t),x.hub.taskman._AstroManager.onTimeChange(t),x.hub.taskman._PeriodicTimerManager.onTimeChange(t));},TM.prototype.onTimerTick=function(t,e){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive time tick for task:"+t);for(var r=0;r<this._tasks.length;r++){if(r>=2&&this._mode%31!=0)return;var i=this._tasks[r];i.id==t&&i.onTimerTick(e);}}},TM.prototype.onHttpEvt=function(t,e){if(this._lock)this._logger.log("debug","task manager locked");else{this._logger.log("info","receive http event"+JSON.stringify(t));var r=!1,i=0;i=this._tasks.length,this._mode%31!=0&&i>2&&(i=2);for(var a=0;a<this._tasks.length;a++){if(a>=2&&this._mode%31!=0)return;this._tasks[a].onHttpEvt(t,function(t,a){a&&(r=!0),0==--i&&e&&e(null,r);});}}},TM.prototype.onActivation=function(t){this.version=t?TM.NS_VERSION:TM.TMP_VERSION;},TM.prototype._writeData=function(t){var e=[];this._tasks.forEach(function(t){t&&e.push(t.toJSON());}),this._writeFile(e,t);},TM.prototype._loadData=function(t){var e=require("fs"),r=this._getFile();e.readFile(r,"utf8",function(e,r){if(e)t&&t(e);else if(r)try{var i=JSON.parse(r),a=[];Array.isArray(i)&&i.forEach(function(t){var e=x.hub.taskman.Task.parse(t);e&&a.push(e);}),t&&t(null,a||[]);}catch(e){t&&t(e);}else t&&t(null,[]);});},TM.prototype._writeFile=function(t,e){var r=require("fs"),i=this._getFile();r.writeFile(i,JSON.stringify(t,null,2),function(t){e&&e(t);});},TM.prototype._getFile=function(){var t=require("x.hub.fileman.js").fileManager,e=require("path"),r=(require("fs"),t.getUserRootDataPath());return e.resolve(r,TM.FILE_NAME);},TM.prototype._sort=function(){var t=this._tasks.length-1,e=!1;do{e=!1;for(var r=0;r<t;++r){if(this._tasks[r].id>this._tasks[r+1].id){var i=this._tasks[r];this._tasks[r]=this._tasks[r+1],this._tasks[r+1]=i,e=!0;}}}while(e);},TM;}(),x.hub.taskman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.taskman.Handler"),this.taskManager=new x.hub.taskman.TaskManager(),this._rehauAlarmTaskManager=new x.hub.taskman.rehau.AlarmTaskManager(this.taskManager);var t=require("x.hub.eventbus.js");t.on("status",this.onStatusEvt.bind(this)),t.on("irevt",this.onIREvt.bind(this)),t.on("locationchange",this.onLocationChange.bind(this)),t.on("timechange",this.onTimeChange.bind(this)),t.on("neoserver_activation",this.onActivation.bind(this));};return Handler.prototype.TaskManager=x.hub.taskman.TaskManager,Handler.prototype.Task=x.hub.taskman.Task,Handler.prototype.Cloud=x.hub.taskman.Cloud,Handler.prototype.Util=x.hub.taskman._Util,Handler.prototype.init=function(t){if(this._logger.log("info","init task manager"),localStorage){"true"==localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(this.taskManager.version=x.hub.taskman.TaskManager.NS_VERSION);var e=localStorage.getItem("x.hub.taskman.CLOUD_SERVER");e&&(x.hub.taskman.Cloud.prototype.URL=e);}var r=this;this.taskManager.init(function(){r._rehauAlarmTaskManager.init(t);});},Handler.prototype.getRehauAlarmTaskManager=function(){return this._rehauAlarmTaskManager;},Handler.prototype.lock=function(){this.taskManager.lock();},Handler.prototype.unlock=function(){this.taskManager.unlock();},Handler.prototype.doWebRequest=function(t,e,r){var cb=function cb(t){if(t.error){var e=x.hub.taskman.ERROR_CODE.General_Error;t.error.code&&(e=t.error.code),r(JSON.stringify({XC_ERR:{code:e,msg:t.error.message}}));}else r(JSON.stringify({XC_SUC:void 0!==t.data&&null!=t.data?t.data:""}));};switch(t){case"Read":var i=e.query.id;void 0===i?this.readAllTasks(cb):this.readTask(i,cb);break;case"Create":this.createTask(e.query.data,cb);break;case"Update":this.updateTask(e.query.data,e.query.pin,cb);break;case"Delete":this.deleteTask(e.query.id,e.query.pin,cb);break;case"Do":this.doTask(e.query.id,e.query.pin,cb);break;case"Cancel":this.cancelTask(e.query.id,e.query.pin,cb);break;case"isRunning":this.isTaskRunning(e.query.id,cb);break;case"SetTaskActive":this.setTaskActive(e.query.id,e.query.active,e.query.pin,cb);break;case"ToggleTaskActive":this.toggleTaskActive(e.query.id,e.query.pin,cb);break;case"SetAlarmActive":this.setAlarmActive(e.query.active,e.query.pin,cb);break;case"SetAlarmDelay":this.setAlarmDelay(e.query.delay,e.query.pin,cb);break;case"GetAlarmInfo":this.getAlarmInfo(cb);break;case"SelectAlarmTask":this.selectAlarmTask(e.query.id,e.query.isAlarmTask,e.query.pin,cb);break;case"SetAlarmPin":this.setAlarmPin(e.query.newPin,e.query.pin,cb);break;case"GetCloudServer":cb({data:x.hub.taskman.Cloud.prototype.URL});break;case"SetCloudServer":if(!e.query.url)return void cb({error:new Error("url invalid")});"http"!=e.query.url.substr(0,4)&&(e.query.url="https://"+e.query.url),localStorage.setItem("x.hub.taskman.CLOUD_SERVER",e.query.url),x.hub.taskman.Cloud.prototype.URL=e.query.url,cb({data:"success"});break;case"GetCloudDeviceTriggerGateway":this.getCloudDeviceTriggerGateway(cb);break;default:if(t&&0==t.indexOf("Rehau"))return void this.doRehauWebRequest(t,e,r);}},Handler.prototype.doRehauWebRequest=function(t,e,r){var cb=function cb(t){if(t.error){var e=x.hub.taskman.ERROR_CODE.General_Error;t.error.code&&(e=t.error.code),r(JSON.stringify({XC_ERR:{code:e,msg:t.error.message}}));}else r(JSON.stringify({XC_SUC:void 0!==t.data&&null!=t.data?t.data:""}));};switch(t){case"RehauPinChallenge":this._rehauAlarmTaskManager.challenge(e.query.id,function(t,e){cb({error:t,data:e});});break;case"RehauGetAlarmInfo":this._rehauAlarmTaskManager.getAlarmInfo(function(t,e){cb({error:t,data:e});});break;case"RehauSetAlarmDelay":this._rehauAlarmTaskManager.setAlarmDelay(e.query.id,e.query.delay,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSetDoorAlarmDelay":this._rehauAlarmTaskManager.setDoorAlarmDelay(e.query.id,e.query.delay,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSetAlarmActive":this._rehauAlarmTaskManager.setAlarmActive(e.query.id,e.query.active,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSelectAssociateTaskAlarm":this._rehauAlarmTaskManager.selectAssociateTaskAlarm(e.query.id,e.query.associateTaskId,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSelectAssociateTaskPreAlarm":this._rehauAlarmTaskManager.selectAssociateTaskPreAlarm(e.query.id,e.query.associateTaskId,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSetNewPin":this._rehauAlarmTaskManager.setNewPin(e.query.id,e.query.pin,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauAddAlarmKey":this._rehauAlarmTaskManager.addAlarmKey(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauUpdateAlarmKey":this._rehauAlarmTaskManager.updateAlarmKey(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauDeleteAlarmKey":this._rehauAlarmTaskManager.deleteAlarmKey(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauAddAlarmDoor":this._rehauAlarmTaskManager.addAlarmDoor(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauUpdateAlarmDoor":this._rehauAlarmTaskManager.updateAlarmDoor(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauDeleteAlarmDoor":this._rehauAlarmTaskManager.deleteAlarmDoor(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});break;case"RehauSetAlarmConfirmation":this._rehauAlarmTaskManager.setAlarmConfirmation(e.query.id,e.query.data,e.query.token,function(t,e){cb({error:t,data:e});});}},Handler.prototype.readAllTasks=function(t){this.taskManager.readAllTasks(function(e,r){if(e)t&&t({error:e});else{var i=[];r.forEach(function(t){i.push(t.toJSON());}),t&&t({data:i});}});},Handler.prototype.createTask=function(t,e){if(t){t.id||(t.id=-1);var r=x.hub.taskman.Task.parse(t);r?this.taskManager.createTask(r,function(t,r){e&&e({error:t,data:r});}):e&&e({error:new Error("task json invalid")});}else e&&e({error:new Error("task json is null")});},Handler.prototype.readTask=function(t,e){this.taskManager.readTask(t,function(t,r){e&&e({error:t,data:r?r.toJSON():null});});},Handler.prototype.updateTask=function(t,e,r){if(t){var i=x.hub.taskman.Task.parse(t);i?this.taskManager.updateTask(i,e,function(t){r&&r({error:t});}):r&&r({error:new Error("task json invalid")});}else r&&r({error:new Error("task json is null")});},Handler.prototype.deleteTask=function(t,e,r){this.taskManager.deleteTask(t,e,function(t){r&&r({error:t});});},Handler.prototype.setTaskActive=function(t,e,r,i){this.taskManager.setTaskActive(t,e,r,function(t){i&&i({error:t});});},Handler.prototype.doTask=function(t,e,r){this.taskManager.doTask(t,e,function(t){r&&r({error:t});});},Handler.prototype.cancelTask=function(t,e,r){this.taskManager.cancelTask(t,e,function(t){r&&r({error:t});});},Handler.prototype.toggleTaskActive=function(t,e,r){this.taskManager.toggleTaskActive(t,e,function(t){r&&r({error:t});});},Handler.prototype.isTaskRunning=function(t,e){this.taskManager.isTaskRunning(t,function(t,r){e&&e({error:t,data:r});});},Handler.prototype.getCloudDeviceTriggerGateway=function(t){this.taskManager.getCloudDeviceTriggerGateway(function(e,r){e?t&&t({error:e}):(r||(r={}),t&&t({data:r}));});},Handler.prototype.importTasks=function(t,e){this.taskManager["import"](t,function(t){e&&e({error:t});});},Handler.prototype.startTaskTrace=function(t,e,r){this.taskManager.startTaskTrace(t,e,function(t){r&&r({error:t});});},Handler.prototype.stopTaskTrace=function(t,e,r){this.taskManager.stopTaskTrace(t,e,function(t){r&&r({error:t});});},Handler.prototype.setAlarmActive=function(t,e,r){this.taskManager.setAlarmActive(t,e,function(t){r&&r({error:t});});},Handler.prototype.setAlarmDelay=function(t,e,r){this.taskManager.setAlarmDelay(t,e,function(t){r&&r({error:t});});},Handler.prototype.getAlarmInfo=function(t){this.taskManager.getAlarmInfo(function(e,r){t&&t({error:e,data:r});});},Handler.prototype.selectAlarmTask=function(t,e,r,i){this.taskManager.selectAlarmTask(t,e,r,function(t){i&&i({error:t});});},Handler.prototype.setAlarmPin=function(t,e,r){this.taskManager.setAlarmPin(t,e,function(t){r&&r({error:t});});},Handler.prototype._getAlarmPin=function(){return this.taskManager._getAlarmPin();},Handler.prototype.onStatusEvt=function(t,e){e&&"taskman"==e.src&&e.taskID?(this._logger.log("trace","receive for task: "+e.taskID+" status event:"+JSON.stringify(t)),this.taskManager.onStatusEvtForTask(t,e.taskID)):e&&"rehau:alarmTask"==e.src&&e.alarmTaskID?(this._logger.log("trace","receive for rehau alarm task: "+e.alarmTaskID+" status event:"+JSON.stringify(t)),this._rehauAlarmTaskManager.onStatusEvtForTask(t,e.alarmTaskID)):(this._logger.log("trace","receive status event:"+JSON.stringify(t)),this.taskManager.onStatusEvt(t));},Handler.prototype.onIREvt=function(t){this._logger.log("trace","receive ir event:"+JSON.stringify(t)),this.taskManager.onIREvt(t);},Handler.prototype.onLocationChange=function(t){this._logger.log("trace","receive location change event:"+JSON.stringify(t)),this.taskManager.onLocationChange(t);},Handler.prototype.onTimeChange=function(t){this._logger.log("trace","receive time change event:"+JSON.stringify(t)),this.taskManager.onTimeChange(t);},Handler.prototype.onActivation=function(t){this._logger.log("trace","receive activation change event:"+t);var e=!1;"true"==t&&(e=!0),this.taskManager.onActivation(e);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.taskman.Handler());