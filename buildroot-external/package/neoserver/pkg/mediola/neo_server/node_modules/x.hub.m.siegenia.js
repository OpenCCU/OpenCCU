var x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.siegenia=x.hub.m.siegenia||{},x.hub.m.siegenia.SIEGENIA_MODULE=require("xnm.aio.siegenia.js"),x.hub.m.siegenia.Handler=function(){this._logger=require("x.logger.js").getLogger("x.hub.m.siegenia.Handler"),this._devices={},this._on={};},x.hub.m.siegenia.Handler.prototype.init=function(e){e&&e();},x.hub.m.siegenia.Handler.prototype.getSystems=function(){return["siegenia"];},x.hub.m.siegenia.Handler.prototype.addStateDevice=function(e,i,a){if(e){if(!e.address&&e.ip||(e.ip=e.address),e.ip){var t=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(e);if(t){var r=this._devices[e.ip];if(!r){r={dev:e,obj:t,metas:[a]},this._devices[e.ip]=r;var n=this;return r.obj.startMonitoring(function(i){n._checkStateChange(e,i);},function(){}),void(i&&i({}));}a&&r.metas.push(a),e.password==r.dev.password&&e.password==r.obj.password||(r.dev.password=e.password,r.obj.password=e.password),i&&i({});}else i&&i({error:new Error("device json unknow device")});}else i&&i({error:new Error("device json invalid")});}else i&&i({error:new Error("device json invalid")});},x.hub.m.siegenia.Handler.prototype.removeStateDevice=function(e,i,a){if(e){if(a){var t=this._devices[e.ip];if(t){var r=t.metas;if(r){for(var n=-1,s=0;s<r.length;s++){var o=r[s];if(o&&"taskman"==o.src&&"taskman"==a.src&&o.taskID==a.taskID&&o.statusKey==a.statusKey){n=s;break;}}if(n>=0&&r.splice(n,1),0==r.length)return delete this._devices[e.ip],void x.hub.m.siegenia.SIEGENIA_MODULE.SessionManager.stopMonitorSession(t.obj,function(){i&&i();});}i&&i();}else i&&i({});}}else i&&i({error:new Error("device json invalid")});},x.hub.m.siegenia.Handler.prototype.updateStates=function(e,i){var a=x.hub.m.siegenia.SIEGENIA_MODULE.resolveDevice(e);a?a.getSingleDeviceStatesCreator(null,e,null,function(e,a){i&&i({error:e,data:a});}):i&&i({error:new Error("device json invalid")});},x.hub.m.siegenia.Handler.prototype.getStates=function(e){return{};},x.hub.m.siegenia.Handler.prototype.getAllStates=function(){return[];},x.hub.m.siegenia.Handler.prototype.executeCommand=function(e,i,a){e&&e.address&&(e.ip=e.address),x.hub.m.siegenia.SIEGENIA_MODULE.doCommand(e,i,function(e){e?a&&a({error:e}):a&&a({});});},x.hub.m.siegenia.Handler.prototype.getState=function(e,i,a){e&&e.address&&(e.ip=e.address),x.hub.m.siegenia.SIEGENIA_MODULE.doStatus("xhub",e,{value:i},function(e,i){e?a&&a({error:e}):i?a&&a({data:{value:i.status}}):a&&a({error:new Error("do status failed")});});},x.hub.m.siegenia.Handler.prototype.checkDeviceMatch=function(e,i){if(!(i&&i.device&&e&&e.device))return!1;var a=e.device.address,t=e.device.data;return a==i.device.address&&t==i.device.data;},x.hub.m.siegenia.Handler.prototype._checkStateChange=function(e,i){if(this._logger.log("trace","receive status:"+JSON.stringify(i)),this._logger.log("trace","for device:"+JSON.stringify(e)),this._devices[e.ip]){var a=this._devices[e.ip],t=a.states;t||(a.states={},t={});var r=[];for(var n in i){var s={};if(s.key=n,s.value=i[n],s.changed=!0,t[n]&&i[n]==t[n].value&&(s.oldvalue=t[n].value,s.changed=!1),a.states[n]={value:i[n],time:new Date().getTime()},s.changed&&r.push({device:e,data:s}),"warnings"==n){var o=t[n]?t[n].value:null;i[n].forEach(function(i){var a={key:"warning"};a.value=i,a.changed=!1,o&&-1==o.indexOf(i)&&(a.changed=!0),r.push({device:e,data:a});});}}r&&r.length>0&&this._generateEvent(e,r);}},x.hub.m.siegenia.Handler.prototype._generateEvent=function(e,i){if(this._devices[e.ip]){var a=require("x.hub.eventbus.js"),t=this._devices[e.ip].metas;if(t&&t.length>0)for(var r=0;r<t.length;r++){var n=t[r];if(n)for(var s=0;s<i.length;s++){var o=i[s];o&&o.data&&(o.data.key==n.statusKey||"*"==o.data.key)&&a.emit("status",{module:"siegenia",device:o.device,data:o.data},n);}}}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.siegenia.Handler());