var m=m||{};m.aio=m.aio||{},m.aio.macromanager=m.aio.macromanager||{},m.aio.macromanager.Path=function(){this._fifo=[];},m.aio.macromanager.Path.prototype={pop:function pop(){if(0==this._fifo.length)throw new Error("path is empty");return this._fifo.splice(0,1)[0];},push:function push(a){a&&this._fifo.push(a);},length:function length(){return this._fifo.length;}},m.aio.macromanager.Path.build=function(a){if(!a)return new m.aio.macromanager.Path();for(;a.length>0&&"/"==a.charAt(0);){a=1==a.length?"":a.substr(1);}if(!a)return new m.aio.macromanager.Path();for(;a.length>0&&"/"==a.charAt(a.length-1);){a=1==a.length?"":a.substr(0,a.length-1);}if(!a)return new m.aio.macromanager.Path();for(var r=new m.aio.macromanager.Path(),n=a.split("/"),i=0;i<n.length;i++){r.push(n[i]);}return r;},m.aio.macromanager.Macros=function(){this.groups=[];},m.aio.macromanager.Macros.parse=function(a){var r=new m.aio.macromanager.Macros();if(a&&a.groups){var n=m.aio.macromanager.Macros._parseGroups(r,a.groups);n&&(r.groups=n);}return r;},m.aio.macromanager.Macros._parseGroups=function(a,r){var n=null;return r&&Array.isArray(r)&&(n=[],r.forEach(function(r){var i=m.aio.macromanager.Group.parse(r);i&&(i._parent=a,n.push(i));})),n;},m.aio.macromanager.Macros.prototype={toJSON:function toJSON(){var a=[];return this.groups&&this.groups.forEach(function(r){if(r.toJSON){var n=r.toJSON();n&&a.push(n);}}),{groups:a};},findMacro:function findMacro(a,r,n){for(var i=null,e=0;e<this.groups.length;e++){if(this.groups[e].name==a){i=this.groups[e];break;}}i?i.findMacro(r,n):n&&n(new Error("no such group"));},findMacroIdx:function findMacroIdx(a,r,n){for(var i=null,e=0;e<this.groups.length;e++){if(this.groups[e].index==a){i=this.groups[e];break;}}i?i.findMacroIdx(r,n):n&&n(new Error("no such group"));},_create:function _create(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this)i&&i(new Error("do not support create opreation"));else if(Array.isArray(e)){var t=m.aio.macromanager.Group.parse(n);if(!t)return void(i&&i(new Error("invalid group format")));for(var o=0;o<this.groups.length;o++){if(this.groups[o].index==t.index)return void(i&&i(new Error("group index exits")));if(this.groups[o].name==t.name)return void(i&&i(new Error("group name exits")));}(!t.index||t.index<0)&&(0==this.groups.length?t.index=1:t.index=this.groups[this.groups.length-1].index+1),t._parent=this,this.groups.push(t),this._sortGroup(),i&&i(null,t);}else e._create(a,r,n,i);}else i&&i(new Error("path invalid"));},_read:function _read(a,r,n,i){var e=this._resolvePath(a);e?e==this?i&&i(null,this):Array.isArray(e)?i&&i(null,e):e._read(a,r,n,i):i&&i(new Error("path invalid"));},_update:function _update(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){var t=m.aio.macromanager.Macros.parse(n);if(!t)return void(i&&i(new Error("data invalid")));this.groups=t.groups,this._sortGroup(),i&&i(null,this);}else if(Array.isArray(e)){var o=m.aio.macromanager.Macros._parseGroups(this,n);if(!o)return void(i&&i(new Error("groups array invalid")));this.groups=o,this._sortGroup(),i&&i(null,this.groups);}else e._update(a,r,n,i);}else i&&i(new Error("path invalid"));},_delete:function _delete(a,r,n,i){var e=this._resolvePath(a);e?e==this||Array.isArray(e)?(this._clearGroups(),i&&i(null,this)):e._delete(a,r,n,i):i&&i(new Error("path invalid"));},_resolvePath:function _resolvePath(a){if(!a||0==a.length())return this;if("groups"!=a.pop())return null;if(0==a.length())return this.groups;var r=a.pop(),n=this._getGroup(r);return n||null;},_clearGroups:function _clearGroups(){this.groups&&this.groups.forEach(function(a){a&&(a._parent=null);}),this.groups=[];},_getGroup:function _getGroup(a){for(var r=0;r<this.groups.length;r++){if(this.groups[r].index==a)return this.groups[r];}return null;},_sortGroup:function _sortGroup(){var a=this.groups.length-1;do{for(var r=!1,n=0;n<a;++n){if(this.groups[n].index>this.groups[n+1].index){var i=this.groups[n];this.groups[n]=this.groups[n+1],this.groups[n+1]=i,r=!0;}}}while(1==r);}},m.aio.macromanager.Group=function(){this._parent=null,this.classid=m.aio.macromanager.Group.CLASS_ID,this.index=-1,this.name=null,this.macros=[];},m.aio.macromanager.Group.CLASS_ID="group",m.aio.macromanager.Group.parse=function(a){if(!a)return null;if(!a.classid||a.classid!=m.aio.macromanager.Group.CLASS_ID)return null;if(!a.name)return null;var r=new m.aio.macromanager.Group();if(r.index=a.index,r.name=a.name,a.macros){var n=m.aio.macromanager.Group._parseMacros(r,a.macros);n&&(r.macros=n);}return r;},m.aio.macromanager.Group._parseMacros=function(a,r){var n=null;return r&&Array.isArray(r)&&(n=[],r.forEach(function(r){var i=m.aio.macromanager.Macro.parse(r);i&&(i._parent=a,n.push(i));})),n;},m.aio.macromanager.Group.prototype={toJSON:function toJSON(){var a=[];return this.macros&&this.macros.forEach(function(r){if(r.toJSON){var n=r.toJSON();n&&a.push(n);}}),{classid:m.aio.macromanager.Group.CLASS_ID,index:this.index,name:this.name,macros:a};},findMacro:function findMacro(a,r){for(var n=null,i=0;i<this.macros.length;i++){if(this.macros[i].name==a){n=this.macros[i];break;}}n?r&&r(null,n):r&&r(new Error("no such macro"));},findMacroIdx:function findMacroIdx(a,r){for(var n=null,i=0;i<this.macros.length;i++){if(this.macros[i].index==a){n=this.macros[i];break;}}n?r&&r(null,n):r&&r(new Error("no such macro"));},_create:function _create(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this)i&&i(new Error("do not support create opreation"));else if(Array.isArray(e)){var t=m.aio.macromanager.Macro.parse(n);if(!t)return void(i&&i(new Error("invalid macro format")));for(var o=0;o<this.macros.length;o++){if(this.macros[o].index==t.index)return void(i&&i(new Error("macro index exits")));if(this.macros[o].name==t.name)return void(i&&i(new Error("macro name exits")));}(!t.index||t.index<0)&&(0==this.macros.length?t.index=1:t.index=this.macros[this.macros.length-1].index+1),t._parent=this,this.macros.push(t),this._sortMacro(),i&&i(null,t);}else e._create(a,r,n,i);}else i&&i(new Error("path invalid"));},_read:function _read(a,r,n,i){var e=this._resolvePath(a);e?e==this?i&&i(null,this):Array.isArray(e)?i&&i(null,e):e._read(a,r,n,i):i&&i(new Error("path invalid"));},_update:function _update(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){var t=m.aio.macromanager.Group.parse(n);if(!t)return void(i&&i(new Error("data invalid")));if(!this._parent||!this._parent.groups)return void(i&&i(new Error("group is isolated")));for(var o=0;o<this._parent.groups.length;o++){if(this._parent.groups[o].index==t.index&&this._parent.groups[o].index!=this.index)return void(i&&i(new Error("group index exits")));if(this._parent.groups[o].name==t.name&&this._parent.groups[o].name!=this.name)return void(i&&i(new Error("group name exits")));}var s=-1;for(o=0;o<this._parent.groups.length;o++){if(this._parent.groups[o]===this){s=o;break;}}s>=0&&this._parent.groups.splice(s,1),(!t.index||t.index<0)&&(t.index=this.index),this._parent.groups.push(t),t._parent=this._parent,this._parent=null,t._parent._sortGroup(),i&&i(null,t);}else if(Array.isArray(e)){var c=m.aio.macromanager.Group._parseMacros(this,n);if(!c)return void(i&&i(new Error("macros array invalid")));this.macros=c,this._sortMacro(),i&&i(null,this.macros);}else e._update(a,r,n,i);}else i&&i(new Error("path invalid"));},_delete:function _delete(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){if(!this._parent)return void(i&&i(null,this));if(!this._parent.groups)return this._parent=null,void(i&&i(null,this));for(var t=-1,o=0;o<this._parent.groups.length;o++){if(this._parent.groups[o]===this){t=o;break;}}if(-1==t)return this._parent=null,void(i&&i(null,this));this._parent.groups.splice(t,1),this._parent=null,i&&i(null,this);}else Array.isArray(e)?(this._clearMacros(),i&&i(null,this)):e._delete(a,r,n,i);}else i&&i(new Error("path invalid"));},_resolvePath:function _resolvePath(a){if(!a||0==a.length())return this;if("macros"!=a.pop())return null;if(0==a.length())return this.macros;var r=a.pop(),n=this._getMacro(r);return n||null;},_clearMacros:function _clearMacros(){this.macros&&this.macros.forEach(function(a){a&&(a._parent=null);}),this.macros=[];},_getMacro:function _getMacro(a){for(var r=0;r<this.macros.length;r++){if(this.macros[r].index==a)return this.macros[r];}return null;},_sortMacro:function _sortMacro(){var a=this.macros.length-1;do{for(var r=!1,n=0;n<a;++n){if(this.macros[n].index>this.macros[n+1].index){var i=this.macros[n];this.macros[n]=this.macros[n+1],this.macros[n+1]=i,r=!0;}}}while(1==r);}},m.aio.macromanager.Macro=function(){this._parent=null,this.classid=m.aio.macromanager.Macro.CLASS_ID,this.index=-1,this.name=null,this.pause=null,this.inWidget=!0,this.cloud=null,this.commands=[];},m.aio.macromanager.Macro.CLASS_ID="macro",m.aio.macromanager.Macro.parse=function(a){if(!a)return null;if(!a.classid||a.classid!=m.aio.macromanager.Macro.CLASS_ID)return null;if(!a.name)return null;var r=new m.aio.macromanager.Macro();if(r.index=a.index,r.name=a.name,r.pause=a.pause,r.inWidget=a.inWidget,r.cloud=a.cloud,a.commands){var n=m.aio.macromanager.Macro._parseMacroCommands(r,a.commands);n&&(r.commands=n);}return r;},m.aio.macromanager.Macro._parseMacroCommands=function(a,r){var n=null;return r&&Array.isArray(r)&&(n=[],r.forEach(function(r){var i=m.aio.macromanager.MacroCommand.parse(r);i&&(i._parent=a,n.push(i));})),n;},m.aio.macromanager.Macro.prototype={toJSON:function toJSON(){var a=[];return this.commands&&this.commands.forEach(function(r){if(r.toJSON){var n=r.toJSON();n&&a.push(n);}}),{classid:m.aio.macromanager.Macro.CLASS_ID,index:this.index,name:this.name,pause:this.pause,inWidget:this.inWidget,cloud:this.cloud,commands:a};},_create:function _create(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this)i&&i(new Error("do not support create opreation"));else if(Array.isArray(e)){var t=m.aio.macromanager.MacroCommand.parse(n);if(!t)return void(i&&i(new Error("invalid macro command format")));for(var o=0;o<this.commands.length;o++){if(this.commands[o].index==t.index)return void(i&&i(new Error("macro index exits")));}(!t.index||t.index<0)&&(0==this.commands.length?t.index=1:t.index=this.commands[this.commands.length-1].index+1),t._parent=this,this.commands.push(t),this._sortCommand(),i&&i(null,t);}else e._create(a,r,n,i);}else i&&i(new Error("path invalid"));},_read:function _read(a,r,n,i){var e=this._resolvePath(a);e?e==this?i&&i(null,this):Array.isArray(e)?i&&i(null,e):e._read(a,r,n,i):i&&i(new Error("path invalid"));},_update:function _update(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){var t=m.aio.macromanager.Macro.parse(n);if(!t)return void(i&&i(new Error("data invalid")));if(!this._parent||!this._parent.macros)return void(i&&i(new Error("macro is isolated")));for(var o=0;o<this._parent.macros.length;o++){if(this._parent.macros[o].index==t.index&&this._parent.macros[o].index!=this.index)return void(i&&i(new Error("macro index exits")));if(this._parent.macros[o].name==t.name&&this._parent.macros[o].name!=this.name)return void(i&&i(new Error("macro name exits")));}var s=-1;for(o=0;o<this._parent.macros.length;o++){if(this._parent.macros[o]===this){s=o;break;}}s>=0&&this._parent.macros.splice(s,1),(!t.index||t.index<0)&&(t.index=this.index),this._parent.macros.push(t),t._parent=this._parent,this._parent=null,t._parent._sortMacro(),i&&i(null,t);}else if(Array.isArray(e)){var c=m.aio.macromanager.Macro._parseMacroCommands(this,n);if(!c)return void(i&&i(new Error("commands array invalid")));this.commands=c,this._sortCommand(),i&&i(null,this.commands);}else e._update(a,r,n,i);}else i&&i(new Error("path invalid"));},_delete:function _delete(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){if(!this._parent)return void(i&&i(null,this));if(!this._parent.macros)return this._parent=null,void(i&&i(null,this));for(var t=-1,o=0;o<this._parent.macros.length;o++){if(this._parent.macros[o]===this){t=o;break;}}if(-1==t)return this._parent=null,void(i&&i(null,this));this._parent.macros.splice(t,1),this._parent=null,i&&i(null,this);}else Array.isArray(e)?(this._clearCommands(),i&&i(null,this)):e._delete(a,r,n,i);}else i&&i(new Error("path invalid"));},_resolvePath:function _resolvePath(a){if(!a||0==a.length())return this;if("commands"!=a.pop())return null;if(0==a.length())return this.commands;var r=a.pop(),n=this._getCommand(r);return n||null;},_clearCommands:function _clearCommands(){this.commands&&this.commands.forEach(function(a){a&&(a._parent=null);}),this.commands=[];},_getCommand:function _getCommand(a){for(var r=0;r<this.commands.length;r++){if(this.commands[r].index==a)return this.commands[r];}return null;},_sortCommand:function _sortCommand(){var a=this.commands.length-1;do{for(var r=!1,n=0;n<a;++n){if(this.commands[n].index>this.commands[n+1].index){var i=this.commands[n];this.commands[n]=this.commands[n+1],this.commands[n+1]=i,r=!0;}}}while(1==r);}},m.aio.macromanager.MacroCommand=function(a){this._parent=null,this.classid=a,this.index=-1;},m.aio.macromanager.MacroCommand.parse=function(a){if(!a)return null;if(!a.classid)return null;var r=null;switch(a.classid){case m.aio.macromanager.Command.CLASS_ID:r=m.aio.macromanager.Command.parse(a);break;case m.aio.macromanager.Navigate.CLASS_ID:r=m.aio.macromanager.Navigate.parse(a);break;case m.aio.macromanager.Sleep.CLASS_ID:r=m.aio.macromanager.Sleep.parse(a);break;default:return null;}return r&&(r.index=a.index),r;},m.aio.macromanager.MacroCommand.prototype={toJSON:function toJSON(){return{classid:this.classid,index:this.index};},_create:function _create(a,r,n,i){var e=this._resolvePath(a);e?e==this&&i&&i(new Error("do not support create opreation")):i&&i(new Error("path invalid"));},_read:function _read(a,r,n,i){var e=this._resolvePath(a);e?e==this&&i&&i(null,this):i&&i(new Error("path invalid"));},_update:function _update(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){var t=m.aio.macromanager.MacroCommand.parse(n);if(!t)return void(i&&i(new Error("data invalid")));if(!this._parent||!this._parent.commands)return void(i&&i(new Error("macro command is isolated")));for(var o=-1,s=0;s<this._parent.commands.length;s++){if(this._parent.commands[s]===this){o=s;break;}}o>=0&&this._parent.commands.splice(o,1),(!t.index||t.index<0)&&(0==this._parent.commands.length?t.index=1:t.index=this._parent.commands[this._parent.commands.length-1].index+1),this._parent.commands.push(t),t._parent=this._parent,this._parent=null,t._parent._sortCommand(),i&&i(null,t);}}else i&&i(new Error("path invalid"));},_delete:function _delete(a,r,n,i){var e=this._resolvePath(a);if(e){if(e==this){if(!this._parent)return void(i&&i(null,this));if(!this._parent.commands)return this._parent=null,void(i&&i(null,this));for(var t=-1,o=0;o<this._parent.commands.length;o++){if(this._parent.commands[o]===this){t=o;break;}}if(-1==t)return this._parent=null,void(i&&i(null,this));this._parent.commands.splice(t,1),this._parent=null,i&&i(null,this);}}else i&&i(new Error("path invalid"));},_resolvePath:function _resolvePath(a){return a&&0!=a.length()?null:this;}},m.aio.macromanager.Command=function(){m.aio.macromanager.MacroCommand.call(this,m.aio.macromanager.Command.CLASS_ID),this.action=null;},m.aio.macromanager.Command.prototype=new m.aio.macromanager.MacroCommand(),m.aio.macromanager.Command.prototype.constructor=m.aio.macromanager.Command,m.aio.macromanager.Command.CLASS_ID="command",m.aio.macromanager.Command.parse=function(a){if(!a)return null;if(!a.classid||a.classid!=m.aio.macromanager.Command.CLASS_ID)return null;var r=new m.aio.macromanager.Command();return r.action=a.action,r;},m.aio.macromanager.Command.prototype.toJSON=function(){var a=m.aio.macromanager.MacroCommand.prototype.toJSON.call(this);return a.action=this.action,a;},m.aio.macromanager.Navigate=function(){m.aio.macromanager.MacroCommand.call(this,m.aio.macromanager.Navigate.CLASS_ID),this.page=null,this.history=null;},m.aio.macromanager.Navigate.prototype=new m.aio.macromanager.MacroCommand(),m.aio.macromanager.Navigate.prototype.constructor=m.aio.macromanager.Navigate,m.aio.macromanager.Navigate.CLASS_ID="navigate",m.aio.macromanager.Navigate.parse=function(a){if(!a)return null;if(!a.classid||a.classid!=m.aio.macromanager.Navigate.CLASS_ID)return null;var r=new m.aio.macromanager.Navigate();return r.page=a.page,"number"==typeof a.history&&(r.history=a.history),"string"==typeof a.popup&&(r.popup=a.popup,a.device&&(r.device=a.device),a.gateway&&(r.gateway=a.gateway),a.settings&&(r.settings=a.settings)),a.popup_close&&(r.popup_close=a.popup_close),a.ext&&(r.ext=a.ext),r;},m.aio.macromanager.Navigate.prototype.toJSON=function(){var a=m.aio.macromanager.MacroCommand.prototype.toJSON.call(this);return a.page=this.page,"number"==typeof this.history&&(a.history=this.history),"string"==typeof this.popup&&(a.popup=this.popup,this.device&&(a.device=this.device),this.gateway&&(a.gateway=this.gateway),this.settings&&(a.settings=this.settings)),this.popup_close&&(a.popup_close=this.popup_close),this.ext&&(a.ext=this.ext),a;},m.aio.macromanager.Sleep=function(){m.aio.macromanager.MacroCommand.call(this,m.aio.macromanager.Sleep.CLASS_ID),this.time=0;},m.aio.macromanager.Sleep.prototype=new m.aio.macromanager.MacroCommand(),m.aio.macromanager.Sleep.prototype.constructor=m.aio.macromanager.Sleep,m.aio.macromanager.Sleep.CLASS_ID="sleep",m.aio.macromanager.Sleep.parse=function(a){if(!a)return null;if(!a.classid||a.classid!=m.aio.macromanager.Sleep.CLASS_ID)return null;var r=new m.aio.macromanager.Sleep();return r.time=a.time,r;},m.aio.macromanager.Sleep.prototype.toJSON=function(){var a=m.aio.macromanager.MacroCommand.prototype.toJSON.call(this);return a.time=this.time,a;},m.aio.macromanager.Handler=function(a,r){this.tenant=a,this.macros=r||new m.aio.macromanager.Macros(),this.runningTask=null,this.waitingTask=null;},m.aio.macromanager.Handler.prototype={execute:function execute(a,r,n,i,e){var t=m.aio.macromanager.Path.build(r);if(t)switch(a){case"create":this._create(t,n,i,function(a,r){var n=this._toJSON(r);e&&e(a,n);}.bind(this));break;case"read":this._read(t,n,i,function(a,r){var n=this._toJSON(r);e&&e(a,n);}.bind(this));break;case"update":this._update(t,n,i,function(a,r){var n=this._toJSON(r);e&&e(a,n);}.bind(this));break;case"delete":this._delete(t,n,i,function(a,r){var n=this._toJSON(r);e&&e(a,n);}.bind(this));break;default:e&&e(new Error("invalid operation"));}else e&&e(new Error("invalid path"));},findMacro:function findMacro(a,r,n){this.macros.findMacro(a,r,n);},findMacroIdx:function findMacroIdx(a,r,n){this.macros.findMacroIdx(a,r,n);},_create:function _create(a,r,n,i){this.macros._create(a,r,n,function(a,r){a?i&&i(a):this._saveMacros(function(a){i&&i(a,a?null:r);});}.bind(this));},_read:function _read(a,r,n,i){this.macros._read(a,r,n,i);},_update:function _update(a,r,n,i){this.macros._update(a,r,n,function(a,r){a?i&&i(a):this._saveMacros(function(a){i&&i(a,a?null:r);});}.bind(this));},_delete:function _delete(a,r,n,i){this.macros._delete(a,r,n,function(a,r){a?i&&i(a):this._saveMacros(function(a){i&&i(a,a?null:r);});}.bind(this));},_saveMacros:function _saveMacros(a){this.runningTask?this.waitingTask?this.waitingTask.addCallback(a):this.waitingTask=new m.aio.macromanager.Handler.SaveMacrosTask(this,a):(this.runningTask=new m.aio.macromanager.Handler.SaveMacrosTask(this,a),this.runningTask.save());},_loadMacros:function _loadMacros(a){if(this.tenant){var r=this.tenant.getFolderPath();if(r){var n=require("fs"),i=r+require("path").sep+m.aio.macromanager.MacroManager.DB,e=this;this._fileExistsSync(i)?n.readFile(i,{encoding:"utf8"},function(r,n){if(!r&&n){var i;try{i=JSON.parse(n);}catch(a){}var e=m.aio.macromanager.Macros.parse(i);e&&(this.macros=e);}a&&a(r);}.bind(this)):n.writeFile(i,"",function(){e._loadMacros(a);});}else a&&a(new Error("tenant folder invalid"));}else a&&a(new Error("tenant is null"));},_saveMacrosFinish:function _saveMacrosFinish(){this.runningTask=null,this.waitingTask&&(this.runningTask=this.waitingTask,this.waitingTask=null,this.runningTask.save());},_fileExistsSync:function _fileExistsSync(a){var r=require("fs");try{r.statSync(a);}catch(a){if("ENOENT"==a.code)return!1;}return!0;},_toJSON:function _toJSON(a){if(void 0===a)return null;if(null==a)return null;if(a.toJSON&&"function"==typeof a.toJSON)return a.toJSON();if(Array.isArray(a)){var r=[];return a.forEach(function(a){r.push(this._toJSON(a));}.bind(this)),r;}return a;}},m.aio.macromanager.Handler.SaveMacrosTask=function(a,r){this._handler=a,this._callbacks=[],r&&this._callbacks.push(r);},m.aio.macromanager.Handler.SaveMacrosTask.prototype={addCallback:function addCallback(a){for(var r=0;r<this._callbacks.length;r++){if(this._callbacks[r]===a)return;}this._callbacks.push(a);},save:function save(){this._saveFile(function(a){this._callbacks.forEach(function(r){r&&r(a);}),this._handler._saveMacrosFinish();}.bind(this));},_saveFile:function _saveFile(a){if(this._handler.tenant){var r=this._handler.tenant.getFolderPath();if(r){var n=require("fs"),i=r+require("path").sep+m.aio.macromanager.MacroManager.DB;n.writeFile(i,JSON.stringify(this._handler.macros.toJSON()),function(r){a(r);});}else a&&a(new Error("tenant folder invalid"));}else a(new Error("tenant is null"));}},m.aio.macromanager.MacroManager=function(){this.handlers=[],this._configmanager=null;},m.aio.macromanager.MacroManager.DB="macros_db",m.aio.macromanager.MacroManager.prototype={init:function init(a,r,n){a&&a.children?(this._configmanager=r,require("async").each(a.children,function(a,r){var n=new m.aio.macromanager.Handler(a);this.handlers.push(n),n._loadMacros(function(){r();});}.bind(this),function(a){n&&n(a);})):n&&n();},addTenant:function addTenant(a,r){var n=new m.aio.macromanager.Handler(a);this.handlers.push(n),n._loadMacros(function(a){r&&r();});},removeTenant:function removeTenant(a,r){this._removeHandler(a.index),r&&r();},execute:function execute(a,r,n,i,e,t){this._configmanager.trace("config/tenants/"+a,function(o,s){if(o)return s||this._removeHandler(a),void(t&&t(new Error("no tenant with index "+a)));if(s.isAccessible()){var c=this._getHandler(a);c?c.execute(r,n,i,e,t):this.addTenant(s,function(a){a?t&&t(a):c.execute(r,n,i,e,t);});}else t&&t(new Error("not permitted"));}.bind(this));},saveRemote:function saveRemote(a,r){if(a.parent){var n=a.parent.parent;if(n){var i=n.getFolderPath();if(i){var e=a.getFolderPath(),t=require("fs"),o=require("fs-extra"),s=require("path"),c=i+s.sep+m.aio.macromanager.MacroManager.DB,h=e+s.sep+m.aio.macromanager.MacroManager.DB;t.exists(c,function(a){a?o.copy(c,h,function(a){r&&r(a);}):r&&r();});}else r&&r(new Error("invalid tenant folder"));}else r&&r(new Error("remote do not belong to any tenant"));}else r&&r(new Error("remote is isolated"));},reloadTenant:function reloadTenant(a,r){for(var n=-1,i=0;i<this.handlers.length;i++){var e=this.handlers[i];if(e&&e.tenant&&e.tenant.index==a.index){n=i;break;}}-1!=n&&this.handlers.splice(n,1);var t=new m.aio.macromanager.Handler(a);this.handlers.push(t),t._loadMacros(function(){r();});},_getHandler:function _getHandler(a){for(var r=0;r<this.handlers.length;r++){var n=this.handlers[r];if(n&&n.tenant&&n.tenant.index==a)return n;}return null;},_removeHandler:function _removeHandler(a){for(var r=-1,n=0;n<this.handlers.length;n++){var i=this.handlers[n];if(i&&i.tenant&&i.tenant.index==a){r=n;break;}}-1!=r&&this.handlers.splice(r,1);}},m.aio.macromanager.MM=new m.aio.macromanager.MacroManager(),m.aio.macromanager.MM.Macros=m.aio.macromanager.Macros,m.aio.macromanager.MM.Handler=m.aio.macromanager.Handler,"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.macromanager.MM);