var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.enoceanip=x.hub.m.enoceanip||{},x.hub.m.enoceanip.MODULE=require("xnm.aio.enoceanip.js"),x.hub.m.enoceanip.Monitor=function(){var Monitor=function Monitor(e){this._logger=require("x.logger.js").getLogger("x.hub.m.enoceanip.Monitor"),this._running=!1,this._stream=null,this._data=null,this._gateway=e,this._devices={},this._buttonEvents={};};return Monitor.prototype.start=function(e){this._logger.log("debug","start monitor for "+this._gateway.getIP()+":"+this._gateway.getPort()),this._running||(this._running=!0,this._startStream()),e&&e();},Monitor.prototype.addStateDevice=function(e,t,a){if(e&&e.deviceId){var r=this._devices[e.deviceId];if(r||(r={device:e,event:{}},this._devices[e.deviceId]=r),a&&a.statusKey){var n=r.event[a.statusKey];n||(n={callbacks:[]},r.event[a.statusKey]=n),a.callback&&-1==n.callbacks.indexOf(a.callback)&&n.callbacks.push(a.callback);}}t&&t();},Monitor.prototype.removeStateDevice=function(e,t,a){if(e&&e.deviceId){var r=this._devices[e.deviceId];if(r&&a&&a.statusKey){var n=r.event[a.statusKey];if(n&&a&&a.callback){var i=n.callbacks.indexOf(a.callback);-1!=i&&n.callbacks.splice(i,1);}n&&0!=n.callbacks.length||delete this._devices[e.deviceId];}}t&&t();},Monitor.prototype._startStream=function(){var e=this;this._stream=this._gateway.getDevicesStream("both","newline","singleLine",function(t){e._logger.log("debug","stream for "+e._gateway.getIP()+":"+e._gateway.getPort()+" closed"),e._logger.log("debug",(t?"error:"+t.message:"")+" restart stream"),t?-2==t.code?e._startStream():setTimeout(function(){e._startStream();},1e3):e._startStream();}),this._stream.on("header",function(e){}),this._stream.on("chunk",function(t){e._data?e._data+=t:e._data=t,e._resolveData();});},Monitor.prototype._resolveData=function(){var e=this._data.split("\n");if(e.length>=2&&0==e[1].length){var t=e[0];this._onMessage(t),e.splice(0,2),this._data=e.join("\n"),this._data.length>0&&this._resolveData();}},Monitor.prototype._onMessage=function(e){try{e=JSON.parse(e);}catch(e){return;}if(e&&e.header&&"telegram"==e.header.content&&e.telegram){this._logger.log("debug","receive event:"+JSON.stringify(e.telegram));var t=e.telegram.deviceId,a=this._devices[t];if(a&&a.device&&a.device.gateway){var r=x.hub.m.enoceanip.MODULE.resolveEvent(a.device.gateway,a.device,e.telegram);if(r)for(var n in r){this._produceEvent(a,n,r[n]);}}}},Monitor.prototype._produceEvent=function(e,t,a){var r=e.device;if(e.event&&e.event[t])for(var n=e.event[t].callbacks,i={key:t,value:a,changed:!0},o={module:"enoceanip",device:r,gateway:r.gateway,data:i},s=0;s<n.length;s++){var c=n[s];c&&c.onEvent&&c.onEvent(o);}if("btn"==t.substr(0,3)&&t.indexOf(!1)&&-1==t.indexOf("longPress")){var v=t.substr(3,2),d=new Date().getTime(),u=this._buttonEvents[e.device.deviceId];if(u){var l=u.event,g=u.timestamp;l&&g&&-1!=l.indexOf("pressed")&&-1!=t.indexOf("released")&&(d-g<1e3?this._produceEvent(e,"btn"+v+"shortPress",!0):this._produceEvent(e,"btn"+v+"longPress",!0));}this._buttonEvents[e.device.deviceId]={event:t,timestamp:d};}},Monitor;}(),x.hub.m.enoceanip.Handler=function(){var Handler=function Handler(){this._monitors={};};return util.inherits(Handler,EventEmitter),Handler.prototype.init=function(e){e&&e();},Handler.prototype.getSystems=function(){return["dcgw"];},Handler.prototype.addStateDevice=function(e,t,a){e?e.gateway?this._startMonitor(e.gateway,function(r,n){r?t&&t({error:r}):n.addStateDevice(e,function(e){t&&t({error:e});},a);}):t&&t(new Error("device gateway format invalid")):t&&t({error:new Error("device json format invalid")});},Handler.prototype.removeStateDevice=function(e,t,a){if(e){if(e.gateway){var r=this._getMonitor(e.gateway);r?r.removeStateDevice(e,function(e){t&&t({error:e});},a):t&&t({});}else t&&t(new Error("device gateway format invalid"));}else t&&t({error:new Error("device json format invalid")});},Handler.prototype.getAllStates=function(){return[];},Handler.prototype.getStates=function(e){return e&&e.gateway&&e.gateway.ip,null;},Handler.prototype.getState=function(e,t,a){e?e.gateway?x.hub.m.enoceanip.MODULE.doStatus("xhub",e.gateway,e,{value:t},function(e,t){e?a&&a({error:e}):t?a&&a({data:{value:t.status}}):a&&a({error:new Error("do status failed")});}):a&&a(new Error("device gateway format invalid")):a&&a({error:new Error("device json format invalid")});},Handler.prototype.executeCommand=function(e,t,a){x.hub.m.enoceanip.MODULE.doCommand(e.gateway,e,t,a);},Handler.prototype.checkDeviceMatch=function(e,t){return!!(t&&t.device&&e&&e.device)&&t.device.deviceId==e.device.deviceId;},Handler.prototype._startMonitor=function(e,t){if(e){var a=x.hub.m.enoceanip.MODULE.resolveGateway(e);if(a){var r=a.getIP(),n=a.getPort();if(r&&n){var i=r+":"+n;if(this._monitors[i])t(null,this._monitors[i]);else{var o=new x.hub.m.enoceanip.Monitor(a);this._monitors[i]=o,o.start(),t(null,o);}}else t(new Error("gateway json format invalid"));}else t(new Error("gateway json format invalid"));}else t(new Error("gateway json is null"));},Handler.prototype._getMonitor=function(e){if(e){var t=x.hub.m.enoceanip.MODULE.resolveGateway(e);if(t){var a=t.getIP(),r=t.getPort();if(a&&r){var n=a+":"+r;return this._monitors[n];}}}},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.enoceanip.Handler());