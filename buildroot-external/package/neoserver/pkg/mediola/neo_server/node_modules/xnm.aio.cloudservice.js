function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;})),keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){_defineProperty(target,key,source[key]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}return target;}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.cloudservice=xnm.aio.cloudservice||{},xnm.aio.cloudservice.Ivideon=function(){var Cam=function Cam(e,t,a,o){this._connectionID=e,this._camID=t,this._cloudService=a,this._format=o,this._jpegCam=null;};return Cam.prototype.getBaseURL=function(){return"/devices/"+this._connectionID+"/"+this._camID;},Cam.prototype.getLivePreview=function(e){var t=this.getBaseURL()+"/live_preview";this._cloudService.doEAPIRequest("ivideon","GET",t,null,null,function(t,a){e&&e(t,a);});},Cam.prototype.getLiveStream=function(e,t){var a=this.getBaseURL()+"/live_stream";e||(e={}),e.format||(e.format="hls"),"string"!=typeof e.q&&"number"!=typeof e.q&&(e.q=1),this._cloudService.doEAPIRequest("ivideon","GET",a,e,null,function(e,a){t&&t(e,a);});},Cam.prototype.getArchiveStream=function(e,t){var a=this.getBaseURL()+"/record_stream";e||(e={}),e.format||(e.format="hls"),"string"!=typeof e.q&&"number"!=typeof e.q&&(e.q=1),this._cloudService.doEAPIRequest("ivideon","GET",a,e,null,function(e,a){if(e)t(e,a);else{var o=null;a&&"object"==_typeof(a)&&(o=a.url),"string"==typeof o&&0!==o.length||(e=new Error("Result did not contain an URL or it was an empty string: "+o)),t(e,o);}});},Cam.prototype.getEvents=function(e,t){var a=this.getBaseURL()+"/events";e||(e={}),e.limit||(e.limit=20),this._cloudService.doEAPIRequest("ivideon","POST",a,null,e,function(e,a){t&&t(e,a);});},Cam.prototype.getRecords=function(e,t){var a=this.getBaseURL()+"/records";this._cloudService.doEAPIRequest("ivideon","GET",a,e,null,function(e,a){t&&t(e,a);});},Cam.prototype.loadImage=function(e,t){var a=this;this._jpegCam?this._jpegCam.loadImage(function(o,s){o?e&&e(o):o||!s||401!=s.statusCode||t?e&&e():(a._jpegCam=null,a.loadImage(e,!0));}):this.getLivePreview(function(t,o){if(!t&&o&&o.url&&o.token){var s="https://"+o.host+"/cameras/"+a._camID+"/live_preview";a._jpegCam=require("xnm.aio.cams.js").createJPEGCam(s,{headers:{Authorization:"Bearer "+o.token},imageName:a._camID+".jpg"}),a.loadImage(e,!0);}else e&&e();});},Cam.parseJSON=function(e,t){return e&&e.connection&&e.id?new Cam(e.connection,e.id,t,e.format):null;},Cam;}(),xnm.aio.cloudservice.Ring=function(){var Doorbell=function Doorbell(e,t,a){this._connectionID=e,this._deviceID=t,this._cloudService=a,this._last_timestap=null,this._last_file_path=null;};Doorbell.prototype.getBaseURL=function(){return"/devices/"+this._connectionID+"/"+this._deviceID;},Doorbell.prototype.getLastSnapshot=function(e){var t=this.getBaseURL()+"/last_snapshot";this._cloudService.doEAPIRequest("ring","GET",t,null,null,function(t,a){e&&e(t,a);});},Doorbell.prototype.getEvents=function(e,t){var a=this.getBaseURL()+"/history";e||(e={}),e.limit||(e.limit=20),this._cloudService.doEAPIRequest("ring","GET",a,e,null,function(e,a){t&&t(e,a);});},Doorbell.prototype.getRecordStream=function(e,t){var a=this.getBaseURL()+"/record_stream";e||(e={}),e.eventID?this._cloudService.doEAPIRequest("ring","GET",a,e,null,function(e,a){if(e)t(e,a);else{var o=null;a&&"object"==_typeof(a)&&(o=a.url),"string"==typeof o&&0!==o.length||(e=new Error("Result did not contain an URL or it was an empty string: "+o)),t(e,o);}}):t(new Error("no eventID"));},Doorbell.prototype.loadImage=function(e,t){var a=this,o=new Date();if(!this._last_timestap||o-this._last_timestap>=6e4)return this._last_timestap=null,this._last_file_path=null,void this.getLastSnapshot(function(t,o){!t&&o&&o.url&&o.timestamp&&o.access_token?(a._last_timestap=o.timestamp,require("xnm.aio.cams.js").createJPEGCam(o.url,{headers:{Authorization:"Bearer "+o.access_token}}).loadImage(function(t,s){if(t)return a._last_file_path=t,void(e&&e(t,o.timestamp));a._last_timestap=null,e&&e();})):e&&e();});e&&e(this._last_file_path,this._last_timestap);};var e={parseJSON:function parseJSON(e,t){return e&&e.type&&e.connection&&e.id&&"doorbell"==e.type?new Doorbell(e.connection,e.id,t,e.format):null;}};return e;}(),xnm.aio.cloudservice.Bosch=function(){var Cam=function Cam(e,t,a,o){this._connectionID=e,this._camID=t,this._cloudService=a,this._format=o,this._jpegCam=null;};return Cam.prototype.getBaseURL=function(){return"/devices/"+this._connectionID+"/"+this._camID;},Cam.prototype.getStates=function(e){var t="/states/"+this._connectionID+"/"+this._camID;this._cloudService.doEAPIRequest("bosch","GET",t,null,null,function(t,a){e&&e(t,a);});},Cam.prototype.getLivePreview=function(e,t){var a=this.getBaseURL()+"/live_preview";this._cloudService.doEAPIRequest("bosch","GET",a,e,null,function(e,a){t&&t(e,a);});},Cam.prototype.getLiveStream=function(e,t){var a=this.getBaseURL()+"/live_stream";e||(e={}),e.endpoint||(e.endpoint="cloud"),e.profile||(e.profile="hd"),this._cloudService.doEAPIRequest("bosch","GET",a,e,null,function(e,a){t&&t(e,a);});},Cam.prototype.getEvents=function(e,t){var a=this.getBaseURL()+"/events";e||(e={}),void 0!==e.page&&null!=e.page||(e.page=0),void 0!==e.pageSize&&null!=e.pageSize||(e.pageSize=10);var o={filter:{},paging:{page:e.page,pageSize:e.pageSize}};e.eventType&&(o.filter.eventType=e.eventType),this._cloudService.doEAPIRequest("bosch","POST",a,null,o,function(e,a,o,s){t&&t(e,a,s?s["x-token"]:null);});},Cam.prototype.getWifiInfo=function(e){var t=this.getBaseURL()+"/wifi";this._cloudService.doEAPIRequest("bosch","GET",t,null,null,function(t,a){e&&e(t,a);});},Cam.prototype.loadImage=function(e,t){var a=this;this._jpegCam?this.getStates(function(o,s){if(!o&&s&&s.states)return"on"!=s.states.state?(a._jpegCam=null,void(e&&e())):void a._jpegCam.loadImage(function(o,s){o?e&&e(o):o||!s||401!=s.statusCode||t?e&&e():(a._jpegCam=null,a.loadImage(e,!0));});e&&e();}):this.getLivePreview({endpoint:"cloud"},function(t,o){if(!t&&o&&o.mediaUri){var s=o.mediaUri,n={headers:{},imageName:a._camID+".jpg"};if(o.accessCredentials&&o.accessCredentials.credentials){var i=o.accessCredentials.credentials.split(":");n.user=i[0],n.password=i[1];}a._jpegCam=require("xnm.aio.cams.js").createJPEGCam(s,n),a.loadImage(e,!0);}else e&&e();});},Cam.parseJSON=function(e,t){return e&&e.connection&&e.id?new Cam(e.connection,e.id,t,e.format):null;},Cam;}(),xnm.aio.cloudservice.DoorBird=function(e,t,a,o){this._connectionID=e,this._camID=t,this._cloudService=a,this._camMAC=o,this._cacheID=e+":"+t+":"+o,this._viewImageFailures=0;var s=xnm.aio.cloudservice.DoorBird;s._cacheImage[this._cacheID]=s._cacheImage[this._cacheID]||{last:0,url:null},this._jpegCam=null;},xnm.aio.cloudservice.DoorBird._cacheImage={},xnm.aio.cloudservice.DoorBird.prototype={getBaseURL:function getBaseURL(){return"/devices/"+this._connectionID+"/"+this._camID;},getStates:function getStates(e){var t="/states/"+this._connectionID+"/"+this._camID;this._cloudService.doEAPIRequest("doorbird","GET",t,null,null,function(t,a){e&&e(t,a);});},getAppScheme:function getAppScheme(e){var t={connection:this._connectionID,device:this._camID,command:"view_scheme",value:{}};this._cloudService.doEAPIRequest("doorbird","POST","/command",null,t,function(t,a){"string"==typeof a&&(a={url:a}),e&&e(t,a);});},getLivePreview:function getLivePreview(e,t){if(this._viewImageFailures>=3){var a=new Error('"view_image" request failed 3 times in a row. No more attempts until page reload.');t&&t(a,null);}else{var o=xnm.aio.cloudservice.DoorBird._cacheImage[this._cacheID];if(o&&(o.error||o.url)){var s=5;if(o.error&&(s=1),Date.now()-o.last<60*s*1e3)return void(t&&t(o.error,{url:o.url}));}e||(e=null);var n={connection:this._connectionID,device:this._camID,command:"view_image",value:{}},i=this;this._cloudService.doEAPIRequest("doorbird","POST","/command",e,n,function(e,a){"string"==typeof a&&(a={url:a}),e?(i._viewImageFailures+=1,i._cloudService._logger.log("error","[DoorBird.getLivePreview] "+e.message),o||(xnm.aio.cloudservice.DoorBird._cacheImage[i._cacheID]={},o=xnm.aio.cloudservice.DoorBird._cacheImage[i._cacheID]),o.last=Date.now(),o.error=e):a&&a.url&&(i._viewImageFailures=0,o||(xnm.aio.cloudservice.DoorBird._cacheImage[i._cacheID]={},o=xnm.aio.cloudservice.DoorBird._cacheImage[i._cacheID]),o.last=Date.now(),o.url=a.url,delete o.error),t&&t(e,a);});}},getLiveStream:function getLiveStream(e,t){e||(e=null);var a={connection:this._connectionID,device:this._camID,command:"view_live",value:{}};this._cloudService.doEAPIRequest("doorbird","POST","/command",e,a,function(e,a){"string"==typeof a&&(a={url:a}),t&&t(e,a);});},loadImage:function loadImage(e,t){var a=this;this._cacheImage&&this._cacheImage.url&&Date.now()-this._cacheImage.last>=3e5&&(this._jpegCam=null),this._jpegCam?a._jpegCam.loadImage(function(o,s){o?e&&e(o):o||!s||401!=s.statusCode||t?e&&e():(a._jpegCam=null,a.loadImage(e,!0));}):this.getLivePreview(null,function(t,o){if(!t&&o&&o.url){var s={headers:{},imageName:a._camID+".jpg"};a._jpegCam=require("xnm.aio.cams.js").createJPEGCam(o.url,s),a.loadImage(e,!0);}else e&&e();});}},xnm.aio.cloudservice.DoorBird.parseJSON=function(e,t){if(!e||!e.connection||!e.id)return null;var a=null;return e.data.metaData?a=e.data.metaData.mac:e.data.mac&&(a=e.data.mac),new xnm.aio.cloudservice.DoorBird(e.connection,e.id,t,a);},xnm.aio.cloudservice.CloudService=function(){var RuleEngine=function RuleEngine(e){this._cloudservice=e;};RuleEngine.prototype.getRules=function(e){this._cloudservice._doJsonRequest("GET","/rules",null,null,e);},RuleEngine.prototype.addRule=function(e,t){e?this._cloudservice._doJsonRequest("POST","/rules",null,e,t):t&&t(new Error("rule is null"));},RuleEngine.prototype.updateRule=function(e,t,a){e?t?this._cloudservice._doJsonRequest("POST","/rules/"+e,null,t,a):a&&a(new Error("rule is null")):a&&a(new Error("rule id is null"));},RuleEngine.prototype.deleteRule=function(e,t){e?this._cloudservice._doJsonRequest("POST","/rules/"+e,null,{},t):t&&t(new Error("rule id is null"));},RuleEngine.prototype.deleteRules=function(e,t){this._cloudservice._doJsonRequest("DELETE","/rules",e,null,t);};var EAPI=function EAPI(e){this._cloudservice=e,this._version="v1";};EAPI.prototype.disconenct=function(e,t,a){e?t?this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+e+"/disconnect",{id:t},null,function(e,t){a&&a(e,t);}):a&&a(new Error("invalid connection id")):a&&a(new Error("invalid module"));},EAPI.prototype.getModuleConnectionInfo=function(e,t,a){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+e+"/info/"+t,null,null,function(e,t){a(e,t);});},EAPI.prototype.getModuleInfo=function(e,t){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+e+"/info",null,null,function(e,a){t(e,a);});},EAPI.prototype.getModuleDevices=function(e,t){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+e+"/devices",null,null,function(e,a){t(e,a);});},EAPI.prototype.getModuleStates=function(e,t){this._cloudservice._doJsonRequest("GET","/eapi/"+this._version+"/"+e+"/states",null,null,function(e,a){t(e,a);});},EAPI.prototype.executeModuleCommand=function(e,t,a){this._cloudservice._doJsonRequest("POST","/eapi/"+this._version+"/"+e+"/command",null,t,function(e,t){a(e,t);});},EAPI.prototype.doRequest=function(e,t,a,o,s,n){this._cloudservice._doJsonRequest(t,"/eapi/"+this._version+"/"+e+a,o,s,function(e,t,a,o){n(e,t,a,o);});};var Service=function Service(e){this._cloudservice=e,this._version="v1";};Service.prototype.getUserInfo=function(e){this._cloudservice._doJsonRequest("GET","/service/userInfo",null,null,function(t,a){e(t,a);});},Service.prototype.getModulesInfo=function(e){var t="/service/moduleInfo";this._cloudservice._moduleFlags&&this._cloudservice._moduleFlags.bosch_enabled&&(t+="?bosch_enabled=true"),this._cloudservice._doJsonRequest("GET",t,null,null,function(t,a){e(t,a);});},Service.prototype.toCloudDevice=function(e,t){this._cloudservice._doJsonRequest("POST","/service/toCloudDevice",null,e,function(e,a){t(e,a);});};var CloudService=function CloudService(e,t,a,o,s,n){this._logger=require("x.logger.js").getLogger("xnm.aio.cloudservice.CloudService"),this._ip=e,this._ip||(this._ip="cloud.mediola.com"),this._port=t,this._port||(this._port=443),this._username=a,this._password=o,this._moduleInfo=s,this._moduleFlags=n||{},this._protocol="https",this._eapi=new EAPI(this),this._ruleEngine=new RuleEngine(this),this._service=new Service(this);};return CloudService.prototype.getIP=function(){return this._ip;},CloudService.prototype.getPort=function(){return this._port;},CloudService.prototype.getUsername=function(){return this._password;},CloudService.prototype.getUserInfo=function(e){this._service.getUserInfo(e);},CloudService.prototype.getModulesInfo=function(e){this._service.getModulesInfo(e);},CloudService.prototype.toCloudDevice=function(e,t){this._service.toCloudDevice(e,t);},CloudService.prototype.doEAPIRequest=function(e,t,a,o,s,n){this._eapi.doRequest(e,t,a,o,s,n);},CloudService.prototype.disconenct=function(e,t,a){this._eapi.disconenct(e,t,a);},CloudService.prototype.getModuleConnectionInfo=function(e,t,a){this._eapi.getModuleConnectionInfo(e,t,a);},CloudService.prototype.getModuleInfo=function(e,t){this._eapi.getModuleInfo(e,t);},CloudService.prototype.getModuleDevices=function(e,t){this._eapi.getModuleDevices(e,t);},CloudService.prototype.getModuleStates=function(e,t){this._eapi.getModuleStates(e,t);},CloudService.prototype.executeModuleCommand=function(e,t,a){this._eapi.executeModuleCommand(e,t,a);},CloudService.prototype.getRules=function(e){this._ruleEngine.getRules(e);},CloudService.prototype.addRule=function(e,t){this._ruleEngine.addRule(e,t);},CloudService.prototype.updateRule=function(e,t,a){this._ruleEngine.updateRule(e,t,a);},CloudService.prototype.deleteRule=function(e,t){this._ruleEngine.deleteRule(e,t);},CloudService.prototype.deleteRules=function(e,t){this._ruleEngine.deleteRules(e,t);},CloudService.prototype.getAccessToken=function(e,t,a){var o={sid:e};t&&(o.force=1),this._doJsonRequest("GET","/getAccessToken",o,null,function(e,t){e?a&&a(e):t?a&&a(null,t.at):a&&a(new Error("invalid response"));});},CloudService.prototype.executeCommandCreator=function(e,t,a){if(e&&e.module&&e.connection&&e.id){if(t&&t.value){var o={connection:e.connection,device:e.id,command:t.value};if(void 0!==t.ext&&null!=t.ext)if(Array.isArray(t.ext)){var s={};t.ext.forEach(function(e){e&&e.value&&(s[e.value]=e.ext);}),o.value=s;}else o.value=t.ext;this.executeModuleCommand(e.module,o,function(e){a&&a(e);});}else a&&a(new Error("command json invalid"));}else a&&a(new Error("device json invalid"));},CloudService.prototype.getStatesCreator=function(e,t,a){var o=this,_getModuleStates=function _getModuleStates(e,t){o.getModuleStates(e,function(a,o){t(a,o,e);});},s=[],n=0;for(n=0;n<t.length;n++){var i=t[n];i&&i.device&&i.device.module&&-1==s.indexOf(i.device.module)&&s.push(i.device.module);}if(0!=s.length){var r=0,u=[],l=[];for(n=0;n<s.length;n++){_getModuleStates(s[n],function(e,o,n){r++;var i=[];if(e&&l.push(e),!e&&o)for(var c=0;c<t.length;c++){var m=t[c];if(m&&m.id&&m.device&&m.device.module==n){var d=null;if(m.device&&m.device.connection&&m.device.id&&m.status&&m.status.value){var v=o[m.device.connection];if(v&&v[m.device.id]){var p=v[m.device.id].states;p&&(d=p[m.status.value]);}}void 0!==d&&null!=d||(d="?"),u.push({id:m.id,status:d}),i.push({id:m.id,status:d});}}"undefined"!=typeof commandhandler&&null!=commandhandler&&void 0!==commandhandler.reportStates&&null!=commandhandler.reportStates&&!e&&i&&i.length>0&&commandhandler.reportStates(null,i),r==s.length&&a&&a(null,u,l);});}}else a&&a(null,[]);},CloudService.prototype.getDeviceList=function(e,t){this.getModuleDevices(e,function(a,o){if(a)t(a);else{var s=[];if(o){for(var n in o){var i=o[n];for(var r in i){var u=i[r];u&&(u.sys="cloudservice",u.module=e,u.connection=n,u.id=r,s.push(u));}}t(null,s);}else t(null,s);}});},CloudService.prototype._doJsonRequest=function(e,t,a,o,s){var n=null;o&&(n=JSON.stringify(o)),this._doRequest(e,t,a,n,function(e,t,a,o){if(e||t){if(t&&t.XC_ERR){var _a=t.XC_ERR;var _o=null,_n=_a.code;_a.msg?_o=_a.msg:_a.error&&"object"==_typeof(_a.error)&&("string"==typeof _a.error.message&&(_o=_a.error.message),void 0!==_a.error.code&&(_n=_a.error.code)),(e=_o?new Error("[XC_ERR] "+_o):new Error(JSON.stringify(t))).code=_n,s&&s(e);}else e?s&&s(e):t.XC_SUC?s&&s(null,t.XC_SUC,a,o):s&&s(new Error("unknown response"));}else s&&s(new Error("invalid response"));});},CloudService.prototype._resolveServerIP=function(e){if("/eapi/"==e.substr(0,6)){var t=e.split("/")[3];if(t){if(this._moduleInfo&&this._moduleInfo[t]&&this._moduleInfo[t].domain){var a=this._moduleInfo[t].domain,o=a.indexOf(":");return-1!=o?a.substr(0,o):a;}return this._ip;}return this._ip;}return this._ip;},CloudService.prototype._resolveServerPort=function(e){if("/eapi/"==e.substr(0,6)){var t=e.split("/")[3];if(t){if(this._moduleInfo&&this._moduleInfo[t]&&this._moduleInfo[t].domain){var a=this._moduleInfo[t].domain,o=a.indexOf(":");return-1!=o?parseInt(a.substr(o+1)):443;}return this._port;}return this._port;}return this._port;},CloudService.prototype._doRequest=function(e,t,a,o,s){var n=t;n||(n="/");var i={};a&&(i=JSON.parse(JSON.stringify(a)));var r="";for(var u in i){i.hasOwnProperty(u)&&(r&&(r+="&"),r+=u+"="+encodeURIComponent(i[u]));}r&&(n+="?"+r);var l={host:this._resolveServerIP(t),port:this._resolveServerPort(t),path:n,method:e,headers:{Connection:"close","Content-Type":"application/json; charset=UTF-8"}};(this._username||this._password)&&(l.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),l.headers.Authorization="Basic "+new Buffer((this._username?this._username:"")+":"+(this._password?this._password:"")).toString("base64"));var c=require(this._protocol);"https"==this._protocol&&"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var m=JSON.parse(JSON.stringify(l));m.headers&&(m.headers.auth&&(m.headers.auth="*********"),m.headers.Authorization&&(m.headers.Authorization="*********")),m.auth&&(m.auth="********"),this._logger.log("trace","do request:"+JSON.stringify(m));var d=this,v=s,p=c.request(l,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){d._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t);var a=null,o=null;if(200==e.statusCode)try{t&&(o=JSON.parse(t));}catch(e){a=e;}else{if(t)try{o=JSON.parse(t);}catch(e){}a=new Error("HTTP response: "+e.statusCode);}v&&(v(a,o,e.statusCode,e.headers),v=null);});});if(p.on&&p.on("error",function(e){d._logger.log("trace","do request error:"+e.message),v&&(v(e),v=null);}),p.setTimeout){var h=3e4;(t.startsWith("/service/userInfo")||t.startsWith("/service/moduleInfo"))&&(h=12e4),p.setTimeout(h,function(){d._logger.log("trace","do request timeout"),p.abort(),v&&(v(new Error("timeout")),v=null);});}o&&(this._logger.log("trace","do request send body:"+o),p.write(o)),p.end();},CloudService.prototype.toJSON=function(){return{sys:"cloudservice",username:this._username,password:this._password,ip:this._ip,port:this._port};},CloudService.prototype.equalsTo=function(e){return!!e&&e instanceof CloudService&&this._ip==e._ip&&this._port==e._port&&this._username==e._username&&this._password==e._password;},CloudService.parseJSON=function(e){return e&&e.username&&e.password?new CloudService(e.ip,e.port,e.username,e.password,e.moduleInfo,{bosch_enabled:e.bosch_enabled}):null;},CloudService;}(),xnm.aio.cloudservice.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="cloudserviceDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"cloudservice",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Cloud Service"}];},createGateway:function createGateway(e,t,a){var o=DMError,s=DMError.ERROR_CODE;e?e.username?e.password?a(null,e):a(new o(s.INVALID,"password is invalid")):a(new o(s.INVALID,"username is invalid")):a(new o(s.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,o){var s=DMError,n=DMError.ERROR_CODE;t?t.username?t.password?o(null,t):o(new s(n.INVALID,"password is invalid")):o(new s(n.INVALID,"username is invalid")):o(new s(n.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var o=DMError,s=DMError.ERROR_CODE;if(e){if(e.connection){if(e.id){if(e.gateway){var n,i,r=t.data.gateways;for(n=0;n<r.length;n++){if(r[n].index===e.gateway){i=r[n];break;}}i?a&&a(null,e):a(new o(s.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(s.INVALID,"gateway is invalid"));}else a(new o(s.INVALID,"id is invalid"));}else a(new o(s.INVALID,"connection is invalid"));}else a(new o(s.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var o=DMError,s=DMError.ERROR_CODE;if(e){if(e.connection){if(e.id){if(e.gateway){var n,i,r=t.data.gateways;for(n=0;n<r.length;n++){if(r[n].index===e.gateway){i=r[n];break;}}i?a(null,e):a(new o(s.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new o(s.INVALID,"gateway is invalid"));}else a(new o(s.INVALID,"id is invalid"));}else a(new o(s.INVALID,"connection is invalid"));}else a(new o(s.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t,a){var o=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,o=0;o<e.length;o++){if(e[o]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var s=[],n=null,i=o.getCommandStatusMap(e,a);return i&&(n=function(e,t,a){var o=[];return"command"==a.catagory?e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}}):"status"==a.catagory?e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}}):"ipevt"==a.catagory&&e.ipevt&&e.ipevt.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}}),o;}(i,0,t),s=s.concat(n)),s;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),n=null;if("command"==t.catagory)n=_filter(e,t),s.command=n;else if("status"==t.catagory)n=_filter(e,t),s.status=n;else{if("ipevt"!=t.catagory)return null;n=_filter(e,t),s.ipevt=n;}return n&&0!=n.length?s:null;},applyIPEventFilter:function applyIPEventFilter(e){return e?this.applyUIFilter(e,{catagory:"ipevt",elems:"*"}):null;},getCommandStatusMap:function getCommandStatusMap(e,t){var _resovleCommandItem=function _resovleCommandItem(e,t){var a=null;if(t.values){if(Array.isArray(t.values))a={type:"enum",name:e,ref:{value:e,ext:"%e",extMeta:t.values}};else if(Object.keys(t.values).length>0)for(var o in a={type:"multi",name:e,ref:{value:e,ext:"%multi",extMeta:[]}},t.values){var s=t.values[o],n=_resovleCommandItem(o,s);n&&a.ref.extMeta.push(n);}}else if(t.value){switch(t.value.type){case"FLOAT":a={type:"float",name:e,ref:{value:e,ext:"%f"}};break;case"RGB":a={type:"rgb",name:e,ref:{value:e,ext:"%rgb"}};break;case"RGBW":a={type:"rgbw",name:e,ref:{value:e,ext:"%rgbw"}};break;case"STRING":a={type:"string",name:e,ref:{value:e,ext:"%s"}};break;case"TIME":a={type:"time",name:e,ref:{value:e,ext:"%time"}};break;default:a={type:"int",name:e,ref:{value:e,ext:"%d"}};}null!=t.value.min&&null!=t.value.min&&null!=t.value.max&&null!=t.value.max&&a&&(a.ref.extMeta=t.value.min+"-"+t.value.max),null!=t.value.step&&null!=t.value.step&&a&&(a.ref.scale=t.value.step);}else a={type:"enum",name:e,ref:{value:e}};return t.hasOwnProperty("automation")&&(a=_objectSpread(_objectSpread({},a),{},{automation:t.automation})),a;};if(!e)return null;var a,o,s,n={command:[],status:[]};if(e.commands)for(a in n.command=[],e.commands){o=e.commands[a],s=null,"homematic"==e.module&&"eco"==a?(delete(o=JSON.parse(JSON.stringify(o))).values.duration,s=_resovleCommandItem(a,o)):"bosch"==e.module&&"off"==a?((o=JSON.parse(JSON.stringify(o))).value&&(o.value.type="INT",o.value.min=0),s=_resovleCommandItem(a,o)):"doorbird"===e.module?"view_image"!==a&&"view_live"!==a&&(s=_resovleCommandItem(a,o),"view_scheme"===a&&(s.name="view_scheme_doorbird")):s=_resovleCommandItem(a,o),s&&n.command.push(s);}if(e.states)for(a in n.status=[],n.ipevt=[],e.states){if((o=e.states[a]).values)0!=o.state&&n.status.push({type:"enum",name:a,ref:{value:a,options:o.values}}),0!=o.event&&n.ipevt.push({type:"enum",name:a,ref:{value:a,options:o.values}});else{switch(s=null,o.type){case"BOOL":s={type:"enum",name:a,ref:{value:a,options:["true","false"]}};break;case"FLOAT":s={type:"float",name:a,ref:{value:a}};break;case"RGB":s={type:"rgb",name:a,ref:{value:a}};break;case"RGBW":s={type:"rgbw",name:a,ref:{value:a}};break;case"STRING":s={type:"string",name:a,ref:{value:a}};break;default:s={type:"int",name:a,ref:{value:a}};}null!=o.min&&null!=o.min&&null!=o.max&&null!=o.max&&s&&(s.ref.extMeta=o.min+"-"+o.max),null!=o.step&&null!=o.step&&s&&(s.ref.scale=o.step),s&&(0!=o.state&&n.status.push(s),0!=o.event&&n.ipevt.push(s));}}return n;},toGeneralDevice:function toGeneralDevice(e,t,a){if(!e||!e.module)return null;var o=null;switch(e.module){case"hue":case"lightify":var s,n;if(o={type:"dimmer",commands:{},states:{},details:{commands:{},states:{}}},e.commands)for(n in e.commands){switch(n){case"on":case"off":case"toggle":case"up":case"down":o.commands[n]={},o.details.commands[n]={value:n};break;case"brightness":case"colorTemperature":o.commands[n]={value:{type:"INT"}},o.details.commands[n]={value:n,ext:"%d"},e.commands[n]&&e.commands[n].value&&(s=e.commands[n].value,isNaN(s.min)||isNaN(s.max)||(o.commands[n].value.min=s.min,o.commands[n].value.max=s.max,o.details.commands[n].extMeta=s.min+"-"+s.max));break;case"color":o.commands[n]={value:{type:"RGB"}},o.details.commands[n]={value:n,ext:"%rgb"},o.commands.white={},o.details.commands.white={value:"color",ext:"FFFFFF"},e.commands[n]&&e.commands[n].value&&"RGBW"==(s=e.commands[n].value).type&&(o.commands[n].value.type="RGBW",o.details.commands[n].ext="%rgbw",o.details.commands.white={value:"color",ext:"FFFFFFFF"});}}if(e.states)for(n in e.states){switch(n){case"state":o.states.state={values:["on","off"]},o.details.states.state={value:"state"};break;case"brightness":o.states.brightness={value:{type:"INT",min:0,max:100}},o.details.states.brightness={value:"brightness",ext:"%d",extMeta:"0-100"};break;case"colorTemperature":o.states.colorTemperature={value:{type:"INT",min:154,max:500}},o.details.states.colorTemperature={value:"colorTemperature",ext:"%d",extMeta:"154-500"};break;case"color":o.states.color={type:"RGB"},o.details.states.color={value:"color",ext:"%rgb"},e.states[n]&&e.states[n].value&&"RGBW"==(s=e.states[n].value).type&&(o.states.color.type="RGBW",o.details.states.color.ext="%rgbw");}}break;case"somfy":if(o={type:"blind",commands:{},states:{},details:{commands:{},states:{}}},e.commands)for(n in e.commands){switch(n){case"open":case"close":o=null;break;case"stop":case"up":case"down":o.commands[n]={},o.details.commands[n]={value:n};break;case"position":case"rotation":o.commands[n]={value:{type:"INT",min:0,max:100}},o.details.commands[n]={value:n,ext:"%d"};}}if(e.states)for(n in e.states){switch(n){case"position":case"rotation":o.states[n]={value:{type:"INT",min:0,max:100}},o.details.states[n]={value:n,ext:"%d",extMeta:"0-100"};}}break;case"homematic":switch(e.type){case"switch":(o=JSON.parse(JSON.stringify(e))).details={commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"state"}}},o.states.power&&(o.details.states.power={value:"power"}),o.states.consumption&&(o.details.states.consumption={value:"consumption"});break;case"dimmer":(o=JSON.parse(JSON.stringify(e))).details={commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"},up:{value:"up"},down:{value:"down"},brightness:{value:"brightness"}},states:{state:{value:"state"},brightness:{value:"brightness"}}};break;case"blind":(o=JSON.parse(JSON.stringify(e))).details={commands:{up:{value:"up"},down:{value:"down"},stop:{value:"stop"},stepUp:{value:"stepUp"},stepDown:{value:"stepDown"},position:{value:"position"}},states:{position:{value:"position"}}},o.commands.rotation&&(o.details.commands.rotation={value:"rotation"}),o.states.rotation&&(o.details.states.rotation={value:"rotation"});break;case"heater":if((o=JSON.parse(JSON.stringify(e))).details={},!o.commands)return null;o.commands&&(o.details.commands={up:{value:"up"},down:{value:"down"},temperature:{value:"temperature"},mode:{value:"mode"},auto:{value:"mode",ext:"auto"},manu:{value:"mode",ext:"manu"},boost:{value:"mode",ext:"boost"}}),o.states&&(o.details.states={state:{value:"state"},mode:{value:"mode"},temperature:{value:"temperature"},humidity:{value:"humidity"}});break;case"temperature":(o=JSON.parse(JSON.stringify(e))).states&&(o.details={states:{}},o.states.temperature&&(o.details.states.temperature={value:"temperature"}),o.states.humidity&&(o.details.states.humidity={value:"humidity"}));break;case"motion":(o=JSON.parse(JSON.stringify(e))).states&&(o.details={states:{}},o.states.motion&&(o.details.states.motion={value:"motion"}));break;case"contact":(o=JSON.parse(JSON.stringify(e))).states&&(o.details={states:{}},o.states.contact&&(o.details.states.state={value:"contact"}));break;case"window":(o=JSON.parse(JSON.stringify(e))).states&&(o.details={states:{}},o.states.window&&(o.details.states.state={value:"window"}));}break;case"bosch":switch(e.type){case"switch":o={type:"switch",commands:{on:{},off:{},toggle:{}},states:{state:{values:["on","off"]},power:{type:"FLOAT",unit:"W"},consumption:{type:"FLOAT",unit:"W"}},details:{commands:{on:{value:"on"},off:{value:"off"},toggle:{value:"toggle"}},states:{state:{value:"state"},power:{value:"power"},consumption:{value:"energy"}}}};break;case"shutter":o={type:"blind",commands:{up:{},down:{},stop:{},position:{value:{type:"INT",min:0,max:100}}},states:{position:{type:"INT",min:0,max:100}},details:{commands:{up:{value:"up"},down:{value:"down"},stop:{value:"stop"},position:{value:"position"}},states:{position:{value:"position"}}}};break;case"heater":o={type:"heater",commands:{up:{},down:{},temperature:{value:{type:"FLOAT",min:5,max:30.5,step:.5}}},states:{state:{type:"FLOAT",min:5,max:30.5,step:.5},temperature:{type:"FLOAT"},mode:{values:["automatic","manual"]}},details:{commands:{up:{value:"up"},down:{value:"down"},temperature:{value:"temperature"}},states:{state:{value:"state"},temperature:{value:"temperature"},mode:{value:"mode"}}}};break;case"contact":o={type:"contact",states:{state:{values:["open","closed"]}},details:{states:{state:{value:"state"}}}};}}return o;},supportSmartWidget:function supportSmartWidget(e,t){if(!e||!e.module)return!1;switch(e.module){case"gardena":case"homeconnect":case"netatmo":case"openweathermap":case"nuki":case"uhoo":return!0;case"enet":return["awning","blind","dimmer","light","switch"].includes(e.type);case"ring":return"doorbell"===e.type;case"homematic":case"hmipc2c":switch(e.type){case"contact":case"dimmer":case"door":case"enviroment":case"environment":case"heater":case"home":case"motion":case"presence":case"room":case"security":case"temperature":case"smoke":case"water":case"weather":return!0;}case"novoferm":return"door"===e.type;}return!1;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,a,o,s){if(!t||!t.module)return null;var n=null,i=null,r=null;n=function(e,t){switch(e.module){case"bosch":"camera"===e.type&&(e.commands&&e.commands.position?t.push("bosch_cam"):t.push("bosch_cam_eyes"));break;case"gardena":switch(e.type){case"mower":t.push("gardena_mower");break;case"switch":t.push("gardena_switch");break;case"sensor":t.push("gardena_sensor");break;case"ic24":t.push("gardena_ic24");break;case"valve":t.push("gardena_valve");}break;case"netatmo":switch(e.type){case"NAMain":t.push("netatmo_basestation");break;case"NAModule1":case"NAModule4":t.push("climate"),t.push("notification");break;case"NAModule2":t.push("netatmo_wind"),t.push("notification");break;case"NAModule3":t.push("netatmo_rain"),t.push("notification");break;case"NHC":t.push("climate","notification");}break;case"openweathermap":t.push("openweathermap");break;case"nuki":t.push("nuki");break;case"ring":if("doorbell"===e.type)t.push("motion");break;case"uhoo":t.push("uhoo");break;case"enet":switch(e.type){case"awning":case"blind":t.push("blind");break;case"dimmer":t.push("dimmer","switch");break;case"light":case"switch":t.push("switch");}break;case"novoferm":"door"===e.type&&t.push("hm_tormatic");break;case"homeconnect":var _a2={"cleaning robot":["bsh_vacuum"],"coffee maker":["bsh_drinks"],"cook processor":["bsh_oven"],cooktop:["bsh_oven"],"dish washer":["bsh_dishwasher"],dryer:["bsh_dryer"],freezer:["bsh_fridge"],"fridge freezer":["bsh_fridge"],hob:["bsh_oven"],hood:["bsh_hood","rgb"],oven:["bsh_oven"],refrigerator:["bsh_fridge"],"warming drawer":["bsh_oven"],"washer dryer":["bsh_dryer","bsh_washer"],washer:["bsh_washer"],"wine cooler":["bsh_fridge"]};_a2[e.type]&&t.push.apply(t,["bsh_general"].concat(_toConsumableArray(_a2[e.type])));break;case"homematic":case"hmipc2c":switch((e.states.battery||e.states.timeout||e.states.sabotage)&&t.push("notification"),e.type){case"dimmer":t.push("dimmer"),t.push("switch");break;case"door":t.push("hm_tormatic");break;case"heater":t.push("thermostat");break;case"home":t.push("weather_station"),t.push("climate"),t.push("home");break;case"enviroment":case"environment":case"temperature":(e.states.temperature||e.states.humidity)&&t.push("climate"),e.states.rain&&t.push("rain");break;case"contact":case"window":t.push("contact"),t.push("window");break;case"motion":case"security":e.states.motion&&t.push("motion"),(e.states.moisture||e.states.water)&&t.push("sensor_water"),e.states.presence&&t.push("motion"),e.states.window&&(t.push("window"),t.push("contact")),e.states.smoke&&t.push("smoke");break;case"presence":e.states.presence&&t.push("motion");break;case"smoke":(e.states.smoke||e.states.smoke_alarm_state)&&t.push("smoke");break;case"water":e.states.water&&t.push("sensor_water");break;case"weather":t.push("weather_station"),t.push("climate");break;case"other":e.states.co2Level&&t.push("sensor_co2");}}return t;}(t,n||[]),i=function(e,t){switch(e.module){case"bosch":if("camera"===e.type){var _a4=e.commands;t["%toggle%"]={value:"toggle"},_a4&&_a4.position&&(t["%camPosition%"]={value:"position",ext:"%d",extMeta:"-120-120"});}break;case"gardena":if(!e.commands)break;switch(e.type){case"mower":t["%start%"]={value:"start_override_timer",ext:"%d",extMeta:"60-6000",scale:60},t["%park%"]={value:"park_until_next_task"};break;case"switch":t["%on%"]={value:"on"},t["%onFor%"]={value:"on_for",ext:"%d",extMeta:"60-7200",scale:60},t["%off%"]={value:"off"};break;case"ic24":t["%stopAll%"]={value:"stop_all_valve"};break;case"valve":t["%run%"]={value:"run",ext:"%d",extMeta:"60-3600",scale:60},t["%pause%"]={value:"pause",ext:"%d",extMeta:"60-604800",scale:60},t["%resume%"]={value:"resume"},t["%stop%"]={value:"stop"};}break;case"nuki":t["%unlock%"]={value:"unlock"},t["%lock%"]={value:"lock"},t["%open%"]={value:"lock_n_go"};break;case"enet":if(!e.commands)break;switch(e.type){case"awning":case"blind":t["%moveTo%"]={value:"position",ext:"%d",extMeta:"0-100"},t["%stop%"]={value:"stop"},e.commands.down?t["%moveDown%"]={value:"down"}:e.commands.out&&(t["%moveDown%"]={value:"out"}),e.commands.up?t["%moveUp%"]={value:"up"}:e.commands["in"]&&(t["%moveUp%"]={value:"in"}),e.commands.rotation&&(t["%lamellaTo%"]={value:"rotation",ext:"%d",extMeta:"0-100"});break;case"dimmer":case"light":case"switch":t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"},t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"},t["%toggle%"]={value:"toggle"},e.commands.brightness&&(t["%dimTo%"]={value:"brightness",ext:"%d",extMeta:"0-100"});}break;case"novoferm":"door"===e.type&&(t["%open%"]={value:"up"},t["%partialOpen%"]={value:"partial"},t["%close%"]={value:"down"},t["%stop%"]={value:"stop"});break;case"hmipc2c":case"homematic":if(!e.commands)break;switch(e.type){case"switch":e.commands.on&&(t["%on%"]={value:"on"}),e.commands.off&&(t["%off%"]={value:"off"}),e.commands.toggle&&(t["%toggle%"]={value:"toggle"});break;case"dimmer":e.commands.brightness&&(t["%dimTo%"]={value:"brightness",ext:"%d",extMeta:"0-100"}),e.commands.up&&(t["%dimUp%"]={value:"up"}),e.commands.down&&(t["%dimDown%"]={value:"down"}),e.commands.on&&(t["%dimOn%"]={value:"on"},t["%on%"]={value:"on"}),e.commands.off&&(t["%dimOff%"]={value:"off"},t["%off%"]={value:"off"}),e.commands.toggle&&(t["%toggle%"]={value:"toggle"});break;case"door":t["%open%"]={value:"open"},t["%close%"]={value:"close"},t["%stop%"]={value:"stop"},e.commands.garage_door_state&&(t["%partialOpen%"]={value:"garage_door_state",ext:"ventilation_position"});break;case"heater":if(e.commands.temperature){var _a5=e.commands.temperature.value||{};t["%thermoTempTo%"]={value:"temperature",ext:"%f",scale:_a5.scale||"0.5"};}e.commands.down&&(t["%thermoTempDown%"]={value:"down"}),e.commands.up&&(t["%thermoTempUp%"]={value:"up"});break;case"home":e.commands.alarm_mode&&(t["%alarmModeDisarm%"]={value:"alarm_mode",ext:"disarmed"},t["%alarmModeProtectExternal%"]={value:"alarm_mode",ext:"external_protection"},t["%alarmModeProtectFull%"]={value:"alarm_mode",ext:"full_protection"}),e.commands.auto&&(t["%thermoAuto%"]={value:"auto"}),e.commands.eco&&(t["%thermoEco%"]={value:"eco",extMeta:[{type:"time",name:"start",ref:{value:"start",ext:"%time"}},{type:"time",name:"end",ref:{value:"end",ext:"%time"}}]}),e.commands.vacation&&(t["%thermoVacation%"]={value:"vacation",extMeta:[{type:"float",name:"temperature",ref:{value:"temperature",ext:"%f",extMeta:"5-30",scale:.5}},{type:"time",name:"end",ref:{value:"end",ext:"%time"}}]});}break;case"homeconnect":var _a3=e.commands;if(!_a3)break;for(var _e in _a3){_a3[_e].values||(t["%".concat(_e,"%")]={value:_e});}if(_a3.PowerState){var _e2=_a3.PowerState.values;_e2&&!_e2.includes("On")||(t["%on%"]={value:"PowerState",ext:"On"}),_e2&&!_e2.includes("Off")||(t["%off%"]={value:"PowerState",ext:"Off"}),_e2&&!_e2.includes("Standby")||(t["%standby%"]={value:"PowerState",ext:"Standby"});}"dish washer"===e.type&&(t["%Intensiv%"]=t["%Intensiv45%"]||t["%Intensiv70%"],t["%Normal%"]=t["%Normal45%"]||t["%Normal65%"],t["%Quick%"]=t["%Quick45%"]||t["%Quick65%"]),_a3.AmbientLightBrightness&&(t["%ambientTo%"]=_a3.AmbientLightBrightness),_a3.AmbientLightCustomColor&&(t["%colorTo%"]=_a3.AmbientLightCustomColor),_a3.AmbientLightEnabled&&(t["%ambientOn%"]={value:"AmbientLightEnabled",ext:!0},t["%ambientOff%"]={value:"AmbientLightEnabled",ext:!1}),_a3.Lighting&&(t["%dimOn%"]={value:"Lighting",ext:!0},t["%dimOff%"]={value:"Lighting",ext:!1}),_a3.LightingBrightness&&(t["%dimTo%"]=_a3.LightingBrightness);}return t;}(t,i||{}),r=function(e,t){switch(e.module){case"bosch":"camera"===e.type&&(t["%camOnline%"]={value:"online"},e.states&&e.states.position&&(t["%camPosition%"]={value:"position",extMeta:"-120-120"}),t["%camState%"]={value:"state"});break;case"gardena":if(!e.states)break;switch(e.states.online&&(t["%online%"]={value:"online",options:["true","false"]}),e.type){case"mower":t["%state%"]={value:"state",options:["paused","ok_cutting","ok_cutting_timer_overridden","ok_searching","ok_leaving","ok_charging","parked_timer","parked_park_selected","parked_autotimer","none"]};break;case"switch":t["%state%"]={value:"state",options:["off","forever_on","time_limited_on","scheduled_on"]},t["%duration%"]={value:"duration"};break;case"sensor":t["%tempAmbient%"]={value:"ambient_temperature"},t["%tempSoil%"]={value:"soil_temperature"},t["%humSoil%"]={value:"soil_humidity"},t["%light%"]={value:"light"};break;case"valve":t["%state%"]={value:"state",options:["closed","manual_watering","scheduled_watering"]},t["%duration%"]={value:"duration"};}break;case"netatmo":switch(e.type){case"NAMain":t["%tempState%"]={value:"temperature"},t["%humState%"]={value:"humidity"},t["%co2State%"]={value:"co2"},t["%noiseState%"]={value:"noise"},t["%pressureState%"]={value:"pressure"};break;case"NAModule1":case"NAModule4":t["%tempState%"]={value:"temperature"},t["%humState%"]={value:"humidity"},t["%lowbat%"]={value:"battery",conv_i:{"0|30":!0,"31|100":!1}};break;case"NAModule2":t["%windspeedState%"]={value:"wind_speed"},t["%windDirection%"]={value:"wind_direction"},t["%lowbat%"]={value:"battery",conv_i:{"0|30":!0,"31|100":!1}};break;case"NAModule3":t["%rain%"]={value:"rain"},t["%rain_last_hour%"]={value:"rain_last_hour"},t["%rain_last_day%"]={value:"rain_last_day"},t["%lowbat%"]={value:"battery",conv_i:{"0|30":!0,"31|100":!1}};break;case"NHC":t["%co2State%"]={value:"co2"},t["%humState%"]={value:"humidity"},t["%noiseState%"]={value:"noise"},t["%pressureState%"]={value:"pressure"},t["%tempState%"]={value:"temperature"};}break;case"openweathermap":t["%tempState%"]={value:"temperature"},t["%humState%"]={value:"humidity"},t["%windspeedState%"]={value:"wind_speed"},t["%windDirection%"]={value:"wind_direction"};break;case"nuki":t["%lockStatus%"]={value:"state",conv_s:{locked:"locked",unlocked:"open"}};break;case"ring":if("doorbell"===e.type)t["%motionState%"]={value:"state",conv_s:{locked:"locked",unlocked:"open"}};break;case"uhoo":t["%onlineState%"]={value:"online"},t["%tempState%"]={value:"temperature",extMeta:"-40-85"},t["%tempUnit%"]={value:"temperature_unit"},t["%humState%"]={value:"humidity",extMeta:"0-100"},t["%dustState%"]={value:"dust",extMeta:"0-200"},t["%vocState%"]={value:"voc",extMeta:"0-1200"},t["%co2State%"]={value:"co2",extMeta:"400-10000"},t["%coState%"]={value:"co",extMeta:"0-1000"},t["%pressureState%"]={value:"pressure",extMeta:"300-1100"},t["%no2State%"]={value:"no2",extMeta:"0-1000"},t["%ozoneState%"]={value:"ozone",extMeta:"0-1000"},t["%measured%"]={value:"measured"};break;case"enet":if(!e.states)break;switch(e.type){case"awning":case"blind":t["%blindState%"]={value:"position",extMeta:"0-100"},e.states.rotation&&(t["%lamellaState%"]={value:"rotation",extMeta:"0-100"});break;case"dimmer":case"light":case"switch":t["%switchState%"]={value:"power"},e.states.brightness&&(t["%dimmerState%"]={value:"brightness",extMeta:"0-100"});}break;case"novoferm":"door"===e.type&&(t["%doorState%"]={value:"state"});break;case"hmipc2c":case"homematic":switch(e.states.battery&&(t["%lowbat%"]={value:"battery",conv_i:{"0|30":"true","31|100":"false"}}),e.states.timeout&&(t["%timeout%"]={value:"timeout"}),e.states.sabotage&&(t["%sabotage%"]={value:"sabotage"}),e.type){case"dimmer":e.states.brightness&&(t["%dimmerState%"]={value:"brightness"}),e.states.state&&(t["%switchState%"]={value:"state"});break;case"door":e.states.garage_door_state&&(t["%doorState%"]={value:"garage_door_state"});break;case"switch":e.states.state&&(t["%switchState%"]={value:"state"});break;case"heater":e.states.temperature&&(t["%thermoCurrentTemp%"]={value:"temperature"}),e.states.setpoint&&(t["%thermoSetTemp%"]={value:"setpoint"}),e.states.humidity&&(t["%thermoHum%"]={value:"humidity"});break;case"home":e.states.temperature&&(t["%tempState%"]={value:"temperature"}),e.states.humidity&&(t["%humState%"]={value:"humidity"}),e.states.wind_speed&&(t["%windspeedState%"]={value:"wind_speed"}),e.states.wind_direction&&(t["%windDirection%"]={value:"wind_direction"},t["%windDirection%"].conv_i={"0|22":"N","23|67":"NO","68|112":"O","113|157":"SO","158|202":"S","203|247":"SW","248|292":"W","293|337":"NW","338|360":"N"}),e.states.alarm_mode&&(t["%alarmMode%"]={value:"alarm_mode"}),e.states.mode&&(t["%thermoMode%"]={value:"mode"});break;case"enviroment":case"environment":case"temperature":e.states.temperature&&(t["%tempState%"]={value:"temperature"}),e.states.humidity&&(t["%humState%"]={value:"humidity"}),e.states.rain&&(t["%rainState%"]={value:"rain"});break;case"contact":e.states.state&&(t["%contactState%"]={value:"state"},t["%windowState%"]={value:"state"});break;case"motion":case"security":e.states.motion&&(t["%motionState%"]={value:"motion"}),(e.states.moisture||e.states.water)&&(t["%waterState%"]={value:"water",conv_s:{"true":"water","false":"dry"}}),e.states.presence&&(t["%motionState%"]||(t["%motionState%"]={value:"presence"})),e.states.window&&(t["%windowState%"]={value:"window"},t["%contactState%"]={value:"window"}),e.states.smoke&&(t["%smokeState%"]={value:"smoke"});break;case"presence":e.states.presence&&(t["%motionState%"]={value:"presence"}),e.states.illumination&&(t["%motionBrightness%"]={value:"illumination"});break;case"smoke":e.states.smoke&&(t["%smokeState%"]={value:"smoke"}),e.states.smoke_alarm_state&&(t["%smokeState%"]={value:"smoke_alarm_state",conv_s:{primary_alarm:"true",secondary_alarm:"true",intrusion_alarm:"true",idle_off:"false"}});break;case"water":e.states.water&&(t["%waterState%"]={value:"water",conv_s:{"true":"water","false":"dry"}});break;case"weather":e.states.temperature&&(t["%tempState%"]={value:"temperature"}),e.states.humidity&&(t["%humState%"]={value:"humidity"}),e.states.illumination&&(t["%brightnessState%"]={value:"illumination"}),e.states.wind_speed&&(t["%windspeedState%"]={value:"wind_speed"}),e.states.wind_direction&&(t["%windDirection%"]={value:"wind_direction"},t["%windDirection%"].conv_i={"0|22":"N","23|67":"NO","68|112":"O","113|157":"SO","158|202":"S","203|247":"SW","248|292":"W","293|337":"NW","338|360":"N"}),e.states.rain&&(t["%rainingState%"]={value:"rain"}),e.states.rain_total&&(t["%rainingCounterState%"]={value:"rain_total"}),e.states.sunshine_total&&(t["%sunshineState%"]={value:"sunshine_total"});break;case"other":e.states.co2Level&&(t["%co2State%"]={value:"co2Level"});}break;case"homeconnect":var _a6=e.states;if(!_a6)break;for(var _e3 in _a6){var _o2=_a6[_e3],_s=String(_o2.type).toLowerCase();if(_o2.state)if(["enum","string"].includes(_s))t["%".concat(_e3,"%")]={value:_e3};else if(["float","int"].includes(_s)){var _a7={value:_e3};void 0!==_o2.min&&(_a7.min=_o2.min),void 0!==_o2.max&&(_a7.max=_o2.max),t["%".concat(_e3,"%")]=_a7;}}_a6.AmbientLightBrightness&&(i["%ambientState%"]=_a6.AmbientLightBrightness),_a6.AmbientLightCustomColor&&(i["%colorState%"]=_a6.AmbientLightCustomColor),_a6.LightingBrightness&&(i["%dimmerState%"]=_a6.LightingBrightness);}return t;}(t,r||{});var u=this._injectToSmartWidgetTemplate(o,n,s,i,r,t);if(Array.isArray(u)&&"bosch"===t.module&&"camera"===t.type&&(!t.commands||!t.commands.toggle))for(var l=0;l<u.length;l++){var c=u[l];if(c&&c.meta&&c.elements&&0===String(c.meta.type).indexOf("bosch_cam")){var m=c.elements.buttons;if(Array.isArray(m))for(var d=0;d<m.length;d++){var v=m[d];v&&v.action&&v.action.ref&&"toggle"===v.action.ref.value&&delete v.action;}}}return u;},_injectToSmartWidgetTemplate:function _injectToSmartWidgetTemplate(e,t,a,o,s,n){var i=[];if(!t)return i;e=e||{},o=o||{},s=s||{};for(var r=0;r<e.length;r++){var u=e[r];if(u.meta&&u.elements&&t.includes(u.meta.type)){var l=JSON.parse(JSON.stringify(u)),c=!1,m=!1;for(var d in l.elements){var v=l.elements[d];if(v&&Array.isArray(v))for(var p=0;p<v.length;p++){var h=v[p];if(h){if(h.action&&("command"==h.action.type||"camera"==h.action.type)&&h.action.ref&&h.action.ref.value){var _e4=h.action.ref.value;var f=h.action.ref.ext;if(o[_e4]){h.action.device=a;var _t=JSON.parse(JSON.stringify(o[_e4]));if(h.action.ref=_t,void 0!==f&&null!=f&&(_t.ext=f),("sliders"==d||"roundsliders"==d)&&_t.extMeta){var g=_t.extMeta.indexOf("-",1);if(-1!=g){var _=_t.extMeta.substr(0,g);_=parseFloat(_);var w=_t.extMeta.substr(g+1);w=parseFloat(w),isNaN(_)||(h.min=_),isNaN(w)||(h.max=w);}}c=!0;}else m=!0,h.action=null;}h.status&&h.status.ref&&h.status.ref.value&&(s[h.status.ref.value]?(h.status.ref=JSON.parse(JSON.stringify(s[h.status.ref.value])),h.status.device=a,c=!0):(m=!0,h.status=null)),h.maxValFromStatus&&h.maxValFromStatus.ref&&h.maxValFromStatus.ref.value&&(s[h.maxValFromStatus.ref.value]?(h.maxValFromStatus.ref=JSON.parse(JSON.stringify(s[h.maxValFromStatus.ref.value])),h.maxValFromStatus.device=a,c=!0):(m=!0,h.maxValFromStatus=null));}}}!c||m&&"homeconnect"!==n.module||(m&&"homeconnect"===n.module&&(l.meta.note=String(l.meta.note||""),l.meta.note.length>0&&(l.meta.note+=","),l.meta.note+="bsh_incomplete"),i.push(l));}}return i;}};}(),xnm.aio.cloudservice.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.cloudservice.DM,Handler.prototype.CloudService=xnm.aio.cloudservice.CloudService,Handler.prototype.Ivideon=xnm.aio.cloudservice.Ivideon,Handler.prototype.Ring=xnm.aio.cloudservice.Ring,Handler.prototype.Bosch=xnm.aio.cloudservice.Bosch,Handler.prototype.DoorBird=xnm.aio.cloudservice.DoorBird,Handler.prototype.registModule=function(e){e.register("cloudservice","cloudservice");},Handler.prototype.resolveGateway=function(e){return e?this.CloudService.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=a?a.command:[];t&&t(null,o);},Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=a?a.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,a,o){var s=this.resolveGateway(e);s?s.executeCommandCreator(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,o,s){var n=this.resolveGateway(t);if(n){var i=[{id:e,device:a,status:o}];n.getStatesCreator(null,i,function(e,t){e?s&&s(e):s&&s(null,t[0]);});}else s&&s(new Error("gateway json format invalid"));},Handler.prototype.getUserInfo=function(e,t){var a=this.resolveGateway(e);a?a.getUserInfo(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.getModulesInfo=function(e,t){var a=this.resolveGateway(e);a?a.getModulesInfo(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t,a){if(t){var o=this.resolveGateway(e);o?o.getDeviceList(t,function(e,t){a&&a(e,t);}):a&&a(new Error("gateway json format invalid"));}else a&&a(new Error("module name invalid"));},Handler.prototype.getConnectionState=function(e,t,a,o){if(t){if(a){var s=this.resolveGateway(e);s?s.getModuleConnectionInfo(t,a,function(e,t){o&&o(e,t);}):o&&o(new Error("gateway json format invalid"));}else o&&o(new Error("connection id invalid"));}else o&&o(new Error("module name invalid"));},Handler.prototype.disconnect=function(e,t,a,o){if(t){if(a){var s=this.resolveGateway(e);s?s.disconenct(t,a,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));}else o&&o(new Error("connection id invalid"));}else o&&o(new Error("module name invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloudservice.Handler());