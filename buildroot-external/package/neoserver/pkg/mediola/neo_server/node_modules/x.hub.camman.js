var x=x||{};x.hub=x.hub||{},x.hub.camman=x.hub.camman||{},x.hub.camman.CamManager=function(){var CM=function CM(){this._logger=require("x.logger.js").getLogger("x.hub.x.hub.camman.CamManager"),this._folder=null;};return CM.prototype.init=function(e,t){this._logger.log("info","init cam managaer");var a=require("fs-extra"),n=require("path"),r=e.getUserRootDataPath();this._folder=n.resolve(r,"cam"),a.ensureDir(this._folder,function(){t&&t();});},CM.prototype.saveSnapshot=function(e,t,a){if(e&&e.deviceName&&t){var n=require("fs-extra"),r=require("path"),o=r.resolve(this._folder,e.deviceName);n.ensureDir(o,function(e){if(e)a&&a(e);else{var s=new Date(),i=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+"_"+s.getHours()+":"+s.getMinutes()+":"+s.getSeconds(),u=r.resolve(o,i+".jpg");n.move(t,u,{clobber:!0},function(e){a&&a(e);});}});}else a&&a(new Error("argument error"));},CM.prototype.getSnapshot=function(e,t,a){var n=require("path").resolve(this._folder,e,t);a&&a(null,n);},CM.prototype.getSnapshots=function(e){var t=require("fs-extra"),a=require("path"),n=this;t.readdir(this._folder,function(r,o){if(r)e&&e(r);else{var s={},i=0,cb=function cb(r,u){var c=o[i];s[c]=!r&&u?u:[],++i==o.length?e&&e(null,s):t.readdir(a.resolve(n._folder,o[i]),cb);};t.readdir(a.resolve(n._folder,o[i]),cb);}});},CM;}(),x.hub.camman.Handler=function(){var Handler=function Handler(){this.camManager=new x.hub.camman.CamManager();};return Handler.prototype.DeviceManager=x.hub.camman.CamManager,Handler.prototype.init=function(e,t,a){this._config(e),this.camManager.init(t,a);},Handler.prototype.saveSnapshot=function(e,t,a){this.camManager.saveSnapshot(e,t,a);},Handler.prototype._config=function(e){e.use("/xhub/cammanager/snapshots",function(e,t){this.camManager.getSnapshots(function(e,a){t.json(this._toRestfulResponse(e,a));}.bind(this));}.bind(this)),e.use("/xhub/cammanager/snapshot",function(e,t){var a=e.query.cam,n=e.query.file;a&&n?this.camManager.getSnapshot(a,n,function(e,a){e?t.status(404).end():t.sendFile(a,function(e){e&&e.statusCode&&t.status(e.statusCode).end(e.message);});}.bind(this)):t.status(404).end();}.bind(this));},Handler.prototype._toRestfulResponse=function(e,t){return e?{status:"fail",message:e.message,code:e.code?e.code:0}:{status:"success",data:t};},Handler;}(),module.exports=new x.hub.camman.Handler();