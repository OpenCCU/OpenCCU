function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _iterableToArray(iter){if(typeof Symbol!=="undefined"&&iter[Symbol.iterator]!=null||iter["@@iterator"]!=null)return Array.from(iter);}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.taskmanager=xnm.aio.taskmanager||{},xnm.aio.taskmanager.Taskmanager=function(){},xnm.aio.taskmanager.Taskmanager.prototype.setCloudService=function(e){return this._cloudService=e,this._cloudTM=new require("xnm.aio.cloudTaskmanager"),this._cloudTM.setCloudService(e),this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl),this;},xnm.aio.taskmanager.Taskmanager.prototype.setWebserviceUrl=function(e){return this._webServiceUrl=e,this;},xnm.aio.taskmanager.Taskmanager.prototype.setCloudAccessUrl=function(e){return this._cloudAccessUrl=e,this._cloudTM&&this._cloudTM.setCloudAccessUrl(this._cloudAccessUrl),this;},xnm.aio.taskmanager.Taskmanager.prototype.setAuth=function(e){return this._auth=e,this;},xnm.aio.taskmanager.Taskmanager.prototype.setSystemData=function(e){return xnm.aio.taskmanager.SystemData=e,this;},xnm.aio.taskmanager.Taskmanager.prototype.runTask=function(e,a){(xnm.aio.taskmanager.isVx(e.aio)?xnm.aio.taskmanager.runVxTask:xnm.aio.taskmanager.runVxProTask)(e,a);},xnm.aio.taskmanager.Taskmanager.prototype.saveTask=function(e,a){xnm.aio.taskmanager.isVx(e.aio)?this.runVxSaving(e,a):this.runVxProSaving(e,a);},xnm.aio.taskmanager.Taskmanager.prototype.runVxSaving=function(e,a){var t=e.root["if"].filter(function(e){return e.cloud;}),n=e.root.then[0].then.filter(function(e){return e.cloud;});e.root["if"]=e.root["if"].filter(function(e){return!e.cloud;}),e.root.then[0].then=e.root.then[0].then.filter(function(e){return!e.cloud;});var i=[],s=[xnm.aio.taskmanager.addVxLocalCloudActions.bind(this,e,n),this.createVxEspActions.bind(this,e),xnm.aio.taskmanager.saveVxTask.bind(this,e,i),this.saveVxSnsData.bind(this,e,i)];xnm.aio.taskmanager.hasCloudDevices()&&s.push(this._cloudTM.saveVxCloudData.bind(this._cloudTM,e,t,n)),new xnm.aio.taskmanager.FunctionStack(s).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.runVxProSaving=function(e,a){var t=e.root["if"].filter(function(e){return e.cloud;}),n=e.root.then[0].then.filter(function(e){return e.cloud;}),i=xnm.aio.taskmanager.SystemData.getGateways(function(e){return"cloudservice"===e.info.sys;})[0];i&&(i.info.__neoIndex=i.index,t.forEach(function(e){e.type="cloud.trigger.device",e.gateway=i.info;}),n.forEach(function(e){e.gateway=i.info;})),xnm.aio.taskmanager.convertVxProTimespan(e);var s=[this.saveVxProSnsData.bind(this,e),xnm.aio.taskmanager.saveVxProTask.bind(this,e)];xnm.aio.taskmanager.hasCloudDevices()&&s.push(this._cloudTM.saveVxProCloudData.bind(this._cloudTM,e,t)),new xnm.aio.taskmanager.FunctionStack(s).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.deleteTask=function(e,a){var t=xnm.aio.taskmanager.isVx(e.aio)?xnm.aio.taskmanager.deleteVxTask:xnm.aio.taskmanager.deleteVxProTask,n=xnm.aio.taskmanager.isVx(e.aio)?this._cloudTM.deleteVxCloudData:this._cloudTM.deleteVxProCloudData,i=[t.bind(this,e)];xnm.aio.taskmanager.hasCloudDevices()&&i.push(n.bind(this._cloudTM,e)),xnm.aio.taskmanager.isVx(e.aio)&&i.push(this.deleteEspActions.bind(this,e)),new xnm.aio.taskmanager.FunctionStack(i).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.setTaskActive=function(e,a,t){(xnm.aio.taskmanager.isVx(e.aio)?xnm.aio.taskmanager.setVxTaskActive:xnm.aio.taskmanager.setVxProTaskActive)(e,a,t);},xnm.aio.taskmanager.Taskmanager.prototype.clear=function(e){xnm.aio.taskmanager.isVx(e)&&xnm.aio.taskmanager.getVxTasks(e,function(a,t){a||t.forEach(function(a){return xnm.aio.taskmanager.deleteVxElement(e,a);});});},xnm.aio.taskmanager.Taskmanager.prototype.getAllTasks=function(e,a){if(!Array.isArray(e)||!e.length)return a(new Error("invalid params"));var t=xnm.aio.taskmanager.isVx(e[0]),n=t?xnm.aio.taskmanager.getVxTasks:xnm.aio.taskmanager.getVxProTasks,i=[],s=0;e.forEach(function(o){return n(o,function createCallback(n){return function(o,d){if(o||!Array.isArray(d))r=o||new Error("Unknown");else{var c=t?xnm.aio.taskmanager.mapVxTasksToPro(n,d):d.map(function(e){return e.aio=n,xnm.aio.taskmanager.reconvertVxProTimespan(e),e;});i=i.concat(c);}++s===e.length&&a(r,i);};}(o));});var r=null;},xnm.aio.taskmanager.getGroups=function(e,a){e._executeRequest("getStates",{config:1},null,function(e,t){if(e)return a(e);if(!Array.isArray(t))return a(null,[]);var n=t.filter(function(e){return"SGROUP"==e.type;}).map(function(e){var a;return e.devices=(a=e,t.filter(function(e){return e.group&&e.group.includes(a.sid);}).map(function(e){return e.sid;})),e;});a(null,n);});},xnm.aio.taskmanager.Taskmanager.prototype.markGroupActions=function(e,a){xnm.aio.taskmanager.getGroups(e.aio,function(t,n){t&&a(t);var i=n.map(function(e){return e.sid;});e.root.then[0].then.forEach(function(e){e.device&&i.includes(e.device.sid)&&(e.group=n.find(function(a){return a.sid==e.device.sid;}),e.subtype="group");}),a(null,{});});},xnm.aio.taskmanager.Taskmanager.prototype.fetchDetailData=function(e,a){var t=[this.unifyStructure.bind(this,e),this.addSnsData.bind(this,e)];xnm.aio.taskmanager.isVx(e.aio)&&t.push(this.addEspActionData.bind(this,e)),xnm.aio.taskmanager.hasCloudDevices()&&t.push(this.addCloudData.bind(this,e)),xnm.aio.taskmanager.isSelve(e.aio)&&t.push(this.markGroupActions.bind(this,e)),new xnm.aio.taskmanager.FunctionStack(t).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.unifyStructure=function(e,a){var t=e.root;if(t["if"]||(t["if"]=[]),t.then||(t.then=[]),t.then[0]||(t.then[0]={"if":[],then:[],type:"condition"}),!t.then[0].then){var n=t.then;delete t.then,t.then=[{"if":[],then:n,type:"condition"}];}a(null,{});},xnm.aio.taskmanager.Taskmanager.prototype.addCloudData=function(e,a){return xnm.aio.taskmanager.isVx(e.aio)?this._cloudTM.addVxCloudData(e,a):this._cloudTM.addVxProCloudData(e,a);},xnm.aio.taskmanager.Taskmanager.prototype.addSnsData=function(e,a){var t=e.root.then[0].then,n=["EMAIL","PUSH","SMS"],i=[],getSNS=function getSNS(a,t){var n=a.isVx?"ai2/m.php":"xhub/sns/getsns",i=a.isVx?{XC_FNC:"getMessage",SID:e.aio._sid,AID:a.id}:{token:a.token};$.ajax({method:"GET",url:this._webServiceUrl+n,headers:{Authorization:this._auth},data:i,success:function success(e){a.isVx?(e=e.replace("{XC_SUC}",""),e=JSON.parse(e||"{}"),a.recipients=e.mail,"PUSH"===e.snsType&&(a.subtype="PUSH")):(a.recipients=e.recipients,a.subject=e.subject),a.message=e.message,a.snsType=e.snsType,"no such action"===a.message&&(a.failed=!0,a.message=""),t(null,e);},error:function error(e){a.failed=!0,t(null,{});}});};t.forEach(function(e){n.includes(e.subtype)&&i.push(getSNS.bind(this,e));}.bind(this)),new xnm.aio.taskmanager.FunctionStack(i).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.saveVxProSnsData=function(e,a){var t=e.root.then[0].then,n=["EMAIL","PUSH","SMS"],i=[],setSns=function setSns(e,a){var t=e.message;"string"==typeof t&&(t={subject:"",snsType:e.snsType,message:e.message,recipients:e.recipients}),$.ajax({method:"POST",url:this._webServiceUrl+"xhub/sns/setsns",contentType:"application/json; charset=utf-8",headers:{Authorization:this._auth},data:JSON.stringify(t),success:function success(t){if(t&&t.error)return a(t,null);e.isVx||(e.token=t.token),a(null,t);},error:function error(){e.failed=!0,a(null,{});}});};t.forEach(function(e){n.includes(e.subtype)&&i.push(setSns.bind(this,e));}.bind(this)),new xnm.aio.taskmanager.FunctionStack(i).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.saveVxSnsData=function(e,a,t){var setSns=function setSns(a,t){XC.debugf(a),$.ajax({method:"POST",url:this._webServiceUrl+"ai2/m.php?XC_FNC=setMessage&SID="+e.aio._sid+"&AID="+a.id,contentType:"application/x-www-form-urlencoded",headers:{Authorization:this._auth},data:{data:JSON.stringify({sns:"PUSH"===a.snsType?"PUSH":void 0,email:a.recipients,message:a.message})},success:function success(e){if(e&&e.error)return t(e,null);t();},error:function error(e){a.failed=!0,t(null,{});}});};a=a.map(function(e){return setSns.bind(this,e);}.bind(this)),new xnm.aio.taskmanager.FunctionStack(a).start(t);},xnm.aio.taskmanager.Taskmanager.prototype.addEspActionData=function(e,a){e.espActionIds=[],e.aio._executeRequest("/api/actions",null,null,function(t,n){e.root.then[0].then.filter(function(e){return e.ipDevice;}).forEach(function(a){var t=parseInt(a.code,16);e.espActionIds.push(t);var i=n[t]||{};a.ipDevEvent=!0,a.command={ref:{value:i.command,ext:i.value}},a.device={id:i.id,ipDevice:!0},"alarm"==i.command&&(a.type="action",a.subtype="audio");}),a();});},xnm.aio.taskmanager.Taskmanager.prototype.createVxEspActions=function(e,a){var _this=this;var t=[],deleteAction=function deleteAction(a,t){e.aio._executeRequest("/data/act/"+a,null,{method:"POST"},t);},n=e.espActionIds?e.espActionIds.map(function(e){return deleteAction.bind(_this,e);}):[],createAction=function createAction(a,n){var i=function(){if(!t.length)return 1;for(var e=1;e<255;e++){if(!t.includes(e))return e;}}();t.push(i),a.espId=i;var s={id:a.device.id,command:a.command.ref.value,value:a.command.ref.ext};e.aio._executeRequest("/data/act/"+i,s,{method:"POST"},n);},i=[].concat(_toConsumableArray(n),[function(a){e.aio._executeRequest("/api/actions",null,null,function(e,n){if(e||!n)return a("ESP Error");n,t=Object.keys(n).map(function(e){return parseInt(e);}),a(e,n);});}],_toConsumableArray(e.root.then[0].then.filter(function(e){return"action"===e.type&&e.device&&"aio"===e.device.sys&&e.device.mod;}).map(function(e){return createAction.bind(_this,e);})));new xnm.aio.taskmanager.FunctionStack(i).start(a);},xnm.aio.taskmanager.Taskmanager.prototype.deleteEspActions=function(e,a){var _this2=this;var deleteAction=function deleteAction(a,t){e.aio._executeRequest("/data/act/"+a,null,{method:"POST"},t);},t=e.root.then[0].then.filter(function(e){return e.ipDevice;}).map(function(e){var a=parseInt(e.code,16);return deleteAction.bind(_this2,a);});new xnm.aio.taskmanager.FunctionStack(t).start(a);},xnm.aio.taskmanager.hasCloudDevices=function(){return xnm.aio.taskmanager.SystemData.getDevices(function(e){return"cloudservice"==e.info.sys;}).length>0;},xnm.aio.taskmanager.mapVxTasksToPro=function(e,a){var t=xnm.aio.taskmanager.SystemData.getGateways(function(a){return a.info.mac==e._mac;})[0];function extractIds(e){return e.match(/.{1,2}/g);}function resolveTaskName(e,a){try{return t.tasks.find(function(e){return e.id==a;}).name;}catch(e){return"Task "+a;}}return a.filter(function(e){return"GROUP"==e.sys;}).map(function(t){var n={id:t.id,aio:e,root:{},name:resolveTaskName(0,t.id),active:1==t.active,isAlarmTask:"FF"==t.id};if(n.root["if"]=[],t.triggerids.length>0&&(n.root["if"]=extractIds(t.triggerids).map(function(e){var t={};var n=a.find(function(a){return function(e){return["EVENT","SEVENT","TASK","ASTRO"].includes(e.sys);}(a)&&a.id==e;});if(!n)return null;switch(n.sys){case"EVENT":t="IRCODE"===n.type?{type:"ir",ir:{code:n.code}}:{type:"device.status",device:{type:n.type,address:n.code},status:n.code};break;case"SEVENT":t={type:"device.status",proEvent:!0,device:{sid:n.device},status:n.condition.state,value:n.condition.value,op:n.condition.type};break;case"TASK":t={op:"=",type:"timer",time:n.time,week:n.days,start:n.dateStart,end:n.dateEnd};break;case"ASTRO":var i=parseInt(n.delay,16);(32768&i)>0&&(i-=65536),t={type:"astro",astro:1==n.time?"sunrise":"sunset",delay:i,week:n.days,start:n.dateStart,end:n.dateEnd};}return t.id=n.id,t.active=n.active,t;}).filter(function(e){return null!=e;})),n.root.then=[{"if":[],then:[]}],t.conditionids&&t.conditionids.length>0){n.root.then[0]["if"]=extractIds(t.conditionids).map(function(e){var t={};var n=a.find(function(a){return function(e){return["TIME","SEVENT"].includes(e.sys);}(a)&&a.id==e;});if(!n)return null;switch(n.sys){case"TIME":t="00:00"===n.start||"00:00"===n.end?{type:"timer",op:"00:00"===n.start?"<=":">=",time:"00:00"===n.start?n.end:n.start,week:n.days,start:n.dateStart,end:n.dateEnd}:{type:"timespan",startTime:n.start,endTime:n.end,week:n.days,start:n.dateStart,end:n.dateEnd};break;case"SEVENT":t={type:"device.status",proEvent:!0,device:{sid:n.device},status:n.condition.state,value:n.condition.value,op:n.condition.type};}return t.id=n.id,t.active=n.active,t;}).filter(function(e){return null!=e;});var i=[];n.root.then[0]["if"].forEach(function(e){i.push(e),i.push({type:"logic.operator",op:"AND"});}),i.pop(),n.root.then[0]["if"]=i;}return t.actionids.length>0&&(n.root.then[0].then=extractIds(t.actionids).map(function(e){var t={};var n=a.find(function(a){return function(e){return["ACTION","DEVICEACTION"].includes(e.sys);}(a)&&a.id==e;});if(!n)return null;switch(n.sys){case"DEVICEACTION":t={type:"action",subtype:"command",proEvent:!0,device:{sid:n.device},command:{ref:{ext:n.value,value:n.cmd}},gateway:null};break;case"ACTION":if("RGB"===n.type){t={type:"action",subtype:"command",gwRgb:!0,command:{type:"enum",ref:{value:{"0000":"ledOff","0001":"ledGreen","0002":"ledBlue","0003":"ledRed","0004":"ledYellow","0005":"ledWhite","0006":"ledPurple","0007":"ledCyan"}[n.code]}}};}else t="CLOUD"===n.type?{type:"CLOUD",internal:!0}:"AIO"===n.type?{type:"action",subtype:"EMAIL",isVx:!0}:"IP"===n.type?{type:"action",subtype:"command",ipDevice:!0,code:n.code}:{type:"action",subtype:"command",device:{type:n.type,address:n.code},command:{ref:{value:n.code}},gateway:null};}return t.id=n.id,t;}).filter(function(e){return null!=e;})),n;});},xnm.aio.taskmanager.mapProTaskToVx=function(e){var _this3=this;var a="",t="",n="",i=e.root["if"].filter(function(e){return!e.internal;}).map(function(e){var a={};switch(n+=e.id,e.type){case"device.status":a=e.device.proDevice?{sys:"SEVENT",device:e.device.sid,condition:{type:e.op,state:e.status,value:e.value}}:{sys:"EVENT",type:e.device.type,code:e.code};break;case"timer":a={sys:"TASK",days:e.week,time:e.time,dateStart:e.start||"2000-00-00",dateEnd:e.end||"2099-00-00"};break;case"ir":a={sys:"EVENT",type:"IRCODE",code:e.ir.code};break;case"astro":var t=e.delay;t<0&&(t+=65536),t=_this3.intToStrHex(t,4),a={sys:"ASTRO",active:1,days:e.week,time:"sunrise"===e.astro?1:2,dateStart:e.start,dateEnd:e.end,delay:t,t:"00:00"};}return a.id=e.id,a.active="1",a;}),s=e.root.then[0]["if"].filter(function(e){return!e.internal;}).filter(function(e){return"logic.operator"!==e.type;}).map(function(e){var a={};switch(t+=e.id,e.type){case"timer":a={sys:"TIME",days:e.week,start:"<="===e.op?"00:00":e.time,end:">="===e.op?"00:00":e.time,dateStart:e.start||"2000-00-00",dateEnd:e.end||"2099-00-00"};break;case"timespan":a={sys:"TIME",days:e.week,start:e.startTime,end:e.endTime,dateStart:e.start||"2000-00-00",dateEnd:e.end||"2099-00-00"};break;case"device.status":a={sys:"SEVENT",device:e.device.sid,condition:{type:e.op,state:e.status,value:e.value}};}return a.id=e.id,a.active="1",a;}),r=e.root.then[0].then.map(function(e){var t={};switch(a+=e.id,e.type){case"CLOUD":t={type:"CLOUD",sys:"ACTION"};break;case"action":if("EMAIL"===e.subtype||"PUSH"===e.subtype){t={code:"",type:"AIO",sys:"ACTION",snsType:e.subtype},"string"==typeof e.message?(t.message=e.message,t.recipients=e.recipients):(t.message=e.message.message,t.recipients=e.message.recipients);break;}if(e.gwRgb){t={type:"RGB",sys:"ACTION",code:{ledOn:"0005",ledOff:"0000",ledGreen:"0001",ledBlue:"0002",ledRed:"0003",ledYellow:"0004",ledWhite:"0005",ledPurple:"0006",ledCyan:"0007"}[e.command.ref.value]};break;}if(e.device.proDevice){t={sys:"DEVICEACTION",device:e.device.sid,cmd:e.command.ref.value,value:e.command.ref.ext};break;}if(e.device.ipDevice){t={sys:"ACTION",type:"IP",code:xnm.aio.taskmanager.intToStrHex(e.espId)};break;}t={sys:"ACTION",type:e.sys,code:e.command.ref.value};}return t.id=e.id,t;});return{group:{id:e.id,sys:"GROUP",actionids:a,conditionids:t,triggerids:n,active:e.active?"1":"0"},actions:r,triggers:i,conditions:s};},xnm.aio.taskmanager.convertVxProTimespan=function(e){var a=[];e.root.then[0]["if"].forEach(function(e){if("timespan"!==e.type)return a.push(e);a.push({type:"timer",op:">=",time:e.startTime,week:e.week,start:e.start,end:e.end},{type:"logic.operator",op:"AND"},{type:"timer",op:"<=",time:e.endTime,week:e.week,start:e.start,end:e.end});}),e.root.then[0]["if"]=a;},xnm.aio.taskmanager.reconvertVxProTimespan=function(e){for(var a=[],t=e.root.then[0]["if"]||e.root.then[1]["if"],n=0;n<t.length;n++){var i=t[n];if("timer"===i.type){var s=t[n+1],r=t[n+2];"timer"===i.type&&">="===i.op&&s&&r&&"AND"===s.op&&"timer"===r.type&&"<="===r.op&&i.week===r.week&&i.start===r.start&&i.end===r.end?(a.push({type:"timespan",startTime:i.time,endTime:r.time,week:i.week,start:i.start,end:i.end}),n+=2):a.push(i);}else a.push(i);}e.root.then[0]["if"]=a;},xnm.aio.taskmanager.getVxIdList=function(e,a){return e.filter(function(e){return a.includes(e.sys);}).map(function(e){return e.id;});},xnm.aio.taskmanager.getNextVxElementId=function(e){if(!e.length)return xnm.aio.taskmanager.intToStrHex(1);for(var a=1;a<255;a++){var t=xnm.aio.taskmanager.intToStrHex(a);if(!e.includes(t))return t;}return null;},xnm.aio.taskmanager.runVxTask=function(e,a){e.aio._executeRequest("doGroup",{id:e.id},null,a);},xnm.aio.taskmanager.runVxProTask=function(e,a){xnm.aio.taskmanager._callVxPro(e.aio,"doTask",{id:e.id},a);},xnm.aio.taskmanager.getVxTasks=function(e,a){e._executeRequest("GetAll",null,null,function(e,t){a(e,t);});},xnm.aio.taskmanager.getVxProTasks=function(e,a){xnm.aio.taskmanager._callVxPro(e,"GetTask",null,a);},xnm.aio.taskmanager.setVxTaskActive=function(e,a,t){a=a?1:0,e.aio._executeRequest("SaveGroup",{id:e.id,active:a},null,t);},xnm.aio.taskmanager.setVxProTaskActive=function(e,a,t){xnm.aio.taskmanager._callVxPro(e.aio,"SetTaskActive",{id:e.id,active:a},t);},xnm.aio.taskmanager.saveVxTask=function(e,a,t){var n=e.aio,i=xnm.aio.taskmanager.mapProTaskToVx(e),s=null,r={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],triggers:["TASK","ASTRO","EVENT","SEVENT"],conditions:["TIME"]},o={actions:"",triggers:"",conditions:""},d={groups:[],actions:[],triggers:[]},c={actions:[],triggers:[],conditions:[]};function delElements(e,a,t){XC.debugf("# del elements: "+e);var i=0,o=c[e],m=r[e];if(0===o.length)return t();o.forEach(function(r){var c=s.filter(function(e){return e.id==r&&m.includes(e.sys);})[0];if(!c)return t(new Error(e+" not found"));xnm.aio.taskmanager.deleteVxElement(n,c,function(e,n){if(e)return t(e);d[a].splice(d[a].indexOf(c.id),1),++i===o.length&&t();});});}function addElements(t,s,r){XC.debugf("# add elements: "+t);var c=i[t];if(!c||!c.length)return r();var m=0;c.forEach(function(i){i.id=xnm.aio.taskmanager.getNextVxElementId(d[s]),o[t]+=i.id,d[s].push(i.id),xnm.aio.taskmanager.addVxElement(n,i,function(t,n){if(t)return XC.debugf(t),r(new Error("add element failed"));"ACTION"===i.sys&&"AIO"===i.type&&a.push(i),"ACTION"===i.sys&&"CLOUD"===i.type&&(e._localCloudId=i.id),++m===c.length&&r();});}.bind(this));}var m=xnm.aio.taskmanager.hasDeleteAll(e.aio)?[function deleteAll(a){if(XC.debugf("# del all"),!e.id)return a();var t={id:e.id,options:"all"};e.alarmPin&&(t.pin=e.alarmPin),e.aio._executeRequest("DelGroup",t,null,function(t,n){if(t)return e.isAlarmTask?a({msg:"pin error"}):a(new Error("del group failed"));a();});}.bind(this)]:[delElements.bind(this,"triggers","triggers"),delElements.bind(this,"conditions","triggers"),delElements.bind(this,"actions","actions")],u=[function init(a){function extractIds(e){return e&&e.match(/.{1,2}/g)||[];}XC.debugf("# init"),xnm.aio.taskmanager.getVxTasks(n,function(t,n){if(t)return a(t);if(s=n,e.id){var i=n.filter(function(a){return"GROUP"===a.sys&&a.id==e.id;})[0];if(!i)return a(new Error("group not found"));c.actions=extractIds(i.actionids),c.conditions=extractIds(i.conditionids),c.triggers=extractIds(i.triggerids);}d.groups=xnm.aio.taskmanager.getVxIdList(n,r.groups),d.actions=xnm.aio.taskmanager.getVxIdList(n,r.actions).concat(xnm.aio.taskmanager.getVxIdList(n,r.conditions)),d.triggers=xnm.aio.taskmanager.getVxIdList(n,r.triggers),a();});}].concat(m,[addElements.bind(this,"triggers","triggers"),addElements.bind(this,"conditions","triggers"),addElements.bind(this,"actions","actions"),function saveGroup(a){var t=i.group;t.actionids=o.actions,t.triggerids=o.triggers,t.conditionids=o.conditions,t.id||(t.id=xnm.aio.taskmanager.getNextVxElementId(d.groups)),e.id=t.id;var s=xnm.aio.taskmanager.SystemData,r=s.getGateways(function(a){return a.info.mac==e.aio._mac;})[0];r.tasks||(r.tasks=[]);var c=r.tasks.find(function(a){return a.id==e.id;});c?c.name=e.name:r.tasks.push({id:e.id,name:e.name}),s.saveGateway(r),e.alarmPin&&(t.pin=e.alarmPin),n._executeRequest("AddGroup",t,null,function(t,n){if(t)return e.isAlarmTask?a({msg:"pin error"}):a(new Error("save group failed"));a();});}]);try{new xnm.aio.taskmanager.FunctionStack(u).start(t);}catch(e){XC.debugf(e);}},xnm.aio.taskmanager.saveVxProTask=function(e,a){var t={data:e};e.alarmPin&&(t.pin=e.alarmPin),xnm.aio.taskmanager._callVxPro(e.aio,e.id?"UpdateTask":"CreateTask",t,function(t,n){if(t)return a(t,n);n&&n.id&&(e.id=n.id),a(null,n);});},xnm.aio.taskmanager.addVxLocalCloudActions=function(e,a,t){var n=e.root.then[0].then;if(a.some(function(e){return e.cloud;})){if(!n.some(function(e){return"CLOUD"===e.type;})){n.push({type:"CLOUD",sys:"ACTION"});}}else e.root.then[0].then=n.filter(function(e){return"CLOUD"!==e.type;});t();},xnm.aio.taskmanager.deleteVxTask=function(e,a){if(function deleteTaskNameMapFromSysData(e){var a=xnm.aio.taskmanager.SystemData,t=a.getGateways(function(a){return a.info.mac==e.aio._mac;})[0];if(t.tasks){for(var n=t.tasks.length;n--;){t.tasks[n].id==e.id&&t.tasks.splice(n,1);}a.saveGateway(t);}}(e),xnm.aio.taskmanager.hasDeleteAll(e.aio))return e.aio._executeRequest("DelGroup",{id:e.id,options:"all"},null,a);var t=null,n={groups:["GROUP"],actions:["ACTION","DEVICEACTION"],conditions:["TIME"],triggers:["TASK","ASTRO","EVENT","SEVENT"]},i={actions:[],triggers:[],conditions:[]};function delElements(a,s,r){XC.debugf("# del elements: "+a);var o=0,d=i[a],c=n[a];if(0===d.length)return r();d.forEach(function(a){var n=t.filter(function(e){return e.id==a&&c.includes(e.sys);})[0];if(!n)return r();xnm.aio.taskmanager.deleteVxElement(e.aio,n,function(e,a){if(e)return r(e);++o===d.length&&r();});});}var s=[function init(a){function extractIds(e){return e&&e.match(/.{1,2}/g)||[];}XC.debugf("# init"),xnm.aio.taskmanager.getVxTasks(e.aio,function(n,s){if(n)return a(n);if(t=s,e.id){var r=s.filter(function(a){return"GROUP"===a.sys&&a.id==e.id;})[0];if(!r)return a(new Error("group not found"));i.actions=extractIds(r.actionids),i.conditions=extractIds(r.conditionids),i.triggers=extractIds(r.triggerids);}a();});},delElements.bind(this,"triggers","triggers"),delElements.bind(this,"conditions","triggers"),delElements.bind(this,"actions","actions"),function delGroup(a){e.aio._executeRequest("DelGroup",{id:e.id},null,a);}];new xnm.aio.taskmanager.FunctionStack(s).start(a);},xnm.aio.taskmanager.deleteVxProTask=function(e,a){xnm.aio.taskmanager._callVxPro(e.aio,"DeleteTask",{id:e.id},a);},xnm.aio.taskmanager.addVxElement=function(e,a,t){var n,i={},s={SEVENT:"SensorEvent",DEVICEACTION:"DeviceAction"};s[a.sys]?(n="Add"+s[a.sys],i.method="POST"):n="Add"+a.sys.charAt(0).toUpperCase()+a.sys.toLowerCase().slice(1),e._executeRequest(n,a,i,t);},xnm.aio.taskmanager.deleteVxElement=function(e,a,t){var n,i={SEVENT:"SensorEvent"};n=i[a.sys]?"Del"+i[a.sys]:"Del"+a.sys.charAt(0).toUpperCase()+a.sys.toLowerCase().slice(1),e._executeRequest(n,{id:a.id},null,t);},xnm.aio.taskmanager._callVxPro=function(e,a,t,n){(t=JSON.parse(JSON.stringify(t)))||(t={}),t.XC_FNC=a,t.at=e._at,t.data&&delete t.data.aio,e.executeRequestV5Plus(t,function(e){if(n)return e?e.error?n(e.error,e):void n(null,e.data):n("error",e);});},xnm.aio.taskmanager.isVx=function(e){return"EA"!==e._hwv;},xnm.aio.taskmanager.isSelve=function(e){return"E7"===e._hwv;},xnm.aio.taskmanager.hasDeleteAll=function(e){return["e7","c1","c2","c3","c4"].includes(e._hwv.toLowerCase());},xnm.aio.taskmanager.intToStrHex=function(e,a){a||(a=2);for(var t=e.toString(16);t.length<a;){t="0"+t;}return t.toUpperCase();},xnm.aio.taskmanager.FunctionStack=function(e){this._stack=e,this._onNext=function(e,a){if(e)return this._callback(e);var t=this._stack.shift();t?t(this._onNext.bind(this)):this._callback(e,a);},this.start=function(e){this._callback=e,this._onNext();};},xnm.aio.taskmanager.Handler=xnm.aio.taskmanager.Taskmanager,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.taskmanager.Handler());