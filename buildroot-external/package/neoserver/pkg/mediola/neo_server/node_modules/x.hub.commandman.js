var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.createTemplateTagFirstArg=function(k){return k.raw=k};$jscomp.createTemplateTagFirstArgWithRaw=function(k,f){k.raw=f;return k};$jscomp.arrayIteratorImpl=function(k){var f=0;return function(){return f<k.length?{done:!1,value:k[f++]}:{done:!0}}};$jscomp.arrayIterator=function(k){return{next:$jscomp.arrayIteratorImpl(k)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(k,f,e){if(k==Array.prototype||k==Object.prototype)return k;k[f]=e.value;return k};
$jscomp.getGlobal=function(k){k=["object"==typeof globalThis&&globalThis,k,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var f=0;f<k.length;++f){var e=k[f];if(e&&e.Math==Math)return e}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};
$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(k,f){var e=$jscomp.propertyToPolyfillSymbol[f];if(null==e)return k[f];e=k[e];return void 0!==e?e:k[f]};$jscomp.polyfill=function(k,f,e,c){f&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(k,f,e,c):$jscomp.polyfillUnisolated(k,f,e,c))};
$jscomp.polyfillUnisolated=function(k,f,e,c){e=$jscomp.global;k=k.split(".");for(c=0;c<k.length-1;c++){var a=k[c];if(!(a in e))return;e=e[a]}k=k[k.length-1];c=e[k];f=f(c);f!=c&&null!=f&&$jscomp.defineProperty(e,k,{configurable:!0,writable:!0,value:f})};
$jscomp.polyfillIsolated=function(k,f,e,c){var a=k.split(".");k=1===a.length;c=a[0];c=!k&&c in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var b=0;b<a.length-1;b++){var d=a[b];if(!(d in c))return;c=c[d]}a=a[a.length-1];e=$jscomp.IS_SYMBOL_NATIVE&&"es6"===e?c[a]:null;f=f(e);null!=f&&(k?$jscomp.defineProperty($jscomp.polyfills,a,{configurable:!0,writable:!0,value:f}):f!==e&&(void 0===$jscomp.propertyToPolyfillSymbol[a]&&($jscomp.propertyToPolyfillSymbol[a]=$jscomp.IS_SYMBOL_NATIVE?$jscomp.global.Symbol(a):
$jscomp.POLYFILL_PREFIX+a),$jscomp.defineProperty(c,$jscomp.propertyToPolyfillSymbol[a],{configurable:!0,writable:!0,value:f})))};$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(k){if(k)return k;var f=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};f.prototype.toString=function(){return this.$jscomp$symbol$id_};var e=0,c=function(a){if(this instanceof c)throw new TypeError("Symbol is not a constructor");return new f("jscomp_symbol_"+(a||"")+"_"+e++,a)};return c},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(k){if(k)return k;k=Symbol("Symbol.iterator");for(var f="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),e=0;e<f.length;e++){var c=$jscomp.global[f[e]];"function"===typeof c&&"function"!=typeof c.prototype[k]&&$jscomp.defineProperty(c.prototype,k,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return k},"es6",
"es3");$jscomp.iteratorPrototype=function(k){k={next:k};k[Symbol.iterator]=function(){return this};return k};$jscomp.iteratorFromArray=function(k,f){k instanceof String&&(k+="");var e=0,c=!1,a={next:function(){if(!c&&e<k.length){var b=e++;return{value:f(b,k[b]),done:!1}}c=!0;return{done:!0,value:void 0}}};a[Symbol.iterator]=function(){return a};return a};$jscomp.polyfill("Array.prototype.keys",function(k){return k?k:function(){return $jscomp.iteratorFromArray(this,function(f){return f})}},"es6","es3");
$jscomp.polyfill("Object.is",function(k){return k?k:function(f,e){return f===e?0!==f||1/f===1/e:f!==f&&e!==e}},"es6","es3");$jscomp.polyfill("Array.prototype.includes",function(k){return k?k:function(f,e){var c=this;c instanceof String&&(c=String(c));var a=c.length;e=e||0;for(0>e&&(e=Math.max(e+a,0));e<a;e++){var b=c[e];if(b===f||Object.is(b,f))return!0}return!1}},"es7","es3");
$jscomp.checkStringArgs=function(k,f,e){if(null==k)throw new TypeError("The 'this' value for String.prototype."+e+" must not be null or undefined");if(f instanceof RegExp)throw new TypeError("First argument to String.prototype."+e+" must not be a regular expression");return k+""};$jscomp.polyfill("String.prototype.includes",function(k){return k?k:function(f,e){return-1!==$jscomp.checkStringArgs(this,f,"includes").indexOf(f,e||0)}},"es6","es3");var x=x||{};x.hub=x.hub||{};
x.hub.commandman=x.hub.commandman||{};
x.hub.commandman.MacroExecutor=function(){var k=function(f,e,c){this._id=-1;this._commandHandler=f;this._callback=c;this._commands=[];this._currentCommand=0;this._canceling=!1;this._cancelCB=null;this._pause=250;if(e&&e.commands){"undefined"!=typeof e.pause&&null!==e.pause&&!isNaN(e.pause)&&0<=e.pause&&(this._pause=Math.max(Math.round(e.pause),1));this._commands=e.commands;f=[];for(e=this._commands.length-1;0<=e;e--)this._commands[e].removed||f.push(this._commands[e]);this._commands=f;window&&window.XCHost&&
window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread");this._executeNextCommand(!0)}};k.prototype.cancel=function(f){this._canceling=!0;this._cancelCB=f};k.prototype._executeNextCommand=function(f){if(this._canceling){this._canceling=!1;var e=this._cancelCB;this._cancelCB=null;f=this._callback;this._callback=null;e&&e();f&&f(Error("canceld"))}else if(this._commandHandler&&0<this._commands.length){e=this._commands.pop();var c=this;if("command"==e.classid){var a=
{cmd:e.action.ref,device:e.action.device};a.cmd||(a.cmd={value:e.action.value});a.cmd&&null!==e.action.ext&&"undefined"!=typeof e.action.ext&&(a.cmd.ext=e.action.ext);e.action.path&&(a.cmd.path=e.action.path);"http_request"==e.action.type?this._commandHandler._doHTTPRequest({url:e.action.value,method:e.action.method,headers:e.action.headers,body:e.action.body},function(){c._executeNextCommand()}):f?this._commandHandler._executeCommand(a,function(){c._executeNextCommand()}):setTimeout(function(){c._commandHandler._executeCommand(a,
function(){c._executeNextCommand()})},c._pause)}else"navigate"==e.classid?(f={type:null},1===e.history?f.type="page_next":-1===e.history?f.type="page_prev":e.page?(f.type="navigate",f.data=e.page):f.type="refresh",c._commandHandler._doAction(f),setTimeout(function(){c._executeNextCommand(!0)},c._pause)):"sleep"==e.classid&&setTimeout(function(){c._executeNextCommand(!0)},e.time)}else this._callback&&this._callback()};return k}();
x.hub.commandman.CommandHandler=function(){var k=function(f,e){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler");this._id=e;this._commandHandler=require("m.aio.commandhandler.js").CentralHandler;this._deviceManager=f;this._deviceManager||(this._deviceManager=require("./x.hub.deviceman.js").deviceManager);this._macroExecutors=[]};k.prototype.init=function(f,e){this._logger.log("info","init command manager");e&&e()};k.prototype.executeCommandWithRef=function(f,e,c,a,b){var d,
g=this._deviceManager;if(f&&e){var h=g.findDevice(f,e);if(!h){b&&b({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(c){if(d=g.findGateway(c),!d){b&&b({error:Error("gateway not found")});return}}else{b&&b({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var l=JSON.parse(JSON.stringify(h.info));l.deviceName=e}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));m.gatewayName=c;m.__neoInfo={db:this._id,index:d.index}}this.executeCommand(l,
m,a,b)};k.prototype.getStateWithRef=function(f,e,c,a,b){var d,g=this._deviceManager;if(f&&e){var h=g.findDevice(f,e);if(!h){b&&b({error:Error("device not found")});return}h.info&&h.info.gateway&&(d=g.findGatewayWithIndex(h.info.gateway))}else if(c){if(d=g.findGateway(c),!d){b&&b({error:Error("gateway not found")});return}}else{b&&b({error:Error("device/gateway reference invalid")});return}if(h&&h.info){var l=JSON.parse(JSON.stringify(h.info));l.deviceName=e}if(d&&d.info){var m=JSON.parse(JSON.stringify(d.info));
m.gatewayName=c;m.__neoInfo={db:this._id,index:d.index}}this.getState(l,m,a,b)};k.prototype.executeCommandWithIdx=function(f,e,c,a){var b,d=this._deviceManager;if(f){var g=d.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});return}g.info&&g.info.gateway&&(b=d.findGatewayWithIndex(g.info.gateway))}else if(e){if(b=d.findGatewayWithIndex(e),!b){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=
JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(b&&b.info){var l=JSON.parse(JSON.stringify(b.info));l.gatewayName=b.name;l.__neoInfo={db:this._id,index:b.index}}this.executeCommand(h,l,c,a)};k.prototype.getStateWithIdx=function(f,e,c,a,b){if(c&&Array.isArray(c))this.getStatesWithIdx(f,e,c,a,b);else{var d;b=this._deviceManager;if(f){var g=b.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});return}g.info&&g.info.gateway&&(d=b.findGatewayWithIndex(g.info.gateway))}else if(e){if(d=
b.findGatewayWithIndex(e),!d){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(d&&d.info){var l=JSON.parse(JSON.stringify(d.info));l.gatewayName=d.name;l.__neoInfo={db:this._id,index:d.index}}this.getState(h,l,c,a)}};k.prototype.getStatesWithIdx=function(f,e,c,a,b){var d;b=this._deviceManager;if(f){var g=b.findDeviceWithIndex(f);if(!g){a&&a({error:Error("device not found")});
return}g.info&&g.info.gateway&&(d=b.findGatewayWithIndex(g.info.gateway))}else if(e){if(d=b.findGatewayWithIndex(e),!d){a&&a({error:Error("gateway not found")});return}}else{a&&a({error:Error("device/gateway reference invalid")});return}if(g&&g.info){var h=JSON.parse(JSON.stringify(g.info));h.deviceName=g.name}if(d&&d.info){var l=JSON.parse(JSON.stringify(d.info));l.gatewayName=d.name;l.__neoInfo={db:this._id,index:d.index}}f=[];for(e=0;e<c.length;e++)b=c[e],b.id&&b.value&&f.push({id:b.id,device:h,
status:b});this.getMultiStatesLegacy(h,l,f,function(m){if(m.error)a&&a(m);else{var n={data:{}};m.data&&m.data.forEach(function(p){p&&p.id&&(n.data[p.id]=p.status)});a&&a(n)}})};k.prototype.executeCommand=function(f,e,c,a){if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b){if(("aio"==b||"neoserver"==b)&&c&&"cfOn"==c.value||"cfOff"==c.value){if(!e||!e.__neoInfo||!e.__neoInfo.index){a&&a({});return}if(this._deviceManager.getOwnIdx()==e.__neoInfo.index){a&&a({});return}}if((b=
require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.executeCommand){var d={};f&&(d=JSON.parse(JSON.stringify(f)));e&&(d.gateway=JSON.parse(JSON.stringify(e)));e=this._logger;var g=e.log,h=JSON,l=h.stringify;try{var m=JSON.parse(JSON.stringify(f));"undefined"!=typeof m.username&&null!=m.username&&(m.username="xxxxxx");"undefined"!=typeof m.password&&null!=m.password&&(m.password="xxxxxx");var n=m}catch(p){n=f}g.call(e,"trace","do command:"+l.call(h,n));this._logger.log("trace","command:"+
JSON.stringify(c));b.executeCommand(d,c,a)}else this.executeCommandLegacy(f,e,c,a)}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.getState=function(f,e,c,a){if(!c||Array.isArray(c))this.getStates(f,e,c,a);else if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b)if((b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.getState){var d={};f&&(d=JSON.parse(JSON.stringify(f)));
e&&(d.gateway=JSON.parse(JSON.stringify(e)));b.getState(d,c.value,function(g){a&&a(g)})}else this.getStateLegacy(f,e,c,a);else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.executeCommandLegacy=function(f,e,c,a){if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b){var d=require("m.aio.modulemanager.js").getModule(b);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;
h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.executeCommand(b,g,f,c,function(l,m){if(f&&"cam"==f.sys&&c&&"snapshot"==c.value&&!l&&m)try{require("x.hub.camman.js").saveSnapshot(f,m,function(){})}catch(n){}a&&a({error:l,data:m})}):a&&a(Error("can not generate host"))}else a&&a({error:Error("no module can handle sys:"+b)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no command")});else a&&a({error:Error("no device or gateway")})};k.prototype.getStateLegacy=
function(f,e,c,a){if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b){var d=require("m.aio.modulemanager.js").getModule(b);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(b,g,[{id:"alias",device:f,status:c}],function(l,m){l?a&&a(l):(l=null,m[0]&&(l=m[0].status),a&&a({data:{value:l}}))}):a&&a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+
b)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no status")});else a&&a({error:Error("no device or gateway")})};k.prototype.getStates=function(f,e,c,a){if(f||e){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b)if((b=require("x.hub.moduleman.js").modulemanager.getModule(b))&&b.updateStates){var d={};f&&(d=JSON.parse(JSON.stringify(f)));e&&(d.gateway=JSON.parse(JSON.stringify(e)));b.updateStates(d,function(g){a&&a(g)},c)}else this.getStatesLegacy(f,e,c,a);else a&&
a({error:Error("no sys parameter")})}else a&&a({error:Error("no device or gateway")})};k.prototype.getStatesLegacy=function(f,e,c,a){if(f||e){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b){var d=require("m.aio.modulemanager.js").getModule(b);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStatesForSingleDevice(b,g,f,c,function(l,m){l?a&&a(l):a&&a({data:m})}):a&&a({error:Error("can not generate host")})}else a&&
a({error:Error("no module can handle sys:"+b)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device or gateway")})};k.prototype.getMultiStatesLegacy=function(f,e,c,a){if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);if(b){var d=require("m.aio.modulemanager.js").getModule(b);if(d){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(b,g,c,function(l,
m){l?a&&a(l):a&&a({data:m})}):a&&a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+b)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device list")});else a&&a({error:Error("no device or gateway")})};k.prototype.execute=function(f,e,c,a,b){this._handler.execute(f,e,c,a,b)};k.prototype._executeCommand=function(f,e){f&&f.device&&f.cmd?f.device.name&&f.device.room?this.executeCommandWithRef(f.device.room,f.device.name,null,f.cmd,e):
f.device.name?this.executeCommandWithRef(null,null,f.device.name,f.cmd,e):e&&e({error:Error("cmd object has no valid device")}):e&&e({error:Error("cmd object format invalid")})};k.prototype._doAction=function(f,e){e&&e({})};k.prototype._doHTTPRequest=function(f,e){var c=null,a="GET",b=null,d=null;"string"===typeof f?c=f:(d=f.body||d,b=f.headers||b,a=f.method||a,c=f.url);f=String(c).toLowerCase();0===f.indexOf("http:")||0===f.indexOf("https:")?(c=require("url").parse(c),f="https:"==c.protocol?require("https"):
require("http"),a={host:c.hostname,method:a,path:c.path,port:c.port,protocol:c.protocol},b&&"object"===typeof b&&(a.headers=b),c.auth&&(a.auth=c.auth),b=f.request(a,function(g){e&&e()}),b.on("error",function(g){XC.debugf(g);e&&e()}),"string"===typeof d&&b.write(d),b.end()):(0<c.indexOf("://")&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:c}),e&&e())};k.prototype.executeMacro=function(f,e,c){var a=this,b=new x.hub.commandman.MacroExecutor(this,f,function(d){for(var g=
-1,h=0;h<a._macroExecutors.length;h++)if(a._macroExecutors[h]==b){g=1;break}-1!=g&&a._macroExecutors.slice(g,1);e&&e({error:d})});b._id=this._macroExecutors.length+1;this._macroExecutors.push(b);c&&c({id:b._id})};k.prototype.cancelMacro=function(f,e){for(var c=null,a=-1,b=0;b<this._macroExecutors.length;b++){var d=this._macroExecutors[b];if(d&&d._id==f){a=b;c=d;break}}c?(-1!=a&&this._macroExecutors.slice(a,1),c.cancel(function(){e&&e({})})):e&&e()};k.prototype.updateGeneralDeviceStates=function(f,
e){var c=this;f||(f=1E4);this._deviceManager.getAllGeneralDevice(function(a,b){if(a)e&&e(a);else if(b&&0!=b.length){var d={};a=[];for(var g=0;g<b.length;g++){var h=b[g];if(h._origin&&h._origin.info&&h.details&&h.details.states){var l=h._origin;l.states=h.details.states;h._origin.info.gateway?(h=h._origin.info.gateway,d[h]||(d[h]=[]),d[h].push(l)):a.push(l)}}var m=e,n={};b=Object.keys(d);var p=0,q=b.length+a.length;setTimeout(function(){m&&(m(null,n),m=null)},f);b.forEach(function(v){c._updateGeneralGatewayDeviceStates(v,
d[v],function(t,r){if(!t&&r)for(var u in r)n[u]=r[u];p++;p==q&&m&&(m(null,n),m=null)})});a.forEach(function(v){c._updateGeneralIPDeviceStats(v,function(t,r,u){!t&&u&&(n[r]=u);p++;p==q&&m&&(m(null,n),m=null)})})}else e&&e(null,{})})};k.prototype._updateGeneralGatewayDeviceStates=function(f,e,c){var a=this._deviceManager.findGatewayWithIndex(f);if(a)if(a.info){a=JSON.parse(JSON.stringify(a.info));a.__neoInfo={db:this._id,index:f};f=[];for(var b=0;b<e.length;b++){var d=e[b];if(d&&d.info&&d.states)for(var g in d.states)f.push({id:d.index+
":"+g,device:d.info,status:d.states[g]})}this._updateGeneralStates(null,a,f,function(h,l){if(h)c&&c(h);else{h={};if(l)for(var m=0;m<l.length;m++){var n=l[m];if(n.id){var p=n.id.indexOf(":");if(-1!=p){var q=parseInt(n.id.substr(0,p));if(p=n.id.substr(p+1))h[q]||(h[q]={}),h[q][p]=n.status}}}c&&c(null,h)}})}else c&&c(Error("invalid gateway json"));else c&&c(Error("no such gateway"))};k.prototype._updateGeneralStates=function(f,e,c,a){if(f||e)if(c){var b=null;e&&e.sys&&(b=e.sys);!b&&f&&f.sys&&(b=f.sys);
if(b){var d=require("x.hub.moduleman.js").modulemanager.getModule(b);if(d&&d.updateGeneralStates)b={},f&&(b=JSON.parse(JSON.stringify(f))),e&&(b.gateway=JSON.parse(JSON.stringify(e))),d.updateGeneralStates(deviceJSON,gatewayJSON,c,function(l){a&&a(l)});else if(d=require("m.aio.modulemanager.js").getModule(b)){var g;e&&(g=d.resolveGateway(e));e=null;var h=this._deviceManager;h&&(e=h.getDeviceInfo());!g&&f&&(g=d.resolveDevice(f,e));g?this._commandHandler.getStates(b,g,c,function(l,m){a&&a(l,m)}):a&&
a({error:Error("can not generate host")})}else a&&a({error:Error("no module can handle sys:"+b)})}else a&&a({error:Error("no sys parameter")})}else a&&a({error:Error("no device list")});else a&&a({error:Error("no device or gateway")})};return k}();
x.hub.commandman.CommandHandlerV6=function(){var k=require("xnm.aio.gateway.js").GatewayV6,f=function(){var c=function(a){k.call(this);this._logger="undefined"==typeof require||null==require?{log:function(){}}:require("x.logger.js").getLogger("xnm.aio.gateway.GatewayLocal");this._options=a};c.prototype=new k;c.prototype.constructor=c;c.prototype._executeRequest=function(a,b,d,g){this._executeRequestLocal(a,b,d,g)};c.prototype._executeRequestLocal=function(a,b,d,g){this._executeRequestV5(a,b,d,g)};
c.prototype._executeRequestV5=function(a,b,d,g){if("/"==a.charAt(0))var h=a;else{h="/cmd";var l=b;b={};b.XC_FNC=a;if(l)for(var m in l)"XC_FNC"!=m&&(b[m]=l[m])}m=l=a=null;var n=h,p=0,q="GET";d&&"POST"==d.method?(q="POST",b&&(this._options.command_source&&b.data&&(b.data.source=this._options.command_source),l=b,a=JSON.stringify(b),p=a.length)):b&&(this._options.command_source&&b.data&&(b.source=this._options.command_source),n=h+"?"+require("querystring").stringify(b),m=b);b={method:q,url:n,path:h,query:m?
m:{},body:a,json:l,size:p,hasValidAuth:!0};this._logger.log("trace","execute command mediola "+JSON.stringify(b));var v=this;require("x.hub.js").getServer().doRequest(h,b,function(t){v._logger.log("trace","execute command mediola return:"+JSON.stringify(t));var r=null;if(t)try{(r=JSON.parse(t))&&r.XC_SUC?g&&g(null,r.XC_SUC):r&&r.XC_ERR?g&&g(Error(t),r.XC_ERR):g&&g(Error(h+" request return invalid format"))}catch(u){g&&g(u)}else g&&g(Error(h+" request return null"))})};return c}(),e=function(c){this._logger=
require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6");this._deviceManager=c};e.prototype.executeCommandWithCommandInfo=function(c,a,b){if(c)if(c.id)this.executeDeviceCommandWithId(c.id,c,a,b?b.source:null);else if(void 0!=c.rule&&null!=c.rule)this.executeRuleCommandWithId(c.rule,c,a,b);else if(void 0!=c.group&&null!=c.group)this.executeGroupCommandWithId(c.group,c,a,b);else if(void 0!=c.device&&null!=c.device){var d=c.device.mod;d?"cloud"==d?(d=c.device,this.executeCloudCommand(d,
c,a,b?b.source:null)):this.executeDeviceCommandWithJson(c.device,c.device.gateway,c,a):(d=c.device,this.executeCommandMediola(d,c,a,b?b.source:null))}else c.command?this.executeCommandRaw(c,a):c.legacycloudaction?this.executeLegacyCloudAction(c.legacycloudaction,a,b?b.source:null):c.cloudaction?this.executeCloudAction(c.cloudaction,a,b?b.source:null):(c=Error("invalid parameter"),c.code="000005",a&&a(c));else c=Error("invalid parameter"),c.code="000005",a&&a(c)};e.prototype.executeCommandRaw=function(c,
a){if(c&&c.command){var b="GET";c.value&&(b="POST");var d=require("url").parse(c.command),g=d.pathname;d=d.query;var h={};d&&(h=require("querystring").parse(d));c={method:b,url:c.command,path:g,query:h,body:c.value?JSON.stringify(c.value):null,json:c.value,size:c.value?(new Buffer(JSON.stringify(c.value),"utf8")).length:0,hasValidAuth:!0};this._logger.log("trace","execute command raw "+JSON.stringify(c));var l=this;require("x.hub.js").getServer().doRequest(g,c,function(m){l._logger.log("trace","execute command raw return:"+
JSON.stringify(m));var n=null;if(m)try{(n=JSON.parse(m))&&n.XC_SUC?a&&a(null,n.XC_SUC):n&&n.XC_ERR?a&&a(Error(m)):a&&a(Error(g+" request return invalid format"))}catch(p){a&&a(p)}else a&&a(Error(g+" request return null"))})}else a&&a(Error("invalid command json"))};e.prototype.executeCommandMediola=function(c,a,b){if(c&&(c.id||c.sys))if(a&&(a.command||a.cmd)){var d=this._getGateway(c.gateway,a);if(d)if(c=JSON.parse(JSON.stringify(c)),c=this._convertDevice(c,a),a=this._convertCommand(c,a),c.id)d._executeRequest("SendGenericCmd",
{id:c.id,data:{cmd:a.value,value:a.ext}},{method:"POST"},function(h){b&&b(h)});else if("HM"==c.type&&"heater"==c.data&&c.address.includes(".BidCos-RF."))d._executeRequest("SendSC",{address:c.address,data:""+a.ext,type:"HM"},null,function(h){b&&b(h)});else{var g=require("xnm.aio.gateway.js").devicemanager.getSystem(c);g&&g.executeCommandCreator?g.executeCommandCreator(d,c,a,function(h){b&&b(h)}):b&&b(Error("unknown device type"))}else b&&b(Error("unknown or invalid gateway"))}else b&&b(Error("invalid command json"));
else b&&b(Error("invalid device json"))};e.prototype.executeDeviceCommandWithId=function(c,a,b,d){var g=require("x.hub.deviceman.js").deviceManagerV6,h=g.getDevice(c);if(h)if("cloud"==d&&h.restricted)a=Error("invalid parameter"),a.code="000005",b&&b(a);else{d=null;if(h.gateway&&(d=g.getGateway(h.gateway),!d)){a=Error("invalid parameter");a.code="000005";b&&b(a);return}this.executeDeviceCommandWithJson(h,d,a,function(l){l||g.setBufferedStates(c,null);b&&b(l)})}else a=Error("invalid parameter"),a.code=
"000005",b&&b(a)};e.prototype.executeDeviceCommandWithJson=function(c,a,b,d){var g=c.mod;a&&a.type&&(g=a.type);"alpha"==g&&(g="moehlenhoff");try{var h=require("x.hub.m."+g+".js");if(h&&h.executeCommandV6)h.executeCommandV6(c,a,b,function(m){m&&(m.code="000000");d&&d(m)});else{var l=Error("invalid parameter");l.code="000005";d&&d(l)}}catch(m){l=Error("invalid parameter"),l.code="000005",d&&d(l)}};e.prototype.executeRuleCommandWithId=function(c,a,b,d){if(d)if("webserver"==d.source){if(1==d.locked&&
0==d.pinMatch){a=Error("access denied (locked)");a.code="000007";b&&b(a);return}}else if("cloud"==d.source&&1==d.locked&&(0==d.pinMatch||0==d.rcs)){a=Error("access denied (locked)");a.code="000007";b&&b(a);return}c?(c=require("x.hub.rule.js").getRuleManager().getRule(c))?c.executeCommand(a,function(g){g&&!g.code&&(g.code="000005");b&&b(g)}):(a=Error("invalid parameter"),a.code="000005",b&&b(a)):(a=Error("invalid parameter"),a.code="000005",b&&b(a))};e.prototype.executeGroupCommandWithId=function(c,
a,b,d){if(c)if(a){var g=require("x.hub.group.js").getGroupManager();g.getGroup(c)?(d&&("webserver"==d.source||"cloud"==d.source)&&b&&(b(),b=null),g.executeGroupCommand(c,a,function(h){h&&!h.code&&(h.code="000005");b&&b(h)})):(c=Error("invalid parameter"),c.code="000005",b&&b(c))}else c=Error("invalid parameter"),c.code="000005",b&&b(c);else c=Error("invalid parameter"),c.code="000005",b&&b(c)};e.prototype.executeCloudCommand=function(c,a,b,d){this._logger.log("trace","execute cloud device: "+JSON.stringify(c)+
" command: "+JSON.stringify(a));d=require("x.hub.js").getServer();if(d.isCloudConnected()){var g=this,h={command:{sys:c.sys,data:c.data,command:a.command}};a.value&&(h.command.value=a.value);d._cloudConnect.sendMessageWithType(h,6,function(l){g._logger.log("trace","execute cloud device: "+JSON.stringify(c)+" command: "+JSON.stringify(a)+" "+(l?"failed: "+l.message:"success"));b&&b(l)})}else this._logger.log("trace","execute cloud command failed: cloud connection not connected"),b&&b(Error("cloud connection not connected"))};
e.prototype.executeLegacyCloudAction=function(c,a,b){this._logger.log("trace","execute legacy cloud action "+c+" from: "+b);var d=null;localStorage&&(d=localStorage.getItem("x.hub.v5.SID"));if(d){var g=parseInt(c,16);b=new Buffer(32);b.writeUInt8(Math.floor(256*Math.random()),0);var h=Math.round((new Date).getTime()/1E3);b.writeInt32BE(h,1);b.writeUInt8(1,5);b.writeUInt8(1,6);for(h=0;h<d.length/2;h++){var l=d.substr(2*h,2);l=parseInt(l,16);b.writeUInt8(l,h+7)}b=Buffer.concat([b,new Buffer(d,"hex")]);
b.writeUInt8(1,23);255<g?(b.writeUInt8(2,5),b.writeUInt8(2,23),b.writeInt16BE(g,24)):b.writeUInt8(g,24);this._logger.log("trace","execute legacy cloud action "+c+" plain buffer: "+b.toString("hex").substr(0,8)+" ...");g=require("crypto");h=new Buffer([42,115,204,166,146,83,35,244,99,130,213,30,57,56,21,227]);l=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]);d="";g=g.createCipheriv("aes-128-cbc",h,l);g.setAutoPadding(!1);d+=g.update(b,null,"hex");d+=g.final("hex");this._logger.log("trace",
"execute legacy cloud action "+c+" encrypted: "+d.substr(0,8)+" ...");b=require("x.hub.js").getServer();var m=this;b.isCloudConnected()?(this._logger.log("trace","execute legacy cloud action "+c+" via cloud connection"),b={event:{type:"LEGACYRA",data:d}},require("x.hub.js").server._cloudConnect.sendMessageActive(b,function(n){m._logger.log("trace","execute legacy cloud action "+c+" via cloud connection "+(n?"failed: "+n.message:"success"));a&&a(n)})):(this._logger.log("trace","execute legacy cloud action "+
c+" via http request"),b=b.getCloudServer(),b=require("http").request({host:b,port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},function(n){n.setEncoding("utf8");var p="";n.on("data",function(q){p+=q});n.on("end",function(){m._logger.log("trace","execute legacy cloud action "+c+" via http response:"+n.statusCode+" - "+p);var q;200!=n.statusCode&&(q=Error("http request failed with status code:"+n.statusCode));a&&(a(q),a=null)})}),b.setTimeout(5E3,
function(){m._logger.log("trace","execute legacy cloud action "+c+" via http timeout");a&&(a(Error("http timeout")),calback=null)}),b.on("error",function(n){m._logger.log("trace","execute legacy cloud action "+c+" via http failed:"+n.message);a&&(a(Error("http error: "+n.message)),calback=null)}),b.write(new Buffer(d,"hex")),b.end())}else this._logger.log("trace","execute legacy cloud action "+c+" failed: no sid"),a&&a(Error("no sid"))};e.prototype.executeCloudAction=function(c,a,b){this._logger.log("trace",
"execute cloud action "+c+" from: "+b);b=require("x.hub.js").getServer();if(b.isCloudConnected()){var d=this;b._cloudConnect.sendMessageActive({event:{type:"ACTION",data:c}},function(g){d._logger.log("trace","execute cloud action "+c+" via cloud connection "+(g?"failed: "+g.message:"success"));a&&a(g)})}else this._logger.log("trace","execute cloud action "+c+" failed: cloud connection not connected"),a&&a(Error("cloud connection not connected"))};e.prototype.getBufferedDeviceStates=function(c){var a=
require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();c&&c(null,a)};e.prototype.getDeviceStatesWithStateInfo=function(c,a,b){if(c)if(void 0!=c.id&&null!=c.id)this.getDeviceStatesWithId(c.id,a,b);else if(void 0!=c.device&&null!=c.device){var d=c.device.mod;d?"cloud"==d?(c=Error("not support get states with "+JSON.stringify(c)),c.code="000005",a&&a(c)):this.getDeviceStatesWithJson(c.device,c.device.gateway,a):this.getDeviceStatesMediola(c.device,a,b)}else void 0!=c.rule&&null!=c.rule?
this.getRuleStatesWithId(c.rule,a,b):(c=Error("invalid parameter"),c.code="000005",a&&a(c));else a&&a(Error("state info is null"))};e.prototype.getDeviceStatesMediola=function(c,a,b){if(c&&(c.id||c.sys))if(b=this._getGateway(c.gateway)){var d=this._convertDevice(c);if(d){var g=this._getSystem(d),h=this;this._logger.log("trace","get states from gateway "+JSON.stringify(c.gateway));b._executeRequest("getStates",null,null,function(l,m){if(l)a&&a(l);else{l=null;for(var n=0;n<m.length;n++){var p=m[n];
if(p){if(c.id&&p.sid==c.id&&p.state){l=p.state;break}if(g&&g._handleState&&(p=g._handleState(d,p))&&Object.keys(p)){l=p;break}}}l&&(l=h._convertStates(d,l));a&&a(null,l)}})}else a&&a(Error("invalid device"))}else a&&a(Error("unknown or invalid gateway"));else a&&a(Error("invalid device json"))};e.prototype.getDeviceStatesWithId=function(c,a,b){if(c){var d,g=require("x.hub.deviceman.js").deviceManagerV6;if(d=g.getDevice(c))if("cloud"==b&&d.restricted)d=Error("invalid parameter"),d.code="000005",a&&
a(d);else{b=null;if(d.gateway&&(b=g.getGateway(d.gateway),!b)){d=Error("invalid parameter");d.code="000005";a&&a(d);return}this.getDeviceStatesWithJson(d,b,function(h,l){!h&&l&&g.setBufferedStates(c,l);a&&a(h,l)})}else d=Error("invalid parameter"),d.code="000005",a&&a(d)}else d=Error("invalid parameter"),d.code="000005",a&&a(d)};e.prototype.getDeviceStatesWithJson=function(c,a,b){var d=c.mod;a&&a.type&&(d=a.type);"alpha"==d&&(d="moehlenhoff");try{var g=require("x.hub.m."+d+".js");if(g&&g.getStatesV6)g.getStatesV6(c,
a,function(l,m){l&&(l.code="000000");b&&b(l,m)});else{var h=Error("invalid parameter");h.code="000005";b&&b(h)}}catch(l){h=Error("invalid parameter"),h.code="000005",b&&b(h)}};e.prototype.getRuleStatesWithId=function(c,a,b){c?(b=require("x.hub.rule.js").getRuleManager().getRule(c),b||(c=Error("invalid parameter"),c.code="000005",a&&a(c)),b.getStates(function(d,g){a&&a(d,g)})):(c=Error("invalid parameter"),c.code="000005",a&&a(c))};e.prototype._getGateway=function(c,a){if(!c)return c={},a&&a.source&&
(c.command_source=a.source),new f(c);a=c;if("object"!=typeof a&&(a=require("x.hub.deviceman.js").deviceManagerV6.getGateway(a),!a))return null;a=this._convertGateway(a);return require("xnm.aio.gateway.js").resolveGateway(a)};e.prototype._convertDevice=function(c,a){var b=JSON.parse(JSON.stringify(c));b.data=b.type;"light"==b.data&&(b.data="switch");b.type=b.sys;b.sys="aio";if("IT"==b.type)b.address&&-1==b.address.indexOf(".")&&(c=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"IT"}),
c=c._resolveAddress(b.address),"object"==typeof c?(b.address=c.address,b.data="bell"):b.address=c);else if("HM"==b.type||"HMIP"==b.type){if("HMIP"==b.type||b.address&&"HMIP"==b.address.substr(0,4).toUpperCase())b._ver="v5+";"v5+"==b._ver?(b.type="HM","switch"==c.type||"light"==c.type?b.data="ip_switch":"dimmer"==c.type?b.data="ip_dimmer":"heater"==c.type?b.data="ip_heater":"shutter"==c.type?b.data="ip_blind":"blind"==c.type?b.data="ip_jalousie":"sensor"==c.type?"water"==c.subtype&&(b.data="ip_water"):
c.type||(b.data=a&&a.command?"up"==a.command||"down"==a.command||"brightness"==a.command?"ip_dimmer":"stop"==a.command||"position"==a.command?"ip_blind":"lamella"==a.command?"ip_jalousie":"temperature"==a.command||"mode"==a.command?"ip_heater":"ip_switch":"ip_switch")):"shutter"==c.type?b.data="blind":"sensor"==c.type?("illumination"==c.subtype&&(b.data="lux"),"weather"==c.subtype&&(b.data="weather_station")):c.type||(b.data=a&&a.command?"up"==a.command||"down"==a.command||"brightness"==a.command?
"dimmer":"stop"==a.command||"position"==a.command||"lamella"==a.command?"blind":"temperature"==a.command||"mode"==a.command?"heater":"switch":"switch")}else"R2"==b.type?"shutter"==c.type?b.data="blind":"blind"==c.type&&(b.data="blind"):"FS20"==b.type||"FS"==b.type?(b.type="FS20",b.address&&-1==b.address.indexOf(".")&&(c=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"FS20"}),c=c._resolveAddress(b.address),b.address=c)):"KP"==b.type||"KOPP"==b.type?b.type="KOPP":"BK"==b.type?"shutter"==
b.data&&(b.data="blind"):"DY"==b.type?"shutter"==b.data&&(b.data="blind"):"DY2"==b.type?"shutter"==b.data&&(b.data="blind"):"SL"==b.type?"shutter"==b.data&&(b.data="blind"):"RT"==b.type&&"shutter"==b.data&&(b.data="jalousie");return b};e.prototype._convertCommand=function(c,a){var b=a.command?a.command:a.cmd,d=b,g=a.value;if(c.id)return"brightness"==d?d="dimTo":"position"==d?d="moveTo":"temperature"==d?d="tempTo":"lamella"==d?d="lamellaTo":"mode"!=d||"auto"!=g&&"manu"!=g&&"boost"!=g||(d="boost"==
g?"boostOn":g,g=""),("HM"==c.type&&"v5+"==c._ver||"CL"==c.sys||"BL"==c.sys)&&"moveTo"==d&&(g=100-parseInt(g)),{value:d,ext:g};"brightness"==b&&(d="dimTo");"position"==b&&(d="moveTo");if("HM"==c.type){if("blind"==c.data||"ip_blind"==c.data||"ip_jalousie"==c.data)"up"==b?d="moveUp":"down"==b&&(d="moveDown");else if("dimmer"==c.data||"ip_dimmer"==c.data)"up"==b?d="dimUp":"down"==b&&(d="dimDown");else if("heater"==c.data||"ip_heater"==c.data)"up"==b?d="tempUp":"down"==b?d="tempDown":"mode"==b?"auto"==
a.value?d="ip_heater"==c.data?"auto":"setAuto":"manu"==a.value?d="ip_heater"==c.data?"manu":"setManu":"boost"==a.value&&(d="ip_heater"==c.data?"boostOn":"setBoost"):"boostOff"==b&&(d="boostOff");"temperature"==b?d="tempTo":"position"==b?d="moveTo":"lamella"==b&&(d="lamellaTo");"v5+"==c._ver&&"moveTo"==d&&(g=100-g)}else"FS"==c.type||"FS20"==c.type?"up"==b?"dimmer"==c.data?d="dimUp":"shutter"==c.data&&(d="moveUp"):"down"==b&&("dimmer"==c.data?d="dimDown":"shutter"==c.data&&(d="moveDown")):"KP"==c.type||
"KOPP"==c.type?"up"==b?d="on":"down"==b&&(d="off"):"CF3"==c.type||"CF4"==c.type?"brightness"==b?d="bri":"color"==b?"CF3"==c.type?d="rgb":"CF4"==c.type&&(d="rgbw"):"scene"==b&&(d="scene"+a.value):"IN"==c.type?"fan"==c.data?"up"==b?d="levelUp":"down"==b?d="levelDown":"level"==b?d="level"+a.value:"mode"==b&&("auto"==a.value?d="auto":"turbo"==a.value&&(d="turbo")):"blind"==c.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"scene"==b?d="gotoP":"position"==b&&(d="position")):"BK"==c.type?"blind"==c.data&&
("up"==b?d="moveUp3s":"down"==b?d="moveDown3s":"stepUp"==b?d="moveUp":"stepDown"==b?d="moveDown":"position"==b&&(1==a.value?d="pos1":2==a.value&&(d="pos2"))):"DY"==c.type?"blind"==c.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down")):"DY2"==c.type?"blind"==c.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down")):"ER"==c.type?"shutter"==c.data&&("up"==b?d="3sUp":"down"==b?d="3sDown":"position"==b&&("air"==a.value?d=
"doubleUp":"shadow"==a.value&&(d="doubleDown"))):"SL"==c.type?"blind"==c.data&&("up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="on":"stepDown"==b&&(d="off")):"RT"==c.type?"up"==b?d="fullUp":"down"==b?d="fullDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down"):"WA"==c.type?"up"==b?d="moveUp":"down"==b?d="moveDown":"stepUp"==b?d="up":"stepDown"==b&&(d="down"):"WR"==c.type?"up"==b?d="moveUp":"down"==b&&(d="moveDown"):"CL"==c.type?"moveTo"==d&&(g=100-g):"BL"==c.type&&"moveTo"==d&&(g=100-g);return{value:d,
ext:g}};e.prototype._convertGateway=function(c){c=JSON.parse(JSON.stringify(c));c.sys="aio";c.ip=c.address;c.username=c.user;c.password=c.pwd;c.version="ca";1==c.legacy&&(c.version="e1");return c};e.prototype._getSystem=function(c){return require("xnm.aio.gateway.js").devicemanager.getSystem(c)};e.prototype.resolveDeviceStates=function(c,a){var b=a.value,d=a.source;a=a.type;var g=null,h=!1;if(c.id&&c.id==b.id)g=b.state;else if(c.device){if(c.device.gateway){if("ST"==d)return null;if("object"==typeof c.device.gateway){if(c.device.gateway.address!=
d)return null}else{var l=this._deviceManager.getGateway(c.device.gateway);if(!l||l.address!=d)return null}}d=this._convertDevice(c.device);if(c.device.id&&b.sid==c.device.id&&(h=!0,g=b.state,b.changed)){l={};for(var m in g)-1!=b.changed.indexOf(m)&&(l[m]=g[m]);g=l}if(!h&&c.device.address){if(!d)return null;c=this._getSystem(d);if(!c)return null;"state"==a?c._handleState&&(g=c._handleState(d,b)):c._handleUdpState&&(g=c._handleUdpState(d,b))}g&&(g=this._convertStates(d,g))}return g?g:null};e.prototype._convertStates=
function(c,a){a=JSON.parse(JSON.stringify(a));"IW"==c.type?(a.state=a.windowState,delete a.windowState):"IT"==c.type?a.windowState?(a.state=a.windowState,delete a.windowState):a.doorState&&(a.state=a.doorState,delete a.doorState):"HM"==c.type&&("v5+"==c._ver?"undefined"!=typeof a.blindLevel&&null!=a.blindLevel&&(a.position=100-parseInt(a.blindLevel)):("undefined"!=typeof a.blindState&&null!=a.blindState&&(a.position=a.blindState),"lux"==c.data?a.illumination=a.state:"blind"==c.data?a.position=a.blindState:
"weather_station"==c.data&&(a.temperature=a.temp,delete a.temp,a.humidity=a.hum,delete a.hum,a.speed=a.winS,delete a.winS,a.direction=a.winD,delete a.winD,a.rain="on"==a.rain)));return a};e.prototype.matchDeviceState=function(c,a){if(!c||!a)return!1;var b=a.value;b||(b="state");var d=a.states,g="==";!d&&a.comp&&(a.comp.operator&&(g=a.comp.operator),void 0!=a.comp.value&&null!=a.comp.value&&(d=[a.comp.value]));if(!d)return!1;a=c[b];if(void 0==a||null==a)return!1;c=!1;switch(g){case "==":c="true"==
a||1==a?-1!=d.indexOf("true")||-1!=d.indexOf(!0):"false"==a||0==a?-1!=d.indexOf("false")||-1!=d.indexOf(!1):-1!=d.indexOf(a);break;case "!=":c="true"==a||1==a?-1==d.indexOf("true")||-1==d.indexOf(!0):"false"==a||0==a?-1==d.indexOf("false")||-1==d.indexOf(!1):-1==d.indexOf(a);break;case ">=":c=parseFloat(a)>=parseFloat(d[0]);break;case ">":c=parseFloat(a)>parseFloat(d[0]);break;case "<=":c=parseFloat(a)<=parseFloat(d[0]);break;case "<":c=parseFloat(a)<parseFloat(d[0])}return c};return e}();
x.hub.commandman.Handler=function(){var k=function(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1);this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2);this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6(require("./x.hub.deviceman.js").deviceManagerV6)};k.prototype.CommandHandler=x.hub.commandman.CommandHandler;k.prototype.CommandHandlerV6=x.hub.commandman.CommandHandlerV6;k.prototype.init=
function(f,e){"CA"==global.HARDWARE_VERSION?this._config(f):this._configOld(f);this.commandHandler.init(e)};k.prototype._config=function(f){var e=this;f=require("x.hub.js").getServer();f.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(c,a){(c=c.json)?e.commandHandler.executeCommand(c.device,c.gateway,c.command,function(b){a.json(e._toRestfulResponse(b.error,"ok"))}):a.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/xhub/commandman/getState",
{method:"POST"},function(c,a){(c=c.json)?e.commandHandler.getState(c.device,c.gateway,c.status,function(b){a.json(e._toRestfulResponse(b.error,b.data))}):a.json(e._toRestfulResponse({code:"000001",message:"invalid argument"}))});f.addRoute("/api/command",function(c,a){var b=c.json;b||"GET"!=c.method||(b=c.query);e.commandHandlerV6.executeCommandWithCommandInfo(b,function(d){d?a.json({XC_ERR:{code:d.code,msg:d.message}}):a.json({XC_SUC:{}})},c)});f.addRoute("/api/state",function(c,a){var b=c.json;
b||"GET"!=c.method||(b=c.query);e.commandHandlerV6.getDeviceStatesWithStateInfo(b,function(d,g){d?a.json({XC_ERR:{code:d.code,msg:d.message}}):a.json({XC_SUC:g})},c.source)});f.addRoute("/api/states",function(c,a){e.commandHandlerV6.getBufferedDeviceStates(function(b,d){b?a.json({XC_ERR:{code:b.code,msg:b.message}}):a.json({XC_SUC:d})})})};k.prototype._configOld=function(f){var e=require("body-parser");f.use("/xhub/commandman",e.json({limit:"50mb"}));f.post("/xhub/commandman/executeCommand",function(a,
b){this.commandHandler.executeCommand(a.body.device,a.body.gateway,a.body.command,function(d){b.json(this._toRestfulResponse(d.error,"ok"))}.bind(this))}.bind(this));f.post("/xhub/commandman/getState",function(a,b){this.commandHandler.getState(a.body.device,a.body.gateway,a.body.status,function(d){b.json(this._toRestfulResponse(d.error,d.data))}.bind(this))}.bind(this));var c=this;f=require("x.hub.js").getServer();f.addRoute("/api/command",function(a,b){c.commandHandlerV6.executeCommandWithCommandInfo(a.query,
function(d){d?b.json({XC_ERR:{code:d.code,msg:d.message}}):b.json({XC_SUC:{}})},a.source)});f.addRoute("/api/state",function(a,b){c.commandHandlerV6.getDeviceStatesWithId(a.query?a.query.id:null,function(d,g){d?b.json({XC_ERR:{code:d.code,msg:d.message}}):b.json({XC_SUC:g})},a.source)});f.addRoute("/api/states",function(a,b){c.commandHandlerV6.getBufferedDeviceStates(function(d,g){d?b.json({XC_ERR:{code:d.code,msg:d.message}}):b.json({XC_SUC:g})})})};k.prototype._toRestfulResponse=function(f,e){return f?
{status:"fail",message:f.message,code:f.code?f.code:0}:{status:"success",data:e}};return k}();module.exports=new x.hub.commandman.Handler;
