function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest();}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}function _iterableToArrayLimit(arr,i){var _i=arr==null?null:typeof Symbol!=="undefined"&&arr[Symbol.iterator]||arr["@@iterator"];if(_i==null)return;var _arr=[];var _n=true;var _d=false;var _s,_e;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"]!=null)_i["return"]();}finally{if(_d)throw _e;}}return _arr;}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr;}function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]};},e:function e(_e3){throw _e3;},f:F};}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o);},n:function n(){var step=it.next();normalCompletion=step.done;return step;},e:function e(_e4){didErr=true;err=_e4;},f:function f(){try{if(!normalCompletion&&it["return"]!=null)it["return"]();}finally{if(didErr)throw err;}}};}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen);}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i];}return arr2;}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var x=x||{};x.hub=x.hub||{},x.hub.commandman=x.hub.commandman||{},x.hub.commandman.MacroExecutor=function(){var AIOMacro=function AIOMacro(e,t,r){if(this._id=-1,this._commandHandler=e,this._callback=r,this._commands=[],this._currentCommand=0,this._canceling=!1,this._cancelCB=null,this._pause=250,t&&t.commands){void 0!==t.pause&&null!==t.pause&&!isNaN(t.pause)&&t.pause>=0&&(this._pause=Math.max(Math.round(t.pause),1)),this._commands=t.commands;for(var a=[],o=this._commands.length-1;o>=0;o--){this._commands[o].removed||a.push(this._commands[o]);}this._commands=a,window&&window.XCHost&&window.XCHost.getType&&"iOS"==window.XCHost.getType()&&XC.callHost("SYSTEM","startBGThread"),this._executeNextCommand(!0);}};return AIOMacro.prototype.cancel=function(e){this._canceling=!0,this._cancelCB=e;},AIOMacro.prototype._executeNextCommand=function(e){if(this._canceling){this._canceling=!1;var t=this._cancelCB;this._cancelCB=null;var r=this._callback;return this._callback=null,t&&t(),void(r&&r(new Error("canceld")));}if(this._commandHandler&&this._commands.length>0){var a=this._commands.pop(),o=this;if("command"==a.classid){var n={cmd:a.action.ref,device:a.action.device};n.cmd||(n.cmd={value:a.action.value}),n.cmd&&null!==a.action.ext&&void 0!==a.action.ext&&(n.cmd.ext=a.action.ext),a.action.path&&(n.cmd.path=a.action.path),"http_request"==a.action.type?this._commandHandler._doHTTPRequest({url:a.action.value,method:a.action.method,headers:a.action.headers,body:a.action.body},function(){o._executeNextCommand();}):e?this._commandHandler._executeCommand(n,function(){o._executeNextCommand();}):setTimeout(function(){o._commandHandler._executeCommand(n,function(){o._executeNextCommand();});},o._pause);}else if("navigate"==a.classid){var i={type:null};1===a.history?i.type="page_next":-1===a.history?i.type="page_prev":a.page?(i.type="navigate",i.data=a.page):i.type="refresh",o._commandHandler._doAction(i),setTimeout(function(){o._executeNextCommand(!0);},o._pause);}else"sleep"==a.classid&&setTimeout(function(){o._executeNextCommand(!0);},a.time);}else this._callback&&this._callback();},AIOMacro;}(),x.hub.commandman.CommandHandler=function(){var CH=function CH(e,t){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandler"),this._id=t,this._commandHandler=require("m.aio.commandhandler.js").CentralHandler,this._deviceManager=e,this._deviceManager||(this._deviceManager=require("./x.hub.deviceman.js").deviceManager),this._macroExecutors=[];};return CH.prototype.init=function(e,t){this._logger.log("info","init command manager"),t&&t();},CH.prototype.executeCommandWithRef=function(e,t,r,a,o){var n,i,s,d,c=this._deviceManager;if(e&&t){if(!(n=c.findDevice(e,t)))return void(o&&o({error:new Error("device not found")}));n.info&&n.info.gateway&&(i=c.findGatewayWithIndex(n.info.gateway));}else{if(!r)return void(o&&o({error:new Error("device/gateway reference invalid")}));if(!(i=c.findGateway(r)))return void(o&&o({error:new Error("gateway not found")}));}n&&n.info&&((s=JSON.parse(JSON.stringify(n.info))).deviceName=t),i&&i.info&&((d=JSON.parse(JSON.stringify(i.info))).gatewayName=r,d.__neoInfo={db:this._id,index:i.index}),this.executeCommand(s,d,a,o);},CH.prototype.getStateWithRef=function(e,t,r,a,o){var n,i,s,d,c=this._deviceManager;if(e&&t){if(!(n=c.findDevice(e,t)))return void(o&&o({error:new Error("device not found")}));n.info&&n.info.gateway&&(i=c.findGatewayWithIndex(n.info.gateway));}else{if(!r)return void(o&&o({error:new Error("device/gateway reference invalid")}));if(!(i=c.findGateway(r)))return void(o&&o({error:new Error("gateway not found")}));}n&&n.info&&((s=JSON.parse(JSON.stringify(n.info))).deviceName=t),i&&i.info&&((d=JSON.parse(JSON.stringify(i.info))).gatewayName=r,d.__neoInfo={db:this._id,index:i.index}),this.getState(s,d,a,o);},CH.prototype.executeCommandWithIdx=function(e,t,r,a){var o,n,i,s,d=this._deviceManager;if(e){if(!(o=d.findDeviceWithIndex(e)))return void(a&&a({error:new Error("device not found")}));o.info&&o.info.gateway&&(n=d.findGatewayWithIndex(o.info.gateway));}else{if(!t)return void(a&&a({error:new Error("device/gateway reference invalid")}));if(!(n=d.findGatewayWithIndex(t)))return void(a&&a({error:new Error("gateway not found")}));}o&&o.info&&((i=JSON.parse(JSON.stringify(o.info))).deviceName=o.name),n&&n.info&&((s=JSON.parse(JSON.stringify(n.info))).gatewayName=n.name,s.__neoInfo={db:this._id,index:n.index}),this.executeCommand(i,s,r,a);},CH.prototype.getStateWithIdx=function(e,t,r,a,o){if(r&&Array.isArray(r))this.getStatesWithIdx(e,t,r,a,o);else{var n,i,s,d;o=this._deviceManager;if(e){if(!(n=o.findDeviceWithIndex(e)))return void(a&&a({error:new Error("device not found")}));n.info&&n.info.gateway&&(i=o.findGatewayWithIndex(n.info.gateway));}else{if(!t)return void(a&&a({error:new Error("device/gateway reference invalid")}));if(!(i=o.findGatewayWithIndex(t)))return void(a&&a({error:new Error("gateway not found")}));}n&&n.info&&((s=JSON.parse(JSON.stringify(n.info))).deviceName=n.name),i&&i.info&&((d=JSON.parse(JSON.stringify(i.info))).gatewayName=i.name,d.__neoInfo={db:this._id,index:i.index}),this.getState(s,d,r,a);}},CH.prototype.getStatesWithIdx=function(e,t,r,a,o){var n,i,s,d;o=this._deviceManager;if(e){if(!(n=o.findDeviceWithIndex(e)))return void(a&&a({error:new Error("device not found")}));n.info&&n.info.gateway&&(i=o.findGatewayWithIndex(n.info.gateway));}else{if(!t)return void(a&&a({error:new Error("device/gateway reference invalid")}));if(!(i=o.findGatewayWithIndex(t)))return void(a&&a({error:new Error("gateway not found")}));}n&&n.info&&((s=JSON.parse(JSON.stringify(n.info))).deviceName=n.name),i&&i.info&&((d=JSON.parse(JSON.stringify(i.info))).gatewayName=i.name,d.__neoInfo={db:this._id,index:i.index});for(var c=[],u=0;u<r.length;u++){var l=r[u];if(l.id&&l.value){var m={id:l.id,device:s,status:l};c.push(m);}}this.getMultiStatesLegacy(s,d,c,function(e){if(e.error)a&&a(e);else{var t={data:{}};e.data&&e.data.forEach(function(e){e&&e.id&&(t.data[e.id]=e.status);}),a&&a(t);}});},CH.prototype.executeCommand=function(e,t,r,a){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){if(("aio"==o||"neoserver"==o)&&r&&"cfOn"==r.value||"cfOff"==r.value){if(!t||!t.__neoInfo||!t.__neoInfo.index)return void(a&&a({}));if(this._deviceManager.getOwnIdx()==t.__neoInfo.index)return void(a&&a({}));}var n=require("x.hub.moduleman.js").modulemanager.getModule(o);if(n&&n.executeCommand){var i={};e&&(i=JSON.parse(JSON.stringify(e))),t&&(i.gateway=JSON.parse(JSON.stringify(t))),this._logger.log("trace","do command:"+JSON.stringify(function(e){try{var t=JSON.parse(JSON.stringify(e));return void 0!==t.username&&null!=t.username&&(t.username="xxxxxx"),void 0!==t.password&&null!=t.password&&(t.password="xxxxxx"),t;}catch(t){return e;}}(e))),this._logger.log("trace","command:"+JSON.stringify(r)),n.executeCommand(i,r,a);}else this.executeCommandLegacy(e,t,r,a);}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no command")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.getState=function(e,t,r,a){if(r&&!Array.isArray(r)){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("x.hub.moduleman.js").modulemanager.getModule(o);if(n&&n.getState){var i={};e&&(i=JSON.parse(JSON.stringify(e))),t&&(i.gateway=JSON.parse(JSON.stringify(t))),n.getState(i,r.value,function(e){a&&a(e);});}else this.getStateLegacy(e,t,r,a);}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no command")});}else a&&a({error:new Error("no device or gateway")});}else this.getStates(e,t,r,a);},CH.prototype.executeCommandLegacy=function(e,t,r,a){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("m.aio.modulemanager.js").getModule(o);if(n){var i;t&&(i=n.resolveGateway(t));var s=null,d=this._deviceManager;d&&(s=d.getDeviceInfo()),!i&&e&&(i=n.resolveDevice(e,s)),i?this._commandHandler.executeCommand(o,i,e,r,function(t,o){if(e&&"cam"==e.sys&&r&&"snapshot"==r.value&&!t&&o)try{require("x.hub.camman.js").saveSnapshot(e,o,function(){});}catch(e){}a&&a({error:t,data:o});}):a&&a(new Error("can not generate host"));}else a&&a({error:new Error("no module can handle sys:"+o)});}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no command")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.getStateLegacy=function(e,t,r,a){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("m.aio.modulemanager.js").getModule(o);if(n){var i;t&&(i=n.resolveGateway(t));var s=null,d=this._deviceManager;if(d&&(s=d.getDeviceInfo()),!i&&e&&(i=n.resolveDevice(e,s)),i){var c=[{id:"alias",device:e,status:r}];this._commandHandler.getStates(o,i,c,function(e,t){if(e)a&&a(e);else{var r=null;t[0]&&(r=t[0].status),a&&a({data:{value:r}});}});}else a&&a({error:new Error("can not generate host")});}else a&&a({error:new Error("no module can handle sys:"+o)});}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no status")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.getStates=function(e,t,r,a){if(e||t){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("x.hub.moduleman.js").modulemanager.getModule(o);if(n&&n.updateStates){var i={};return e&&(i=JSON.parse(JSON.stringify(e))),t&&(i.gateway=JSON.parse(JSON.stringify(t))),void n.updateStates(i,function(e){a&&a(e);},r);}this.getStatesLegacy(e,t,r,a);}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.getStatesLegacy=function(e,t,r,a){if(e||t){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("m.aio.modulemanager.js").getModule(o);if(n){var i;t&&(i=n.resolveGateway(t));var s=null,d=this._deviceManager;if(d&&(s=d.getDeviceInfo()),!i&&e&&(i=n.resolveDevice(e,s)),i){var c=r;this._commandHandler.getStatesForSingleDevice(o,i,e,c,function(e,t){e?a&&a(e):a&&a({data:t});});}else a&&a({error:new Error("can not generate host")});}else a&&a({error:new Error("no module can handle sys:"+o)});}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.getMultiStatesLegacy=function(e,t,r,a){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n=require("m.aio.modulemanager.js").getModule(o);if(n){var i;t&&(i=n.resolveGateway(t));var s=null,d=this._deviceManager;d&&(s=d.getDeviceInfo()),!i&&e&&(i=n.resolveDevice(e,s)),i?this._commandHandler.getStates(o,i,r,function(e,t){e?a&&a(e):a&&a({data:t});}):a&&a({error:new Error("can not generate host")});}else a&&a({error:new Error("no module can handle sys:"+o)});}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no device list")});}else a&&a({error:new Error("no device or gateway")});},CH.prototype.execute=function(e,t,r,a,o){this._handler.execute(e,t,r,a,o);},CH.prototype._executeCommand=function(e,t){e&&e.device&&e.cmd?e.device.name&&e.device.room?this.executeCommandWithRef(e.device.room,e.device.name,null,e.cmd,t):e.device.name?this.executeCommandWithRef(null,null,e.device.name,e.cmd,t):t&&t({error:new Error("cmd object has no valid device")}):t&&t({error:new Error("cmd object format invalid")});},CH.prototype._doAction=function(e,t){t&&t({});},CH.prototype._doHTTPRequest=function(e,t){var r=null,a="GET",o=null,n=null;"string"==typeof e?r=e:(n=e.body||n,o=e.headers||o,a=e.method||a,r=e.url);var i=String(r).toLowerCase();if(0===i.indexOf("http:")||0===i.indexOf("https:")){var s=require("url").parse(r),d="https:"==s.protocol?require("https"):require("http"),c={host:s.hostname,method:a,path:s.path,port:s.port,protocol:s.protocol};o&&"object"==_typeof(o)&&(c.headers=o),s.auth&&(c.auth=s.auth);var u=d.request(c,function(e){t&&t();});u.on("error",function(e){XC.debugf(e),t&&t();}),"string"==typeof n&&u.write(n),u.end();}else r.indexOf("://")>0&&window.XC&&window.XC.callHost&&window.XC.callHost("SYSTEM","startApp",{scheme:r}),t&&t();},CH.prototype.executeMacro=function(e,t,r){var a=this,o=new x.hub.commandman.MacroExecutor(this,e,function(e){for(var r=-1,n=0;n<a._macroExecutors.length;n++){if(a._macroExecutors[n]==o){r=1;break;}}-1!=r&&a._macroExecutors.slice(r,1),t&&t({error:e});});o._id=this._macroExecutors.length+1,this._macroExecutors.push(o),r&&r({id:o._id});},CH.prototype.cancelMacro=function(e,t){for(var r=null,a=-1,o=0;o<this._macroExecutors.length;o++){var n=this._macroExecutors[o];if(n&&n._id==e){a=o,r=n;break;}}r?(-1!=a&&this._macroExecutors.slice(a,1),r.cancel(function(){t&&t({});})):t&&t();},CH.prototype.updateGeneralDeviceStates=function(e,t){var r=this;e||(e=1e4),this._deviceManager.getAllGeneralDevice(function(a,o){if(a)t&&t(a);else if(o&&0!=o.length){for(var n={},i=[],s=0;s<o.length;s++){var d=o[s];if(d._origin&&d._origin.info&&d.details&&d.details.states){var c=d._origin;if(c.states=d.details.states,d._origin.info.gateway){var u=d._origin.info.gateway;n[u]||(n[u]=[]),n[u].push(c);}else i.push(c);}}var l=t,m={},f=Object.keys(n),v=0,g=f.length+i.length;setTimeout(function(){l&&(l(null,m),l=null);},e),f.forEach(function(e){r._updateGeneralGatewayDeviceStates(e,n[e],function(e,t){if(!e&&t)for(var r in t){m[r]=t[r];}++v==g&&l&&(l(null,m),l=null);});}),i.forEach(function(e){r._updateGeneralIPDeviceStats(e,function(e,t,r){!e&&r&&(m[t]=r),++v==g&&l&&(l(null,m),l=null);});});}else t&&t(null,{});});},CH.prototype._updateGeneralGatewayDeviceStates=function(e,t,r){var a=this._deviceManager.findGatewayWithIndex(e);if(a){if(a.info){var o=JSON.parse(JSON.stringify(a.info));o.__neoInfo={db:this._id,index:e};for(var n=[],i=0;i<t.length;i++){var s=t[i];if(s&&s.info&&s.states)for(var d in s.states){var c={id:s.index+":"+d,device:s.info,status:s.states[d]};n.push(c);}}this._updateGeneralStates(null,o,n,function(e,t){if(e)r&&r(e);else{var a={};if(t)for(var o=0;o<t.length;o++){var n=t[o];if(n.id){var i=n.id.indexOf(":");if(-1!=i){var s=parseInt(n.id.substr(0,i)),d=n.id.substr(i+1);d&&(a[s]||(a[s]={}),a[s][d]=n.status);}}}r&&r(null,a);}});}else r&&r(new Error("invalid gateway json"));}else r&&r(new Error("no such gateway"));},CH.prototype._updateGeneralStates=function(e,t,r,a){if(e||t){if(r){var o=null;if(t&&t.sys&&(o=t.sys),!o&&e&&e.sys&&(o=e.sys),o){var n;if((n=require("x.hub.moduleman.js").modulemanager.getModule(o))&&n.updateGeneralStates){var i={};return e&&(i=JSON.parse(JSON.stringify(e))),t&&(i.gateway=JSON.parse(JSON.stringify(t))),void n.updateGeneralStates(deviceJSON,gatewayJSON,r,function(e){a&&a(e);});}if(n=require("m.aio.modulemanager.js").getModule(o)){var s;t&&(s=n.resolveGateway(t));var d=null,c=this._deviceManager;c&&(d=c.getDeviceInfo()),!s&&e&&(s=n.resolveDevice(e,d)),s?this._commandHandler.getStates(o,s,r,function(e,t){a&&a(e,t);}):a&&a({error:new Error("can not generate host")});}else a&&a({error:new Error("no module can handle sys:"+o)});}else a&&a({error:new Error("no sys parameter")});}else a&&a({error:new Error("no device list")});}else a&&a({error:new Error("no device or gateway")});},CH;}(),x.hub.commandman.CommandHandlerV6=function(){var e,t=require("xnm.aio.gateway.js").GatewayV6,r=(((e=function e(_e){t.call(this),"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.gateway.GatewayLocal"),this._options=_e;}).prototype=new t()).constructor=e,e.prototype._executeRequest=function(e,t,r,a){this._executeRequestLocal(e,t,r,a);},e.prototype._executeRequestLocal=function(e,t,r,a){this._executeRequestV5(e,t,r,a);},e.prototype._executeRequestV5=function(e,t,r,a){var o;if("/"==e.charAt(0))o=e;else{o="/cmd";var n=t;if((t={}).XC_FNC=e,n)for(var i in n){"XC_FNC"!=i&&(t[i]=n[i]);}}var s=null,d=null,c=null,u=o,l=0,m="GET";r&&"POST"==r.method?(m="POST",t&&(this._options.command_source&&t.data&&(t.data.source=this._options.command_source),d=t,l=(s=JSON.stringify(t)).length)):t&&(this._options.command_source&&t.data&&(t.source=this._options.command_source),u=o+"?"+require("querystring").stringify(t),c=t);var f={method:m,url:u,path:o,query:c||{},body:s,json:d,size:l,hasValidAuth:!0};this._logger.log("trace","execute command mediola "+JSON.stringify(f));var v=this;require("x.hub.js").getServer().doRequest(o,f,function(e){v._logger.log("trace","execute command mediola return:"+JSON.stringify(e));var t=null;if(e)try{(t=JSON.parse(e))&&t.XC_SUC?a&&a(null,t.XC_SUC):t&&t.XC_ERR?a&&a(new Error(e),t.XC_ERR):a&&a(new Error(o+" request return invalid format"));}catch(e){a&&a(e);}else a&&a(new Error(o+" request return null"));});},e),CH=function CH(e){this._logger=require("x.logger.js").getLogger("x.hub.commandman.CommandHandlerV6"),this._deviceManager=e;};return CH.prototype.executeCommandWithCommandInfo=function(e,t,r){var a;if(!e)return(a=new Error("invalid parameter")).code="000005",void(t&&t(a));if(e.device&&e.device.restricted&&r&&("webserver"==r.source||"cloud"==r.source))return(a=new Error("restricted")).code="000005",void(t&&t(a));if(e.id){var o=e.id,n=e;this.executeDeviceCommandWithId(o,n,t,r?r.source:null);}else if(null!=e.rule&&null!=e.rule){var i=e.rule;n=e;this.executeRuleCommandWithId(i,n,t,r);}else if(null!=e.group&&null!=e.group){var s=e.group;n=e;this.executeGroupCommandWithId(s,n,t,r);}else if(null!=e.device&&null!=e.device){var d=e.device.mod;if(d){if("cloud"==d){c=e.device,n=e;this.executeCloudCommand(c,n,t,r?r.source:null);}else this.executeDeviceCommandWithJson(e.device,e.device.gateway,e,t);}else{var c=e.device,n=e;this.executeCommandMediola(c,n,t,r?r.source:null);}}else e.command?this.executeCommandRaw(e,t):e.legacycloudaction?this.executeLegacyCloudAction(e.legacycloudaction,t,r?r.source:null):e.cloudaction?this.executeCloudAction(e.cloudaction,t,r?r.source:null):((a=new Error("unsupported command")).code="000005",t&&t(a));},CH.prototype.executeCommandRaw=function(e,t){if(e&&e.command){var r="GET";e.value&&(r="POST");var a=require("url").parse(e.command),o=a.pathname,n=a.query,i={};n&&(i=require("querystring").parse(n));var s={method:r,url:e.command,path:o,query:i,body:e.value?JSON.stringify(e.value):null,json:e.value,size:e.value?new Buffer(JSON.stringify(e.value),"utf8").length:0,hasValidAuth:!0};if(this._logger.log("trace","execute command raw "+JSON.stringify(s)),e.gateway){var d=this._getGateway(e.gateway,null);if(!d)return void t(new Error("can not find the corresponding gw "+e.gateway));if(!e||!e.command)return void(t&&t(new Error("invalid command json")));try{if(e.value)var c=e.value.XC_FNC,u=e.value;else{var l=e.command.indexOf("/"),m=e.command.indexOf("?");c=e.command.slice(l,m),u=this._getParamsFromStringCommand(e.command);}d._executeRequest(c,u,{method:r},function(e){t&&t(e);});}catch(e){t&&t(e.message);}}else{var f=this;require("x.hub.js").getServer().doRequest(o,s,function(e){f._logger.log("trace","execute command raw return:"+JSON.stringify(e));var r=null;if(e)try{(r=JSON.parse(e))&&r.XC_SUC?t&&t(null,r.XC_SUC):r&&r.XC_ERR?t&&t(new Error(e)):t&&t(new Error(o+" request return invalid format"));}catch(e){t&&t(e);}else t&&t(new Error(o+" request return null"));});}}else t&&t(new Error("invalid command json"));},CH.prototype._getParamsFromStringCommand=function(e){var t=(e=e.replace("/cmd?","")).split("&"),r={};var _iterator=_createForOfIteratorHelper(t),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var a=_step.value;var o=a.split("="),n=o[0],i=o[1];r[n]=i;}}catch(err){_iterator.e(err);}finally{_iterator.f();}return r;},CH.prototype.executeCommandMediola=function(e,t,r){var a=this;if(e&&(e.id||e.sys)){if(t&&(t.command||t.cmd)){var o=this._getGateway(e.gateway,t);if(o){e=JSON.parse(JSON.stringify(e));var n=this._convertDevice(e,t),i=this._convertCommand(n,t);if(n.id)o._executeRequest("SendGenericCmd",{id:n.id,data:{cmd:i.value,value:i.ext}},{method:"POST"},function(e){r&&r(e);});else if("HM"==n.type&&"heater"==n.data&&n.address.includes(".BidCos-RF."))o._executeRequest("SendSC",{address:n.address,data:"".concat(i.ext),type:"HM"},null,function(e){r&&r(e);});else{var s=require("xnm.aio.gateway.js").devicemanager.getSystem(n);s&&s.executeCommandCreator?s.executeCommandCreator(o,n,i,function(e){e&&a._logger.log("error","error in executeCommandCreator for \n                ".concat(JSON.stringify(n)," - ").concat(JSON.stringify(i))),r&&r(e);}):r&&r(new Error("unknown device type"));}}else r&&r(new Error("unknown or invalid gateway"));}else r&&r(new Error("invalid command json"));}else r&&r(new Error("invalid device json"));},CH.prototype.executeDeviceCommandWithId=function(e,t,r,a){var o,n=require("x.hub.deviceman.js").deviceManagerV6,i=n.getDevice(e);if(!i)return(o=new Error("invalid parameter")).code="000005",this._logger.log("error","can not find device with id ".concat(e," ")),void(r&&r(o));if("cloud"==a&&i.restricted)return(o=new Error("invalid parameter")).code="000005",this._logger.log("error","access from cloud is restricted for ".concat(e)),void(r&&r(o));var s=null;if(i.gateway&&!(s=n.getGateway(i.gateway)))return(o=new Error("invalid parameter")).code="000005",this._logger.log("error","can not find gateway info for ".concat(e," - gw :").concat(i.gateway)),void(r&&r(o));this.executeDeviceCommandWithJson(i,s,t,function(t){t||n.setBufferedStates(e,null),r&&r(t);});},CH.prototype.executeDeviceCommandWithJson=function(e,t,r,a){var o,n=e.mod;if(t&&t.type&&(n=t.type),"alpha"==n&&(n="moehlenhoff"),!n)return this._logger.log("warn","mod is null and we assume it is IR device"),void this.executeCommandMediola(e,r,function(e){e&&(e.code="000000"),a&&a(e);});try{var i=require("x.hub.m."+n+".js");if(!i||!i.executeCommandV6)return(o=new Error("invalid parameter")).code="000005",void(a&&a(o));i.executeCommandV6(e,t,r,function(e){e&&(e.code="000000"),a&&a(e);});}catch(e){(o=new Error("invalid parameter")).code="000005",a&&a(o);}},CH.prototype.executeRuleCommandWithId=function(e,t,r,a){var o;if(a)if("webserver"==a.source){if(1==a.locked&&0==a.pinMatch)return(o=new Error("access denied (locked)")).code="000007",void(r&&r(o));}else if("cloud"==a.source&&1==a.locked&&(0==a.pinMatch||0==a.rcs))return(o=new Error("access denied (locked)")).code="000007",void(r&&r(o));if(!e)return(o=new Error("invalid parameter")).code="000005",void(r&&r(o));var n=require("x.hub.rule.js").getRuleManager().getRule(e);if(!n)return(o=new Error("invalid parameter")).code="000005",void(r&&r(o));var i=n.getType();if(i&&"alarm"==i&&"cloud"==a.source&&!a.rcs)return(o=new Error("alarms can not be changed over cloud when is not in relaxed mode")).code="000008",void(r&&r(o));n.executeCommand(t,function(e){e&&!e.code&&(e.code="000005"),r&&r(e);});},CH.prototype.executeGroupCommandWithId=function(e,t,r,a){var o;if(!e)return(o=new Error("invalid parameter")).code="000005",void(r&&r(o));if(!t)return(o=new Error("invalid parameter")).code="000005",void(r&&r(o));var n=require("x.hub.group.js").getGroupManager();if(!n.getGroup(e))return(o=new Error("invalid parameter")).code="000005",void(r&&r(o));n.executeGroupCommand(e,t,function(e){e&&!e.code&&(e.code="000005"),r&&r(e);},a);},CH.prototype.executeCloudCommand=function(e,t,r,a){this._logger.log("trace","execute cloud device: "+JSON.stringify(e)+" command: "+JSON.stringify(t));var o=require("x.hub.js").getServer();if(!o.isCloudConnected())return this._logger.log("trace","execute cloud command failed: cloud connection not connected"),void(r&&r(new Error("cloud connection not connected")));var n=this,i={command:{sys:e.sys,data:e.data,command:t.command}};t.value&&(i.command.value=t.value),o._cloudConnect.sendMessageWithType(i,6,function(a){n._logger.log("trace","execute cloud device: "+JSON.stringify(e)+" command: "+JSON.stringify(t)+" "+(a?"failed: "+a.message:"success")),r&&r(a);});},CH.prototype.executeLegacyCloudAction=function(e,t,r){this._logger.log("trace","execute legacy cloud action "+e+" from: "+r);var a=null;if(localStorage&&(a=localStorage.getItem("x.hub.v5.SID")),!a)return this._logger.log("trace","execute legacy cloud action "+e+" failed: no sid"),void(t&&t(new Error("no sid")));var o=parseInt(e,16),n=new Buffer(32),i=Math.floor(256*Math.random());n.writeUInt8(i,0);var s=Math.round(new Date().getTime()/1e3);n.writeInt32BE(s,1),n.writeUInt8(1,5),n.writeUInt8(1,6);for(var d=0;d<a.length/2;d++){var c=a.substr(2*d,2);c=parseInt(c,16),n.writeUInt8(c,d+7);}(n=Buffer.concat([n,new Buffer(a,"hex")])).writeUInt8(1,23),o>255?(n.writeUInt8(2,5),n.writeUInt8(2,23),n.writeInt16BE(o,24)):n.writeUInt8(o,24),this._logger.log("trace","execute legacy cloud action "+e+" plain buffer: "+n.toString("hex").substr(0,8)+" ...");var u=require("crypto"),l=new Buffer([42,115,204,166,146,83,35,244,99,130,213,30,57,56,21,227]),m=new Buffer([118,76,69,24,233,5,91,82,57,245,163,255,98,147,114,52]),f="",v=u.createCipheriv("aes-128-cbc",l,m);v.setAutoPadding(!1),f+=v.update(n,null,"hex"),f+=v["final"]("hex"),this._logger.log("trace","execute legacy cloud action "+e+" encrypted: "+f.substr(0,8)+" ...");var g=require("x.hub.js").getServer(),p=g.isCloudConnected(),h=this;if(p){this._logger.log("trace","execute legacy cloud action "+e+" via cloud connection");var y={event:{type:"LEGACYRA",data:f}};require("x.hub.js").server._cloudConnect.sendMessageActive(y,function(r){h._logger.log("trace","execute legacy cloud action "+e+" via cloud connection "+(r?"failed: "+r.message:"success")),t&&t(r);});}else{this._logger.log("trace","execute legacy cloud action "+e+" via http request");var w={host:g.getCloudServer(),port:8888,path:"/legacy/ra",method:"POST",headers:{"Content-Type":"application/octet-stream",Connection:"close"}},_=require("http").request(w,function(r){r.setEncoding("utf8");var a="";r.on("data",function(e){a+=e;}),r.on("end",function(){var o;h._logger.log("trace","execute legacy cloud action "+e+" via http response:"+r.statusCode+" - "+a),200==r.statusCode||(o=new Error("http request failed with status code:"+r.statusCode)),t&&(t(o),t=null);});});_.setTimeout(5e3,function(){h._logger.log("trace","execute legacy cloud action "+e+" via http timeout"),t&&(t(new Error("http timeout")),calback=null);}),_.on("error",function(r){h._logger.log("trace","execute legacy cloud action "+e+" via http failed:"+r.message),t&&(t(new Error("http error: "+r.message)),calback=null);}),_.write(new Buffer(f,"hex")),_.end();}},CH.prototype.executeCloudAction=function(e,t,r){this._logger.log("trace","execute cloud action "+e+" from: "+r);var a=require("x.hub.js").getServer();if(!a.isCloudConnected())return this._logger.log("trace","execute cloud action "+e+" failed: cloud connection not connected"),void(t&&t(new Error("cloud connection not connected")));var o=this,n={event:{type:"ACTION",data:e}};a._cloudConnect.sendMessageActive(n,function(r){o._logger.log("trace","execute cloud action "+e+" via cloud connection "+(r?"failed: "+r.message:"success")),t&&t(r);});},CH.prototype.getBufferedDeviceStates=function(e){var t=require("x.hub.deviceman.js").deviceManagerV6.getAllBufferedStates();e&&e(null,t);},CH.prototype.getDeviceStatesWithStateInfo=function(e,t,r){if(e){if(null!=e.id&&null!=e.id)this.getDeviceStatesWithId(e.id,t,r);else if(null!=e.device&&null!=e.device){var a=e.device.mod;if(a){if("cloud"==a){(n=new Error("not support get states with "+JSON.stringify(e))).code="000005",t&&t(n);}else this.getDeviceStatesWithJson(e.device,e.device.gateway,t);}else{var o=e.device;this.getDeviceStatesMediola(o,t,r);}}else if(null!=e.rule&&null!=e.rule)this.getRuleStatesWithId(e.rule,t,r);else if(null!=e.rules&&null!=e.rules&&e.rules.length)this.getRulesStates(e.rules,t,r);else{var n;(n=new Error("invalid parameter")).code="000005",t&&t(n);}}else t&&t(new Error("state info is null"));},CH.prototype.getDeviceStatesMediola=function(e,t,r){if(e&&(e.id||e.sys)){var a=this._getGateway(e.gateway);if(a){var o=this._convertDevice(e);if(o){var n=this._getSystem(o),i=this;this._logger.log("trace","get states from gateway "+JSON.stringify(e.gateway)),a._executeRequest("getStates",null,null,function(r,a){if(r)t&&t(r);else{for(var s=null,d=0;d<a.length;d++){var c=a[d];if(c){if(e.id&&c.sid==e.id&&c.state){s=c.state;break;}if(!n||!n._handleState)continue;var u=n._handleState(o,c);if(u&&Object.keys(u)){s=u;break;}}}s&&(s=i._convertStates(o,s)),t&&t(null,s);}});}else t&&t(new Error("invalid device"));}else t&&t(new Error("unknown or invalid gateway"));}else t&&t(new Error("invalid device json"));},CH.prototype.getDeviceStatesWithId=function(e,t,r){if(!e)return(a=new Error("invalid parameter")).code="000005",void(t&&t(a));var a,o=require("x.hub.deviceman.js").deviceManagerV6,n=o.getDevice(e);if(!n)return(a=new Error("invalid parameter")).code="000005",this._logger.log("error","can not find device with id ".concat(e," ")),void(t&&t(a));if("cloud"==r&&n.restricted)return(a=new Error("invalid parameter")).code="000005",this._logger.log("error","access from cloud is restricted for ".concat(e)),void(t&&t(a));var i=null;if(n.gateway&&!(i=o.getGateway(n.gateway)))return(a=new Error("invalid parameter")).code="000005",this._logger.log("error","can not find gateway info for ".concat(e," - gw :").concat(n.gateway)),void(t&&t(a));this.getDeviceStatesWithJson(n,i,function(r,a){!r&&a&&o.setBufferedStates(e,a),t&&t(r,a);});},CH.prototype.getDeviceStatesWithJson=function(e,t,r){var a,o=e.mod;t&&t.type&&(o=t.type),"alpha"==o&&(o="moehlenhoff");try{var n=require("x.hub.m."+o+".js");if(!n||!n.getStatesV6)return(a=new Error("invalid parameter")).code="000005",this._logger.log("error","can not find the module for ".concat(o)),void(r&&r(a));n.getStatesV6(e,t,function(e,t){e&&(e.code="000000"),r&&r(e,t);});}catch(e){(a=new Error("invalid parameter")).code="000005",this._logger.log("error",e.stack?e.stack:e),r&&r(a);}},CH.prototype.getRuleStatesWithId=function(e,t,r){if(!e)return(a=new Error("invalid parameter")).code="000005",void(t&&t(a));var a,o=require("x.hub.rule.js").getRuleManager();e=e.toString();var n=o.getRule(e);n||((a=new Error("invalid parameter")).code="000005",t&&t(a));var i=require("x.hub.js").getServer().getRCS();if(r&&"cloud"==r&&!i&&"alarm"==n.getType())return(a=new Error("restricted, alarm state is available only when rcs is set")).code="000009",void(t&&t(a));n.getStates(function(e,r){t&&t(e,r);});},CH.prototype.getRulesStates=function(e,t,r){var a,o=require("x.hub.rule.js").getRuleManager(),n=require("x.hub.js").getServer().getRCS(),i=o.getRules();i||((a=new Error("no rules")).code="000005",t&&t(a)),e=e.map(function(e){return e.toString();});var s={};for(var _i=0,_Object$entries=Object.entries(i);_i<_Object$entries.length;_i++){var _Object$entries$_i=_slicedToArray(_Object$entries[_i],2),_t=_Object$entries$_i[0],_r=_Object$entries$_i[1];e.includes(_t)&&(s[_t]=_r);}if(r&&"cloud"==r&&!n)for(var _i2=0,_Object$entries2=Object.entries(s);_i2<_Object$entries2.length;_i2++){var _Object$entries2$_i=_slicedToArray(_Object$entries2[_i2],2),_e2=_Object$entries2$_i[0],_t2=_Object$entries2$_i[1];"alarm"==_t2.getType()&&delete s[_e2];}var d={};for(var c in s){s[c].getStates(function(e,t){d[c]=t;});}t&&t(a,d);},CH.prototype._getGateway=function(e,t){if(!e){var a={};return t&&t.source&&(a.command_source=t.source),new r(a);}var o=e;if("object"!=_typeof(o)&&!(o=require("x.hub.deviceman.js").deviceManagerV6.getGateway(o)))return null;var n=this._convertGateway(o);return require("xnm.aio.gateway.js").resolveGateway(n);},CH.prototype._convertDevice=function(e,t){var r=JSON.parse(JSON.stringify(e));if(r.data=r.type,"light"==r.data&&(r.data="switch"),r.type=r.sys,r.sys="aio","IT"==r.type)r.address&&-1==r.address.indexOf(".")&&("object"==_typeof(a=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"IT"})._resolveAddress(r.address))?(r.address=a.address,r.data="bell"):r.address=a);else if("HM"==r.type||"HMIP"==r.type)("HMIP"==r.type||r.address&&"HMIP"==r.address.substr(0,4).toUpperCase())&&(r._ver="v5+"),"v5+"==r._ver?(r.type="HM","switch"==e.type||"light"==e.type?r.data="ip_switch":"dimmer"==e.type?r.data="ip_dimmer":"heater"==e.type?r.data="ip_heater":"shutter"==e.type?r.data="ip_blind":"blind"==e.type?r.data="ip_jalousie":"sensor"==e.type?"water"==e.subtype&&(r.data="ip_water"):e.type||(t&&t.command?"up"==t.command||"down"==t.command||"brightness"==t.command?r.data="ip_dimmer":"stop"==t.command||"position"==t.command?r.data="ip_blind":"lamella"==t.command?r.data="ip_jalousie":"temperature"==t.command||"mode"==t.command?r.data="ip_heater":r.data="ip_switch":r.data="ip_switch")):"shutter"==e.type?r.data="blind":"sensor"==e.type?("illumination"==e.subtype&&(r.data="lux"),"weather"==e.subtype&&(r.data="weather_station")):e.type||(t&&t.command?"up"==t.command||"down"==t.command||"brightness"==t.command?r.data="dimmer":"stop"==t.command||"position"==t.command||"lamella"==t.command?r.data="blind":"temperature"==t.command||"mode"==t.command?r.data="heater":r.data="switch":r.data="switch");else if("R2"==r.type)("shutter"==e.type||"blind"==e.type)&&(r.data="blind");else if("FS20"==r.type||"FS"==r.type){if(r.type="FS20",r.address&&-1==r.address.indexOf(".")){var a=require("xnm.aio.gateway.js").devicemanager.getSystem({type:"FS20"})._resolveAddress(r.address);r.address=a;}}else if("KP"==r.type||"KOPP"==r.type)r.type="KOPP";else if("BK"==r.type)"shutter"==r.data&&(r.data="blind");else if("DY"==r.type)"shutter"==r.data&&(r.data="blind");else if("DY2"==r.type)"shutter"==r.data&&(r.data="blind");else if("SL"==r.type)"shutter"==r.data&&(r.data="blind");else if("RT"==r.type)"shutter"==r.data&&(r.data="jalousie");else if("CODE"==r.type){if(r.codes)r.ircodes={codes:[]},Object.entries(r.codes).forEach(function(_ref){var _ref2=_slicedToArray(_ref,2),e=_ref2[0],t=_ref2[1];r.ircodes.codes.push({key:e,code:t});});}return r;},CH.prototype._convertCommand=function(e,t){var r=t.command?t.command:t.cmd,a=r,o=t.value;return e.id?("brightness"==a?a="dimTo":"position"==a?a="moveTo":"temperature"==a?a="tempTo":"lamella"==a?a="lamellaTo":"mode"!=a||"auto"!=o&&"manu"!=o&&"boost"!=o||(a="boost"==o?"boostOn":o,o=""),("HM"==e.type&&"v5+"==e._ver||"CL"==e.sys||"BL"==e.sys)&&"moveTo"==a&&(o=100-parseInt(o)),{value:a,ext:o}):("brightness"==r&&(a="dimTo"),"position"==r&&(a="moveTo"),"HM"==e.type?("blind"==e.data||"ip_blind"==e.data||"ip_jalousie"==e.data?"up"==r?a="moveUp":"down"==r&&(a="moveDown"):"dimmer"==e.data||"ip_dimmer"==e.data?"up"==r?a="dimUp":"down"==r&&(a="dimDown"):"heater"!=e.data&&"ip_heater"!=e.data||("up"==r?a="tempUp":"down"==r?a="tempDown":"mode"==r?"auto"==t.value?a="ip_heater"==e.data?"auto":"setAuto":"manu"==t.value?a="ip_heater"==e.data?"manu":"setManu":"boost"==t.value&&(a="ip_heater"==e.data?"boostOn":"setBoost"):"boostOff"==r&&(a="boostOff")),"temperature"==r?a="tempTo":"position"==r?a="moveTo":"lamella"==r&&(a="lamellaTo"),"v5+"==e._ver&&"moveTo"==a&&(o=100-o)):"FS"==e.type||"FS20"==e.type?"up"==r?"dimmer"==e.data?a="dimUp":"shutter"==e.data&&(a="moveUp"):"down"==r&&("dimmer"==e.data?a="dimDown":"shutter"==e.data&&(a="moveDown")):"KP"==e.type||"KOPP"==e.type?"up"==r?a="on":"down"==r&&(a="off"):"CF3"==e.type||"CF4"==e.type?"brightness"==r?a="bri":"color"==r?"CF3"==e.type?a="rgb":"CF4"==e.type&&(a="rgbw"):"scene"==r&&(a="scene"+t.value):"IN"==e.type?"fan"==e.data?"up"==r?a="levelUp":"down"==r?a="levelDown":"level"==r?a="level"+t.value:"mode"==r&&("auto"==t.value?a="auto":"turbo"==t.value&&(a="turbo")):"blind"==e.data&&("up"==r?a="moveUp":"down"==r?a="moveDown":"scene"==r?a="gotoP":"position"==r&&(a="position")):"BK"==e.type?"blind"==e.data&&("up"==r?a="moveUp3s":"down"==r?a="moveDown3s":"stepUp"==r?a="moveUp":"stepDown"==r?a="moveDown":"position"==r&&(1==t.value?a="pos1":2==t.value&&(a="pos2"))):"DY"==e.type||"DY2"==e.type?"blind"==e.data&&("up"==r?a="moveUp":"down"==r?a="moveDown":"stepUp"==r?a="up":"stepDown"==r&&(a="down")):"ER"==e.type?"shutter"==e.data&&("up"==r?a="3sUp":"down"==r?a="3sDown":"position"==r&&("air"==t.value?a="doubleUp":"shadow"==t.value&&(a="doubleDown"))):"SL"==e.type?"blind"==e.data&&("up"==r?a="moveUp":"down"==r?a="moveDown":"stepUp"==r?a="on":"stepDown"==r&&(a="off")):"RT"==e.type?"up"==r?a="fullUp":"down"==r?a="fullDown":"stepUp"==r?a="up":"stepDown"==r&&(a="down"):"WA"==e.type?"up"==r?a="moveUp":"down"==r?a="moveDown":"stepUp"==r?a="up":"stepDown"==r&&(a="down"):"WR"==e.type?"up"==r?a="moveUp":"down"==r&&(a="moveDown"):"CL"==e.type?"moveTo"==a&&(o=100-o):"BL"==e.type&&"moveTo"==a&&(o=100-o),{value:a,ext:o});},CH.prototype._convertGateway=function(e){var t=JSON.parse(JSON.stringify(e));return t.sys="aio",t.ip=t.address,t.username=t.user,t.password=t.pwd,t.version="ca",1==t.legacy&&(t.version="e1"),t;},CH.prototype._getSystem=function(e){return require("xnm.aio.gateway.js").devicemanager.getSystem(e);},CH.prototype.resolveDeviceStates=function(e,t){var r=t.value,a=t.source,o=t.type,n=null,i=!1;if(e.id&&e.id==r.id)i=!0,n=r.state;else if(e.device){if(e.device.gateway){if("ST"==a)return null;if("object"==_typeof(e.device.gateway)){if(e.device.gateway.address!=a)return null;}else{var s=this._deviceManager.getGateway(e.device.gateway);if(!s)return null;if(s.address!=a)return null;}}var d=this._convertDevice(e.device);if(e.device.id&&r.sid==e.device.id&&(i=!0,n=r.state,r.changed)){var c={};for(var u in n){-1!=r.changed.indexOf(u)&&(c[u]=n[u]);}n=c;}if(!i&&e.device.address){if(!d)return null;var l=this._getSystem(d);if(!l)return null;"state"==o?l._handleState&&(n=l._handleState(d,r)):l._handleUdpState&&(n=l._handleUdpState(d,r));}n&&(n=this._convertStates(d,n));}return n||null;},CH.prototype._convertStates=function(e,t){var r=JSON.parse(JSON.stringify(t));return"IW"==e.type?(r.state=r.windowState,delete r.windowState):"IT"==e.type?r.windowState?(r.state=r.windowState,delete r.windowState):r.doorState&&(r.state=r.doorState,delete r.doorState):"HM"==e.type&&("v5+"==e._ver?void 0!==r.blindLevel&&null!=r.blindLevel&&(r.position=100-parseInt(r.blindLevel)):(void 0!==r.blindState&&null!=r.blindState&&(r.position=r.blindState),"lux"==e.data?r.illumination=r.state:"blind"==e.data?r.position=r.blindState:"weather_station"==e.data&&(r.temperature=r.temp,delete r.temp,r.humidity=r.hum,delete r.hum,r.speed=r.winS,delete r.winS,r.direction=r.winD,delete r.winD,r.rain="on"==r.rain))),r;},CH.prototype.matchDeviceState=function(e,t){if(!e)return!1;if(!t)return!1;var r=t.value;r||(r="state");var a=!1,o=t.states,n="==";if(o||t.comp&&(t.comp.operator&&(n=t.comp.operator),null!=t.comp.value&&null!=t.comp.value&&(o=[t.comp.value])),!o)return!1;var i=e[r];if(null==i||null==i)return!1;a=!1;switch(n){case"==":a="true"==i||1==i?-1!=o.indexOf("true")||-1!=o.indexOf(!0):"false"==i||0==i?-1!=o.indexOf("false")||-1!=o.indexOf(!1):-1!=o.indexOf(i);break;case"!=":a="true"==i||1==i?-1==o.indexOf("true")||-1==o.indexOf(!0):"false"==i||0==i?-1==o.indexOf("false")||-1==o.indexOf(!1):-1==o.indexOf(i);break;case">=":a=parseFloat(i)>=parseFloat(o[0]);break;case">":a=parseFloat(i)>parseFloat(o[0]);break;case"<=":a=parseFloat(i)<=parseFloat(o[0]);break;case"<":a=parseFloat(i)<parseFloat(o[0]);}return a;},CH;}(),x.hub.commandman.Handler=function(){var Handler=function Handler(){this.commandHandler=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager,1),this.commandHandler2=new x.hub.commandman.CommandHandler(require("./x.hub.deviceman.js").deviceManager2,2),this.commandHandlerV6=new x.hub.commandman.CommandHandlerV6(require("./x.hub.deviceman.js").deviceManagerV6);};return Handler.prototype.CommandHandler=x.hub.commandman.CommandHandler,Handler.prototype.CommandHandlerV6=x.hub.commandman.CommandHandlerV6,Handler.prototype.init=function(e,t){"CA"==global.HARDWARE_VERSION?this._config(e):this._configOld(e),this.commandHandler.init(t);},Handler.prototype._config=function(e){var t=this,r=require("x.hub.js").getServer();r.addRoute("/xhub/commandman/executeCommand",{method:"POST"},function(e,r){var a=e.json;a?t.commandHandler.executeCommand(a.device,a.gateway,a.command,function(e){r.json(t._toRestfulResponse(e.error,"ok"));}):r.json(t._toRestfulResponse({code:"000001",message:"invalid argument"}));}),r.addRoute("/xhub/commandman/getState",{method:"POST"},function(e,r){var a=e.json;a?t.commandHandler.getState(a.device,a.gateway,a.status,function(e){r.json(t._toRestfulResponse(e.error,e.data));}):r.json(t._toRestfulResponse({code:"000001",message:"invalid argument"}));}),r.addRoute("/api/command",{lock:function lock(e,t,r){return r._auth.checkLockWithRCS(e,t,r);}},function(e,r){var a=e.json;a||"GET"!=e.method||(a=e.query),"cloud"!=e.source||e.rcs?t.commandHandlerV6.executeCommandWithCommandInfo(a,function(e){e?r.json({XC_ERR:{code:e.code,msg:e.message}}):r.json({XC_SUC:{}});},e):r.json({XC_ERR:{code:"000008",msg:"only accessible when rcs set"}});}),r.addRoute("/api/state",function(e,r){var a=e.json;a||"GET"!=e.method||(a=e.query),t.commandHandlerV6.getDeviceStatesWithStateInfo(a,function(e,t){e?r.json({XC_ERR:{code:e.code,msg:e.message}}):r.json({XC_SUC:t});},e.source);}),r.addRoute("/api/states",function(e,r){t.commandHandlerV6.getBufferedDeviceStates(function(e,t){e?r.json({XC_ERR:{code:e.code,msg:e.message}}):r.json({XC_SUC:t});});});},Handler.prototype._configOld=function(e){var t=require("body-parser");e.use("/xhub/commandman",t.json({limit:"50mb"})),e.post("/xhub/commandman/executeCommand",function(e,t){this.commandHandler.executeCommand(e.body.device,e.body.gateway,e.body.command,function(e){t.json(this._toRestfulResponse(e.error,"ok"));}.bind(this));}.bind(this)),e.post("/xhub/commandman/getState",function(e,t){this.commandHandler.getState(e.body.device,e.body.gateway,e.body.status,function(e){t.json(this._toRestfulResponse(e.error,e.data));}.bind(this));}.bind(this));var r=this,a=require("x.hub.js").getServer();a.addRoute("/api/command",function(e,t){var a=e.query;r.commandHandlerV6.executeCommandWithCommandInfo(a,function(e){e?t.json({XC_ERR:{code:e.code,msg:e.message}}):t.json({XC_SUC:{}});},e.source);}),a.addRoute("/api/state",function(e,t){var a=e.query?e.query.id:null;r.commandHandlerV6.getDeviceStatesWithId(a,function(e,r){e?t.json({XC_ERR:{code:e.code,msg:e.message}}):t.json({XC_SUC:r});},e.source);}),a.addRoute("/api/states",function(e,t){r.commandHandlerV6.getBufferedDeviceStates(function(e,r){e?t.json({XC_ERR:{code:e.code,msg:e.message}}):t.json({XC_SUC:r});});});},Handler.prototype._toRestfulResponse=function(e,t){return e?{status:"fail",message:e.message,code:e.code?e.code:0}:{status:"success",data:t};},Handler;}(),module.exports=new x.hub.commandman.Handler();