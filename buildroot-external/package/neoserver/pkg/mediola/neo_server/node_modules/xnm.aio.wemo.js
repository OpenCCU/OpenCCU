var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.wemo=xnm.aio.wemo||{},xnm.aio.wemo.Switch=function(){var Switch=function Switch(t,e,n,i){this.ip=t,this.port=e,this.uuid=n,this.type="switch",i&&(this.type=i),this.CommandHandler=null;};return Switch.prototype.switchTo=function(t,e){var n=new(require("x.upnp.js").Device)(),i=this;n.init(this.ip,this.port,this.uuid),n._doSOAPRequest(n.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","SetBinaryState",{BinaryState:t},function(t){if(t)e&&e(t);else{var n=0;"insight"==i.type&&(n=1e3),e&&setTimeout(e,n);}});},Switch.prototype._getBinaryState=function(t){var e=new(require("x.upnp.js").Device)();e.init(this.ip,this.port,this.uuid),e._doSOAPRequest(e.getURL("/upnp/control/basicevent1"),"urn:Belkin:service:basicevent:1","GetBinaryState",{BinaryState:1},function(e,n){var i=null;if(n){var o=n.find("BinaryState");o.length>0&&(0==(i=parseInt($(o[0]).text()))?i="off":null!=i&&(i="on"));}t&&t(i);});},Switch.prototype._getInsightState=function(t){var e=new(require("x.upnp.js").Device)();e.init(this.ip,this.port,this.uuid),e._doSOAPRequest(e.getURL("/upnp/control/insight1"),"urn:Belkin:service:insight:1","GetInsightParams",null,function(e,n){var i=null;if(n){var o=n.find("InsightParams");if(o.length>0){var r=$(o[0]).text().split("|");11==r.length&&(i=(parseInt(r[7])/1e3).toFixed(1));}}t&&t(i);});},Switch.prototype.getState=function(t){var e=null,n=this;this._getBinaryState(function(i){i&&i?(e={state:i},"insight"==n.type?n._getInsightState(function(n){n&&(e.current=n),t&&t(e);}):t&&t(e)):t&&t(null);});},Switch.prototype.executeCommand=function(t,e,n){if("on"==e)this.switchTo(1,n);else if("off"==e)this.switchTo(0,n);else if("toggle"==e){var i=this;this._getBinaryState(function(t){"off"==t?i.switchTo(1,n):i.switchTo(0,n);});}else n&&n();},Switch.prototype.getStates=function(t,e,n){var i=this;this.CommandHandler=t,this.getState(function(t){t&&e&&i.CommandHandler.setState?(i.CommandHandler.setState(e.id,t.state),t&&t.current&&i.CommandHandler.setState(e.id+":current",t.current)):t&&i.CommandHandler.receivedState&&i.CommandHandler.receivedState("wemo",i.ip+":"+i.port,t),n&&n(t);});},Switch.prototype.getStateValues=function(t,e){return e;},Switch.prototype.executeCommandCreator=function(t,e,n){e&&e.value?this.executeCommand(t,e.value,function(t){n&&n(t);}):n&&n(new Error("command value is empty"));},Switch.prototype.getStatesCreator=function(t,e,n){this.getState(function(t){if(t){for(var i=[],o=0;o<e.length;o++){var r=e[o];if(r&&r.id&&r.status)switch(r.status.value){case"switchState":t.state&&i.push({id:r.id,status:t.state});break;case"powerState":t.current&&i.push({id:r.id,status:parseFloat(t.current)});}}n&&n(null,i);}else n&&n(new Error("get state error"));});},Switch.prototype.toJSON=function(){return{sys:xnm.aio.wemo.DM.SYS,type:this.type,ip:this.ip,port:this.port,uuid:this.uuid};},Switch.prototype.equalsTo=function(t){return!!t&&t instanceof Switch&&this.ip==t.ip&&this.port==t.port;},Switch.parseJSON=function(t){return t.ip&&t.port?new Switch(t.ip,t.port,t.uuid,t.type):null;},Switch;}(),xnm.aio.wemo.DM=function(){var t={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off","on"]}}]},insight:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"switch status",ref:{value:"switchState",options:["off","on"]}},{type:"float",name:"power status",ref:{value:"powerState",scale:"0.1"}}]}},DMError=function DMError(t,e){this.code=t,this.message=e,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="WemoDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"wemo",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Belkin WeMo"}];},createDevice:function createDevice(t,e,n){var i=DMError,o=DMError.ERROR_CODE;t?t.type?t.ip?n(null,t):n(new i(o.INVALID,"ip is invalid")):n(new i(o.INVALID,"type is invalid")):n(new i(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,e,n){var i=DMError,o=DMError.ERROR_CODE;t?t.type?t.ip?n(null,t):n(new i(o.INVALID,"ip is invalid")):n(new i(o.INVALID,"type is invalid")):n(new i(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e,n){var _contains=function _contains(t,e){if("*"==t)return!0;for(var n=!1,i=0;i<t.length;i++){if(t[i]==e){n=!0;break;}}return n;},_filter=function _filter(t,e){var i=[],o=null,r=xnm.aio.wemo.DM.getCommandStatusMap(t,n);return r&&(o=function(t,e,n){var i=[];switch(n.catagory){case"command":t.command&&t.command.forEach(function(t){if(_contains(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));i.push(e);}});break;case"status":t.status&&t.status.forEach(function(t){if(_contains(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));i.push(e);}});}return i;}(r,0,e),i=i.concat(o)),i;};if(!t.sys)return null;var i=JSON.parse(JSON.stringify(t)),o=null;switch(e.catagory){case"command":o=_filter(t,e),i.command=o;break;case"status":o=_filter(t,e),i.status=o;break;default:return null;}return o&&0!=o.length?i:null;},getCommandStatusMap:function getCommandStatusMap(e,n){return e.type?t[e.type]:null;}};}(),xnm.aio.wemo.Handler=function(){var Handler=function Handler(){this.detectedDevices={};};return Handler.prototype.discoverDevices=function(t){var e=require("x.upnp.js");if(e){var n=this;e.discoverDevices(function(e){if("wemo"==e.type){var i=new xnm.aio.wemo.Switch(e.ip,e.port,e.uuid);e.subtype&&(i.type=e.subtype),n.detectedDevices[e.uuid]=i,t(i);}});}},Handler.prototype.getStateValues=function(t,e){return new xnm.aio.wemo.Switch().getStateValues(t,e);},Handler.prototype.getDeviceCommandList=function(t,e){var n=[];return n.push({id:window.XC_Text.on,cmd:"on"}),n.push({id:window.XC_Text.off,cmd:"off"}),n;},Handler.prototype.getDevice=function(t){return new xnm.aio.wemo.Switch(t.address,t.port,null,t.data);},Handler.prototype.devicemanager=xnm.aio.wemo.DM,Handler.prototype.registModule=function(t){t.register(xnm.aio.wemo.DM.SYS,"wemo");},Handler.prototype.resolveDevice=function(t){if(!t)return null;switch(t.type){case"switch":case"insight":return xnm.aio.wemo.Switch.parseJSON(t);default:return null;}},Handler.prototype.getDeviceCommands=function(t,e){var n=xnm.aio.wemo.DM.applyUIFilter(t,{catagory:"command",elems:"*"}),i=n?n.command:[];e&&e(null,i);},Handler.prototype.getDeviceStatus=function(t,e){var n=xnm.aio.wemo.DM.applyUIFilter(t,{catagory:"status",elems:"*"}),i=n?n.status:[];e&&e(null,i);},Handler.prototype.doCommand=function(t,e,n){var i=this.resolveDevice(t);i?i.executeCommandCreator(t,e,function(t){n&&n(t);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(t,e,n,i){var o=this.resolveDevice(e);if(o){var r=[{id:t,device:e,status:n}];o.getStatesCreator(null,r,function(t,e){t?i&&i(t):i&&i(null,e[0]);});}else i&&i(new Error("device json format invalid"));},Handler.prototype.discoverWithTimeout=function(t,e){var n={};this.discoverDevices(function(t){t&&t.uuid&&!n[t.uuid]&&(n[t.uuid]=t);}),setTimeout(function(){var t=[];for(var i in n){n.hasOwnProperty(i)&&t.push(n[i]);}e&&e(null,t);},t);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.wemo.Handler());