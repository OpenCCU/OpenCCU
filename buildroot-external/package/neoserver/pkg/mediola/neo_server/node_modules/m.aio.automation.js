var m=m||{};m.aio=m.aio||{},m.aio.automation=m.aio.automation||{},m.aio.automation.Logger=null,m.aio.automation.Task=function(){var Task=function Task(t){var i;if(this._id=t.id&&t.id>0?t.id:0,this._name=t.name,this._active=!!t.active,this._triggers=[],this._actions=[],t.triggers)for(i=0;i<t.triggers.length;i++){var a=m.aio.automation.Trigger.parse(t.triggers[i]);a&&this._triggers.push(a);}if(t.actions)for(i=0;i<t.actions.length;i++){var n=m.aio.automation.Action.parse(t.actions[i]);n&&this._actions.push(n);}};return Task.prototype.added=function(){var t=this;this._triggers.forEach(function(i){i.added(t);}),this._actions.forEach(function(i){i.added(t);});},Task.prototype.deleted=function(){var t=this;this._triggers.forEach(function(i){i.deleted(t);}),this._actions.forEach(function(i){i.deleted(t);});},Task.prototype.toJSON=function(){var t=[];this._triggers.forEach(function(i){t.push(i.toJSON());});var i=[];return this._actions.forEach(function(t){i.push(t.toJSON());}),{id:this._id,name:this._name,active:this._active,triggers:t,actions:i};},Task.parse=function(t){return t.name?new Task(t):null;},Task;}(),m.aio.automation.Trigger=function(){var Trigger=function Trigger(t){this._id=t.id&&t.id>0?t.id:0,this._active=!!t.active,this._input=null,this._condition=null,t.input&&(this._input=m.aio.automation.Input.parse(t.input)),t.condition&&(this._condition=m.aio.automation.Contidion.parse(t.condition));};return Trigger.prototype.added=function(t){var i;this._input&&this._input.type&&(i=m.aio.automation.Inputhandler.getHandler(this._input.type))&&i.added&&"function"==typeof i.added&&i.added(t._id,this._id,this._input);},Trigger.prototype.deleted=function(t){var i;this._input&&this._input.type&&(i=m.aio.automation.Inputhandler.getHandler(this._input.type))&&i.deleted&&"function"==typeof i.deleted&&i.deleted(t._id,this._id,this._input);},Trigger.prototype.toJSON=function(){return{id:this._id,active:this._active,input:this._input?this._input.toJSON():null,condition:this._condition?this._condition.toJSON():null};},Trigger.parse=function(t){return t.input?new Trigger(t):null;},Trigger;}(),m.aio.automation.Action=function(){var Action=function Action(t){this._id=t.id&&t.id>0?t.id:0,this._active=!!t.active,this._output=null,t.output&&(this._output=m.aio.automation.Output.parse(t.output));};return Action.prototype.added=function(t){var i;this._output&&this._output.type&&(i=m.aio.automation.Inputhandler.getHandler(this._output.type))&&i.added&&"function"==typeof i.added&&i.added(t._id,this._id,this._output);},Action.prototype.deleted=function(t){},Action.prototype.toJSON=function(){return{id:this._id,active:this._active,output:this._output?this._output.toJSON():null};},Action.parse=function(t){return t.output?new Action(t):null;},Action;}(),m.aio.automation.Output=function(){var Output=function Output(t){this.type=t.type;};return Output.parse=function(t){if(!t.type)return null;var i=m.aio.automation.Outputhandler.getHandler(t.type);return i&&i.parse&&"function"==typeof i.parse?i.parse(t):null;},Output;}(),m.aio.automation.Input=function(){var Input=function Input(t){this.type=t.type;};return Input.parse=function(t){if(!t.type)return null;var i=m.aio.automation.Inputhandler.getHandler(t.type);return i&&i.parse&&"function"==typeof i.parse?i.parse(t):null;},Input;}(),m.aio.automation.Contidion=function(){var Contidion=function Contidion(t){this.type=t.type;};return Contidion.parse=function(t){if(!t.type)return null;var i=m.aio.automation.Conditionhandler.getHandler(t.type);return i&&i.parse&&"function"==typeof i.parse?i.parse(t):null;},Contidion;}(),m.aio.automation.OPERATION={CREATE:"post",READ:"get",UPDATE:"put",DELETE:"delete"},m.aio.automation.Outputhandler={_handlers:{},getHandler:function getHandler(t){return t&&this._handlers[t]?this._handlers[t].handler:null;}},m.aio.automation.Conditionhandler={_handlers:{},getHandler:function getHandler(t){return t&&this._handlers[t]?this._handlers[t].handler:null;}},m.aio.automation.Inputhandler={_handlers:{},getHandler:function getHandler(t){return t&&this._handlers[t]?this._handlers[t].handler:null;}},m.aio.automation.Actionhandler={execute:function execute(t,i,a,n,e){if(t){if(a){var o=a.split("/");if("action"==o[0])switch(i){case m.aio.automation.OPERATION.CREATE:if(1!=o.length)return void(e&&e(new Error("path invalid")));this._createAction(t,n,e);break;case m.aio.automation.OPERATION.READ:1==o.length?this._readActions(t,e):this._readAction(t,o[1],e);break;case m.aio.automation.OPERATION.UPDATE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._updateAction(t,o[1],n,e);break;case m.aio.automation.OPERATION.DELETE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._deleteAction(t,o[1],e);break;default:e&&e(new Error("no such operation"));}else e&&e(new Error("path invalid"));}else e&&e(new Error("path invalid"));}else e&&e(new Error("task invalid"));},_findAction:function _findAction(t,i){for(var a=i.length;a--;){if(i[a]&&i[a]._id==t)return i[a];}return null;},_createAction:function _createAction(t,i,a){var n=m.aio.automation.Action.parse(i);if(n){for(var e=1,o=-1,r=0;r<t._actions.length;r++){if(t._actions[r]._id!=e){o=r;break;}e++;}n._id=e,o=-1==o?t._actions.length:o,t._actions.splice(o,0,n),this._saveTasks(function(i){i?t._actions.splice(o,1):n.added(t),a&&a(i,i?null:n.toJSON());});}else a&&a(new Error("data invalid"));},_readActions:function _readActions(t,i){for(var a=[],n=0;n<t._actions.length;n++){var e=t._actions[n]?t._actions[n].toJSON():null;e&&a.push(e);}i&&i(null,a);},_readAction:function _readAction(t,i,a){var n=this._findAction(i,t._actions);a&&a(n?null:new Error("no such actoin"),n?n.toJSON():null);},_updateAction:function _updateAction(t,i,a,n){for(var e,o=t._actions.length;o--;){if(t._actions[o]&&t._actions[o]._id==i){e=t._actions[o];break;}}if(e){var r=m.aio.automation.Action.parse(a);r?r._id&&r._id==e._id?(t._actions.splice(o,1,r),this._saveTasks(function(i){i?t._actions.splice(o,1,e):(e.deleted(t),r.added(t)),n&&n(i,i?null:r.toJSON());})):n&&n(new Error("new action id invalid")):n&&n(new Error("data invalid"));}else n&&n(new Error("no such action"));},_deleteAction:function _deleteAction(t,i,a){for(var n,e=t._actions.length;e--;){if(t._actions[e]&&t._actions[e]._id==i){n=t._actions[e];break;}}n?(t._actions.splice(e,1),this._saveTasks(function(i){i?t._actions.splice(e,0,n):n.deleted(t),a&&a(i);})):a&&a(new Error("no such action"));},_saveTasks:function _saveTasks(t){m.aio.automation.Manager.saveDatabase(t);},fireAction:function fireAction(t,i){if(t&&t._active&&t._output&&t._output.type){var a=m.aio.automation.Outputhandler.getHandler(t._output.type);a&&a.execute&&"function"==typeof a.execute?a.execute(t._output,function(){i&&i();}):i&&i();}else i&&i();}},m.aio.automation.Triggerhandler={execute:function execute(t,i,a,n,e){if(t){if(a){var o=a.split("/");if("trigger"==o[0])switch(i){case m.aio.automation.OPERATION.CREATE:if(1!=o.length)return void(e&&e(new Error("path invalid")));this._createTrigger(t,n,e);break;case m.aio.automation.OPERATION.READ:1==o.length?this._readTriggers(t,e):this._readTrigger(t,o[1],e);break;case m.aio.automation.OPERATION.UPDATE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._updateTrigger(t,o[1],n,e);break;case m.aio.automation.OPERATION.DELETE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._deleteTrigger(t,o[1],e);break;default:e&&e(new Error("no such operation"));}else e&&e(new Error("path invalid"));}else e&&e(new Error("path invalid"));}else e&&e(new Error("task invalid"));},_findTrigger:function _findTrigger(t,i){for(var a=i.length;a--;){if(i[a]&&i[a]._id==t)return i[a];}return null;},_createTrigger:function _createTrigger(t,i,a){var n=m.aio.automation.Trigger.parse(i);if(n){for(var e=1,o=-1,r=0;r<t._triggers.length;r++){if(t._triggers[r]._id!=e){o=r;break;}e++;}n._id=e,o=-1==o?t._triggers.length:o,t._triggers.splice(o,0,n),this._saveTasks(function(i){i?t._triggers.splice(o,1):n.added(t),a&&a(i,i?null:n.toJSON());});}else a&&a(new Error("data invalid"));},_readTriggers:function _readTriggers(t,i){for(var a=[],n=0;n<t._triggers.length;n++){var e=t._triggers[n]?t._triggers[n].toJSON():null;e&&a.push(e);}i&&i(null,a);},_readTrigger:function _readTrigger(t,i,a){var n=this._findTrigger(i,t._triggers);a&&a(n?null:new Error("no such trigger"),n?n.toJSON():null);},_updateTrigger:function _updateTrigger(t,i,a,n){for(var e,o=t._triggers.length;o--;){if(t._triggers[o]&&t._triggers[o]._id==i){e=t._triggers[o];break;}}if(e){var r=m.aio.automation.Trigger.parse(a);r?r._id&&r._id==e._id?(t._triggers.splice(o,1,r),this._saveTasks(function(i){i?t._triggers.splice(o,1,e):(e.deleted(t),r.added(t)),n&&n(i,i?null:r.toJSON());})):n&&n(new Error("new trigger id invalid")):n&&n(new Error("data invalid"));}else n&&n(new Error("no such trigger"));},_deleteTrigger:function _deleteTrigger(t,i,a){for(var n,e=t._triggers.length;e--;){if(t._triggers[e]&&t._triggers[e]._id==i){n=t._triggers[e];break;}}n?(t._triggers.splice(e,1),this._saveTasks(function(i){i?t._triggers.splice(e,0,n):n.deleted(t),a&&a(i);})):a&&a(new Error("no such trigger"));},_saveTasks:function _saveTasks(t){m.aio.automation.Manager.saveDatabase(t);},fireTrigger:function fireTrigger(t,i,a){var n=this._findTrigger(i,t._triggers);n&&n._active&&(n._condition&&n._condition.match&&"function"==typeof n._condition.match?n._condition.match(a,function(a){a&&(m.aio.automation.Logger.log("trace","fire trigger "+i+" in task "+t._id),m.aio.automation.Taskhandler.fireTask(t._id));}):(m.aio.automation.Logger.log("trace","fire trigger "+i+" in task "+t._id),m.aio.automation.Taskhandler.fireTask(t._id)));}},m.aio.automation.Taskhandler={_firedTask:{},execute:function execute(t,i,a,n,e){if(t){if(a){var o=a.split("/");if("task"==o[0]){var r,s=this;if(o.length>2){if(!o[1]||!o[1].match(/^\d+$/))return void(e&&e(new Error("path invalid")));if(!(r=this._findTask(o[1],m.aio.automation.Manager._tasks)))return void(e&&e(new Error("no such task")));switch(o.splice(0,2),o[0]){case"trigger":return void m.aio.automation.Triggerhandler.execute(r,i,o.join("/"),n,function(t,i){t?e&&e(t):s._saveTasks(function(t){e&&e(t,i);});});case"action":return void m.aio.automation.Actionhandler.execute(r,i,o.join("/"),n,function(t,i){t?e&&e(t):s._saveTasks(function(t){e&&e(t,i);});});default:return void(e&&e(new Error("path invalid")));}}switch(i){case m.aio.automation.OPERATION.CREATE:if(1!=o.length)return void(e&&e(new Error("path invalid")));this._createTask(n,e);break;case m.aio.automation.OPERATION.READ:1==o.length?this._readTasks(e):this._readTask(o[1],e);break;case m.aio.automation.OPERATION.UPDATE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._updateTask(o[1],n,e);break;case m.aio.automation.OPERATION.DELETE:if(2!=o.length)return void(e&&e(new Error("path invalid")));this._deleteTask(o[1],e);break;default:e&&e(new Error("no such operation"));}}else e&&e(new Error("path invalid"));}else e&&e(new Error("path invalid"));}else e&&e(new Error("tasks invalid"));},_findTask:function _findTask(t,i){for(var a=i.length;a--;){if(i[a]&&i[a]._id==t)return i[a];}return null;},_saveTasks:function _saveTasks(t){m.aio.automation.Manager.saveDatabase(t);},_createTask:function _createTask(t,i){var a=m.aio.automation.Manager._tasks,n=m.aio.automation.Task.parse(t);if(n){if(n._name){for(var e,o=1,r=-1,s=0;s<a.length;s++){if(a[s]._id==o?o++:-1==r&&(r=s),a[s]&&a[s]._name==n._name){e=a[s];break;}}e?i&&i(new Error("another task has the same name")):(n._id=o,r=-1==r?a.length:r,a.splice(r,0,n),this._saveTasks(function(t){t?a.splice(r,1):n.added(),i&&i(t,t?null:n.toJSON());}));}else i&&i(new Error("new task name invalid"));}else i&&i(new Error("data invalid"));},_readTasks:function _readTasks(t){for(var i=m.aio.automation.Manager._tasks,a=[],n=0;n<i.length;n++){var e=i[n]?i[n].toJSON():null;e&&a.push(e);}t&&t(null,a);},_readTask:function _readTask(t,i){var a=m.aio.automation.Manager._tasks,n=this._findTask(t,a);i&&i(n?null:new Error("no such task"),n?n.toJSON():null);},_updateTask:function _updateTask(t,i,a){var n=m.aio.automation.Manager._tasks,e=this._findTask(t,n);if(e){var o=m.aio.automation.Task.parse(i);if(o){if(o._id&&o._id==e._id){for(var r,s=n.length;s--;){if(n[s]&&n[s]._id!=e._id&&n[s]._name!=o._name){r=n[s];break;}}if(r)a&&a(new Error("another task has the same name"));else{var u=e._name,d=e._active;e._name=o._name,e._active=o._active,this._saveTasks(function(t){t&&(e._name=u,e._active=d),a&&a(t,t?null:e.toJSON());});}}else a&&a(new Error("new task id invalid"));}else a&&a(new Error("data invalid"));}else a&&a(new Error("no such task"));},_deleteTask:function _deleteTask(t,i){for(var a,n=m.aio.automation.Manager._tasks,e=n.length;e--;){if(n[e]&&n[e]._id==t){a=n[e];break;}}a?(m.aio.automation.Manager._tasks.splice(e,1),this._saveTasks(function(t){t?m.aio.automation.Manager._tasks.splice(e,0,a):a.deleted(),i&&i(t);})):i&&i(new Error("no such task"));},tasks2json:function tasks2json(t){var i=[];return t.forEach(function(t){t&&i.push(t.toJSON());}),i;},json2tasks:function json2tasks(t){var i=[];return t.forEach(function(t){var a=m.aio.automation.Task.parse(t);a&&i.push(a);}),i;},getInputs:function getInputs(t){var i=m.aio.automation.Manager._tasks,a=[];return i.forEach(function(i){i&&i._triggers&&i._triggers.forEach(function(n){n&&n._input&&n._input.type==t&&a.push({taskId:i._id,triggerId:n._id,input:n._input});});}),a;},fireTask:function fireTask(t){var i=m.aio.automation.Manager._tasks,a=this._findTask(t,i);if(a&&a._active){var n=new Date().getTime(),e=this._firedTask[a._id];(!e||Math.abs(n-e)>1e3)&&(this._firedTask[a._id]=n,m.aio.automation.Logger.log("trace","fire task "+t),this._executeNextAction(0,a._actions));}},_executeNextAction:function _executeNextAction(t,i){if(i&&0!=i.length&&!(i.length<t+1)){var a=i[t],n=this;a?m.aio.automation.Actionhandler.fireAction(a,function(){t+=1,n._executeNextAction(t,i);}):(t+=1,this._executeNextAction(t,i));}}},m.aio.automation.Devicehandler={DEVICE:"device_db",DEVICE_INFO:"deviceinfo.xml",_folder:null,_fm:null,_dm:null,init:function init(t,i,a){this._fm=t,this._folder=i,this._dm=require("m.aio.devicemanager.js"),this._loadDeviceManager(function(){a&&a();});},uploadDevice:function uploadDevice(t,i){var a=this,n=require("fs-extra"),e=this._getDevicePath();n.writeFile(e,JSON.stringify(t),function(t){t?i&&i(t):(a._dm.handlers=[],a._loadDeviceManager(function(t){i&&i(t);}));});},uploadDeviceinfo:function uploadDeviceinfo(t,i){var a=this,n=require("fs-extra"),e=this._getDeviceinfoPath();n.writeFile(e,t,function(t){t?i&&i(t):(a._dm.handlers=[],a._loadDeviceManager(function(t){i&&i(t);}));});},_loadDeviceManager:function _loadDeviceManager(t){var i=this,a={index:1,getFolderPath:function getFolderPath(){var t=require("path");return i._fm.getUserRootDataPath()+t.sep+i._folder;}};this._dm._loadTenant(a,function(i){t&&t(i);});},_getDevicePath:function _getDevicePath(){return this._getFilePath(this.DEVICE);},_getDeviceinfoPath:function _getDeviceinfoPath(){return this._getFilePath(this.DEVICE_INFO);},_getFilePath:function _getFilePath(t){if(!this._fm)return null;var i=require("path");return this._fm.getUserRootDataPath()+i.sep+this._folder+i.sep+t;},getDevices:function getDevices(t,i){this._dm.execute("readWithoutLicense",1,"device",t,i);},getGateway:function getGateway(t,i){this._dm?this._dm.execute("readWithoutLicense",1,"gateway",{filter:"prop","info.sys":t},function(t,a){i&&i(t,a);}):i&&i(new Error("device manager is null"));}},m.aio.automation.Manager={FOLDER:"automation",DB:"db",_modules:[],_fm:null,_tasks:[],init:function init(t,i){if(t&&t.fileManager){m.aio.automation.Logger=require("x.logger.js").getLogger("m.aio.automation");var a=this;if(this._fm=t.fileManager,t.modules)for(var n=0;n<t.modules.length;n++){var e=t.modules[n];e&&e.dir&&e.handler&&e.handler.init&&"function"==typeof e.handler.init&&(this._modules.push({id:n+1,dir:e.dir,handler:e.handler}),e.handler.init(n+1,this));}var o=this._getDbPath();if(o)require("fs-extra").ensureFile(o,function(t){t?i&&i(t):m.aio.automation.Devicehandler.init(a._fm,a.FOLDER,function(){a.loadDatabase(function(){a._modules.forEach(function(t){t&&t.handler&&t.handler.initFinish&&"function"==typeof t.handler.initFinish&&t.handler.initFinish();}),i&&i();});});});else i&&i(new Error("database file invalid"));}else i&&i(new Error("argument error"));},saveDatabase:function saveDatabase(t){var i=this._getDbPath();if(i){var a=require("fs"),n=m.aio.automation.Taskhandler.tasks2json(this._tasks);a.writeFile(i,JSON.stringify(n),function(i){t&&t(i);});}else t&&t(new Error("database file invalid"));},loadDatabase:function loadDatabase(t){var i=this._getDbPath();if(i){var a=require("fs"),n=this;a.readFile(i,{encoding:"utf8"},function(i,a){if(i)t&&t(i);else if(a){try{var e=JSON.parse(a);Array.isArray(e)&&(e=m.aio.automation.Taskhandler.json2tasks(e))&&(n._tasks=e);}catch(t){}t&&t();}else t&&t();});}else t&&t(new Error("database file invalid"));},_getDbPath:function _getDbPath(){if(!this._fm)return null;var t=require("path");return this._fm.getUserRootDataPath()+t.sep+this.FOLDER+t.sep+this.DB;},_getModule:function _getModule(t){for(var i=0;i<this._modules.length;i++){if(this._modules[i]&&this._modules[i].id==t)return this._modules[i];}return null;},registInputHandler:function registInputHandler(t,i,a,n){return!!(t&&i&&a&&n)&&!m.aio.automation.Inputhandler._handlers[i]&&(m.aio.automation.Inputhandler._handlers[i]={id:t,handler:a,ui:n},!0);},registConditionHandler:function registConditionHandler(t,i,a,n){return!!(t&&i&&a&&n)&&!m.aio.automation.Conditionhandler._handlers[i]&&(m.aio.automation.Conditionhandler._handlers[i]={id:t,handler:a,ui:n},!0);},registOutputHandler:function registOutputHandler(t,i,a,n){return!!(t&&i&&a&&n)&&!m.aio.automation.Outputhandler._handlers[i]&&(m.aio.automation.Outputhandler._handlers[i]={id:t,handler:a,ui:n},!0);},getInputs:function getInputs(t){return m.aio.automation.Taskhandler.getInputs(t);},fireTrigger:function fireTrigger(t,i,a){var n=m.aio.automation.Taskhandler._findTask(t,this._tasks);n&&m.aio.automation.Triggerhandler.fireTrigger(n,i,a);}},m.aio.automation.Handler=function(){var Handler=function Handler(){};return Handler.prototype.init=function(t,i){t&&t.fileManager?m.aio.automation.Manager.init(t,i):i&&i(new Error("invalid params"));},Handler.prototype.execute=function(t,i,a,n){m.aio.automation.Taskhandler.execute(m.aio.automation.Manager._tasks,t,i,a,n);},Handler.prototype.getUiJs=function(t,i){if(!i)return null;var a,n,e=require("path");switch(t){case"input":n=m.aio.automation.Inputhandler._handlers[i];break;case"output":n=m.aio.automation.Outputhandler._handlers[i];break;case"condition":n=m.aio.automation.Conditionhandler._handlers[i];}return n&&n.id&&n.handler&&n.ui&&(a=m.aio.automation.Manager._getModule(n.id))&&a.dir?a.dir+e.sep+n.ui:null;},Handler.prototype.listUiJs=function(){var t,i,a={input:[],condition:[],output:[]};for(i in m.aio.automation.Inputhandler._handlers){m.aio.automation.Inputhandler._handlers.hasOwnProperty(i)&&(t=m.aio.automation.Inputhandler._handlers[i])&&t.ui&&a.input.push({type:i,js:"/js/automation/input/"+i+"/ui.js"});}for(i in m.aio.automation.Conditionhandler._handlers){m.aio.automation.Conditionhandler._handlers.hasOwnProperty(i)&&(t=m.aio.automation.Conditionhandler._handlers[i])&&t.ui&&a.condition.push({type:i,js:"/js/automation/condition/"+i+"/ui.js"});}for(i in m.aio.automation.Outputhandler._handlers){m.aio.automation.Outputhandler._handlers.hasOwnProperty(i)&&(t=m.aio.automation.Outputhandler._handlers[i])&&t.ui&&a.output.push({type:i,js:"/js/automation/output/"+i+"/ui.js"});}return a;},Handler.prototype.uploadDevice=function(t,i){m.aio.automation.Devicehandler.uploadDevice(t,i);},Handler.prototype.uploadDeviceinfo=function(t,i){m.aio.automation.Devicehandler.uploadDeviceinfo(t,i);},Handler.prototype.onHttpGetInput=function(t,i,a,n,e){var o=e,r=m.aio.automation.Manager.getInputs("http");if(r)for(var s=r.length,u=0;u<r.length;u++){r[u].input&&r[u].input.test(r[u],{path:t,query:i,username:a,password:n},function(t){s--,t&&o&&(o(),o=null),0==s&&o&&o(new Error("no matched http input"));});}},Handler.prototype.getDevices=function(t,i){m.aio.automation.Devicehandler.getDevices(t,i);},Handler.prototype.getGateway=function(t,i){m.aio.automation.Devicehandler.getGateway(t,i);},Handler;}(),"undefined"!=typeof module&&(module.exports=new m.aio.automation.Handler());