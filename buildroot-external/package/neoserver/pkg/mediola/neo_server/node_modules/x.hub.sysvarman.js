var x=x||{};x.hub=x.hub||{},x.hub.sysvarman=x.hub.sysvarman||{},x.hub.sysvarman.SysvarManager=function(){var SM=function SM(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.SysvarManager"),this._sysvarFile=null,this._sysvars={},this._writing=!1,this._writeQueue=0;};return SM.FILE_NAME="sysvar.json",SM.prototype.init=function(r,e){this._logger.log("info","init sysvar mananger");var t=require("fs-extra"),a=require("path");this._sysvarFile||(this._sysvarFile=a.resolve(r.getUserRootDataPath(),SM.FILE_NAME));var s=this;t.ensureFile(this._sysvarFile,function(r){if(r)return s._logger.log("error","error in ensureFile"),s._logger.log("error",r),void(e&&e(r));s._readData(function(r,t){!r&&t&&(s._sysvars=t),e&&e(r);});});},SM.prototype.setVar=function(r,e){if(this._logger.log("trace","setVar:"+(r?JSON.stringify(r):null)),r&&r.id&&r.type){if(-1!=["ONOFF","FLOAT","INT","STRING"].indexOf(r.type)){var t=parseInt(r.id,16);if(t<=0)e&&e(new Error("sysvar out of range"));else{var a=t.toString(16).toUpperCase();a.length<2&&(a="0"+a);var s,i={id:a,type:r.type,value:r.value},o=this._sysvars[i.id];switch(i.type){case"ONOFF":if(i.value||(i.value="OFF"),i.value=i.value.toUpperCase(),"ON"!=i.value&&"OFF"!=i.value&&"TOGGLE"!=i.value)return void(e&&e(new Error("ONOFF sysvar value invalid")));if("TOGGLE"==i.value)if(o){if(o.type!=i.type)return void(e&&e(new Error("sysvar is not a ONOFF type")));i.value="ON"==o.value?"OFF":"ON";}else i.value="OFF";break;case"FLOAT":case"INT":if(i.value||(i.value="00000000"),s=parseInt(i.value,16),isNaN(s))return void(e&&e(new Error("FLOAT/INT sysvar value invalid")));break;case"STRING":i.value||(i.value=""),i.value=decodeURIComponent(i.value+"");}i.time=new Date().getTime(),this._sysvars[i.id]=i;var n=require("x.hub.eventbus.js");o&&o.value==i.value||n.emit("gatewayevent",this.getSysvarStateLegacy(i.id),{address:"Sysvar"},"STA"),n.emit("udpevent",this.getSysvarStateLegacy(i.id),"STA"),this._postWrite(function(r){e&&e(r);});}}else e&&e(new Error("invalid sysvar type"));}else e&&e(new Error("sysvar format invalid"));},SM.prototype.delVar=function(r,e){if(r&&this._sysvars[r])return delete this._sysvars[r],void this._postWrite(function(r){e&&e(r);});e&&e();},SM.prototype.getVar=function(r){return r?this._sysvars[r]:null;},SM.prototype.getSysvars=function(){return JSON.parse(JSON.stringify(this._sysvars));},SM.prototype.getSysvarStateLegacy=function(r){if(!r||!this._sysvars[r])return null;var e=this._sysvars[r];return{type:e.type,adr:e.id,state:e.value};},SM.prototype.getSysvarStatesLegacy=function(){var r=[];for(var e in this._sysvars){if(this._sysvars.hasOwnProperty(e)){var t=this.getSysvarStateLegacy(e);t&&r.push(t);}}return r;},SM.prototype._readData=function(r){var e=this;require("fs").readFile(this._sysvarFile,"utf8",function(t,a){if(t)return e._logger.log("error","error in _readData"),e._logger.log("error",t),void(r&&r(t));if(a)try{var s=JSON.parse(a);r&&r(null,s||{});}catch(t){e._logger.log("error","error in parse json in _readData"),e._logger.log("error",t),r&&r(t);}else r&&r(null,{});});},SM.prototype._postWrite=function(r){this._writeQueue++,this._writing||this._doWrite(),r&&r();},SM.prototype._doWrite=function(){if(this._writeQueue>0){var r=this;this._writeQueue=0,this._writing=!0,this._writeData(function(e){e&&r._logger.log("warn","write file failed:"+e.message),r._writing=!1,r._doWrite();});}},SM.prototype._writeData=function(r){var e=this;try{require("fs").writeFile(this._sysvarFile,JSON.stringify(this._sysvars,null,2),function(t){t&&(e._logger.log("error","error in _writeData"),e._logger.log("error",t)),e._logger.log("trace","variables written into file:"+Object.keys(e._sysvars)),r&&r(t);});}catch(r){e._logger.log("error","error in _writeData"),e._logger.log("error",r);}},SM;}(),x.hub.sysvarman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.sysvarman.Handler"),this.sysvarManager=new x.hub.sysvarman.SysvarManager();};return Handler.prototype.SysvarManager=x.hub.sysvarman.SysvarManager,Handler.prototype.init=function(r,e,t){var a=this;this.sysvarManager.init(e,function(r){r&&(a._logger.log("error","error in init"),a._logger.log("error",r)),t&&t({error:r});});},Handler.prototype.setVar=function(r,e){var t=this;this.sysvarManager.setVar(r,function(r){r&&(t._logger.log("error","error in setVar"),t._logger.log("error",r)),e&&e({error:r});});},Handler.prototype.delVar=function(r,e){var t=this;this.sysvarManager.delVar(r,function(r){r&&(t._logger.log("error","error in delVar"),t._logger.log("error",r)),e&&e({error:r});});},Handler.prototype.getSysvarStates=function(r){var e=this.sysvarManager.getSysvarStatesLegacy();this._logger.log("trace","getSysvarStates:"+JSON.stringify(e)),r&&r({data:e});},Handler.prototype.processSysvarST=function(r,e,t){var a=this;a._logger.log("trace","process st sysvars:"+JSON.stringify(e));for(var _deleteStSysvar=function _deleteStSysvar(r,e,t){if(r&&e&&e.id){a._logger.log("trace","delete st sysvar "+JSON.stringify(e));var s=t,i="/cmd?XC_FNC=delVar&id="+e.id,o=setTimeout(function(){a._logger.log("error","delete st sysvar "+e.id+" timeout"),s&&s(new Error("st timeout")),s=null;},1e4);r._doSTMCommandRequest(i,!1,function(r){o&&(clearTimeout(o),o=null),a._logger.log("trace","delete st sysvar "+e.id+" return",r),s&&s(),s=null;});}else t&&t();},s=[],i=[],o=[],n=0;n<e.length;n++){var g=e[n];if(g)switch(g.type){case"ONOFF":case"FLOAT":case"INT":case"STRING":var l={id:g.adr,type:g.type,value:g.state};s.push(l);var v=g.adr;this.sysvarManager.getVar(v)||i.push(l);break;default:o.push(g);}}a._logger.log("trace","find st sysvars:"+JSON.stringify(s)),a._logger.log("trace","find new sysvars:"+JSON.stringify(i)),function(r,e){if(r&&0!=r.length){var t=0,cb=function cb(s){a._logger.log(s?"error":"trace","add new sysvar "+JSON.stringify(r[t])+":"+s),t++,s?e&&e(s):t!=r.length?a.sysvarManager.setVar(r[t],cb):e&&e();};a.sysvarManager.setVar(r[t],cb);}else e&&e();}(i,function(e){if(e)return a._logger.log("error","error in _addNewSysvars"),a._logger.log("error",e),void(t&&t({error:e}));!function(r,e,t){if(r&&e&&0!=e.length){var a=0,cb=function cb(s){a++,s?t&&t(s):a!=e.length?_deleteStSysvar(r,e[a],cb):t&&t();};_deleteStSysvar(r,e[a],cb);}else t&&t();}(r,s),a.getSysvarStates(function(r){r&&r.error||(r.data||(r.data=[]),r.data=r.data.concat(o)),t&&t(r);});});},Handler;}(),module.exports=new x.hub.sysvarman.Handler();