function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});Object.defineProperty(subClass,"prototype",{writable:false});if(superClass)_setPrototypeOf(subClass,superClass);}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined");}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _wrapNativeSuper(Class){var _cache=typeof Map==="function"?new Map():undefined;_wrapNativeSuper=function _wrapNativeSuper(Class){if(Class===null||!_isNativeFunction(Class))return Class;if(typeof Class!=="function"){throw new TypeError("Super expression must either be null or a function");}if(typeof _cache!=="undefined"){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper);}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor);}Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:false,writable:true,configurable:true}});return _setPrototypeOf(Wrapper,Class);};return _wrapNativeSuper(Class);}function _construct(Parent,args,Class){if(_isNativeReflectConstruct()){_construct=Reflect.construct.bind();}else{_construct=function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var Constructor=Function.bind.apply(Parent,a);var instance=new Constructor();if(Class)_setPrototypeOf(instance,Class.prototype);return instance;};}return _construct.apply(null,arguments);}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function _isNativeFunction(fn){return Function.toString.call(fn).indexOf("[native code]")!==-1;}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}function _regeneratorRuntime(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */_regeneratorRuntime=function _regeneratorRuntime(){return exports;};var exports={},Op=Object.prototype,hasOwn=Op.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key];}try{define({},"");}catch(err){define=function define(obj,key,value){return obj[key]=value;};}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return generator._invoke=function(innerFn,self,context){var state="suspendedStart";return function(method,arg){if("executing"===state)throw new Error("Generator is already running");if("completed"===state){if("throw"===method)throw arg;return doneResult();}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult;}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if("suspendedStart"===state)throw state="completed",context.arg;context.dispatchException(context.arg);}else"return"===context.method&&context.abrupt("return",context.arg);state="executing";var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?"completed":"suspendedYield",record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done};}"throw"===record.type&&(state="completed",context.method="throw",context.arg=record.arg);}};}(innerFn,self,context),generator;}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)};}catch(err){return{type:"throw",arg:err};}}exports.wrap=wrap;var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,function(){return this;});var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){define(prototype,method,function(arg){return this._invoke(method,arg);});});}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==_typeof(value)&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject);},function(err){invoke("throw",err,resolve,reject);}):PromiseImpl.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result);},function(error){return invoke("throw",error,resolve,reject);});}reject(record.arg);}var previousPromise;this._invoke=function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl(function(resolve,reject){invoke(method,arg,resolve,reject);});}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg();};}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(undefined===method){if(context.delegate=null,"throw"===context.method){if(delegate.iterator["return"]&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method");}return ContinueSentinel;}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel);}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry);}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record;}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0);}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;){if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;}return next.value=undefined,next.done=!0,next;};return next.next=next;}}return{next:doneResult};}function doneResult(){return{value:undefined,done:!0};}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(Gp,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name));},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun;},exports.awrap=function(arg){return{__await:arg};},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,function(){return this;}),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next();});},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,function(){return this;}),define(Gp,"toString",function(){return"[object Generator]";}),exports.keys=function(object){var keys=[];for(var key in object){keys.push(key);}return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next;}return next.done=!0,next;};},exports.values=values,Context.prototype={constructor:Context,reset:function reset(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this){"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined);}},stop:function stop(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval;},dispatchException:function dispatchException(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught;}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc);}}}},abrupt:function abrupt(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break;}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record);},complete:function complete(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel;},finish:function finish(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel;}},"catch":function _catch(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry);}return thrown;}}throw new Error("illegal catch attempt");},delegateYield:function delegateYield(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel;}},exports;}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value;}catch(error){reject(error);return;}if(info.done){resolve(value);}else{Promise.resolve(value).then(_next,_throw);}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value);}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err);}_next(undefined);});};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.somfylocal=xnm.aio.somfylocal||{},xnm.aio.somfylocal.getLogger=function SomfyLoggerFactory(e){var t=require("x.logger.js").getLogger(e);return require("x.logger.js").setLogToConsole(!0,e),t;},xnm.aio.somfylocal.TokenManager=/*#__PURE__*/function(){function SomfyTokenManager(e){_classCallCheck(this,SomfyTokenManager);this.HOST="ha101-1.overkiz.com",this.API_BASE="/enduser-mobile-web/enduserAPI",this.TOKEN_LABEL="Mediola_".concat(e.pod),this.TEMP_TOKEN_LABEL="xnm.aio.somfylocal.tempToken.".concat(e.pod),this.SECRET_KEY="DoNotChangeMeItIsNotSecure",this.cookie="",this.lastLogin=0,this.boxInfo=e,this.client=new xnm.aio.somfylocal.httpClient(this.HOST,null,!0);this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.TokenManager");}_createClass(SomfyTokenManager,[{key:"getValidBoxInfo",value:function(){var _getValidBoxInfo=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return this.doLogin();case 3:_context.next=5;return this._generateToken();case 5:if(_context.sent){_context.next=7;break;}throw new Error("can not generate token");case 7:_context.next=9;return this._activateToken();case 9:if(_context.sent){_context.next=11;break;}throw new Error("can not activate token");case 11:return _context.abrupt("return",(this.boxInfo.discovery=!1,this.boxInfo));case 14:_context.prev=14;_context.t0=_context["catch"](0);return _context.abrupt("return",(this._logger.log("error",_context.t0),null));case 17:case"end":return _context.stop();}}},_callee,this,[[0,14]]);}));function getValidBoxInfo(){return _getValidBoxInfo.apply(this,arguments);}return getValidBoxInfo;}()},{key:"doLogin",value:function(){var _doLogin=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(){return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return this._login();case 2:if(_context2.sent){_context2.next=4;break;}throw new Error("can not login");case 4:case"end":return _context2.stop();}}},_callee2,this);}));function doLogin(){return _doLogin.apply(this,arguments);}return doLogin;}()},{key:"isValid",value:function(){var _isValid=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(e){var t,o,_e;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return this.doLogin();case 3:this._checkCookie();_context3.next=6;return this._listTokens();case 6:t=_context3.sent;o=this.boxInfo.tokenLabel;if(!(e&&(o=e),!t)){_context3.next=10;break;}return _context3.abrupt("return","unknown");case 10:if(o){_context3.next=12;break;}return _context3.abrupt("return",(this._logger.log("warn","anomaly tokenLabel is not set for ".concat(this.boxInfo.pod)),"unknown"));case 12:if(t.find(function(e){return e.label==o;})){_context3.next=15;break;}_e=JSON.parse(JSON.stringify(this.boxInfo));return _context3.abrupt("return",(_e.username=_e.username&&"*****",_e.password=_e.password&&"*****",_e.token=_e.token&&"*****",this._logger.log("warn","cannot find the token in list ".concat(JSON.stringify(_e))),"invalid"));case 15:return _context3.abrupt("return","ok");case 18:_context3.prev=18;_context3.t0=_context3["catch"](0);return _context3.abrupt("return",(this._logger.log("error",_context3.t0),"unknown"));case 21:case"end":return _context3.stop();}}},_callee3,this,[[0,18]]);}));function isValid(_x){return _isValid.apply(this,arguments);}return isValid;}()},{key:"getTokenInfo",value:function(){var _getTokenInfo=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee4(){var _this=this;var e,t;return _regeneratorRuntime().wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_context4.next=3;return this.doLogin();case 3:this._checkCookie();_context4.next=6;return this._listTokens();case 6:e=_context4.sent;if(e){_context4.next=9;break;}return _context4.abrupt("return",null);case 9:if(this.boxInfo.tokenLabel){_context4.next=11;break;}return _context4.abrupt("return",(this._logger.log("warn","get token info : anomaly tokenLabel is not set for ".concat(this.boxInfo.pod)),null));case 11:t=e.find(function(e){return e.label==_this.boxInfo.tokenLabel;});return _context4.abrupt("return",t||(this._logger.log("warn","get token info : can not find the token in list ".concat(JSON.stringify(this.boxInfo))),null));case 15:_context4.prev=15;_context4.t0=_context4["catch"](0);return _context4.abrupt("return",(this._logger.log("error",_context4.t0),null));case 18:case"end":return _context4.stop();}}},_callee4,this,[[0,15]]);}));function getTokenInfo(){return _getTokenInfo.apply(this,arguments);}return getTokenInfo;}()},{key:"getIP",value:function(){var _getIP=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee5(e){var _this2=this;return _regeneratorRuntime().wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:return _context5.abrupt("return",new Promise(function(t,o){try{var n="gateway-".concat(_this2.boxInfo.pod,".local"),a=require("x.mdns.js");a.clearRecordBuffer();var s="_kizboxdev._tcp.local";("number"!=typeof e||isNaN(e))&&(e=1e4),a.discoverServiceWithTimeout(s,e,function(e,a){if(e)return void o(e);var s=null;for(var _e2=0;_e2<a.length;_e2++){var _t=a[_e2];_t.target.toString()==n&&_t.ip&&_t.ip.length>0&&(s=_t.ip[0]);}s&&xnm.aio.somfylocal.Utils._isIP(s)?(_this2._logger.log("debug","".concat(n," is resolved to ").concat(s)),t(s)):o(new Error("can not resolve the ip"));});}catch(e){o(e);}}));case 1:case"end":return _context5.stop();}}},_callee5);}));function getIP(_x2){return _getIP.apply(this,arguments);}return getIP;}()},{key:"_login",value:function(){var _login2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee6(){var e,t,o,n,a,s,r,i;return _regeneratorRuntime().wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:_context6.prev=0;e=Date.now(),t=6e4,o=e-this.lastLogin;if(!(this.lastLogin&&o<t)){_context6.next=4;break;}return _context6.abrupt("return",(this._logger.log("debug","we should still be logged in, last login at ".concat(this.lastLogin," - delta ").concat(o)),!0));case 4:n={"Content-Type":"application/x-www-form-urlencoded"};a="".concat(encodeURI("userId"),"=").concat(encodeURIComponent(this.boxInfo.username),"&").concat(encodeURI("userPassword"),"=").concat(encodeURIComponent(this.boxInfo.password));s="".concat(this.API_BASE,"/login");_context6.next=9;return this.client.post(s,n,a);case 9:r=_context6.sent;if(!(!r.body||!r.body.success)){_context6.next=12;break;}throw new Error("login failed");case 12:i=r.headers["Set-Cookie"]||r.headers["set-cookie"];if(!(!i||!i[0])){_context6.next=15;break;}throw new Error("can not get cookie");case 15:return _context6.abrupt("return",(this.cookie=i[0],this.lastLogin=Date.now(),!0));case 18:_context6.prev=18;_context6.t0=_context6["catch"](0);return _context6.abrupt("return",(this._logger.log("error",_context6.t0),!1));case 21:case"end":return _context6.stop();}}},_callee6,this,[[0,18]]);}));function _login(){return _login2.apply(this,arguments);}return _login;}()},{key:"_generateToken",value:function(){var _generateToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee7(){var e,t,o;return _regeneratorRuntime().wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.prev=0;this._checkCookie();e=this._getHeaders();t="".concat(this.API_BASE,"/config/").concat(encodeURIComponent(this.boxInfo.pod),"/local/tokens/generate");_context7.next=6;return this.client.get(t,e);case 6:o=_context7.sent;if(!(!o.body||!o.body.token)){_context7.next=9;break;}throw new Error("can not generate token");case 9:return _context7.abrupt("return",(this.boxInfo.token=o.body.token,!0));case 12:_context7.prev=12;_context7.t0=_context7["catch"](0);return _context7.abrupt("return",(this._logger.log("error",_context7.t0),!1));case 15:case"end":return _context7.stop();}}},_callee7,this,[[0,12]]);}));function _generateToken(){return _generateToken2.apply(this,arguments);}return _generateToken;}()},{key:"_activateToken",value:function(){var _activateToken2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee8(e){var t,o,n,a,s;return _regeneratorRuntime().wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.prev=0;if(this.boxInfo.token){_context8.next=3;break;}throw new Error("you need first generate token, no token is set");case 3:this._checkCookie();t=this._getHeaders();o="".concat(this.TOKEN_LABEL,"_").concat(Date.now());e&&(o=e);n={label:o,token:this.boxInfo.token,scope:"devmode"};a="".concat(this.API_BASE,"/config/").concat(encodeURIComponent(this.boxInfo.pod),"/local/tokens");_context8.next=11;return this.client.post(a,t,JSON.stringify(n));case 11:s=_context8.sent;if(!(!s.body||!s.body.requestId)){_context8.next=14;break;}throw new Error("can not activate token");case 14:return _context8.abrupt("return",(this.boxInfo.tokenLabel=o,o));case 17:_context8.prev=17;_context8.t0=_context8["catch"](0);return _context8.abrupt("return",(this._logger.log("error",_context8.t0),!1));case 20:case"end":return _context8.stop();}}},_callee8,this,[[0,17]]);}));function _activateToken(_x3){return _activateToken2.apply(this,arguments);}return _activateToken;}()},{key:"deleteToken",value:function(){var _deleteToken=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee9(){var _this3=this;var e,t,o;return _regeneratorRuntime().wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.prev=0;_context9.next=3;return this.doLogin();case 3:this._checkCookie();_context9.next=6;return this.getTokenInfo();case 6:e=_context9.sent;if(e){_context9.next=9;break;}throw new Error("something is wrong in getting token info");case 9:t=this._getHeaders(),o="".concat(this.API_BASE,"/config/").concat(encodeURIComponent(this.boxInfo.pod),"/local/tokens/").concat(e.uuid);return _context9.abrupt("return",this.client["delete"](o,t).then(function(t){return _this3._logger.log("debug","".concat(e.uuid," is deleted")),!0;}));case 13:_context9.prev=13;_context9.t0=_context9["catch"](0);return _context9.abrupt("return",(this._logger.log("error","can not delete ".concat(this.boxInfo.tokenLabel," of ").concat(this.boxInfo.pod)),this._logger.log("error",_context9.t0),!1));case 16:case"end":return _context9.stop();}}},_callee9,this,[[0,13]]);}));function deleteToken(){return _deleteToken.apply(this,arguments);}return deleteToken;}()},{key:"_getLocalStorage",value:function _getLocalStorage(){if(XC&&XC.localStorage)return XC.localStorage;if(localStorage)return localStorage;throw new Error("can not find the localStorage");}},{key:"_listTokens",value:function(){var _listTokens2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee10(){var e,t,o;return _regeneratorRuntime().wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.prev=0;e=this._getHeaders();t="".concat(this.API_BASE,"/config/").concat(encodeURIComponent(this.boxInfo.pod),"/local/tokens/devmode");_context10.next=5;return this.client.get(t,e);case 5:o=_context10.sent;if(!(!o.body||!Array.isArray(o.body))){_context10.next=8;break;}throw new Error("list of tokens are invalid");case 8:return _context10.abrupt("return",o.body);case 11:_context10.prev=11;_context10.t0=_context10["catch"](0);return _context10.abrupt("return",(this._logger.log("error",_context10.t0),null));case 14:case"end":return _context10.stop();}}},_callee10,this,[[0,11]]);}));function _listTokens(){return _listTokens2.apply(this,arguments);}return _listTokens;}()},{key:"_checkCookie",value:function _checkCookie(){if(!this.cookie)throw new Error("you need first login, no cookie is set");return!0;}},{key:"_getHeaders",value:function _getHeaders(){return{Cookie:this.cookie};}},{key:"_encodeInfo",value:function _encodeInfo(e){var t=JSON.stringify(e);try{return require("x.crypt.js").AES.encodeString(t,this.SECRET_KEY);}catch(e){this._logger.log("error",e.stack?e.stack:e);}return t;}},{key:"_decodeInfo",value:function _decodeInfo(e){try{return JSON.parse(e);}catch(t){var o=require("x.crypt.js").AES.decodeString(e,this.SECRET_KEY);return JSON.parse(o);}}}]);return SomfyTokenManager;}(),xnm.aio.somfylocal.Box=/*#__PURE__*/function(){function SomfyBox(e){_classCallCheck(this,SomfyBox);this.excludeDeviceList=["Pod","ConfigurationComponent","NetworkComponent","ProtocolGateway","ConsumptionSensor","ElectricitySensor","OnOffHeatingSystem","Wifi","RemoteController","io:LightIOSystemDeviceSensor","io:RelativeHumidityIOSystemDeviceSensor","WeatherForecastSensor"];var t="xnm.aio.somfylocal.Box.".concat(e.pod);this._logger=xnm.aio.somfylocal.getLogger(t),this.somfyBoxInfo=e,this.HOST=e.ip,this.API_BASE="/enduser-mobile-web/1/enduserAPI",this.client=new xnm.aio.somfylocal.httpClient(this.HOST,null,!1,this.somfyBoxInfo.port),this.tokenHandler=new xnm.aio.somfylocal.TokenManager(this.somfyBoxInfo);}_createClass(SomfyBox,[{key:"executeCommandCreator",value:function(){var _executeCommandCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee11(e,t,o){return _regeneratorRuntime().wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:_context11.prev=0;_context11.next=3;return this._executeCommand(e,t);case 3:o(null);_context11.next=9;break;case 6:_context11.prev=6;_context11.t0=_context11["catch"](0);o(_context11.t0);case 9:case"end":return _context11.stop();}}},_callee11,this,[[0,6]]);}));function executeCommandCreator(_x4,_x5,_x6){return _executeCommandCreator.apply(this,arguments);}return executeCommandCreator;}()},{key:"getStatesCreator",value:function(){var _getStatesCreator=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee12(e,t,o){return _regeneratorRuntime().wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:_context12.prev=0;_context12.t0=o;_context12.next=4;return this._getStates(e,t);case 4:_context12.t1=_context12.sent;(0,_context12.t0)(null,_context12.t1);_context12.next=11;break;case 8:_context12.prev=8;_context12.t2=_context12["catch"](0);o(_context12.t2,null);case 11:case"end":return _context12.stop();}}},_callee12,this,[[0,8]]);}));function getStatesCreator(_x7,_x8,_x9){return _getStatesCreator.apply(this,arguments);}return getStatesCreator;}()},{key:"_executeCommand",value:function(){var _executeCommand2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee13(e,t){var o,n,_t2,a;return _regeneratorRuntime().wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:o=[];t.ext&&o.push(t.ext);n=t.value;_context13.t0=t.value;_context13.next=_context13.t0==="toggle"?6:_context13.t0==="setClosureAndLinearSpeed"?13:14;break;case 6:_context13.next=8;return this._getState(e.device.deviceURL,"core:OnOffState");case 8:_t2=_context13.sent;if(!(null==_t2)){_context13.next=11;break;}throw new Error("can not get the current state of ".concat(e.address));case 11:"on"==_t2?n="off":"off"==_t2&&(n="on");return _context13.abrupt("break",14);case 13:o.push("lowspeed");case 14:a={deviceURL:e.device.deviceURL,commands:[{name:n,parameters:o}]};return _context13.abrupt("return",this._execApply([a]));case 16:case"end":return _context13.stop();}}},_callee13,this);}));function _executeCommand(_x10,_x11){return _executeCommand2.apply(this,arguments);}return _executeCommand;}()},{key:"_getStates",value:function(){var _getStates2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee14(e,t){var _e3,o;return _regeneratorRuntime().wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:_context14.prev=0;_context14.next=3;return this._getSetup();case 3:_e3=_context14.sent;o=[];return _context14.abrupt("return",_e3&&_e3.devices&&_e3.devices.length?(t.forEach(function(t){var n=_e3.devices.find(function(e){return e.deviceURL==t.device.address;});if(!n)return void o.push({id:t.id,status:"no data"});if(!n.states||!n.states.length)return void o.push({id:t.id,status:"states empty"});var a=n.states.find(function(e){return e.name==t.status.value;});a?o.push({id:t.id,status:a.value}):o.push({id:t.id,status:"unknown"});}),o):(t.forEach(function(e){o.push({id:e.id,status:"error"});}),o));case 8:_context14.prev=8;_context14.t0=_context14["catch"](0);throw this._logger.log("error",_context14.t0.stack?_context14.t0.stack:_context14.t0),_context14.t0;case 11:case"end":return _context14.stop();}}},_callee14,this,[[0,8]]);}));function _getStates(_x12,_x13){return _getStates2.apply(this,arguments);}return _getStates;}()},{key:"_getState",value:function(){var _getState2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee15(e,t){var o,n;return _regeneratorRuntime().wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:_context15.prev=0;_context15.next=3;return this._getSetup();case 3:o=_context15.sent.devices.find(function(t){return t.deviceURL==e;});if(o){_context15.next=6;break;}throw new Error("can not find device ".concat(e));case 6:if(o.states){_context15.next=8;break;}throw new Error("".concat(e," does not have states"));case 8:n=o.states.find(function(e){return e.name==t;});if(n){_context15.next=11;break;}throw new Error("can not find state for ".concat(t," of ").concat(e));case 11:return _context15.abrupt("return",n.value);case 14:_context15.prev=14;_context15.t0=_context15["catch"](0);return _context15.abrupt("return",(this._logger.log("error","error in getting ".concat(t," of ").concat(e)),void this._logger.log("error",_context15.t0.stack?_context15.t0.stack:_context15.t0)));case 17:case"end":return _context15.stop();}}},_callee15,this,[[0,14]]);}));function _getState(_x14,_x15){return _getState2.apply(this,arguments);}return _getState;}()},{key:"listDevices",value:function(){var _listDevices=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee16(){var e,t,o,_e4,n,a;return _regeneratorRuntime().wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:_context16.next=2;return this._getSetup();case 2:e=_context16.sent;if(!(!e||!e.devices)){_context16.next=5;break;}throw new Error("get setup returns invalid format");case 5:t={devices:[]},o=e.devices;_e4=0;case 7:if(!(_e4<o.length)){_context16.next=17;break;}n=o[_e4];if(!(this.excludeDeviceList.includes(n.uiClass)||this.excludeDeviceList.includes(n.widget)||this.excludeDeviceList.includes(n.controllableName)||this.excludeDeviceList.includes(n.label)||this.excludeDeviceList.includes(n.protocol)||this.excludeDeviceList.includes(n.definition.uiClass)||this.excludeDeviceList.includes(n.definition.widgetName))){_context16.next=12;break;}this._logger.log("warn","excluded ".concat(JSON.stringify(n)));return _context16.abrupt("continue",14);case 12:a={sys:"somfylocal",name:n.label,address:n.deviceURL,placeOID:n.placeOID,type:this._uiClassToMediolaType(n.definition.uiClass),device:n};"not-supported"!=a.type?t.devices.push(a):this._logger.log("error","we do not support ".concat(JSON.stringify(n)));case 14:_e4++;_context16.next=7;break;case 17:return _context16.abrupt("return",t);case 18:case"end":return _context16.stop();}}},_callee16,this);}));function listDevices(){return _listDevices.apply(this,arguments);}return listDevices;}()},{key:"isReachable",value:function(){var _isReachable=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee17(){var _this4=this;var e;return _regeneratorRuntime().wrap(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:_context17.prev=0;_context17.next=3;return this._getInfos();case 3:e=_context17.sent;return _context17.abrupt("return",!!e.find(function(e){return e.gatewayId==_this4.somfyBoxInfo.pod;}));case 7:_context17.prev=7;_context17.t0=_context17["catch"](0);return _context17.abrupt("return",(this._logger.log("error",_context17.t0.stack?_context17.t0.stack:_context17.t0),!1));case 10:case"end":return _context17.stop();}}},_callee17,this,[[0,7]]);}));function isReachable(){return _isReachable.apply(this,arguments);}return isReachable;}()},{key:"_getInfos",value:function(){var _getInfos2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee18(){var e,t;return _regeneratorRuntime().wrap(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:e=this._getEndpointPath("/setup/gateways");_context18.next=3;return this.client.get(e,this._getHeaders()).then(function(e){return e.body;});case 3:t=_context18.sent;return _context18.abrupt("return",Array.isArray(t)?t:(this._logger.log("error","can not get infos, ".concat(JSON.stringify(t))),[]));case 5:case"end":return _context18.stop();}}},_callee18,this);}));function _getInfos(){return _getInfos2.apply(this,arguments);}return _getInfos;}()},{key:"_uiClassToMediolaType",value:function _uiClassToMediolaType(e){switch(e){case"OnOff":return"switch";case"Awning":case"ExteriorScreen":case"Pergola":case"Screen":case"Shutter":case"SwingingShutter":case"RollerShutter":case"VenetianBlind":case"ExteriorVenetianBlind":return"blind";case"Gate":case"GarageDoor":return"door";case"AirSensor":case"ContactSensor":case"HumiditySensor":case"LightSensor":case"RainSensor":case"Siren":case"SmokeSensor":case"TemperatureSensor":return"sensor";case"DoorLock":return"lock";case"HeatingSystem":return"heating";case"Light":return"light";case"Window":return"window";default:return"not-supported";}}},{key:"_execApply",value:function(){var _execApply2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee19(e){var t,o,n;return _regeneratorRuntime().wrap(function _callee19$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:t=this._getEndpointPath("/exec/apply"),o={actions:e},n=this.client.post(t,this._getHeaders(),JSON.stringify(o));return _context19.abrupt("return",(this._checkResponseAndThrowError(n),n.body));case 2:case"end":return _context19.stop();}}},_callee19,this);}));function _execApply(_x16){return _execApply2.apply(this,arguments);}return _execApply;}()},{key:"_getSetup",value:function(){var _getSetup2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee20(){var e,t;return _regeneratorRuntime().wrap(function _callee20$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:e=this._getEndpointPath("/setup");_context20.next=3;return this.client.get(e,this._getHeaders());case 3:t=_context20.sent;return _context20.abrupt("return",(this._checkResponseAndThrowError(t),t.body));case 5:case"end":return _context20.stop();}}},_callee20,this);}));function _getSetup(){return _getSetup2.apply(this,arguments);}return _getSetup;}()},{key:"_checkResponseAndThrowError",value:function _checkResponseAndThrowError(e){if(e&&e.statusCode&&(e.statusCode<200||e.statusCode>299)){var t=e.statusMessage;if(e.body)try{t=JSON.stringify(e.body);}catch(o){t=e.body;}var o=new Error(t);throw o.code=e.statusCode,o;}}},{key:"_getEndpointPath",value:function _getEndpointPath(e){return this.API_BASE+e;}},{key:"_getHeaders",value:function _getHeaders(){return{Authorization:"Bearer ".concat(this.somfyBoxInfo.token)};}},{key:"toJSON",value:function toJSON(){return this.somfyBoxInfo;}},{key:"equalsTo",value:function equalsTo(e){var _this$somfyBoxInfo,_e$somfyBoxInfo;return!!e&&e instanceof SomfyBox&&this.somfyBoxInfo.username==e.somfyBoxInfo.username&&this.somfyBoxInfo.password==e.somfyBoxInfo.password&&this.somfyBoxInfo.pod==e.somfyBoxInfo.pod&&((_this$somfyBoxInfo=this.somfyBoxInfo)===null||_this$somfyBoxInfo===void 0?void 0:_this$somfyBoxInfo.token)==((_e$somfyBoxInfo=e.somfyBoxInfo)===null||_e$somfyBoxInfo===void 0?void 0:_e$somfyBoxInfo.token);}}]);return SomfyBox;}(),xnm.aio.somfylocal.DeviceManagerErrorCodes={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.somfylocal.DeviceManagerError=/*#__PURE__*/function(_Error){_inherits(SomfyError,_Error);var _super=_createSuper(SomfyError);function SomfyError(e,t){var _this5;_classCallCheck(this,SomfyError);_this5=_super.call(this,t),_this5.name="SomfyLocalDMError",_this5.code=e;return _this5;}return _createClass(SomfyError);}(/*#__PURE__*/_wrapNativeSuper(Error)),xnm.aio.somfylocal.DM={Error:xnm.aio.somfylocal.DeviceManagerError,ErrorCodes:xnm.aio.somfylocal.DeviceManagerErrorCodes,Logger:xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.Dm"),SYS:"somfylocal",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Somfy"}];},createGateway:function createGateway(e,t,o){var _this6=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee21(){var _t3,_o,_o2,n;return _regeneratorRuntime().wrap(function _callee21$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:_context21.prev=0;if(!(e.discovery&&e.ip&&e.pod)){_context21.next=3;break;}return _context21.abrupt("return",(e.discovery=!1,void o(null,e)));case 3:_t3=new xnm.aio.somfylocal.TokenManager(e);if(!(_this6._validateBoxInfo(e),!e.token||!e.tokenLabel)){_context21.next=11;break;}_context21.next=7;return _t3.getValidBoxInfo();case 7:_o=_context21.sent;if(_o){_context21.next=10;break;}throw new _this6.Error(_this6.ErrorCodes.INVALID,"can not get token");case 10:e=_o;case 11:if(!e.ip){_context21.next=16;break;}if(xnm.aio.somfylocal.Utils._isIP(e.ip)){_context21.next=14;break;}throw new _this6.Error("invalid ip");case 14:_context21.next=20;break;case 16:_context21.next=18;return _t3.getIP(2e4);case 18:_o2=_context21.sent;e.ip=_o2;case 20:n=new xnm.aio.somfylocal.Box(e);_context21.next=23;return n.isReachable();case 23:if(_context21.sent){_context21.next=25;break;}return _context21.abrupt("return",void o(new _this6.Error(_this6.ErrorCodes.NOT_FOUND,"gateway is not reachable")));case 25:_this6.Logger.log("debug","gateway is created for ".concat(e.pod)),o(null,e);_context21.next=31;break;case 28:_context21.prev=28;_context21.t0=_context21["catch"](0);_this6._handleError(_context21.t0,o);case 31:case"end":return _context21.stop();}}},_callee21,null,[[0,28]]);}))();},updateGateway:function updateGateway(e,t,o,n){var _this7=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee22(){var _o3,_e6,_e5,a;return _regeneratorRuntime().wrap(function _callee22$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:_context22.prev=0;_this7._validateBoxInfo(t);_o3=new xnm.aio.somfylocal.TokenManager(t);if(!(e.username==t.username&&e.password==t.password)){_context22.next=30;break;}_context22.next=6;return _o3.isValid();case 6:_context22.t0=_context22.sent;_context22.t1="invalid"==_context22.t0;if(!_context22.t1){_context22.next=11;break;}_context22.next=11;return _this7._updateTokenAndIP(t,_o3);case 11:if(!t.ip){_context22.next=16;break;}if(xnm.aio.somfylocal.Utils._isIP(t.ip)){_context22.next=14;break;}throw new _this7.Error("invalid ip");case 14:_context22.next=20;break;case 16:_context22.next=18;return _o3.getIP(2e4);case 18:_e6=_context22.sent;t.ip=_e6;case 20:_this7.Logger.log("debug","gateway is updated for ".concat(t.pod," with the same email and pass"));_e5=new xnm.aio.somfylocal.Box(t);_context22.next=24;return _e5.isReachable();case 24:if(!_context22.sent){_context22.next=28;break;}_context22.t2=void n(null,t);_context22.next=29;break;case 28:_context22.t2=void n(new _this7.Error(_this7.ErrorCodes.NOT_FOUND,"gateway is not reachable"));case 29:return _context22.abrupt("return",_context22.t2);case 30:if(!(e.pod!=t.pod)){_context22.next=32;break;}throw new _this7.Error(_this7.ErrorCodes.INVALID,"pod should not be changed");case 32:_context22.next=34;return _this7._updateTokenAndIP(t,_o3);case 34:_this7.Logger.log("debug","gateway is updated for ".concat(t.pod));a=new xnm.aio.somfylocal.Box(t);_context22.next=38;return a.isReachable();case 38:if(_context22.sent){_context22.next=40;break;}return _context22.abrupt("return",void n(new _this7.Error(_this7.ErrorCodes.NOT_FOUND,"gateway is not reachable")));case 40:n(null,t);_context22.next=46;break;case 43:_context22.prev=43;_context22.t3=_context22["catch"](0);_this7._handleError(_context22.t3,n);case 46:case"end":return _context22.stop();}}},_callee22,null,[[0,43]]);}))();},_updateTokenAndIP:function _updateTokenAndIP(e,t){var _this8=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee23(){var o,n;return _regeneratorRuntime().wrap(function _callee23$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:_context23.next=2;return t.getValidBoxInfo();case 2:o=_context23.sent;if(o){_context23.next=5;break;}throw new _this8.Error(_this8.ErrorCodes.INVALID,"can not get token during updating the info");case 5:e=o,_this8.Logger.log("debug","token of ".concat(e.pod," is updated"));_context23.next=8;return t.getIP(2e4);case 8:n=_context23.sent;e.ip=n;case 10:case"end":return _context23.stop();}}},_callee23);}))();},deleteGateway:function deleteGateway(e,t,o){var _this9=this;return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee24(){var _t4;return _regeneratorRuntime().wrap(function _callee24$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:_context24.prev=0;_t4=new xnm.aio.somfylocal.TokenManager(e);_context24.next=4;return _t4.deleteToken();case 4:o();_context24.next=10;break;case 7:_context24.prev=7;_context24.t0=_context24["catch"](0);_this9.Logger.log("error",_context24.t0),o();case 10:case"end":return _context24.stop();}}},_callee24,null,[[0,7]]);}))();},createDevice:function createDevice(e,t,o){o(null,e);},updateDevice:function updateDevice(e,t,o){o(null,e);},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t){var o=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var o=!1,n=0;n<e.length;n++){if(e[n]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var n=[],a=null,s=o.getCommandStatusMap(e);return s&&(a=function(e,t,o){var n=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(s,0,t),n=n.concat(a)),n;};if(!e||null==e.type||void 0===e.type)return null;var n=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),n.command=a;break;case"status":a=_filter(e,t),n.status=a;break;default:return null;}return a&&a.length?n:null;},getCommandStatusMap:function getCommandStatusMap(e){try{if(!e||!e.device||!e.device.definition)return this.Logger.log("error","anomaly, invalid device ".concat(JSON.stringify(e))),null;var t={command:[],status:[]},o=e.device.definition,n=xnm.aio.somfylocal.Devices;switch(o.uiClass){case"Awning":case"ExteriorScreen":case"Pergola":case"Screen":case"Shutter":case"SwingingShutter":case"Window":o.uiClass="RollerShutter";break;case"Gate":o.uiClass="GarageDoor";}var a=n[o.uiClass];if(a&&this._insertCommandsAndStatuses(o,a,t),o.widgetName){var _e7=a[o.widgetName];_e7&&this._insertCommandsAndStatuses(o,_e7,t);}return t;}catch(e){return this.Logger.log("error",e.stack?e.stack:e),null;}},_insertCommandsAndStatuses:function _insertCommandsAndStatuses(e,t,o){e.commands&&e.commands.length>0&&t.commands.forEach(function(t){!function _ifCommandExistInsert(t){e.commands.find(function(e){return e.commandName==t.ref.value;})&&(o.command.find(function(e){return e.name==t.name;})||o.command.push(t));if("toggle"==t.ref.value){e.states.find(function(e){return"core:OnOffState"==e.name;})&&o.command.push(t);}}(t);}),e.states&&e.states.length>0&&t.statuses.forEach(function(t){!function _ifStateExistInsert(t){e.states.find(function(e){return e.name==t.ref.value;})&&(o.status.find(function(e){return e.name==t.name;})||o.status.push(t));if(t.ref.somfy_values&&Array.isArray(t.ref.somfy_values)){t.ref.somfy_values.forEach(function(n){if(e.states.find(function(e){return e.name==n;})&&!o.status.find(function(e){return e.name==t.name;})){var _e8=JSON.parse(JSON.stringify(t));_e8.ref.value=n,o.status.push(_e8);}});}}(t);});},_validateBoxInfo:function _validateBoxInfo(e){if(!e)throw new this.Error(this.ErrorCodes.INVALID,"info is invalid");if(!e.username)throw new this.Error(this.ErrorCodes.INVALID,"username is invalid");if(!e.password)throw new this.Error(this.ErrorCodes.INVALID,"password is invalid");if(!e.pod)throw new this.Error(this.ErrorCodes.INVALID,"pod is invalid");e.pod=e.pod.trim();},_handleError:function _handleError(e,t){console&&console.log&&console.log(e),e.code?t(e,null):t(new this.Error(this.ErrorCodes.UNKNOWN,e.message?e.message:"unknown error"),null);},supportSmartWidget:function supportSmartWidget(e){return!(!e||!e.type||"not-supported"===e.type);},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,o,n,a){if(!t||!t.type||"not-supported"===t.type)return null;var s=this.getCommandStatusMap(t);if(!s)return null;var r={},i={},l=[t.type];"blind"===t.type?l.push("shutter"):"heating"===t.type?l.push("thermostat"):"light"===t.type&&l.push("dimmer","switch");var c={blind:{down:"moveDown",position:"moveTo",up:"moveUp"},heating:{auto:"thermoAuto"},light:{brightness:"dimTo"},"switch":{"on for":"onFor"}},u={blind:{position:"blindState"},"switch":{state:"switchState"}};return s.command.forEach(function(e){var _c$t$type;var o=((_c$t$type=c[t.type])===null||_c$t$type===void 0?void 0:_c$t$type[e.name])||e.name;r["%".concat(o,"%")]=e.ref,"light"===t.type&&("on"===o?r["%dimOn%"]=e.ref:"off"===o&&(r["%dimOff%"]=e.ref));}),s.status.forEach(function(e){var _u$t$type;var o=((_u$t$type=u[t.type])===null||_u$t$type===void 0?void 0:_u$t$type[e.name])||e.name;i["%".concat(o,"%")]=e.ref,"blindState"===o&&(i["%shutterState%"]=e.ref);}),e._injectToSmartWidgetTemplate(n,l,a,r,i,null);}},xnm.aio.somfylocal.Handler=/*#__PURE__*/function(){function SomfyHandler(){_classCallCheck(this,SomfyHandler);this.TokenManager=xnm.aio.somfylocal.TokenManager,this.Box=xnm.aio.somfylocal.Box,this.devicemanager=xnm.aio.somfylocal.DM,this.Utils=xnm.aio.somfylocal.Utils;this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.Handler");}_createClass(SomfyHandler,[{key:"registModule",value:function registModule(e){e.register(this.devicemanager.SYS,"somfylocal");}},{key:"resolveGateway",value:function resolveGateway(e){if(!(e&&e.username&&e.password&&e.pod&&e.token&&e.ip)){var t=JSON.parse(JSON.stringify(e));return t.username=t.username&&"*****",t.password=t.password&&"*****",t.token=t.token&&"*****",this._logger.log("warn","cannot resolve gateway, return null due to invalid gateway json ".concat(JSON.stringify(t))),null;}return new this.Box(e);}},{key:"getDeviceList",value:function getDeviceList(e,t){var _this10=this;var o=this.resolveGateway(e);o?o.listDevices().then(function(e){t&&t(null,e);})["catch"](function(e){_this10._logger.log("error",e.stack?e.stack:e),t&&t(e,null);}):t&&t(new Error("gateway json format invalid"));}},{key:"discoverWithTimeout",value:function discoverWithTimeout(e,t){var _this11=this;var o=require("x.mdns.js");o.clearRecordBuffer();var n="_kizboxdev._tcp.local",a=[];o.discoverServiceWithTimeout(n,e,function(e,s){if(e)t(e);else{try{_this11._logger.log("debug","results of mdns : ".concat(JSON.stringify(s)));}catch(e){}for(var _e9=0;_e9<s.length;_e9++){var _t5=s[_e9];var _o4="",_n="";_t5.ip&&_t5.ip.length>0&&xnm.aio.somfylocal.Utils._isIP(_t5.ip[0])&&(_o4=_t5.ip[0]),_t5.info&&_t5.info.gateway_pin&&(_n=_t5.info.gateway_pin),_o4&&_n&&a.push({sys:"somfylocal",ip:_o4,port:8443,pod:_n,discovery:!0,name:"pod ".concat(_n.slice(-4))});}o.stopDiscover(n,function(e){_this11._logger.log("error",e);}),t(null,a);}});}}]);return SomfyHandler;}(),xnm.aio.somfylocal.Utils={_isIP:function _isIP(e){return /^(?!0)(?!.*\.$)((1?\d?\d|25[0-5]|2[0-4]\d)(\.|$)){4}$/.test(e);}},xnm.aio.somfylocal.httpClient=/*#__PURE__*/function(){function SomfyHttpClient(e,t,o,n){_classCallCheck(this,SomfyHttpClient);this.port=443,this.REQUESTS_TIMEOUT_MS=1e4,this.rejectUnauthorized=!1,this.host=e,t&&"number"==typeof t&&(this.REQUESTS_TIMEOUT_MS=t),null!=o&&"boolean"==typeof o&&(this.rejectUnauthorized=o),n&&"number"==typeof n&&(this.port=n),this._logger=xnm.aio.somfylocal.getLogger("xnm.aio.somfylocal.httpClient"),!this._logger&&console&&console.log&&(this._logger=console);}_createClass(SomfyHttpClient,[{key:"get",value:function(){var _get=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee25(e,t,o){var _this12=this;return _regeneratorRuntime().wrap(function _callee25$(_context25){while(1){switch(_context25.prev=_context25.next){case 0:return _context25.abrupt("return",new Promise(function(n,a){_this12._doRequest("GET",e,t,o,function(e,t){e&&a(e),n(t);});}));case 1:case"end":return _context25.stop();}}},_callee25);}));function get(_x17,_x18,_x19){return _get.apply(this,arguments);}return get;}()},{key:"post",value:function(){var _post=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee26(e,t,o){var _this13=this;return _regeneratorRuntime().wrap(function _callee26$(_context26){while(1){switch(_context26.prev=_context26.next){case 0:return _context26.abrupt("return",new Promise(function(n,a){_this13._doRequest("POST",e,t,o,function(e,t){e&&a(e),n(t);});}));case 1:case"end":return _context26.stop();}}},_callee26);}));function post(_x20,_x21,_x22){return _post.apply(this,arguments);}return post;}()},{key:"put",value:function(){var _put=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee27(e,t,o){var _this14=this;return _regeneratorRuntime().wrap(function _callee27$(_context27){while(1){switch(_context27.prev=_context27.next){case 0:return _context27.abrupt("return",new Promise(function(n,a){_this14._doRequest("PUT",e,t,o,function(e,t){e&&a(e),n(t);});}));case 1:case"end":return _context27.stop();}}},_callee27);}));function put(_x23,_x24,_x25){return _put.apply(this,arguments);}return put;}()},{key:"patch",value:function(){var _patch=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee28(e,t,o){var _this15=this;return _regeneratorRuntime().wrap(function _callee28$(_context28){while(1){switch(_context28.prev=_context28.next){case 0:return _context28.abrupt("return",new Promise(function(n,a){_this15._doRequest("PATCH",e,t,o,function(e,t){e&&a(e),n(t);});}));case 1:case"end":return _context28.stop();}}},_callee28);}));function patch(_x26,_x27,_x28){return _patch.apply(this,arguments);}return patch;}()},{key:"delete",value:function(){var _delete2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee29(e,t,o){var _this16=this;return _regeneratorRuntime().wrap(function _callee29$(_context29){while(1){switch(_context29.prev=_context29.next){case 0:return _context29.abrupt("return",new Promise(function(n,a){_this16._doRequest("DELETE",e,t,o,function(e,t){e&&a(e),n(t);});}));case 1:case"end":return _context29.stop();}}},_callee29);}));function _delete(_x29,_x30,_x31){return _delete2.apply(this,arguments);}return _delete;}()},{key:"_doRequest",value:function _doRequest(e,t,o,n,a){var s={host:this.host,port:this.port,path:t,method:e,family:4,timeout:this.REQUESTS_TIMEOUT_MS,headers:{Connection:"close","Content-Type":"application/json","User-Agent":"Mediola"},rejectUnauthorized:this.rejectUnauthorized};if(o)for(var _e10 in o){o.hasOwnProperty(_e10)&&(s.headers[_e10]=o[_e10]);}n&&n.length&&(s.headers["Content-Length"]=n.length),this._logger.log("debug","call on ".concat(t));var r=require("https"),i=this,l=a;var c=r.request(s,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var o=(e===null||e===void 0?void 0:e.statusCode)>399?"error":"debug";i._logger.log(o,"receive code:"+e.statusCode+" response:"+t);try{t=JSON.parse(t),e.body=t;}catch(t){e.body=t.message;}l&&(l(null,e),l=null);});});c.on&&c.on("error",function(e){i._logger.log("error","do request error:"+e.message),l&&(l(e),l=null);}),c.setTimeout&&c.setTimeout(this.REQUESTS_TIMEOUT_MS,function(){i._logger.log("error","do request timeout"),c.abort(),l&&(l(new Error("timeout")),l=null);}),n&&c.write(n),c.end();}}]);return SomfyHttpClient;}(),xnm.aio.somfylocal.Devices={OnOff:{commands:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",unit:"s",extMeta:"60-600",value_t:"on_for"}}],statuses:[{type:"enum",name:"state",ref:{value:"core:OnOffState",value_t:"state",options:["on","off"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},RollerShutter:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"int",name:"position",ref:{value:"setClosure",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"enum",name:"identify",ref:{value:"identify"}}],statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}],PositionableRollerShutterWithLowSpeedManagement:{commands:[{type:"int",name:"position slowly",ref:{value:"setClosureAndLinearSpeed",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position_silentmode"}}],statuses:[]}},AirSensor:{commands:[],statuses:[{type:"int",name:"co2",ref:{value:"core:CO2ConcentrationState",value_t:"co2"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},ContactSensor:{commands:[],statuses:[{type:"enum",name:"state",ref:{value:"core:ContactState",value_t:"state",options:["closed","open","tilt"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},DoorLock:{commands:[{type:"enum",name:"lock",ref:{value:"setLockedUnlocked",value_t:"lock",ext:"locked"}},{type:"enum",name:"unlock",ref:{value:"setLockedUnlocked",value_t:"unlock",ext:"unlocked"}}],statuses:[{type:"int",name:"state",ref:{value:"core:LockedUnlockedState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},GarageDoor:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}}],statuses:[{type:"int",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",somfy_values:["core:OpenClosedPedestrianState","core:OpenClosedUnknownState","core:OpenClosedPartialState"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},HeatingSystem:{commands:[{type:"enum",name:"auto",ref:{value:"auto"}},{type:"enum",name:"heat",ref:{value:"heat"}},{type:"enum",name:"cool",ref:{value:"cool"}},{type:"enum",name:"off",ref:{value:"off"}}],statuses:[{type:"int",name:"temperature",ref:{value:"core:TemperatureState",value_t:"temperature",somfy_values:["core:TargetTemperatureState"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},HumiditySensor:{commands:[],statuses:[{type:"int",name:"humidity",ref:{value:"core:RelativeHumidityState",value_t:"humidity"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},Light:{commands:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",unit:"s",extMeta:"60-600",value_t:"on_for"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"int",name:"brightness",ref:{value:"setIntensity",ext:"%d",unit:"%",extMeta:"0-100",value_t:"brightness"}}],statuses:[{type:"enum",name:"state",ref:{value:"core:OnOffState",value_t:"state",options:["on","off"]}},{type:"int",name:"brightness",ref:{value:"core:IntensityState",value_t:"brightness",somfy_values:["core:LightIntensityState"]}},{type:"enum",name:"hue",ref:{value:"core:ColorHueState",value_t:"hue"}},{type:"int",name:"saturation",ref:{value:"core:ColorSaturationState",value_t:"saturation"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},LightSensor:{commands:[],statuses:[{type:"int",name:"lightLevel",ref:{value:"core:LuminanceState",value_t:"lightLevel"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},OccupancySensor:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:OccupancyState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},RainSensor:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:RainState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},Siren:{commands:[],statuses:[{type:"int",name:"state",ref:{value:"core:OnOffState",value_t:"state"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},SmokeSensor:{commands:[],statuses:[{type:"int",name:"smoke",ref:{value:"core:SmokeState",value_t:"smoke"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},TemperatureSensor:{commands:[],statuses:[{type:"int",name:"temperature",ref:{value:"core:TemperatureState",value_t:"temperature"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},VenetianBlind:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}}],statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"int",name:"angle",ref:{value:"core:SlateOrientationState",value_t:"angle"}},{type:"enum",name:"movement",ref:{value:"core:MovingState",options:["true","false"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},VentilationSystem:{commands:[{type:"enum",name:"mode",ref:{value:"setAirDemandMode",value_t:"mode",options:["auto","boost"]}}],statuses:[{type:"int",name:"mode",ref:{value:"io:AirDemandModeState",value_t:"mode"}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]},ExteriorVenetianBlind:{commands:[{type:"enum",name:"open",ref:{value:"open"}},{type:"enum",name:"close",ref:{value:"close"}},{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"enum",name:"my",ref:{value:"my"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"int",name:"position",ref:{value:"setPosition",ext:"%d",unit:"%",extMeta:"0-100",value_t:"position"}},{type:"int",name:"angle",ref:{value:"setOrientation",ext:"%d",value_t:"angle"}}],statuses:[{type:"int",name:"position",ref:{value:"core:ClosureState",value_t:"position"}},{type:"enum",name:"state",ref:{value:"core:OpenClosedState",value_t:"state",options:["closed","open"]}},{type:"int",name:"angle",ref:{value:"core:SlateOrientationState",value_t:"angle"}},{type:"enum",name:"movement",ref:{value:"core:MovingState",options:["true","false"]}},{type:"enum",name:"connectivity",ref:{value:"core:StatusState",value_t:"connectivity"}}]}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.somfylocal.Handler());