var x=x||{};x.hub=x.hub||{},x.hub.password=x.hub.password||{},x.hub.password.PasswordManager=function(){var PM=function PM(){this._logger=require("x.logger.js").getLogger("x.hub.password.PasswordManager"),this._fileManager=null,this._pinHash=null,this._secureClients={},this._passwords={gateways:{},devices:{}};};return PM.PASSWORDS_FILE_NAME="passwords.enc",PM.MAX_SECURE_CLIENT_COUNT=5,PM.prototype.init=function(e,r){this._fileManager=e,this._pinHash=localStorage.getItem("x.hub.Server.pin");var s=require("path"),t=e.getUserRootDataPath();this._dataFolder=s.resolve(t,"db_v6"),this._loadPasswordsDB(function(e){r&&r(e);});},PM.prototype.setPin=function(e,r){return!!this.checkPin(e)&&!!r&&(this._pinHash=this._hashPin(r),localStorage.setItem("x.hub.Server.pin",this._pinHash),!0);},PM.prototype.checkPin=function(e){return!!e&&this._hashPin(e)==(this._pinHash?this._pinHash:this._hashPin("0000"));},PM.prototype.reset=function(){if(this._pinHash=null,this._fileManager){var e=require("fs"),r=require("fs-extra"),s=require("path"),t=this._fileManager.getUserRootDataPath(),i=s.join(t,"localstorage","x.hub.Server.pin");e.existsSync(i)&&(this._logger.log("trace","remove file "+i),r.removeSync(i));}},PM.prototype._hashPin=function(e){return require("x.crypt.js").MD5(e+"_SALT!");},PM.prototype.addSecureClient=function(e,r,s){if(e){var t=0,i=null,n=null,o=null;for(var a in this._secureClients){a!=e&&(o=this._secureClients[a])&&o.lastAccess?(t++,n?o.lastAccess<i&&(n=a,i=o.lastAccess):(n=a,i=o.lastAccess)):delete this._secureClients[a];}t>=PM.MAX_SECURE_CLIENT_COUNT&&delete this._secureClients[n];var u=require("crypto"),l=require("x.crypt.js"),c=u.randomBytes(32).toString("hex"),d=new Buffer(l.Curve25519.curve25519(c)).toString("hex"),p=l.Curve25519.curve25519(c,r),h=p.slice(0,16),_=p.slice(16,32),f=u.randomBytes(16).toString("hex");this._secureClients[e]={token:f,key:h,iv:_,lastAccess:null},s&&s(null,this._secureClients[e],d);}else s&&s(new Error("invalid client ip"));},PM.prototype.decodeSecureReq=function(e,r,s){if(e){if(this._secureClients[e]){if(r.body){var t=this._secureClients[e],i=require("x.crypt.js");i.AES.setSize(128);var n=i.AES.decrypt(i.AES.h2a(r.body),t.key,t.iv,!1),o=i.AES.a2s(n);if(o.length<32)s&&s(new Error("invalid secure request"));else if(o.substr(0,32)==t.token){var a=o.substr(32),u=require("url").parse(a);if(r.method="GET",r.url=a,u.pathname&&(r.path=u.pathname),u.query){var l=require("querystring");r.query=l.parse(u.query);}s&&s(null,r);}else s&&s(new Error("unknown client token"));}else s&&s(new Error("invalid secure request"));}else s&&s(new Error("unknown client ip"));}else s&&s(new Error("invalid client ip"));},PM.prototype.encodeSecureRsp=function(e,r,s){if(e){if(this._secureClients[e]){if(r){var t=this._secureClients[e],i=require("x.crypt.js");i.AES.setSize(128);var n=new Buffer(r,"utf8"),o=(Array.prototype.slice.call(n),i.AES.encrypt(i.AES.s2a(r),t.key,t.iv));s&&s(null,i.AES.a2h(o));}else s&&s(null,r);}else s&&s(new Error("unknown client ip"));}else s&&s(new Error("invalid client ip"));},PM.prototype.getDevicePassword=function(e){return e?this._passwords.devices[e]:null;},PM.prototype.checkDevicePassword=function(e,r){if(!e)return"invalid device id";var s=this._passwords.devices[e];return null==s||null==s?"no pass found for device ".concat(e):s!=r?"check failed":null;},PM.prototype.setDevicePassword=function(e,r,s){e?(!r&&this._passwords.devices[e]?delete this._passwords.devices[e]:this._passwords.devices[e]=r,this._writePasswordsDB(function(e){s&&s(e);})):s&&s(new Error("invalid device id"));},PM.prototype._loadPasswordsDB=function(e){var r=require("fs-extra"),s=this._getPasswordsFile(),t=this;r.ensureFile(s,function(r){if(r)return t._logger.log("error","[ensureFile] ".concat(r)),void e(r);t._loadPasswordFile(function(r,s){if(r)return t._passwords={gateways:{},devices:{}},t._logger.log("error","[_loadPasswordFile] ".concat(r)),void e(r);t._passwords=s||{gateways:{},devices:{}},e();});});},PM.prototype._writePasswordsDB=function(e){this._writePasswordsFile(this._passwords,function(r){e(r);});},PM.prototype._getPasswordsFile=function(){return require("path").resolve(this._dataFolder,PM.PASSWORDS_FILE_NAME);},PM.prototype._loadPasswordFile=function(e){var r=require("fs"),s=this._getPasswordsFile(),t=this;r.readFile(s,"utf8",function(r,s){if(r)e(r);else if(s)try{s=require("x.crypt").AES.decodeString(s,t._ml_v1_info());var i=JSON.parse(s);e(null,i);}catch(s){t._logger.log("error","[readFile] ".concat(r)),e(s,null);}else e(null,"");});},PM.prototype._writePasswordsFile=function(e,r){var s=require("fs"),t=require("x.crypt.js"),i=this._getPasswordsFile();try{var n=t.AES.encodeString(JSON.stringify(e),this._ml_v1_info());s.writeFile(i,n,function(e){r&&r(e);});}catch(e){self._logger.log("error","[_writePasswordsFile] ".concat(e)),r&&r(e);}},PM.prototype._ml_v1_info=function(){return require("x.crypt").SHA1("0cc6c6df12537fc79522a1ac15f1f592e93fdeb3");},PM;}(),x.hub.password.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.password.Handler"),this._passwordManager=new x.hub.password.PasswordManager();};return Handler.prototype.init=function(e,r){this._initHttpApi(),this._passwordManager.init(e,function(e){e&&r&&r(e);});},Handler.prototype._initHttpApi=function(){var e=this;require("x.hub.js").getServer().addRoute("/pwd",{method:"GET",source:1,lock:1},function(r,s,t){var i=r.query?r.query.pin:null,n=r.query?r.query.dev:null;i&&(e.checkPin(i)?s.json({XC_SUC:{}}):s.json({XC_ERR:{code:"000003",msg:"check failed"}}));if(n){var o=r.query?r.query.v:null,a=r.query?r.query.c:null;if(null==o&&null==o){if(a){var u=e._passwordManager.checkDevicePassword(n,a);return null==u?s.json({XC_SUC:{}}):s.json({XC_ERR:{code:"000003",msg:u}});}return s.json({XC_ERR:{code:"000005",msg:"cannot handle your request"}});}e._passwordManager.setDevicePassword(n,o,function(e){e?s.json({XC_ERR:{code:"000005",msg:e.toString()}}):s.json({XC_SUC:{}});});}else s.json({XC_ERR:{code:"000005",msg:"invalid parameter"}});});},Handler.prototype.checkPin=function(e){return this._passwordManager.checkPin(e);},Handler.prototype.setPin=function(e,r){return this._passwordManager.setPin(e,r);},Handler.prototype.reset=function(e){this._passwordManager.reset(),e&&e();},Handler.prototype.registSecureClient=function(e,r,s){this._passwordManager.addSecureClient(e,r,function(e,r,t){if(e)s&&s(e);else{var i=require("x.crypt.js");i.AES.setSize(128);var n=i.AES.encrypt(i.AES.h2a(r.token),r.key,r.iv);n=i.AES.a2h(n),s&&s(null,{key:t,token:n});}});},Handler.prototype.decodeSecureReq=function(e,r,s){this._passwordManager.decodeSecureReq(e,r,function(e,r){s&&s(e,r);});},Handler.prototype.encodeSecureRsp=function(e,r,s){this._passwordManager.encodeSecureRsp(e,r,function(e,r){s&&s(e,r);});},Handler;}(),module.exports=new x.hub.password.Handler();