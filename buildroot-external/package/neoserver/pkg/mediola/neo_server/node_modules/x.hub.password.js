var x=x||{};x.hub=x.hub||{},x.hub.password=x.hub.password||{},x.hub.password.PasswordManager=function(){var PM=function PM(){this._logger=require("x.logger.js").getLogger("x.hub.password.PasswordManager"),this._fileManager=null,this._pinHash=null,this._secureClients={};};return PM.MAX_SECURE_CLIENT_COUNT=5,PM.prototype.init=function(e,r){this._fileManager=e,this._pinHash=localStorage.getItem("x.hub.Server.pin"),r&&r();},PM.prototype.setPin=function(e,r){return!!this.checkPin(e)&&!!r&&(this._pinHash=this._hashPin(r),localStorage.setItem("x.hub.Server.pin",this._pinHash),!0);},PM.prototype.checkPin=function(e){return!!e&&this._hashPin(e)==(this._pinHash?this._pinHash:this._hashPin("0000"));},PM.prototype.reset=function(){if(this._pinHash=null,this._fileManager){var e=require("fs"),r=require("fs-extra"),t=require("path"),n=this._fileManager.getUserRootDataPath(),s=t.join(n,"localstorage","x.hub.Server.pin");e.existsSync(s)&&(this._logger.log("trace","remove file "+s),r.removeSync(s));}},PM.prototype._hashPin=function(e){return require("x.crypt.js").MD5(e+"_SALT!");},PM.prototype.addSecureClient=function(e,r,t){if(e){var n=0,s=null,i=null,o=null;for(var a in this._secureClients){a!=e&&(o=this._secureClients[a])&&o.lastAccess?(n++,i?o.lastAccess<s&&(i=a,s=o.lastAccess):(i=a,s=o.lastAccess)):delete this._secureClients[a];}n>=PM.MAX_SECURE_CLIENT_COUNT&&delete this._secureClients[i];var u=require("crypto"),c=require("x.crypt.js"),l=u.randomBytes(32).toString("hex"),p=new Buffer(c.Curve25519.curve25519(l)).toString("hex"),h=c.Curve25519.curve25519(l,r),d=h.slice(0,16),f=h.slice(16,32),_=u.randomBytes(16).toString("hex");this._secureClients[e]={token:_,key:d,iv:f,lastAccess:null},t&&t(null,this._secureClients[e],p);}else t&&t(new Error("invalid client ip"));},PM.prototype.decodeSecureReq=function(e,r,t){if(e){if(this._secureClients[e]){if(r.body){var n=this._secureClients[e],s=require("x.crypt.js");s.AES.setSize(128);var i=s.AES.decrypt(s.AES.h2a(r.body),n.key,n.iv,!1),o=s.AES.a2s(i);if(o.length<32)t&&t(new Error("invalid secure request"));else if(o.substr(0,32)==n.token){var a=o.substr(32),u=require("url").parse(a);if(r.method="GET",r.url=a,u.pathname&&(r.path=u.pathname),u.query){var c=require("querystring");r.query=c.parse(u.query);}t&&t(null,r);}else t&&t(new Error("unknown client token"));}else t&&t(new Error("invalid secure request"));}else t&&t(new Error("unknown client ip"));}else t&&t(new Error("invalid client ip"));},PM.prototype.encodeSecureRsp=function(e,r,t){if(e){if(this._secureClients[e]){if(r){var n=this._secureClients[e],s=require("x.crypt.js");s.AES.setSize(128);var i=new Buffer(r,"utf8"),o=(Array.prototype.slice.call(i),s.AES.encrypt(s.AES.s2a(r),n.key,n.iv));t&&t(null,s.AES.a2h(o));}else t&&t(null,r);}else t&&t(new Error("unknown client ip"));}else t&&t(new Error("invalid client ip"));},PM;}(),x.hub.password.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.password.Handler"),this._passwordManager=new x.hub.password.PasswordManager();};return Handler.prototype.init=function(e,r){this._initHttpApi(),this._passwordManager.init(e,function(e){e&&r(e);});},Handler.prototype._initHttpApi=function(){var e=this;require("x.hub.js").getServer().addRoute("/pwd",{method:"GET",source:1,lock:1},function(r,t,n){var s=r.query?r.query.pin:null;s?e.checkPin(s)?t.json({XC_SUC:{}}):t.json({XC_ERR:{code:"000003",msg:"check failed"}}):t.json({XC_ERR:{code:"000005",msg:"invalid parameter"}});});},Handler.prototype.checkPin=function(e){return this._passwordManager.checkPin(e);},Handler.prototype.setPin=function(e,r){return this._passwordManager.setPin(e,r);},Handler.prototype.reset=function(e){this._passwordManager.reset(),e&&e();},Handler.prototype.registSecureClient=function(e,r,t){this._passwordManager.addSecureClient(e,r,function(e,r,n){if(e)t&&t(e);else{var s=require("x.crypt.js");s.AES.setSize(128);var i=s.AES.encrypt(s.AES.h2a(r.token),r.key,r.iv);i=s.AES.a2h(i),t&&t(null,{key:n,token:i});}});},Handler.prototype.decodeSecureReq=function(e,r,t){this._passwordManager.decodeSecureReq(e,r,function(e,r){t&&t(e,r);});},Handler.prototype.encodeSecureRsp=function(e,r,t){this._passwordManager.encodeSecureRsp(e,r,function(e,r){t&&t(e,r);});},Handler;}(),module.exports=new x.hub.password.Handler();