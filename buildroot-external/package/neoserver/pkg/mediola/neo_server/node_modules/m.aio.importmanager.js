var m=m||{};m.aio=m.aio||{},m.aio.importmanager=m.aio.importmanager||{},m.aio.importmanager.Manager=function(){var Manager=function Manager(e){this._appname=e,this._appname||(this._appname="iqontrolpro");};return Manager.prototype.setAppName=function(e){this._appname=e;},Manager.prototype.importSteckerPRO=function(e,r,n,t){var _contains=function _contains(e,r){for(var n=0;n<e.length;n++){if(e[n]===r)return!0;}return!1;},o=require("m.aio.configmanager.js"),a=o.LicenseManager;o.trace("/config/tenants/"+e,function(o,i){if(o)t&&t(o);else if(i&&i.license){var s;if(a.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"brennenstuhl"},i.license))s="brennenstuhl";else if(a.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"intertechno"},i.license))s="intertechno";else{if(!a.permitFeature("read",{sys:"hcgw",ip:"127.0.0.1",vendor:"hc"},i.license))return void(t&&t(new Error("license do not have hcgw module")));s="hc";}var c=function(e,r){var n={rooms:[],devices:[],gateways:[]};try{var t,o,a=$($.parseXML(r)),i=a.find("gateway");if(i&&i.length>0)for(t=0;t<i.length;t++){var s=i[t];if(s){var c=$(s).find("transmitter");if(c&&c.length>0&&c[0]){var l=$(c[0]),u=l.attr("ip"),p=l.attr("mode");if(u&&p){p=parseInt(p);var d={index:n.gateways.length+1,name:("hc"==e?"HC":e)+" Gateway",info:{sys:"hcgw",ip:u,port:49880,vendor:e,mode:1==p?1:0}};n.gateways.push(d);}}}}if(0==n.gateways.length){var f={index:n.gateways.length+1,name:("hc"==e?"HC":e)+" Gateway",info:{sys:"hcgw",ip:"0.0.0.0",port:49880,vendor:e,mode:1}};n.gateways.push(f);}var h=a.find("location");if(h&&h.length>0)for(t=0;t<h.length;t++){var g=h[t];if(g){var v=$(g);if(o=v.attr("id")){var y={index:n.rooms.length+1,name:o};n.rooms.push(y);var w=v.find("device");if(w&&w.length>0)for(var E=0;E<w.length;E++){var C=w[E];if(C){var _=$(C);o=_.attr("id");var q=_.attr("type"),R=_.attr("address"),I=_.attr("data");if(o&&q&&R&&I){var S,x;switch(q){case"BS":S="brennenstuhl",x="RC 3600","heater"==I&&(x="FHT 433");break;case"ELRO":S="brennenstuhl",x="RCS 1000N";break;case"DY":S="rohrmotor24",x="RMF Motor";break;case"DY2":S="rohrmotor24",x="RMF-RS1 (AP/UP)";break;case"IT":S="intertechno",R.length>=9?(x="IT-1500 ","shutter"==I?x="ITL-1000":"dimmer"==I&&(x="ITLR-300")):(x="CMR-300","shutter"==I&&(x="CMR-500"));}var M={index:n.devices.length+1,name:o,room:y.index,info:{sys:"hcgw",gateway:1,data:I,type:"IT"==q&&R.length>=9?"IT2":q,manufacture:S,model:x,address:R}};n.devices.push(M);}}}}}}}catch(e){console.error(e);}return n;}(s,r),l=[];c&&c.rooms&&c.rooms.forEach(function(e){e&&e.name&&l.push(e.name);});var u=function(e,r){var n={groups:[]};try{var t,o=$($.parseXML(e)).find("location");if(o&&o.length>0)for(t=0;t<o.length;t++){var a=o[t];if(a){var i=$(a),s=i.attr("id");if(s&&_contains(r,s)){var c={classid:"group",index:n.groups.length+1,name:s,macros:[]};n.groups.push(c);var l=i.find("macro");if(l&&l.length>0)for(var u=0;u<l.length;u++){var p=l[u];if(p){var d=$(p),f=d.attr("id");if(f){var h={classid:"macro",index:c.macros.length+1,name:f,commands:[]};c.macros.push(h);var g=d.find("command");if(g&&g.length>0)for(var v=0;v<g.length;v++){var y=g[v];if(y){var w,E=$(y),C=E.attr("action"),_=E.attr("sleep");if(C){var q=C.split(".");3==q.length&&(w={classid:"command",index:h.commands.length+1,action:{type:"command",device:{name:q[1],room:q[0]},value:q[2]}},h.commands.push(w));}else _&&(w={classid:"sleep",index:h.commands.length+1,time:parseInt(_)},h.commands.push(w));}}}}}}}}}catch(e){console.error(e);}return n;}(n,l),p=require("m.aio.devicemanager.js"),d=require("m.aio.macromanager.js"),f=p.getIntHandler(e);if(f){var h=d._getHandler(e);h?(f.data=c,f._save(function(e){e?t&&t(e):(h.macros=d.Macros.parse(u),h._saveMacros(function(e){t&&t(e);}));})):t&&t(new Error("no such tenant for macros"));}else t&&t(new Error("no such tenant"));}else t&&t("invalid tenant");});},Manager.prototype.getConfigList_Eltako=function(e,r,n,t){e+="/listData";var o=require("url").parse(e),a={host:o.hostname,port:o.port||443,path:o.path+"?path=files/iqn/config",auth:r+":"+n},i=require("https").request(a,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200!==e.statusCode)t(new Error("HTTP response code: "+e.statusCode));else if(r)try{var _e=null,_n=JSON.parse(r);_n.XC_SUC?_n=_n.XC_SUC:_n.XC_ERR&&(_e=new Error(r)),_e||Array.isArray(_n)||(_e=new Error("Response did not contain an array.")),t(_e,_n);}catch(e){t(e);}else t(new Error("No data received for parsing."));t=null;});});i.on("timeout",function(){t&&(t(new Error("Timeout")),t=null);}),i.on("error",function(e){t&&(t(e),t=null);}),i.end();},Manager.prototype.getConfigList_IQP=function(e,r,n,t){e+="/iqconfig/getconfigs";var o=require("url").parse(e),a=o.protocol;"http:"==a&&(a="http"),"https:"==a&&(a="https"),a||(a="https");var i=o.port;i||(i=443);var s={host:o.hostname,port:i,path:o.path+"?app="+this._appname,auth:r+":"+n},c=require(a).request(s,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200==e.statusCode)try{var n=[];r&&(n=JSON.parse(r)),t&&(t(null,n),t=null);}catch(e){t&&(t(new Error("invalid json reponse")),t=null);}else t&&(t(new Error("http reponse code:"+e.statusCode)),t=null);});});c.on("timeout",function(){t&&(t(new Error("http timeout")),t=null);}),c.on("error",function(e){t&&(t(e),t=null);}),c.end();},Manager.prototype.downloadConfig_Eltako=function(e,r,n,t,o,a){var _this=this;e+="/getFileURL";var i=require("url").parse(e),s={host:i.hostname,port:i.port||443,path:i.path+"?path=files/iqn/config/"+encodeURIComponent(t),auth:r+":"+n},c=require("https").request(s,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){if(200!==e.statusCode)a&&a(new Error("HTTP response code: "+e.statusCode)),a=null;else if(r)try{var _e2=null,_n2=JSON.parse(r);_n2.XC_SUC?_n2=_n2.XC_SUC:_n2.XC_ERR&&(_e2=new Error(r)),_n2&&_n2.url||(_e2=new Error("Result did not contain a URL to download the content from.")),_e2?(a&&a(_e2,_n2),a=null):_this._getContentFromURL(_n2.url,function(e,r){if(e)return a&&a(e),void(a=null);_this._parseConfig_Eltako(r,o,function(e,r){a&&a(e,r),a=null;});});}catch(e){a&&a(e),a=null;}else a&&a(new Error("No data received for parsing.")),a=null;});});c.on("timeout",function(){a&&(a(new Error("Timeout")),a=null);}),c.on("error",function(e){a&&(a(e),a=null);}),c.end();},Manager.prototype._getContentFromURL=function(e,r){var n=require("https").get(e,function(e){e.setEncoding("utf8");var n="";e.on("data",function(e){n+=e;}),e.on("end",function(){r&&(200!==e.statusCode?r(new Error("HTTP response code: "+e.statusCode)):n?r(null,n):r(new Error("No data received.")),r=null);});});n.on("timeout",function(){r&&(r(new Error("Timeout")),r=null);}),n.on("error",function(e){r&&(r(e),r=null);});},Manager.prototype._parseConfig_Eltako=function(e,r,n){if(!e)return void n(new Error("No content to parse."));var t=require("x.crypt.js"),decrypt=function decrypt(e){var n=t.AES.decodeString(e,r);if(!n)throw new Error("Decryption failed.");return JSON.parse(n);},o=["devices","macros"],a={},i=new(require("url").URLSearchParams)(e),s=Array.from(i.keys());for(var _e3=0;_e3<s.length;_e3++){var _r=s[_e3];var _t=i.get(_r);if(_t=String(_t).replace(/\n/g,""),_t&&o.includes(_r))try{_t=decrypt(_t);}catch(e){return void n(e);}a[_r]=_t;}n(null,a);},Manager.prototype.downloadConfig_IQP=function(e,r,n,t,o){e+="/iqconfig/getdevices";var a=require("url").parse(e),i=a.protocol;"http:"==i&&(i="http"),"https:"==i&&(i="https"),i||(i="https");var s=a.port;s||(s=443);var c={host:a.hostname,port:s,path:a.path+"?app="+this._appname+"&name="+encodeURIComponent(t),auth:r+":"+n},l=require(i).request(c,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){200==e.statusCode?o&&(o(null,r),o=null):o&&(o(new Error("http reponse code:"+e.statusCode)),o=null);});});l.on("timeout",function(){o&&(o(new Error("http timeout")),o=null);}),l.on("error",function(e){o&&(o(e),o=null);}),l.end();},Manager.prototype.decryptConfig_IQP=function(e,r,n){var t=require("x.crypt.js").AES.decodeString(e,r);if("string"==typeof t&&t.length>0){var o=null;try{o=JSON.parse(t),n&&n(null,o);}catch(e){n&&n(new Error("invalid config json"));}}else n&&n(new Error("decryption failed"));},Manager.prototype.importConfig_IQP=function(e,r,n,t,o){var a=require("m.aio.configmanager.js");a.LicenseManager;a.trace("/config/tenants/"+e,function(a,i){if(a)o&&o(a);else if(i&&i.license){var s=r;r.system&&(s=r.system);var c=require("m.aio.devicemanager.js"),l=c.getIntHandler(e);if(l){var u=-1,p=[];if(s.rooms)for(var d=0;d<s.rooms.length;d++){var f=s.rooms[d];if(f){if("_cameras_288c9304ed854ca5f41185e88b240621"==f.name){u=f.index;break;}p.push(f.index);}}else s.rooms=[];if(-1==u){for(u=1;-1!=p.indexOf(u);){u++;}s.rooms.push({name:"_cameras_288c9304ed854ca5f41185e88b240621",index:u});}if(s.devices)for(var h=0;h<s.devices.length;h++){var g=s.devices[h];g&&g.info&&("cloudservice"==g.info.sys&&"ivideon"==g.info.module&&"camera"==g.info.type||"cam"==g.info.sys)&&(g.room=u);}else s.devices=[];if(s.gateways)for(var v=0;v<s.gateways.length;v++){var y=s.gateways[v];y&&y.info&&("cloudservice"==y.info.sys&&(y.info.ip||(y.info.ip="cloud.mediola.com"),y.info.port||(y.info.port=443),y.info.username||y.info.password||(y.info.username=n,y.info.password=t)),"aio"==y.info.sys&&"gtw"==y.info.common_type&&(s.gateways.splice(v,1),v--));}else s.gateways=[];l.data=s,l._save(function(e){e?o&&o(e):c.reloadTenant(i,function(e){o&&o(e);});});}else o&&o(new Error("no such tenant"));}else o&&o("invalid tenant");});},Manager.prototype.downloadMacros_IQP=function(e,r,n,t,o){e+="/iqconfig/getmacros";var a=require("url").parse(e),i=a.protocol;"http:"==i&&(i="http"),"https:"==i&&(i="https"),i||(i="https");var s=a.port;s||(s=443);var c={host:a.hostname,port:s,path:a.path+"?app="+this._appname+"&name="+encodeURIComponent(t),auth:r+":"+n},l=require(i).request(c,function(e){e.setEncoding("utf8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){200==e.statusCode?o&&(o(null,r),o=null):o&&(o(new Error("http reponse code:"+e.statusCode)),o=null);});});l.on("timeout",function(){o&&(o(new Error("http timeout")),o=null);}),l.on("error",function(e){o&&(o(e),o=null);}),l.end();},Manager.prototype.decryptMacros_IQP=function(e,r,n){var t=require("x.crypt.js").AES.decodeString(e,r);if(t.length>0&&"string"==typeof t){var o=null;try{o=JSON.parse(t),n&&n(null,o);}catch(e){n&&n(new Error("invalid macros json"));}}else n&&n(new Error("decryption failed"));},Manager.prototype.importMacros_IQP=function(e,r,n){require("m.aio.configmanager.js").trace("/config/tenants/"+e,function(t,o){if(t)n&&n(t);else if(o&&o.license){var a=require("m.aio.macromanager.js"),i=a._getHandler(e);if(i){var s=require("m.aio.devicemanager.js").getIntHandler(e);if(s){var c=r;if(c&&c.groups)for(var l=0;l<c.groups.length;l++){var u=c.groups[l];if(u&&u.macros)for(var p=0;p<u.macros.length;p++){var d=u.macros[p];if(d&&d.commands)for(var f=0;f<d.commands.length;f++){var h=d.commands[f];if(h&&h.action&&h.action.device){var g=h.action.device.room;if(g&&!isNaN(parseInt(g))){var v=s.findRoomWithIndex(parseInt(g));v&&v.name&&(h.action.device.room=v.name);}}}}}i.macros=a.Macros.parse(c),i._saveMacros(function(e){e?n&&n(e):require("m.aio.devicemanager.js").reloadTenant(o,function(e){n&&n(e);});});}else n&&n(new Error("no device manager"));}else n&&n(new Error("no such tenant"));}else n&&n("invalid tenant");});},Manager;}(),m.aio.importmanager.Handler=m.aio.importmanager.Manager,"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.importmanager.Handler());