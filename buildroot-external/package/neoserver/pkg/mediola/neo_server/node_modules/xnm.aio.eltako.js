var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.eltako=xnm.aio.eltako||{},xnm.aio.eltako.Gateway=function(){var Gateway=function Gateway(e){this._ip=e.ip,this._port=e.port,this._username=e.username,this._password=e.password,this._uuid=e.uuid,this._port||(this._port=35689);};return Gateway.parseJSON=function(e){return e&&e.ip?new Gateway(e):null;},Gateway;}(),xnm.aio.eltako._Session=function(){var e=[135,168,230,29,180,182,102,60,255,187,209,156,101,25,89,153,140,238,246,8,102,13,208,242,93,44,238,212,67,94,59,0,224,13,248,241,214,25,87,212,250,247,223,69,97,178,170,48,22,195,217,17,52,9,111,170,59,244,41,109,131,14,154,124,32,158,12,100,151,81,122,189,90,138,157,48,107,207,103,237,145,249,230,114,91,71,88,192,34,224,177,239,66,117,191,123,108,91,252,17,212,95,144,136,185,65,245,78,177,229,155,184,188,57,160,191,18,48,127,92,79,219,112,197,129,178,63,118,182,58,202,225,202,166,183,144,45,82,82,103,53,72,138,14,241,60,109,154,81,191,164,171,58,216,52,119,150,82,77,142,246,161,103,181,164,24,37,217,103,225,68,229,20,5,100,37,28,202,203,131,230,180,134,246,179,202,63,121,113,80,96,38,192,184,87,246,137,150,40,86,222,212,1,10,189,11,230,33,195,163,150,10,84,231,16,195,117,242,99,117,215,1,65,3,164,181,67,48,193,152,175,18,97,22,210,39,110,17,113,95,105,56,119,250,215,239,9,202,219,9,74,233,30,26,21,151],t=[63,179,44,155,115,19,77,11,46,119,80,102,96,237,189,72,76,167,177,143,33,239,32,84,7,244,121,58,26,11,161,37,16,219,193,80,119,190,70,63,255,79,237,74,172,11,181,85,190,58,108,27,12,107,71,177,188,55,115,191,126,140,111,98,144,18,40,248,194,140,187,24,165,90,227,19,65,0,10,101,1,150,249,49,199,122,87,242,221,244,99,229,233,236,20,75,119,125,230,42,170,184,168,98,138,195,118,210,130,214,237,56,100,230,121,130,66,142,188,131,29,20,52,143,111,47,145,147,181,4,90,242,118,113,100,225,223,201,103,193,251,63,46,85,164,189,27,255,232,59,156,128,208,82,185,133,209,130,234,10,219,42,59,115,19,211,254,20,200,72,75,30,5,37,136,185,183,210,187,210,223,1,97,153,236,208,110,21,87,205,9,21,179,53,59,187,100,224,236,55,127,208,40,55,13,249,43,82,199,137,20,40,205,198,126,182,24,75,82,61,29,178,70,195,47,99,7,132,144,240,14,248,214,71,209,72,212,121,84,81,94,35,39,207,239,152,197,130,102,75,76,15,108,196,22,89],Session=function Session(e){if(!e)throw new Error("options is null");if(!e.ip)throw new Error("no ip");this._timeout=3e3,this._ip=e.ip,this._port=e.port,this._port||(this._port=35689),this._username=e.username,this._password=e.password,this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Session.{"+this._ip+":"+this._port+"}"),this._state="IDLE",this._listeners={},this._socket=null,this._sequenceID=0,this._buffer={},this._settings=null,this._auth=null;};return Session.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},Session.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var o=this._listeners[e].indexOf(t);-1!=o&&this._listeners[e].splice(o,1);}},Session.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT";var t=new xnm.aio.eltako._Socket({ip:this._ip,port:this._port});this._logger.log("trace","start session to "+this._ip+":"+this._port),t.on("open",function(){e._logger.log("trace","_socket success connect to "+e._ip+":"+e._port),e._init();}),t.on("data",function(t){e._onData(t);}),t.on("error",function(t){e._logger.log("trace","_socket error: "+t.message),e._emitEvent("error",t);}),t.on("close",function(){e._logger.log("trace","_socket closed"),e._onClose();}),t.open(),this._socket=t;}},Session.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.close(),this._onClose());},Session.prototype.sendObject=function(e,t){"CONNECTED"==this._state?this._sendObject(e,t):t&&t(new Error("session not connected"));},Session.prototype._sendObject=function(e,t){var o=this;this._sequenceID++;var s={classType:"bsc.api.transport.TransmissionObject",object:e};s.id=new Date().getTime()+"",s.sequenceID=this._sequenceID,this._buffer[s.id]={callback:t,timeout:setTimeout(function(){o._onTimeout(s.id);},this._timeout)},this._logger.log("trace","send object:"+JSON.stringify(s));var r=this._buildData(JSON.stringify(s));this._socket.sendData(r);},Session.prototype._emitEvent=function(e,t){if(e){var o=this._listeners[e];if(o&&o.length>0)for(var s=0;s<o.length;s++){var r=o[s];try{r(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},Session.prototype._buildData=function(e){return require("x.crypt.js").stringToUtf8ByteArray(e);},Session.prototype._parseObject=function(e){var t=require("x.crypt.js").utf8ByteArrayToString(e);try{return JSON.parse(t);}catch(e){return null;}},Session.prototype._init=function(){var e=this;this._doConnectRequest(function(t,o){if(t)return e._emitEvent("error",t),void e.close();var s=o.apiVersions?o.apiVersions[0]:null,r=o.apiExtensions;e._sendCaps(null,null,null,s,r,function(t,o){if(t)return e._emitEvent("error",t),void e.close();e._settings=o;var s=e._genKeySig(e._username,e._password);e._sendAuth(e._username,s.key,s.signature,function(t,o){if(t)return e._emitEvent("error",t),void e.close();e._auth=o,e._emitEvent("open",e._settings,e._auth);});});});},Session.prototype._genKeySig=function(e,t){var o=this._genDHKey(),s=new Buffer(o,"hex").toString("base64"),r=this._genSignature(e,t,o);return{key:s,signature:new Buffer(r,"hex").toString("base64")};},Session.prototype._genDHKey=function(){var o=require("x.crypt.js"),s=o.bigInt(o.byteArrayToHex(e),16),r=o.bigInt.randBetween(o.bigInt("730750818665451459101842416358141509827966271488"),s.minus(2)),n=require("crypto").createDiffieHellman(new Buffer(e),null,new Buffer(t),null);return n.setPrivateKey(r.toString(16),"hex"),n.generateKeys("hex");},Session.prototype._genSignature=function(e,t,o){var s=require("crypto"),r=s.createHash("sha256");r.update(t);var n=e+r.digest("hex");(r=s.createHash("sha256")).update(o,"hex");var i=r.digest("hex");(r=s.createHash("sha256")).update(n,"utf8");var a=r.digest("hex"),c=s.createCipher("aes-128-cbc",new Buffer(a,"hex")),p=c.update(new Buffer(i,"hex"),null,"hex");return p+=c["final"]("hex");},Session.prototype._doConnectRequest=function(e){this._sendObject({classType:"bsc.api.transport.commands.ConnectionRequest",metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["M2M->VID","0#2#0010F3601410"]]}},function(t,o){if(t)e&&e(t);else if(o.object&&"bsc.api.transport.result.ObjectResult"==o.classType){var s=o.object;if(s&&"bsc.api.transport.model.Caps"==s.classType){var r={protocols:[],encryptions:[],compressions:[],apiVersions:[],apiExtension:[]};s.protocols&&s.protocols.data&&(r.protocols=s.protocols.data),s.encryptions&&s.encryptions.data&&(r.encryptions=s.encryptions.data),s.compressions&&s.compressions.data&&(r.compressions=s.compressions.data),s.apiVersions&&s.apiVersions.data&&(r.apiVersions=s.apiVersions.data),s.apiExtensions&&s.apiExtensions.data&&(r.apiExtensions=s.apiExtensions.data),e&&e(null,r);}else e&&e(new Error("do ConnectionRequest failed:"+JSON.stringify(reponse.object)));}else e&&e(new Error("do ConnectionRequest failed:"+JSON.stringify(reponse)));});},Session.prototype._sendCaps=function(e,t,o,s,r,n){e||(e={classType:"Enum",enumType:"bsc.api.Enumerations$ProtocolType",name:"JSON"}),t||(t={classType:"Enum",enumType:"bsc.api.Enumerations$EncryptionType",name:"NONE"}),o||(o={classType:"Enum",enumType:"bsc.api.Enumerations$CompressionType",name:"NONE"}),s||(s={classType:"Enum",enumType:"bsc.api.Enumerations$ApiVersion",name:"Ver_2_1_0"}),r||(r=["CORE","VOICECONTROL","TEACHIN","TIMER","M2M","CAMERA","CONNECTIONS","USERMANAGEMENT","OBJECT_TAG","MESSAGE","BSC","ALEXA","QoS","HEATER","USERCONFIG","PARAMETER","HISTORY"]);var i={classType:"bsc.api.transport.model.Caps",protocols:{classType:"List",valueType:"bsc.api.Enumerations$ProtocolType",data:[e]},encryptions:{classType:"List",valueType:"bsc.api.Enumerations$EncryptionType",data:[t]},compressions:{classType:"List",valueType:"bsc.api.Enumerations$CompressionType",data:[o]},apiVersions:{classType:"List",valueType:"bsc.api.Enumerations$ApiVersion",data:[s]},apiExtensions:{classType:"List",valueType:"String",data:r},metaInformation:{classType:"Map",keyType:"String",valueType:"String",data:[["BSC->PRODUCT","10004"]]}};this._sendObject(i,function(e,t){if(e)n&&n(e);else if(t.object&&"bsc.api.transport.result.ObjectResult"==t.classType){var o=t.object;if(o&&"bsc.api.transport.model.Settings"==o.classType){var s={protocol:o.protocol,encryption:o.encryption,compression:o.compression,apiVersion:o.apiVersion,apiExtensions:o.apiExtensions};n&&n(null,s);}else n&&n(new Error("send Caps failed:"+JSON.stringify(reponse.object)));}else n&&n(new Error("send Caps failed:"+JSON.stringify(reponse)));});},Session.prototype._sendAuth=function(e,t,o,s){var r={classType:"bsc.api.transport.model.Auth",key:t,signature:o,user:e};this._sendObject(r,function(e,t){if(e)s&&s(e);else if(t.object&&"bsc.api.transport.result.ObjectResult"==t.classType){var o=t.object;if(o&&"bsc.api.transport.model.Auth"==o.classType){var r={user:o.user,signature:o.signature,sessionID:o.sessionID};s&&s(null,r);}else s&&s(new Error("send Auth failed:"+JSON.stringify(reponse.object)));}else s&&s(new Error("send Auth failed:"+JSON.stringify(reponse)));});},Session.prototype._onTimeout=function(e){var t=this._buffer[e];t&&(delete this._buffer[e],t.timeout&&clearTimeout(t.timeout),t.callback&&t.callback(new Error("response timeout")));},Session.prototype._onData=function(e){var t=this._parseObject(e);if(this._logger.log("trace","receive object:"+JSON.stringify(t)),t&&t.id&&t.object)if(t.sequenceID&&(this._sequenceID=t.sequenceID),t.object.resultType){var o=this._buffer[t.id];if(o&&t.object.resultType&&"bsc.api.transport.result.Result$ResultType"==t.object.resultType.enumType)return delete this._buffer[t.id],o.timeout&&clearTimeout(o.timeout),void(o.callback&&o.callback(null,t.object));this._emitEvent("object",t.object,function(e){});}else this._emitEvent("object",t.object,function(e){});},Session.prototype._onClose=function(){this._state="CLOSED",this._socket=null,this._emitEvent("close"),this._listeners={};var e=this._buffer;for(var t in this._buffer={},this._sequenceID=0,this._settings=null,e){var o=e[t];o&&(o.timeout&&clearTimeout(o.timeout),o.callback&&o.callback(new Error("session closed")));}},Session;}(),xnm.aio.eltako._Socket=function(){var Socket=function Socket(e){if(!e)throw new Error("options is null");if(!e.ip)throw new Error("no ip");this._ip=e.ip,this._port=e.port,this._port||(this._port=35689),this._logger=require("x.logger.js").getLogger("xnm.aio.eltako._Socket.{"+this._ip+":"+this._port+"}"),this._timeout=2e3,this._listeners={},this._state="IDLE",this._socket=null,this._buf=null,this._compress=null,this._encrypt=null;};return Socket.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},Socket.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var o=this._listeners[e].indexOf(t);-1!=o&&this._listeners[e].splice(o,1);}},Socket.prototype.setCompress=function(e){this._compress=e;},Socket.prototype.setEncrpty=function(e){this._encrypt=e;},Socket.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT",this._buf="";var t=require("net").connect({port:this._port,host:this._ip});t.setTimeout(this._timeout),this._logger.log("trace","start connect to "+this._ip+":"+this._port),t.on("connect",function(){e._logger.log("trace","success to connect "+e._ip+":"+e._port),e._state="CONNECTED",e._emitEvent("open");}),t.on("data",function(t){t.readUInt8&&(t=e._bufferToArray(t));var o=require("x.crypt.js");e._logger.log("trace","receive data: "+o.byteArrayToHex(t)),e._onData(t);}),t.on("error",function(t){e._logger.log("trace","socket error: "+t.message),e._emitEvent("error",t);}),t.on("timeout",function(){"CONNECT"==e._state&&(e._logger.log("trace","connect timeout"),e._emitEvent("error",new Error("connect timeout")),e.close());}),t.on("close",function(){e._logger.log("trace","socket closed"),e._onClose();}),t._doConnect&&"function"==typeof t._doConnect&&t._doConnect(),this._socket=t;}},Socket.prototype.close=function(){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose());},Socket.prototype.sendData=function(e,t){var o=require("x.crypt.js");if(this._logger.log("trace","send data:"+o.byteArrayToHex(e)),"CONNECTED"==this._state){var s=this._buildPacket(e);this._logger.log("trace","send packet:"+o.byteArrayToHex(s)),this._socket.write(new Buffer(s),"binary",function(e){t&&t(e);});}else t&&t(new Error("socket not connected"));},Socket.prototype._buildPacket=function(e){var t=e.length,o=this._int32ToArray(2).concat(this._int32ToArray(t)),s=require("x.crypt.js"),r=s.CRC32(o),n=s.CRC32(e),i=this._int32ToArray(r).concat(this._int32ToArray(n));return[85].concat(o).concat(i).concat(e);},Socket.prototype._emitEvent=function(e,t){if(e){var o=this._listeners[e];if(o&&o.length>0)for(var s=0;s<o.length;s++){var r=o[s];try{r(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},Socket.prototype._arrayToInt32=function(e){var t=((255&e[0])<<24)+((255&e[1])<<16)+((255&e[2])<<8)+(255&e[3]);return t<0?4294967296+t:t;},Socket.prototype._int32ToArray=function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e];},Socket.prototype._bufferToArray=function(e){for(var t=[],o=0;o<e.length;o++){t.push(e[o]);}return t;},Socket.prototype._onData=function(e){this._buf?this._buf=this._buf.concat(e):this._buf=e;for(var t=this._buf.length,o=0;o<t;){if(85==this._buf[o]){if(t<=o+17)break;var s=this._buf.slice(o+5,o+9),r=this._arrayToInt32(s);if(t<o+17+r)break;var n=this._buf.slice(o,o+17+r),i=this._parsePacket(n);i&&this._emitEvent("data",i),o+=17+r-1;}o++;}this._buf=o==t?null:this._buf.slice(o);},Socket.prototype._parsePacket=function(e){var t=require("x.crypt.js");this._logger.log("trace","receive packet:"+t.byteArrayToHex(e));var o=e.slice(1,9),s=e.slice(9,17),r=e.slice(17),n=this._arrayToInt32(o.slice(0,4)),i=this._arrayToInt32(o.slice(4)),a=this._arrayToInt32(s.slice(0,4)),c=this._arrayToInt32(s.slice(4)),p=t.CRC32(o),l=t.CRC32(r);return this._logger.log("trace","parse packet t:"+n+" l:"+i+" crc_h:<"+a+","+p+"> crc_d:<"+c+","+l+">"),r;},Socket.prototype._onClose=function(){this._state="CLOSED",this._socket=null,this._emitEvent("close"),this._listeners={},this._buf=null;},Socket;}(),xnm.aio.eltako.BR64=function(){var BR64=function BR64(e,t,o){if(this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.BR64"),this._ip=e,this._port=t,this._port||(this._port=4443),this._mac=o,this._timeout=1e4,this._httpReqBuffer=[],"undefined"!=typeof process&&null!=process&&process.env){var s=require("https");this._keepAliveAgent=new s.Agent({keepAlive:!0,maxSockets:1});}};BR64.prototype._getSystem=function(e){this._doRequest("GET","/system",null,function(t,o){if(t)e&&e(t);else if(o)try{var s=JSON.parse(o);e&&e(null,s);}catch(t){e&&e(new Error("invalid response"));}else e&&e(new Error("invalid response"));});},BR64.prototype._getDevices=function(e){this._doRequest("GET","/devices",null,function(t,o){if(t)e&&e(t);else if(o)try{var s=JSON.parse(o);e&&e(null,s);}catch(t){e&&e(new Error("invalid response"));}else e&&e(new Error("invalid response"));});},BR64.prototype._getDevice=function(e,t){this._doRequest("GET","/device("+e+")",null,function(e,o){if(e)t&&t(e);else if(o)try{var s=JSON.parse(o);t&&t(null,s);}catch(e){t&&t(new Error("invalid response"));}else t&&t(new Error("invalid response"));});},BR64.prototype._setDeviceState=function(e,t,o){this._doRequest("PATCH","/devices("+e+")",JSON.stringify(t),function(e,t){if(e)o&&o(e);else if(t)try{var s=JSON.parse(t);o&&o(null,s);}catch(e){o&&o(new Error("invalid response"));}else o&&o(new Error("invalid response"));});},BR64.prototype._doRequest=function(e,t,o,s){var r=this._httpReqBuffer.length;this._httpReqBuffer.push({method:e,path:t,data:o,callback:s}),0==r&&this._doNextHttpReq();},BR64.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var e=this._httpReqBuffer[0],t=this;this._doRequestHttp(e.method,e.path,e.data,function(o,s){e.callback&&e.callback(o,s),t._httpReqBuffer.splice(0,1),t._doNextHttpReq();});}},BR64.prototype._doRequestHttp=function(e,t,o,s){var r="https://"+this._ip+":"+this._port+t;this._logger.log("trace","send "+e+" to url: "+r+" data:"+o);var n={host:this._ip,port:this._port,path:t,method:e,headers:{}};o&&(n.headers["Content-Length"]=o.length);var i=this,a=s,c=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",n.agent=this._keepAliveAgent);var p=c.request(n,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(i._logger.log("trace",r+" response "+e.statusCode+": "+t),200==e.statusCode)a&&a(null,t);else{var o=new Error("http response "+e.statusCode);a&&a(o);}a=null;});});p.setTimeout(this._timeout,function(){i._logger.log("trace","http request "+r+" timeout"),a&&(a(new Error("http request timeout")),a=null),p.abort();}),p.on("error",function(e){i._logger.log("trace","http request "+r+" error:"+e.message),a&&(a(e),a=null);}),o&&p.write(o),p.end();},BR64.prototype.toJSON=function(){return{sys:"eltako_br64",ip:this._ip,port:this._port,mac:this._mac};},BR64.parseJSON=function(e){return e&&e.ip&&e.type&&"fsr64"===e.type?new FSR(e.ip,e.port,e.mac):null;};var FSR=function FSR(e,t,o){BR64.call(this,e,t,o),this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.FSR");};return FSR.prototype=new BR64(),FSR.prototype.constructor=FSR,FSR.prototype.executeCommandCreator=function(e,t,o){if(t&&t.value)switch(t.value){case"on":this.on(o);break;case"off":this.off(o);break;case"toggle":this.toggle(o);break;default:o&&o(new Error("unknown command"));}else o&&o(new Error("command value is empty"));},FSR.prototype.getStatesCreator=function(e,t,o){this.getStates(function(e,s){if(e)o&&o(e);else{for(var r=[],n=0;n<t.length;n++){var i=t[n];if(i&&i.id&&i.status&&i.status.value&&"state"===i.status.value)r.push({id:i.id,status:s?s[i.status.value]:"?"});}o&&o(null,r);}});},FSR.prototype.on=function(e){this._setDeviceState(0,{State:{relay_state:[!0]}},function(t){e&&e(t);});},FSR.prototype.off=function(e){this._setDeviceState(0,{State:{relay_state:[!1]}},function(t){e&&e(t);});},FSR.prototype.toggle=function(e){var t=this;this.getStates(function(o,s){o?e&&e(o):"on"==s.state?t.off(e):t.on(e);});},FSR.prototype.getStates=function(e){this._getDevices(function(t,o){if(t)e&&e(t);else if(o&&o.devices&&o.devices[0]){var s=o.devices[0];if(s.State&&s.State.relay_state&&s.State.relay_state.length){var r=s.State.relay_state[0];e&&e(null,{state:1==r?"on":"off"});}else e&&e(new Error("invalid response"));}else e&&e(new Error("invalid response"));});},FSR.prototype.equalsTo=function(e){return!!e&&e instanceof FSR&&this._ip==e._ip&&this._port==e._port;},FSR.prototype.toJSON=function(){var e=BR64.prototype.toJSON.call(this);return e.type="fsr64",e;},BR64.FSR=FSR,BR64;}(),xnm.aio.eltako.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="EltakoDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={fsr64:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}]}};return{SYS:"eltako_br64",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"eltako BR64"}];},createDevice:function createDevice(e,t,o){var s=DMError,r=DMError.ERROR_CODE;e?e.type?e.ip?o(null,e):o(new s(r.INVALID,"ip is invalid")):o(new s(r.INVALID,"type is invalid")):o(new s(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){var s=DMError,r=DMError.ERROR_CODE;e?e.type?e.ip?o(null,e):o(new s(r.INVALID,"ip is invalid")):o(new s(r.INVALID,"type is invalid")):o(new s(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t,o){var s=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var o=!1,s=0;s<e.length;s++){if(e[s]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var r=[],n=null,i=s.getCommandStatusMap(e,o);return i&&(n=function(e,t,o){var s=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}});}return s;}(i,0,t),r=r.concat(n)),r;};if(!e.sys)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),r.command=n;break;case"status":n=_filter(e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;},getCommandStatusMap:function getCommandStatusMap(t){return t&&t.type?e[t.type]:null;}};}(),xnm.aio.eltako.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("xnm.aio.eltako.Handler "),this._controller=null,this._getDeviceListTo=null;};return Handler.prototype.Socket=xnm.aio.eltako._Socket,Handler.prototype.Session=xnm.aio.eltako._Session,Handler.prototype.Gateway=xnm.aio.eltako.Gateway,Handler.prototype.BR64=xnm.aio.eltako.BR64,Handler.prototype.devicemanager=xnm.aio.eltako.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"eltako");},Handler.prototype.resolveDevice=function(e){return this.BR64.parseJSON(e);},Handler.prototype.getDeviceCommands=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),s=o?o.command:[];t&&t(null,s);},Handler.prototype.getDeviceStatus=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),s=o?o.status:[];t&&t(null,s);},Handler.prototype.doCommand=function(e,t,o){var s=this.resolveDevice(e);s?s.executeCommandCreator(e,t,function(e){o&&o(e);}):o&&o(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,o,s){var r=this.resolveDevice(t);if(r){var n=[{id:e,device:t,status:o}];r.getStatesCreator(null,n,function(e,t){e?s&&s(e):s&&s(null,t[0]);});}else s&&s(new Error("device json format invalid"));},Handler.prototype.discoverDevices=function(e,t){var o=require("x.mdns.js"),s=this;o.clearRecordBuffer(),o.discoverServiceWithTimeout("_hap._tcp.local",e,function(e,o){if(e)t&&t(e);else{s._logger.log("trace","find _hap._tcp.local: "+JSON.stringify(o));for(var r=[],n=0;n<o.length;n++){var i=o[n];if(i&&i.info&&i.info.md&&"FSR64"==i.info.md){var a={sys:"eltako_br64",ip:i.ip[0],port:4443,mac:i.info.id,type:i.info.md.toLowerCase(),name:i.domain.substr(0,i.domain.indexOf("."))};r.push(a);}}t&&t(null,r);}});},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.eltako.Handler());