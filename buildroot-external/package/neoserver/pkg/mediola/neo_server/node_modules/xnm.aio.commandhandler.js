var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.commandhandler=xnm.aio.commandhandler||{},xnm.aio.commandhandler.CommandHandler=function(e,t,i,a,s){this.SystemData=e,this.RulesManager=t,this.RemoteHandler=a,this.CloudHandler=s,this.gwModule=require("xnm.aio.gateway.js"),this.CFG=i,this._gealanFans=null,this._persistentAioKeys=["_lastCF3colorSeq","_lastCF4colorSeq"],this._persistentAioData={},this._states={},this.RemoteController=null,this._updateReceivers=[],this.getStatesCallback=null,this.setGealanFanFactory=function(e){this._gealanFans=e;},this.getCurrentState=function(e){return void 0!==this._states[e]?this._states[e]:"?";},this.setState=function(e,t){if(this._states[e]!=t){this._states[e]=t;for(var i=0;i<this._updateReceivers.length;i++){var a=this._updateReceivers[i];a.filter(e)&&a.callback(e.substr(e.indexOf(":")+1),t);}}},this.deleteDeviceStates=function(e){for(var t in this._states){if(this._states.hasOwnProperty(t))parseInt(t.split(":")[0])===e&&delete this._states[t];}},this.subscribe=function(e,t,i){var a={filter:e,callback:t,refresh:i};this._updateReceivers.push(a);var s;return{unsubscribe:(s=this._updateReceivers,function(){var e=s.indexOf(a);-1!==e&&s.splice(e,1);})};},this.subscribeForDevice=function(e,t,i){var a=e.index;return this.subscribe(function(e){return+e.split(":")[0]===a;},t,i);},this.clearSubscribers=function(){this._updateReceivers=[];},this.subscribeForStateOnDevices=function(e,t,i){return this.subscribe(function(e){var i=e.split(":")[0];return t.some(function(e){return e.index===+i;});},function(t,a){e.some(function(e){return t===e;})&&i(a);});},this.refreshSubscribers=function(){this._updateReceivers.forEach(function(e){void 0!==e.refresh&&e&&e.refresh();}.bind(this));},this.receivedState=function(e,t,i,a){XC.debugf(e),XC.debugf(t),XC.debugf(i);var s=this;if("hue"===e)this.SystemData.getGateways(function(t){return t.info.sys===e;}).forEach(function(a){this.SystemData.getDevices(function(e){return e.info.gateway===a.index;}).forEach(function(a){var s={},n="",o=a.info.data;for(var r in a.info.subtype&&(o=a.info.subtype),a.info.address==t&&(n=a.room+"."+a.index,"hue"===e&&((s=require("xnm.aio.hue.js").getStateValues({type:o},i)).rgb=i.rgb,s.effect=i.effect)),s){"state"==r?this.setState(n,s[r]):this.setState(n+":"+r,s[r]);}}.bind(this));}.bind(this));else if("sonos"==e||"wemo"==e||"orvibo"==e||"edimax"==e||"kt"==e||"siegenia"==e||"lightify"==e){s.SystemData.getDevices(function(e){return e.info.address===t;}).forEach(function(t){XC.debugf(t),XC.debugf(i);var a={},n=t.room+"."+t.index,o=t.data;for(var r in t.subtype&&(o=t.subtype),"lightify"===e&&(e="osram"),a=require("xnm.aio."+e+".js").getStateValues({type:o},i),"osram"===e&&(a.rgb=""+XC.getHexVal(i.red,2)+XC.getHexVal(i.green,2)+XC.getHexVal(i.blue,2),a.ct=i.colorTemp),a){"state"==r?s.setState(n,a[r]):s.setState(n+":"+r,a[r]);}});}},this.execute=function(e,t,i,a){var s=this.SystemData.getDevices(function(t){return t.index==e;})[0];s&&this.executeCommand(t,s.info,i,a);},this.executeCommand=function(e,t,i,a){var _this=this;var s=this,n=t.gateway,o=t.sys,r=this.SystemData.getGateways(function(e){return e.index===n;},!0)[0];if(!r||"aio"!==o&&"hm"!==o){if(!this.RemoteHandler.isRemote())if(r&&"fritzbox"===o){var d=new(require("xnm.aio.fritz.js").Box)(r.info.ip,r.info.password);d.executeCommand(t,e,function(){XC.debugf("executed fritz command"),a&&a.call(),t.id=t.location+"."+t.id,i&&d.getStates(s,[t]);});}else if(r&&"alpha2"===o){var f=new(require("xnm.aio.moehlenhoff.js").Alpha2)(r.info.ip);f.executeCommandCreator(t,e,function(){XC.debugf("executed moehlenhoff command"),a&&a.call(),t.id=t.location+"."+t.id,i&&f.getStates(s,[t]);});}else if(r)XC.debugf("executeCommand for unknown gatewaytype");else{if(["edimax","kt","orvibo","siegenia","sonos","wemo"].includes(o)){var h={address:t.address,data:t.data};if("wemo"===o){h.port=49154;var u=t.address.split(":");2==u.length&&(h.address=u[0],h.port=u[1]);}else"sonos"===o?(h.port=1400,h.address=t.ip):"siegenia"===o&&(h.pwd=t.pwd);var l=require("xnm.aio."+o+".js").getDevice(h);l?l.executeCommandCreator(h,e,function(e,t){XC.debugf("executed "+o+" command"),"siegenia"===o?a&&a.call(null,e,t):a&&a.call(),i&&l.getStates(s);}):a&&a.call();}else if("gealan"===o){new(require("xnm.aio.gealan.js").Fan)(t.ip,t.port,t.username,t.password).executeCommandCreator(t,e,function(e,t){XC.debugf("executed "+o+" command"),a&&a.call();});}else if("aiogateway"===o){(c=new this.gwModule.Gateway(t.address)).executeGatewayCommand(e,function(){a&&a.call();});}}}else{var c;(c=this.gwModule.resolveGateway(r.info)).CommandHandler=this,this._restoreAioData(c),r.info.server&&c.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),r.info.password&&(c._at=this.hash(r.info.password));var m=this.RemoteHandler.isRemote();c.setCloudAccess(m),m&&(i=!0),c.executeCommandCreator(null,{value:m?"raOn":"raOff"}),c.executeCommandCreator(t,e,function(n){_this._saveAioData(c),XC.debugf("Executed Gateway Command: "+t.sys+" "+e+(m?" (remote)":" (local)")),i&&setTimeout(function(){return c.getStates(s);},1e3),a&&a(n);});}},this._restoreAioData=function(e){if(this._persistentAioData[e._mac])for(var t in this._persistentAioData[e._mac]){e[t]=this._persistentAioData[e._mac][t];}else this._persistentAioData[e._mac]={};},this._saveAioData=function(e){var _this2=this;this._persistentAioKeys.forEach(function(t){t in e&&(_this2._persistentAioData[e._mac][t]=e[t]);});},this.hash=function(e){return e=String(e),require("x.crypt.js").MD5(unescape(encodeURI(e+"_SALT!")));},this.getStatesForDevice=function(e,t){var _this3=this;e.info&&"cloudservice"===e.info.sys&&new this.CloudHandler().getModuleStates(e.info.module,function(t,i){if(_this3.deleteDeviceStates(e.index),i){var a=i[e.info.connection];if(a){var s=a[e.info.id];if(s&&s.states)for(var n in s.states){_this3.setState(e.index+":"+n,s.states[n]);}}}});if(e.info&&e.info.mod){this.deleteDeviceStates(e.index);var i=this.gwModule.devicemanager.getSystem(e.info);if(!i)return;var a,s=this.SystemData.getGateways(function(t){return t.index===e.info.gateway;})[0];if(!s)return;var n=s.info.mac;this._aioCache?(this._aioCache[n]||(this._aioCache[n]=this.gwModule.resolveGateway(s.info)),a=this._aioCache[n]):a=this.gwModule.resolveGateway(s.info),this.RemoteHandler.isRemote()&&(a.setRemoteAccessMode(s.info.sid),a.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),a._at=this.hash(s.info.password)),a.executeCommandCreator(null,{value:this.RemoteHandler.isRemote()?"raOn":"raOff"}),i.getStatesCreator(a,e.info,function(i,a){if(!i&&a){for(var s in a){_this3.setState(e.index+":"+s,a[s]);}t&&t(a);}});}else if(!this.RemoteHandler.isRemote()){var o=e.sys;if(-1!==["gealan"].indexOf(o)&&"gealan"==o){var r=this._gealanFans.getFan({ip:e.ip,port:e.port,mac:e.mac}),d=[];require("xnm.aio.gealan.js").getDeviceStatus(e,function(t,i){for(var a=0;a<i.length;a++){var s=i[a];if(s.ref&&s.ref.value){var n={id:s.ref.value,device:e,status:{value:s.ref.value}};d.push(n);}}}),r.getStatesCreator(null,d,function(i,a){if(!i&&a){for(var s=0;s<a.length;s++){var n=a[s];_this3.setState(e.id+":"+n.id,n.status);}t&&t(i,a);}});}}},this.getStatesForDevices=function(e,t){var i={},a=[];this._orderByGateway(e,i,a),this.getStatesPerGateway(i,a,t);},this.getStatesForLocations=function(e,t){var _this4=this;var i={},a=[];e.forEach(function(e){var s=_this4.SystemData.getDevices(function(t){return t.room===e.index;});_this4._orderByGateway(s,i,a,t);}),this.getStatesPerGateway(i,a);},this._orderByGateway=function(e,t,i,a){e.forEach(function(e){var s={};if("cloudservice"===e.info.sys){if(!a)return;s=e;}else e.info.mod?s=e:((s=Object.assign({},e.info)).id=e.index,s.subtype=e.info.subtype?e.info.subtype:e.info.data);var n=e.info.gateway;n&&!e.info.mod?(t[n]||(t[n]=[]),t[n].push(s)):i.push(s);});},this.getStatesPerGateway=function(e,t,i){var _this5=this;for(var a in e){var s=this.SystemData.getGateways(function(e){return e.index==a;},!0)[0];if(!s)return;var n=s.info.sys,o=e[a];if("aio"!==n){if("hm"!==n){if("fritzbox"!==n){if("alpha2"!==n);else new(require("xnm.aio.moehlenhoff.js").Alpha2)(s.info.ip).getStates(this,o);}else new(require("xnm.aio.fritz.js").Box)(s.info.ip,s.info.password).getStates(this,o);}else XC.debugf("GET HM STATES"),new(require("xnm.aio.hm.js").CCU)(s.info.ip).getStates(this,o,function(e,t){if(!e&&t)for(var i=0;i<t.length;i++){this.setState(t[i].id,t[i].status);}}.bind(this));}else{var r=this.gwModule.resolveGateway(s.info);this.RemoteHandler.isRemote()&&(r.setRemoteAccessMode(s.info.sid),r.setRemoteUrl("https://"+this.CFG.links.cloudAccessServer+"/rapi/live/"),r._at=this.hash(s.info.password),r.setCloudAccess(!0),r.executeCommandCreator(null,{value:"raOn"})),r.getStates(this,o,function(e,t){null==e&&i&&i(new Error("Error getting states "+t));});}}setTimeout(function(){_this5._aioCache=[];for(var e=0;e<t.length;e++){_this5.getStatesForDevice(t[e]);}_this5._aioCache=[];},1e3);};},xnm.aio.commandhandler.Handler=function(){},xnm.aio.commandhandler.Handler.prototype.CommandHandler=xnm.aio.commandhandler.CommandHandler,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.commandhandler.Handler());