var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.sms=xnm.aio.sms||{},xnm.aio.sms.Handler=function(){var e="http://webservice.aio-control.com/smsservice",r="https://webservice.mediola.com/cloudservice",t={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function encode(e){var r,o,n,s,i,u,a,c="",d=0;for(e=t._utf8_encode(e);d<e.length;){s=(r=e.charCodeAt(d++))>>2,i=(3&r)<<4|(o=e.charCodeAt(d++))>>4,u=(15&o)<<2|(n=e.charCodeAt(d++))>>6,a=63&n,isNaN(o)?u=a=64:isNaN(n)&&(a=64),c=c+this._keyStr.charAt(s)+this._keyStr.charAt(i)+this._keyStr.charAt(u)+this._keyStr.charAt(a);}return c;},decode:function decode(e){var r,o,n,s,i,u,a="",c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;){r=this._keyStr.indexOf(e.charAt(c++))<<2|(s=this._keyStr.indexOf(e.charAt(c++)))>>4,o=(15&s)<<4|(i=this._keyStr.indexOf(e.charAt(c++)))>>2,n=(3&i)<<6|(u=this._keyStr.indexOf(e.charAt(c++))),a+=String.fromCharCode(r),64!=i&&(a+=String.fromCharCode(o)),64!=u&&(a+=String.fromCharCode(n));}return a=t._utf8_decode(a);},_utf8_encode:function _utf8_encode(e){e=e.replace(/\r\n/g,"\n");for(var r="",t=0;t<e.length;t++){var o=e.charCodeAt(t);o<128?r+=String.fromCharCode(o):o>127&&o<2048?(r+=String.fromCharCode(o>>6|192),r+=String.fromCharCode(63&o|128)):(r+=String.fromCharCode(o>>12|224),r+=String.fromCharCode(o>>6&63|128),r+=String.fromCharCode(63&o|128));}return r;},_utf8_decode:function _utf8_decode(e){for(var r="",t=0,o=c1=c2=0;t<e.length;){(o=e.charCodeAt(t))<128?(r+=String.fromCharCode(o),t++):o>191&&o<224?(c2=e.charCodeAt(t+1),r+=String.fromCharCode((31&o)<<6|63&c2),t+=2):(c2=e.charCodeAt(t+1),c3=e.charCodeAt(t+2),r+=String.fromCharCode((15&o)<<12|(63&c2)<<6|63&c3),t+=3);}return r;}},Handler=function Handler(){};return Handler.prototype.setURL=function(r){e=r;},Handler.prototype.setCloudServiceURL=function(e){r=e;},Handler.prototype.registAllUndeliveredPurchase=function(e,r){var t=this;this._getUndeliveredPurchase(function(o,n){if(XC.debugf("deliver unregest ps"),XC.debugf(o),XC.debugf(n),o)r&&r(o);else if(n&&0!=n.length){XC.debugf("registAllSmsPurchase purchases:"+JSON.stringify(n));for(var s=[],i=[],u=0;u<n.length;u++){var a=n[u];if(t._isSmsPurchase(a)){var c=t._getSmsCount(a);c&&(a.smsTotalCount=c,a.sid=e,s.push(a));}else if(t._isCloudServicePurchase(a)){var d=t._getCloudServiceDuration(a);d&&(a.duration=d,i.push(a));}}var h=2,p=null;t._handleSms(s,function(e){h--,e&&(p=e),0==h&&r&&r(p);}),t._handleCloudService(i,function(e){h--,e&&(p=e),0==h&&r&&r(p);});}else r&&r();});},Handler.prototype._handleSms=function(e,r){if(!e||e.length<=0)r&&r();else{var t=this;this._registSmsPurchases(e,function(o){o?r&&r(o):t._purchasesDelivered(e,function(e){r&&r(e);});});}},Handler.prototype._handleCloudService=function(e,r){if(!e||e.length<=0)r&&r();else{var t=this;this._registCloudServicePurchases(e,function(o){o?r&&r(o):t._purchasesDelivered(e,function(e){r&&r(e);});});}},Handler.prototype.getSmsInfo=function(r,t){var o=require("url").parse(e),n={host:o.hostname,port:o.port,path:o.path+"/gatewaysmsinfo?sid="+r,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}},s=require("http").request(n,function(e){e.setEncoding("utf-8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){var o;if(200!=e.statusCode)o=new Error("http response:"+e.statusCode),t&&t(o);else if(r)try{var n=JSON.parse(r);t&&t(null,n);}catch(e){t&&t(e);}else o=new Error("server response is empty"),t&&t(o);});});s.setTimeout&&s.setTimeout(1e4),s.on&&s.on("error",function(e){t&&t(e||new Error("http error"));}),s.end();},Handler.prototype.setSmsActive=function(r,t,o){var n=require("url").parse(e),s={host:n.hostname,port:n.port,path:n.path+"/activatesms?sid="+r+"&active="+t,method:"GET",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}},i=require("http").request(s,function(e){e.setEncoding("utf-8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){var t;200!=e.statusCode&&(t=new Error("http response:"+e.statusCode)),o&&o(t,r);});});i.setTimeout&&i.setTimeout(1e4),i.on&&i.on("error",function(e){o&&o(e||new Error("http error"));}),i.end();},Handler.prototype._getUndeliveredPurchase=function(e){XC.callHost("inapppurchase","getUndeliveredPurchase",null,function(r){r?r.error?e&&e(new Error(r.error)):r.value?e&&e(null,r.value):e&&e(null,[]):e&&e(new Error("result is null"));});},Handler.prototype._registSmsPurchases=function(r,t){var o=this._encrypt2base64(JSON.stringify(r)),n=require("url").parse(e);XC.debugf("registAllSmsPurchase ud:"+JSON.stringify(n));var s={host:n.hostname,port:n.port,path:n.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}},i=require("http").request(s,function(e){e.setEncoding("utf-8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){var o;200!=e.statusCode&&(o=new Error("http response:"+e.statusCode)),t&&t(o,r);});});i.setTimeout&&i.setTimeout(1e4),i.on&&i.on("error",function(e){t&&t(e||new Error("http error"));}),i.write(o),i.end();},Handler.prototype._registCloudServicePurchases=function(e,t){var o=this._encrypt2base64(JSON.stringify(e)),n=require("url").parse(r),s=n.port;-1!=n.protocol.indexOf("https")&&80==s&&(s=443),XC.debugf("regist cloud service purchase ud:"+JSON.stringify(n));var i={host:n.hostname,port:s,path:n.path+"/consume",method:"POST",headers:{"Content-Type":'text/plain; charset="utf-8"',Connection:"close"}},u=require("https").request(i,function(e){e.setEncoding("utf-8");var r="";e.on("data",function(e){r+=e;}),e.on("end",function(){var o;200!=e.statusCode&&(o=new Error("http response:"+e.statusCode)),t&&t(o,r);});});u.setTimeout&&u.setTimeout(1e4),u.on&&u.on("error",function(e){t&&t(e||new Error("http error"));}),u.write(o),u.end();},Handler.prototype._encrypt2base64=function(e){var r=require("x.crypt.js"),o=function(e){for(var r,t="",o=0,n=e.length;o<n;o+=1){r=e.charCodeAt(o),t+=r.toString(16);}return t;}(t.encode(e)),n=r.AES.h2a(o);r.AES.setSize(128);var s=r.AES.h2a("CB1CC15198F09B7D9EA80892A870399E"),i=r.AES.h2a("D0648681F88076B43CE216E0686A02DD"),u=r.AES.encrypt(n,s,i);return r.AES.a2h(u);},Handler.prototype._purchasesDelivered=function(e,r){var t=e.length;if(t)for(var o=null,n=0;n<e.length;n++){var s=e[n];this._purchaseDelivered(s.orderId,function(e){t--,o||(o=e),0==t&&r&&r(o);});}else r&&r();},Handler.prototype._purchaseDelivered=function(e,r){e?XC.callHost("inapppurchase","purchaseDelivered",{orderId:e},function(e){e?e.error?r&&r(new Error(e.error)):r&&r(null,e.value):r&&r(new Error("result is null"));}):r&&r(new Error("order id is empty"));},Handler.prototype._isSmsPurchase=function(e){return!!e&&!!e.productId&&("android.test.purchased"==e.productId||e.productId.indexOf(".sms.")>=0);},Handler.prototype._isCloudServicePurchase=function(e){return!!e&&!!e.productId&&("android.test.purchased"==e.productId||e.productId.indexOf(".cloudservice")>=0);},Handler.prototype._getSmsCount=function(e){if(!e)return 0;if(!e.productId)return 0;if("android.test.purchased"==e.productId)return 50;var r=e.productId,t=r.indexOf(".sms.");if(t<0)return 0;if(t+5>=r.length)return 0;var o=r.substr(t+5);return parseInt(o);},Handler.prototype._getCloudServiceDuration=function(e){if(!e)return 0;if(!e.productId)return 0;if("android.test.purchased"==e.productId)return 50;var r=e.productId,t=r.indexOf(".cloudservice.");if(t<0)return 0;if(t+14>=r.length)return 0;var o=r.substr(t+14);return parseInt(o);},Handler;}(),"undefined"!=typeof module&&module&&module.exports&&(module.exports=new xnm.aio.sms.Handler());