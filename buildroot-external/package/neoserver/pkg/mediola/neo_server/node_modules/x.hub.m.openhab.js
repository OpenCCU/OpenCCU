function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});Object.defineProperty(subClass,"prototype",{writable:false});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined");}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.openhab=x.hub.m.openhab||{},x.hub.m.openhab.MODULE=require("xnm.aio.openhab.js"),x.hub.m.openhab.Monitor=/*#__PURE__*/function(){function XHUBOpenHABMonitor(e){_classCallCheck(this,XHUBOpenHABMonitor);this._logger=require("x.logger.js").getLogger("x.hub.m.openhab.Monitor"),this._running=!1,this._server=e,this._devices={},this._reconnectTO=null,this._reconnectTimeout=5e3;}_createClass(XHUBOpenHABMonitor,[{key:"start",value:function start(e){this._logger.log("debug","start monitor for:"+this._server.ip),this._running||(this._running=!0,this._listenToEventSource()),e&&e();}},{key:"addStateDevice",value:function addStateDevice(e,t){e&&e.address&&e.item&&e.item.name&&(this._devices[e.item.name]=e),t&&t();}},{key:"_listenToEventSource",value:function _listenToEventSource(){this._logger.log("debug","connect to openhab server "+this._server.ip+":"+this._server.port);var e=this;this._startHttpConnection(function(t){e._logger.log("debug","disconnectd from openhab server "+e._server.ip+":"+e._server.port+(t?" with error:"+t.message:"")),e._logger.log("debug","reconnect after "+e._reconnectTimeout+" seconds"),e._reconnectTO=setTimeout(function(){e._listenToEventSource();},e._reconnectTimeout);});}},{key:"_startHttpConnection",value:function _startHttpConnection(e){var t=this,r=require("http"),o={host:this._server.ip,port:this._server.port,path:"/rest/events",method:"get"},n=!1,s=r.request(o,function(r){if(r.setEncoding("utf-8"),n=!0,t._logger.log("trace","server response with status code:"+r.statusCode),200==r.statusCode){var o="";r.on("data",function(e){if((o+=e).indexOf("\n\n")>=0){var r=o.split("\n\n");o="";for(var n=0;n<r.length;n++){var s=r[n].trim().split("\n");s[1]&&"data:"==s[1].substr(0,5)&&t._onMessage(s[1].substr(6).trim());}}else o.length>2e4&&(t._logger.log("warn","incoming message string has become too long ("+o.length+"). discarding message."),o="");}),r.on("end",function(){t._logger.log("trace","http connection closed");}),r.on("close",function(){t._logger.log("trace","http connection closed"),e&&(e(),e=null);});}else{var s=new Error("http error:"+r.statusCode);e&&(e(s),e=null);}});s.setTimeout(2e3,function(){n||(s.abort(),e&&(e(new Error("connection timeout")),e=null));}),s.on("error",function(t){e&&(e(t),e=null);}),s.end();}},{key:"_onMessage",value:function _onMessage(e){try{this._logger.log("trace","receive message: "+e);var r=JSON.parse(e);if(!(r&&r.type&&r.topic&&r.payload))return;if("ItemStateChangedEvent"==r.type){var _e=r.topic.split("/")[2];if(!_e||!this._devices[_e])return;var o=JSON.parse(r.payload);if(!o)return;var n=this._devices[_e],s={state:o.oldValue},a={state:o.value};for(var t in a){this._produceEvent(n,t,s[t],a[t]);}}}catch(e){this._logger.log("error",e);}}},{key:"_produceEvent",value:function _produceEvent(e,t,r,o){if(r!=o){this._logger.log("trace","receive new status:"+JSON.stringify({address:e.address,key:t,value:o}));var n={key:t,value:o,oldvalue:r,changed:!0};require("x.hub.eventbus.js").emit("status",{module:"openhab",device:e,gateway:e.gateway,data:n});}}}]);return XHUBOpenHABMonitor;}(),x.hub.m.openhab.Handler=/*#__PURE__*/function(_EventEmitter){_inherits(XHUBOpenHABHandler,_EventEmitter);var _super=_createSuper(XHUBOpenHABHandler);function XHUBOpenHABHandler(){var _this;_classCallCheck(this,XHUBOpenHABHandler);_this=_super.call(this),_this._monitors={};return _this;}_createClass(XHUBOpenHABHandler,[{key:"init",value:function init(e){e&&e();}},{key:"getSystems",value:function getSystems(){return["openhab"];}},{key:"addStateDevice",value:function addStateDevice(e,t){e?e.gateway?this._startMonitor(e.gateway,function(r,o){r?t&&t({error:r}):o.addStateDevice(e,function(e){t&&t({error:e});});}):t&&t(new Error("device gateway format invalid")):t&&t({error:new Error("device json format invalid")});}},{key:"getState",value:function getState(e,t,r){e?e.gateway?x.hub.m.openhab.MODULE.doStatus("xhub",e.gateway,e,{value:t},function(e,t){e?r&&r({error:e}):t?r&&r({data:{value:t.status}}):r&&r({error:new Error("do status failed")});}):r&&r(new Error("device gateway format invalid")):r&&r({error:new Error("device json format invalid")});}},{key:"executeCommand",value:function executeCommand(e,t,r){x.hub.m.openhab.MODULE.doCommand(e.gateway,e,t,r);}},{key:"checkDeviceMatch",value:function checkDeviceMatch(e,t){return!!(t&&t.device&&e&&e.device)&&!(!t.gateway||!e.gateway)&&t.gateway.ip==e.gateway.ip&&t.device.address==e.device.address;}},{key:"_startMonitor",value:function _startMonitor(e,t){if(e&&e.ip){var r=e.ip;if(this._monitors[r])t&&t(null,this._monitors[r]);else{var o=x.hub.m.openhab.MODULE.resolveGateway(e);if(o){var n=new x.hub.m.openhab.Monitor(o);this._monitors[r]=n,n.start(),t&&t(null,n);}else t&&t(new Error("gateway format invalid"));}}else t&&t(new Error("gateway, format invalid"));}}]);return XHUBOpenHABHandler;}(EventEmitter),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.openhab.Handler());