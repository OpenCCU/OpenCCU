var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.hue=xnm.aio.hue||{},xnm.aio.hue.Util={_HSVToRGB:function _HSVToRGB(e,t,r){var a,n,o,i=Math.floor(6*e),s=6*e-i,u=r*(1-t),l=r*(1-s*t),d=r*(1-(1-s)*t);switch(i%6){case 0:a=r,n=d,o=u;break;case 1:a=l,n=r,o=u;break;case 2:a=u,n=r,o=d;break;case 3:a=u,n=l,o=r;break;case 4:a=d,n=u,o=r;break;case 5:a=r,n=u,o=l;}return[255*a,255*n,255*o];},_RGBToHex:function _RGBToHex(e,t,r){for(var a=e.toString(16);a.length<2;){a="0"+a;}for(var n=t.toString(16);n.length<2;){n="0"+n;}for(var o=r.toString(16);o.length<2;){o="0"+o;}return(a+n+o).toUpperCase();}},xnm.aio.hue.Bridge=function(e,t,r,a,n){var o=require("x.logger.js");this._logger=o?o.getLogger("xnm.aio.hue.Bridge"):{log:function log(){}},this._USER="IQONTROLUser",n&&(this._USER=n),this.ip=e,this.port=t,this.uuid=r,this.CommandHandler=null;},xnm.aio.hue.Bridge.prototype._RGBToHSV=function(e,t,r){e/=255,t/=255,r/=255;var a=Math.min(e,Math.min(t,r)),n=Math.max(e,Math.max(t,r));return a==n?[0,0,a]:[60*((e==a?3:r==a?1:5)-(e==a?t-r:r==a?e-t:r-e)/(n-a)),(n-a)/n,n];},xnm.aio.hue.Bridge.prototype._RGBToXY=function(e,t,r){var a=[[.703,.296],[.214,.709],[.139,.081]],n=[[.674,.322],[.408,.517],[.168,.041]],o=[[.692,.308],[.17,.7],[.153,.048]],i=[[1,0],[0,1],[0,0]],s=["LLC001","LLC005","LLC006","LLC007","LLC010","LLC011","LLC012","LLC014","LLC013","LST001"],u=["LCT001","LCT002","LCT003","LCT004","LLM001","LCT005","LCT006","LCT007"],l=["LCT010","LCT011","LCT012","LCT014","LCT015","LCT016","LLC020","LST002"],d=["HBL001","HBL002","HBL003","HIL001","HIL002","HEL001","HEL002"],_converter_calculateXY=function _converter_calculateXY(e,t,r,c){t/=255,r/=255;var m=(e/=255)>.04045?Math.pow((e+.055)/1.055,2.4000000953674316):e/12.92,h=t>.04045?Math.pow((t+.055)/1.055,2.4000000953674316):t/12.92,f=r>.04045?Math.pow((r+.055)/1.055,2.4000000953674316):r/12.92,p=.664511*m+.154324*h+.162028*f,g=.283881*m+.668433*h+.047685*f,v=88e-6*m+.07231*h+.986039*f,y=[p/(p+g+v),g/(p+g+v)];isNaN(y[0])&&(y[0]=0),isNaN(y[1])&&(y[1]=0);var x=function colorPointsForModel(e){null==e&&(e=" ");return-1==u.indexOf(e)&&-1==d.indexOf(e)?s.indexOf(e)>=0?a:l.indexOf(e)>=0?o:i:n;}(c),_=function checkPointInLampsReach(e,t){if(null!=e&&null!=t){var r=t[0],a=t[1],n=t[2],o=[a[0]-r[0],a[1]-r[1]],i=[n[0]-r[0],n[1]-r[1]],s=[e[0]-r[0],e[1]-r[1]],u=crossProduct(s,i)/crossProduct(o,i),l=crossProduct(o,s)/crossProduct(o,i);return u>=0&&l>=0&&u+l<=1;}return!1;}(y,x);if(!_){var b=getClosestPointToPoints(x[0],x[1],y),w=getClosestPointToPoints(x[2],x[0],y),S=getClosestPointToPoints(x[1],x[2],y),E=getDistanceBetweenTwoPoints(y,b),L=getDistanceBetweenTwoPoints(y,w),O=E,T=b;L<E&&(O=L,T=w),getDistanceBetweenTwoPoints(y,S)<O&&(T=S),y[0]=T[0],y[1]=T[1];}return y[0]=precision(y[0]),y[1]=precision(y[1]),y;};function crossProduct(e,t){return e[0]*t[1]-e[1]*t[0];}function getClosestPointToPoints(e,t,r){if(null!=e&&null!=t&&null!=r){var a=[r[0]-e[0],r[1]-e[1]],n=[t[0]-e[0],t[1]-e[1]],o=(a[0]*n[0]+a[1]*n[1])/(n[0]*n[0]+n[1]*n[1]);return o<0?o=0:o>1&&(o=1),[e[0]+n[0]*o,e[1]+n[1]*o];}return null;}function getDistanceBetweenTwoPoints(e,t){var r=e[0]-t[0],a=e[1]-t[1];return Math.sqrt(r*r+a*a);}function precision(e){return Math.round(1e4*e)/1e4;}return _converter_calculateXY(e,t,r);},xnm.aio.hue.Bridge.prototype._doRequest=function(e,t,r,a){var n="/api/"+this._USER+t;t||(n="/api");var o={host:this.ip,port:this.port,path:n,method:e,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}},i=this,s=a;this._logger.log("trace","send '"+e+"' to "+this.ip+":"+this.port+"/api/xxxxxxxx"+(t||"")),r&&this._logger.log("trace","with data: "+r);var u=require("http").request(o,function(e){if(200==e.statusCode){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){i._logger.log("trace","http response 200: "+t);var e={};try{var r=JSON.parse(t);r&&r[0]&&r[0].error?(e.error="unknown",1==r[0].error.type&&(e.error="unauthorized"),101==r[0].error.type&&(e.error="unpressed")):e.data=r;}catch(e){}s&&(s(e),s=null);});}else i._logger.log("trace","http response "+e.statusCode),s&&(s(null),s=null);});u.setTimeout(1e3,function(){i._logger.log("trace","http request timeout"),u.abort();}),u.on("error",function(e){i._logger.log("trace","http request error:"+e.message),s&&(s(null),s=null);}),r&&u.write(r),u.end();},xnm.aio.hue.Bridge.prototype._doRequestForAuth=function(e,t,r,a){var n="/api/"+this._USER+t;t||(n="/api");var o={host:this.ip,port:this.port,path:n,method:e,headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}};this._logger.log("debug","do auth:"+JSON.stringify(o));var i=this,s=a,u=null,l=require("http").request(o,function(e){if(i._logger.log("trace","do auth return status:"+e.statusCode),u=e.statusCode,200==e.statusCode){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){i._logger.log("trace","do auth return:"+t);var e={};try{var r=JSON.parse(t);r&&r[0]&&r[0].error?(e.error="unknown",1==r[0].error.type&&(e.error="unauthorized"),101==r[0].error.type&&(e.error="unpressed")):e.data=r;}catch(e){}s&&(s(e),s=null);});}else XC.debugf("Failed to post request to "+i.ip),s&&(s(null),s=null);});l.setTimeout(1e3,function(){i._logger.log("trace","do auth timeout"),l.abort();}),l.on("error",function(e){u&&"ECONNRESET"==e.code?i._logger.log("trace","do auth connection reset"):(i._logger.log("trace","do auth error:"+e.message),s&&(s(null),s=null));}),r&&l.write(r),l.end();},xnm.aio.hue.Bridge.prototype.getLights=function(e){this._doRequest("GET","/lights",null,function(t){e&&e(t);});},xnm.aio.hue.Bridge.prototype.executeCommand=function(e,t,r,a){if("power"==t&&(t="toggle"),"ct"==e.channel||t.length>3&&"CT:"==t.substr(0,3)){var n=Math.floor(500-3.46*parseInt(t));t.length>3&&"CT:"==t.substr(0,3)&&(n=parseInt(t.substr(3))),n>500&&(n=500),n<153&&(n=153);var o={ct:n,on:!0},i=a?"/groups/".concat(e.address,"/action"):"/lights/".concat(e.address,"/state");this._doRequest("PUT",i,JSON.stringify(o),r);}else if("on"==t){var _t={on:!0};this._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",JSON.stringify(_t),r);}else if("off"==t){var _t2={on:!1};e.manufacturer&&"osram"==e.manufacturer.toLowerCase()&&(_t2.transitiontime=0),this._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",JSON.stringify(_t2),r);}else if("alertStop"==t||"alertOne"==t||"alertRepeat"==t){var _n="none";"alertOne"==t?_n="select":"alertRepeat"==t&&(_n="lselect"),this._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",'{"alert": "'+_n+'"}',r);}else if("effectNone"==t||"effectColorloop"==t){var _n2="none";"effectColorloop"==t&&(_n2="colorloop"),this._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",'{"effect": "'+_n2+'"}',r);}else if("string"==typeof t&&"setscene"==t.substr(0,8)){var _a=t.split("@");if(_a.length<2)return void(r&&r());var _n3=_a[1];this._doRequest("PUT","/groups/"+e.address+"/action",'{"scene": "'+_n3+'"}',r);}else if("toggle"==t){var _t3=this;this._doRequest("GET",a?"/groups/"+e.address:"/lights/"+e.address,null,function(n){if(!n||n.error)return void(r&&r(n));if(!n.data)return void(r&&r({error:new Error("no data field")}));var o=0,i={on:!1};e.type&&0==e.type.indexOf("On/Off")?i=n.data.state:a&&n.data.action&&null!=n.data.action.bri&&void 0!==n.data.action.bri?(o=n.data.action.bri,i=n.data.action):!a&&n.data.state&&null!=n.data.state.bri&&void 0!==n.data.state.bri&&(o=n.data.state.bri,i=n.data.state);var s={on:!0};e.type&&0==e.type.indexOf("On/Off")?i.on&&(s.on=!1):(i.on&&(s.on=!1,e.manufacturer&&"osram"==e.manufacturer.toLowerCase()&&(s.transitiontime=0)),s.on&&0==o&&(s.bri=10));var u=JSON.stringify(s);_t3._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",u,r);});}else if("up"==t||"down"==t){var _n4=this,_o=a?"/groups/".concat(e.address):"/lights/".concat(e.address);this._doRequest("GET",_o,null,function(o){if(o&&o.error)r&&r(o);else{if(o&&o.data){var _i=-1;if(a&&o.data.action&&null!=o.data.action.bri&&void 0!==o.data.action.bri?_i=o.data.action.bri:!a&&o.data.state&&null!=o.data.state.bri&&void 0!==o.data.state.bri&&(_i=o.data.state.bri),-1!=_i){var _o2=_i;_o2="up"==t?Math.floor(_o2+25.4):Math.floor(_o2-25.4),_o2>254&&(_o2=254),_o2<0&&(_o2=0);var s='{"bri": '+_o2+', "on": true}';0==_o2&&(s='{"bri": '+_o2+', "on": false, "transitiontime":0}'),_n4._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",s,r),r=null;}}r&&r();}});}else if("string"==typeof t&&t.length>7&&"briRamp"==t.substr(0,7)){var _n5=t.substr(7).split(":"),_o3=Math.floor(2.54*parseInt(_n5[0])),_i2=parseInt(_n5[1]),s=null;s=0==_o3?{on:!1,transitiontime:_i2}:{on:!0,bri:_o3,transitiontime:_i2},this._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",JSON.stringify(s),r);}else if(6===t.length||7===t.length&&t.startsWith("#")){t=t.replace("#","");var _n6=parseInt(t.substr(0,2),16),_o4=parseInt(t.substr(2,2),16),_i3=parseInt(t.substr(4,2),16),_s=this._RGBToHSV(_n6,_o4,_i3),u=Math.floor(_s[0]/360*65535+3e3),l=Math.floor(254*_s[1]);"osram"===String(e.manufacturer).toLowerCase()&&(u-=3e3),u>65535?u=65535:u<0&&(u=0),l>254?l=254:l<0&&(l=0);var d=this,c=a?"/groups/".concat(e.address):"/lights/".concat(e.address);this._doRequest("GET",c,null,function(t){if(t&&t.error)r&&r(t);else{if(t&&t.data){var _s2=-1;if(a&&t.data.action&&null!=t.data.action.bri&&void 0!==t.data.action.bri?_s2=t.data.action.bri:!a&&t.data.state&&null!=t.data.state.bri&&void 0!==t.data.state.bri&&(_s2=t.data.state.bri),-1!=_s2){if(t.data.state&&"xy"==t.data.state.colormode){var _t4=d._RGBToXY(_n6,_o4,_i3);0==_s2&&(_s2=10);var _u=JSON.stringify({xy:_t4,on:!0,bri:_s2});d._doRequest("PUT",a?"/groups/"+e.address+"/action":"/lights/"+e.address+"/state",_u,r);}else{var _t5={hue:u,sat:l,on:!0};0==_s2&&(_t5.bri=10),_t5=JSON.stringify(_t5);var _n7=a?"/groups/".concat(e.address,"/action"):"/lights/".concat(e.address,"/state");d._doRequest("PUT",_n7,_t5,r);}r=null;}}r&&r();}});}else if(8==t.length){var _n8={hue:Math.floor(parseInt(t.substr(0,4),16)),sat:Math.floor(parseInt(t.substr(4,2),16)),bri:Math.floor(parseInt(t.substr(6,2),16)),on:!0},_o5=a?"/groups/".concat(e.address,"/action"):"/lights/".concat(e.address,"/state");this._doRequest("PUT",_o5,JSON.stringify(_n8),r);}else{var _n9=Math.floor(2.54*parseInt(t));_n9>254?_n9=254:_n9<0&&(_n9=0);var _o6={bri:_n9,on:!0};0==_n9&&(_o6.on=!1,_o6.transitiontime=0);var _i4=a?"/groups/".concat(e.address,"/action"):"/lights/".concat(e.address,"/state");this._doRequest("PUT",_i4,JSON.stringify(_o6),r);}},xnm.aio.hue.Bridge.prototype.authorizeUser=function(e){this._doRequest("POST",null,'{"username": "'+this._USER+'", "devicetype": "IQONTROL"}',e);},xnm.aio.hue.Bridge.prototype.getStates=function(e,t,r){var a=this;this.CommandHandler=e,this.getLights(function(e){if(e&&e.error&&"unauthorized"==e.error)r&&r("AUT");else{if(e&&e.data&&e.data.XC_ERR)return XC.debugf("[xnm.aio.hue.Bridge.getStates] "+JSON.stringify(e.data),"error"),void(r&&r("XC_ERR",e.data.XC_ERR));if(e&&e.data)if(t&&a.CommandHandler.setState)for(var n=0;n<t.length;n++){var o,i=t[n];if(e.data[i.address]&&(o=e.data[i.address].state)){var s=a.getStateValues(i.subtype,o);for(var u in s){"state"==u?a.CommandHandler.setState(i.id,s[u]):a.CommandHandler.setState(i.id+":"+u,s[u]);}}}else if(a.CommandHandler.receivedState)for(var l in e.data){a.CommandHandler.receivedState("hue",l,e.data[l].state);}r&&r("OK");}});},xnm.aio.hue.Bridge.prototype.getStateValues=function(e,t){var r={};return t.on?(r.state=""+Math.round(t.bri/2.54),1==t.bri&&(r.state="1"),r.power="on"):(r.state="0",r.power="off"),t.ct&&(r.ct=""+t.ct),r;},xnm.aio.hue.Discovery=function(){var D=function D(){};return D.prototype.discoverBridges=function(e){},D;}(),xnm.aio.hue.Handler=function(){var e=require("x.logger.js");xnm.aio.hue.DM._logger=e?e.getLogger("xnm.aio.hue.DM"):{log:function log(){}},this._logger=e?e.getLogger("xnm.aio.hue.Handler"):{log:function log(){}},this.detectedBridges={};},xnm.aio.hue.Handler.prototype.discoverBridges=function(e){var t=this;!function(e){require("x.upnp.js").discoverDevices(function(r){if("hue"===r.type){t._logger.log("trace","upnp found Hue: "+r.ip+" UUID:"+r.uuid);var a=new xnm.aio.hue.Bridge(r.ip,80,r.uuid);t.detectedBridges[r.uuid]=a,e(a);}});}(e),function(e){var _loadDesc=function _loadDesc(e,t){var r="http://".concat(e,"/description.xml");new(require("x.upnp.js").DescLoader)(e).load(r,function(e,r){t&&t(e,r);});};var r;r=function r(_r3,a){if(!_r3&&a&&0!==a.length)for(var _r=0;_r<a.length;_r++){var n=a[_r];n&&n.internalipaddress&&_loadDesc(n.internalipaddress,function(r,a){if(!r&&a&&"hue"===a.type){t._logger.log("trace","nupnp found Hue: "+a.ip+" UUID: "+a.uuid);var _r2=new xnm.aio.hue.Bridge(a.ip,80,a.uuid);t.detectedBridges[a.uuid]=_r2,e(_r2);}});}},$.ajax({url:"https://discovery.meethue.com",type:"GET",timeout:3e3,dataType:"text",cache:!0,success:function success(e){t._logger.log("trace","nupnp request success: "+e);try{var _t6=JSON.parse(e);r&&(r(null,_t6),r=null);}catch(e){r&&(r(e),r=null);}},error:function error(e,a){var n="nupnp request error: "+(e?e.status:"0")+"-"+a;t._logger.log("error",n),r&&(r(new Error(n)),r=null);}});}(e);},xnm.aio.hue.Handler.prototype._NUPnP=function(e){},xnm.aio.hue.Handler.prototype.Bridge=xnm.aio.hue.Bridge,xnm.aio.hue.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.hue.Bridge().getStateValues(e.type,t);},xnm.aio.hue.Handler.prototype.getDeviceCommandList=function(e,t){var r=[];if("rgb"==e.data||"colortemplight"==e.data)t||("rgb"==e.data?r.push({id:window.XC_Text.colorvalue+" (RGBA)",cmd:"colorvalue"}):"colortemplight"==e.data&&r.push({id:window.XC_Text.colorvalue,cmd:"colorvalue"})),r.push({id:window.XC_Text.on,cmd:"on"}),r.push({id:window.XC_Text.off,cmd:"off"});else if(r.push({id:window.XC_Text.on,cmd:"on"}),r.push({id:window.XC_Text.off,cmd:"off"}),"dimmer"==e.data&&!t)for(var a=0;a<=100;a+=5){r.push({id:a+"%",cmd:""+a});}return r;},xnm.aio.hue.Bridge.prototype.authorizeUser2=function(e){e.__count||(e.__count=0);var t=this;this._doRequestForAuth("POST",null,'{"devicetype": "mediola#user"}',function(r){var a,n;if(r&&r.data&&r.data[0]&&r.data[0].success&&r.data[0].success.username)return n=r.data[0].success.username,void(e&&e(null,n));e.__count>=50?(a=new Error("push button error"),e&&e(a)):(e.__count++,setTimeout(function(){t.authorizeUser2(e);},500));});},xnm.aio.hue.Bridge.prototype.getGroupStates=function(e,t,r){var a=this;this.CommandHandler=e,t&&0!=t.length?xnm.aio.hue.Group.getAllGroups(this,function(e,n){if(e&&1==e.error)r&&r("AUT");else{if(n)if(t&&a.CommandHandler.setState)for(var _e=0;_e<t.length;_e++){var _r4=t[_e],o=null;for(var _e2=0;_e2<n.length;_e2++){if(n[_e2]&&n[_e2]._meta&&n[_e2]._meta.action&&n[_e2]._address==_r4.address){o=n[_e2]._meta.action;var _t7=a.getStateValues(_r4.subtype,o);for(var _e3 in _t7){"state"==_e3?a.CommandHandler.setState(_r4.id,_t7[_e3]):a.CommandHandler.setState(_r4.id+":"+_e3,_t7[_e3]);}}}}else if(a.CommandHandler.receivedState)for(var _e4=0;_e4<n.length;_e4++){n[_e4]&&n[_e4]._meta&&n[_e4]._meta.action&&n[_e4]._address&&a.CommandHandler.receivedState("hue",n[_e4]._address,n[_e4]._meta.action,!0);}r&&r("OK");}}):r&&r("OK");},xnm.aio.hue.Bridge.prototype.executeCommandCreator=function(e,t,r){if(e){if(t){var a=t.value;if("rgb"==a||"rgbS"==a||"hue"==a||"bri"==a)a=t.ext;else if("ct"==a){if(!((a=parseInt(t.ext))>=153||a<=500))return void(r&&r(new Error("ct command invalid")));a<153&&(a=153),a>500&&(a=500),a="CT:"+a;}else if("alert"==a)switch(a=t.ext){case"stop":a="alertStop";break;case"one":a="alertOne";break;case"repeat":a="alertRepeat";break;default:return void(r&&r(new Error("alert command ext invalid")));}else if("effect"==a)switch(a=t.ext){case"none":a="effectNone";break;case"colorloop":a="effectColorloop";break;default:return void(r&&r(new Error("effect command ext invalid")));}else if("setScene"==a){if(!(a=t.ext))return void(r&&r(new Error("setScene command ext invalid")));a="setscene@"+a;}else if("briRamp"==a){if(!t.ext||0==t.ext.length)return r&&r(new Error("briRamp command ext invalid")),null;for(var n,o,i=0;i<t.ext.length;i++){var s=t.ext[i];if(s)switch(s.value){case"bri":n=s.ext;break;case"transtime":o=s.ext;}}if(void 0===n||null==n||void 0===o||null==o)return void(r&&r(new Error("briRamp command ext invalid")));a="briRamp"+n+":"+o;}switch(e.manufacturer=e.manufacturername,e.category){case"light":this.executeCommand(e,a,function(e){var t;e&&e.error&&(t=new Error(e.error),"unauthorized"==e.error&&(t.code=1,t.module=xnm.aio.hue.DM.SYS)),r&&r(t);});break;case"group":this.executeCommandGroup(e,a,function(e){var t;e&&e.error&&(t=new Error(e.error),"unauthorized"==e.error&&(t.code=1,t.module=xnm.aio.hue.DM.SYS)),r&&r(t);});break;default:r&&r(new Error("no such category:"+e.category));}}else r&&r(new Error("command is null"));}else r&&r(new Error("device is null"));},xnm.aio.hue.Bridge.prototype.getStatesCreator=function(e,t,r){if(t){for(var a=[],n=[],o=0;o<t.length;o++){var i=t[o];if("group"==i.device.category){var s={id:i.id,address:i.device.address};n.push(s);}else{var u={id:i.id,address:i.device.address};a.push(u);}}var l=[],d={},c=this;d.receivedState=function(e,r,a,n){var o;a=c.getStateValues(0,a);for(var i=0;i<t.length;i++){if(t[i]&&t[i].device&&t[i].device.address==r&&t[i].status){if(n&&"group"!=t[i].device.category)continue;if("power"==t[i].status.value&&null!==a.power&&void 0!==a.power)o={id:t[i].id,status:a.power},l.push(o);else if("brightness"==t[i].status.value&&null!==a.state&&void 0!==a.state)o={id:t[i].id,status:parseInt(a.state)},l.push(o);else if("ct"==t[i].status.value&&null!==a.ct&&void 0!==a.ct){var s=parseInt(a.ct);if(!(s>=153||s<=500))continue;o={id:t[i].id,status:s},l.push(o);}}}};var m=3,h=r;this.getStates(d,a,function(e){if(m--,"AUT"==e){var t=new Error(e);return t.code=1,t.module=xnm.aio.hue.DM.SYS,void(h&&h(t));}0==m&&(h&&h(null,l),h=null);}),this.getGroupStates(d,n,function(e){if(m--,"AUT"==e){var t=new Error(e);return t.code=1,t.module=xnm.aio.hue.DM.SYS,h&&h(t),void(h=null);}0==m&&(h&&h(null,l),h=null);}),xnm.aio.hue.Sensor._getAllSensors(this,function(e,r){if(m--,e)return h&&h(e),void(h=null);if(r)for(var a=0;a<t.length;a++){if(t[a]){var n=t[a].id,o=t[a].device,i=t[a].status;if(n&&i&&i.value&&o&&o.address&&"sensor"==o.category){var s=r[o.address];if(s){var u=xnm.aio.hue.Sensor._parseSensor(o.address,s);if(u){var d=u.getStates();if(d){var c=d[i.value];void 0!==c&&null!=c||(c="?"),l.push({id:n,status:c});}}}}}}0==m&&(h&&h(null,l),h=null);});}else r&&r(new Error("deviceList is null"));},xnm.aio.hue.Bridge.prototype.executeCommandGroup=function(e,t,r){this.executeCommand(e,t,r,!0);},xnm.aio.hue.Bridge.prototype.getAllGroups=function(e){xnm.aio.hue.Group.getAllGroups(this,e);},xnm.aio.hue.Bridge.prototype.toJSON=function(){return{sys:xnm.aio.hue.DM.SYS,ip:this.ip,port:this.port,uuid:this.uuid,username:this._USER};},xnm.aio.hue.Bridge.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.hue.Bridge&&this.ip==e.ip&&this.port==e.port;},xnm.aio.hue.Bridge.prototype.getAllStates=function(e){xnm.aio.hue.Light.getAllLights(this,function(e,t){}),xnm.aio.hue.Group.getAllGroups(this,function(e,t){}),xnm.aio.hue.Sensor.getAllSensors(this,function(e,t){});},xnm.aio.hue.Light=function(){var Light=function Light(e,t){this._category=Light.CATEGORY,this._address=e,this._meta=t;};return Light.CATEGORY="light",Light.getAllLights=function(e,t){var r=this;e.getLights(function(e){if(e){if(e.error){var a=new Error(e.error);return"unauthorized"==e.error&&(a.code=1,a.module=xnm.aio.hue.DM.SYS),void(t&&t(a));}e.data?t&&t(null,r.parseLights(e.data)):t&&t(null,[]);}else t&&t(new Error("hue request error"));});},Light.parseLights=function(e){for(var t=[],r=Object.keys(e),a=0;a<r.length;a++){var n=new Light(r[a],e[r[a]]);t.push(n);}return t;},Light.prototype.getStates=function(){if(!this._meta)return null;var e={};if(this._meta.state){e=this._meta.state;var t=this._meta.state;if(t.on?(e.state=""+Math.round(t.bri/2.54),1==t.bri&&(e.state="1"),e.power="on"):(e.state="0",e.power="off"),t.ct&&(e.ct=t.ct),void 0!==t.hue&&null!=t.hue&&void 0!==t.sat&&null!=t.sat&&void 0!==t.bri&&null!=t.bri){var r=t.hue/65535,a=t.sat/254,n=t.bri/254,o=xnm.aio.hue.Util._HSVToRGB(r,a,n);e.rgb=xnm.aio.hue.Util._RGBToHex(Math.round(o[0]),Math.round(o[1]),Math.round(o[2]));}}return e;},Light.prototype.toJSON=function(){var e=JSON.parse(JSON.stringify(this._meta));return e.sys=xnm.aio.hue.DM.SYS,e.category=this._category,e.address=this._address,e;},Light;}(),xnm.aio.hue.Group=function(){var Group=function Group(e,t){this._category=Group.CATEGORY,this._address=e,this._meta=t;};return Group.prototype.toJSON=function(){var e=JSON.parse(JSON.stringify(this._meta));return e.sys=xnm.aio.hue.DM.SYS,e.category=this._category,e.address=this._address,e;},Group.CATEGORY="group",Group.getAllGroups=function(e,t){var r,a,n=this;this._getGroupWithID(e,0,function(o,i){o?t&&t(o):(a=i,n._getGroups(e,function(e,o){e?t&&t(e):(r=o||{},a&&(r[0]=a),t&&t(null,n._parseGroupList(r)));}));});},Group.createGroup=function(e,t,r){if(t){if(t.name){if(t.lights){if(t.lights.length){var a=this;this._createGroup(e,t,function(t,n){t?r&&r(t):a._getGroupWithID(e,n,function(e,t){if(e)r&&r(e);else{var a=new Group(n,t);r&&r(null,a);}});});}else r&&r(new Error("group lights is empty"));}else r&&r(new Error("group lights is invalid"));}else r&&r(new Error("group name is invalid"));}else r&&r(new Error("group is null"));},Group._getGroups=function(e,t){e._doRequest("GET","/groups",null,function(e){if(e){if(e.error){var r=new Error(e.error);return"unauthorized"==e.error&&(r.code=1,r.module=xnm.aio.hue.DM.SYS),void(t&&t(r));}e.data?t&&t(null,e.data):t&&t(new Error("heu response format invalid"));}else t&&t(new Error("hue request error"));});},Group._getGroupWithID=function(e,t,r){e._doRequest("GET","/groups/"+t,null,function(e){if(e){if(e.error){var t=new Error(e.error);return"unauthorized"==e.error&&(t.code=1,t.module=xnm.aio.hue.DM.SYS),void(r&&r(t));}e.data?r&&r(null,e.data):r&&r(new Error("heu response format invalid"));}else r&&r(new Error("hue request error"));});},Group._createGroup=function(e,t,r){var a={name:t.name,lights:t.lights};e._doRequest("POST","/groups",JSON.stringify(a),function(e){if(e){if(e.error){var t=new Error(e.error);return"unauthorized"==e.error&&(t.code=1,t.module=xnm.aio.hue.DM.SYS),void(r&&r(t));}if(e.data&&e.data[0]&&e.data[0].success&&e.data[0].success.id){var a=e.data[0].success.id;0==a.indexOf("/groups/")&&(a=a.substr(8)),r&&r(null,a);}else r&&r(new Error("heu response format invalid"));}else r&&r(new Error("hue request error"));});},Group._parseGroupList=function(e){for(var t=[],r=Object.keys(e),a=0;a<r.length;a++){"0"==r[a]&&(e[r[a]].name="All Lights");var n=new Group(r[a],e[r[a]]);t.push(n);}return t;},Group;}(),xnm.aio.hue.Scene=function(){var Scene=function Scene(){};return Scene.getAllScenes=function(e,t){e._doRequest("GET","/scenes",null,function(e){if(e){if(e.error){var r=new Error(e.error);return"unauthorized"==e.error&&(r.code=1,r.module=xnm.aio.hue.DM.SYS),void(t&&t(r));}e.data?t&&t(null,e.data):t&&t(new Error("heu response format invalid"));}else t&&t(new Error("hue request error"));});},Scene;}(),xnm.aio.hue.Sensor=function(){var Sensor=function Sensor(e,t){this._category=Sensor.CATEGORY,this._address=e,this._meta=t;};Sensor.CATEGORY="sensor",Sensor.getAllSensors=function(e,t){var r=this;this._getAllSensors(e,function(e,a){e?t&&t(e):t&&t(null,r._parseSensors(a));});},Sensor._parseSensors=function(e){for(var t=[],r=Object.keys(e),a=0;a<r.length;a++){var n=r[a],o=e[r[a]],i=this._parseSensor(n,o);i&&t.push(i);}return t;},Sensor._parseSensor=function(e,t){switch(t.type){case"Daylight":return new Daylight(e,t);case"ZGPSwitch":return new ZGPSwitch(e,t);case"ZLLSwitch":return new ZLLSwitch(e,t);case"ZLLPresence":return new ZLLPresence(e,t);case"ZLLTemperature":return new ZLLTemperature(e,t);case"ZLLLightLevel":return new ZLLLightLevel(e,t);default:return null;}},Sensor._getAllSensors=function(e,t){e._doRequest("GET","/sensors",null,function(e){if(e){if(e.error){var r=new Error(e.error);return"unauthorized"==e.error&&(r.code=1,r.module=xnm.aio.hue.DM.SYS),void(t&&t(r));}e.data?t&&t(null,e.data):t&&t(new Error("hue response format invalid"));}else t&&t(new Error("hue request error"));});},Sensor.prototype.getType=function(){return this._meta?this._meta.type:null;},Sensor.prototype.getAddress=function(){return this._address;},Sensor.prototype.getStates=function(){return null;},Sensor.prototype.toJSON=function(){var e=JSON.parse(JSON.stringify(this._meta));return e.sys=xnm.aio.hue.DM.SYS,e.category=this._category,e.address=this._address,e;};var Daylight=function Daylight(e,t){Sensor.call(this,e,t);};Daylight.prototype=new Sensor(),Daylight.prototype.constructor=Daylight,Daylight.prototype.getStates=function(){if(!this._meta)return null;var e={};return this._meta.state&&(e.daylight=this._meta.state.daylight,e.ltime=this._meta.state.lastupdated),e;};var ZGPSwitch=function ZGPSwitch(e,t){Sensor.call(this,e,t);};ZGPSwitch.prototype=new Sensor(),ZGPSwitch.prototype.constructor=ZGPSwitch,ZGPSwitch.prototype.getStates=function(){if(!this._meta)return null;var e={};if("FOHSWITCH"==this._meta.modelid){if(this._meta.state){switch(this._meta.state.buttonevent){case 20:e.levent="Press_Button1";break;case 21:e.levent="Press_Button2";break;case 23:e.levent="Press_Button3";break;case 22:e.levent="Press_Button4";}e.ltime=this._meta.state.lastupdated;}}else if(this._meta.state){switch(this._meta.state.buttonevent){case 34:e.levent="Press_Button1";break;case 16:e.levent="Press_Button2";break;case 17:e.levent="Press_Button3";break;case 18:e.levent="Press_Button4";}e.ltime=this._meta.state.lastupdated;}return e;};var ZLLSwitch=function ZLLSwitch(e,t){Sensor.call(this,e,t);};ZLLSwitch.prototype=new Sensor(),ZLLSwitch.prototype.constructor=ZLLSwitch,ZLLSwitch.prototype.getStates=function(){if(!this._meta)return null;var e={};if(this._meta.state){switch(this._meta.state.buttonevent){case 1e3:"ROM001"==this._meta.modelid?e.levent="INITIAL_PRESS":e.levent="ON";break;case 1001:"ROM001"==this._meta.modelid?e.levent="HOLD":e.levent="ON";break;case 1002:"ROM001"==this._meta.modelid?e.levent="SHORT_RELEASED":e.levent="ON",e.btn1event="shortPress";break;case 1003:"ROM001"==this._meta.modelid?e.levent="LONG_RELEASED":e.levent="ON",e.btn1event="longPress";break;case 2e3:case 2001:case 2002:case 2003:2002==this._meta.state.buttonevent?e.btn2event="shortPress":2003==this._meta.state.buttonevent&&(e.btn2event="longPress"),e.levent="DIM_UP";break;case 3e3:case 3001:case 3002:case 3003:3002==this._meta.state.buttonevent?e.btn3event="shortPress":3003==this._meta.state.buttonevent&&(e.btn3event="longPress"),e.levent="DIM_DOWN";break;case 4e3:case 4001:case 4002:case 4003:4002==this._meta.state.buttonevent?e.btn4event="shortPress":4003==this._meta.state.buttonevent&&(e.btn4event="longPress"),e.levent="OFF";}e.ltime=this._meta.state.lastupdated,this._meta.config&&(void 0!==this._meta.config.battery&&null!=this._meta.config.battery&&(e.battery=this._meta.config.battery),void 0!==this._meta.config.reachable&&null!=this._meta.config.reachable&&(e.reachable=this._meta.config.reachable));}return e;};var ZLLPresence=function ZLLPresence(e,t){Sensor.call(this,e,t);};ZLLPresence.prototype=new Sensor(),ZLLPresence.prototype.constructor=ZLLPresence,ZLLPresence.prototype.getStates=function(){if(!this._meta)return null;var e={};return this._meta.state&&(e.motion=this._meta.state.presence,e.motion2=this._meta.state.presence?"on":"off",e.ltime=this._meta.state.lastupdated),this._meta.config&&(e.battery=this._meta.config.battery),e;};var ZLLTemperature=function ZLLTemperature(e,t){Sensor.call(this,e,t);};ZLLTemperature.prototype=new Sensor(),ZLLTemperature.prototype.constructor=ZLLTemperature,ZLLTemperature.prototype.getStates=function(){if(!this._meta)return null;var e={};return this._meta.state&&(e.temperature=this._meta.state.temperature/100,e.ltime=this._meta.state.lastupdated),this._meta.config&&(e.battery=this._meta.config.battery),e;};var ZLLLightLevel=function ZLLLightLevel(e,t){Sensor.call(this,e,t);};return ZLLLightLevel.prototype=new Sensor(),ZLLLightLevel.prototype.constructor=ZLLLightLevel,ZLLLightLevel.prototype.getStates=function(){if(!this._meta)return null;var e={};return this._meta.state&&(e.lightlevel=this._meta.state.lightlevel,e.dark=this._meta.state.dark,e.daylight=this._meta.state.daylight,e.ltime=this._meta.state.lastupdated),this._meta.config&&(e.battery=this._meta.config.battery),e;},Sensor;}(),xnm.aio.hue.MAP={onoff:{command:[{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"alert",ref:{value:"alert",ext:"%e",extMeta:["stop","one","repeat"]}}],status:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},dimmable:{command:[{type:"enum",name:"up",ref:{value:"up"}},{type:"enum",name:"down",ref:{value:"down"}},{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},{type:"multi",name:"brightness (transition)",ref:{value:"briRamp",ext:"%multi",extMeta:[{type:"int",name:"brightness",ref:{value:"bri",ext:"%d",extMeta:"0-100"}},{type:"int",name:"transition time (100ms)",ref:{value:"transtime",ext:"%d",extMeta:"0-16343"}}]}}],status:[{type:"int",name:"brightness",ref:{value:"brightness",extMeta:"0-100"}}]},colortemp:{command:[{type:"int",name:"color temperature (mired)",ref:{value:"ct",value_t:"ctMired",ext:"%d",extMeta:"153-500",scale:"1"}}],status:[{type:"int",name:"color temperature (mired)",ref:{value:"ct",value_t:"ctMired",extMeta:"153-500",scale:"1"}}]},colorlight:{command:[{type:"string",name:"rgb color",ref:{value:"rgbS",ext:"%s"}},{type:"rgb",name:"rgb color",ref:{value:"rgb",ext:"%s"}},{type:"enum",name:"effect",ref:{value:"effect",ext:"%e",extMeta:["none","colorloop"]}},{type:"string",name:"hsb color",ref:{value:"hue",ext:"%s"}}]},extendcolor:{},group:{command:[{type:"dynamic",name:"set scene",ref:{value:"setScene",ext:"%dynamic"}}]},sensor:{Daylight:{status:[{type:"enum",name:"day light",ref:{value:"daylight",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"event",options:["sunrise","sunset"]}}]},ZGPSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["Press_Button1","Press_Button2","Press_Button3","Press_Button4"]}}]},ZLLSwitch:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"last button",ref:{value:"lbutton",options:["button1","button2","button3","button4"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"enum",name:"event",ref:{value:"levent",options:["ON","DIM_UP","DIM_DOWN","OFF"]}},{type:"enum",name:"button 1 event",ref:{value:"btn1event",options:["shortPress","longPress"]}},{type:"enum",name:"button 2 event",ref:{value:"btn2event",options:["shortPress","longPress"]}},{type:"enum",name:"button 3 event",ref:{value:"btn3event",options:["shortPress","longPress"]}},{type:"enum",name:"button 4 event",ref:{value:"btn4event",options:["shortPress","longPress"]}}]},SmartButton:{status:[{type:"enum",name:"last event",ref:{value:"levent",options:["INITIAL_PRESS","HOLD","SHORT_RELEASED","LONG_RELEASED"]}},{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",name:"reachable",ref:{value:"reachable",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}}],ipevt:[{type:"int",name:"battery",ref:{value:"battery",extMeta:"0-100"}},{type:"enum",name:"button event",ref:{value:"btn1event",options:["shortPress","longPress"]}}]},ZLLPresence:{status:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}},{type:"enum",name:"detect motion (on/off)",ref:{value:"motion2",options:["on","off"]}}],ipevt:[{type:"enum",name:"detect motion",ref:{value:"motion",options:["true","false"]}}]},ZLLTemperature:{status:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"float",name:"temperature",ref:{value:"temperature"}},{type:"int",name:"battery",ref:{value:"battery"}}]},ZLLLightLevel:{status:[{type:"int",name:"light level",ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true","false"]}},{type:"string",name:"last event time",ref:{value:"ltime"}},{type:"int",name:"battery",ref:{value:"battery"}}],ipevt:[{type:"int",name:"light level",ref:{value:"lightlevel"}},{type:"enum",name:"dark",ref:{value:"dark",options:["true","false"]}},{type:"enum",name:"daylight",ref:{value:"daylight",options:["true","false"]}},{type:"int",name:"battery",ref:{value:"battery"}}]}}},xnm.aio.hue.DMError=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.hue.DMError.prototype=new Error(),xnm.aio.hue.DMError.prototype.name="HUEDeviceManagerError",xnm.aio.hue.DMError.prototype.code=0,xnm.aio.hue.DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.hue.DM={SYS:"hue",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"Philips Hue"}];},createGateway:function createGateway(e,t,r){var a=xnm.aio.hue.DMError,n=xnm.aio.hue.DMError.ERROR_CODE;e?e.ip?r(null,e):r(new a(n.INVALID,"ip is invalid")):r(new a(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,a){var n=xnm.aio.hue.DMError,o=xnm.aio.hue.DMError.ERROR_CODE;t?t.ip?a(null,t):a(new n(o.INVALID,"ip is invalid")):a(new n(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,r){r();},createDevice:function createDevice(e,t,r){var a=xnm.aio.hue.DMError,n=xnm.aio.hue.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.address&&void 0!==e.address){if(e.category){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,i,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){i=s[o];break;}}i?r(null,e):r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.INVALID,"catagory is invalid"));}else r(new a(n.INVALID,"address is invalid"));}else r(new a(n.INVALID,"gateway is invalid"));}else r(new a(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var a=xnm.aio.hue.DMError,n=xnm.aio.hue.DMError.ERROR_CODE;if(e){if(null!=e.address&&void 0!==e.address){if(e.category){if(e.gateway){var o,i,s=t.data.gateways;for(o=0;o<s.length;o++){if(s[o].index===e.gateway){i=s[o];break;}}i?r(null,e):r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.INVALID,"gateway is invalid"));}else r(new a(n.INVALID,"catagory is invalid"));}else r(new a(n.INVALID,"address is invalid"));}else r(new a(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,a=0;a<e.length;a++){if(e[a]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var r=[],a=null,n=xnm.aio.hue.DM.getCommandStatusMap(e);return n&&(a=function(e,t,r){var a=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});}return a;}(n,0,t),r=r.concat(a)),r;};if(!e.category)return null;var r=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter(e,t),r.command=a;break;case"status":a=_filter(e,t),r.status=a;break;default:return null;}return a&&0!=a.length?r:null;},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e.sys)return null;if("sensor"!=e.category)return null;var r=this.getCommandStatusMap(e);if(!r)return null;var a=JSON.parse(JSON.stringify(e));return a.ipevt=r.ipevt,a;},getCommandStatusMap:function getCommandStatusMap(e,t){var _mergemap=function _mergemap(e,t){var r=[],a=[];return e&&e.command&&e.command.length>0&&(r=r.concat(e.command)),t&&t.command&&t.command.length>0&&(r=r.concat(t.command)),e&&e.status&&e.status.length>0&&(a=a.concat(e.status)),t&&t.status&&t.status.length>0&&(a=a.concat(t.status)),{command:r,status:a};};if(!e.type)return null;if("sensor"==e.category)return"ROM001"==e.modelid?xnm.aio.hue.MAP.sensor.SmartButton:xnm.aio.hue.MAP.sensor[e.type];var r=e.type.toLowerCase(),a=[];if(e.state||e.action){var n=e.state;"room"!=r&&"lightgroup"!=r&&"luminaire"!=r&&"lightsource"!=r&&"zone"!=r||(n=e.action),n&&(null!=n.on&&void 0!==n.on&&(a=_mergemap(a,xnm.aio.hue.MAP.onoff)),null!=n.bri&&void 0!==n.bri&&(a=_mergemap(a,xnm.aio.hue.MAP.dimmable)),null!=n.ct&&void 0!==n.ct&&(a=_mergemap(a,xnm.aio.hue.MAP.colortemp)),null!=n.hue&&void 0!==n.hue&&(a=_mergemap(a,xnm.aio.hue.MAP.colorlight)),"room"!=r&&"lightgroup"!=r&&"luminaire"!=r&&"lightsource"!=r&&"zone"!=r||(a=_mergemap(a,xnm.aio.hue.MAP.group)));}else switch(e.type.toLowerCase()){case"on/off light":case"on/off plug-in unit":a=xnm.aio.hue.MAP.onoff;break;case"dimmable light":case"dimmable plug-in unit":a=_mergemap(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable);break;case"color temperature light":a=_mergemap(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.colortemp);break;case"color light":a=_mergemap(_mergemap(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colorlight);break;case"extended color light":case"lightgroup":case"luminaire":case"lightsource":a=_mergemap(_mergemap(_mergemap(xnm.aio.hue.MAP.onoff,xnm.aio.hue.MAP.dimmable),xnm.aio.hue.MAP.colortemp),xnm.aio.hue.MAP.colorlight),"lightgroup"!=r&&"luminaire"!=r&&"lightsource"!=r||(a=_mergemap(a,xnm.aio.hue.MAP.group));}return a;},supportSmartWidget:function supportSmartWidget(e){if(!e||!e.type)return!1;if("ZLLPresence"==e.type)return!0;var t=this.applyUIFilter(e,{catagory:"command",elems:"*"});if(!t||!t.command||0==t.command.length)return!1;for(var r=0;r<t.command.length;r++){var a=t.command[r];if(a&&a.ref&&("on"==a.ref.value||"up"==a.ref.value||"ct"==a.ref.value||"rgb"==a.ref.value))return!0;}return!1;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,r){if(!e||!e.type)return!1;var a=this.applyUIFilter(e,{catagory:"command",elems:"*"});if(!a||!a.command||0==a.command.length)return!1;for(var n,o,i,s=!1,u=!1,l=!1,d=!1,c=0;c<a.command.length;c++){var m=a.command[c];m&&m.ref&&("on"==m.ref.value&&(s=!0),"up"==m.ref.value&&(u=!0),"ct"==m.ref.value&&(l=!0),"rgb"==m.ref.value&&(d=!0));}return"ZLLPresence"==e.type&&(o={"%motionState%":{value:"motion2",options:["on","off"],name:"detect motion (on/off)"}},i=["motion"]),s&&(n||(n={}),n["%on%"]||(n["%on%"]={value:"on",name:"on"}),n["%off%"]||(n["%off%"]={value:"off",name:"off"}),n["%toggle%"]||(n["%toggle%"]={value:"toggle",name:"toggle"}),o||(o={}),o["%switchState%"]||(o["%switchState%"]={value:"power",options:["off","on"],name:"power"}),i||(i=[]),-1==i.indexOf("switch")&&i.push("switch")),u&&(n||(n={}),n["%dimOn%"]||(n["%dimOn%"]={value:"on",name:"on"}),n["%dimOff%"]||(n["%dimOff%"]={value:"off",name:"off"}),n["%dimUp%"]||(n["%dimUp%"]={value:"up",name:"up"}),n["%dimDown%"]||(n["%dimDown%"]={value:"down",name:"down"}),n["%dimTo%"]||(n["%dimTo%"]={value:"bri",ext:"%d",extMeta:"0-100",name:"brightness"}),o||(o={}),o["%dimmerState%"]||(o["%dimmerState%"]={value:"brightness",name:"brightness"}),i||(i=[]),-1==i.indexOf("dimmer")&&i.push("dimmer")),l&&(n||(n={}),n["%colorTemp%"]||(n["%colorTemp%"]={value:"ct",ext:"%d",extMeta:"153-500",name:"color temperature"}),i||(i=[]),-1==i.indexOf("color_temp")&&i.push("color_temp")),d&&(n||(n={}),n["%rgb%"]||(n["%rgb%"]={value:"rgb",ext:"%s",name:"rgb color"}),n["%white%"]||(n["%white%"]={value:"rgbS",ext:"FFFFFF",name:"rgb color"}),i||(i=[]),-1==i.indexOf("rgb")&&i.push("rgb")),i&&0!=i.length?this._injectToSmartWidgetTemplate(t,i,r,n,o):null;},_injectToSmartWidgetTemplate:function _injectToSmartWidgetTemplate(e,t,r,a,n){var o=[];e||(a={}),a||(a={}),n||(n={});for(var i=0;i<e.length;i++){var s=e[i];if(s.meta&&-1!=t.indexOf(s.meta.type)&&s.elements){var u=JSON.parse(JSON.stringify(s)),l=!1;for(var d in u.elements){var c=u.elements[d];if(c&&Array.isArray(c))for(var m=0;m<c.length;m++){var h=c[m];h&&(h.action&&"command"==h.action.type&&h.action.ref&&h.action.ref.value&&(a[h.action.ref.value]?(h.action.ref=a[h.action.ref.value],h.action.device=r,l=!0):h.action=null),h.status&&h.status.ref&&h.status.ref.value&&(n[h.status.ref.value]?(h.status.ref=n[h.status.ref.value],h.status.device=r,l=!0):h.status=null));}}l&&o.push(u);}}return o;}},xnm.aio.hue.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"hue");},xnm.aio.hue.Handler.prototype.devicemanager=xnm.aio.hue.DM,xnm.aio.hue.Handler.prototype.Light=xnm.aio.hue.Light,xnm.aio.hue.Handler.prototype.Group=xnm.aio.hue.Group,xnm.aio.hue.Handler.prototype.Scene=xnm.aio.hue.Scene,xnm.aio.hue.Handler.prototype.Sensor=xnm.aio.hue.Sensor,xnm.aio.hue.Handler.prototype.discoverBridgesWithTimeout=function(e,t){this._discoverCallbacks||(this._discoverCallbacks=[]);for(var r=!1,a=0;a<this._discoverCallbacks.length;a++){if(this._discoverCallbacks[a]===t){r=!0;break;}}r||this._discoverCallbacks.push(t);var n=this,o=[];e<=10&&(e=10);setTimeout(function(){if(null!=n._discoverCallbacks)for(var e=0;e<n._discoverCallbacks.length;e++){n._discoverCallbacks[e](null,o);}n._discoverCallbacks=null;},1e3*e),this.discoverBridges(function(e){if(e){for(var t=0;t<o.length;t++){if(o[t].uuid==e.uuid)return;}o.push(e);}});},xnm.aio.hue.Handler.prototype.auth=function(e,t){if(e.ip){var r=this.resolveGateway(e);r?r.authorizeUser2(function(e,r){t&&t(e,r);}):t&&t(new Error("gateway json format invalid"));}else t&&t(new Error("bridge format invalid"));},xnm.aio.hue.Handler.prototype.getDeviceList=function(e,t){if(e.ip){var r=this.resolveGateway(e);if(r){var a=3,n=[];xnm.aio.hue.Light.getAllLights(r,function(e,r){a--,e&&e,r&&(n=n.concat(r)),0==a&&t&&t(e,n);}),xnm.aio.hue.Group.getAllGroups(r,function(e,r){a--,e&&e,r&&(n=n.concat(r)),0==a&&t&&t(e,n);}),xnm.aio.hue.Sensor.getAllSensors(r,function(e,r){a--,e&&e,r&&(n=n.concat(r)),0==a&&t&&t(e,n);});}else t&&t(new Error("gateway json format invalid"));}else t&&t(new Error("bridge format invalid"));},xnm.aio.hue.Handler.prototype.createGroup=function(e,t,r){if(e.ip){var a=this.resolveGateway(e);a?xnm.aio.hue.Group.createGroup(a,t,r):r&&r(new Error("gateway json format invalid"));}else r&&r(new Error("bridge format invalid"));},xnm.aio.hue.Handler.prototype.resolveGateway=function(e){return new xnm.aio.hue.Bridge(e.ip,e.port,e.uuid,null,e.username);},xnm.aio.hue.Handler.prototype.getDeviceCommands=function(e,t){var r=xnm.aio.hue.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),a=r?r.command:[];t&&t(null,a);},xnm.aio.hue.Handler.prototype.getDeviceStatus=function(e,t){var r=xnm.aio.hue.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),a=r?r.status:[];t&&t(null,a);},xnm.aio.hue.Handler.prototype.getSceneCommands=function(e,t){if(e.ip){var r=this.resolveGateway(e);r?xnm.aio.hue.Scene.getAllScenes(r,function(e,r){if(e)t&&t(e);else{var a={};if(r)for(var n in r){r.hasOwnProperty(n)&&r[n]&&r[n].name&&(a[n]=r[n].name);}t&&t(null,a);}}):t&&t(new Error("gateway json format invalid"));}else t&&t(new Error("bridge format invalid"));},xnm.aio.hue.Handler.prototype.doCommand=function(e,t,r,a){var n=this.resolveGateway(e);n?n.executeCommandCreator(t,r,function(e){a&&a(e);}):a&&a(new Error("gateway json format invalid"));},xnm.aio.hue.Handler.prototype.doStatus=function(e,t,r,a,n){var o=this.resolveGateway(t);if(o){var i=[{id:e,device:r,status:a}];o.getStatesCreator(null,i,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json format invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.hue.Handler());