var m=m||{};m.aio=m.aio||{},m.aio.voicemanager=m.aio.voicemanager||{},m.aio.voicemanager.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var o=JSON.parse(JSON.stringify(e));if(o.auth&&(o.auth="xxxxxx:xxxxxx"),o.headers)for(var n in headers){if(n&&"authorization"==n.toLocaleLowerCase()){var t=headers[n];if(t){var a=t.indexOf(" ");headers[n]=-1==a?"xxxxxx":t.substr(0,a)+" xxxxxx";}}}return o;}catch(o){return e;}}},m.aio.voicemanager.CloudConfigHandler=function(){var CloudConfigHandler=function CloudConfigHandler(e,o){this._devicemanager=e,this._macromanager=o;};CloudConfigHandler.prototype._getCloudDeviceConfig=function(e,o,n){var t=null;if(!o)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));var a=require("xnm.aio.cloudservice.js").resolveGateway(o);if(!a)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));this._getCloudDevicesFromDB(e,a,function(e,o){if(e)n&&n(e);else if(o&&0!=o.length){var t=o.map(function(e){var o=e.info;return delete o.gateway,delete o.commands,delete o.states,o;});a.toCloudDevice(t,function(e,t){if(e)return e.code=40003,void(n&&n(e));if(t&&0!=t.length){for(var a={},r=0;r<o.length;r++){var i=o[r];if(i)for(var s=0;s<t.length;s++){var l=t[s];l&&(l.data&&i.info.module==l.data.mod&&i.info.connection==l.data.connection&&i.info.id==l.data.id?(l.name=i.__cloudref,a[i.__cloudref]=l):i.info.module==l.mod&&i.info.connection==l.connection&&i.info.id==l.id&&(l.name=i.__cloudref,l.data={mod:l.mod,connection:l.connection,id:l.id},delete l.mod,delete l.connection,delete l.id,a[i.__cloudref]=l));}}n&&n(null,a);}else n&&n(null,{});});}else n&&n(null,{});});},CloudConfigHandler.prototype._mergeConfig=function(e,o){var n,t={};if(e)for(n in e){t[n]=e[n];}if(o)for(n in o){t[n]=o[n];}return t;},CloudConfigHandler.prototype._getCloudDevicesFromDB=function(e,o,n){var _find=function _find(e,o){for(var n=0;n<o.length;n++){var t=o[n];if(t&&t.index==e)return t;}return null;},t=this,a=require("xnm.aio.cloudservice.js"),r={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",e,"device",r,function(i,s){if(i)return i.code=40001,void(n&&n(i));s&&0!=s.length?(r={filter:"prop","info.sys":"cloudservice"},t._devicemanager.execute("read",e,"gateway",r,function(r,i){if(r)return r.code=40001,void(n&&n(r));i&&0!=i.length?t._devicemanager.execute("read",e,"room",null,function(e,t){if(e)return e.code=40001,void(n&&n(e));if(t&&0!=t.length){for(var r=[],l=0;l<s.length;l++){var u=s[l];if(u&&u.info&&u.info.gateway){var c=_find(u.info.gateway,i);if(c&&c.info){var d=a.resolveGateway(c.info);if(d){if(!d.equalsTo(o))return(e=new Error("cloud device "+u.index+" belongs to another account")).code=40002,void(n&&n(e));var f=_find(u.room,t);if(f){var p=u.name,g=f.name,v=(g?g+" ":"")+(p||"");u.cloud.alias&&(v=u.cloud.alias),(u=JSON.parse(JSON.stringify(u))).__cloudref=v,r.push(u);}}}}}n&&n(null,r);}else n&&n(null,[]);}):n&&n(null,[]);})):n&&n(null,[]);});},CloudConfigHandler.prototype._getCloudEnabledDevices=function(e,o){this._devicemanager.execute("read",e,"device",{filter:"prop","cloud.enabled":!0},function(e,n){o&&o(e,n);});},CloudConfigHandler.prototype._getGateways=function(e,o){this._devicemanager.execute("read",e,"gateway",null,function(e,n){o&&o(e,n);});},CloudConfigHandler.prototype._getRooms=function(e,o){this._devicemanager.execute("read",e,"room",null,function(e,n){o&&o(e,n);});},CloudConfigHandler.prototype._getGatewayInfo=function(e,o){if(e){if("aio"==e.sys||"neoserver"==e.sys){var n,t=this,a=require("xnm.aio.gateway.js");"neoserver"==e.sys?((e=JSON.parse(JSON.stringify(e))).sys="aio",e.version="EA",n=a.resolveGateway(e,!0)):n=a.resolveGateway(e),n?a.Admin.getGatewaySID(n,function(r,i){return r?(t._logger.log("warn","get gateway sid error:"+r.message),r.code="50001",r.message="get gateway sid error:"+r.message,void(o&&o(r))):i?e.password?void a.Admin.V5.getInfo(n,function(n,a){return n?(t._logger.log("warn","get gateway info error:"+n.message),n.message="get gateway info error:"+n.message,n.code="50101",void(o&&o(n))):a&&a.server?!a.cfg||64&parseInt(a.cfg,16)?(t._logger.log("warn","gateway cloud server is deactivated"),(n=new Error("gateway cloud server is deactivated")).code="50103",void(o&&o(n))):void t._getAccessToken(a.server,i,e.password,!1,function(n,r){if(n)return(n=new Error("get accesss token error:"+n.message)).code="50003",void(o&&o(n));r?o&&o(null,r,a.server,i):t._getAccessToken(a.server,i,e.password,!0,function(e,n){if(e)return(e=new Error("generate accesss token error:"+e.message)).code="50004",void(o&&o(e));n?o&&o(null,n,a.server,i):o&&o(new Error("access token empty"));});}):(t._logger.log("warn","gateway has no cloud server"),(n=new Error("gateway has no cloud server")).code="50102",void(o&&o(n)));}):((r=new Error("gateway has no password")).code="50002",void(o&&o(r))):((r=new Error("gateway has no sid")).code="50002",void(o&&o(r)));}):o&&o(new Error("gateway json invalid"));}else o&&o(new Error("gateway type invalid"));}else o&&o(new Error("gateway json is null"));},CloudConfigHandler.prototype._getAccessToken=function(e,o,n,t,a){var r=this._parseCCS(e),i=r.port;"https"==r.protocol&&80==i&&(i=443);var s={host:r.host,port:i,path:"/getAccessToken?sid="+o,method:"GET",timeout:3e4,auth:"user:"+n,user:"user",password:n,headers:{Authorization:"Basic "+new Buffer("user:"+n).toString("base64")}};t&&(s.path+="&force=1"),this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(s)));var l=this,u=require(r.protocol).request(s,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){l._logger.log("trace","get access token reponse:"+o);try{var n=JSON.parse(o);n.XC_ERR?a&&a(new Error(n.XC_ERR.msg)):n.XC_SUC?a&&a(null,n.XC_SUC.at):a&&a(new Error("invalid response"));}catch(e){a&&a(e);}}else l._logger.log("warn","get access token error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});u.on&&u.on("error",function(e){l._logger.log("warn","get access token error:"+e.message),a&&a(e),a=null;}),u.setTimeout&&u.setTimeout(5e3,function(){u.abort(),l._logger.log("warn","get access token timeout"),a&&a(new Error("http timeout")),a=null;}),u.end();},CloudConfigHandler.prototype._parseCCS=function(e){var o=e.indexOf(":");if(-1==o)return{protocol:"https",host:e,port:443};var n=e.substr(0,o),t=e.substr(o+1);return 8080==t?t=8443:80==t&&(t=443),{protocol:"https",host:n,port:t};};var V5ConfigHandler=function V5ConfigHandler(e,o){CloudConfigHandler.call(this,e,o),this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.V5ConfigHandler"),this._targetGatewayJSON=null,this._gatewayDetail={},this._tenantIdx=null,this._currentMacroGatewayIndex=null;};return(V5ConfigHandler.prototype=new CloudConfigHandler()).constructor=V5ConfigHandler,V5ConfigHandler.prototype.setTargetGateway=function(e){this._targetGatewayJSON=e;},V5ConfigHandler.prototype.exportConfig=function(e,o,n){var t=this;this._gatewayDetail={},this._tenantIdx=e,this._currentMacroGatewayIndex=null,this._getCloudDeviceConfig(e,o,function(o,a){o?n&&n(o):t._getGatewayDeviceConfig(e,function(o,r){o?n&&n(o):t._getMacrosConfig(e,function(e,o){if(e)n&&n(e);else{var i=t._mergeConfig(a,r);i=t._mergeConfig(o,i),n&&n(null,i);}});});});},V5ConfigHandler.prototype._isSameAsTargetGateway=function(e){return!!this._targetGatewayJSON&&e.ip==this._targetGatewayJSON.ip&&e.sid==this._targetGatewayJSON.sid;},V5ConfigHandler.prototype._getGatewayDeviceConfig=function(e,o){var _find=function _find(e,o){if(!o||0==o.length)return null;for(var n=o.length;n--;){var t=o[n];if(t&&t.index==e)return t;}return null;},n=this;this._getDevicesDetail(e,function(e,t){if(e)o&&o(e);else{for(var a=t.devices,r=t.gateways,i=t.rooms,s={},l=0;l<r.length;l++){var u=r[l];u&&u.info&&"aio"==u.info.sys&&u.info.version&&("C"!=u.info.version.charAt(0)&&"E"!=u.info.version.charAt(0)||"EA"!=u.info.version&&(n._targetGatewayJSON&&!n._isSameAsTargetGateway(u.info)||(s[u.index]=u)));}0!=Object.keys(s)?n._getGatewaysDetail(Object.values(s),function(e){if(e)o&&o(e);else if(a&&0!=a.length){for(var t=[],l=0;l<a.length;l++){var u=a[l];if(u&&u.info&&"aio"==u.info.sys&&u.info.gateway){var c=_find(u.info.gateway,r);if(c&&s[u.info.gateway]){var d=_find(u.room,i);t.push({device:u,gateway:c,room:d});}}}if(0!=t.length){var f={},p=(l=0,function(e,a){!e&&a&&(f=n._mergeConfig(f,a)),++l<t.length?n._genDeviceConfig(t[l].device,t[l].gateway,t[l].room,p):o&&o(null,f);});n._genDeviceConfig(t[l].device,t[l].gateway,t[l].room,p);}else o&&o(null,{});}else o&&o(null,{});}):o&&o(null,{});}});},V5ConfigHandler.prototype._genDeviceConfig=function(e,o,n,t){if(e&&e.info&&e.info.sys){if(o&&o.index){var a=this._gatewayDetail[o.index];if(a){var r=e.info.sys,i=this._devicemanager.getModule(r);if(i&&i.devicemanager&&i.devicemanager.toGeneralDevice){var s=i.devicemanager.toGeneralDevice(e.info,null,"v5");if(!s)return void(t&&t(null,null));s.name=this._genDeviceName(e,n),s.local="http://"+o.info.ip+(o.info.port?":"+o.info.port:""),s.baseurl=this._genBaseUrl(a),s.data||(s.data={}),s.data.sid=a.sid;var l={};l[s.name]=s,t&&t(null,l);}else t&&t(new Error("sys "+r+" can not be convert to general device"));}else t&&t(new Error("no gateway detail info"));}else t&&t(new Error("invalid gateway json"));}else t&&t(new Error("invalid device json"));},V5ConfigHandler.prototype._genDeviceName=function(e,o){if(e.cloud&&e.cloud.alias)return e.cloud.alias;var n=e.name,t=o.name;return n?t?t+" "+n:n:t;},V5ConfigHandler.prototype._genBaseUrl=function(e){var o=e.ccs,n=this._parseCCS(o);return n.protocol+"://"+n.host+"/rapi/"+e.token;},V5ConfigHandler.prototype._getDevicesDetail=function(e,o){var n=this;this._getCloudEnabledDevices(e,function(t,a){t?o&&o(t):n._getGateways(e,function(t,r){t?o&&o(t):n._getRooms(e,function(e,n){o&&o(e,{devices:a,gateways:r,rooms:n});});});});},V5ConfigHandler.prototype._getGatewaysDetail=function(e,o){var n=this,t=0,cb=function cb(a,r,i,s){a?o&&o(a):(n._gatewayDetail[e[t].index]={sid:s,ccs:i,token:r},++t<e.length?n._getGatewayInfo(e[t].info,cb):o&&o());};n._getGatewayInfo(e[t].info,cb);},V5ConfigHandler.prototype._getMacrosConfig=function(e,o){var n=this;this._macromanager.execute(e,"read",null,null,null,function(e,t){if(e)o&&o(e);else if(t&&t.groups&&0!=t.groups.length){for(var a={},r=0;r<t.groups.length;r++){var i=t.groups[r];if(i&&i.macros&&i.macros.length>0){var s=0,cb=function cb(e,o,t){!e&&o&&t&&(a[o]=t),++s<i.macros.length&&n._getMacroConfig(i,i.macros[s],cb);};n._getMacroConfig(i,i.macros[s],cb);}}o&&o(null,a);}else o&&o(null,{});});},V5ConfigHandler.prototype._getMacroConfig=function(e,o,n){if(o&&o.cloud&&o.cloud.enabled){var t=e.name+" "+o.name;o.cloud.alias&&(t=o.cloud.alias);var a={name:t,type:"scene",commands:{on:{type:"POST",url:null,data:[]}}};this._currentMacroGatewayIndex=null;var r=this;if(o.commands&&o.commands.length>0){var i=0,cb=function cb(e,s,l){if(!e&&s&&a.commands.on.data.push(s),++i<o.commands.length)r._convertMacroCommand(o.commands[i],cb);else{var u=r._gatewayDetail[r._currentMacroGatewayIndex];u?(a.commands.on.url=r._genBaseUrl(u)+"/macro",n&&n(null,t,a)):n&&n(new Error("no main gateway"));}};this._convertMacroCommand(o.commands[i],cb);}}else n&&n(null,null,null);},V5ConfigHandler.prototype._convertMacroCommand=function(e,o){if(e&&e.classid)switch(e.classid){case"sleep":o(null,{P:e.time});break;case"command":if(!e.action||!e.action.device)return void o(new Error("invalid macro device command"));this._convertMacroDeviceCommand(e,o);break;default:o(new Error("unknown macro command"));}else o(new Error("invalid macro command"));},V5ConfigHandler.prototype._convertMacroDeviceCommand=function(e,o){var n=this;this._devicemanager.execute("read",this._tenantIdx,"device",{filter:"prop",index:e.action.device.index},function(t,a){if(t)o(t);else if(a&&0!=a.length){var r=a[0];r&&r.info&&r.info.sys?"aio"==r.info.sys?n._devicemanager.execute("read",n._tenantIdx,"gateway",{filter:"prop",index:r.info.gateway},function(t,a){if(t)o(t);else if(a&&0!=a.length){var i=a[0];if(i&&i.info&&i.index){n._gatewayDetail[i.index]&&(n._currentMacroGatewayIndex||(n._currentMacroGatewayIndex=i.index));var s=require("xnm.aio.gateway.js").devicemanager.getSystem(r.info,i.info);if(s){var l={value:e.action.value,ext:e.action.ext};if(s.buildQuery){var u=s.buildQuery(i.info,r.info,l);if(u){var c={},d=null;if("SendGenericCmd"==u.XC_FNC){if(d="/cmd?XC_FNC=SendGenericCmd&id="+u.id,u.data)for(var f in u.data){d+="&"+f+"="+(null==u.data[f]||null==u.data[f]?"":encodeURIComponent(u.data[f]));}}else if("/api/command"==u.fnc)d="/api/command?json=",u.data&&(d+=encodeURIComponent(JSON.stringify(u.data)));else for(var f in d="/cmd?",u){d+="&"+f+"="+(null==u[f]||null==u[f]?"":encodeURIComponent(u[f]));}i.index==n._currentMacroGatewayIndex?c.C=d:c.A={host:i.info.ip,cmd:d},o(null,c);}else o(new Error("invalid device command"));}else o(new Error("system do not support command"));}else o(new Error("unknown device type"));}else o(new Error("invalid gateway json"));}else o(new Error("no such gateway"));}):o(null,null):o(new Error("invalid device json"));}else o(new Error("no such device"));});},{V5:V5ConfigHandler};}(),m.aio.voicemanager.AlexaHandler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Cloud"),this._customMap=null;};return Handler.LANG=["en","de"],Handler.MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],up:["up","up"],down:["down","down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],dimup:["up","up"],dimdown:["down","down"],dimto:["value","value"],"move up":["up","up"],"move down":["down","down"],"move to":["value","value"],moveup:["up","up"],movedown:["down","down"],moveto:["value","value"],stop:["off","off"],brightness:["value","value"],"brightness up":["up","up"],"brightness down":["down","down"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set temperature":["value","value"],temperature:["value","value"],"set point":["value","value"],"mode auto":["auto","auto"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],auto:["auto","auto"],"mode manu":["manu","manu"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],manu:["manu","manu"],"mode boost":["boost","boost"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],boost:["boost","boost"],white:["white","weiß"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","grün"],yellow:["yellow","gelb"],orange:["orange","orange"],mode:["mode","mode"],"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"],"volume to":["value","value"]},Handler.HM_MAP={"short press":["short press","kurz drücken"],"long press":["long press","lange drücken"],"set value":["value","value"],red:["red","rot"],green:["green","grün"],orange:["orange","orange"],on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"move up":["up","up"],"move down":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","öffnen"],lock:["lock","abschließen"],unlock:["unlock","aufschließen"],"temperature up":["up","up"],"temperature down":["down","down"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"set manual mode":["manu","manu"],"set manu mode":["manu","manu"],"set boost mode":["boost","boost"],"set comfort mode":["comfort","komfort"],"lamella up":["lamella up","lamella up"],"lamella down":["lamella down","lamella down"],"lamella to":["lamella to","lamella to"]},Handler.AIO_MAP={on:["on","on"],off:["off","off"],toggle:["toggle","toggle"],"mode auto":["auto","auto"],"mode manu":["manu","manu"],"mode toggle":["toggle","toggle"],up:["up","up"],down:["down","down"],"up step bit":["step up","step up"],"down step bit":["step down","step down"],"dim up":["up","up"],"dim down":["down","down"],"dim to":["value","value"],"dim off":["off","off"],Auf:["up","up"],Ab:["down","down"],Stop:["off","off"],"move up":["up","up"],"move down":["down","down"],"move in":["up","up"],"move out":["down","down"],"level up":["up","up"],"level down":["down","down"],"start dim":["up","up"],"stop dim":["down","down"],"step up":["step up","step up"],"step down":["step down","step down"],"move to":["value","value"],stop:["off","off"],open:["open","öffnen"],close:["close","schließen"],lock:["lock","abschließen"],unlock:["unlock","aufschließen"],"temperature up":["up","up"],"temperature down":["down","down"],"set temperature":["value","value"],"temperature to":["value","value"],"set auto mode":["auto","auto"],"auto mode":["auto","auto"],"set manual mode":["manu","manu"],"manu mode":["manu","manu"],"set boost mode":["boost","boost"],"boost mode":["boost","boost"],"boost on":["boost","boost"],"boost off":["boost off","boost aus"],"heater on":["heater on","heizung an"],"heater off":["heater off","heizung aus"],"led on":["led on","led an"],"led off":["led off","led aus"],"chime on":["chime on","chime an"],"chime off":["chime off","chime aus"],"panic alarm on":["panic on","panic an"],"panic alarm off":["panic off","panic aus"],disarmed:["disarm","entschärfen"],"all armed":["arm","scharf schalten"],"lamella up":["lamella up","lamella hoch"],"lamella down":["lamella down","lamella runter"],"lamella step up":["lamella step up","lamella step up"],"lamella step down":["lamella step down","lamella step down"],"lamella to":["lamella to","lamella to"],lamella:["lamella to","lamella to"],"tilt to":["lamella to","lamella to"],"preset position":["position to","position to"],activate:["on","on"],deactivate:["off","off"],A:["off","off"],B:["off","off"],C:["off","off"],"do scene":["do scene","scene starten"],brightness:["value","value"],color:["color","farblich"],white:["white","weiß"],red:["red","rot"],purple:["purple","violett"],blue:["blue","blau"],cyan:["cyan","cyan"],green:["green","grün"],yellow:["yellow","gelb"],orange:["orange","orange"],position:["value","value"],"position 1":["position 1","position 1"],"position 2":["position 2","position 2"],"brightness up":["up","up"],"brightness down":["down","down"],"set value":["value","value"]},Handler.SONOS_MAP={play:["play","play"],pause:["pause","pause"],stop:["off","off"],previous:["previous","previous"],next:["next","next"],"shuffle on":["shuffle on","shuffle on"],"shuffle off":["shuffle off","shuffle off"],"repeat off":["repeat off","repeat off"],"repeat all":["repeat all","repeat all"],"repeat one":["repeat one","repeat one"],"group volume":["value","value"],"group volume up":["up","up"],"group volume down":["down","down"],"group mute":["mute","mute"],"group unmute":["unmute","unmute"],volume:["value","value"],"volume up":["up","up"],"volume down":["down","down"],mute:["mute","mute"],unmute:["unmute","unmute"]},Handler.HUE_MAP={"color temperature":["color temperature","color temperatur"]},Handler.MILIGHT_MAP={"disco speed up":["faster","schneller"],"disco speed down":["slower","langsamer"],"speed up":["faster","schneller"],"speed down":["slower","langsamer"],"mode up":["next mode","nächste mode"],"mode down":["previous mode","vorherige mode"],"full brightness":["max","max"],"warm white up":["warmer","wärmer"],"cool white up":["cooler","kälter"],"max brightness":["max","max"],"night mode":["night mode","nacht mode"],"night light on":["night mode","nacht mode"],warmer:["warmer","wärmer"],cooler:["cooler","kälter"]},Handler.OSRAM_MAP={"color temperature":["color temperature","color temperatur"],"do scene":["scene","szene"]},Handler.HARMONY_MAP={"power on":["on","on"],"power off":["off","off"],poweron:["on","on"],poweroff:["off","off"],stop:["stop","stop"],volumeup:["up","up"],volumedown:["down","down"],"volume up":["up","up"],"volume down":["down","down"]},Handler.AV_MAP={stop:["stop","stop"]},Handler.TADO_MAP={"set manu temperature":["value","value"],manu:["value","value"]},Handler.NETATMO_MAP={manu:["value","value"]},Handler.FIBAROHC_MAP={"set value":["value","value"]},Handler.REMOTE_SERVER="https://cloud.mediola.com",Handler.prototype._getAccessToken=function(e,o,n,t,a){var r={host:require("url").parse("https://"+e).hostname,port:443,path:"/getAccessToken?sid="+o,method:"GET",timeout:3e4,auth:"user:"+n,user:"user",password:n,headers:{Authorization:"Basic "+new Buffer("user:"+n).toString("base64")}};t&&(r.path+="&force=1"),this._logger.log("trace","send get access token to:"+JSON.stringify(m.aio.voicemanager.Util.clearHttpOptionForLog(r)));var i=this,s=require("https").request(r,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){i._logger.log("trace","get access token reponse:"+o);try{var n=JSON.parse(o);n.XC_ERR?a&&a(new Error(n.XC_ERR.msg)):n.XC_SUC?a&&a(null,n.XC_SUC.at):a&&a(new Error("invalid response"));}catch(e){a&&a(e);}}else i._logger.log("warn","get access token error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});s.on&&s.on("error",function(e){i._logger.log("warn","get access token error:"+e.message),a&&a(e),a=null;}),s.setTimeout&&s.setTimeout(5e3,function(){s.abort(),i._logger.log("warn","get access token timeout"),a&&a(new Error("http timeout")),a=null;}),s.end();},Handler.prototype._processHMCommands=function(e,o,n){return this._processCommandsFromMap(Handler.HM_MAP,e,o,n);},Handler.prototype._processAIOCommands=function(e,o,n){return this._processCommandsFromMap(Handler.AIO_MAP,e,o,n);},Handler.prototype._processSonosCommands=function(e,o,n){return this._processCommandsFromMap(Handler.SONOS_MAP,e,o,n);},Handler.prototype._processHueCommands=function(e,o,n){return this._processCommandsFromMap(Handler.HUE_MAP,e,o,n);},Handler.prototype._processMilightCommands=function(e,o,n,t){return this._processCommandsFromMap(Handler.MILIGHT_MAP,e,o,n,t);},Handler.prototype._processOsramCommands=function(e,o,n){return this._processCommandsFromMap(Handler.OSRAM_MAP,e,o,n);},Handler.prototype._processHarmonyCommands=function(e,o,n,t){return this._processCommandsFromMap(Handler.HARMONY_MAP,e,o,n,t);},Handler.prototype._processMcontrolCommands=function(e,o,n){if(e&&e.info&&e.info.command){var t=JSON.parse(JSON.stringify(e.info.command));e.info.command=t,e.info.command.push({type:"enum",name:"on",ref:{value:"do",ext:"on"}}),e.info.command.push({type:"enum",name:"off",ref:{value:"do",ext:"off"}}),e.info.command.push({type:"enum",name:"up",ref:{value:"do",ext:"up"}}),e.info.command.push({type:"enum",name:"down",ref:{value:"do",ext:"down"}}),e.info.command.push({type:"int",name:"move to",ref:{value:"setInt",ext:"%d"}});}return this._processCommandsFromMap(null,e,o,n);},Handler.prototype._processFibaroHCCommands=function(e,o,n){if(n&&"blind"==n.type&&e&&e.info&&e.info.command){for(var t=JSON.parse(JSON.stringify(e.info.command)),a=0;a<t.length;a++){var r=t[a];switch(r.name){case"open":r.name="up";break;case"close":r.name="down";break;case"up":r.name="step up";break;case"down":r.name="step down";break;case"stop":r.name="off";}}e.info.command=t;}return this._processCommandsFromMap(Handler.FIBAROHC_MAP,e,o,n);},Handler.prototype._processAVCommands=function(e,o,n,t){return this._processCommandsFromMap(Handler.AV_MAP,e,o,n,t);},Handler.prototype._processTadoCommands=function(e,o,n){return this._processCommandsFromMap(Handler.TADO_MAP,e,o,n);},Handler.prototype._processNetatmoCommands=function(e,o,n){return this._processCommandsFromMap(Handler.NETATMO_MAP,e,o,n);},Handler.prototype._processCommandsFromMap=function(e,o,n,t,a){n=n?String(n).toLowerCase():"de";var r={},i=Handler.LANG.indexOf(n);for(var s=0;s<o.info.command.length;s++){var l=o.info.command[s];if("string"===l.type&&("aio"!==o.info.sys||"STRING"!==o.info.type))continue;if("root"===l.type){this._processRootCommandsFromMap(r,l,e,o,n,t,a);continue;}var u={type:"POST",url:"/cmd",original:l.name,data:{XC_FNC:"SendRM",device:o.index,command:JSON.parse(JSON.stringify(l.ref))}};var c=l.name.toLowerCase();var d=Handler.MAP[c]?Handler.MAP[c][i]:null,f=e&&e[c]?e[c][i]:null;f&&(d=f);var p=null,g=null;var v=o.info.sys;if(this._customMap&&v&&this._customMap[v]&&(g=this._customMap[v],p=g[l.name]?g[l.name][i]:null),p&&(d=p),"%d"!==l.ref.ext&&"%f"!==l.ref.ext&&"%s"!==l.ref.ext){if("%e"!==l.ref.ext)"rgb"!==l.type&&"rgbw"!==l.type?(d||(d=l.name),r[d]=u,p&&(u.mappedCustom=!0)):(u=JSON.parse(JSON.stringify(u)),u.data.command.ext="FF0000",r[Handler.MAP.red[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="FF00FF",r[Handler.MAP.purple[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="0000FF",r[Handler.MAP.blue[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="00FFFF",r[Handler.MAP.cyan[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="00FF00",r[Handler.MAP.green[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="FFFF00",r[Handler.MAP.yellow[i]]=u,u=JSON.parse(JSON.stringify(u)),u.data.command.ext="FF8C00",r[Handler.MAP.orange[i]]=u,"rgbw"===l.type&&(u=JSON.parse(JSON.stringify(u)),u.data.command.ext="FFFFFF",r[Handler.MAP.white[i]]=u));else if(d||(d=l.name),l.ref.extMeta&&l.ref.extMeta.length>0)for(var _e=0;_e<l.ref.extMeta.length;_e++){var _o=JSON.parse(JSON.stringify(u));_o.data.command.ext=l.ref.extMeta[_e],_o.original+=" "+l.ref.extMeta[_e];var _n=d+" "+l.ref.extMeta[_e];if(this._customMap&&v&&this._customMap[v]){g=this._customMap[v];var _e2=g[_o.original]?g[_o.original][i]:null;_e2&&(_n=_e2);}r[_n]=_o;}}else{if(u.data.command.ext="{val}","%f"===l.ref.ext&&(u["float"]=1),l.ref.extMeta){var _e3=l.ref.extMeta.indexOf("-",1);if(-1!=_e3){var _o2=parseFloat(l.ref.extMeta.substr(0,_e3)),_n2=parseFloat(l.ref.extMeta.substr(_e3+1));u.min=_o2,u.max=_n2;}}l.ref.scale&&(u.step=parseFloat(l.ref.scale)),d||(d=l.name),"value"===d?("%s"!==l.ref.ext||r[d],r[d]=u):(t&&!t.values&&(t.values={}),t&&t.values&&(t.values[d]=u));}}return r;},Handler.prototype._processRootCommandsFromMap=function(e,o,n,t,a,r,i){a||(a="de"),a=a.toLowerCase();var s={},l=Handler.LANG.indexOf(a);if(o&&o.value&&o.children&&0!=o.children.length){if("mainzone"!=o.value&&"global"!=o.value){var u=r.name+" "+o.name,c={name:u,type:r.type,sys:r.sys,baseurl:r.baseurl,commands:{}};i[u]=c,e=c.commands;}for(var d=0;d<o.children.length;d++){var f=o.children[d];if(("string"!=f.type||"aio"==t.info.sys&&"STRING"==t.info.type)&&"root"!=f.type){var p={type:"POST",url:"/cmd",original:f.name,data:{XC_FNC:"SendRM",device:t.index,command:JSON.parse(JSON.stringify(f.ref))}};p.data.command.path=[o.value];var g=f.name.toLowerCase(),v=Handler.MAP[g]?Handler.MAP[g][l]:null,h=n&&n[g]?n[g][l]:null;h&&(v=h);var w=null,y=null,_=t.info.sys;if(this._customMap&&_&&this._customMap[_]&&(w=(y=this._customMap[_])[f.name]?y[f.name][l]:null),w&&(v=w),"%d"!=f.ref.ext&&"%f"!=f.ref.ext&&"%s"!=f.ref.ext){if("%e"!=f.ref.ext)"rgb"!=f.type&&"rgbw"!=f.type?(v||(v=f.name),e[v]=p,w&&(p.mappedCustom=!0)):((p=JSON.parse(JSON.stringify(p))).data.command.ext="FF0000",e[Handler.MAP.red[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FF00FF",e[Handler.MAP.purple[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="0000FF",e[Handler.MAP.blue[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="00FFFF",e[Handler.MAP.cyan[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="00FF00",e[Handler.MAP.green[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FFFF00",e[Handler.MAP.yellow[l]]=p,(p=JSON.parse(JSON.stringify(p))).data.command.ext="FF8C00",e[Handler.MAP.orange[l]]=p,"rgbw"==f.type&&((p=JSON.parse(JSON.stringify(p))).data.command.ext="FFFFFF",e[Handler.MAP.white[l]]=p));else if(v||(v=f.name),f.ref.extMeta&&f.ref.extMeta.length>0)for(var C=0;C<f.ref.extMeta.length;C++){var x=JSON.parse(JSON.stringify(p));x.data.command.ext=f.ref.extMeta[C],x.original+=" "+f.ref.extMeta[C];var b=v+" "+f.ref.extMeta[C];if(this._customMap&&_&&this._customMap[_]){var M=(y=this._customMap[_])[x.original]?y[x.original][l]:null;M&&(b=M);}e[b]=x;}}else{if(p.data.command.ext="{val}","%f"==f.ref.ext&&(p["float"]=1),f.ref.extMeta){var O=f.ref.extMeta.indexOf("-",1);if(-1!=O){var S=parseFloat(f.ref.extMeta.substr(0,O)),F=parseFloat(f.ref.extMeta.substr(O+1));p.min=S,p.max=F;}}f.ref.scale&&(p.step=parseFloat(f.ref.scale)),v||(v=f.name),"value"==v?("%s"!=f.ref.ext||s[v],s[v]=p):(r&&!r.values&&(r.values={}),r&&r.values&&(r.values[v]=p));}}}return e;}},Handler.prototype._isDeviceHeater=function(e){if(!e||!e.info)return!1;var o=e.info;if("hm"==o.sys){var n=String(o.type).toLowerCase();return["hm-cc-rt-dn","hm-cc-rt-dn-bom","hm-cc-tc","hm-cc-vg-1","hm-tc-it-wm-w-eu","hmip-bwth","hmip-bwth24","hmip-etrv","hmip-etrv-2","hmip-etrv-b","hmip-etrv-b1","hmip-etrv-c","hmip-heating","hmip-sth","hmip-sthd","hmip-wth","hmip-wth-2","hmip-wth-b","hmipw-sth","hmipw-sthd","hmipw-wth","zel stg rm fwt"].indexOf(n)>=0;}if("aio"==o.sys){if("HM"==o.type){if(-1!=["heater","thermostat","wallthermo","wallthermostat","ip_heater","ip_wallthermo","ip_wallthermo2"].indexOf(o.data))return!0;}else if("FHT80b"==o.type)return!0;}else if("max"==o.sys){if(1==o.type||2==o.type||3==o.type)return!0;}else{if("tado"==o.sys)return!0;if("netatmo"==o.sys){if("NATherm1"==o.type)return!0;}else if("gira"===o.sys&&"heater"===o.type)return!0;}return!1;},Handler.prototype._isDeviceScene=function(e){return!(!e||!e.info||"hm"!=e.info.sys)&&"Prog"==e.info.type;},Handler.prototype._isDeviceBlind=function(e){return!(!e||!e.info)&&"NY"===e.info.type&&"shutter"===e.info.data;},Handler.prototype._getDeviceCatagory=function(e){if(!e||!e.info)return null;if(this._isDeviceHeater(e))return"heater";if(this._isDeviceScene(e))return"scene";if(this._isDeviceBlind(e))return"blind";if(!e.info.command)return null;if("fibaro"==e.info.sys)return this._getFibaroHCDeviceCatagory(e);for(var o=e.info.command,n=!1,t=0;t<o.length;t++){var a=o[t];if(a&&a.name){var r=a.name.toLowerCase();if(("hue"==e.info.sys||"osram"==e.info.sys)&&"brightness"==r)return"light";if("moveto"==r||"move to"==r||"position to"==r||"positionto"==r)return"blind";if("dimto"==r||"dim to"==r||"levelto"==r||"level to"==r)return"light";"on"==r?n=!0:"off"==r&&!0;}}return n||n?"switch":null;},Handler.prototype._getFibaroHCDeviceCatagory=function(e){for(var o=e.info.command,n=[],t=0;t<o.length;t++){var a=o[t];if(a&&a.name){var r=a.name.toLowerCase();-1==n.indexOf(r)&&n.push(r);}}return-1!=n.indexOf("open")&&-1!=n.indexOf("close")?"blind":-1!=n.indexOf("up")&&-1!=n.indexOf("down")&&-1!=n.indexOf("set value")?"light":-1!=n.indexOf("on")&&-1!=n.indexOf("off")?"switch":null;},Handler.prototype._convertDeviceToCloudFormat=function(e,o,n,t,a){var r=e.info.sys,i=e.info.type,s=this._getDeviceCatagory(e);s&&(i=s);var l={name:o,type:i,module:r,sys:r,baseurl:n,commands:{},states:{}};if("aio"==r&&"TASK"==e.info.type)return{name:o,type:"scene",module:r,sys:r,baseurl:n,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:e.index,command:{value:"run"}}}}};if("hm"==r&&"Prog"==e.info.type)return l={name:o,type:"scene",module:r,sys:r,baseurl:n,commands:{on:{type:"POST",url:"/cmd",original:"run",data:{XC_FNC:"SendRM",device:e.index,command:{value:"progExec"}}}}};if(e.info.command&&e.info.command.length>0){var u;switch(r){case"hm":u=this._processHMCommands(e,t,l,a);break;case"aio":u=this._processAIOCommands(e,t,l,a);break;case"sonos":u=this._processSonosCommands(e,t,l,a);break;case"hue":u=this._processHueCommands(e,t,l,a);break;case"easyled":case"milight":case"milightv6":u=this._processMilightCommands(e,t,l,a);break;case"lightify":u=this._processOsramCommands(e,t,l,a);break;case"harmony":case"pioneer":case"onkyo":case"denon":case"yamaha":u=this._processHarmonyCommands(e,t,l,a);break;case"mcontrol":u=this._processMcontrolCommands(e,t,l,a);break;case"fibaro":u=this._processFibaroHCCommands(e,t,l,a);break;case"tado":u=this._processTadoCommands(e,t,l,a);break;case"netatmo":u=this._processNetatmoCommands(e,t,l,a);break;default:u=this._processCommandsFromMap(null,e,t,l,a);}l.commands=u;}return e.info.status&&Object.keys(e.info.status).length>0&&(l.states=e.info.status),l;},Handler.prototype._resovleDeviceID=function(e,o,n){var t,a=e.name,r=n[e.room];"_cameras"==a.substr(0,8)&&(r=null,t=a.indexOf(":"),a=a.substr(t+1)),"_progs&sysvars"==r&&(r=o[e.info.gateway],"gw"==a.substr(0,2)&&(t=a.indexOf("_"),a=a.substr(t+1)));var i=(r?r+" ":"")+(a||"");return e.cloud.alias&&(i=e.cloud.alias),i;},Handler.prototype._resovleBaseUrl=function(e,o){var n=e,t=e.indexOf(":");return-1!=t&&(n=e.substr(0,t)),"https://"+n+"/rapi/"+o;},Handler.prototype.getAccessToken=function(e,o){if(e){if("aio"==e.sys||"neoserver"==e.sys){var n,t=this,a=require("xnm.aio.gateway.js");"neoserver"==e.sys?((e=JSON.parse(JSON.stringify(e))).sys="aio",e.version="EA",n=a.resolveGateway(e,!0)):n=a.resolveGateway(e),n?a.Admin.getGatewaySID(n,function(r,i){return r?(t._logger.log("warn","get gateway sid error:"+r.message),r.code="50001",r.message="get gateway sid error:"+r.message,void(o&&o(r))):i?e.password?void a.Admin.V5.getInfo(n,function(n,a){return n?(t._logger.log("warn","get gateway info error:"+n.message),n.message="get gateway info error:"+n.message,n.code="50101",void(o&&o(n))):a&&a.server?!a.cfg||64&parseInt(a.cfg,16)?(t._logger.log("warn","gateway cloud server is deactivated"),(n=new Error("gateway cloud server is deactivated")).code="50103",void(o&&o(n))):void t._getAccessToken(a.server,i,e.password,!1,function(n,r){if(n)return(n=new Error("get accesss token error:"+n.message)).code="50003",void(o&&o(n));r?o&&o(null,r,a.server,i):t._getAccessToken(a.server,i,e.password,!0,function(e,n){if(e)return(e=new Error("generate accesss token error:"+e.message)).code="50004",void(o&&o(e));n?o&&o(null,n,a.server,i):o&&o(new Error("access token empty"));});}):(t._logger.log("warn","gateway has no cloud server"),(n=new Error("gateway has no cloud server")).code="50102",void(o&&o(n)));}):((r=new Error("gateway has no password")).code="50002",void(o&&o(r))):((r=new Error("gateway has no sid")).code="50002",void(o&&o(r)));}):o&&o(new Error("gateway json invalid"));}else o&&o(new Error("gateway type invalid"));}else o&&o(new Error("gateway json is null"));},Handler.prototype.generateConfig=function(e,o,n,t,a,r,i,s,l,u){for(var c=require("url").parse("https://"+s),d=function(e){for(var o=e.length,n={};o--;){var t=e[o];n[t.index]=t.name;}return n;}(o),f=function(e){for(var o=e.length,n={};o--;){var t=e[o];n[t.index]=t.name;}return n;}(n),p={},g=this._resovleBaseUrl(s,r),v=null,h=null,w=0;w<e.length;w++){var y=e[w];y&&y.info&&("cloudservice"==y.info.sys&&y.info.module||"_webpages"!=y.name.substr(0,9)&&(v=this._resovleDeviceID(y,f,d),(h=this._convertDeviceToCloudFormat(y,v,g,a,p)).data={mod:"mediola",ccs:c.hostname,accessToken:r,deviceID:y.index},p[v]=h));}var _={},C=null;if(t&&t.groups)for(var x=0;x<t.groups.length;x++){var b=t.groups[x];if(b&&b.macros&&0!=b.macros.length)for(var M=b.name,O=0;O<b.macros.length;O++){var S=b.macros[O],F=S.name;if(S.cloud&&S.cloud.enabled){v=(M?M+" ":"")+(F||""),S.cloud.alias&&(v=S.cloud.alias),C="";for(var A=v.toLowerCase(),E=["on","off","an","aus","up","down","auf","ab","hoch","runter","ein"],N=0;N<E.length;N++){var D=E[N],J=A.substr(A.length-D.length);A.length>D.length&&J==D&&(_[C=v.substr(0,A.length-D.length).trim()]||(_[C]=[]),_[C].push({original_id:v,command:D}));}h={name:v,type:"scene",baseurl:g,local:"http://"+i.ip+(i.port?":"+i.port:""),commands:{on:{type:"POST",url:"/cmd",data:{XC_FNC:"DoMacroRM",groupIdx:b.index,macroIdx:S.index}}}},p[v]=h;}}}for(C in _){var k=_[C];h={name:C,type:"scene",baseurl:g,local:"http://"+i.ip+(i.port?":"+i.port:""),commands:{}};for(var T=!1,P=!1,G=0;G<k.length;G++){var H=k[G];if(H&&H.original_id&&H.command){var I=H.original_id,R=p[I];if(delete p[I],!R)continue;var L=R.commands.on,j=H.command;switch(H.command){case"on":case"an":case"ein":T=!0,j="on";break;case"off":case"aus":T=!0,j="off";break;case"up":case"auf":case"hoch":P=!0,j="up";break;case"down":case"ab":case"runter":P=!0,j="down";}h.commands[j]=L;}}T?h.type="switch":P&&(h.type="blind"),p[C]=h;}u&&u(null,p);},Handler.prototype.uploadConfig=function(e,o,n){var t={type:"mediola",configuration:o},a=e.ip;a||(a=require("url").parse(Handler.REMOTE_SERVER).host);var r=e.port;r||(r=443);var i=e.username?e.username:"",s=e.password?e.password:"",l={host:a,port:r,path:"/alexa/setConfiguration",method:"POST",timeout:3e4,auth:i+":"+s,user:i,password:s,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(i+":"+s).toString("base64"),Connection:"close"}},u=this;this._logger.log("trace","upload config to:"+JSON.stringify(l));var c=require("https").request(l,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){u._logger.log("trace","upload config reponse:"+o);try{var t=JSON.parse(o);if(t.XC_ERR){var a=new Error(t.XC_ERR.msg);a.code=t.XC_ERR.code,n&&n(a);}else t.XC_SUC&&n&&n();}catch(e){n&&n(e);}}else u._logger.log("warn","upload config error +"+e.statusCode+":"+o),n&&n(new Error("http response:"+e.statusCode));});});c.on&&c.on("error",function(e){u._logger.log("warn","upload config error:"+e.message),n&&n(e),n=null;}),c.write(JSON.stringify(t)),c.end();},Handler.prototype.setCustomCommandMap=function(e){this._customMap=e;},Handler.prototype.loadCustomComamndMap=function(e,o){var n=require("fs-extra");n.ensureFile(e,function(t){t?o&&o(null,{}):n.readFile(e,"utf8",function(e,n){if(e)o&&o(e);else if(n)try{var t=JSON.parse(n);o&&o(null,t);}catch(e){o&&o(null,{});}else o&&o(null,{});});});},Handler.prototype.saveCustomCommandMap=function(e,o,n){var t=require("fs-extra");t.ensureFile(e,function(a){if(a)n&&n(null,{});else try{var r=JSON.stringify(o,null,2);t.writeFile(e,r,function(e){n&&n(e);});}catch(e){n&&n(e);}});},Handler;}(),m.aio.voicemanager.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("m.aio.voicemanager.Handler"),this._configmanager=null,this._devicemanager=null,this._alexaHandler=new m.aio.voicemanager.AlexaHandler(),this.CLOUD_PROTOCOL="https",this.CLOUD_HOST="webservice.mediola.com",this.CLOUD_PORT=443,this.CLOUD_PATH="/account/bindLicense";};return Handler.prototype.CUSTOM_CMD_MAP_FILE="cloud_service_command.map",Handler.prototype.init=function(e,o,n,t){this._configmanager=e,this._devicemanager=o,this._macromanager=n,t&&t();},Handler.prototype.loadCustomComamndMap=function(e,o){var n=this;this._configmanager.trace("/config/tenants/"+e,function(e,t){if(e)return e.code="50100",void(o&&o(e));var a=require("path"),r=t.getFolderPath();if(!r)return(e=new Error("tenant folder is null")).code="50100",void(o&&o(e));var i=a.join(r,n.CUSTOM_CMD_MAP_FILE);n._alexaHandler.loadCustomComamndMap(i,function(e,n){o&&o(e,n);});});},Handler.prototype.saveCustomComamndMap=function(e,o,n){var t=this;this._configmanager.trace("/config/tenants/"+e,function(e,a){if(e)return e.code="50100",void(n&&n(e));var r=require("path"),i=a.getFolderPath(),s=r.join(i,t.CUSTOM_CMD_MAP_FILE);t._alexaHandler.saveCustomCommandMap(s,o,function(e){n&&n(e);});});},Handler.prototype.getLocalDeviceConfig=function(e,o,n,t){if(o){var a=this;this._alexaHandler.getAccessToken(o,function(r,i,s,l){r?t&&t(r):a._getDeviceWithCommandAndStatus(e,function(r,u){if(r)return r.code="50005",void(t&&t(r));a._devicemanager.execute("read",e,"gateway",null,function(r,c){if(r)return r.code="50007",void(t&&t(r));a._devicemanager.execute("read",e,"room",null,function(r,d){if(r)return r.code="50008",void(t&&t(r));a._macromanager.execute(e,"read",null,null,null,function(r,f){if(r)return r.code="50009",void(t&&t(r));a.loadCustomComamndMap(e,function(e,r){!e&&r||(r=null),a._alexaHandler.setCustomCommandMap(r),a._alexaHandler.generateConfig(u,d,c,f,n,i,o,s,l,function(e,o){if(e)return a._logger.log("warn","generate configuration error:"+e.message),e.code="50010",void(t&&t(e));t&&t(null,o);});});});});});});});}else t&&t(null,null);},Handler.prototype.getCloudDeviceConfig=function(e,o,n){var t=null;if(!o)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));var a=require("xnm.aio.cloudservice.js").resolveGateway(o);if(!a)return(t=new Error("cloud json invalid")).code=4e4,void(n&&n(t));this._getCloudDevicesFromDB(e,a,function(e,o){if(e)n&&n(e);else if(o&&0!=o.length){var t=o.map(function(e){var o=e.info;return delete o.gateway,delete o.commands,delete o.states,o;});a.toCloudDevice(t,function(e,t){if(e)return e.code=40003,void(n&&n(e));if(t&&0!=t.length){for(var a={},r=0;r<o.length;r++){var i=o[r];if(i)for(var s=0;s<t.length;s++){var l=t[s];l&&(l.data&&i.info.module==l.data.mod&&i.info.connection==l.data.connection&&i.info.id==l.data.id?(l.name=i.__cloudref,a[i.__cloudref]=l):i.info.module==l.mod&&i.info.connection==l.connection&&i.info.id==l.id&&(l.name=i.__cloudref,l.data={mod:l.mod,connection:l.connection,id:l.id},delete l.mod,delete l.connection,delete l.id,a[i.__cloudref]=l));}}n&&n(null,a);}else n&&n(null,{});});}else n&&n(null,{});});},Handler.prototype._getCloudDevicesFromDB=function(e,o,n){var _find=function _find(e,o){for(var n=0;n<o.length;n++){var t=o[n];if(t&&t.index==e)return t;}return null;},t=this,a=require("xnm.aio.cloudservice.js"),r={filter:"prop","info.sys":"cloudservice","cloud.enabled":!0};this._devicemanager.execute("read",e,"device",r,function(i,s){if(i)return i.code=40001,void(n&&n(i));s&&0!=s.length?(r={filter:"prop","info.sys":"cloudservice"},t._devicemanager.execute("read",e,"gateway",r,function(r,i){if(r)return r.code=40001,void(n&&n(r));i&&0!=i.length?t._devicemanager.execute("read",e,"room",null,function(e,t){if(e)return e.code=40001,void(n&&n(e));if(t&&0!=t.length){for(var r=[],l=0;l<s.length;l++){var u=s[l];if(u&&u.info&&u.info.gateway){var c=_find(u.info.gateway,i);if(c&&c.info){var d=a.resolveGateway(c.info);if(d){if(!d.equalsTo(o))return(e=new Error("cloud device "+u.index+" belongs to another account")).code=40002,void(n&&n(e));var f=_find(u.room,t);if(f){var p=u.name,g=f.name,v=(g?g+" ":"")+(p||"");u.cloud.alias&&(v=u.cloud.alias),(u=JSON.parse(JSON.stringify(u))).__cloudref=v,r.push(u);}}}}}n&&n(null,r);}else n&&n(null,[]);}):n&&n(null,[]);})):n&&n(null,[]);});},Handler.prototype.previewAlexaConfig=function(e,o,n,t,a){if(n&&n.username){if(t&&t.version&&"C"==t.version.charAt(0)&&"CA"!=t.version.toUpperCase()){var r=new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager);return r.setTargetGateway(t),void r.exportConfig(e,n,function(e,o){a&&a(e,o);});}var i=this;this.getCloudDeviceConfig(e,n,function(n,r){n?a&&a(n):i.getLocalDeviceConfig(e,t,o,function(e,o){if(e)a&&a(e);else{var n={};if(r)for(var t in r){n[t]=r[t];}if(o)for(var t in o){n[t]=o[t];}var s=Object.keys(n);if(!s||0==s.length)return i._logger.log("warn","generate empty configuration"),(e=new Error("empty configuration")).code="50011",void(a&&a(e));a&&a(null,n);}});});}else a&&a(new Error("username is null"));},Handler.prototype.exportAlexaConfig=function(e,o,n,t,a){if(n&&n.username){if(t){var r=this;this.previewAlexaConfig(e,o,n,t,function(o,t){if(o)a&&a(o);else{var i={};if(t)for(var s in t){var l=t[s];delete l.sys,delete l.module,i[s]=l;}r._configmanager.execute("read","/config/tenants/"+e,null,function(e,o){if(e)return e.code="50013",void(a&&a(e));var t=null;o.license&&"normal"==o.license.type&&o.license.valid&&o.license.license&&(t=o.license.license),r._alexaHandler.uploadConfig(n,i,function(e){if(e)return r._logger.log("warn","upload configuration error:"+e.message),"000009"==e.code?e.code="50014":e.code="50012",void(a&&a(e));t?r.bindLicense(n.username,n.password,t,function(e){e&&r._logger.log("warn","bind user license error:"+e.message),a&&a(null,i);}):a&&a(null,i);});});}});}else a&&a(new Error("gateway invalid"));}else a&&a(new Error("username is null"));},Handler.prototype._getDeviceWithCommandAndStatus=function(e,o){var n={filter:"prop","cloud.enabled":!0},t=this,a={};this._devicemanager.execute("read",e,"device",{filter:"ui",f_ui_elem:"*",f_ui_type:"command"},function(r,i){if(r)o(r);else{if(i&&i.length>0)for(var s=0;s<i.length;s++){var l=i[s];if(l&&l.cloud&&l.cloud.enabled&&l.info&&l.info.command&&0!=l.info.command.length){var u=l.index;a[u]=l;}}t._devicemanager.execute("read",e,"device",n,function(n,r){if(n)o(n);else if(r&&0!=r.length){var i=0,cb=function cb(n,s){if(!n&&s&&(a[r[i].index]?a[r[i].index].info.status=s.states:(a[r[i].index]=r[i],r[i].info.status=s.states)),++i<r.length)t._devicemanager.toGeneralDevice(e,r[i].index,!1,cb);else{var l=Object.values(a);o(null,l);}};t._devicemanager.toGeneralDevice(e,r[i].index,!1,cb);}else{var s=Object.values(a);o(null,s);}});}});},Handler.prototype.bindLicense=function(e,o,n,t){var a={host:this.CLOUD_HOST,port:this.CLOUD_PORT,path:this.CLOUD_PATH+"?license="+n,method:"GET",timeout:3e4,auth:e+":"+o,user:e,password:o,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(e+":"+o).toString("base64"),Connection:"close"}},r=this;this._logger.log("trace","bind license "+n+" to:"+e);var i=require(this.CLOUD_PROTOCOL).request(a,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){200==e.statusCode?(r._logger.log("trace","bind license success"),t&&t()):(r._logger.log("warn","bind license success +"+e.statusCode+":"+o),t&&t(new Error("http response:"+e.statusCode))),t=null;});});i.on&&i.on("error",function(e){r._logger.log("warn","upload config error:"+e.message),t&&t(e),t=null;}),i.setTimeout(3e4,function(){t&&t(new Error("timeout")),t=null;}),i.end();},Handler.prototype.uploadDeviceDB=function(e,o,n,t){this._uploadFile(e,o,"device_db",n,t);},Handler.prototype.uploadMacroDB=function(e,o,n,t){this._uploadFile(e,o,"macros_db",n,t);},Handler.prototype._uploadFile=function(e,o,n,t,a){var r="/xhub/xhubsync/upload2?gatewayid="+e+"&fileName="+n+"&auth=";o.password&&(r+=o.password);var i={host:o.ip,port:o.port,path:r,method:"POST",timeout:3e4,headers:{"Content-Type":"text/plain",Connection:"close"}},s=this;this._logger.log("trace","upload "+n+" to:"+JSON.stringify(i));var l=require("http").request(i,function(e){e.setEncoding("utf8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){if(200==e.statusCode){s._logger.log("trace","upload "+n+" reponse:"+o);try{"success"==JSON.parse(o).status?a&&a():a&&a(new Error("failed to upload "+n));}catch(e){a&&a(e);}}else s._logger.log("warn","upload "+n+" error +"+e.statusCode+":"+o),a&&a(new Error("http response:"+e.statusCode));});});l.on&&l.on("error",function(e){s._logger.log("warn","upload "+n+" error:"+e.message),a&&a(e),a=null;}),l.write(JSON.stringify(t)),l.end();},Handler.prototype.exportV5Config=function(e,o,n,t,a){if(n&&n.username){if(t){var r=this;new m.aio.voicemanager.CloudConfigHandler.V5(this._devicemanager,this._macromanager).exportConfig(e,n,function(o,t){if(o)return r._logger.log("error","generate configuration error:"+o.message),o.code="50012",void(a&&a(o));r._configmanager.execute("read","/config/tenants/"+e,null,function(e,o){if(e)return e.code="50013",void(a&&a(e));var i=null;o.license&&"normal"==o.license.type&&o.license.valid&&o.license.license&&(i=o.license.license),r._alexaHandler.uploadConfig(n,t,function(e){if(e)return r._logger.log("warn","upload configuration error:"+e.message),"000009"==e.code?e.code="50014":e.code="50012",void(a&&a(e));i?r.bindLicense(n.username,n.password,i,function(e){e&&r._logger.log("warn","bind user license error:"+e.message),a&&a(null,t);}):a&&a(null,t);});});});}else a&&a(new Error("gateway invalid"));}else a&&a(new Error("username is null"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.voicemanager.Handler());