var x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.gateway=x.hub.m.gateway||{},x.hub.m.gateway.AIOMODULE=require("xnm.aio.gateway.js"),x.hub.m.gateway.Monitor=function(){var Monitor=function Monitor(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Monitor");var e=this;this._eventCallback=function(t,r){e._onGatewayEvent(t,r);},this._eventCallback.onError=function(t){e._restartEventListener();},this._restartTO=null;};return Monitor.prototype.init=function(e){var t=this;x.hub.m.gateway.AIOMODULE.startGatewayEventListener(this._eventCallback,function(r){r?t._restartEventListener():t._restartTO&&(clearTimeout(t._restartTO),t._restartTO=null),e&&e();});},Monitor.prototype._onGatewayEvent=function(e,t){require("x.hub.eventbus.js").emit("gatewayevent",e,t,"EVT");},Monitor.prototype._onEventListenerError=function(e){},Monitor.prototype._restartEventListener=function(){this._restartTO&&clearTimeout(this._restartTO);var e=this;this._restartTO=setTimeout(function(){e.init();},5e3);},Monitor;}(),x.hub.m.gateway.GatewayInternalHandler=function(){var Handler=function Handler(){this._devices={},this._meta={},this._states={};};return Handler.prototype.addStateDevice=function(e,t,r){if(e&&e.type&&e.address){(e=JSON.parse(JSON.stringify(e))).gateway&&e.gateway.ip&&(e._gw_ip_rinfo=e.gateway.ip),delete e.gateway;var a=this._getDeviceID(e);if(this._devices[a]||(this._devices[a]=e),this._meta[a]||(this._meta[a]=[]),this._states[a]||(this._states[a]={}),r){for(var i=!1,n=0;n<this._meta[a].length;n++){var o=this._meta[a][n];if(o&&o.statusKey==r.statusKey&&o.src==r.src&&o.taskID==r.taskID){i=!0;break;}}i||this._meta[a].push(r);}t&&t();}else t&&t(new Error("device json invalid"));},Handler.prototype.removeStateDevice=function(e,t,r){if(e&&e.type&&e.address){if(r){delete(e=JSON.parse(JSON.stringify(e))).gateway;var a=this._getDeviceID(e),i=this._meta[a];if(i){for(var n=-1,o=0;o<i.length;o++){var s=i[o];if(s&&s.src==r.src&&s.taskID==r.taskID&&s.statusKey==r.statusKey){n=o;break;}}n>=0&&i.splice(n,1),0==i.length&&(delete this._devices[a],delete this._meta[a],delete this._states[a]);}t&&t();}}else t&&t(new Error("device json invalid"));},Handler.prototype.onEvent=function(e,t,r){if(e){var a,i,n,o,s=null,u=!1;if(e.sid)for(l in this._devices){if((n=this._devices[l]).sid==e.sid&&!(n._gw_ip_rinfo&&t&&t.address&&n._gw_ip_rinfo!=t.address)){var d=JSON.parse(JSON.stringify(e));if(n.type&&!d.type&&(d.type=n.type),n.address&&!d.address&&(d.address=n.address),n.address&&!d.adr&&(d.adr=n.address),n.data&&!d.data&&(d.data=n.data),(a=this._getSystem(d))&&(e.changed&&e.changed.length&&(d.state={},e.changed.forEach(function(t){d.state[t]=e.state[t];}),i=a._handleState(n,d)),i&&Object.keys(i).length>0)){o=n,this._getDeviceID(o),s=i,u=!0;break;}}}if(!u){if(!e.type)return;if(!(a=this._getSystem(e)))return;for(var l in this._devices){if(this._devices.hasOwnProperty(l))if(n=this._devices[l],"EVT"==r&&a._handleUdpState){if((i=a._handleUdpState(n,e))&&Object.keys(i).length>0){o=n,this._getDeviceID(o),s=i;break;}}else if("STA"==r&&a._handleState){if((i=a._handleState(n,e))&&Object.keys(i).length>0){o=n,this._getDeviceID(o),s=i;break;}}else if("BTN"==r&&l==e.type+"@"+e.adr){o=n,s=e.state;break;}}}s&&this._updateState(o,s,e);}},Handler.prototype._getDeviceID=function(e){if(e&&e.sid){var t="sid@"+e.sid;return e.type&&e.address&&(t+="@"+e.type+"@"+e.address),t;}return e&&"ZWAVE2"==e.type?e.type+"@"+e.address+"."+e.instance:e.type+"@"+e.address;},Handler.prototype._getSystem=function(e){return x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(e);},Handler.prototype._updateState=function(e,t,r){var a=this._getDeviceID(e),i=this._meta[a],n=this._states[a]?this._states[a]:{};if(this._states[a]=t,i&&i.length>0)for(var o in t){if(t.hasOwnProperty(o)){var s=t[o],u=n[o],d={key:o,value:s,changed:u!=s,oldValue:u};if(r&&r.sid&&r.changed&&r.changed.length&&(d.changed=!0,delete d.oldValue),"aio"==e.sys&&"MBUS"==e.type){if(void 0===u||null==u)continue;if(!d.changed)continue;}for(var l=require("x.hub.eventbus.js"),c=(require("x.hub.taskman.js"),0);c<i.length;c++){var y=i[c];!y||y.statusKey!=o&&"*"!=y.statusKey||l.emit("status",{module:"aio",device:e,gateway:null,data:d},y);}}}},Handler;}(),x.hub.m.gateway.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.m.gateway.Handler"),this._intHandler=new x.hub.m.gateway.GatewayInternalHandler(),this._monitor=new x.hub.m.gateway.Monitor(),this._on={},this._localIpBuffer=[],this._localIpUpdateInterval=null,this._db1GatewayNeoIndex=0,this._db2GatewayNeoIndex=0;};return Handler.prototype.on=function(e,t){this._on[e]=t;},Handler.prototype._checkStateChange=function(e,t){},Handler.prototype.updateGatewayStates=function(e,t){t({});},Handler.prototype.updateStates=function(e,t){t({});},Handler.prototype.getStates=function(e){return{};},Handler.prototype.getAllStates=function(){return[];},Handler.prototype.init=function(e){var t=this;require("x.hub.eventbus.js").on("gatewayevent",function(e,r,a){t._onEvent(e,r,a);}),localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx")),this._updateLocalIPBuffer(),this._localIpUpdateInterval=setInterval(function(){t._updateLocalIPBuffer();},18e5),this._monitor.init();},Handler.prototype.getSystems=function(){return["aio"];},Handler.prototype.addStateDevice=function(e,t,r){e&&e.type&&e.address?this._intHandler.addStateDevice(e,function(e){t&&t({error:e});},r):t&&t({error:new Error("device json invalid")});},Handler.prototype.removeStateDevice=function(e,t,r){e&&e.type&&e.address?this._intHandler.removeStateDevice(e,function(e){t&&t({error:e});},r):t&&t({error:new Error("device json invalid")});},Handler.prototype.getState=function(e,t,r){if(e.gateway){if(e.gateway.ip){var a=(e=JSON.parse(JSON.stringify(e))).gateway;(a=this._processPassword(a)).__isself?this._getStateLocal(a,e,t,r):x.hub.m.gateway.AIOMODULE.doStatus("hub",a,e,{value:t},function(e,t){var a=null;t&&(a={value:t.status,time:new Date().getTime()}),r&&r({error:e,data:a});});}else r&&r({error:new Error("gateway json invalid")});}else this._getStateIQ(e,t,r);},Handler.prototype.executeCommand=function(e,t,r){if(e){if(e.gateway){var a=(e=JSON.parse(JSON.stringify(e))).gateway;a.ip?((a=this._processPassword(a))&&!e.type&&(e=a),a.__isself?this._executeCommandLocal(a,e,t,r):x.hub.m.gateway.AIOMODULE.doCommand(a,e,t,function(e){r&&r({error:e});})):r&&r({errror:new Error("gateway json invalid")});}else this._executeCommandIQ(e,t,r);}else r&&r({error:new Error("device is null")});},Handler.prototype.checkDeviceMatch=function(e,t){if(!(t&&t.device&&e&&e.device))return!1;var r=e.device.address;r&&"string"==typeof r&&(r=r.toUpperCase());var a=t.device.address;a&&"string"==typeof a&&(a=a.toUpperCase());var i=e.device.type;return r==a&&i==t.device.type;},Handler.prototype.updateGatewayNeoIndex=function(){localStorage&&(this._db1GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB1NeoIdx"),this._db2GatewayNeoIndex=localStorage.getItem("x.hub.m.gateway.DB2NeoIdx"));},Handler.prototype._onEvent=function(e,t,r){if(!(e.module||e.sys||(this._logger.log("trace","from "+(t?t.address:null)+" receive "+r+" event:"+JSON.stringify(e)),this._localIpBuffer&&t&&t.address&&"STA"==r&&-1!=this._localIpBuffer.indexOf(t.address)||t&&"Sysvar"!=t.address&&e.type&&-1!=["ONOFF","FLOAT","STRING","INT"].indexOf(e.type)))){var a=require("x.hub.eventbus.js");e.type&&"IR"==e.type&&e.data?a.emit("irevt",{code:e.data}):this._intHandler.onEvent(e,t,r);}},Handler.prototype._executeCommandIQ=function(e,t,r){if(e.type){var a;if("HM"==e.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)return"ip_siren"==e.data&&(t.value=x.hub.m.gateway.AIOMODULE.Systems.HM_X._buildData(null,e,t)),(a=require("x.hub.moduleman.js").modulemanager.getModule("hm"))?void a.executeCommand(e,t,r):void(r&&r({error:new Error("no module for type HM")}));if("ENOCEAN"==e.type.toUpperCase()&&"EA"==global.HARDWARE_VERSION)return(a=require("x.hub.moduleman.js").modulemanager.getModule("enocean"))?void a.executeCommand(e,t,r):void(r&&r({error:new Error("no module for type ENOCEAN")}));var i=x.hub.m.gateway.AIOMODULE.getGatewayFunctionForType(e.type);if(i){var n;if("CODE"==e.type){var o=x.hub.m.gateway.AIOMODULE.Systems.Code._rebuildDevice(JSON.parse(JSON.stringify(e))),s=x.hub.m.gateway.AIOMODULE.Systems.Code._findIRCode(t,e);n=x.hub.m.gateway.AIOMODULE.Systems.Code._buildParam(s,o);}else n="BG"==e.type?x.hub.m.gateway.AIOMODULE.Systems.BG._buildParam(null,e,t):x.hub.m.gateway.AIOMODULE.getGatewayParams(e,t.value);var u="http://localhost/command?XC_FNC="+i;if(n)for(var d in n){u+="&"+d+"="+encodeURIComponent(n[d]);}try{var l=require("x.hub.js").server;if(!l)return void(r&&r({error:new Error("server not initialized")}));l._doSTMCommandRequest(u,!1,function(e){r&&r({error:e});});}catch(e){r&&r({error:e});}}else r&&r({error:new Error("unknow device type")});}else r&&r({error:new Error("device type is null")});},Handler.prototype._executeCommandLocal=function(e,t,r,a){var i=x.hub.m.gateway.AIOMODULE.devicemanager.getSystem(t,e);if(i&&i.buildQuery){var n=x.hub.m.gateway.AIOMODULE.resolveGateway(e),o=i.buildQuery(n||e,t,r);if(o){try{var s=require("x.hub.js").server;if(!s)return void(a&&a({error:new Error("server not initialized")}));var u,d,l,c,y=require("querystring");if(o.fnc&&0==o.fnc.indexOf("/api"))u=c=o.fnc,o.fnc&&delete o.fnc,o.data?o=o.data:(d=y.stringify(o),o=y.parse(d),u=c+"?"+d),l={url:u,query:o},e&&e.at&&(l.query.at=e.at),l.method="GET";else"SendGenericCmd"==o.XC_FNC?(c="/cmd",l={method:"POST",url:u,query:o,json:o}):(c="/cmd",d=y.stringify(o),o=y.parse(d),l={url:u=c+"?"+d,query:o});this._logger.log("trace","execute command local directly "+u);var f=this;s.doRequest(c,l,function(e){f._logger.log("trace","execute command local directly return:"+JSON.stringify(e));var t=null;if(e)try{(t=JSON.parse(e))&&t.XC_SUC?a&&a({data:t}):t&&t.XC_ERR?a&&a({error:new Error(e)}):a&&a({error:new Error("/cmd request return invalid format")});}catch(e){a&&a({error:e});}else a&&a({error:new Error("/cmd request return null")});});}catch(e){a&&a({error:e});}return;}}this._logger.log("trace","execute command via localhost:"+JSON.stringify(t)+" command:"+JSON.stringify(r)),x.hub.m.gateway.AIOMODULE.doCommand(e,t,r,function(e){a&&a({error:e});});},Handler.prototype._getStateIQ=function(e,t,r){var a={ip:"127.0.0.1",port:require("x.hub.js").server._port,version:"EA"};a=this._processPassword(a),this._getStateLocal(a,e,t,r);},Handler.prototype._getStateLocal=function(e,t,r,a){var _handleLocalStateRsp=function _handleLocalStateRsp(e,t,r){if(e.error)return{error:e.error};var a=r._handleGeneralStatesRsp(e.data,t),i=null;return a&&a[0]&&(i={value:a[0].status,time:new Date().getTime()}),{error:null,data:i};},i=x.hub.m.gateway.AIOMODULE.resolveGateway(e);if(i){var n=[{id:"hub",device:t,status:{value:r}}],o=this;if(t&&"dev"==t.common_type)return t.id?void require("x.hub.commandman.js").commandHandlerV6.getDeviceStatesWithId(t.id,function(e,t){if(e)a&&a({error:e});else{var i={value:t?t[r]:null,time:new Date().getTime()};a&&a({error:null,data:i});}}):void(a&&a({error:new Error("device json invalid")}));if(t&&t.type){if("HM"==t.type&&"CA"!=global.HARDWARE_VERSION)require("x.hub.m.hm.js").getAllStatesLegacy(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});else if("ENOCEAN"==t.type&&"CA"!=global.HARDWARE_VERSION){require("x.hub.m.enocean.js").getAllStatesLegacy(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});}else if("ZWAVE2"==t.type){require("x.hub.m.zway.js").getAllStatesLegacy(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});}else if("KNX"==t.type){require("x.hub.m.knx.js").getAllStatesLegacy(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});}else if("ZIGBEE"==t.type){require("x.hub.m.zigbee.js").getAllStatesLegacy(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});}else if("ONOFF"==t.type||"FLOAT"==t.type||"INT"==t.type||"STRING"==t.type){require("x.hub.sysvarman.js").getSysvarStates(function(e){var t=_handleLocalStateRsp(e,n,i);a&&a(t);});}else if("TASK"==t.type){require("x.hub.taskman.js").readAllTasks(function(e){var t;if(e.error)t=_handleLocalStateRsp(e,n,i),a&&a(t);else{var r=[];e.data.forEach(function(e){e&&r.push({type:"TASK",id:e.id,active:e.active});}),t=_handleLocalStateRsp({data:r},n,i),a&&a(t);}});}else{var s=require("x.hub.js").server;if(!s)return void(a&&a({error:new Error("server not initialized")}));this._logger.log("trace","get states from ST directly"),s.doSTMCommand("XC_FNC=getStates",function(e){if(o._logger.log("trace","get states from ST return:"+JSON.stringify(e)),e){if(e.XC_SUC){var t={data:null};Array.isArray(e.XC_SUC)?t.data=e.XC_SUC:Object.keys(e.XC_SUC).length>0&&(t.data=[e.XC_SUC]);var r=_handleLocalStateRsp(t,n,i);a&&a(r);}else a&&a({error:new Error("ST get states return error:"+JSON.stringify(e))});}else a&&a({error:new Error("ST get states return null")});});}}else x.hub.m.gateway.AIOMODULE.doStatus("hub",e,t,{value:r},function(e,t){var r=null;t&&(r={value:t.status,time:new Date().getTime()}),a&&a({error:e,data:r});});}else a&&a({error:new Error("gateway json format invalid")});},Handler.prototype._processPassword=function(e){var t=this._localIpBuffer,r="";return localStorage&&(r=localStorage.getItem("x.hub.Server.pwd")),("localhost"==e.ip||"127.0.0.1"==e.ip||-1!=t.indexOf(e.ip)||e.__neoInfo&&(1==e.__neoInfo.db&&e.__neoInfo.index==this._db1GatewayNeoIndex||2==e.__neoInfo.db&&e.__neoInfo.index==this._db2GatewayNeoIndex))&&(e.ip="127.0.0.1",e.port=require("x.hub.js").getServer()._port,e.__isself=!0,r&&(e.at=r)),e;},Handler.prototype._updateLocalIPBuffer=function(){new Date().getTime();var e=[],t=require("os").networkInterfaces();for(var r in t){for(var a=t[r],i=0;i<a.length;i++){e.push(a[i].address);}}this._localIpBuffer=e;},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.gateway.Handler());