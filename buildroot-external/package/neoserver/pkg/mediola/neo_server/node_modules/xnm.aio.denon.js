var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.denon=xnm.aio.denon||{},xnm.aio.marantz=xnm.aio.marantz||{},xnm.aio.denon.AVR=function(){var AVR=function AVR(e,t){this.ip=e,this.port=t,this.port||(this.port="23"),this.timeout=2e3,this._socket=null,this.CommandHandler=null;};return AVR.prototype._doRequest=function(e,t,n){var o=require("net");if(!this._socket){var s=null,i=[];this._socket=o.connect({port:this.port,host:this.ip}),this._socket.setTimeout(this.timeout);var r=this,a=null;this._socket.on("connect",function(){var t=new Buffer(e.shift()+"\r");r._socket.write(t),n&&r._socket.setTimeout(250);}),this._socket.on("data",function(t){s?s+=t.toString():s=t.toString();for(var n=s.indexOf("\r");n>0;){i.push(s.substr(0,n)),n=(s=s.substr(n+1)).indexOf("\r");}if(e.length>0){var o=new Buffer(e.shift()+"\r");r._socket.write(o);}else r._socket.setTimeout(100);}),this._socket.on("error",function(e){t&&(t({error:"socket error",data:null}),t=null),r._socket&&r._socket.destroy(),r._socket=null;}),this._socket.on("timeout",function(){r._socket.destroy(),r._socket=null,t&&(a=i.length>0?{error:null,data:i}:{error:"socket timeout",data:null});}),this._socket.on("close",function(){r._socket=null,t&&a&&setTimeout(function(){t(a);},250);});}},AVR.prototype._executeCommand=function(e,t){this._doRequest([e],function(){t&&t();},!0);},AVR.prototype.executeCommand=function(e,t){var n=e,o=this;"on"==e?n="PWON":"off"==e||"standby"==e?n="PWSTANDBY":"toggle"==e&&(n=null,this.getStates(function(e){e&&"on"==e.power?o._executeCommand("PWSTANDBY",t):o._executeCommand("PWON",t);})),n&&this._executeCommand(n,t);},AVR.prototype.getStates=function(e){var t={mainzone:{},zone2:{}};this._doRequest(["PW?","MU?","SI?","MV?","ZM?","Z2MU?","Z2?"],function(n){if(n.data){for(var o=0;o<n.data.length;o++){var s=n.data[o].trim();"PW"==s.substr(0,2)?t.power=s.substr(2).toLowerCase():"MV"==s.substr(0,2)?3==(s=s.substr(2)).length?t.mainzone.volume=(parseFloat(s)/10).toFixed(1):2==s.length&&(t.mainzone.volume=parseFloat(s).toFixed(1)):"MU"==s.substr(0,2)?t.mainzone.mute=s.substr(2).toLowerCase():"SI"==s.substr(0,2)?t.mainzone.input=s.substr(2).toLowerCase():"ZM"==s.substr(0,2)?t.mainzone.power=s.substr(2).toLowerCase():"Z2MU"==s.substr(0,4)?t.zone2.mute=s.substr(4).toLowerCase():"Z2"==s.substr(0,2)&&("Z2ON"==s?t.zone2.power="on":"Z2OFF"==s?t.zone2.power="off":(s=s.substr(2),/^\d+$/.test(s)?3==s.length?t.zone2.volume=(parseFloat(s)/10).toFixed(1):2==s.length&&(t.zone2.volume=parseFloat(s).toFixed(1)):t.zone2.input=s.toLowerCase()));}e&&e(t);}else e&&e();});},AVR.prototype.getStateValues=function(e,t){return t;},AVR;}(),xnm.aio.denon.Cache={_cache:{},_getCache:function _getCache(e){return e?this._cache[e]:null;},_ensureCache:function _ensureCache(e){return e?(this._cache[e]||(this._cache[e]={}),this._cache[e]):null;},getConfig:function getConfig(e){if(!e)return null;var t=this._getCache(e);return t?t.config:null;},setConfig:function setConfig(e,t){if(!e)return null;this._ensureCache(e).config=t;}},xnm.aio.denon.WebAVR=function(){var WebAVR=function WebAVR(e,t,n,o,s){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.denon.WebAVR"),this.ip=e,this.port=t,this.port||(this.port=80),this.uuid=n,this.name=o,this.model=s,this.timeout=3e3,this.CommandHandler=null;};return WebAVR.prototype.audioModes=["DIRECT","STEREO","DOLBY DIGITAL","DTS SURROUND","AUTO","MCH STEREO","SUPER STADIUM","ROCK ARENA","JAZZ CLUB","CLASSIC CONCERT","MONO MOVIE","MATRIX","VIDEO GAME","VIRTUAL"],WebAVR.prototype.audioModesDesc=["Direct","Stereo","Dolby Surrounds","DTS Surrounds","Auto","Multi Ch Stereo","Super Stadium","Rock Arena","Jazz Club","Classic Concert","Mono Movie","Matrix","Video Game","Virtual"],WebAVR.prototype.videoInputs=["CBL/SAT","DVD/Blu-ray","Blu-ray","Game","AUX","AUX2","Media Player","iPod/USB","TV Audio","Tuner","Online Music","Bluetooth","Internetradio","Media Server","CD","PHONO","HDRADIO"],WebAVR.prototype._getConfig=function(){return xnm.aio.denon.Cache.getConfig(this.ip);},WebAVR.prototype._setConfig=function(e){xnm.aio.denon.Cache.setConfig(this.ip,e);},WebAVR.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if("openNative"==t.value)return window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?e&&"marantz"==e.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&(e&&"marantz"==e.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),void(n&&n());var o="";t.path&&t.path[0]&&"global"!=t.path[0]&&(o=t.path[0]+":");var s=o+t.value;if("setInput"==t.value){if(!t.ext)return void(n&&n(new Error("command setInput ext format invalid")));s=o+t.ext;}else if("audioMode"==t.value){if(!t.ext)return void(n&&n(new Error("command audioMode ext format invalid")));s=o+t.ext;}else if("setTo"==t.value||"setToDB"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command setTo ext format invalid")));s+=t.ext;}else if("customCMD"==t.value){if(!t.ext)return void(n&&n(new Error("command customCMD ext format invalid")));s="customCMD:"+t.ext;}if("tuner"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command tunerPreset ext format invalid")));s+=t.ext;}this.executeCommand(s,function(e){if(e)n&&n(e);else{if(t.path&&t.path[0]&&"mainzone"==t.path[0]){if("on"==t.value||"off"==t.value||"toggle"==t.value)return void setTimeout(function(){n&&n();},1e3);if("setTo"==t.value||"setToDB"==t.value||"volumeUp"==t.value||"volumeDown"==t.value)return void setTimeout(function(){n&&n();},10);}"setInput"!=t.value&&"audioMode"!=t.value?n&&n():setTimeout(function(){n&&n();},1e3);}});}else n&&n(new Error("command json format invalid"));},WebAVR.prototype.getStatesCreator=function(e,t,n){this.getStates(function(e,o){for(var s=[],i=0;i<t.length;i++){if(t[i]&&t[i].id){var r="?";if(o&&t[i].status&&t[i].status.value){var a="";t[i].status.path&&t[i].status.path[0]&&"global"!=t[i].status.path[0]&&(a=t[i].status.path[0]);var u=t[i].status.value;a&&null!=o[a]&&void 0!==o[a]?o[a][u]&&(r=o[a][u]):null!=o[u]&&void 0!==o[u]&&(r=o[u]);}s.push({id:t[i].id,status:r});}}n&&n(null,s);});},WebAVR.prototype._doRequest=function(e,t,n,o){var s=this,i="http://"+this.ip+":"+this.port+t;this._logger.log("trace","send "+e+" to url:"+i+" data:"+n);var r=o;$.ajax({url:i,type:e,timeout:this.timeout,data:n,dataType:"text",cache:!0,success:function success(e){s._logger.log("trace","http request success:"+e),setTimeout(function(){r&&(r(null,e),r=null);},200);},error:function error(e,t){var n="http request error:"+(e?e.status:"0")+"-"+t;s._logger.log("trace",n),r&&(r(new Error(n)),r=null);}});},WebAVR.prototype._getInputList=function(e){this._doRequest("GET","/goform/formMainZone_MainZoneXmlStatus.xml",null,function(t,n){if(t)e&&e(t);else try{var o=$($.parseXML(n));if(!o)return void(e&&e(new Error("MainZoneXmlStatus.xml response invalid")));var s={inputs:[],renamed:[]};o.find("InputFuncList").each(function(){$(this).find("value").each(function(){var e=$(this).text();e&&s.inputs.push(e.trim());});}),o.find("RenameSource").each(function(){$(this).find("value value").each(function(){var e=$(this).text();e&&s.renamed.push(e.trim());});}),e&&e(null,s);}catch(t){e&&e(t);}});},WebAVR.prototype._getStateValue=function(e,t,n,o){var s=null;return e.find(t).each(function(){var e=$(this).find("value");e.length>0&&(s=$(e[0]).text());}),s&&o&&(s=s.trim()),s&&n&&(s=s.toLowerCase()),s;},WebAVR.prototype._getOriginalInputName=function(e){var t=e,n=this._getConfig();if(n&&n.renamed&&n.inputs){var o=n.renamed.indexOf(e);-1!=o&&n.inputs[o]&&(t=n.inputs[o]);}return t;},WebAVR.prototype._parseStates=function(e){var t={};try{var n=$($.parseXML(e));if(n){switch(t.mainpower=this._getStateValue(n,"Power",!0,!0),"standby"==t.mainpower&&(t.mainpower="off"),t.power=this._getStateValue(n,"ZonePower",!0,!0),t.mute=this._getStateValue(n,"Mute",!0,!0),t.input=this._getStateValue(n,"InputFuncSelect",!1,!0),t.audioMode=this._getStateValue(n,"selectSurround",!1,!0),t.input&&(t.originalInput=this._getOriginalInputName(t.input)),"NETWORK"==t.originalInput&&(t.netfunc=this._getStateValue(n,"NetFuncSelect",!1,!0)),t.originalInput){case"CBL/SAT":t.originalInput="CBL/SAT";break;case"DVD":t.originalInput="DVD/Blu-ray";break;case"Blu-ray":t.originalInput="Blu-ray";break;case"GAME":t.originalInput="Game";break;case"Media Player":t.originalInput="Media Player";break;case"iPod/USB":t.originalInput="iPod/USB";break;case"TUNER":t.originalInput="Tuner";break;case"TV AUDIO":t.originalInput="TV Audio";break;case"NETWORK":switch(t.netfunc){case"IRADIO":t.originalInput="Internetradio";break;case"SERVER":t.originalInput="Media Server";break;default:t.originalInput="Online Music";}}var o=this._getStateValue(n,"MasterVolume",!1,!0);t.volumeDB="--"==o?"-80.0":parseFloat(o).toFixed(1),o="--"==o?0:parseFloat(o)+80,t.volume=""+o.toFixed(1);}}catch(e){}return t;},WebAVR.prototype.getStates=function(e){var t={mainzone:{},zone2:{},zone3:{}},n=this;this._getConfig()?this._doRequest("GET","/goform/formMainZone_MainZoneXml.xml",null,function(o,s){!o&&s?(t.mainzone=n._parseStates(s),t.power=t.mainzone.mainpower,delete t.mainzone.mainpower,n._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE2",null,function(o,s){!o&&s&&(t.zone2=n._parseStates(s),delete t.zone2.mainpower),n._doRequest("GET","/goform/formMainZone_MainZoneXml.xml?ZoneName=ZONE3",null,function(o,i){!o&&s&&(t.zone3=n._parseStates(i),delete t.zone3.mainpower),e&&e(o,t);});})):e&&e(o,t);}):this._getInputList(function(t,o){t?e&&e(t):(n._setConfig(o),n.getStates(e));});},WebAVR.prototype.executeCommand=function(e,t){var n=null,o=!0,s=null,i=e.indexOf(":");i>0&&(s=e.substr(0,i),e=e.substr(i+1));var r="POST",a="/MainZone/index.put.asp",u=this;if("on"==e)n="mainzone"==s?"cmd0=PutZone_OnOff%2FON":"zone2"==s?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FON";else if("off"==e||"standby"==e)n="mainzone"==s?"cmd0=PutZone_OnOff%2FOFF":"zone2"==s?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2":"zone2"==s?"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3":"cmd0=PutSystem_OnStandby%2FSTANDBY";else if("toggle"==e)o=!1,this.getStates(function(e,n){s?"mainzone"==s?n&&n.mainzone&&"on"==n.mainzone.power?u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FOFF",t):u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FON",t):"zone2"==s?n&&n.zone2&&"on"==n.zone2.power?u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE2",t):u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE2",t):"zone3"==s&&(n&&n.zone3&&"on"==n.zone3.power?u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FOFF&ZoneName=ZONE3",t):u._doRequest("POST",a,"cmd0=PutZone_OnOff%2FON&ZoneName=ZONE3",t)):n&&"on"==n.power?u._doRequest("POST",a,"cmd0=PutSystem_OnStandby%2FSTANDBY",t):u._doRequest("POST",a,"cmd0=PutSystem_OnStandby%2FON",t);});else if("mute"==e)"zone2"==s?n="cmd0=PutVolumeMute/on&ZoneName=ZONE2":"zone3"==s?n="cmd0=PutVolumeMute/on&ZoneName=ZONE3":"mainzone"==s?n="cmd0=PutVolumeMute/on":(a="/goform/AppCommand.xml",n='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>ON</value>\r\n</tx>');else if("unmute"==e)"zone2"==s?n="cmd0=PutVolumeMute/off&ZoneName=ZONE2":"zone3"==s?n="cmd0=PutVolumeMute/off&ZoneName=ZONE3":"mainzone"==s?n="cmd0=PutVolumeMute/off":(a="/goform/AppCommand.xml",n='<?xml version="1.0" encoding="utf-8"?>\r\n<tx>\r\n<cmd id="1">SetAllZoneMute</cmd>\r\n<value>OFF</value>\r\n</tx>');else if("toggleMute"==e)n="zone2"==s?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE2":"zone3"==s?"cmd0=PutVolumeMute/toggle&ZoneName=ZONE3":"cmd0=PutVolumeMute/toggle";else if("volumeDown"==e)n="zone2"==s?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE2":"zone3"==s?"cmd0=PutMasterVolumeBtn/<&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/<";else if("volumeUp"==e)n="zone2"==s?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE2":"zone3"==s?"cmd0=PutMasterVolumeBtn/>&ZoneName=ZONE3":"cmd0=PutMasterVolumeBtn/>";else if("CBL/SAT"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/SAT/CBL&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SAT/CBL";else if("DVD/Blu-ray"==e||"DVD"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/DVD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/DVD";else if("Blu-ray"==e||"BD"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/BD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BD";else if("Game"==e||"GAME"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/GAME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/GAME";else if("AUX"==e||"AUX1"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/AUX1&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX1";else if("AUX2"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/AUX2&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/AUX2";else if("Media Player"==e||"MPLAY"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/MPLAY&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/MPLAY";else if("iPod/USB"==e||"IPOD"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/USB/IPOD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/USB/IPOD";else if("TV Audio"==e||"TV"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/TV&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TV";else if("Tuner"==e||"TUNER"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/TUNER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/TUNER";else if("Online Music"==e||"NETHOME"==e||"NET"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/NETHOME&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/NETHOME";else if("Bluetooth"==e||"BT"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/BT&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/BT";else if("Internetradio"==e||"IRP"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/IRP&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/IRP";else if("Media Server"==e||"SERVER"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/SERVER&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/SERVER";else if("CD"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE2":"zone2"==s?"cmd0=PutZone_InputFunction/CD&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/CD";else if("PHONO"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/PHONO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/PHONO";else if("HDRADIO"==e)n="zone2"==s?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE2":"zone3"==s?"cmd0=PutZone_InputFunction/HDRADIO&ZoneName=ZONE3":"cmd0=PutZone_InputFunction/HDRADIO";else if("Source"==e)r="GET","zone2"==s?a="/goform/formiPhoneAppDirect.xml?Z2SOURCE":"zone2"==s&&(a="/goform/formiPhoneAppDirect.xml?Z3SOURCE");else if("Quick1"==e)n="cmd0=PutUserMode/Quick1";else if("Quick2"==e)n="cmd0=PutUserMode/Quick2";else if("Quick3"==e)n="cmd0=PutUserMode/Quick3";else if("Quick4"==e)n="cmd0=PutUserMode/Quick4";else if("playPause"==e)n="cmd0=PutNetAudioCommand/CurEnter";else if("previous"==e)n="cmd0=PutNetAudioCommand/CurUp";else if("next"==e)n="cmd0=PutNetAudioCommand/CurDown";else if(0==e.indexOf("tuner"))e=e.replace(/tuner/g,""),r="GET",a="/goform/formiPhoneAppTuner.xml",e="Up"==e?"PRESETUP":"Down"==e?"PRESETDOWN":(e.length,"PRESETCALL0"+e),a+="?"+(n="zone2"==s?"2+"+e:"zone3"==s?"3+"+e:"1+"+e),n=null;else if(-1!=this.audioModes.indexOf(e))r="GET",a="/goform/formiPhoneAppDirect.xml?MS"+encodeURI(e),n=null;else if(-1!=this.audioModesDesc.indexOf(e))e=this.audioModes[this.audioModesDesc.indexOf(e)],r="GET",a="/goform/formiPhoneAppDirect.xml?MS"+encodeURI(e),n=null;else if("customCMD"==s)r="GET",a=e;else if(0==e.indexOf("setToDB")){if(0==e.indexOf("setToDB")&&(e=e.replace(/setToDB/g,"")),"mainzone"==s)(l=parseFloat(e))<-80?l=-80:l>18&&(l=18),n="cmd0=PutMasterVolumeSet/"+(l=l.toFixed(1));else if("zone2"==s){(l=parseInt(e))<-80?l=-80:l>18&&(l=18),n="cmd0=PutMasterVolumeSet/"+(l=l.toFixed(1))+"&ZoneName=ZONE2";}else if("zone3"==s){(l=parseInt(e))<-80?l=-80:l>18&&(l=18),n="cmd0=PutMasterVolumeSet/"+(l=l.toFixed(1))+"&ZoneName=ZONE3";}}else if(s){if(0==e.indexOf("setTo")&&(e=e.replace(/setTo/g,"")),"mainzone"==s)(l=parseFloat(e))<0?l=0:l>98&&(l=98),n="cmd0=PutMasterVolumeSet/"+(l=(l-80).toFixed(1));else if("zone2"==s){(l=parseInt(e))<0?l=0:l>80&&(l=80),n="cmd0=PutMasterVolumeSet/"+(l-=80)+"&ZoneName=ZONE2";}else if("zone3"==s){var l;(l=parseInt(e))<0?l=0:l>80&&(l=80),n="cmd0=PutMasterVolumeSet/"+(l-=80)+"&ZoneName=ZONE3";}}o&&this._doRequest(r,a,n,t);},WebAVR.prototype.getStateValues=function(e,t){return t;},WebAVR.prototype.toJSON=function(){var e={sys:xnm.aio.denon.DM.SYS,type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};return this.name&&(e.name=this.name),e;},WebAVR.prototype.equalsTo=function(e){return!!e&&e instanceof WebAVR&&this.ip==e.ip&&this.port==e.port;},WebAVR.parseJSON=function(e){return e.ip?new WebAVR(e.ip,e.port,e.uuid,e.name,e.model):null;},WebAVR;}(),xnm.aio.denon.AVR2=function(){var e,t=function(){var _StateBuffer=function _StateBuffer(){this._stateExpiredTime=300,this._errorStateExpiredTime=10,this._buffer={};};return _StateBuffer.prototype.reset=function(){this._buffer={};},_StateBuffer.prototype.getState=function(e){var t=Math.round(new Date().getTime()/1e3);if(this._buffer[e]){var n=this._buffer[e];return!n.update||null==n.value&&t-n.update>this._errorStateExpiredTime||t-n.update>this._stateExpiredTime?(n.update=t,void(n.value=null)):n.value;}this._buffer[e]={update:t,value:null};},_StateBuffer.prototype.putState=function(e,t){var n={};n.update=Math.round(new Date().getTime()/1e3),n.value=t,this._buffer[e]=n;},_StateBuffer;}(),n=function(){var _Controller=function _Controller(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller");var e=this;this._session=new o(),this._session.on("open",function(){e._state="OPEN",e._logger.log("trace","session opened"),e._emitEvent("open"),e._restartCloseTimeout();}),this._session.on("close",function(){e._state="IDLE",e._reset(),e._logger.log("trace","session closed"),e._emitEvent("close");}),this._session.on("error",function(t){e._state="CONNECT",e._logger.log("trace","session error:"+t.message),e._reset();}),this._session.on("event",function(t){e._logger.log("trace","receive session event:"+t),e._processAVREvent(t);}),this._state="IDLE",this._stateBuffer=new t(),this._listeners={},this._closeTO=null,this._closeTimeout=3e5;};return _Controller.prototype.isIdle=function(){return"IDLE"==this._state;},_Controller.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},_Controller.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var n=this._listeners[e].indexOf(t);-1!=n&&this._listeners[e].splice(n,1);}},_Controller.prototype.open=function(e){"IDLE"==this._state&&(this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Controller.("+e.ip+":"+e.port+")"),this._logger.log("trace","open session"),this._state="CONNECT",this._session.open(e));},_Controller.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("trace","close session"),this._state="CLOSED",this._session.close());},_Controller.prototype.sendCommand=function(e,t,n){this._logger.log("trace","send command:"+e+" param:"+t),this._restartCloseTimeout();var o=this;this._session.sendCommand(e,t,function(e,t){e?o._logger.log("trace","send command failed:"+e.message):o._logger.log("trace","send command success:"+t),n&&n(e,t);});},_Controller.prototype.getState=function(e,t){this._logger.log("trace","get state:"+e),this._restartCloseTimeout();var n=this._stateBuffer.getState(e);if(void 0!==n)return this._logger.log("trace","get buffered state:"+n),void(t&&t(null,n));var o=this,s=e,i="?";"CV"==s.substr(0,2)?s="CV":"MSQUICK"==s||"VS"==s.substr(0,2)?i=" ?":"PS"==s.substr(0,2)?("PSFRONT"!=s&&(i=" ?"),"PSSWL2"==s&&(s="PSSWL")):"PV"==s.substr(0,2)?"PV"!=s&&(i=" ?"):"TR"==s.substr(0,2)?s="TR":"DIM"==s.substr(0,3)?i=" ?":"Z2"==s.substr(0,2)?"Z2QUICK"==s||"Z2PSBAS"==s||"Z2PSTRE"==s?i=" ?":"Z2:POWER"!=s&&"Z2:VOLUME"!=s&&"Z2:INPUT"!=s||(s="Z2"):"Z3"==s.substr(0,2)&&("Z3QUICK"==s||"Z3PSBAS"==s||"Z3PSTRE"==s?i=" ?":"Z3:POWER"!=s&&"Z3:VOLUME"!=s&&"Z3:INPUT"!=s||(s="Z3")),this._logger.log("trace","do send state request:"+s),this._session.sendCommand(s,i,function(i){if(i)return o._logger.log("trace","get state failed:"+i.message),void(t&&t(i));"CV"==s||"MS"==s||"PSSWL"==s||"TR"==s||"Z2"==s||"Z3"==s?setTimeout(function(){o._logger.log("trace","get state "+s+" success"),n=o._stateBuffer.getState(e),t&&t(null,n);},250):(o._logger.log("trace","get state "+s+" success"),n=o._stateBuffer.getState(e),t&&t(null,n));});},_Controller.prototype._reset=function(){this._stateBuffer.reset();},_Controller.prototype._emitEvent=function(e,t){if(e){var n=this._listeners[e];if(n&&n.length>0)for(var o=0;o<n.length;o++){var s=n[o];try{s(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},_Controller.prototype._processAVREvent=function(e){if(e&&!(e.length<2)){var t,n,o=e.split(" ");if("CVEND"!=e&&"DC"!=e.substr(0,2)&&"SY"!=e.substr(0,2)&&"NS"!=e.substr(0,2)&&"UG"!=e.substr(0,2)){if("CV"==e.substr(0,2))t=o[0],n=o[1].trim();else if("SV"==e.substr(0,2))t=e.substr(0,2),n=e.substr(2).trim();else if("STBY"==e.substr(0,4))t="STBY",n=e.substr(4).trim();else if("ECO"==e.substr(0,3))t="ECO",n=e.substr(3).trim();else if("SLP"==e.substr(0,3))t="SLP",n=e.substr(3).trim();else if("MS"==e.substr(0,2))"MSQUICK"==e.substr(0,7)?(t="MSQUICK",n=e.substr(7).trim()):(t=e.substr(0,2),n=e.substr(2).trim());else if("VS"==e.substr(0,2))"VSASP"==e.substr(0,5)?(t="VSASP",n=e.substr(5).trim()):"VSMONI"==e.substr(0,6)?(t="VSMONI",n=e.substr(6).trim()):"VSSCH"==e.substr(0,5)?(t="VSSCH",n=e.substr(5).trim()):"VSSC"==e.substr(0,4)?(t="VSSC",n=e.substr(4).trim()):"VSVST"==e.substr(0,5)?(t="VSVST",n=e.substr(5).trim()):"VSAUDIO"==e.substr(0,7)?(t="VSAUDIO",n=e.substr(7).trim()):"VSVPM"==e.substr(0,5)&&(t="VSVPM",n=e.substr(5).trim());else if("PS"==e.substr(0,2))"PSSP:"==e.substr(0,5)?(t="PSSP:",n=e.substr(5).trim()):"PSTONE CTRL"==e.substr(0,11)?(t="PSTONE CTRL",n=e.substr(11).trim()):"PSCINEMA EQ."==e.substr(0,12)?(t="PSCINEMA EQ.",n=e.substr(12).trim()):"PSMULTEQ:"==e.substr(0,9)?(t="PSMULTEQ:",n=e.substr(9).trim()):(t=o[0],n=o[1].trim());else if("PV"==e.substr(0,2))2==o.length?(t=o[0],n=o[1].trim()):(t=e.substr(0,2),n=e.substr(2).trim());else if("MN"==e.substr(0,2))t=o[0],n=o[1].trim();else if("TR"==e.substr(0,2))t=o[0],n=o[1].trim();else if("DIM"==e.substr(0,3))t=o[0],n=o[1].trim();else if("TF"==e.substr(0,2))"TFANNAME"==e.substr(0,8)?(t="TFANNAME",n=e.substr(8).trim()):"TFAN"==e.substr(0,4)&&(t="TFAN",n=e.substr(4).trim());else if("TP"==e.substr(0,2))"TPAN"==e.substr(0,4)&&(t="TPAN",n=e.substr(4).trim());else if("TM"==e.substr(0,2)){if("TMAN"==e.substr(0,4)){t=e.substr(0,4),n=e.substr(4).trim();var s=this._stateBuffer.getState(t);switch(s||(s={}),n){case"AM":case"FM":s.band=n;break;case"AUTO":case"MANUAL":s.mode=n;}n=s;}}else if("Z2"==e.substr(0,2)){if("Z2MU"==e.substr(0,4))t="Z2MU",n=e.substr(4).trim();else if("Z2STBY"==e.substr(0,6))t="Z2STBY",n=e.substr(6).trim();else if("Z2CS"==e.substr(0,4))t="Z2CS",n=e.substr(4).trim();else if("Z2CV"==e.substr(0,4))t=o[0],n=o[1].trim();else if("Z2HPF"==e.substr(0,5))t="Z2HPF",n=e.substr(5).trim();else if("Z2PS"==e.substr(0,4))t=o[0],n=o[1].trim();else if("Z2SLP"==e.substr(0,5))t="Z2SLP",n=e.substr(5).trim();else if("Z2HDA"==e.substr(0,5))t="Z2HDA",n=e.substr(5).trim();else if(n=e.substr(2).trim(),isNaN(parseInt(n)))switch(n){case"ON":case"OFF":t="Z2:POWER";break;case"QUICK1":case"QUICK2":case"QUICK3":case"QUICK4":case"QUICK5":t="Z2QUICK";break;default:t="Z2:INPUT";}else t="Z2:VOLUME";}else if("Z3"==e.substr(0,2)){if("Z3MU"==e.substr(0,4))t="Z3MU",n=e.substr(4).trim();else if("Z3STBY"==e.substr(0,6))t="Z3STBY",n=e.substr(6).trim();else if("Z3CS"==e.substr(0,4))t="Z3CS",n=e.substr(4).trim();else if("Z3CV"==e.substr(0,4))t=o[0],n=o[1].trim();else if("Z3HPF"==e.substr(0,5))t="Z3HPF",n=e.substr(5).trim();else if("Z3PS"==e.substr(0,4))t=o[0],n=o[1].trim();else if("Z3SLP"==e.substr(0,5))t="Z3SLP",n=e.substr(5).trim();else if(n=e.substr(2).trim(),isNaN(parseInt(n)))switch(n){case"ON":case"OFF":t="Z3:POWER";break;case"QUICK1":case"QUICK2":case"QUICK3":case"QUICK4":case"QUICK5":t="Z3QUICK";break;default:t="Z3:INPUT";}else t="Z3:VOLUME";}else"MVMAX"==e.substr(0,5)?(t="MVMAX",n=e.substr(6).trim()):(t=e.substr(0,2),n=e.substr(2).trim());t&&n&&this._stateBuffer.putState(t,n);}}},_Controller.prototype._restartCloseTimeout=function(){var e=this;null!=this._closeTO&&(clearTimeout(this._closeTO),this._closeTO=null),this._closeTO=setTimeout(function(){e._logger.log("trace","no activity for "+e._closeTimeout/1e3+" seconds, stop the session"),e.close();},this._closeTimeout);},_Controller;}(),o=function(){var _Discover=function _Discover(){};_Discover.prototype.searchAVR=function(e,t){require("x.upnp.js").discoverDevicesWithTimeout(3e3,function(n){if(0==n.name.indexOf("Denon AVR")&&n.uuid==e){var o=n.modelName;o&&"*"==o.charAt(0)&&(o=o.substr(1)),t&&t(null,{ip:n.ip,uuid:n.uuid,name:n.name,model:o});}});};var _Monitor=function _Monitor(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session._Monitor"),this._socket=null,this._monitorCallback=null,this._commandTimeoutCount=0,this._heartBeatTo=null,this._heatBeatMissCount=0;var e=this;this._socketErrorCallback=function(t){e._finishRun(t);},this._socketCloseCallback=function(){e._finishRun(new Error("socket closed"));};};_Monitor.prototype.run=function(e,t){this._socket=e,this._monitorCallback=t,this._setListener(),this.scheduleNextHeartBeat();},_Monitor.prototype.reset=function(){if(this._monitorCallback=null,this._heatBeatMissCount=0,this._heartBeatTo&&(clearTimeout(this._heartBeatTo),this._heartBeatTo=null),this._socket){var e=this._socket;this._clearListener(),this._socket=null,e.close();}},_Monitor.prototype.executeCommandTimeout=function(e){e?(this._commandTimeoutCount++,this._logger.log("warn","execute command timeout#"+this._commandTimeoutCount),this._commandTimeoutCount>3&&this._finishRun(new Error("execute command is always timeout"))):this._commandTimeoutCount=0;},_Monitor.prototype.scheduleNextHeartBeat=function(e){this._scheduleNextHeartBeat(e||15e3);},_Monitor.prototype._scheduleNextHeartBeat=function(e){var t=this;this._heartBeatTo&&clearTimeout(this._heartBeatTo),this._heartBeatTo=setTimeout(function(){t._checkHeartBeat();},e);},_Monitor.prototype._checkHeartBeat=function(){if(this._socket){this._logger.log("trace","check heart beat");var e=this;this._socket.sendCommand("PW","?",function(t){t?(e._heatBeatMissCount++,e._logger.log("warn","check heart beat failed #"+e._heatBeatMissCount+", error:"+t.message),e._scheduleNextHeartBeat(2e3)):(e._heatBeatMissCount=0,e._scheduleNextHeartBeat(15e3)),e._heatBeatMissCount>3&&e._finishRun(new Error("heart beat failed"));});}},_Monitor.prototype._setListener=function(){this._socket&&(this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback));},_Monitor.prototype._clearListener=function(){this._socket&&(this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback));},_Monitor.prototype._finishRun=function(e){var t=this._socket;if(this._socket&&(this._clearListener(),this._socket=null),e&&t&&t.close(),this._heartBeatInterval&&(clearInterval(this._heartBeatInterval),this._heartBeatInterval=null),this._commandTimeoutCount=0,this._heatBeatMissCount=0,this._monitorCallback){var n=this._monitorCallback;this._monitorCallback=null,n(e);}};var _Connect=function _Connect(){this._connectWaitTo=null,this._socket=null,this._connectCallback=null;var e=this;this._socketOpenCallback=function(){e._finishConnect();},this._socketErrorCallback=function(t){e._finishConnect(t);},this._socketCloseCallback=function(){e._finishConnect(new Error("socket closed"));};};_Connect.prototype.connect=function(e,t){this._connectCallback=t;var n=e.wait;if(delete e.wait,this._socket=new s(e),this._setListener(),n){var o=this;this._connectWaitTo=setTimeout(function(){o._socket.open();},n);}else this._socket.open();return this._socket;},_Connect.prototype.reset=function(){if(this._connectWaitTo&&clearTimeout(this._connectWaitTo),this._connectWaitTo=null,this._connectCallback=null,this._socket){var e=this._socket;this._clearListener(),this._socket=null,e.close();}},_Connect.prototype._setListener=function(){this._socket&&(this._socket.on("open",this._socketOpenCallback),this._socket.on("error",this._socketErrorCallback),this._socket.on("close",this._socketCloseCallback));},_Connect.prototype._clearListener=function(){this._socket&&(this._socket.off("open",this._socketOpenCallback),this._socket.off("error",this._socketErrorCallback),this._socket.off("close",this._socketCloseCallback));},_Connect.prototype._finishConnect=function(e){var t=this._socket;if(this._socket&&(this._clearListener(),this._socket=null),e&&t&&t.close(e),this._connectCallback){var n=this._connectCallback;this._connectCallback=null,n(e,t);}};var _Session=function _Session(){this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session"),this._connect=new _Connect(),this._monitor=new _Monitor(),this._discover=new _Discover();var e=this;this._socketEventCallback=function(t){e._logger.log("trace","receive event:"+t),e._monitor.scheduleNextHeartBeat(),e._emitEvent("event",t);},this._socket=null,this._state="IDLE",this._ip=null,this._port=null,this._uuid=null,this._eventListeners={},this._connectFailCount=0,this._isConnecting=!1;};return _Session.prototype.on=function(e,t){e&&t&&(this._eventListeners[e]||(this._eventListeners[e]=[]),-1==this._eventListeners[e].indexOf(t)&&this._eventListeners[e].push(t));},_Session.prototype.off=function(e,t){if(e&&t&&this._eventListeners[e]){var n=this._eventListeners[e].indexOf(t);-1!=n&&this._eventListeners[e].splice(n,1);}},_Session.prototype.open=function(e){e&&"IDLE"==this._state&&(this._ip=e.ip,this._port=e.port,this._uuid=e.uuid,this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Session.("+this._ip+":"+this._port+")"),this._logger.log("debug","start controller for "+this._ip),this._doFSM("init"));},_Session.prototype.close=function(){"IDLE"!=this._state&&(this._logger.log("debug","stop controller"),this._doFSM("stop"));},_Session.prototype.sendCommand=function(e,t,n){if("IDLE"==this._state){var o=new Error("session not initialized");return o.sys="denon",o.code=-4,n&&n(o),void(this._isConnecting||this._doFSM("init"));}this._logger.log("trace","send command:"+e+t+" to "+this._ip);var s=this;this._socket.sendCommand(e,t,function(e,t){e?-3==e.code?(s._monitor.scheduleNextHeartBeat(),s._monitor.executeCommandTimeout(!0)):s._monitor.executeCommandTimeout(!1):(s._monitor.scheduleNextHeartBeat(),s._monitor.executeCommandTimeout(!1)),e?s._logger.log("trace","send command failed:"+e.message):s._logger.log("trace","send command success:"+t),n&&n(e,t);});},_Session.prototype._emitEvent=function(e,t){if(e){var n=this._eventListeners[e];if(n&&n.length>0)for(var o=0;o<n.length;o++){var s=n[o];try{s(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},_Session.prototype._connectAVR=function(e){this._logger.log("trace","connect avr device:"+this._ip+(e?" after "+e+" ms":"")),this._isConnecting=!0;var t=this;this._socket=this._connect.connect({ip:this._ip,port:this._port,uuid:this._uuid,wait:e},function(e,n){t._isConnecting=!1,e?(t._logger.log("trace","connect to avr device:"+t._ip+" failed, error:"+e.message),t._doFSM("conn_fail")):(t._logger.log("trace","connect to avr device:"+t._ip+" success"),t._socket=n,t._doFSM("conn_ok"));});},_Session.prototype._stopConnectAVR=function(){this._logger.log("trace","stop connect avr device:"+this._ip),this._connect.reset(),this._reset();},_Session.prototype._runAVR=function(){this._logger.log("trace","monitor avr device:"+this._ip);var e=this;this._monitor.run(this._socket,function(t){t&&(e._logger.log("trace","monitor avr device:"+e._ip+" failed, error:"+t.message),e._socket=null,e._doFSM("run_error"),e._emitEvent("error",t));}),this._setListener(),this._emitEvent("open");},_Session.prototype._stopRunAVR=function(){this._logger.log("trace","stop monitor avr device:"+this._ip),this._monitor.reset(),this._clearListener(),this._emitEvent("close"),this._reset();},_Session.prototype._searchAVR=function(){if(this._uuid){var e=this;this._discover.searchAVR(this._uuid,function(t,n){!t&&n&&n.ip!=e._ip&&(e._logger.log("trace","find avr ("+e._uuid+") with new ip:"+n.ip),"CONNECT"==e._state&&(e._ip=n.ip,e._connect.reset(),e._connectAVR()));});}},_Session.prototype._setListener=function(){this._socket&&this._socket.on("event",this._socketEventCallback);},_Session.prototype._clearListener=function(){this._socket&&this._socket.off("event",this._socketEventCallback);},_Session.prototype._reset=function(){this._socket=null,this._ip=null,this._port=null,this._uuid=null,this._connectFailCount=0;},_Session.prototype._doFSM=function(e){switch(this._logger.log("trace","FSM current state:"+this._state+" input:"+e),this._state){case"IDLE":if("init"===e)this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectAVR();break;case"CONNECT":switch(e){case"conn_fail":this._connectFailCount++,this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectFailCount>=2&&this._searchAVR(),this._connectAVR(Math.min(3e4,5e3*this._connectFailCount));break;case"conn_ok":this._connectFailCount=0,this._state="RUN",this._logger.log("trace","FSM new state:"+this._state),this._runAVR();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopConnectAVR();}break;case"RUN":switch(e){case"run_error":this._state="CONNECT",this._logger.log("trace","FSM new state:"+this._state),this._connectAVR();break;case"stop":this._state="IDLE",this._logger.log("trace","FSM new state:"+this._state),this._stopRunAVR();}}},_Session;}(),s=((e=function e(_e){if(!_e)throw new Error("options is null");if(!_e.ip)throw new Error("no ip");this._responseTimeout=300,this._ip=_e.ip,this._port=_e.port,this._port||(this._port=23),this._logger=require("x.logger.js").getLogger("xnm.aio.denon.AVR2._Socket.("+this._ip+":"+this._port+")"),this._timeout=2e3,this._listeners={},this._socket=null,this._buf="",this._state="IDLE",this._commands=[];}).prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},e.prototype.off=function(e,t){if(e&&t&&this._listeners[e]){var n=this._listeners[e].indexOf(t);-1!=n&&this._listeners[e].splice(n,1);}},e.prototype.open=function(){if(!this._socket&&"IDLE"==this._state){var e=this;this._state="CONNECT",this._buf="";var t=require("net").connect({port:this._port,host:this._ip});t.setTimeout(this._timeout),t.setEncoding("utf8"),this._logger.log("trace","start connect to "+this._ip+":"+this._port),t.on("connect",function(){e._logger.log("trace","success to connect "+e._ip+":"+e._port),e._state="CONNECTED",e._emitEvent("open"),e._executeNextCommand();}),t.on("data",function(t){e._logger.log("trace","receive data: "+t.toString()),e._buf+=t.toString(),e._processBuffer();}),t.on("error",function(t){e._logger.log("trace","socket error: "+t.message),e._emitEvent("error",t);}),t.on("timeout",function(){"CONNECT"==e._state&&(e._logger.log("trace","connect timeout"),e._emitEvent("error",new Error("connect timeout")),e.close(new Error("connect timeout")));}),t.on("close",function(){e._logger.log("trace","socket closed"),e._onClose();}),t._doConnect&&"function"==typeof t._doConnect&&t._doConnect(),this._socket=t;}},e.prototype.close=function(e){this._socket&&(this._state="CLOSED",this._socket.destroy(),this._onClose(e));},e.prototype.sendCommand=function(e,t,n){var o=null;if("CLOSED"==this._state)return(o=new Error("socket closed")).code=-1,void(n&&n(o));if(!e)return(o=new Error("invalid command")).code=-2,void(n&&n(o));var s={command:e,param:t,callback:n,timeout:null,state:"IDLE",responseTimeout:this._responseTimeout},i=this._commands.length;this._commands.push(s),0==i&&this._executeNextCommand();},e.prototype._executeNextCommand=function(){var e=this._commands[0];if(e&&"IDLE"==e.state&&"CONNECTED"==this._state){var t=e.command;void 0!==e.param&&null!=e.param&&(t+=e.param),t+="\r",e.state="SENT",this._setupReponseTimeout(e),this._logger.log("debug","send command:"+t);var n=new Buffer(t);this._socket.write(n);}},e.prototype._setupReponseTimeout=function(e){var t=this;e.timeout=setTimeout(function(){if(t._commands.splice(0,1),e.state="TIMEOUT",e.callback){t._logger.log("debug","response timeout");var n=new Error("response timeout");n.code=-3,e.callback(n);}t._executeNextCommand();},e.responseTimeout);},e.prototype._emitEvent=function(e,t){if(e){var n=this._listeners[e];if(n&&n.length>0)for(var o=0;o<n.length;o++){var s=n[o];try{s(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},e.prototype._processBuffer=function(){for(var e=this._buf.indexOf("\r");-1!=e;){if(0!=e){var t=this._buf.substr(0,e);this._processResponse(t);}this._buf=this._buf.substr(e+1),e=this._buf.indexOf("\r");}},e.prototype._processResponse=function(e){this._logger.log("debug","receive response: "+e);try{this._emitEvent("event",e);var t=this._commands[0];if(t&&"SENT"==t.state&&t.command&&t.command.substr(0,2)==e.substr(0,2)){clearTimeout(t.timeout);try{t.callback&&t.callback(null,e);}catch(e){this._logger.log("debug","do command callback error: "+e.message);}this._commands.splice(0,1),this._executeNextCommand();}}catch(e){this._logger.log("debug","process response error: "+e.message);}},e.prototype._onClose=function(e){this._state="CLOSED",this._socket=null,this._emitEvent("close"),this._listeners={};var t=e||new Error("socket closed");t.code=-1;for(var n=0;n<this._commands.length;n++){var o=this._commands[n];o.timeout&&clearTimeout(o.timeout),o.callback&&o.callback(t);}this._commands=[],this._buf="";},e),AVR=function AVR(e){this._ip=e.ip,this._port=e.port,this._uuid=e.uuid,this._model=e.model,this._name=e.name,this._port||(this._port=23),this._controller=new n();};return AVR.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if("openNative"==t.value)return window&&window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?e&&"marantz"==e.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"marantzremoteapp://"}):window.XC.callHost("SYSTEM","startApp",{scheme:"denonremoteapp://"}):"Android"==window.XCHost.getType()&&(e&&"marantz"==e.sys?window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.marantzremoteapp"}):window.XC.callHost("SYSTEM","startApp",{scheme:"com.dmholdings.denonremoteapp"}))),void(n&&n());if("customCMD"==t.value)return t.ext?(cmd="customCMD:"+t.ext,void this._sendCommand(t.ext,"",function(e){n&&n(e);})):void(n&&n(new Error("command customCMD ext format invalid")));var o=null,s=null;switch(t.path&&t.path[0]&&(o=t.path[0]),o){case"global":s=0;break;case"mainzone":s=1;break;case"zone2":s=2;break;case"zone3":s=3;}if("radio"==o)switch(t.value){case"band":this.setRadioBand(t.ext,n);break;case"previousPreset":this.previousRadioPreset(n);break;case"nextPreset":this.nextRadioPreset(n);break;case"preset":this.setRadioPreset(t.ext,n);break;default:n&&n(new Error("unkonwn command"));}else switch(t.value){case"on":this.setPower(s,!0,n);break;case"off":this.setPower(s,!1,n);break;case"toggle":this.togglePower(s,n);break;case"mute":this.setMute(s,!0,n);break;case"unmute":this.setMute(s,!1,n);break;case"toggleMute":this.toggleMute(s,n);break;case"volumeUp":this.volumeUp(s,n);break;case"volumeDown":this.volumeDown(s,n);break;case"setTo":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command json invalid")));this.setVolume(s,t.ext,n);break;case"setToDB":if(void 0===t.ext||null==t.ext)return void(n&&n(new Error("command json invalid")));this.setVolumeDB(s,t.ext,n);break;case"setInput":if(!t.ext)return void(n&&n(new Error("command json invalid")));this.setInput(s,t.ext,n);break;case"audioMode":if(!t.ext)return void(n&&n(new Error("command json invalid")));this.setSurroundMode(s,t.ext,n);break;case"quickSelect":if(!t.ext)return void(n&&n(new Error("command json invalid")));this.setQuickSelect(s,t.ext,n);break;default:n&&n(new Error("unkonwn command"));}}else n&&n(new Error("command json invalid"));},AVR.prototype.getStatesCreator=function(e,t,n){for(var o={},s=0;s<t.length;s++){if(t[s]&&t[s].id&&t[s].status&&t[s].status.value){var i="";t[s].status.path&&t[s].status.path[0]&&(i=t[s].status.path[0]);var r=t[s].status.value,a=r;i&&(a=i+":"+r),o[a]||(o[a]=[]),o[a].push(t[s].id);}}var u=this,l=[],c=Object.keys(o);if(c.length){var m=0,cb=function cb(e,t){e&&(t="?"),o[c[m]].forEach(function(e){l.push({id:e,status:t});}),++m<c.length?u._getStateWithName(c[m],cb):n&&n(null,l);};this._getStateWithName(c[m],cb);}else n&&n(null,[]);},AVR.prototype._getStateWithName=function(e,t){switch(e){case"global:power":case"power":this.getPower(0,t);break;case"radio:band":this.getRadioBand(t);break;case"radio:preset":this.getRadioPreset(t);break;case"mainzone:volume":this.getVolume(1,function(e,n){t(e,n);});break;case"mainzone:volumeDB":this.getVolume(1,function(e,n,o){t(e,o);});break;case"mainzone:power":this.getPower(1,t);break;case"mainzone:mute":this.getMute(1,t);break;case"mainzone:input":this.getInput(1,t);break;case"mainzone:audioMode":this.getSurroundMode(1,t);break;case"zone2:volume":this.getVolume(2,function(e,n){t(e,n);});break;case"zone2:volumeDB":this.getVolume(2,function(e,n,o){t(e,o);});break;case"zone2:power":this.getPower(2,t);break;case"zone2:mute":this.getMute(2,t);break;case"zone2:input":this.getInput(2,t);break;case"zone3:volume":this.getVolume(3,function(e,n){t(e,n);});break;case"zone3:volumeDB":this.getVolume(3,function(e,n,o){t(e,o);});break;case"zone3:power":this.getPower(3,t);break;case"zone3:mute":this.getMute(3,t);break;case"zone3:input":this.getInput(3,t);break;default:t(new Error("unknown state key"));}},AVR.prototype.setPower=function(e,t,n){var o=null,s=null;switch(e){case 0:o="PW",s=t?"ON":"STANDBY";break;case 1:o="ZM",s=t?"ON":"OFF";break;case 2:o="Z2",s=t?"ON":"OFF";break;case 3:o="Z3",s=t?"ON":"OFF";}o&&s?this._sendCommand(o,s,function(e){e?n&&n(e):setTimeout(function(){n&&n();},1e3);}):n&&n(new Error("invalid command"));},AVR.prototype.togglePower=function(e,t){var n=this;this.getPower(e,function(o,s){o?t&&t(o):(value="on"!=s,n.setPower(e,value,t));});},AVR.prototype.getPower=function(e,t){var n=null;switch(e){case 0:n="PW";break;case 1:n="ZM";break;case 2:n="Z2:POWER";break;case 3:n="Z3:POWER";}this._getState(n,function(e,n){e?t&&t(e):n?t&&t(null,"ON"==n?"on":"off"):t&&t(null,null);});},AVR.prototype.volumeUp=function(e,t){var n=null;switch(e){case 1:n="MV";break;case 2:n="Z2";break;case 3:n="Z3";}n?this._sendCommand(n,"UP",function(e){t&&t(e);}):t&&t(new Error("invalid command"));},AVR.prototype.volumeDown=function(e,t){var n=null,o="DOWN";switch(e){case 1:n="MV";break;case 2:n="Z2";break;case 3:n="Z3";}n?this._sendCommand(n,o,function(e){t&&t(e);}):t&&t(new Error("invalid command"));},AVR.prototype.setVolume=function(e,t,n){var o=null;switch(e){case 1:o="MV";break;case 2:o="Z2";break;case 3:o="Z3";}if(o){if((t=parseFloat(t))<0&&(t=0),t>98&&(t=98),function _isFloat(e){return Number(e)===e&&e%1!=0;}(t))for(t=10*t+"";t.length<3;){t="0"+t;}else for(t+="";t.length<2;){t="0"+t;}this._sendCommand(o,t,function(e){n&&n(e);});}else n&&n(new Error("invalid command"));},AVR.prototype.setVolumeDB=function(e,t,n){t=parseFloat(t),t+=80,this.setVolume(e,t,n);},AVR.prototype.getVolume=function(e,t){var n=null;switch(e){case 1:n="MV";break;case 2:n="Z2:VOLUME";break;case 3:n="Z3:VOLUME";}this._getState(n,function(e,n){if(e)t&&t(e);else if(n){var o=0;o=n.length<=2?parseInt(n):parseInt(n)/10,t&&t(null,o,o-80);}else t&&t(null,null);});},AVR.prototype.setMute=function(e,t,n){var o=null,s=t?"ON":"OFF";switch(e){case 1:o="MU";break;case 2:o="Z2MU";break;case 3:o="Z3MU";}o&&s?this._sendCommand(o,s,function(e){n&&n(e);}):n&&n(new Error("invalid command"));},AVR.prototype.toggleMute=function(e,t){var n=this;this.getMute(e,function(o,s){o?t&&t(o):(value="on"!=s,n.setMute(e,value,t));});},AVR.prototype.getMute=function(e,t){var n=null;switch(e){case 1:n="MU";break;case 2:n="Z2MU";break;case 3:n="Z3MU";}this._getState(n,function(e,n){e?t&&t(e):n?t&&t(null,"ON"==n?"on":"off"):t&&t(null,null);});},AVR.prototype.setInput=function(e,t,n){var o=null,s=t;switch(e){case 1:o="SI";break;case 2:o="Z2";break;case 3:o="Z3";}o&&s?this._sendCommand(o,s,function(e){n&&n(e);}):n&&n(new Error("invalid command"));},AVR.prototype.getInput=function(e,t){var n=null;switch(e){case 1:n="SI";break;case 2:n="Z2:INPUT";break;case 3:n="Z3:INPUT";}this._getState(n,function(e,n){e?t&&t(e):t&&t(null,n);});},AVR.prototype.setSurroundMode=function(e,t,n){var o=null,s=t;if(1===e)o="MS";o&&s?this._sendCommand(o,s,function(e){n&&n(e);}):n&&n(new Error("invalid command"));},AVR.prototype.getSurroundMode=function(e,t){var n=null;switch(e){case 1:n="MS";break;case 2:n="Z2:INPUT";break;case 3:n="Z3:INPUT";}this._getState(n,function(e,n){e?t&&t(e):t&&t(null,n);});},AVR.prototype.setQuickSelect=function(e,t,n){var o=null,s=t;if(!(s=parseInt(t))||isNaN(s)||s<1||s>5)n&&n(new Error("invalid command value"));else{switch(s="QUICK"+s,e){case 1:o="MS";break;case 2:o="Z2";break;case 3:o="Z3";}o&&s?this._sendCommand(o,s,function(e){n&&n(e);}):n&&n(new Error("invalid command"));}},AVR.prototype.previousRadioPreset=function(e){this._sendCommand("TP","ANUP",function(t){e&&e(t);});},AVR.prototype.nextRadioPreset=function(e){this._sendCommand("TP","ANDOWN",function(t){e&&e(t);});},AVR.prototype.setRadioPreset=function(e,t){!e||parseInt(e)<0||parseInt(e)>56?t&&t(new Error("invalid command")):((e+="").length<2&&(e="0"+e),this._sendCommand("TP","AN"+e,function(e){t&&t(e);}));},AVR.prototype.getRadioPreset=function(e){this._getState("TPAN",function(t,n){if(t)e&&e(t);else{var o=null;(o="OFF"==n?null:parseInt(n))&&!isNaN(o)||(o=null),e&&e(null,o);}});},AVR.prototype.setRadioBand=function(e,t){var n=null;switch(e){case"am":n="ANAM";break;case"fm":n="ANFM";}n?this._sendCommand("TM",n,function(e){t&&t(e);}):t&&t(new Error("invalid command"));},AVR.prototype.getRadioBand=function(e){this._getState("TMAN",function(t,n){if(t)e&&e(t);else{var o=null;if(n)switch(n.band){case"AM":o="am";break;case"FM":o="fm";}e&&e(null,o);}});},AVR.prototype._sendCommand=function(e,t,n){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.sendCommand(e,t,n);},AVR.prototype._getState=function(e,t){this._controller.isIdle()&&this._controller.open(this.toJSON()),this._controller.getState(e,t);},AVR.prototype.toJSON=function(){return{sys:"denon",type:"avr2",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model,name:this._name};},AVR.prototype.equalsTo=function(e){return!!e&&e instanceof AVR&&this._ip==e._ip&&this._port==e._port;},AVR.parseJSON=function(e){return e&&e.ip?new AVR(e):null;},AVR._Socket=s,AVR._Session=o,AVR._Controller=n,AVR;}(),xnm.aio.marantz.WebAVR=function(e,t,n,o,s){xnm.aio.denon.WebAVR.call(this,e,t,n,o,s),this._logger=require("x.logger.js").getLogger("xnm.aio.marantz.WebAVR");},xnm.aio.marantz.WebAVR.prototype=new xnm.aio.denon.WebAVR(),xnm.aio.marantz.WebAVR.prototype.constructor=xnm.aio.marantz.WebAVR,xnm.aio.marantz.WebAVR.prototype.toJSON=function(){var e={sys:xnm.aio.denon.DM.MARANTZ_SYS,type:"avr",ip:this.ip,port:this.port,uuid:this.uuid,model:this.model};return this.name&&(e.name=this.name),e;},xnm.aio.marantz.WebAVR.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.marantz.WebAVR&&this.ip==e.ip&&this.port==e.port;},xnm.aio.marantz.WebAVR.parseJSON=function(e){return e.ip?new xnm.aio.marantz.WebAVR(e.ip,e.port,e.uuid,e.name,e.model):null;},xnm.aio.denon.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="DenonDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"Quick Select 1",ref:{value:"Quick1"}},{type:"enum",name:"Quick Select 2",ref:{value:"Quick2"}},{type:"enum",name:"Quick Select 3",ref:{value:"Quick3"}},{type:"enum",name:"Quick Select 4",ref:{value:"Quick4"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"Internetradio",value:"netradio",children:[{type:"enum",name:"play/pause",ref:{value:"playPause"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","DVD/Blu-ray","Blu-ray","Game","AUX","AUX2","Media Player","iPod/USB","TV Audio","Tuner","Online Music","Bluetooth","Internetradio","Media Server","CD","PHONO"]}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}},{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:["Direct","Stereo","Dolby Surrounds","DTS Surrounds","Auto","Multi Ch Stereo","Super Stadium","Rock Arena","Jazz Club","Classic Concert","Mono Movie","Matrix","Video Game","Virtual"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","Media Player","iPod/USB","Tuner","Online Music","Bluetooth","Internetradio","Media Server","Source"]}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","Media Player","iPod/USB","Tuner","Online Music","Bluetooth","Internetradio","Media Server","Source"]}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner to preset",ref:{value:"tuner",ext:"%d",extMeta:"1-50",scale:"1"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:["CBL/SAT","DVD/Blu-ray","Blu-ray","Game","AUX","AUX2","Media Player","iPod/USB","TV Audio","Tuner","NETHOME","Bluetooth","Internetradio","SERVER","CD","PHONO"]}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:["Direct","Stereo","Dolby Surrounds","DTS Surrounds","Auto","Multi Ch Stereo","Super Stadium","Rock Arena","Jazz Club","Classic Concert","Mono Movie","Matrix","Video Game","Virtual"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:["CBL/SAT","DVD/Blu-ray","Blu-ray","Game","AUX","AUX2","Media Player","iPod/USB","TV Audio","Tuner","NETHOME","Bluetooth","Internetradio","SERVER","CD","PHONO"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"string",name:"input",ref:{value:"input"}},{type:"enum",name:"original input",ref:{value:"originalInput",options:["CBL/SAT","DVD/Blu-ray","Blu-ray","Game","AUX","AUX2","Media Player","iPod/USB","TV Audio","Tuner","NETHOME","Bluetooth","Internetradio","SERVER","CD","PHONO"]}}]}]},avr2:{command:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open denon Remote App",ref:{value:"openNative",value_t:"open_app_denon"}}]},{type:"root",name:"tuner",value:"radio",children:[{type:"enum",name:"set band",ref:{value:"band",ext:"%e",extMeta:["am","fm"]}},{type:"enum",name:"previous preset",ref:{value:"previousPreset"}},{type:"enum",name:"next preset",ref:{value:"nextPreset"}},{type:"int",name:"preset",ref:{value:"preset",ext:"%d",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"float",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%f",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}},{type:"enum",name:"set sound modus",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","DIRECT","PURE DIRECT","STEREO","AUTO","DOLBY DIGITAL","DTS SURROUND","AURO3D","AURO2DSURR","MCH STEREO","WIDE SCREEN","SUPER STADIUM","ROCK ARENA","JAZZ CLUB","CLASSIC CONCERT","MONO MOVIE","MATRIX","VIDEO GAME","VIRTUAL"]}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"float",name:"volume to (dB)",ref:{value:"setToDB",value_t:"volumeToDb",ext:"%f",extMeta:"-80.0-18.0",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}},{type:"int",name:"quick select",ref:{value:"quickSelect",ext:"%d",extMeta:"1-5"}}]}],status:[{type:"root",name:"global",value:"global",children:[{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}}]},{type:"root",name:"radio",value:"radio",children:[{type:"enum",name:"band",ref:{value:"band",options:["am","fm"]}},{type:"int",name:"current preset",ref:{value:"preset",extMeta:"1-56"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (db)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}},{type:"enum",name:"sound modus",ref:{value:"audioMode",options:["MOVIE","MUSIC","GAME","DIRECT","PURE DIRECT","STEREO","AUTO","DOLBY DIGITAL","DTS SURROUND","AURO3D","AURO2DSURR","MCH STEREO","WIDE SCREEN","SUPER STADIUM","ROCK ARENA","JAZZ CLUB","CLASSIC CONCERT","MONO MOVIE","MATRIX","VIDEO GAME","VIRTUAL"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"float",name:"volume",ref:{value:"volume",extMeta:"0.0-98.0",scale:"0.5"}},{type:"float",name:"volume (dB)",ref:{value:"volumeDB",extMeta:"-80.0-18.0",scale:"0.5"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["PHONO","CD","DVD","BD","TV","SAT/CBL","MPLAY","GAME","TUNER","HDRADIO","IRADIO","SERVER","FAVORITES","AUX1","AUX2","AUX3","AUX4","AUX5","AUX6","AUX7","NET","BT"]}}]}]}};return{SYS:"denon",MARANTZ_SYS:"marantz",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Denon AV Receiver",type:"avr"},{sys:this.SYS,name:"Denon AV Receiver - 2018",type:"avr2"},{sys:this.MARANTZ_SYS,name:"Marantz AV Receiver",type:"avr"},{sys:this.MARANTZ_SYS,name:"Marantz AV Receiver - 2018",type:"avr2"}];},createDevice:function createDevice(e,t,n){var o=DMError,s=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(s.INVALID,"ip is invalid")):n(new o(s.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var o=DMError,s=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(s.INVALID,"ip is invalid")):n(new o(s.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var o=this,_doFilterArr=function _doFilterArr(e,t,n){var o=[];return e.forEach(function(e){if("root"==e.type){var s=JSON.parse(JSON.stringify(e)),i=_doFilterArr(s.children,t,n);i&&i.length>0&&(s.children=i,o.push(s));}else if(function(e,t){if("*"==e)return!0;for(var n=!1,o=0;o<e.length;o++){if(e[o]==t){n=!0;break;}}return n;}(n.elems,e.type)){var r=JSON.parse(JSON.stringify(e));o.push(r);}}),o;},_filter=function _filter(e,t){var s=[],i=null,r=o.getCommandStatusMap(e,n);return r&&(i=function(e,t,n){var o=[];switch(n.catagory){case"command":e.command&&(o=_doFilterArr(e.command,t,n));break;case"status":e.status&&(o=_doFilterArr(e.status,t,n));}return o;}(r,e,t),s=s.concat(i)),s;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),i=null;switch(t.catagory){case"command":i=_filter(e,t),s.command=i;break;case"status":i=_filter(e,t),s.status=i;break;default:return null;}return i&&0!=i.length?s:null;},getCommandStatusMap:function getCommandStatusMap(t){if(!t||!t.type)return null;if(t.sys==this.MARANTZ_SYS){if(!e[t.type])return null;var n=JSON.parse(JSON.stringify(e[t.type]));if(n.command&&n.command[0]&&n.command[0].children){for(var o=-1,s=n.command[0].children,i=0;i<s.length;i++){if(s[i]&&s[i].ref&&s[i].ref.value&&"openNative"==s[i].ref.value){o=i;break;}}-1!=o&&(s[i].name="open marantz Remote App");}return n;}return e[t.type];}};}(),xnm.aio.denon.Handler=function(){var Handler=function Handler(){this.detectedAVRs={},this.detectedMarantzAVRs={};};return Handler.prototype.AVR=xnm.aio.denon.WebAVR,Handler.prototype.MarantzAVR=xnm.aio.marantz.WebAVR,Handler.prototype.AVR2=xnm.aio.denon.AVR2,Handler.prototype.devicemanager=xnm.aio.denon.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"denon"),e.register(this.devicemanager.MARANTZ_SYS,"denon");},Handler.prototype.resolveDevice=function(e){if(!e)return null;switch(e.sys){case this.devicemanager.SYS:switch(e.type){case"avr":return this.AVR.parseJSON(e);case"avr2":return this.AVR2.parseJSON(e);default:return null;}break;case this.devicemanager.MARANTZ_SYS:return"avr"===e.type?this.MarantzAVR.parseJSON(e):null;default:return null;}},Handler.prototype.getDeviceCommands=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=n?n.command:[];t&&t(null,o);},Handler.prototype.getDeviceStatus=function(e,t){var n=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=n?n.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,n){var o=this.resolveDevice(e);o?o.executeCommandCreator(e,t,function(e){n&&n(e);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,n,o){var s=this.resolveDevice(t);if(s){var i=[{id:e,device:t,status:n}];s.getStatesCreator(null,i,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("device json format invalid"));},Handler.prototype.discoverDevices=function(e){var t=require("x.upnp.js");if(t){var n=this;t.discoverDevicesWithTimeout(3e3,function(t){if(0==t.name.indexOf("Denon AVR")){var o=t.modelName;o&&"*"==o.charAt(0)&&(o=o.substr(1));var s=new xnm.aio.denon.AVR2({ip:t.ip,port:null,uuid:t.uuid,name:t.name,model:o});n.detectedAVRs["uuid:"+t.uuid]||(n.detectedAVRs["uuid:"+t.uuid]=s),e(s);}});}},Handler.prototype.discoverWithTimeout=function(e,t){var n={};this.discoverDevices(function(e){e&&e._uuid&&!n[e._uuid]&&(n[e._uuid]=e);}),setTimeout(function(){var e=[];for(var o in n){n.hasOwnProperty(o)&&e.push(n[o]);}t&&t(null,e);},e);},Handler.prototype.discoverMarantz=function(e){var t=require("x.upnp.js");if(t){var n=this;t.discoverDevicesWithTimeout(3e3,function(t){if(t.name&&0==t.name.toLowerCase().indexOf("marantz")){var o=t.modelName;o&&"*"==o.charAt(0)&&(o=o.substr(1));var s=new xnm.aio.marantz.WebAVR(t.ip,null,t.uuid,t.name,o);n.detectedMarantzAVRs["uuid:"+t.uuid]||(n.detectedMarantzAVRs["uuid:"+t.uuid]=s),e(s);}});}},Handler.prototype.discoverMarantzWithTimeout=function(e,t){var n={};this.discoverMarantz(function(e){e&&e.uuid&&!n[e.uuid]&&(n[e.uuid]=e);}),setTimeout(function(){var e=[];for(var o in n){n.hasOwnProperty(o)&&e.push(n[o]);}t&&t(null,e);},e);},Handler.prototype.getStateValues=function(e,t){return new xnm.aio.denon.WebAVR().getStateValues(e.type,t);},Handler.prototype.getDeviceCommandList=function(e,t,n){var o,s,i=[];if(t)i.push({id:window.XC_Text.on,cmd:"on"}),i.push({id:window.XC_Text.off,cmd:"off"});else if(n&&"avr"==e.type){i.push({id:"on",cmd:"on"}),i.push({id:"off",cmd:"off"}),i.push({id:"toggle",cmd:"toggle"}),i.push({id:"volumeDown",cmd:"volumeDown"}),i.push({id:"volumeUp",cmd:"volumeUp"}),i.push({id:"mute",cmd:"mute"}),i.push({id:"unmute",cmd:"unmute"}),i.push({id:"toggleMute",cmd:"toggleMute"});var r=i.length;for(o=0;o<r;o++){(s=JSON.parse(JSON.stringify(i[o]))).ch="mainzone",i.push(s),(s=JSON.parse(JSON.stringify(i[o]))).ch="zone2",i.push(s);}i.push({id:"set volume",cmd:"setTo",step:"0.5",max:"98",ch:"mainzone"}),i.push({id:"set volume",cmd:"setTo",step:"1",max:"80",ch:"zone2"});var a=[];for(a.push({id:"CBLSAT",cmd:"CBLSAT"}),a.push({id:"DVDBlu-ray",cmd:"DVDBlu-ray"}),a.push({id:"Blu-ray",cmd:"Blu-ray"}),a.push({id:"Game",cmd:"Game"}),a.push({id:"AUX",cmd:"AUX"}),a.push({id:"AUX2",cmd:"AUX2"}),a.push({id:"MediaPlayer",cmd:"MediaPlayer"}),a.push({id:"iPodUSB",cmd:"iPodUSB"}),a.push({id:"TVAudio",cmd:"TVAudio"}),a.push({id:"Tuner",cmd:"Tuner"}),a.push({id:"NETHOME",cmd:"NETHOME"}),a.push({id:"Bluetooth",cmd:"Bluetooth"}),a.push({id:"IRADIO",cmd:"IRADIO"}),a.push({id:"SERVER",cmd:"SERVER"}),a.push({id:"CD",cmd:"CD"}),a.push({id:"PHONO",cmd:"PHONO"}),a.push({id:"HDRADIO",cmd:"HDRADIO"}),a.push({id:"tunerUp",cmd:"tunerUp"}),a.push({id:"tunerDown",cmd:"tunerDown"}),a.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"50"}),r=a.length,o=0;o<r;o++){(s=JSON.parse(JSON.stringify(a[o]))).ch="mainzone",i.push(s),(s=JSON.parse(JSON.stringify(a[o]))).ch="zone2",i.push(s);}var u=new xnm.aio.denon.WebAVR().audioModes;for(o=0;o<u.length;o++){i.push({id:u[o],cmd:u[o]});}i.push({id:"Quick1",cmd:"Quick1"}),i.push({id:"Quick2",cmd:"Quick2"}),i.push({id:"Quick3",cmd:"Quick3"}),i.push({id:"Quick4",cmd:"Quick4"}),i.push({id:"playPause",cmd:"playPause"}),i.push({id:"previous",cmd:"previous"}),i.push({id:"next",cmd:"next"});}return i;},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.denon.Handler());