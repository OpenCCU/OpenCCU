"use strict";var x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.nanoleaf=x.hub.m.nanoleaf||{},x.hub.m.nanoleaf.Monitor={_devices:{},_logger:require("x.logger.js").getLogger("x.hub.m.nanoleaf.Monitor"),_timeout:null,handler:null,module:require("xnm.aio.nanoleaf.js"),interval:3e5,isRunning:!1,_checkDevices:function _checkDevices(e){for(var t=0;t<e.length;t++){var n=e[t],i=String(n.id).toLowerCase(),a=this._devices[i];if(a&&a.ip!==n.ip){this._logger.log("debug","IP of device "+i+" has changed: from "+a.ip+" to "+n.ip);var o=this.handler._connections[a.ip];this.handler.removeStateDevice(a),a.ip=n.ip,this.handler.addStateDevice(a),this.handler._connections[n.ip].callbacks=o.callbacks;}}},_search:function _search(){if(this.isRunning){var e=this;this.module.discoverWithTimeout(5e3,function(t,n){e.isRunning&&(!t&&Array.isArray(n)&&e._checkDevices(n),e._timeout=setTimeout(function(){e._search();},e.interval));});}},addDevice:function addDevice(e){if(e&&e.id){var t=String(e.id).toLowerCase();this._devices[t]=e;}},removeDevice:function removeDevice(e){if(e&&e.id){var t=String(e.id).toLowerCase();delete this._devices[t];}},start:function start(){this.isRunning||(this._logger.log("debug","Starting monitor."),this.isRunning=!0,this._search());},stop:function stop(){this.isRunning=!1,clearTimeout(this._timeout),this._logger.log("debug","Stopped monitor.");}},x.hub.m.nanoleaf.Handler=function(){this._callbacks=[],this._connections={},this._device=null,this._logger=require("x.logger.js").getLogger("x.hub.m.nanoleaf.Handler"),x.hub.m.nanoleaf.Monitor.handler=this;},x.hub.m.nanoleaf.Handler.prototype={_buildEvent:function _buildEvent(e,t,n){if(!n)return null;var i=[],a=null,o=null,r=null,s=null;return 1===t?(r=n.value,1===n.attr?a="on":2===n.attr?a="brightness":3===n.attr?a="hue":4===n.attr?a="sat":5===n.attr?a="ct":6===n.attr&&(a="colorMode")):2===t||(3===t?1===n.attr&&(a="effectSelected",r=n.value):4===t&&(0===n.gesture?(a="gestureTap",r="single tap",n.panelId>=0&&(o="gestureSingleTapPanel",s=n.panelId)):1===n.gesture?(a="gestureTap",r="double tap",n.panelId>=0&&(o="gestureDoubleTapPanel",s=n.panelId)):2===n.gesture?(a="gestureSwipe",r="swipe up"):3===n.gesture?(a="gestureSwipe",r="swipe down"):4===n.gesture?(a="gestureSwipe",r="swipe left"):5===n.gesture&&(a="gestureSwipe",r="swipe right"))),null===a||null===r?null:(i.push({module:"nanoleaf",device:e,data:{key:a,value:r,changed:!0}}),null!==o&&null!==s&&i.push({module:"nanoleaf",device:e,data:{key:o,value:s,changed:!0}}),i);},_handleEventStream:function _handleEventStream(e,t,n){if(200!==e.statusCode){var i=new Error("Server responded with status code: "+e.statusCode);return this._logger.log("error","[_handleEventStream] "+i.message),void(t&&t({error:i}));}this._logger.log("debug","[_handleEventStream] Connection for "+n.ip+" has been opened.");var a=this,o="";this._connections[n.ip].stream=e,this._connections[n.ip].status="connected",e.on("data",function(e){if((o+=String(e)).indexOf("\n\n")>=0){var t=o.split("\n\n");o="",a._parseIncomingMessage(n,t);}else o.length>2e4&&(a._logger.log("warn","[_handleEventStream] Incoming message string has become too long ("+o.length+"). Discarding message."),o="");}),e.on("end",function(){a._logger.log("debug","[_handleEventStream] Event stream ended for device "+n.ip+".");}),e.on("close",function(){a._logger.log("debug","[_handleEventStream] Event stream closed for device: "+n.ip+"."),a._connections[n.ip]&&(a._connections[n.ip].stream=null,a._connections[n.ip].status="disconnected",a._retryWithTimeout(n));});},_parseIncomingMessage:function _parseIncomingMessage(e,t){var n=this._connections[e.ip];if(n&&n.callbacks)for(var i=0;i<t.length;i++){for(var a=t[i].trim().split("\n"),o=null,r=null,s=0;s<a.length;s++){var l=a[s].trim();if(0===l.indexOf("id:"))o=parseInt(l.replace("id:","").trim(),10);else if(0===l.indexOf("data:")){r=l.replace("data:","").trim();try{r=JSON.parse(r);}catch(e){r=null;}}}if(o&&r&&Array.isArray(r.events))for(var c=0;c<r.events.length;c++){var u=r.events[c],d=this._buildEvent(e,o,u);if(d)for(var g=0;g<d.length;g++){var h=d[g];this._sendEvent(h,n.callbacks);}}}},_retryWithTimeout:function _retryWithTimeout(e,t){if(("number"!=typeof t||isNaN(t)||t<0)&&(t=12e4),this._connections[e.ip]){var n=this;setTimeout(function(){n.addStateDevice(e,null);},t);}else this._logger.log("debug","Device connection data does not exist anymore. Will not retry connection.");},_sendEvent:function _sendEvent(e,t){if(!e||!e.data)return null;for(var n in this._logger.log("trace","[_sendEvent] "+e.data.key+": "+e.data.value),t){if(n===e.data.key)for(var i=t[n],a=0;a<i.length;a++){var o=i[a];if(o&&"function"==typeof o.onEvent)try{o.onEvent(e);}catch(e){this._logger.log("error","[_sendEvent] "+e.message);}}}},addCallback:function addCallback(e,t){if(e&&t&&t.callback&&t.statusKey){var n=this._connections[e.ip];if(n){var i=t.statusKey;n.callbacks[i]||(n.callbacks[i]=[]),n.callbacks[i].indexOf(t.callback)<0&&n.callbacks[i].push(t.callback);}}},addStateDevice:function addStateDevice(e,t,n){var i=null;if(!e.token)return i=new Error("Nanoleaf device has no auth token."),this._logger.log("error","[addStateDevice] "+i.message),void(t&&t({error:i}));if(!e.ip)return i=new Error("Nanoleaf device has no IP."),this._logger.log("error","[addStateDevice] "+i.message),void(t&&t({error:i}));var a=this._connections[e.ip];if(a&&(a.stream||"connecting"===a.status))return n&&this.addCallback(e,n),this._logger.log("debug","[addStateDevice] Device connection for "+e.ip+" already exists."),void(t&&t());a||(this._connections[e.ip]={callbacks:{},device:e,status:"connecting",stream:null}),n&&this.addCallback(e,n),this._logger.log("debug","[addStateDevice] Opening connection for event stream to device "+e.ip+"..."),x.hub.m.nanoleaf.Monitor.addDevice(e),x.hub.m.nanoleaf.Monitor.start();var o=require("http"),r="/api/v1/"+e.token+"/events?id=1,3,4",s={host:e.ip,port:e.port||16021,path:r,method:"GET",headers:{Accept:"text/event-stream","Cache-Control":"no-cache"}},l=this,c=o.request(s,function(n){l._handleEventStream(n,t,e);});"function"==typeof c.setEncoding&&c.setEncoding("utf8"),c.on("error",function(t){l._logger.log("error","[addStateDevice] Request error: "+t.message),l._retryWithTimeout(e);}),c.end();},checkDeviceMatch:function checkDeviceMatch(e,t){return!!(t&&t.device&&e&&e.device)&&t.device.ip===e.device.ip;},removeCallback:function removeCallback(e,t){if(e&&t&&t.statusKey&&t.callback){var n=this._connections[e.ip];if(n){var i=n.callbacks[t.statusKey];if(i){var a=i.indexOf(t.callback);a>=0&&i.splice(a,1);}}}},removeStateDevice:function removeStateDevice(e,t,n){n&&this.removeCallback(e,n);var i=this._connections[e.ip];i&&(delete this._connections[e.ip],i.stream&&i.stream.destroy());},getSystems:function getSystems(){return["nanoleaf"];},init:function init(e){e&&e();}},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.nanoleaf.Handler());