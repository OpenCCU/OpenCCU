var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.devicegroup=xnm.aio.devicegroup||{},xnm.aio.devicegroup.Group=function(){var Group=function Group(e){this.info=e;};return Group.prototype.executeCommandCreator=function(e,n,i,r){if(this.info&&this.info.devices){if(n&&n.value){if(r){if(0!=this.info.devices.length){var a=this,o=0,cb=function cb(e){o++,e,o!=a.info.devices.length?a._executeCommand(r,a.info.devices[o],n,cb):i&&i();};this._executeCommand(r,this.info.devices[o],n,cb);}else i&&i();}else i&&i(new Error("commandhandler invlaid"));}else i&&i(new Error("command value is empty"));}else i&&i(new Error("info devices is invalid"));},Group.prototype._executeCommand=function(e,n,i,r){var a={device:{room:n.room,name:n.device},cmd:i};e._executeCommand(a,function(e){r&&r(e);});},Group;}(),xnm.aio.devicegroup.DM=function(){var DMError=function DMError(e,n){this.code=e,this.message=n,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="DeviceGroupDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"devicegroup",createDevice:function createDevice(e,n,i){var r=DMError,a=DMError.ERROR_CODE;e?e.devices?i(null,e):i(new r(a.INVALID,"devices is invalid")):i(new r(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,n,i){var r=DMError,a=DMError.ERROR_CODE;e?e.devices?i(null,e):i(new r(a.INVALID,"devices is invalid")):i(new r(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,n,i){i();},applyUIFilter:function applyUIFilter(e,n,i,r){var _mergeCommand=function _mergeCommand(e,n){if(e.command){for(var i=[],r=0;r<n.length;r++){var a=!1,o=n[r];if(o&&o.ref&&o.ref.value){for(var t=0;t<e.command.length;t++){var c=e.command[r];if(c&&c.ref&&c.ref.value&&o.ref.value==c.ref.value){a=!0;break;}}a||i.push(o);}}e.command=e.command.concat(i);}else e.command=n;},_mergeStatus=function _mergeStatus(e,n){if(e.status){for(var i=[],r=0;r<n.length;r++){var a=!1,o=n[r];if(o&&o.ref&&o.ref.value){for(var t=0;t<e.status.length;t++){var c=e.status[r];if(c&&c.ref&&c.ref.value&&c.ref.value==c.ref.value){a=!0;break;}}a||i.push(o);}}e.status=e.status.concat(i);}else e.status=n;},_getCommandStatusMap=function _getCommandStatusMap(e,i,r){if(!(e&&r&&r.findDevice&&r.dm&&e.devices&&0!=e.devices.length))return null;for(var a={command:[],status:[]},o=0;o<e.devices.length;o++){if(e.devices[o]){var t=e.devices[o].room,c=e.devices[o].device,s=r.findDevice(t,c);if(s&&s.info&&s.info.sys){var u=r.dm.getModule(s.info.sys);if(u&&u.devicemanager&&u.devicemanager.applyUIFilter){var v=u.devicemanager.applyUIFilter(s.info,n,r.deviceinfo,r);v&&(v.command&&_mergeCommand(a,v.command),v.status&&_mergeStatus(a,v.status));}}}}return a;},_contains=function _contains(e,n){if("*"==e)return!0;for(var i=!1,r=0;r<e.length;r++){if(e[r]==n){i=!0;break;}}return i;},_filter=function _filter(e,n){var i=[],a=null,o=_getCommandStatusMap(e,0,r);return o&&(a=function(e,n,i){var r=[];switch(i.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(i.elems,e.type)){var n=JSON.parse(JSON.stringify(e));r.push(n);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(i.elems,e.type)){var n=JSON.parse(JSON.stringify(e));r.push(n);}});}return r;}(o,0,n),i=i.concat(a)),i;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),o=null;switch(n.catagory){case"command":o=_filter(e,n),a.command=o;break;case"status":o=_filter(e,n),a.status=o;break;default:return null;}return o&&0!=o.length?a:null;}};}(),xnm.aio.devicegroup.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.devicegroup.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"devicegroup");},Handler.prototype.resolveDevice=function(e){return e&&e.devices?new xnm.aio.devicegroup.Group(e):null;},Handler;}(),"undefined"!=typeof module&&module&&module.exports&&(module.exports=new xnm.aio.devicegroup.Handler());