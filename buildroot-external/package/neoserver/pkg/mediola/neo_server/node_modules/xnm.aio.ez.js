var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.ez=xnm.aio.ez||{},xnm.aio.ez.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var t=JSON.parse(JSON.stringify(e));if(t.auth&&(t.auth="xxxxxx:xxxxxx"),t.headers)for(var r in headers){if(r&&"authorization"==r.toLocaleLowerCase()){var n=headers[r];if(n){var a=n.indexOf(" ");headers[r]=-1==a?"xxxxxx":n.substr(0,a)+" xxxxxx";}}}return t;}catch(t){return e;}}},xnm.aio.ez.XS1=function(){var XS1=function XS1(e,t,r){this._logger=require("x.logger.js").getLogger("xnm.aio.ez.XS1"),this.ip=e,this.port=80,t&&(t=parseInt(t))>0&&(this.port=t),this.username="admin",this.password=r||null,this._getDevicesCBs=[],this._deviceBuffer=null;};return XS1.prototype._doRequest=function(e,t,r){var n={host:this.ip,port:this.port,path:"/control?callback=data&cmd="+e,method:"GET",headers:{Connection:"close"}};if(t)for(var a in t){t.hasOwnProperty(a)&&(n.path+="&"+a+"="+encodeURI(t[a]));}this.username&&this.password&&(n.headers.Authorization="Basic "+new Buffer(this.username+":"+this.password).toString("base64")),this._logger.log("trace","send http request:"+JSON.stringify(xnm.aio.ez.Util.clearHttpOptionForLog(n)));var o=r,s=this,i=require("http").request(n,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){if(s._logger.log("trace","http response code:"+e.statusCode+" body:"+t),200==e.statusCode){if((t=t.trim()).length<6||"data("!=t.substr(0,5))return o&&o(new Error("response fomart error:"+t)),void(o=null);for(var r=t.substr(5),n=r.length-1;n>=0&&")"!=r.charAt(n);){n-=1;}if(n<0)return o&&o(new Error("response fomart error:"+t)),void(o=null);r=r.substr(0,n);try{r=JSON.parse(r),o&&o(null,r),o=null;}catch(e){o&&o(new Error("response fomart error:"+t)),o=null;}}else o&&o(new Error("http response code:"+e.statusCode+" "+t)),o=null;});});i.setTimeout(2e3,function(){s._logger.log("trace","http request timeout"),i.abort(),o&&o(new Error("http request timeout")),o=null;}),i.on("error",function(e){s._logger.log("trace","http request error:"+e.message),o&&o(e),o=null;}),i.end();},XS1.prototype.getDevices=function(e){e||(e=function e(){});var t=this._getDevicesCBs.length;if(-1==this._getDevicesCBs.indexOf(e)&&this._getDevicesCBs.push(e),0==t){var r=this;this.getActuators(function(e,t){if(e){var n=r._getDevicesCBs;r._getDevicesCBs=[];for(var a=0;a<n.length;a++){n[a]&&n[a](e);}}else{var o=[];t&&(o=o.concat(t)),r.getSensors(function(e,t){var n=r._getDevicesCBs,a=0;if(r._getDevicesCBs=[],e)for(a=0;a<n.length;a++){n[a]&&n[a](e);}else for(t&&(o=o.concat(t)),a=0;a<n.length;a++){n[a]&&n[a](null,o);}});}});}},XS1.prototype.getState=function(e){var _resolveStates=function _resolveStates(e){var t={actuator:{},sensor:{}};if(e)for(var r=0;r<e.length;r++){var n=e[r];n.address&&("actuator"==n.type?t.actuator[n.address]=n.value:"sensor"==n.type&&(t.sensor[n.address]=n.value));}return t;};if(this._deviceBuffer){var t=_resolveStates(this._deviceBuffer);e&&e(null,t),e=null;}this.getDevices(function(t,r){if(t)e&&e(t);else{var n=_resolveStates(r);e&&e(null,n),e=null;}});},XS1.prototype.executeCommand=function(e,t,r){e.address?t?this._doRequest("set_state_actuator",{number:e.address,"function":t},function(e){r&&r(e);}):r&&r(new Error("command invalid")):r&&r(new Error("address invalid"));},XS1.prototype.executeCommandCreator=function(e,t,r){if(t&&t.value&&"func"==t.value&&t.ext){var n=t.ext;this.executeCommand(e,n,function(e){r&&r(e);});}else r&&r(new Error("command invalid"));},XS1.prototype.getStatesCreator=function(e,t,r){this.getState(function(e,n){if(e)r&&r(e);else{for(var a=[],o=0;o<t.length;o++){var s=t[o];if(s&&s.id&&s.device){var i,u=s.device;if(u.type&&u.address)"actuator"==u.type?i=n.actuator[u.address]:"sensor"==u.type&&(i=n.sensor[u.address]),void 0!==i&&null!=i&&a.push({id:s.id,status:i});}}r&&r(null,a);}});},XS1.prototype.getActuators=function(e){this._doRequest("GET_LIST_ACTUATORS",null,function(t,r){if(t)e&&e(t);else{var n=[];if(r&&r.actuator)for(var a=0;a<r.actuator.length;a++){"disabled"!=r.actuator[a].type&&n.push({sys:"xs1",type:"actuator",name:r.actuator[a].name,address:r.actuator[a].id,data:r.actuator[a].type,value:r.actuator[a].value,unit:r.actuator[a].unit,"function":r.actuator[a]["function"]});}e&&e(null,n);}});},XS1.prototype.getSensors=function(e){this._doRequest("GET_LIST_SENSORS",null,function(t,r){if(t)e&&e(t);else{var n=[];if(r&&r.sensor)for(var a=0;a<r.sensor.length;a++){"disabled"!=r.sensor[a].type&&n.push({sys:"xs1",type:"sensor",name:r.sensor[a].name,address:r.sensor[a].id,data:r.sensor[a].type,value:r.sensor[a].value,unit:r.sensor[a].unit});}e&&e(null,n);}});},XS1.prototype.toJSON=function(){return{sys:"xs1",ip:this.ip,port:this.port,password:this.password};},XS1.prototype.equalsTo=function(e){return!!e&&e instanceof XS1&&this.ip==e.ip&&this.port==e.port&&this.password==e.password;},XS1;}(),xnm.aio.ez.DMError=function(e,t){this.code=e,this.message=t,this.stack=new Error().stack;},xnm.aio.ez.prototype=new Error(),xnm.aio.ez.prototype.name="EZDMError",xnm.aio.ez.prototype.code=0,xnm.aio.ez.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},xnm.aio.ez.DM={XS1_SYS:"xs1",getGatewayType:function getGatewayType(){return[{sys:this.XS1_SYS,name:"EZcontrol XS1"}];},getGatewayDeviceType:function getGatewayDeviceType(e){return e.sys===this.XS1_SYS?[{type:"actuator",name:"Actuator"},{type:"sensor",name:"Sensor"}]:null;},createGateway:function createGateway(e,t,r){var n=xnm.aio.ez.DM.DMError,a=xnm.aio.ez.DM.ERROR_CODE;e?e.ip?(e.port||(e.port=80),r(null,e)):r(new n(a.INVALID,"ip is invalid")):r(new n(a.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,n){var a=xnm.aio.ez.DM.DMError,o=xnm.aio.ez.DM.ERROR_CODE;t?t.ip?(t.port||(t.port=80),n(null,t)):n(new a(o.INVALID,"ip is invalid")):n(new a(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,r){r();},createDevice:function createDevice(e,t,r){var n=xnm.aio.ez.DMError,a=xnm.aio.ez.DM.ERROR_CODE;e?e.type?e.address?r(null,e):r(new n(a.INVALID,"address is invalid")):r(new n(a.INVALID,"type is invalid")):r(new n(a.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var n=xnm.aio.ez.DMError,a=xnm.aio.ez.DM.ERROR_CODE;e?e.type?e.address?r(null,e):r(new n(a.INVALID,"address is invalid")):r(new n(a.INVALID,"type is invalid")):r(new n(a.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(e){if(!e.sys||!e.type)return null;var t={command:[],status:[{type:"float",name:"status",ref:{value:"state",ext:"%f"}}]};if(e.sys===this.XS1_SYS){if(e["function"])for(var r=0;r<e["function"].length;r++){var n=e["function"][r];n&&n.type&&"disabled"!=n.type&&t.command.push({type:"enum",name:n.dsc,ref:{value:"func",ext:r+1}});}return t;}return null;},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,n=0;n<e.length;n++){if(e[n]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var r=[],n=null,a=xnm.aio.ez.DM.getCommandStatusMap(e);return a&&(n=function(e,t,r){var n=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(a,0,t),r=r.concat(n)),r;};if(!e.sys)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),r.command=n;break;case"status":n=_filter(e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;}},xnm.aio.ez.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.ez.DM,Handler.prototype.XS1=xnm.aio.ez.XS1,Handler.prototype.registModule=function(e){e.register(this.devicemanager.XS1_SYS,"ez");},Handler.prototype.resolveGateway=function(e){return e&&e.sys&&e.ip&&e.sys===this.devicemanager.XS1_SYS?new xnm.aio.ez.XS1(e.ip,e.port,e.password):null;},Handler.prototype.getDeviceCommands=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),n=r?r.command:[];t&&t(null,n);},Handler.prototype.getDeviceStatus=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),n=r?r.status:[];t&&t(null,n);},Handler.prototype.doCommand=function(e,t,r,n){var a=this.resolveGateway(e);a?a.executeCommandCreator(t,r,n):n&&n(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,r,n,a){var o=this.resolveGateway(t);if(o){var s=[{id:e,device:r,status:n}];o.getStatesCreator(null,s,function(e,t){e?a&&a(e):a&&a(null,t[0]);});}else a&&a(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var r=this.resolveGateway(e);r?r.getDevices(function(e,r){t&&t(e,r);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.ez.Handler());