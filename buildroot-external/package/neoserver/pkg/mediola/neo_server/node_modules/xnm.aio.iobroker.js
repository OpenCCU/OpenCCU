function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.iobroker=xnm.aio.iobroker||{},xnm.aio.iobroker.SimpleAPI=/*#__PURE__*/function(){function SimpleAPI(e,t,a,s,n){_classCallCheck(this,SimpleAPI);"undefined"==typeof require||null==require?this._logger={log:function log(e,t){console&&console.log&&console.log(e,t);}}:(this._logger=require("x.logger.js").getLogger("xnm.aio.iobroker.SimpleAPI"),require("x.logger.js").setLogToConsole(!0,"xnm.aio.iobroker.SimpleAPI")),this.ip=e,this.port=t,this.port||(this.port=8087),this.username=a,this.password=s,this.https=n,this._statesCache={},this._statesRequestPending=!1;}_createClass(SimpleAPI,[{key:"executeCommand",value:function executeCommand(e,t,a){if(e&&e.id){if(t&&t.value)switch(t.value){case"setValue":if(null==t.ext||null==t.ext)return void(a&&a(new Error("value invalid")));this._set(e.id,{value:t.ext},a);break;case"toggleValue":this._toggle(e.id,a);break;default:a&&a(new Error("unknown command"));}else a&&a(new Error("command invalid"));}else a&&a(new Error("device invalid"));}},{key:"getStates",value:function getStates(e,t){var _this=this;var a=null;if(1===e.length)a=e[0];else if(e.length>1){e.sort(function(e,t){return e.length-t.length;});for(var s=e[0].split("."),n="",o=0,r=Math.min(s.length,8);o<r;){for(var i=n+s[o],l=!1,u=1;u<e.length;u++){if(0!==e[u].indexOf(i)){l=!0;break;}}if(l)break;n=i+".",o++;}n&&("."===n[n.length-1]&&(n=n.substr(0,n.length-1)),a=n+"*",this._logger.log("trace","ioBroker states pattern: "+a));}var c=Date.now();for(var _e in this._statesCache){c-this._statesCache[_e].time>=2e3&&delete this._statesCache[_e];}var m=this._statesCache["*"];var d=a||"*",p=this._statesCache[d];if("*"!==d&&m&&(!p||m.time>p.time)&&(d="*",p=m),p){this._logger.log("debug","Request for pattern \"".concat(a,"\" (key: \"").concat(d,"\") answered from cache."));var _s=this._buildStatesReturn(p.data,e);return void t(null,_s);}if(this._statesRequestPending){var _e2=new Error("Last ioBroker request is still pending. Ignoring new one.");return this._logger.log("debug",_e2.message),void t(_e2,null);}this._statesRequestPending=!0;var f=setTimeout(function(){_this._logger.log("debug","Gave up on pending request after 3 sec."),_this._statesRequestPending=!1;},3e3);this._states(a,function(a,s){clearTimeout(f),_this._statesRequestPending=!1;var n=null;!a&&s&&(_this._statesCache[d]={data:s,time:Date.now()}),a?_this._logger.log("error",a):n=_this._buildStatesReturn(s,e),t(a,n);});}},{key:"_buildStatesReturn",value:function _buildStatesReturn(e,t){var a=null;if(t&&0!==t.length){a={};for(var s=0;s<t.length;s++){var n=t[s];e[n]&&(a[n]=e[n].val);}}else a=e;return a;}},{key:"executeCommandCreator",value:function executeCommandCreator(e,t,a){if(t&&t.value){if(e&&e.id){var s=this._resolveCommand(e,t);s?this.executeCommand(e,s,function(e){a&&a(e);}):a&&a(new Error("unknown command"));}else a&&a(new Error("device json invalid"));}else a&&a(new Error("command json invalid"));}},{key:"isReachable",value:function isReachable(){var _this2=this;return new Promise(function(e){_this2._doRequest("GET","/get/system.adapter.simple-api.0.uptime",null,null,function(t,a){if(t)return _this2._logger.log("error",t),void e(!1);e(!0);});});}},{key:"_resolveCommand",value:function _resolveCommand(e,t){if(!t)return null;if("setGenValue"==t.value){var a=t.ext;return void 0!==a&&null!=a||(a=""),{value:"setValue",ext:a};}if("toggle"==t.value)return{value:"toggleValue"};if(!e.common)return null;if(!t.value)return null;switch(e.common.type){case"boolean":switch(t.value){case"on":case"press":case"longPress":case"stop":case"start":case"open":case"unlock":case"play":case"next":case"prev":case"pause":case"forward":case"reverse":case"fastforward":case"fastreverse":return{value:"setValue",ext:!0};case"off":case"lock":return{value:"setValue",ext:!1};}break;case"number":var s=e.common.min,n=e.common.max;switch(t.value){case"setValue":if(void 0===t.ext||null==t.ext)return null;var o=parseFloat(t.ext);return isNaN(o)?null:(void 0===s||null==s||isNaN(parseFloat(s))||o<parseFloat(s)&&(o=parseFloat(s)),void 0===n||null==n||isNaN(parseFloat(n))||o>parseFloat(n)&&(o=parseFloat(n)),{value:"setValue",ext:o});case"setRGB":return void 0===t.ext||null==t.ext?null:{value:"setValue",ext:parseInt(t.ext,16)};}break;case"string":return void 0===t.ext||null==t.ext?null:{value:"setValue",ext:t.ext};default:return null;}}},{key:"getStatesCreator",value:function getStatesCreator(e,t,a){if(t){if(0!=t.length){for(var s=[],n=0;n<t.length;n++){var o=t[n];o&&o.device&&o.device.id&&-1==s.indexOf(o.device.id)&&s.push(o.device.id);}var r=this;this.getStates(s,function(e,s){if(e)a&&a(e);else{for(var n=[],o=0;o<t.length;o++){var i=t[o];if(i&&i.id){var l=null;i.device&&i.device.id&&i.status&&(l=s[i.device.id],l=r._resolveState(i.device,i.status,l)),void 0!==l&&null!=l||(r._logger.log("error","? status (device:".concat(JSON.stringify(i),")")),l="?"),n.push({id:i.id,status:l});}}a&&a(null,n);}});}else a&&a(null,[]);}else a&&a(new Error("deviceList is null"));}},{key:"_resolveState",value:function _resolveState(e,t,a){if(void 0===a||null==a)return null;if(!t||!t.value)return a;if("genValue"==t.value)return a;if(!e||!e.common)return null;switch(e.common.type){case"boolean":switch(e.common.role){case"state":case"sensor.light":case"sensor.motion":case"sensor.rain":case"switch":case"switch.boost":case"switch.light":case"switch.comfort":case"media.mode.shuffle":case"media.mode.repeat":case"media.mute":return a?"on":"off";case"sensor.window":case"sensor.door":return a?"open":"closed";case"sensor.lock":case"switch.lock":case"switch.lock.door":case"switch.lock.window":return a?"unlock":"lock";case"media.state":return a?"play":"stop";default:return a;}case"number":switch(e.common.role){case"value.window":return e.common.states?e.common.states[a]:{0:"closed",1:"titled",2:"open"}[a];case"value.time":return parseInt(a);case"media.state":return e.common.states?e.common.states[a]:{0:"play",1:"stop",2:"pause"}[a];default:return e.common.states?e.common.states[a]:parseFloat(a);}default:return a;}}},{key:"getStateObjectTree",value:function getStateObjectTree(e){var t=[],a=this;this._objects("instance",null,function(s,n){if(s)e&&e(s);else{var o=0;for(var r in n){o++;var i={id:r,name:r,type:n[r].type,children:[]};a._insertTree(t,i);}a._logger.log("debug","Found "+o+" instances."),a._objects("device",null,function(s,n){if(s)e&&e(s);else{var o=0;for(var r in n){o++;var i={id:r,name:r,type:n[r].type,children:[]};a._insertTree(t,i);}a._logger.log("debug","Found "+o+" devices."),a._objects("channel",null,function(s,n){if(s)e&&e(s);else{var o=0;for(var r in n){o++;var i={id:r,name:r,type:n[r].type,children:[]};a._insertTree(t,i);}a._logger.log("debug","Found "+o+" channels."),a._objects("state",null,function(s,n){if(s)e&&e(s);else{var o=0;for(var r in n){o++;var i=n[r],l={sys:"iobroker",id:r,name:r,type:i.type,common:i.common};a._insertTree(t,l);}a._logger.log("debug","Found "+o+" states."),a._logger.log("debug","Final tree has length of: "+t.length),e&&e(null,t);}});}});}});}});}},{key:"_insertTree",value:function _insertTree(e,t){if(e&&t){var a=t.name;"system.adapter."==a.substr(0,15)&&(a=a.substr(15),t.name=a);for(var s=0;s<e.length;s++){var n=e[s];if(n.name&&a.substr(0,n.name.length+1)==n.name+".")return t.name=a.substr(n.name.length+1),void this._insertTree(n.children,t);}e.push(t);}}},{key:"getAllAdapters",value:function getAllAdapters(e){this._objects("adapter",null,function(e,t){console.log(e,t);});}},{key:"_objects",value:function _objects(e,t,a){var s=null;(e||t)&&(s={}),e&&(s.type=e),t&&(s.pattern=t),this._doRequest("GET","/objects",s,null,function(e,t){a&&a(e,t);});}},{key:"_getBulk",value:function _getBulk(e,t){this._doRequest("GET","/getBulk/"+encodeURIComponent(e.join(",")),null,null,function(e,a){t&&t(e,a);});}},{key:"_get",value:function _get(e,t){var a=null;a=Array.isArray(e)?encodeURIComponent(e.join(",")):encodeURIComponent(e),this._doRequest("GET","/get/"+a,null,null,function(e,a){t&&t(e,a);});}},{key:"_set",value:function _set(e,t,a){this._doRequest("GET","/set/"+encodeURIComponent(e),t,null,function(e,t){a&&a(e,t);});}},{key:"_toggle",value:function _toggle(e,t){this._doRequest("GET","/toggle/"+encodeURIComponent(e),null,null,function(e,a){t&&t(e,a);});}},{key:"_states",value:function _states(e,t){var a=null;e&&(a={pattern:e}),this._doRequest("GET","/states",a,null,function(e,a){t&&t(e,a);});}},{key:"_doRequest",value:function _doRequest(e,t,a,s,n){var o=t;o||(o="/");var r={};a&&(r=JSON.parse(JSON.stringify(a))),this._logger.log("trace","do request: "+e+" "+t+"? "+JSON.stringify(r)),this.username&&(r.user=this.username,r.pass=this.password);var i="";for(var l in r){r.hasOwnProperty(l)&&(i&&(i+="&"),i+=l+"="+encodeURIComponent(r[l]));}i&&(o+="?"+i);var u={host:this.ip,port:this.port,path:o,method:e,headers:{Connection:"close","Content-Type":"application/json; charset=utf-8"}};s&&(u.headers["Content-Length"]=s.length);var c=require("http");this.https&&(c=require("https"),"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),u.rejectUnauthorized=!1);var m=this,d=n,p=c.request(u,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var a,s,n=e.statusCode&&e.statusCode>399?"error":"trace";if(m._logger.log(n,"receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),200==e.statusCode)try{s=t?JSON.parse(t):{};}catch(e){a=e;}else a=new Error("http response code :"+e.statusCode);d&&(d(a,s,e.statusCode),d=null);});});p.on&&p.on("error",function(e){m._logger.log("error","do request error:"+e.message),d&&(d(e),d=null);}),p.setTimeout&&p.setTimeout(1e4,function(){m._logger.log("error","do request timeout"),p.abort(),d&&(d(new Error("timeout")),d=null);}),s&&(this._logger.log("trace","do request send body:"+s),p.write(s)),p.end();}},{key:"toJSON",value:function toJSON(){return{sys:"iobroker",ip:this.ip,port:this.port,username:this.username,password:this.password,https:this.https};}},{key:"equalsTo",value:function equalsTo(e){return!!e&&e instanceof SimpleAPI&&this.ip==e.ip&&this.username==e.username&&this.password==e.password;}}],[{key:"parseJSON",value:function parseJSON(e){return e.ip?new SimpleAPI(e.ip,e.port,e.username,e.password,e.https):null;}}]);return SimpleAPI;}(),xnm.aio.iobroker.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="ioBrokerDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOWN:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"ioBroker",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"ioBroker"}];},createGateway:function createGateway(e,t,a){var s=DMError,n=DMError.ERROR_CODE;if(!e)return void a(new s(n.INVALID,"info is invalid"));if(!e.ip)return void a(new s(n.INVALID,"ip is invalid"));new xnm.aio.iobroker.Handler().isReachable(e).then(function(t){t?a(null,e):a(new s(n.NOT_FOUND,"is  unreachable"));})["catch"](function(e){a(new s(n.UNKNOWN,e.message));});},updateGateway:function updateGateway(e,t,a,s){var n=DMError,o=DMError.ERROR_CODE;if(!t)return void s(new n(o.INVALID,"update is invalid"));if(!t.ip)return void s(new n(o.INVALID,"ip is invalid"));new xnm.aio.iobroker.Handler().isReachable(t).then(function(e){e?s(null,t):s(new n(o.NOT_FOUND,"is unreachable"));})["catch"](function(e){s(new n(o.UNKNOWN,e.message));});},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var s=DMError,n=DMError.ERROR_CODE;if(e){if(e.id){if(e.type){if(e.common){if(e.gateway){var o,r,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){r=i[o];break;}}r?a&&a(null,e):a(new s(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(n.INVALID,"gateway is invalid"));}else a(new s(n.INVALID,"common is invalid"));}else a(new s(n.INVALID,"type is invalid"));}else a(new s(n.INVALID,"id is invalid"));}else a(new s(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var s=DMError,n=DMError.ERROR_CODE;if(e){if(e.id){if(e.type){if(e.common){if(e.gateway){var o,r,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){r=i[o];break;}}r?a(null,e):a(new s(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(n.INVALID,"gateway is invalid"));}else a(new s(n.INVALID,"common is invalid"));}else a(new s(n.INVALID,"type is invalid"));}else a(new s(n.INVALID,"id is invalid"));}else a(new s(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t,a){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,s=0;s<e.length;s++){if(e[s]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var s=[],n=null,o=xnm.aio.iobroker.DM.getCommandStatusMap(e,a);return o&&(n=function(e,t,a){var s=[];return"command"==a.catagory?e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}}):"status"==a.catagory&&e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}}),s;}(o,0,t),s=s.concat(n)),s;};if(!e.sys)return null;var s=JSON.parse(JSON.stringify(e)),n=null;if("command"==t.catagory)n=_filter(e,t),s.command=n;else{if("status"!=t.catagory)return null;n=_filter(e,t),s.status=n;}return n&&0!=n.length?s:null;},getCommandStatusMap:function getCommandStatusMap(e,t){if(!e||"state"!=e.type||!e.common)return null;var a={command:[],status:[]},s=e.common.min,n=e.common.max,o=e.common.unit,r=null;if(e.common.write)switch(a.command.push({type:"string",name:"set generic value",ref:{value:"setGenValue",ext:"%s"}}),e.common.type){case"boolean":switch(e.common.role){case"button":a.command.push({type:"enum",name:"press",ref:{value:"press"}});break;case"button.long":a.command.push({type:"enum",name:"long press",ref:{value:"longPress"}});break;case"button.stop":a.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case"button.start":a.command.push({type:"enum",name:"start",ref:{value:"start"}});break;case"button.open.door":case"button.open.window":a.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case"switch.lock":case"switch.lock.door":case"switch.lock.window":a.command.push({type:"enum",name:"unlock",ref:{value:"unlock"}}),a.command.push({type:"enum",name:"lock",ref:{value:"lock"}}),a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;case"media.state ":a.command.push({type:"enum",name:"play",ref:{value:"play"}}),a.command.push({type:"enum",name:"stop",ref:{value:"stop"}}),a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});break;default:a.command.push({type:"enum",name:"on",ref:{value:"on"}}),a.command.push({type:"enum",name:"off",ref:{value:"off"}}),a.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}});}break;case"number":switch(e.common.role){case"level.temperature":void 0!==s&&null!=s||(s=5),void 0!==n&&null!=n||(n=40),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"5.0-40.0"}}).ref.extMeta=s+"-"+n,o&&(r.ref.unit=o),a.command.push(r);break;case"level.color.red":case"level.color.green":case"level.color.blue":case"level.color.white":void 0!==s&&null!=s||(s=0),void 0!==n&&null!=n||(n=255),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-255"}}).ref.extMeta=s+"-"+n,o&&(r.ref.unit=o),a.command.push(r);break;case"level.color.rgb":void 0!==s&&null!=s||(s=0),void 0!==n&&null!=n||(n=16777215),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-16777215"}}).ref.extMeta=s+"-"+n,o&&(r.ref.unit=o),a.command.push(r),r={type:"rgb",name:"set RGB",ref:{value:"setRGB",ext:"%s"}},a.command.push(r);break;default:void 0!==s&&null!=s||(s=0),void 0!==n&&null!=n||(n=100),(r={type:"float",name:"set value",ref:{value:"setValue",ext:"%f",extMeta:"0-100"}}).ref.extMeta=s+"-"+n,o&&(r.ref.unit=o),a.command.push(r);}break;case"string":a.command.push({type:"string",name:"set value",ref:{value:"setValue",ext:"%s"}});}if(e.common.read||void 0===e.common.read)switch(a.status.push({type:"string",name:"generic value",ref:{value:"genValue"}}),e.common.type){case"boolean":switch(e.common.role){case"state":case"sensor.light":case"sensor.motion":case"sensor.rain":case"switch":case"switch.boost":case"switch.light":case"switch.comfort":case"media.mode.shuffle":case"media.mode.repeat":case"media.mute":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["on","off"]}});break;case"sensor.window":case"sensor.door":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}});break;case"sensor.lock":case"switch.lock":case"switch.lock.door":case"switch.lock.window":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["unlock","lock"]}});break;case"media.state":a.status.push({type:"enum",name:"state",ref:{value:"state",options:["play","stop"]}});break;default:a.status.push({type:"enum",name:"state",ref:{value:"state",options:["true","false"]}});}break;case"number":switch(e.common.role){case"value.window":for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}0==r.ref.options.length&&(r.ref.options=["closed","tilted","open"]),a.status.push(r);break;case"value.time":a.status.push({type:"int",name:"state",ref:{value:"state"}});break;case"media.state":for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}0==r.ref.options.length&&(r.ref.options=["play","stop","pause"]),a.status.push(r);break;default:if(e.common.states){for(var i in r={type:"enum",name:"state",ref:{value:"state",options:[]}},e.common.states){var l;if(e.common.states.hasOwnProperty(i))void 0!==(l=e.common.states[i])&&null!=l&&r.ref.options.push(l);}a.status.push(r);}else r={type:"float",name:"state",ref:{value:"state"}},(void 0!==s&&null!=s&&void 0===n||null!=n)&&(r.ref.extMeta=s+"-"+n),o&&(r.ref.unit=o),a.status.push(r);}break;case"string":a.status.push({type:"string",name:"state",ref:{value:"state"}});}return a;}};}(),xnm.aio.iobroker.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.iobroker.DM,Handler.prototype.SimpleAPI=xnm.aio.iobroker.SimpleAPI,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"iobroker");},Handler.prototype.resolveGateway=function(e){return e?this.SimpleAPI.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),s=a?a.command:[];t&&t(null,s);},Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),s=a?a.status:[];t&&t(null,s);},Handler.prototype.doCommand=function(e,t,a,s){var n=this.resolveGateway(e);n?n.executeCommandCreator(t,a,function(e){s&&s(e);}):s&&s(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,s,n){var o=this.resolveGateway(t);if(o){var r=[{id:e,device:a,status:s}];o.getStatesCreator(null,r,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getStateObjectTree(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.isReachable=function(e){return this.resolveGateway(e).isReachable().then(function(e){return e;});},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.iobroker.Handler());