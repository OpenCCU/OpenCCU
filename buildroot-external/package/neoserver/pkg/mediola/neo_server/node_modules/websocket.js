var WebSocket=function WebSocket(e){this._secure=!1,this._socket=null,this._handshakeDone=!1;var t=require("url").parse(e);this._host=t.hostname,this._port=t.port,this._path=t.path,this._path||(this._path="/"),"wss:"==t.protocol?(this._secure=!0,this._port||(this._port=443)):this._port||(this._port=80),this.onmessage=null,this.onerror=null,this.onopen=null,this.onclose=null;};WebSocket.prototype.open=function(){if(this._secure){var e=require("tls");process.env.NODE_TLS_REJECT_UNAUTHORIZED="0";var t=this;this._socket=e.connect(this._port,this._host,function(){t._socket.setEncoding("utf-8");var e="GET "+t._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";e+="Host: "+t._host+"\r\n",e+="Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\n",e+="Sec-WebSocket-Version: 13\r\n\r\n",t._socket.write(e);}),this._socket.addListener("data",function(e){if(t._handshakeDone){var n=t._decodeWSData(e).trim();t.onmessage&&n.length>0&&t.onmessage(n);}else 0==e.indexOf("HTTP")&&(t._handshakeDone=!0,t.onopen&&t.onopen());}),this._socket.addListener("error",function(e){t.onerror&&t.onerror(e.code);}),this._socket.addListener("close",function(){t.onclose&&t.onclose(),t.onmessage=null,t.onerror=null,t.onopen=null,t.onclose=null;});}else this._open();},WebSocket.prototype._open=function(){var e=require("net"),t=this;this._socket=e.connect(this._port,this._host,function(){t._socket.setEncoding("utf-8");var e="GET "+t._path+" HTTP/1.1\r\nUpgrade: websocket\r\nConnection: keep-alive, Upgrade\r\nOrigin: null\r\n";e+="Host: "+t._host+"\r\n",e+="Sec-WebSocket-Key: 2P9Q2RaEAdXHSNO2zy4oqQ==\r\n",e+="Sec-WebSocket-Version: 13\r\n\r\n",t._socket.write(e);}),this._socket.addListener("data",function(e){if(t._handshakeDone){var n=t._decodeWSData(e).trim();t.onmessage&&n.length>0&&t.onmessage(n);}else 0==e.indexOf("HTTP")&&(t._handshakeDone=!0,t.onopen&&t.onopen());}),this._socket.addListener("error",function(e){t.onerror&&t.onerror(e.code);}),this._socket.addListener("close",function(){t.onclose&&t.onclose(),t.onmessage=null,t.onerror=null,t.onopen=null,t.onclose=null;});},WebSocket.prototype.send=function(e){this._socket.write(this._encodeWSData(e));},WebSocket.prototype.sendJSON=function(e){this.send(JSON.stringify(e));},WebSocket.prototype.close=function(){this._socket.end(),this.onclose&&this.onclose(),this.onmessage=null,this.onerror=null,this.onopen=null,this.onclose=null;},WebSocket.prototype._encodeWSData=function(e){e=new Buffer(e,"binary");var t=new Array(),n=0;if(t[n++]=129,e.length<=125)t[n++]=e.length+128;else{if(!(e.length<=65535))return null;t[n++]=254,t[n++]=e.length>>8&255,t[n++]=255&e.length;}for(var o=[],s=0;s<4;s++){o.push(Math.floor(255*Math.random())),t[n++]=o[s];}for(s=0;s<e.length;s++){t[n++]=e[s]^o[s%4];}return new Buffer(t,"binary");},WebSocket.prototype._decodeWSData=function(e){var t=127&e.charCodeAt(1),n=2;return 126==t?n=4:127==t&&(n=10),e.substr(n);};var WebSocketJS=function(){var Socket=function Socket(e){this._logger=require("x.logger.js").getLogger("WebSocketJS"),this._url=e,this._ws=null,this._state="IDLE",this._eventListeners={};};return Socket.prototype.on=function(e,t){e&&t&&(this._eventListeners[e]||(this._eventListeners[e]=[]),-1==this._eventListeners[e].indexOf(t)&&this._eventListeners[e].push(t));},Socket.prototype.off=function(e,t){if(e&&t&&this._eventListeners[e]){var n=this._eventListeners[e].indexOf(t);-1!=n&&this._eventListeners[e].splice(n,1);}},Socket.prototype.open=function(){if("IDLE"==this._state){this._state="OPEN";var e=require("ws"),t=this,n=new e(url);n.on("open",function(){t._onOpen();}),n.on("close",function(){t._onClose();}),n.on("error",function(e){t._onError(e);}),n.on("message",function(e){t._onMessage(e);}),n.on("pong",function(){}),this._ws=n;}},Socket.prototype.close=function(){"CLOSE"!=this._state&&this._ws.close();},Socket.prototype._emitEvent=function(e,t){if(e){var n=this._eventListeners[e];if(n&&n.length>0)for(var o=0;o<n.length;o++){var s=n[o];try{s(t);}catch(t){this._logger.log("trace","call "+e+" listener failed, error:"+t.message);}}}},Socket.prototype._onOpen=function(){this._logger.log("trace","ws open"),"RUN"!=this._state&&(this._state="RUN",this._emitEvent("open"));},Socket.prototype._onClose=function(){this._logger.log("trace","ws closed"),"CLOSE"!=this._state&&(this._state="CLOSE",this._emitEvent("close"),this._eventListeners={},this._ws=null);},Socket.prototype._onError=function(e){this._logger.log("trace","ws error:"+e.message),"CLOSE"!=this._state&&(this._state="CLOSE",this._emitEvent("error",e),this._eventListeners={},this._ws.close(),this._ws=null);},Socket.prototype._onMessage=function(){},Socket;}();exports.createWebSocket=function(e){return new WebSocket(e);};