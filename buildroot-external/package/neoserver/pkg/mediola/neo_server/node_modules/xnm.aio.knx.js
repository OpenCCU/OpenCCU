function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var dgram=require("dgram"),os=require("os"),EventEmitter=require("x.events.js").EventEmitter,Logger=require("x.logger.js"),xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.knx=xnm.aio.knx||{},xnm.aio.knx.KNXGateway=function(){var e,_ipv4ToLong=function _ipv4ToLong(e){var t=e.split("."),n=(parseInt(t[0])<<24)+(parseInt(t[1])<<16)+(parseInt(t[2])<<8)+parseInt(t[3]);return n&=4294967295;},_longToIpv4=function _longToIpv4(e){return(e>>24&255)+"."+(e>>16&255)+"."+(e>>8&255)+"."+(255&e);},t=((e=function e(_e){this._loggger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway.RawStateBuffer"),this._stateBuffer={},this._stateReqTime={},this._knx=_e;}).prototype.setState=function(e,t){void 0!==e&&null!=e&&(this._stateBuffer[e]||(this._stateBuffer[e]={}),this._stateBuffer[e].value=t,this._stateBuffer[e].timestamp=new Date());},e.prototype.getState=function(e){if(void 0!==e&&null!=e){var t=this._stateBuffer[e];return t?t.value:null;}return null;},e.prototype.setStateReqTime=function(e,t){this._stateReqTime[e]=t;},e.prototype.getStateReqTime=function(e){return this._stateReqTime[e];},e),KNXGateway=function KNXGateway(e,n,r){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway ("+e+")"),this.ip=e,this.localIp=n,this.uuid=r,this._stateBuffer=new t(),this._stateMachine={state:KNXGateway._FSM.IDLE},this._eventEmitter=new EventEmitter(),this._dataLink=null,this._dataLinkRetryCount=0,this._dataLinkTimer=null;};KNXGateway.STATES_REQ_EXPIRED=18e4,KNXGateway.MAX_DL_RETRY_COUNT=3,KNXGateway._FSM={IDLE:1,MONITORING:2,START_MONITOR:3,STOP_MONITOR:4},KNXGateway._ipv4ToLong=_ipv4ToLong,KNXGateway._longToIpv4=_longToIpv4,KNXGateway._adr2long=function(e){var t=e.split("/"),n=0;switch(t.length){case 3:n+=parseInt(t[0])<<11,n+=parseInt(t[1])<<8,n+=parseInt(t[2]);break;case 2:n+=parseInt(t[0])<<11,n+=parseInt(t[1]);break;case 1:n+=parseInt(t[0]);}return n;},KNXGateway.prototype={getStateBuffer:function getStateBuffer(){return this._stateBuffer;},on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},removeListener:function removeListener(e,t){this._eventEmitter.removeListener(e,t);},startMonitor:function startMonitor(e){e&&this.on("open",e),this._fsmStartMonitor();},stopMonitor:function stopMonitor(e){e&&this.on("close",e),this._fsmStopMonitor();},_fsmStartMonitor:function _fsmStartMonitor(){switch(this._stateMachine.state){case KNXGateway._FSM.IDLE:this._stateMachine.state=KNXGateway._FSM.START_MONITOR,this._startDataLink();break;case KNXGateway._FSM.START_MONITOR:break;case KNXGateway._FSM.MONITORING:this._eventEmitter.emit("open");break;case KNXGateway._FSM.STOP_MONITOR:return void this._logger.log("warn","can not start the monitor again while stopping it");}},_fsmStopMonitor:function _fsmStopMonitor(){switch(this._stateMachine.state){case KNXGateway._FSM.IDLE:this._onClose();break;case KNXGateway._FSM.START_MONITOR:case KNXGateway._FSM.MONITORING:this._stateMachine.state=KNXGateway._FSM.STOP_MONITOR,this._stopDataLink();break;case KNXGateway._FSM.STOP_MONITOR:return;}},_fsmDatalinkOpen:function _fsmDatalinkOpen(){if(this._stateMachine.state===KNXGateway._FSM.START_MONITOR)this._stateMachine.state=KNXGateway._FSM.MONITORING,this._onOpen(),this._dataLinkRetryCount=0;},_fsmDatalinkClosed:function _fsmDatalinkClosed(e,t){switch(e?this._logger.log("trace","data link stopped due to error"):this._logger.log("trace","data link stopped"),this._stateMachine.state){case KNXGateway._FSM.START_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,++this._dataLinkRetryCount<KNXGateway.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=KNXGateway._FSM.START_MONITOR,this._startDataLink(t)):(this._stateMachine.state=KNXGateway._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!0));break;case KNXGateway._FSM.MONITORING:this._dataLink.removeAllListeners(),this._dataLink=null,++this._dataLinkRetryCount<KNXGateway.MAX_DL_RETRY_COUNT?(this._logger.log("trace","auto restart monitor tunnel"),this._stateMachine.state=KNXGateway._FSM.START_MONITOR,this._startDataLink(t)):(this._onError(new Error("can not connect monitor tunnel to knx gateway")),this._stateMachine.state=KNXGateway._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!0));break;case KNXGateway._FSM.STOP_MONITOR:this._dataLink.removeAllListeners(),this._dataLink=null,this._stateMachine.state=KNXGateway._FSM.IDLE,t&&t.forEach(function(e){e&&e.callback&&e.callback(new Error("monitor closed due to error"));}),this._onClose(!1);}},_fsmDataLinkMessage:function _fsmDataLinkMessage(e,t){if(this._stateMachine.state===KNXGateway._FSM.MONITORING){t.getAPCI();return this._stateBuffer.setState(e,t.getData()),void this._eventEmitter.emit("message",this.uuid,e,t);}},_fsmDatalinkError:function _fsmDatalinkError(e){this._stateMachine.state,KNXGateway._FSM.START_MONITOR,this._onError(e);},_onOpen:function _onOpen(){0==this._dataLinkRetryCount&&this._eventEmitter.emit("open");},_onError:function _onError(e){this._eventEmitter.emit("error",e);},_onClose:function _onClose(e){this._eventEmitter.emit("close",e);},_sendCommand:function _sendCommand(e,t,n){this._dataLink?this._sendCommandWithDL(this._dataLink,e,t,n):n&&n(new Error("knx gateway not connected"));},_getState:function _getState(e,t){this._dataLink?this._getStateWithDL(this._dataLink,e,t):t&&t(new Error("knx gateway not connected"));},_sendCommandWithDL:function _sendCommandWithDL(e,t,n,r){var a=KNXGateway._adr2long(t),o=new KNXGateway.APDU(null,2,n),i=this;e.send(a,o,function(e){e||i._stateBuffer.setState(a,o.getData()),r&&"function"==typeof r&&r(e);});},_getStateWithDL:function _getStateWithDL(e,t,n){var r=KNXGateway._adr2long(t),a=new KNXGateway.APDU(null,0,new Buffer([0]));e.send(r,a,n);},_startDataLink:function _startDataLink(e){var t=this;this._dataLink=new KNXGateway._DataLink(this.ip,this.localIp),this._dataLink.on("connect",function(){t._fsmDatalinkOpen();}),this._dataLink.on("close",function(e,n){t._fsmDatalinkClosed(e,n);}),this._dataLink.on("error",function(e){t._logger.log("warn","monitor tunnel error:"+e.message),t._fsmDatalinkError(e);}),this._dataLink.on("message",function(e,n){t._fsmDataLinkMessage(e,n);}),this._dataLink.connect(e);},_stopDataLink:function _stopDataLink(){this._dataLink&&this._dataLink.close();}};var n,_r,a=(n=function n(e,t){this._logger=Logger.getLogger("xnm.aio.knx.KNXGateway._DataLink ("+e+")");var n=this;this._tunnel=new o(e,null,t,null),this._tunnel.on("connect",function(){n._onTunnelConnect();}),this._tunnel.on("end",function(){n._onTunnelEnd();}),this._tunnel.on("close",function(e,t){n._onTunnelClose(e,t);}),this._tunnel.on("message",function(e){n._onTunnelMessage(e);}),this._tunnel.on("error",function(e){n._onTunnelError(e);}),this._eventEmitter=new EventEmitter();},n.prototype={on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},removeListener:function removeListener(e,t){this._eventEmitter.removeListener(e,t);},connect:function connect(e){this._tunnel.connect(e);},close:function close(){this._tunnel.close();},send:function send(e,t,n){this._logger.log("debug","send l_data.req "+t.toBuffer().toString("hex")+"@"+e);var r=new s.L_Data_Req(e,t);this._tunnel.send(r,function(e){n&&n(e);});},_onTunnelConnect:function _onTunnelConnect(){this._eventEmitter.emit("connect");},_onTunnelClose:function _onTunnelClose(e,t){this._eventEmitter.emit("close",e,t);},_onTunnelEnd:function _onTunnelEnd(){this._eventEmitter.emit("end");},_onTunnelMessage:function _onTunnelMessage(e){var t="unknown";e&&e instanceof s.L_Data_Con?t="l_data.con":e&&e instanceof s.L_Data_Ind&&(t="l_data.ind");var n=e.getDstAddr(),r=e.getAPDU();this._logger.log("debug","recive "+t+" "+r.toBuffer().toString("hex")+"@"+n),this._eventEmitter.emit("message",n,r);},_onTunnelError:function _onTunnelError(e){this._eventEmitter.emit("error",e);}},n),o=((_r=function r(e,t,n,a){this._eventEmitter=new EventEmitter(),this._ip=e,this._port=t,(!this._port||this._port<=0)&&(this._port=_r.DEFAULT_REMOTE_PORT),this._logger=require("x.logger.js").getLogger("xnm.aio.knx.KNXGateway._Tunnel ("+this._ip+":"+this._port+")"),this._localIp=n,this._localPort=a,this._localPort<=0&&(this._localPort=null),this._socket=null,this._requestBuffer=[],this._stateMachine={state:_r._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,connection:{id:0,seqNo:0,recvSeqNo:0,hpai:{ip:null,port:0}},close_with_error:null},this._connectStateNackCount=0;}).TUNNEL_ACK_TIMEOUT=1e3,_r.CONNECT_REQUEST_TIMEOUT=1e4,_r.CONNECTIONSTATE_REQUEST_INTERVAL=6e4,_r.CONNECTIONSTATE_REQUEST_TIMEOUT=1e4,_r.MAX_CONNECTIONSTATE_NACK_COUNT=3,_r.DEFAULT_REMOTE_PORT=3671,_r._STATE={IDLE:0,BINDUDP:1,CONNECT:2,TUNNELLING:3,DISCONNECT:4,CLOSEUDP:5},_r.prototype={on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},connect:function connect(e){e&&(this._requestBuffer=e),this._fsmConnect();},close:function close(){this._fsmClose(!1);},send:function send(e,t){if(e){var n={cEMI:e,callback:t,retry:!1,timer:null,seqNo:-1},a=this._requestBuffer.length;this._requestBuffer.push(n),0==a&&this._stateMachine.state==_r._STATE.TUNNELLING&&this._sendNextReq();}else t&&t(new Error("cEMI is null"));},_sendNextReq:function _sendNextReq(){if(0!=this._requestBuffer.length){var e=this._requestBuffer[0],t=this._stateMachine.connection.seqNo;-1!=e.seqNo?t=e.seqNo:e.seqNo=t;var n=this;this._send(t,e.cEMI,function(t){if(t)return e.callback&&e.callback(t),n._requestBuffer.splice(0,1),void n._sendNextReq();e.timer=setTimeout(function(){e.retry?(n._logger.log("warn","TUNNELLING_ACK ("+e.seqNo+") timeout after "+_r.TUNNEL_ACK_TIMEOUT+" seconds"),n._fsmClose(!0)):(n._logger.log("warn","TUNNELLING_ACK ("+e.seqNo+") timeout after "+_r.TUNNEL_ACK_TIMEOUT+" seconds, retry"),e.retry=!0,n._sendNextReq());},_r.TUNNEL_ACK_TIMEOUT);});}},_send:function _send(e,t,n){var a=this;if(this._stateMachine.state===_r._STATE.TUNNELLING){this._logger.log("debug","send cEMI "+t.toBuffer().toString("hex"));var o=new i.TunnellingRequest(this._stateMachine.connection.id,e,t).toBuffer();this._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+o.toString("hex")),this._socket.send(o,0,o.length,this._port,this._ip,function(t){t?a._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+o.toString("hex")+" error:"+t.message):a._logger.log("debug","send TUNNELLING_REQUEST ("+e+") "+o.toString("hex")+" finish"),n&&n(null);});}else n&&n(new Error("Tunnel is not connected"));},_fsmConnect:function _fsmConnect(){this._logger.log("debug","connect to knx"),this._stateMachine.state===_r._STATE.IDLE&&(this._stateMachine.state=_r._STATE.BINDUDP,this._startListenerSocket());},_fsmClose:function _fsmClose(e){switch(this._stateMachine.close_with_error=e,this._stateMachine.state){case _r._STATE.IDLE:this._fsmClosed();break;case _r._STATE.BINDUDP:this._stateMachine.state=_r._STATE.CLOSEUDP,this._stopListenerSocket();break;case _r._STATE.CONNECT:this._clearStateMachineGuard(),this._stateMachine.state=_r._STATE.CLOSEUDP,this._stopListenerSocket();break;case _r._STATE.TUNNELLING:var t=new i.DisconnectRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai).toBuffer();this._logger.log("debug","send DISCONNECT_REQUEST "+t.toString("hex")),this._socket.send(t,0,t.length,this._port,this._ip),this._stateMachine.state=_r._STATE.DISCONNECT,this._clearStateMachineGuard(),this._setStateMachineGuard(1e3,_r._STATE.CLOSEUDP);case _r._STATE.DISCONNECT:case _r._STATE.CLOSEUDP:}},_fsmError:function _fsmError(e){this._eventEmitter.emit("error",e),this._fsmClose(!0);},_fsmUdpListening:function _fsmUdpListening(){if(this._logger.log("debug","udp socket established"),this._stateMachine.state===_r._STATE.BINDUDP){this._stateMachine.state=_r._STATE.CONNECT,this._clearStateMachineGuard();var e=this._socket.address(),t={ip:e.address,port:e.port},n=new i.ConnectionRequest(t,t).toBuffer();this._logger.log("debug","send CONNECTION_REQUEST "+n.toString("hex")),this._socket.send(n,0,n.length,this._port,this._ip),this._setStateMachineGuard(_r.CONNECT_REQUEST_TIMEOUT,_r._STATE.TUNNELLING);}},_fsmUdpMessage:function _fsmUdpMessage(e){var t,n,a,o,c=this,u=this._socket.address(),l=i.parseFrame(e);if(l)switch(this._stateMachine.state){case _r._STATE.CONNECT:if(518===l.getType())if(l.isConnectionStatusOK())this._clearStateMachineGuard(),t=l.getConnectionID(),this._logger.log("debug","receive CONNECTION_RESPONSE with connection id "+t),this._stateMachine.connection={},this._stateMachine.connection.id=t,n={ip:u.address,port:u.port},this._stateMachine.connection.hpai=n,this._stateMachine.connection.seqNo=0,this._stateMachine.connection.recvSeqNo=0,this._stateMachine.state=_r._STATE.TUNNELLING,this._sendConnectionStateRequest(),this._sendNextReq(),this._onConnected();else{var d=l.getConnectionStatus(),f=new Error("tunnel connection fail with error:"+d.toString(16));f.code=d,this._fsmError(f);}break;case _r._STATE.TUNNELLING:switch(l.getType()){case 1056:if((t=l.getConnectionID())===this._stateMachine.connection.id){var h=l.getcEMI(),_=l.getSeqNo(),p=!1;_==this._stateMachine.connection.recvSeqNo&&(p=!0),_!=this._stateMachine.connection.recvSeqNo&&_!=this._stateMachine.connection.recvSeqNo-1||(a=(l=new i.TunnellingACK(t,_)).toBuffer(),this._logger.log("trace","send TUNNELLING_ACK ("+_+") "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(e){try{p&&(h&&h instanceof s.L_Data_Con?(c._logger.log("debug","receive TUNNELLING_REQUEST ("+_+") l_data.con "+h.toBuffer().toString("hex")),c._onMessage(h)):h&&h instanceof s.L_Data_Ind&&(c._logger.log("debug","receive TUNNELLING_REQUEST ("+_+") l_data.ind "+h.toBuffer().toString("hex")),c._onMessage(h)));}catch(e){}})),_!=this._stateMachine.connection.recvSeqNo&&_!=this._stateMachine.connection.recvSeqNo-1||_==this._stateMachine.connection.recvSeqNo&&(this._stateMachine.connection.recvSeqNo++,this._stateMachine.connection.recvSeqNo>255&&(this._stateMachine.connection.recvSeqNo=0));}break;case 1057:(t=l.getConnectionID())===this._stateMachine.connection.id&&this._onTunnelAck(l);break;case 521:t=l.getConnectionID(),n=l.getCtrlEndpointHPAI(),t===this._stateMachine.connection.id&&(this._logger.log("debug","receive DISCONNECT_REQUEST"),a=(l=new i.DisconnectResponse(t)).toBuffer(),this._logger.log("debug","send DISCONNECT_RESPONSE "+a.toString("hex")),this._socket.send(a,0,a.length,this._port,this._ip,function(){c._fsmEnd();}));break;case 520:t=l.getConnectionID(),this._logger.log("debug","receive CONNECTIONSTATE_RESPONSE with connection id "+t),this._connectStateNackCount=0,this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null,this._stateMachine.connectionStateTimer||(this._stateMachine.connectionStateTimer=setTimeout(function(){c._stateMachine.connectionStateTimer=null,c._sendConnectionStateRequest();},_r.CONNECTIONSTATE_REQUEST_INTERVAL)));}break;case _r._STATE.DISCONNECT:522===l.getType()&&(t=l.getConnectionID())===this._stateMachine.connection.id&&(o=l.isDisconnectOK(),this._logger.log("debug","receive DISCONNECT_RESPONSE with status "+(o?"OK":"NOK")),this._clearStateMachineGuard(),this._stateMachine.state=_r._STATE.CLOSEUDP,c._stopListenerSocket());}},_fsmEnd:function _fsmEnd(){this._stateMachine.state=_r._STATE.CLOSEUDP,this._eventEmitter.emit("end"),this._stateMachine.close_with_error=!1,this._stopListenerSocket();},_fsmClosed:function _fsmClosed(){this._stateMachine.state=_r._STATE.IDLE;var e=this._stateMachine.close_with_error;this._socket&&this._socket.removeAllListeners(),this._socket=null;var t=null;if(e){t=this._requestBuffer;for(var n=0;n<t.length;n++){var a=t[n];a&&(a.timer&&clearTimeout(a.timer),a.seqNo=-1);}this._requestBuffer=[];}else this._clearRequestBuffer();this._resetStateMachine(),this._eventEmitter.emit("close",e,t);},_onConnected:function _onConnected(){this._eventEmitter.emit("connect");},_onMessage:function _onMessage(e){this._eventEmitter.emit("message",e);},_onTunnelAck:function _onTunnelAck(e){var t=e.getSeqNo(),n=e.isOK();if(this._logger.log("debug","receive TUNNELLING_ACK ("+t+") with status "+(n?"OK":"NOK")),t==this._stateMachine.connection.seqNo){var r=this._requestBuffer[0];r.timer&&clearTimeout(r.timer),r.callback&&r.callback(n?null:new Error("NACK")),this._stateMachine.connection.seqNo+=1,this._stateMachine.connection.seqNo>255&&(this._stateMachine.connection.seqNo=0),this._requestBuffer.splice(0,1),this._sendNextReq();}},_clearRequestBuffer:function _clearRequestBuffer(){for(var e=0;e<this._requestBuffer.length;e++){var t=this._requestBuffer[e];t&&(t.timer&&clearTimeout(t.timer),t.callback&&t.callback(new Error("NACK due to tunnel closed")));}this._requestBuffer=[];},_setStateMachineGuard:function _setStateMachineGuard(e,t){var n=this;this._stateMachine.stateTimer=setTimeout(function(){var e=n._stateMachine.state;if(e===_r._STATE.DISCONNECT&&t===_r._STATE.CLOSEUDP)n._stateMachine.state=_r._STATE.CLOSEUDP,n._stopListenerSocket();else if(e!==t){var a="";a=3==t?"receive CONNECTION_RESPONSE timeout":"knx tunnel receive data timeout in "+e,n._logger.log("warn",a),n._fsmError(new Error(a));}},e);},_clearStateMachineGuard:function _clearStateMachineGuard(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer);},_sendConnectionStateRequest:function _sendConnectionStateRequest(){var e=this,t=new i.ConnectionStateRequest(this._stateMachine.connection.id,this._stateMachine.connection.hpai).toBuffer();this._logger.log("debug","send CONNECTIONSTATE_REQUEST "+t.toString("hex")+" with connection id "+this._stateMachine.connection.id),this._socket.send(t,0,t.length,this._port,this._ip),this._stateMachine.connectionStateAckTimer&&(clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine.connectionStateAckTimer=null),this._stateMachine.connectionStateAckTimer=setTimeout(function(){e._connectStateNackCount++,e._connectStateNackCount<_r.MAX_CONNECTIONSTATE_NACK_COUNT&&e._stateMachine.state===_r._STATE.TUNNELLING?(e._logger.log("warn","receive CONNECTIONSTATE_RESPONSE timeout"),e._sendConnectionStateRequest()):(e._logger.log("warn","tunnel break due to CONNECTIONSTATE_RESPONSE timeout"),e._fsmError(new Error("tunnel break")));},_r.CONNECTIONSTATE_REQUEST_TIMEOUT);},_resetStateMachine:function _resetStateMachine(){this._stateMachine.stateTimer&&clearTimeout(this._stateMachine.stateTimer),this._stateMachine.connectionStateTimer&&clearTimeout(this._stateMachine.connectionStateTimer),this._stateMachine.connectionStateAckTimer&&clearTimeout(this._stateMachine.connectionStateAckTimer),this._stateMachine={state:_r._STATE.IDLE,stateTimer:null,connectionStateTimer:null,connectionStateAckTimer:null,socket:null,connection:{id:0,seqNo:0,hpai:{ip:null,port:0}},close_with_error:null};},_startListenerSocket:function _startListenerSocket(){this._logger.log("trace","{UDP Socket} start knx upd listener on "+this._localIp);var e=this;this._socket=dgram.createSocket("udp4"),this._socket.on("listening",function(){try{e._socket.addMembership("224.0.23.12");var t=e._socket.address();e._logger.log("trace","{UDP Socket} knx listening "+t.address+":"+t.port),e._fsmUdpListening();}catch(t){e._logger.log("trace","{UDP Socket} knx listening bind multicast failed:"+t.message),e._socket.close(),e._fsmClosed();}}),this._socket.on("close",function(){e._logger.log("trace","{UDP Socket} control socket closed"),e._fsmClosed();}),this._socket.on("error",function(t){e._logger.log("trace","{UDP Socket} control socket error: "+t.stack),e._fsmError(t);}),this._socket.on("message",function(t,n){var r=e._socket.address();e._logger.log("trace","{UDP Socket} receive data "+t.toString("hex")+" from "+n.address+":"+n.port+" @local "+r.address+":"+r.port),e._fsmUdpMessage(t);}),this._socket.bind(null,this._localIp);},_stopListenerSocket:function _stopListenerSocket(){this._logger.log("trace","{UDP Socket} stop knx upd listener"),this._socket.close();}},_r),i=function(){var IPFrame=function IPFrame(e,t){e&&t&&(this._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),this._buffer=new Buffer(6+t.length),this._buffer.writeUInt16BE(1552,0),this._buffer.writeUInt16BE(e,2),this._buffer.writeUInt16BE(6+t.length,4),t.copy(this._buffer,6));};IPFrame._logger=Logger.getLogger("xnm.aio.KNXGateway.IPFrame"),IPFrame.parseFrame=function(e){var t=null;if(e.length<6)return IPFrame._logger.log("debug","data is too short"),null;var n=e.readUInt16BE(0);if(1552!==n)return IPFrame._logger.log("debug","data header&version is invalid:"+n),null;var r=e.readUInt16BE(4);if(r>e.length)return IPFrame._logger.log("debug","data length in header is larger than actual size:"+r),null;var a=e.readUInt16BE(2);switch(a){case 514:r>=14&&(t=new SearchResponse());break;case 518:r>=8&&(t=new ConnectionResponse());break;case 520:r>=8&&(t=new ConnectionStateResponse());break;case 1057:r>=10&&(t=new TunnellingACK());break;case 1056:r>=6&&(t=new TunnellingRequest());break;case 521:r>=16&&(t=new DisconnectRequest());break;case 522:r>=8&&(t=new DisconnectResponse());break;default:IPFrame._logger.log("debug","data type is unknow:"+a);}return t&&(t._buffer=e),t;},IPFrame.prototype.getType=function(){return this._buffer.readUInt16BE(2);},IPFrame.prototype.getSize=function(){return this._buffer.readUInt16BE(4);},IPFrame.prototype.toBuffer=function(){return this._buffer;};var SearchRequest=function SearchRequest(e){var t=new Buffer(8);t.writeUInt16BE(2049,0),t.writeInt32BE(_ipv4ToLong(e.ip),2),t.writeUInt16BE(e.port,6),IPFrame.call(this,513,t);};(SearchRequest.prototype=new IPFrame()).constructor=SearchRequest;var SearchResponse=function SearchResponse(){IPFrame.call(this);};SearchResponse.prototype=new IPFrame(),SearchResponse.prototype.constructor=SearchResponse,SearchResponse.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(8),t=_longToIpv4(e),n=this._buffer.readUInt16BE(12),r={};return r.ip=t,r.port=n,r;},SearchResponse.prototype.getSerialNumber=function(){return(this._buffer.readUInt8(22)<<16)+(this._buffer.readUInt8(23)<<8)+this._buffer.readUInt8(24)+""+((this._buffer.readUInt8(25)<<16)+(this._buffer.readUInt8(26)<<8)+this._buffer.readUInt8(27));},SearchResponse.prototype.getRoutingMulticastAddress=function(){return this._buffer.readUInt8(28)+"."+this._buffer.readUInt8(29)+"."+this._buffer.readUInt8(30)+"."+this._buffer.readUInt8(31);},SearchResponse.prototype.getMAC=function(){return this._buffer.toString("hex",32,38);},SearchResponse.prototype.getName=function(){return this._buffer.toString("utf8",38,68);},SearchResponse.prototype.toJSON=function(){return{hapi:this.getCtrlEndpointHPAI(),structure_length:this._buffer.readUInt8(14),desciprtion_type_code:this._buffer.readUInt8(15),knx_medium:this._buffer.readUInt8(16),device_status:this._buffer.readUInt8(17),physical_address:this._buffer.readUInt16BE(18),project_installation_id:this._buffer.readUInt16BE(20),serial_number:this.getSerialNumber(),routing_multicast_address:this.getRoutingMulticastAddress(),mac:this.getMAC(),name:this.getName()};};var ConnectionRequest=function ConnectionRequest(e,t){var n=new Buffer(20);n.writeUInt16BE(2049,0),n.writeInt32BE(_ipv4ToLong(e.ip),2),n.writeUInt16BE(e.port,6),n.writeUInt16BE(2049,8),n.writeInt32BE(_ipv4ToLong(t.ip),10),n.writeUInt16BE(t.port,14),n.writeUInt8(4,16),n.writeUInt8(4,17),n.writeUInt8(2,18),n.writeUInt8(0,19),IPFrame.call(this,517,n);};(ConnectionRequest.prototype=new IPFrame()).constructor=ConnectionRequest;var ConnectionResponse=function ConnectionResponse(){IPFrame.call(this);};ConnectionResponse.prototype=new IPFrame(),ConnectionResponse.prototype.constructor=ConnectionResponse,ConnectionResponse.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},ConnectionResponse.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7);},ConnectionResponse.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(10),t=_longToIpv4(e),n=this._buffer.readUInt16BE(14),r={};return r.ip=t,r.port=n,r;},ConnectionResponse.prototype.getCRD=function(){return this._buffer.readUInt32BE(16);},ConnectionResponse.prototype.getConnectionStatus=function(){return this._buffer.readUInt8(7);};var ConnectionStateRequest=function ConnectionStateRequest(e,t){var n=new Buffer(10);n.writeUInt8(e,0),n.writeUInt8(0,1),n.writeUInt16BE(2049,2),n.writeInt32BE(_ipv4ToLong(t.ip),4),n.writeUInt16BE(t.port,8),IPFrame.call(this,519,n);};(ConnectionStateRequest.prototype=new IPFrame()).constructor=ConnectionStateRequest;var ConnectionStateResponse=function ConnectionStateResponse(){IPFrame.call(this);};ConnectionStateResponse.prototype=new IPFrame(),ConnectionStateResponse.prototype.constructor=ConnectionStateResponse,ConnectionStateResponse.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},ConnectionStateResponse.prototype.isConnectionStatusOK=function(){return 0===this._buffer.readUInt8(7);};var TunnellingRequest=function TunnellingRequest(e,t,n){if(null!=e&&null!=t&&n){var r=new Buffer(4+n.getLength());r.writeUInt8(4,0),r.writeUInt8(e,1),r.writeUInt8(t,2),r.writeUInt8(0,3),n.toBuffer().copy(r,4),IPFrame.call(this,1056,r);}else IPFrame.call(this);};TunnellingRequest.prototype=new IPFrame(),TunnellingRequest.prototype.constructor=TunnellingRequest,TunnellingRequest.prototype.getConnectionID=function(){return this._buffer.readUInt8(7);},TunnellingRequest.prototype.getSeqNo=function(){return this._buffer.readUInt8(8);},TunnellingRequest.prototype.getcEMI=function(){var e=this._buffer.readUInt16BE(4),t=new Buffer(e-6-4);return this._buffer.copy(t,0,10),s.parseFrame(t);};var TunnellingACK=function TunnellingACK(e,t){if(e){var n=new Buffer(4);n.writeUInt8(4,0),n.writeUInt8(e,1),n.writeUInt8(t,2),n.writeUInt8(0,3),IPFrame.call(this,1057,n);}else IPFrame.call(this);};TunnellingACK.prototype=new IPFrame(),TunnellingACK.prototype.constructor=TunnellingACK,TunnellingACK.prototype.getConnectionID=function(){return this._buffer.readUInt8(7);},TunnellingACK.prototype.getSeqNo=function(){return this._buffer.readUInt8(8);},TunnellingACK.prototype.isOK=function(){return 0===this._buffer.readUInt8(9);};var DisconnectRequest=function DisconnectRequest(e,t){if(e&&null!==t){var n=new Buffer(10);n.writeUInt8(e,0),n.writeUInt8(0,1),n.writeUInt8(8,2),n.writeUInt8(1,3),n.writeInt32BE(_ipv4ToLong(t.ip),4),n.writeUInt16BE(t.port,8),IPFrame.call(this,521,n);}else IPFrame.call(this);};DisconnectRequest.prototype=new IPFrame(),DisconnectRequest.prototype.constructor=DisconnectRequest,DisconnectRequest.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},DisconnectRequest.prototype.getCtrlEndpointHPAI=function(){var e=this._buffer.readUInt32BE(10),t=_longToIpv4(e),n=this._buffer.readUInt16BE(14),r={};return r.ip=t,r.port=n,r;};var DisconnectResponse=function DisconnectResponse(e){if(e){var t=new Buffer(2);t.writeUInt8(e,0),t.writeUInt8(0,1),IPFrame.call(this,1057,t);}else IPFrame.call(this);};return DisconnectResponse.prototype=new IPFrame(),DisconnectResponse.prototype.constructor=DisconnectResponse,DisconnectResponse.prototype.getConnectionID=function(){return this._buffer.readUInt8(6);},DisconnectResponse.prototype.isDisconnectOK=function(){return 0===this._buffer.readUInt8(7);},IPFrame.SearchRequest=SearchRequest,IPFrame.SearchResponse=SearchResponse,IPFrame.ConnectionRequest=ConnectionRequest,IPFrame.ConnectionResponse=ConnectionResponse,IPFrame.ConnectionStateRequest=ConnectionStateRequest,IPFrame.ConnectionStateResponse=ConnectionStateResponse,IPFrame.TunnellingRequest=TunnellingRequest,IPFrame.TunnellingACK=TunnellingACK,IPFrame.DisconnectRequest=DisconnectRequest,IPFrame.DisconnectResponse=DisconnectResponse,IPFrame;}(),s=function(){var cEMI=function cEMI(e){this._buffer=e;};cEMI.parseFrame=function(e){var t=null;switch(e.readUInt8(0)){case L_Data_Con.MSG_CODE:t=new L_Data_Con();break;case L_Data_Ind.MSG_CODE:t=new L_Data_Ind();}return t&&(t._buffer=e),t;},cEMI.prototype={getLength:function getLength(){return this._buffer.length;},getSrcAddr:function getSrcAddr(){return this._buffer.readUInt16BE(4);},getDstAddr:function getDstAddr(){return this._buffer.readUInt16BE(6);},getDataLength:function getDataLength(){return this._buffer.readUInt8(8);},getAPDU:function getAPDU(){var e=this.getDataLength()+1,t=new Buffer(e);return this._buffer.copy(t,0,9,9+t.length),c.parse(t);},toBuffer:function toBuffer(){return this._buffer;}};var L_Data_Req=function L_Data_Req(e,t){var n=new Buffer(9+t.getLength());n.writeUInt8(17,0),n.writeUInt8(0,1),n.writeUInt8(188,2),n.writeUInt8(224,3),n.writeUInt8(0,4),n.writeUInt8(0,5),n.writeUInt8(e>>8&255,6),n.writeUInt8(255&e,7),n.writeUInt8(t.getLength()-1,8),t.toBuffer().copy(n,9),cEMI.call(this,n);};L_Data_Req.MSG_CODE=17,(L_Data_Req.prototype=new cEMI()).constructor=L_Data_Req;var L_Data_Con=function L_Data_Con(){cEMI.call(this);};L_Data_Con.MSG_CODE=46,L_Data_Con.prototype=new cEMI(),L_Data_Con.prototype.constructor=L_Data_Con;var L_Data_Ind=function L_Data_Ind(){cEMI.call(this);};return L_Data_Ind.MSG_CODE=41,L_Data_Ind.prototype=new cEMI(),L_Data_Ind.prototype.constructor=L_Data_Ind,cEMI.L_Data_Req=L_Data_Req,cEMI.L_Data_Con=L_Data_Con,cEMI.L_Data_Ind=L_Data_Ind,cEMI;}(),c=function(){var APDU=function APDU(e,t,n){t||(t=0),e||(e=0);var r=1;n&&n.length>1&&(r=n.length),this._buffer=new Buffer(1+r),e|=t>>2,this._buffer.writeUInt8(e,0),t=t<<6|(n&&n.length>0?n.readUInt8(0):0),this._buffer.writeUInt8(t,1),n&&n.length>1&&n.copy(this._buffer,2,1);};return APDU.parse=function(e){var t=new APDU();return t._buffer=e,t;},APDU.prototype={getLength:function getLength(){return this._buffer.length;},getAPCI:function getAPCI(){return(3&this._buffer.readUInt8(0))<<2|(192&this._buffer.readUInt8(1))>>6&3;},getData:function getData(){var e=this._buffer.length-1,t=this._buffer.readUInt8(1),n=new Buffer(e);return n.writeUInt8(63&t,0),e>1&&this._buffer.copy(n,1,2),n;},toBuffer:function toBuffer(){return this._buffer;}},APDU;}();return KNXGateway._DataLink=a,KNXGateway._Tunnel=o,KNXGateway.IPFrame=i,KNXGateway.cEMI=s,KNXGateway.APDU=c,KNXGateway;}(),xnm.aio.knx.KNXGateway._DPT=function(){var DPT=function DPT(e){this.type=e;};DPT.resolve=function(e){if(!e)return null;if(e.length<=3)return null;var t=e.indexOf("-");if(t<=0)return null;var n=e.substring(0,t);if("DPT"==n){if(e.length<5)return null;n=e;}else{if("DPST"!=n)return null;if((t=e.indexOf("-",t+1))<0)return null;n=e.substring(0,t);}switch(n){case"DPT-1":case"DPST-1":return new DPT1(e);case"DPT-2":case"DPST-2":return new DPT2(e);case"DPT-3":case"DPST-3":return new DPT3(e);case"DPT-5":case"DPST-5":return new DPT5(e);case"DPT-6":case"DPST-6":return new DPT6(e);case"DPT-9":case"DPST-9":return new DPT9(e);case"DPT-14":case"DPST-14":return new DPT14(e);case"DPT-20":case"DPST-20":return new DPT20(e);}return null;},DPT.prototype.doCommand=function(e,t,n,r){r&&r();},DPT.prototype.setValue=function(e,t,n,r){e&&e instanceof Buffer?t._sendCommand(n,e,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT.prototype.getValue=function(e,t,n){e._getState(t,function(e,t){e?n&&n(e):n&&n(null,this._resolveData(t));}.bind(this));},DPT.prototype._resolveDataRaw=function(e){return e.toString("hex");},DPT.prototype._resolveData=function(e){return e.toString("hex");};var DPT1=function DPT1(e){DPT.call(this,e);};DPT1.prototype=new DPT(),DPT1.prototype.constructor=DPT1,DPT1.prototype.doCommand=function(e,t,n,r){if(e){var a=0;if(0==e.indexOf("setValue"))return(a=parseInt(e.substr(8)))&&!isNaN(a)||(a=0),void this.setValue(a,t,n,r);switch(e){case"on":case"true":case"enable":case"ramp":case"alarm":case"high":case"increase":case"down":case"close":case"start":case"active":case"inverted":a=1;break;case"off":case"false":case"disable":case"no_ramp":case"no_alarm":case"low":case"decrease":case"up":case"open":case"stop":case"inactive":case"not_inverted":a=0;break;default:return void(r&&r(new Error("unknown command:"+e)));}this.setValue(a,t,n,r);}else r&&r(new Error("unknown command:"+e));},DPT1.prototype.setValue=function(e,t,n,r){var a=null;a=0==e||1==e?new Buffer([e]):e,DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this));},DPT1.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},DPT1.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},DPT1.prototype._resolveValue=function(e){switch(this.type){case"DPT-1":case"DPST-1-1":return e?"on":"off";case"DPST-1-2":return e?"true":"false";case"DPST-1-3":return e?"enable":"disable";case"DPST-1-4":return e?"ramp":"no_ramp";case"DPST-1-5":return e?"alarm":"no alarm";case"DPST-1-6":return e?"high":"low";case"DPST-1-7":return e?"increase":"decrease";case"DPST-1-8":return e?"down":"up";case"DPST-1-9":return e?"close":"open";case"DPST-1-10":return e?"start":"stop";case"DPST-1-11":return e?"active":"inactive";case"DPST-1-12":return e?"inverted":"not_inverted";case"DPST-1-13":return e?"cyclically":"start/stop";case"DPST-1-14":return e?"calculated":"fixed";case"DPST-1-15":return e?"reset command":"no action";case"DPST-1-16":return e?"acknowledge command":"no action";case"DPST-1-18":return e?"occupied":"not occupied";case"DPST-1-19":return e?"open":"closed";case"DPST-1-21":return e?"logical function AND":"logical function OR";case"DPST-1-22":return e?"scene B":"scene A";case"DPST-1-23":return e?"move Up/Down +StepStop mode (blind)":"only move Up/Down mode (shutter)";default:return null;}};var DPT2=function DPT2(e){DPT.call(this,e);};DPT2.prototype=new DPT(),DPT2.prototype.constructor=DPT2,DPT2.prototype.doCommand=function(e,t,n,r){if(e){var a=0;if(0==e.indexOf("setValue"))return i=e.substr(0,8),(a=parseInt(e.substr(8)))&&!isNaN(a)||(a=0),void this.setValue(a,t,n,r);var o=e.split(".");if(o.length<2)r&&r(new Error("unknown command:"+e));else{a="prio"==o[0]?1:0;var i=o[1];switch(i){case"on":case"true":case"enable":case"ramp":case"alarm":case"high":case"increase":case"down":case"close":case"start":case"active":case"inverted":a=a<<1|1;break;case"off":case"false":case"disable":case"no_ramp":case"no_alarm":case"low":case"decrease":case"up":case"open":case"stop":case"inactive":case"not_inverted":a=a<<1|0;break;default:return void(r&&r(new Error("unknown command:"+e)));}this.setValue(a,t,n,r);}}else r&&r(new Error("unknown command:"+e));},DPT2.prototype.setValue=function(e,t,n,r){var a=null;a=0==e||1==e||2==e||3==e?new Buffer([e]):e,DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this));},DPT2.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},DPT2.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},DPT2.prototype._resolveValue=function(e){var t="";switch(t=e>>1==1?"prio.":"no_prio.",this.type){case"DPT-2":t=e;break;case"DPST-2-1":t+=1&e?"on":"off";break;case"DPST-2-2":t+=1&e?"true":"false";break;case"DPST-2-3":t+=1&e?"enable":"disable";break;case"DPST-2-4":t+=1&e?"ramp":"no_ramp";break;case"DPST-2-5":t+=1&e?"alarm":"no alarm";break;case"DPST-2-6":t+=1&e?"high":"low";break;case"DPST-2-7":t+=1&e?"increase":"decrease";break;case"DPST-2-8":t+=1&e?"down":"up";break;case"DPST-2-9":t+=1&e?"close":"open";break;case"DPST-2-10":t+=1&e?"start":"stop";break;case"DPST-2-11":t+=1&e?"active":"inactive";break;case"DPST-2-12":t+=1&e?"inverted":"not_inverted";break;default:return null;}return t;};var DPT3=function DPT3(e){DPT.call(this,e);};DPT3.prototype=new DPT(),DPT3.prototype.constructor=DPT3,DPT3.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;if(0==e.indexOf("setValue"))return a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0),void this.setValue(o,t,n,r);"stepUpStop"==e||"stepDownStop"==e?(a=e,o=0):0==e.indexOf("stepUp")?(a=e.substr(0,6),(o=parseInt(e.substr(6)))&&!isNaN(o)||(o=1)):0==e.indexOf("stepDown")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=1));var i=0,s=this._getStepcode(o);if(-1!=s){switch(a){case"stepUp":if(i=1,s<=0)return void(r&&r(new Error("stepUp command value invalid")));break;case"stepDown":if(i=0,s<=0)return void(r&&r(new Error("stepDown command value invalid")));break;case"stepUpStop":i=1;break;case"stepDownStop":i=0;break;default:return void(r&&r(new Error("unknown command:"+a)));}var c=i<<3|s;this.setValue(c,t,n,r);}else r&&r(new Error("invalid step precent:"+o));}else r&&r(new Error("unknown command:"+e));},DPT3.prototype.setValue=function(e,t,n,r){e<0&&(e=0),e>15&&(e=15);var a=new Buffer([e]);DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this));},DPT3.prototype._resolveDataRaw=function(e){return e.readUInt8(0);},DPT3.prototype._resolveData=function(e){var t=e.readUInt8(0);return this._resolveValue(t);},DPT3.prototype._resolveValue=function(e){var t=7&e,n=0;return 0==t?n=0:1==t?n=100:2==t?n=50:3==t?n=25:4==t?n=12:5==t?n=6:6==t?n=3:7==t&&(n=1),{direction:8&e?"up":"down",precent:n,stepcode:t};},DPT3.prototype._getStepcode=function(e){switch(e){case 0:return 0;case 1:return 7;case 3:return 6;case 6:return 5;case 12:return 4;case 25:return 3;case 50:return 2;case 100:return 1;default:return-1;}};var DPT5=function DPT5(e){DPT.call(this,e);};DPT5.prototype=new DPT(),DPT5.prototype.constructor=DPT5,DPT5.prototype.doCommand=function(e,t,n,r){if(e){var a=e,o=0;switch(0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0)),a){case"setValue":break;case"up":case"down":var i=null;return(i="up"==a?this._getBuffer(255):this._getBuffer(0))?void DPT.prototype.setValue.call(this,i,t,n,function(e){r&&r(e);}.bind(this)):void(r&&r(new Error("invalid value")));default:return void(r&&r(new Error("unknown command:"+a)));}this.setValue(o,t,n,r);}else r&&r(new Error("unknown command:"+e));},DPT5.prototype.setValue=function(e,t,n,r){switch(this.type){case"DPST-5-1":e<0&&(e=0),e>100&&(e=100),e=Math.round(e/100*255);break;case"DPST-5-3":e<0&&(e=0),e>360&&(e=360),e=Math.round(e/360*255);break;case"DPST-5-6":e<0&&(e=0),e>254&&(e=254),e=Math.round(e/360*255);break;default:e<0&&(e=0),e>255&&(e=255);}var a=this._getBuffer(e);a?DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT5.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},DPT5.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},DPT5.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},DPT5.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},DPT5.prototype._resolveValue=function(e){switch(this.type){case"DPST-5-1":return Math.round(e/255*100);case"DPST-5-3":return Math.round(e/255*360);default:return e;}},DPT5.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;};var DPT6=function DPT6(e){DPT.call(this,e);};DPT6.prototype=new DPT(),DPT6.prototype.constructor=DPT6,DPT6.prototype.doCommand=function(e,t,n,r){if(e){var a=e,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},DPT6.prototype.setValue=function(e,t,n,r){this.type,e<-128&&(e=-128),e>127&&(e=127),e<0&&(e+=256);var a=this._getBuffer(e);a?DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT6.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},DPT6.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},DPT6.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},DPT6.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},DPT6.prototype._resolveValue=function(e){return this.type,e>127&&(e-=256),e;},DPT6.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;};var DPT9=function DPT9(e){DPT.call(this,e);};DPT9.prototype=new DPT(),DPT9.prototype.constructor=DPT9,DPT9.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseFloat(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},DPT9.prototype.setValue=function(e,t,n,r){switch(this.type){case"DPT-9":e<-671088.64&&(e=-671088.64),e>670760.96&&(e=670760.96),e=this._float2short(e);break;case"DPST-9-1":e<-273&&(e=-273),e>670760&&(e=670760),e=this._float2short(e);break;case"DPST-9-4":e<0?e=0:e>670433.28&&(e=670433.28),e=this._float2short(e);break;default:e=this._float2short(e);}var a=this._getBuffer(e);a?DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT9.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},DPT9.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},DPT9.prototype._resolveDataRaw=function(e){return!e||e.length<3?0:e.readUInt16BE(1);},DPT9.prototype._resolveData=function(e){if(!e||e.length<3)return 0;var t=e.readUInt16BE(1);return this._resolveValue(t);},DPT9.prototype._resolveValue=function(e){return this.type,parseFloat(this._short2float(e).toFixed(2));},DPT9.prototype._getBuffer=function(e){var t=new Buffer(3);return t.writeUInt8(0,0),t.writeUInt16BE(e,1),t;},DPT9.prototype._float2short=function(e){for(var t=100*e,n=0;t<-2048;t/=2){n++;}for(;t>2047;t/=2){n++;}var r=2047&Math.round(t),a=n<<3|r>>8;return e<0&&(a|=128),a<<8|r;},DPT9.prototype._short2float=function(e){var t=e>>15&1,n=e>>11&15,r=2047&e|t<<11;return 1==t&&(r-=4096),.01*r*Math.pow(2,n);};var DPT14=function DPT14(e){DPT.call(this,e);};DPT14.prototype=new DPT(),DPT14.prototype.constructor=DPT14,DPT14.prototype.doCommand=function(e,t,n,r){if(e){var a=null,o=0;0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseFloat(e.substr(8)))&&!isNaN(o)||(o=0)),"setValue"===a?this.setValue(o,t,n,r):r&&r(new Error("unknown command:"+a));}else r&&r(new Error("unknown command:"+e));},DPT14.prototype.setValue=function(e,t,n,r){var a;this.type,e<-340282347e30&&(e=-340282347e30),e>340282347e30&&(e=340282347e30),a=this._float2bytes(e);var o=this._getBuffer(a);o?DPT.prototype.setValue.call(this,o,t,n,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT14.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o+=e,this.setValue(o,n,r,a);},DPT14.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o-=e,this.setValue(o,n,r,a);},DPT14.prototype._resolveDataRaw=function(e){return!e||e.length<5?0:e.readUInt32BE(1);},DPT14.prototype._resolveData=function(e){if(!e||e.length<5)return 0;var t=e.readUInt32BE(1);return this._resolveValue(t);},DPT14.prototype._resolveValue=function(e){return this.type,parseFloat(this._long2float(e).toFixed(2));},DPT14.prototype._getBuffer=function(e){if(!e||e.length<4)return null;var t=new Buffer(5);t.writeUInt8(0,0);for(var n=0;n<4;n++){t.writeUInt8(e[n],n+1);}return t;},DPT14.prototype._float2bytes=function(e){return this._toIEEE754Single(e);},DPT14.prototype._long2float=function(e){var t=new Buffer(4);t.writeUInt32BE(e);var n=Array.prototype.slice.call(t);return this._fromIEEE754Single(n);},DPT14.prototype._toIEEE754=function(e,t,n){var r,a,o,i=(1<<t-1)-1;if(isNaN(e))a=(1<<i)-1,o=1,r=0;else if(e===1/0||e===-1/0)a=(1<<i)-1,o=0,r=e<0?1:0;else if(0===e)a=0,o=0,r=1/e==-1/0?1:0;else if(r=e<0,(e=Math.abs(e))>=Math.pow(2,1-i)){var s=Math.min(Math.floor(Math.log(e)/Math.LN2),i);a=s+i,o=e*Math.pow(2,n-s)-Math.pow(2,n);}else a=0,o=e/Math.pow(2,1-i-n);var c,u=[];for(c=n;c;c-=1){u.push(o%2?1:0),o=Math.floor(o/2);}for(c=t;c;c-=1){u.push(a%2?1:0),a=Math.floor(a/2);}u.push(r?1:0),u.reverse();for(var l=u.join(""),d=[];l.length;){d.push(parseInt(l.substring(0,8),2)),l=l.substring(8);}return d;},DPT14.prototype._fromIEEE754=function(e,t,n){for(var r=[],a=e.length;a;a-=1){for(var o=e[a-1],i=8;i;i-=1){r.push(o%2?1:0),o>>=1;}}r.reverse();var s=r.join(""),c=(1<<t-1)-1,u=parseInt(s.substring(0,1),2)?-1:1,l=parseInt(s.substring(1,1+t),2),d=parseInt(s.substring(1+t),2);return l===(1<<t)-1?0!==d?NaN:u*(1/0):l>0?u*Math.pow(2,l-c)*(1+d/Math.pow(2,n)):0!==d?u*Math.pow(2,-(c-1))*(d/Math.pow(2,n)):0*u;},DPT14.prototype._fromIEEE754Single=function(e){return this._fromIEEE754(e,8,23);},DPT14.prototype._toIEEE754Single=function(e){return this._toIEEE754(e,8,23);};var DPT20=function DPT20(e){DPT.call(this,e);};return DPT20.prototype=new DPT(),DPT20.prototype.constructor=DPT20,DPT20.prototype.doCommand=function(e,t,n,r){if(e){var a=e,o=0;switch(0==e.indexOf("setValue")&&(a=e.substr(0,8),(o=parseInt(e.substr(8)))&&!isNaN(o)||(o=0)),a){case"auto":o=0;break;case"comfort":o=1;break;case"standby":o=2;break;case"economy":o=3;break;case"protection":o=4;break;case"setValue":break;default:return void(r&&r(new Error("unknown command:"+a)));}this.setValue(o,t,n,r);}else r&&r(new Error("unknown command:"+e));},DPT20.prototype.setValue=function(e,t,n,r){var a=this._getBuffer(e);a?DPT.prototype.setValue.call(this,a,t,n,function(e){r&&r(e);}.bind(this)):r&&r(new Error("invalid value"));},DPT20.prototype.incValue=function(e,t,n,r,a){var o=this._resolveValue(t);o=o.value+e,this.setValue(o,n,r,a);},DPT20.prototype.decValue=function(e,t,n,r,a){var o=this._resolveValue(t);o=o.value-e,this.setValue(o,n,r,a);},DPT20.prototype._resolveDataRaw=function(e){return!e||e.length<2?null:e.readUInt8(1);},DPT20.prototype._resolveData=function(e){if(!e||e.length<2)return null;var t=e.readUInt8(1);return this._resolveValue(t);},DPT20.prototype._resolveValue=function(e){var t;switch(this.type){case"DPT-20":t=e;break;case"DPST-20-1":switch(e){case 0:t="autonomous";break;case 1:t="slave";break;case 2:t="master";break;default:t="unknow";}break;case"DPST-20-102":switch(e){case 0:t="auto";break;case 1:t="comfort";break;case 2:t="standby";break;case 3:t="economy";break;case 4:t="protection";break;default:t="unknow";}break;default:return null;}return t;},DPT20.prototype._getBuffer=function(e){var t=new Buffer(2);return t.writeUInt8(0,0),t.writeUInt8(e,1),t;},DPT.DPT1=DPT1,DPT.DPT2=DPT2,DPT.DPT3=DPT3,DPT.DPT5=DPT5,DPT.DPT6=DPT6,DPT.DPT9=DPT9,DPT.DPT14=DPT14,DPT.DPT20=DPT20,DPT;}(),xnm.aio.knx.KNXGateway._Device=function(){var Device=function Device(e){this._device=e;};Device.resolve=function(e){if(!e)return null;var t=null;switch(e.data){case"outlet":t=new Outlet(e);break;case"lighting":t=new Lighting(e);break;case"blind":t=new Blind(e);break;case"shutter":t=new Shutter(e);break;case"heater":t=new Heater(e);break;case"1bit":t=new BIT_1(e);break;case"1byte":t=new Byte_1(e);break;case"general":t=new General(e);}return t;},Device.prototype={getDefaultChannel:function getDefaultChannel(){return null;},executeCommand:function executeCommand(e,t,n){this._parseCommand(e,function(e,r,a,o){if(e)n&&n(e);else{var i=o.ga,s=xnm.aio.knx.KNXGateway._DPT.resolve(o.type);s?s.doCommand(a,t,i,function(e){n&&n(e);}.bind(this)):n&&n(new Error("unknown actuator type:"+o.type));}});},_parseCommand:function _parseCommand(e,t){if(this._device){if(e){var n=e.indexOf("@");if(-1!=n){var r=e.substr(0,n),a=e.substr(n+1);if(r||(r=this.getDefaultChannel()),this._device.channels&&this._device.channels[r]){var o=this._device.channels[r];if(o.actuator&&o.actuator.ga&&o.actuator.type)xnm.aio.knx.KNXGateway._DPT.resolve(o.actuator.type)?t&&t(null,r,a,o.actuator):t&&t(new Error("unknown actuator type:"+o.actuator.type));else t&&t(new Error("device has no actuator for channel:"+r));}else t&&t(new Error("device has no channel with id:"+r));}else t&&t(new Error("command format invalid"));}else t&&t(new Error("command is null"));}else t&&t(new Error("device is null"));},getStates:function getStates(e){if(!this._device||!this._device.channels)return null;var t=null;for(var n in this._device.channels){if(this._device.channels.hasOwnProperty(n)){var r=this.getState(n,e);r&&!r.error&&(t||(t={}),null==r.resolvedValue?t[n]={state:r.resolvedValue,raw:r.resolvedRawValue}:"object"==_typeof(r.resolvedValue)?(t[n]=JSON.parse(JSON.stringify(r.resolvedValue)),t[n].raw=r.resolvedRawValue):t[n]={state:r.resolvedValue,raw:r.resolvedRawValue});}}return t;},getState:function getState(e,t){return this._getBufferedState(e,t);},_getBufferedState:function _getBufferedState(e,t){var n={error:null,bufferedValue:null,resolvedRawValue:null,resovledValue:null};if(!this._device)return n.error=new Error("device is null"),n;if(e||(e=this.getDefaultChannel()),!this._device.channels||!this._device.channels[e])return n.error=new Error("device has no channel with id:"+e),n;var r,a=this._device.channels[e],o=null,i=null,s=null,c=t.getStateBuffer();if(a.event&&a.event.ga&&(o=c.getState(xnm.aio.knx.KNXGateway._adr2long(a.event.ga)))&&(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.event.type))&&(s=r._resolveDataRaw(o),i=r._resolveData(o)),void 0!==o&&null!=o||a.status&&a.status.ga&&(o=c.getState(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)))&&(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&(s=r._resolveDataRaw(o),i=r._resolveData(o)),(void 0===o||null==o)&&a.status&&a.status.ga){var u=c.getStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga)),l=new Date();(!u||l.getTime()-u.getTime()>xnm.aio.knx.KNXGateway.STATES_REQ_EXPIRED)&&(c.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(a.status.ga),l),(r=xnm.aio.knx.KNXGateway._DPT.resolve(a.status.type))&&r.getValue(t,a.status.ga));}return n.bufferedValue=o,n.resolvedRawValue=s,n.resolvedValue=i,n;},refreshStates:function refreshStates(e){if(!this._device||!this._device.channels)return null;var t=e.getStateBuffer();for(var n in this._device.channels){if(this._device.channels.hasOwnProperty(n)){var r=this._device.channels[n];if(r.status&&r.status.ga&&r.status.type){var a=xnm.aio.knx.KNXGateway._DPT.resolve(r.status.type);if(a){var o=new Date();t.setStateReqTime(xnm.aio.knx.KNXGateway._adr2long(r.status.ga),o),a.getValue(e,r.status.ga);}}}}return null;}};var General=function General(e){Device.call(this,e);};General.prototype=new Device(),General.prototype.constructor=General,General.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(e,a,o,i){if(e)n&&n(e);else{var s,c,u,l,d=i.ga,f=xnm.aio.knx.KNXGateway._DPT.resolve(i.type);if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT1){if("toggle"===o){if((u=r.getState(a,t)).err||!u.bufferedValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.bufferedValue.readUInt8(0),f.setValue(l?0:1,t,d,function(e){n&&n(e);}.bind(this));}else f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT2)f.doCommand(o,t,d,n);else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT3)f.doCommand(o,t,d,n);else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT5)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT6)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT9)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseFloat(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT14)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseFloat(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else if(f instanceof xnm.aio.knx.KNXGateway._DPT.DPT20)switch(s=o,(0==o.indexOf("inc")||0==o.indexOf("dec"))&&(s=o.substr(0,3),(c=parseInt(o.substr(3)))&&!isNaN(c)||(c=1)),s){case"inc":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.incValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;case"dec":if((u=r.getState(a,t)).err||void 0===u.resolvedRawValue||null==u.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));l=u.resolvedRawValue,f.decValue(c,l,t,d,function(e){n&&n(e);}.bind(this));break;default:f.doCommand(o,t,d,n);}else n&&n(new Error("unknown data point type"));}});};var Outlet=function Outlet(e){Device.call(this,e);};Outlet.prototype=new Device(),Outlet.prototype.constructor=Outlet,Outlet.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(a,o,i,s){if(a)n&&n(a);else{var c=s.ga,u=xnm.aio.knx.KNXGateway._DPT.resolve(s.type);if("switch"===o)switch(i){case"on":case"off":u.doCommand(i,t,c,n);break;case"toggle":var l=r.getState(o,t);if(l.err||!l.bufferedValue)return void(n&&n(new Error("device (buffered) Status unknow")));var d=l.bufferedValue.readUInt8(0);u.setValue(d?0:1,t,c,function(e){n&&n(e);}.bind(this));break;default:n&&n(new Error("invalid device command"));}else General.prototype.executeCommand.call(r,e,t,n);}});},Outlet.prototype.getDefaultChannel=function(){return"switch";};var Lighting=function Lighting(e){Device.call(this,e);};Lighting.prototype=new Device(),Lighting.prototype.constructor=Lighting,Lighting.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(a,o,i,s){if(a)n&&n(a);else{var c,u,l=s.ga,d=xnm.aio.knx.KNXGateway._DPT.resolve(s.type),f=i,h=null;switch(o){case"switch":switch(i){case"on":case"off":d.doCommand(i,t,l,n);break;case"toggle":if((c=r.getState(o,t)).err||!c.bufferedValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.bufferedValue.readUInt8(0),d.setValue(u?0:1,t,l,function(e){n&&n(e);}.bind(this));break;default:n&&n(new Error("invalid device command"));}break;case"step":0==i.indexOf("stepUp")||0==i.indexOf("stepDown")?d.doCommand(i,t,l,n):n&&n(new Error("invalid device command"));break;case"value":switch(0==i.indexOf("inc")||0==i.indexOf("dec")?(f=i.substr(0,3),(h=parseInt(i.substr(3)))&&!isNaN(h)||(h=1)):0==i.indexOf("dimTo")&&(f="dimTo",(h=parseInt(i.substr(5)))&&!isNaN(h)||(h=0)),f){case"dimUp":d.doCommand("up",t,l,n);break;case"dimDown":d.doCommand("down",t,l,n);break;case"inc":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"dec":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"dimTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;default:return void General.prototype.executeCommand.call(r,e,t,n);}}});},Lighting.prototype.getDefaultChannel=function(){return"value";};var Blind=function Blind(e){Device.call(this,e);};Blind.prototype=new Device(),Blind.prototype.constructor=Blind,Blind.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(a,o,i,s){if(a)n&&n(a);else{var c,u,l=s.ga,d=xnm.aio.knx.KNXGateway._DPT.resolve(s.type),f=i,h=null;switch(o){case"blind_step":switch(i){case"blindStepUp":d.doCommand("up",t,l,n);break;case"blindStepDown":d.doCommand("down",t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"blind_move":switch(i){case"blindMoveUp":d.doCommand("up",t,l,n);break;case"blindMoveDown":d.doCommand("down",t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"blind_stop":if("blindStop"===i)d.doCommand("stop",t,l,n);else n&&n(new Error("invalid device command"));break;case"blind_position":switch(0==i.indexOf("inc")||0==i.indexOf("dec")?(f=i.substr(0,3),(h=parseInt(i.substr(3)))&&!isNaN(h)||(h=1)):0==i.indexOf("moveTo")&&(f="moveTo",(h=parseInt(i.substr(6)))&&!isNaN(h)||(h=0)),f){case"moveUp":d.doCommand("down",t,l,n);break;case"moveDown":d.doCommand("up",t,l,n);break;case"inc":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"dec":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"moveTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"lamella_position":switch(0==i.indexOf("incL")||0==i.indexOf("decL")?(f=i.substr(0,4),(h=parseInt(i.substr(4)))&&!isNaN(h)||(h=1)):0==i.indexOf("lamellaTo")&&(f="lamellaTo",(h=parseInt(i.substr(9)))&&!isNaN(h)||(h=0)),f){case"lamellaUp":d.doCommand("down",t,l,n);break;case"lamellaDown":d.doCommand("up",t,l,n);break;case"incL":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"decL":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"lamellaTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;default:return void General.prototype.executeCommand.call(r,e,t,n);}}});},Blind.prototype.getDefaultChannel=function(){return"blind_position";};var Shutter=function Shutter(e){Device.call(this,e);};Shutter.prototype=new Device(),Shutter.prototype.constructor=Shutter,Shutter.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(a,o,i,s){if(a)n&&n(a);else{var c,u,l=s.ga,d=xnm.aio.knx.KNXGateway._DPT.resolve(s.type),f=i,h=null;switch(o){case"shutter_step":switch(i){case"shutterStepUp":d.doCommand("up",t,l,n);break;case"shutterStepDown":d.doCommand("down",t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"shutter_move":switch(i){case"shutterMoveUp":d.doCommand("up",t,l,n);break;case"shutterMoveDown":d.doCommand("down",t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"shutter_stop":if("shutterStop"===i)d.doCommand("stop",t,l,n);else n&&n(new Error("invalid device command"));break;case"shutter_position":switch(0==i.indexOf("inc")||0==i.indexOf("dec")?(f=i.substr(0,3),(h=parseInt(i.substr(3)))&&!isNaN(h)||(h=1)):0==i.indexOf("moveTo")&&(f="moveTo",(h=parseInt(i.substr(6)))&&!isNaN(h)||(h=0)),f){case"moveUp":d.doCommand("down",t,l,n);break;case"moveDown":d.doCommand("up",t,l,n);break;case"inc":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"dec":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"moveTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;default:return void General.prototype.executeCommand.call(r,e,t,n);}}});},Shutter.prototype.getDefaultChannel=function(){return"shutter_position";};var Heater=function Heater(e){Device.call(this,e);};Heater.prototype=new Device(),Heater.prototype.constructor=Heater,Heater.prototype.executeCommand=function(e,t,n){if("refreshStates"==e)return this.refreshStates(t),void(n&&n());var r=this;this._parseCommand(e,function(a,o,i,s){if(a)n&&n(a);else{var c,u,l=s.ga,d=xnm.aio.knx.KNXGateway._DPT.resolve(s.type),f=i,h=null;switch(o){case"setpoint_basic":switch(0==i.indexOf("tempUp")?(f=i.substr(0,6),(h=parseFloat(i.substr(6)))&&!isNaN(h)||(h=.5)):0==i.indexOf("tempDown")?(f=i.substr(0,8),(h=parseFloat(i.substr(8)))&&!isNaN(h)||(h=.5)):0==i.indexOf("tempTo")&&(f="tempTo",(h=parseFloat(i.substr(6)))&&!isNaN(h)||(h=0)),f){case"tempUp":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"tempDown":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"tempTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"setpoint_shift":switch(0==i.indexOf("tempShiftUp")?(f=i.substr(0,11),(h=parseInt(i.substr(11)))&&!isNaN(h)||(h=1)):0==i.indexOf("tempShiftDown")?(f=i.substr(0,13),(h=parseInt(i.substr(13)))&&!isNaN(h)||(h=1)):0==i.indexOf("tempShiftTo")&&(f="tempShiftTo",(h=parseInt(i.substr(11)))&&!isNaN(h)||(h=0)),f){case"tempShiftUp":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.incValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"tempShiftDown":if((c=r.getState(o,t)).err||void 0===c.resolvedRawValue||null==c.resolvedRawValue)return void(n&&n(new Error("device (buffered) Status unknow")));u=c.resolvedRawValue,d.decValue(h,u,t,l,function(e){n&&n(e);}.bind(this));break;case"tempShiftTo":d.doCommand("setValue"+h,t,l,n);break;default:n&&n(new Error("invalid device command"));}break;case"mode":d.doCommand(i,t,l,n);break;default:return void General.prototype.executeCommand.call(r,e,t,n);}}});},Heater.prototype.getDefaultChannel=function(){return"set_temperature";};var BIT_1=function BIT_1(e){Device.call(this,e);};BIT_1.prototype=new Device(),BIT_1.prototype.constructor=BIT_1,BIT_1.prototype.doCommand=function(e,t,n){var r,a={},o=e.command,i=e.channel;if(i||(i=this.getDefaultChannel()),this._device[i]){var s=this._getWriteableGa(this._device[i]);if(s){if(s instanceof Error)n&&n(s);else switch(o){case"on":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(1,t,s,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;case"off":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(0,t,s,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;case"toggle":if(!(r=this._getReadableGa(this._device[i])))return void(n&&n(new Error("invalid device has no readable address")));if(r instanceof Error)return void(n&&n(s));xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).invValue(t,s,r,function(e,t){e||(a.channel=i,a.state=t),n&&n(e,e?null:a);}.bind(this));break;default:n&&n(new Error("invalid device command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},BIT_1.prototype.evalGroupCommand=function(e,t,n){var r={},a=e.command,o=e.channel;if(o||(o=this.getDefaultChannel()),this._device[o]){var i=this._getWriteableGa(this._device[o]);if(i){if(i instanceof Error)n&&n(i);else switch(a){case"on":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(1,t,i,function(e,t){e||(r.channel=o,r.state=t),n&&n(e,e?null:r);}.bind(this));break;case"off":xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(0,t,i,function(e,t){e||(r.channel=o,r.state=t),n&&n(e,e?null:r);}.bind(this));break;default:n&&n(new Error("invalid device group command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},BIT_1.prototype.getState=function(e,t,n){var r;e&&e.channel&&(r=e.channel),r||(r=this.getDefaultChannel()),this._getState(r,t,n);},BIT_1.prototype.getDefaultChannel=function(){return"channel";};var Byte_1=function Byte_1(e){Device.call(this,e);};return Byte_1.prototype=new Device(),Byte_1.prototype.constructor=Byte_1,Byte_1.prototype.doCommand=function(e,t,n){var r,a={},o=e.command,i=e.channel;if(i||(i=this.getDefaultChannel()),this._device[i]){var s=this._getWriteableGa(this._device[i]);if(s){if(s instanceof Error)n&&n(s);else{if(o.length>=3&&("inc"===o.substr(0,3).toLowerCase()||"dec"===o.substr(0,3).toLowerCase())){var c=o.substr(0,3);return""==(o=o.substr(3))&&(o="10"),o.match(/^\d+$/)?(o=parseInt(o),(r=this._getReadableGa(this._device[i]))?r instanceof Error?void(n&&n(r)):void xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type)["inc"==c?"incValue":"decValue"](o,t,s,r,function(e,t){e||null==t||(a.channel=i,a.state=t),n&&n(e,e?null:a);}):void(n&&n(new Error("invalid device has no readable address")))):void(n&&n(new Error("invalid device command")));}o.length>6&&"moveto"===o.substr(0,6).toLowerCase()&&(o=o.substr(6)),o.match(/^\d+$/)?(o=parseInt(o),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[i].actuator.type).setValue(o,t,s,function(e,t){e||null==t||(a.channel=i,a.state=t),n&&n(e,e?null:a);})):n&&n(new Error("invalid device command"));}}else n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},Byte_1.prototype.evalGroupCommand=function(e,t,n){var r={},a=e.command,o=e.channel;if(o||(o=this.getDefaultChannel()),this._device[o]){var i=this._getWriteableGa(this._device[o]);i?i instanceof Error?n&&n(i):a.length>=3&&("inc"===a.substr(0,3).toLowerCase()||"dec"===a.substr(0,3).toLowerCase())?n&&n(new Error("invalid device group command")):(a.length>6&&"moveto"===a.substr(0,6).toLowerCase()&&(a=a.substr(6)),a.match(/^\d+$/)?(a=parseInt(a),xnm.aio.knx.KNXGateway._DPT.resolve(this._device[o].actuator.type).evalValue(a,t,i,function(e,t){e||null==t||(r.channel=o,r.state=t),n&&n(e,e?null:r);})):n&&n(new Error("invalid device command"))):n&&n(new Error("invalid device has no writeable address"));}else n&&n(new Error("invalid device"));},Byte_1.prototype.getState=function(e,t,n){var r;e&&e.channel&&(r=e.channel),r||(r=this.getDefaultChannel()),this._getState(r,t,n);},Byte_1.prototype.getDefaultChannel=function(){return"channel";},Device.General=General,Device.Outlet=Outlet,Device.Lighting=Lighting,Device.Blind=Blind,Device.Shutter=Shutter,Device.Heater=Heater,Device.BIT_1=BIT_1,Device.Byte_1=Byte_1,Device;}(),xnm.aio.knx.Discovery={_eventEmitter:new EventEmitter(),_logger:Logger.getLogger("xnm.aio.knx.Discovery"),_listenerSockets:[],_closedSockets:[],on:function on(e,t){this._eventEmitter.on(e,t);},removeAllListeners:function removeAllListeners(){this._eventEmitter.removeAllListeners();},startSearchKNX:function startSearchKNX(){if(os&&os.networkInterfaces){var e=os.networkInterfaces();for(var t in e){for(var n=e[t],r=0;r<n.length;r++){var a=n[r];if(!1===a.internal&&"IPv4"===a.family){var o=a.address;this._createSocket(o);}}}}else this._createSocket(null);this._closedSockets=[];},stopSearchKNX:function stopSearchKNX(){for(var e=0;e<this._listenerSockets.length;e++){this._listenerSockets[e].close();}},_createSocket:function _createSocket(e){var t=this,n=dgram.createSocket("udp4");n.on("listening",function(){n.addMembership("224.0.23.12"),n.setBroadcast(!0);var e=n.address();t._logger.log("debug","knx discovery socket listening "+e.address+":"+e.port),t._listenerSockets.push(n);var r={ip:e.address,port:e.port},a=new xnm.aio.knx.KNXGateway.IPFrame.SearchRequest(r).toBuffer();t._logger.log("debug","send knx search request: "+a.toString("hex")+" from "+e.address+":"+e.port),n.send(a,0,a.length,3671,"224.0.23.12");}),n.on("message",function(e,r){var a=n.address();t._logger.log("trace","receive data "+e.toString("hex")+" from "+r.address+":"+r.port+" @local "+a.address+":"+a.port);var o=xnm.aio.knx.KNXGateway.IPFrame.parseFrame(e);if(o instanceof xnm.aio.knx.KNXGateway.IPFrame.SearchResponse){var i=o.getCtrlEndpointHPAI();t._logger.log("debug","find knx "+i.ip+":"+i.port),t._eventEmitter.emit("found",o,a),t._eventEmitter.emit("device",o.toJSON(),a);}}),n.on("error",function(e){t._logger.log("debug","discovery socket error: "+e.stack),t._eventEmitter.emit("error",e);}),n.on("close",function(){t._logger.log("debug","discovery socket closed"),t._closedSockets.push(n),t._listenerSockets.length===t._closedSockets.length&&(t._listenerSockets=[],t._closedSockets=[],t._eventEmitter.emit("close"));}),n.bind(null,e);}},xnm.aio.knx.Handler=function(){var Handler=function Handler(){this._listenerSockets=[];};return Handler.prototype={KNXGateway:xnm.aio.knx.KNXGateway,Finder:xnm.aio.knx.Discovery},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.knx.Handler());