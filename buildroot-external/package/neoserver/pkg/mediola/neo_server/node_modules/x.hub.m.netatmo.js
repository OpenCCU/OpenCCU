var x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.netatmo=x.hub.m.netatmo||{},x.hub.m.netatmo.MODULE=require("xnm.aio.netatmo.js"),x.hub.m.netatmo.Monitor=function(){var Monitor=function Monitor(e){this._logger=require("x.logger.js").getLogger("x.hub.m.netatmo.Monitor.["+e.refreshToken.substr("6")+"...]"),this._running=!1,this._gateway=e,this._devices={},this._status={};};return Monitor.prototype.start=function(e){this._logger.log("debug","start monitor"),this._running||(this._running=!0,this._getAllStatus()),e&&e();},Monitor.prototype.addStateDevice=function(e,t){if(e){var r;switch(e.type){case"NAMain":case"NHC":case"NAPlug":case"room":case"home":r=e.address;break;default:r=e.module;}r&&(this._devices[r]=e);}t&&t();},Monitor.prototype._getAllStatus=function(){var e=this;this._logger.log("trace","get all status"),this._gateway.getAllStatus(function(t,r){t?e._logger.log("trace","get all status error:"+t.message):r&&(e._logger.log("trace","get all status response:"+JSON.stringify(r)),e._receiveStatus(r)),e._running&&setTimeout(function(){e._getAllStatus();},1e4);});},Monitor.prototype._receiveStatus=function(e){for(var t in e=JSON.parse(JSON.stringify(e))){var r=e[t],o=this._status[t];if(r&&o&&this._devices[t])for(var a in r){var i=r[a],s=o[a];void 0!==s&&null!=s&&void 0!==i&&null!=i&&s!=i&&this._produceEvent(this._devices[t],a,s,i);}}this._status=e;},Monitor.prototype._produceEvent=function(e,t,r,o){try{this._logger.log("debug","state ["+t+"] changed from '"+r+"' to '"+o+"' for device:"+JSON.stringify(e));var a=require("x.hub.eventbus.js"),i={key:t,value:o,oldvalue:r,changed:!0};a.emit("status",{module:"netatmo",device:e,gateway:this._gateway.toJSON(),data:i});}catch(e){}},Monitor;}(),x.hub.m.netatmo.Handler=function(){var Handler=function Handler(){this._clouds={},this._monitors={};};return Handler.prototype.init=function(e){e&&e();},Handler.prototype.getSystems=function(){return["netatmo"];},Handler.prototype.addStateDevice=function(e,t){e&&e.gateway?this._startMonitor(e.gateway,function(r,o){r?t&&t({error:r}):(delete(e=JSON.parse(JSON.stringify(e))).gateway,o.addStateDevice(e,function(e){t&&t({error:e});}));}):t&&t({error:new Error("gateway is null")});},Handler.prototype.getState=function(e,t,r){if(e&&e.gateway){var o=x.hub.m.netatmo.MODULE.resolveGateway(e.gateway);if(o){var a=o.refreshToken;this._clouds[a]||(this._clouds[a]=o),o=this._clouds[a],delete(e=JSON.parse(JSON.stringify(e))).gateway,o.getStatesCreator(null,[{id:"xhub",device:e,status:{value:t}}],function(e,t){var o=null;t&&t[0]&&(o=t[0].status),r&&r({error:e,data:{value:o}});});}else r&&r({error:new Error("gateway invalid")});}else r&&r({error:new Error("gateway is null")});},Handler.prototype.executeCommand=function(e,t,r){if(e&&e.gateway){var o=x.hub.m.netatmo.MODULE.resolveGateway(e.gateway);if(o){var a=o.refreshToken;this._clouds[a]||(this._clouds[a]=o),o=this._clouds[a],delete(e=JSON.parse(JSON.stringify(e))).gateway,o.executeCommandCreator(e,t,function(e){r&&r({error:e});});}else r&&r({error:new Error("gateway invalid")});}else r&&r({error:new Error("gateway is null")});},Handler.prototype.checkDeviceMatch=function(e,t){return!!(t&&t.device&&e&&e.device)&&t.device.type==e.device.type&&("NAMain"==t.device.type||"NHC"==t.device.type||"NAPlug"==t.device.type||"room"==t.device.type||"home"==t.device.type?t.device.address==e.device.address:t.device.module==e.device.module);},Handler.prototype._startMonitor=function(e,t){if(e&&e.refreshToken){var r=x.hub.m.netatmo.MODULE.resolveGateway(e);if(r){var o=r.refreshToken;if(this._clouds[o]||(this._clouds[o]=r),r=this._clouds[o],this._monitors[o])t&&t(null,this._monitors[o]);else{var a=new x.hub.m.netatmo.Monitor(r);this._monitors[o]=a,a.start(),t&&t(null,a);}}else t&&t({error:new Error("gateway invalid")});}else t&&t(new Error("gateway format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.netatmo.Handler());