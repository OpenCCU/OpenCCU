var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.yellowstone=xnm.aio.yellowstone||{},xnm.aio.yellowstone.Cloudy=function(){var t=[1,2,3,4,5],CommandTask=function CommandTask(t,e,o){this._taskBuffer=null,this._cloudy=t,this._command=e,this._callback=o;};CommandTask.prototype.run=function(){this._cloudy._logger.log("debug","run command task: "+JSON.stringify(this._command));var t,e=this;if(this._command.raw)t=this._cloudy._buildRawCommandReq(this._command.raw);else if(this._command.hexValue)t=this._cloudy._buildHexCommandReq(this._command.bg,this._command.sig,this._command.hexValue);else if("toggle"==this._command.command){var o=this._cloudy._buildStateReq(this._command.bg);this._cloudy._doStateReq(o,function(o,r){if(o)!o||1!=o.errorCode&&2!=o.errorCode&&3!=o.errorCode?e._taskBuffer._finishLastTask(o):e._taskBuffer._finishAllTask(o);else{var i=e._command.sig;if(r&&r.intState&&void 0!==r.intState[i]&&null!=r.intState[i]){var a=r.intState[i];a=0==a?1:0,t=e._cloudy._buildCommandReq(e._command.bg,e._command.sig,a),e._cloudy._doCommandReq(t,function(t){!t||1!=t.errorCode&&2!=t.errorCode&&3!=t.errorCode?e._taskBuffer._finishLastTask(t):e._taskBuffer._finishAllTask(t);});}else e._taskBuffer._finishLastTask(o);}});}else t=this._cloudy._buildCommandReq(this._command.bg,this._command.sig,this._command.value);t&&this._cloudy._doCommandReq(t,function(t){!t||1!=t.errorCode&&2!=t.errorCode&&3!=t.errorCode?e._taskBuffer._finishLastTask(t):e._taskBuffer._finishAllTask(t);});};var StatusTask=function StatusTask(t,e,o){this._taskBuffer=null,this._cloudy=t,this._bgs=e,this._callback=o;};StatusTask.prototype.run=function(){this._cloudy._logger.log("debug","run status task: "+JSON.stringify(this._bgs));var t,e=this,o={},r=0,cb=function cb(t,i){var a;t&&4!=t.errorCode&&5!=t.errorCode?1==t.errorCode||2==t.errorCode||3==t.errorCode?e._taskBuffer._finishAllTask(t):e._taskBuffer._finishLastTask(t):(i&&(o[e._bgs[r]]=i),++r<e._bgs.length?(a=-1==e._bgs[r]?e._cloudy._buildRawMsgReq():e._cloudy._buildStateReq(e._bgs[r]),e._cloudy._doStateReq(a,cb)):e._taskBuffer._finishLastTask(null,o));};t=-1==this._bgs[r]?this._cloudy._buildRawMsgReq():this._cloudy._buildStateReq(this._bgs[r]),this._cloudy._doStateReq(t,cb);};var TaskBuffer=function TaskBuffer(t){this._cloudy=t,this._buffer=[];};TaskBuffer.prototype.executeTask=function(t){var e=this._buffer.length;t._taskBuffer=this,this._buffer.push(t),0==e&&this._doNextTask();},TaskBuffer.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run();},TaskBuffer.prototype._finishLastTask=function(t,e){if(this._buffer.length>0){var o=this._buffer[0];o&&o._callback&&(o._callback(t,e),o._callback=null),this._buffer.splice(0,1);}this._doNextTask();},TaskBuffer.prototype._finishAllTask=function(t){var e=this._buffer;this._buffer=[];for(var o=0;o<e.length;o++){e[o]&&e[o]._callback&&(e[o]._callback(t),e[o]._callback=null);}};var PacketBuffer=function PacketBuffer(t){this._cloudy=t,this._logger=t._logger,this._buffer=[],this._bufferEmptyTo=null,this._dataBuffer=null;};PacketBuffer.prototype.RESPONSE_TO=2e3,PacketBuffer.prototype.sendPacket=function(t,e){if(t){var o={packet:t,callback:e},r=this._buffer.length;this._buffer.push(o),this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null),0==r&&this._sendNextPacket();}else e&&e(new Error("message is null"));},PacketBuffer.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var e=this,o=this._buffer[0];this._cloudy._sendPacket(o.packet,function(r){if(r)return r.errorCode=t[0],void e._finishAllPacket(r);o.timeout=setTimeout(function(){e._logger.log("warn","packet response timeout");var o=new Error("packet reponse timeout");o.errorCode=t[3],e._finishLastPacket(o);},e.RESPONSE_TO);});}},PacketBuffer.prototype._finishLastPacket=function(t,e){if(this._buffer.length>0&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(t,e),this._buffer[0].callback=null)),this._buffer.splice(0,1)),0==this._buffer.length){var o=this;this._bufferEmptyTo=setTimeout(function(){o._bufferEmptyTo=null,0==o._buffer.length&&o._cloudy._disconnect();},500);}else this._sendNextPacket();},PacketBuffer.prototype._finishAllPacket=function(t){var e=this._buffer;this._buffer=[],this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var o=0;o<e.length;o++){e[o]&&(e[o].timeout&&(clearTimeout(e[o].timeout),e[o].timeout=null),e[o].callback&&(e[o].callback(t),e[o].callback=null));}},PacketBuffer.prototype._hex2ascii=function(t){for(var e="",o=0;o<t.length;o+=2){e+=String.fromCharCode(parseInt(t.substr(o,2),16));}return e;},PacketBuffer.prototype._handlePacket=function(t){if(this._buffer.length>0&&this._buffer[0]){var e=this._buffer[0].packet;if(e&&e.length>=3)switch(e.substr(0,3)){case"CRO":case"CWO":case"CRS":t.raw&&t.raw.length>=2&&(t.params=t.raw.substr(1));break;case"CGO":t.raw&&t.raw.length>=2&&(t.params=t.raw.substr(1).trim().split(" "));}this._logger.log("trace","parsed packet:"+JSON.stringify(t)),this._finishLastPacket(null,t);}},PacketBuffer.prototype._handleData=function(){for(var t=null,e=!1,o=0;o<=this._dataBuffer.length-2;o+=2){var r=this._dataBuffer.substr(o,2),i=null;if(o<=this._dataBuffer.length-4&&(i=this._dataBuffer.substr(o+2,2)),"04"==r.toLowerCase()){t=this._dataBuffer.substr(0,o),e=!0,o==this._dataBuffer.length-2?this._dataBuffer=null:this._dataBuffer=this._dataBuffer.substr(o+2);break;}if(("0d"==r.toLowerCase()||"0a"==r.toLowerCase())&&"03"==i.toLowerCase()){t=this._dataBuffer.substr(0,o),o==this._dataBuffer.length-4?this._dataBuffer=null:this._dataBuffer=this._dataBuffer.substr(o+4);break;}}if(void 0!==t&&null!=t){t=this._hex2ascii(t);var a={};a.interrupt=e,a.raw=t,a.ok=">"==t.charAt(0),this._logger.log("trace","receive packet:"+JSON.stringify(a)),this._handlePacket(a);}void 0!==t&&null!=t&&this._dataBuffer&&this._handleData();},PacketBuffer.prototype._onSocketData=function(t){t&&(this._dataBuffer?this._dataBuffer+=t:this._dataBuffer=t),this._dataBuffer&&this._handleData();},PacketBuffer.prototype._onSocketTimeout=function(){},PacketBuffer.prototype._onSocketError=function(e){e.errorCode=t[1],this._finishAllPacket(e);},PacketBuffer.prototype._onSocketClose=function(e){var o=new Error("socket closed");o.errorCode=t[2],this._finishAllPacket(o);};var Cloudy=function Cloudy(t,e){this._logger=require("x.logger.js").getLogger("xnm.aio.yellowstone.Cloudy"),this._ip=t,this._port=e,this._port||(this._port=4e3),this._socket=null,this._taskBuffer=new TaskBuffer(this),this._packetBuffer=new PacketBuffer(this);};return Cloudy.prototype.executeCommandCreator=function(t,e,o){if(e&&e.value){var r;if("rawCmd"===e.value){if(!e.ext)return void(o&&o(new Error("command rawCmd ext null")));r={raw:e.ext};}else{if(!t||void 0===t.bg||null==t.bg||void 0===t.sig||null==t.sig)return void(o&&o(new Error("device invalid")));var i;switch(e.value){case"on":r={bg:t.bg,sig:t.sig,value:1};break;case"off":r={bg:t.bg,sig:t.sig,value:0};break;case"toggle":r={bg:t.bg,sig:t.sig,command:"toggle"};break;default:if(void 0===e.ext||null==e.ext)return void(o&&o(new Error("command setValue ext null")));switch(e.value){case"setHex":r={bg:t.bg,sig:t.sig,hexValue:e.ext};break;case"setInt":i=parseInt(e.ext),r={bg:t.bg,sig:t.sig,value:i};break;case"setFloat":if(i=parseFloat(e.ext),0==parseFloat(t.scale))i=0;else{var a=parseFloat(t.scale);!isNaN(a)&&a||(a=1),i=Math.round(i/a);}r={bg:t.bg,sig:t.sig,value:i};}}}r?this._executeCommand(r,o):o&&o(new Error("no such command"));}else o&&o(new Error("command is null"));},Cloudy.prototype.getStatesCreator=function(t,e,o){if(e){if(0!=e.length){for(var r=[],i=0;i<e.length;i++){var a,n=e[i];if(n)a=!n.device||n.device.ip?-1:n.device.bg,-1==r.indexOf(a)&&r.push(a);}this._getStates(r,function(t,r){var i=[];if(r)for(var a=0;a<e.length;a++){if(e[a]&&e[a].id){var n="?";if((!e[a].device||e[a].device.ip)&&e[a].status&&e[a].status.value)void 0!==r[-1]&&null!=r[-1]&&(n=r[-1]);else if(e[a].device&&e[a].status&&e[a].status.value){var s=e[a].device.bg,l=e[a].device.sig,u=e[a].device.scale;if(void 0!==s&&null!=s&&void 0!==l&&null!=l&&r[s]){var c=r[s];if(void 0!==c&&null!=c){var f=null;switch(e[a].status.value){case"stateHex":c.hexState&&c.hexState[l]&&(n=c.hexState[l]);break;case"stateFloat":c.intState&&void 0!==c.intState[l]&&null!=c.intState[l]&&(f=c.intState[l],void 0!==u&&null!=u&&(f*=parseFloat(u)),n=f);break;case"stateInt":c.intState&&void 0!==c.intState[l]&&null!=c.intState[l]&&(n=c.intState[l]);break;case"stateBi":c.intState&&void 0!==c.intState[l]&&null!=c.intState[l]&&(n=0==(f=c.intState[l])?"off":"on");}}}}void 0!==n&&null!=n||(n="?"),i.push({id:e[a].id,status:n});}}o&&o(null,i);});}else o&&o(null,[]);}else o&&o(new Error("deviceList is null"));},Cloudy.prototype._executeCommand=function(t,e){this._logger.log("debug","execute command: "+JSON.stringify(t));var o=new CommandTask(this,t,e);this._taskBuffer.executeTask(o);},Cloudy.prototype._getStates=function(t,e){this._logger.log("debug","get states: "+JSON.stringify(t));var o=new StatusTask(this,t,e);this._taskBuffer.executeTask(o);},Cloudy.prototype._resolveMsg=function(t){var e=null;if(t){var o=t.params.replace(/"/g,"");">"==o.charAt(0)&&o.length>1&&(o=o.substr(1)),e=o.trim();}return e;},Cloudy.prototype._resolveStatus=function(t){var e=[],o=[];if(t.params)for(var r=0;r<t.params.length;r++){var i=parseInt(t.params[r],16);2147483648&i&&(i=(2147483647&i)-2147483648);for(var a=t.params[r];a.length<8;){a="0"+a;}o.push(a),e.push(i);}return{hexState:o,intState:e};},Cloudy.prototype._doCommandReq=function(t,e){this._packetBuffer.sendPacket(t,function(t,o){if(!t)return o&&!o.interrupt&&o.ok&&o.params?void e():((t=new Error("CWO response error")).errorCode=5,void e(t));e(t);});},Cloudy.prototype._doStateReq=function(t,e){var o=this;this._packetBuffer.sendPacket(t,function(r,i){if(r)e(r);else{if(!i||i.interrupt||!i.ok||!i.params)return(r=new Error("state (CGO, CRS) response error")).errorCode=5,void e(r);var a;a=0==t.indexOf("CRS")?o._resolveMsg(i):o._resolveStatus(i),e(null,a);}});},Cloudy.prototype._buildCommandReq=function(t,e,o){return o<-2147483648&&(o=-2147483648),o>2147483647&&(o=2147483647),o<0&&(o=o+2147483648|2147483648),"CWO "+t+" "+e+" "+o.toString(16);},Cloudy.prototype._buildRawCommandReq=function(t){return'CWR "'+t+'"';},Cloudy.prototype._buildHexCommandReq=function(t,e,o){return o.length>8&&(o=o.substr(o.length-8)),"CWO "+t+" "+e+" "+o;},Cloudy.prototype._buildStateReq=function(t){return"CGO "+t+" 0 64";},Cloudy.prototype._buildRawMsgReq=function(){return"CRS";},Cloudy.prototype._buildData=function(t){for(var e=[],o=0;o<t.length;o++){e.push(t.charCodeAt(o));}return e.push(13),e.push(3),new Buffer(e);},Cloudy.prototype._sendPacket=function(t,e){if(this._socket){this._logger.log("trace","send packet:"+t);var o=this._buildData(t);this._socket.write(o,"binary"),e();}else{var r=this;this._connect(function(o){o?e(o):r._sendPacket(t,e);});}},Cloudy.prototype._connect=function(t){this._socket&&(this._socket.end(),this._socket=null);var e=this,o={port:this._port,host:this._ip},r=require("net").connect(o);return r.setTimeout(5e3),r.__connected=!1,r.setEncoding("hex"),r.on("connect",function(){e._logger.log("trace","connect to cloudy:"+e._ip),r.__connected=!0,e._socket=r,t();}),r.on("data",function(t){e._logger.log("trace","receive from cloudy "+(r.__disconnected?"(closed)":"")+":"+e._ip+" data:"+t),r.__disconnected||e._packetBuffer._onSocketData(t);}),r.on("error",function(o){r.__connected?(e._logger.log("trace","cloudy"+(r.__disconnected?"(closed)":"")+":"+e._ip+" error:"+o.message),r.destroy(),r.__disconnected||(r.__disconnected=!0,e._socket=null,e._packetBuffer._onSocketError(o))):(e._logger.log("trace","cloudy:"+e._ip+" connection error:"+o.message),t(o));}),r.on("timeout",function(){r.__connected?(e._logger.log("trace","cloudy"+(r.__disconnected?"(closed)":"")+":"+e._ip+" data timeout"),r.__disconnected||e._packetBuffer._onSocketTimeout()):(e._logger.log("trace","cloudy:"+e._ip+" connection timeout"),r.destroy&&r.destroy(),t(new Error("timeout")));}),r.on("close",function(){e._logger.log("trace","cloudy"+(r.__disconnected?"(closed)":"")+":"+e._ip+" close socket"),r.__disconnected||(r.__disconnected=!0,e._socket=null,e._packetBuffer._onSocketClose(r));}),r._doConnect&&"function"==typeof r._doConnect&&r._doConnect(),r;},Cloudy.prototype._disconnect=function(){this._logger.log("debug","disconnect socket"),this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null);},Cloudy.prototype.toJSON=function(){return{sys:"cloudy",ip:this._ip,port:this._port};},Cloudy.prototype.equalsTo=function(t){return!!t&&t instanceof Cloudy&&this._ip==t._ip&&this._port==t._port;},Cloudy;}(),xnm.aio.yellowstone.Handler=function(){var Handler=function Handler(){};return Handler.prototype.Cloudy=xnm.aio.yellowstone.Cloudy,Handler.prototype.devicemanager=null,Handler.prototype.registModule=function(t){t.register("cloudy","yellowstone");},Handler.prototype.resolveGateway=function(t){return t&&t.ip?new xnm.aio.yellowstone.Cloudy(t.ip,t.port):null;},Handler.prototype.getDeviceCommands=function(t,e){var o=this.devicemanager.applyUIFilter(t,{catagory:"command",elems:"*"}),r=o?o.command:[];e&&e(null,r);},Handler.prototype.getDeviceStatus=function(t,e){var o=this.devicemanager.applyUIFilter(t,{catagory:"status",elems:"*"}),r=o?o.status:[];e&&e(null,r);},Handler.prototype.getGatewayCommands=function(t,e){var o=this.devicemanager.applyUIFilterGateway(t,{catagory:"command",elems:"*"}),r=o?o.command:[];e&&e(null,r);},Handler.prototype.getGatewayStatus=function(t,e){var o=this.devicemanager.applyUIFilterGateway(t,{catagory:"status",elems:"*"}),r=o?o.status:[];e&&e(null,r);},Handler.prototype.doCommand=function(t,e,o,r){var i=this.resolveGateway(t);i?i.executeCommandCreator(e,o,function(t){r&&r(t);}):r&&r(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(t,e,o,r,i){var a=this.resolveGateway(e);if(a){var n=[{id:t,device:o,status:r}];a.getStatesCreator(null,n,function(t,e){t?i&&i(t):i&&i(null,e[0]);});}else i&&i(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(t,e){this.resolveGateway(t)?e&&e(null,this.devicemanager.BG_LIST):e&&e(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.yellowstone.Handler());