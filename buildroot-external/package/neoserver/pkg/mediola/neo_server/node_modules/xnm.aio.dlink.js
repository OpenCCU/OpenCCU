var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.dlink=xnm.aio.dlink||{},xnm.aio.dlink.WifiDevice=function(){var Device=function Device(t){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiDevice"),t&&(this.ip=t.ip,this.port=t.port,this.port||(this.port=80),this.username=t.username,this.username||(this.username="admin"),this.password=t.password,this.model=t.model,this.mac=t.mac),this._challenge=null,this._privateKey=null,this._cookie=null,this._logginTime=null,this._loginRunning=!1,this._loginCallbacks=[];};return Device.prototype.HNAP_PATH="/HNAP1",Device.prototype.HNAP_METHOD="POST",Device.prototype.HNAP1_XMLNS="http://purenetworks.com/HNAP1/",Device.prototype.HNAP_LOGIN_ACTION="Login",Device.prototype.toJSON=function(){return{sys:"dlink",type:"wifi",model:this.model,mac:this.mac,ip:this.ip,port:this.port,username:this.username,password:this.password};},Device.prototype.equalsTo=function(t){return!!t&&t instanceof Device&&this.type==t.type&&this.data==t.data&&this.ip==t.ip&&this.port==t.port&&this.username==t.username&&this.password==t.password;},Device.prototype.getStatesCreator=function(t,e,i){for(var n=[],o=0;o<e.length;o++){if(e[o]&&e[o].id&&e[o].status&&e[o].status.value){var a=e[o].status.value;-1==n.indexOf(a)&&n.push(a);}}this._getStates(n,function(t,n){for(var o=[],a=0;a<e.length;a++){if(e[a]&&e[a].id){var r="?";if(n&&e[a].status&&e[a].status.value){var s=e[a].status.value;null!=n[s]&&void 0!==n[s]&&(r=n[s]);}o.push({id:e[a].id,status:r});}}i&&i(null,o);});},Device.prototype._getModuleProfile=function(t,e){this._doAction("GetModuleProfile",this._requestBody("GetModuleProfile",this._moduleParameters(t)),"GetModuleProfileResponse",function(t,i){if(t)e&&e(t);else if(i){var n=i.find("GetModuleProfileResult");if(n&&0!=n.length)"OK"==$(n[0]).text()?e&&e(null,i):e&&e(new Error("get module profile fail"));else e&&e(new Error("get module profile without GetModuleProfileResult"));}else e&&e(new Error("get module profile format error"));});},Device.prototype._moduleParameters=function(t){return"<ModuleID>"+t+"</ModuleID>";},Device.prototype._doAction=function(t,e,i,n){if(this._logginTime){var o=new Date().getTime()-this._logginTime;(o<0||o>3e5)&&(!0,this._challenge=null,this._privateKey=null,this._cookie=null,this._logginTime=null);}if(this._challenge&&this._privateKey&&this._cookie)this._soapAction(t,e,i,n);else{var a=this;this._login(function(o){o?n&&n(o):a._doAction(t,e,i,n);});}},Device.prototype._loginRequest=function(){return"<Action>request</Action><Username>"+this.username+"</Username><LoginPassword></LoginPassword><Captcha></Captcha>";},Device.prototype._loginParameters=function(){var t=require("x.crypt.js").HMAC_MD5(this._privateKey,this._challenge);return"<Action>login</Action><Username>"+this.username+"</Username><LoginPassword>"+t.toUpperCase()+"</LoginPassword><Captcha></Captcha>";},Device.prototype._handleLoginResult=function(t){var e=t.find("Challenge")[0];if(!e)return!1;e=$(e).text(),this._challenge=e;var i=t.find("PublicKey")[0];if(!i)return!1;i=$(i).text();var n=t.find("Cookie")[0];if(!n)return!1;n=$(n).text(),this._cookie=n;var o=require("x.crypt.js");return this._privateKey=o.HMAC_MD5(i+this.password,e).toUpperCase(),!0;},Device.prototype._login=function(t){if(t&&-1==this._loginCallbacks.indexOf(t)&&this._loginCallbacks.push(t),!this._loginRunning){this._loginRunning=!0;var e=this;this._soapAction(this.HNAP_LOGIN_ACTION,this._requestBody(this.HNAP_LOGIN_ACTION,this._loginRequest()),"LoginResponse",function(t,i){var n;return t?(e._loginRunning=!1,n=e._loginCallbacks,e._loginCallbacks=[],void n.forEach(function(e){e&&e(t);})):e._handleLoginResult(i)?(e._logginTime=new Date().getTime(),void e._soapAction(e.HNAP_LOGIN_ACTION,e._requestBody(e.HNAP_LOGIN_ACTION,e._loginParameters()),"LoginResult",function(t,i){!t&&i&&"success"!=i.text()&&(t=new Error("login failed")),e._loginRunning=!1;var n=e._loginCallbacks;e._loginCallbacks=[],n.forEach(function(e){e&&e(t);});})):(t=new Error("LoginResponse format error"),e._loginRunning=!1,n=e._loginCallbacks,e._loginCallbacks=[],void n.forEach(function(e){e&&e(t);}));});}},Device.prototype._requestBody=function(t,e){return'<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"><soap:Body><'+t+' xmlns="'+this.HNAP1_XMLNS+'">'+e+"</"+t+"></soap:Body></soap:Envelope>";},Device.prototype._getHnapAuth=function(t,e){var i=new Date(),n=Math.round(i.getTime()/1e3);return require("x.crypt.js").HMAC_MD5(e,n+t).toUpperCase()+" "+n;},Device.prototype._soapAction=function(t,e,i,n){var o={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"'+this.HNAP1_XMLNS+t+'"'};this._privateKey&&(o.HNAP_AUTH=this._getHnapAuth('"'+this.HNAP1_XMLNS+t+'"',this._privateKey)),this._cookie&&(o.Cookie="uid="+this._cookie);var a=this;this._doRequest(this.HNAP_METHOD,this.HNAP_PATH,o,e,function(o,r,s){if(o)n&&n(o);else{if(401==s)return a._logger.log("warn","unauthorized soap action"),a._challenge=null,a._privateKey=null,a._cookie=null,void a._login(function(o){o?n&&n(o):a._soapAction(t,e,i,n);});if(200!=s)return a._logger.log("warn","http request error with status code:"+s),void(n&&n(new Error("http request error with status code:"+s)));try{var u=null;$($($.parseXML(r)).children()[0]).find(i).each(function(){u=$(this);}),u?n&&n(null,u):n&&n(new Error("no response element:"+i));}catch(t){n&&n(t);}}});},Device.prototype._doRequest=function(t,e,i,n,o){this._reqBuffer||(this._reqBuffer=[],this._totalReqNo=0);for(var a=0,r=0;r<this._reqBuffer.length;r++){this._reqBuffer[r].running&&a++;}var s={method:t,path:e,headers:i,data:n,callback:o,running:!1,no:this._totalReqNo++};this._reqBuffer.push(s),a<10&&this._doNextReq();},Device.prototype._doNextReq=function(){for(var t=this,e=null,i=0;i<this._reqBuffer.length;i++){if(!this._reqBuffer[i].running){e=this._reqBuffer[i];break;}}if(e){e.running=!0;var cb=function cb(i,n,o){e.callback&&e.callback(i,n,o);var a=t._reqBuffer.indexOf(cb.__req);t._reqBuffer.splice(a,1),t._doNextReq();};cb.__req=e,this._doRequest_(e.method,e.path,e.headers,e.data,cb);}},Device.prototype._doRequest_=function(t,e,i,n,o){var a=this,r="http://"+this.ip+":"+this.port+e;this._logger.log("trace","send "+t+" to url:"+r),this._logger.log("trace","with headers:"+JSON.stringify(i)),this._logger.log("trace","with data:"+n);var s=o,u={host:this.ip,port:this.port,path:e,method:t,headers:i};u.headers||(u.headers={}),u.headers["Content-Type"]="text/xml",u.headers["Content-Length"]=n.length,u.headers["User-Agent"]="mediola",u.headers.Connection="close";var l="",c=require("http").request(u,function(t){t.on("data",function(t){l+=t;}),t.on("end",function(){a._logger.log("trace","http reponse status code:"+t.statusCode),a._logger.log("trace","http reponse:"+l),s&&s(null,l,t.statusCode),s=null;});});c.setTimeout&&c.setTimeout(2e4,function(){c.abort();}),c.on&&"function"==typeof c.on&&c.on("error",function(t){t||(t=new Error("http request error")),s&&s(t),s=null;}),c.write(n),c.end();},Device.parseJSON=function(t){if(!(t&&"wifi"==t.type&&t.data&&t.ip&&t.password))return null;switch(t.data){case"switch":return new xnm.aio.dlink.WifiPlug(t);case"motion":return new xnm.aio.dlink.WifiMotion(t);case"siren":return new xnm.aio.dlink.WifiSiren(t);case"water":return new xnm.aio.dlink.WifiWater(t);case"hub":return new xnm.aio.dlink.WifiHub(t);default:return null;}},Device;}(),xnm.aio.dlink.WifiPlug=function(){var WifiPlug=function WifiPlug(t){xnm.aio.dlink.WifiDevice.call(this,t),this._getSettingsCbs=[],this._getReadyCbs=[],this._getTempCbs=[],this._getPowerCbs=[],this._getTotalPCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiPlug");};return(WifiPlug.prototype=new xnm.aio.dlink.WifiDevice()).constructor=WifiPlug,WifiPlug.prototype.toJSON=function(){var t=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);return t.data="switch",t;},WifiPlug.prototype.executeCommandCreator=function(t,e,i){if(e&&e.value){var n=this;switch(e.value){case"on":case"off":xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0)?"on"==e.value?this._on(i):this._off(i):this._getSocketSettings(function(o){o?i&&i(o):n.executeCommandCreator(t,e,i);});break;case"toggle":this._getOnOffState(function(e,o){e?i&&i(e):n.executeCommandCreator(t,{value:"off"==o?"on":"off"},i);});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command json format invalid"));},WifiPlug.prototype._controlParameters=function(t,e,i,n){return this._moduleParameters(t)+"<NickName>"+e+"</NickName><Description>"+i+"</Description><OPStatus>"+n+"</OPStatus><Controller>1</Controller>";},WifiPlug.prototype._on=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),i=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,e.nickName,e.description,!0)),"SetSocketSettingsResult",function(e,n){e||n&&"OK"==n.text()||(e=new Error("turn plug on failed")),e||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,0,{opStatus:"true"}),t&&t(e);});},WifiPlug.prototype._off=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0),i=this;this._doAction("SetSocketSettings",this._requestBody("SetSocketSettings",this._controlParameters(1,e.nickName,e.description,!1)),"SetSocketSettingsResult",function(e,n){e||n&&"OK"==n.text()||(e=new Error("turn plug off failed")),e||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,0,{opStatus:"false"}),t&&t(e);});},WifiPlug.prototype._getStates=function(t,e){if(t&&0!=t.length)for(var i={},n=0,cb=function cb(){++n==t.length&&e&&e(null,i);},o=0;o<t.length;o++){switch(t[o]){case"ready":this._getDeviceReadyState(function(t,e){!t&&e&&(i.ready=e),cb();});break;case"state":this._getOnOffState(function(t,e){!t&&e&&(i.state=e),cb();});break;case"temp":this._getTempState(function(t,e){!t&&e&&(i.temp=e),cb();});break;case"power":this._getCurrentPowerState(function(t,e){!t&&e&&(i.power=e),cb();});break;case"totalPower":this._getTotalPowerState(function(t,e){!t&&e&&(i.totalPower=e),cb();});break;default:cb();}}else e&&e(null,{});},WifiPlug.prototype._getSocketSettings=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(e&&e.opStatus&&e.nickName&&e.description)t&&t(null,e);else{var i=this._getSettingsCbs.length;if(t&&-1==this._getSettingsCbs.indexOf(t)&&this._getSettingsCbs.push(t),0==i){var n=this;this._doAction("GetSocketSettings",this._requestBody("GetSocketSettings",this._moduleParameters(1)),"GetSocketSettingsResponse",function(t,e){var i=n._getSettingsCbs;if(n._getSettingsCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get switch on/off state result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetSocketSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get socket settings failed"),void i.forEach(function(e){e&&e(t);});var a=null,r=null,s=null;e.find("NickName").each(function(){r||(r=$(this).text());}),e.find("Description").each(function(){s||(s=$(this).text());}),e.find("OPStatus").each(function(){a||(a=$(this).text());});var u={nickName:r,description:s,opStatus:a};xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,0,u),i.forEach(function(t){t&&t(null,u);});}});}}},WifiPlug.prototype._getDeviceReadyState=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(e&&void 0!==e.ready&&null!=e.ready)t&&t(null,e.ready);else{var i=this._getReadyCbs.length;if(t&&-1==this._getReadyCbs.indexOf(t)&&this._getReadyCbs.push(t),0==i){var n=this;this._doAction("IsDeviceReady",this._requestBody("IsDeviceReady",""),"IsDeviceReadyResult",function(t,e){var i=n._getReadyCbs;if(n._getReadyCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get device ready state result format error"),void i.forEach(function(e){e&&e(t);});var o="OK"==e.text()?"true":"false";xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,0,{ready:o}),i.forEach(function(t){t&&t(null,o);});}});}}},WifiPlug.prototype._getOnOffState=function(t){this._getSocketSettings(function(e,i){if(e)t&&t(e);else{var n=i.opStatus;n="true"==n?"on":"false"==n?"off":"?",t&&t(null,n);}});},WifiPlug.prototype._getTempState=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(e&&void 0!==e.temp&&null!=e.temp)t&&t(null,e.temp);else{var i=this._getTempCbs.length;if(t&&-1==this._getTempCbs.indexOf(t)&&this._getTempCbs.push(t),0==i){var n=this;this._doAction("GetCurrentTemperature",this._requestBody("GetCurrentTemperature",this._moduleParameters(3)),"CurrentTemperature",function(t,e){var i=n._getTempCbs;if(n._getTempCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get temperature state result format error"),void i.forEach(function(e){e&&e(t);});xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,0,{temp:e.text()}),i.forEach(function(t){t&&t(null,e.text());});}});}}},WifiPlug.prototype._getCurrentPowerState=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(e&&void 0!==e.power&&null!=e.power)t&&t(null,e.power);else{var i=this._getPowerCbs.length;if(t&&-1==this._getPowerCbs.indexOf(t)&&this._getPowerCbs.push(t),0==i){var n=this;this._doAction("GetCurrentPowerConsumption",this._requestBody("GetCurrentPowerConsumption",this._moduleParameters(2)),"CurrentConsumption",function(t,e){var i=n._getPowerCbs;if(n._getPowerCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get current power state result format error"),void i.forEach(function(e){e&&e(t);});xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,0,{power:e.text()}),i.forEach(function(t){t&&t(null,e.text());});}});}}},WifiPlug.prototype._getTotalPowerState=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,0);if(e&&void 0!==e.totalPower&&null!=e.totalPower)t&&t(null,e.totalPower);else{var i=this._getTotalPCbs.length;if(t&&-1==this._getTotalPCbs.indexOf(t)&&this._getTotalPCbs.push(t),0==i){var n=this;this._doAction("GetPMWarningThreshold",this._requestBody("GetPMWarningThreshold",this._moduleParameters(2)),"TotalConsumption",function(t,e){var i=n._getTotalPCbs;if(n._getTotalPCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get total power state result format error"),void i.forEach(function(e){e&&e(t);});xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,0,{totalPower:e.text()}),i.forEach(function(t){t&&t(null,e.text());});}});}}},WifiPlug;}(),xnm.aio.dlink.WifiMotion=function(){var Motion=function Motion(t){xnm.aio.dlink.WifiDevice.call(this,t),this._getSettingsCbs=[],this._getLastDetectCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiMotion");};return(Motion.prototype=new xnm.aio.dlink.WifiDevice()).constructor=Motion,Motion.prototype.toJSON=function(){var t=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);return t.data="motion",t;},Motion.prototype.executeCommandCreator=function(t,e,i){if(e&&e.value){var n=this;switch(e.value){case"activate":case"deactivate":case"actToggle":case"sensTo":case"sensUp":case"sensDown":this._getMotionDetectorSettings(function(t,o){var a;if(t)i&&i(t);else switch(e.value){case"activate":case"deactivate":n._setDetectorActive("activate"==e.value,i);break;case"actToggle":n._setDetectorActive("true"!=o.opStatus,i);break;case"sensTo":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));(a=parseInt(e.ext))<=0&&(a=1),a>100&&(a=100),n._setDetectorSensitivity(a,i);break;case"sensUp":case"sensDown":a=parseInt(o.sensitivity),"sensUp"==e.value?a+=5:a-=5,a<=0&&(a=1),a>100&&(a=100),n._setDetectorSensitivity(a,i);}});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command json format invalid"));},Motion.prototype._controlParameters=function(t,e){return this._moduleParameters(t)+"<NickName>"+e.nickName+"</NickName><Description>"+e.description+"</Description><OPStatus>"+e.opStatus+"</OPStatus><Sensitivity>"+e.sensitivity+"</Sensitivity><Backoff>"+e.backoff+"</Backoff>";},Motion.prototype._getStates=function(t,e){if(t&&0!=t.length)for(var i={},n=0,cb=function cb(){++n==t.length&&e&&e(null,i);},o=0;o<t.length;o++){switch(t[o]){case"active":this._getActiveState(function(t,e){!t&&e&&(i.active=e),cb();});break;case"sens":this._getSensitivityState(function(t,e){!t&&e&&(i.sens=e),cb();});break;case"dectTime":case"dectTimeStr":this._getDetectTime(function(t,e){!t&&e&&(i.dectTime=e,i.dectTimeStr=new Date(1e3*e).toLocaleString()),cb();});break;default:cb();}}else e&&e(null,{});},Motion.prototype._setDetectorActive=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);i.opStatus=t+"",this._setMotionDetectorSettings(i,e);},Motion.prototype._setDetectorSensitivity=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);i.sensitivity=t+"",this._setMotionDetectorSettings(i,e);},Motion.prototype._setMotionDetectorSettings=function(t,e){var i=this;this._doAction("SetMotionDetectorSettings",this._requestBody("SetMotionDetectorSettings",this._controlParameters(1,t)),"SetMotionDetectorSettingsResult",function(n,o){n||o&&"OK"==o.text()||(n=new Error("turn plug on failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,1,t),e&&e(n);});},Motion.prototype._getActiveState=function(t){this._getMotionDetectorSettings(function(e,i){if(e)t&&t(e);else{var n=i.opStatus;t&&t(null,n);}});},Motion.prototype._getSensitivityState=function(t){this._getMotionDetectorSettings(function(e,i){if(e)t&&t(e);else{var n=i.sensitivity;t&&t(null,n);}});},Motion.prototype._getMotionDetectorSettings=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.backoff&&e.sensitivity&&e.opStatus&&e.nickName&&e.description)t&&t(null,e);else{var i=this._getSettingsCbs.length;if(t&&-1==this._getSettingsCbs.indexOf(t)&&this._getSettingsCbs.push(t),0==i){var n=this;this._doAction("GetMotionDetectorSettings",this._requestBody("GetMotionDetectorSettings",this._moduleParameters(1)),"GetMotionDetectorSettingsResponse",function(t,e){var i=n._getSettingsCbs;if(n._getSettingsCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get motion detector settings result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetMotionDetectorSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get socket settings failed"),void i.forEach(function(e){e&&e(t);});var a={nickName:null,description:null,opStatus:null,sensitivity:null,backoff:null};e.find("NickName").each(function(){a.nickName=$(this).text();}),e.find("Description").each(function(){a.description=$(this).text();}),e.find("OPStatus").each(function(){a.opStatus=$(this).text();}),e.find("Sensitivity").each(function(){a.sensitivity=$(this).text();}),e.find("Backoff").each(function(){a.backoff=$(this).text();}),xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,a),i.forEach(function(t){t&&t(null,a);});}});}}},Motion.prototype._getDetectTime=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.lastDetect)t&&t(null,e.lastDetect);else{var i=this._getLastDetectCbs.length;if(t&&-1==this._getLastDetectCbs.indexOf(t)&&this._getLastDetectCbs.push(t),0==i){var n=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(t,e){var i=n._getLastDetectCbs;if(n._getLastDetectCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get motion detector last detection result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetLatestDetectionResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get motion detector last detection failed"),void i.forEach(function(e){e&&e(t);});var a=e.find("LatestDetectTime");if(!a||!a[0])return t=new Error("get motion detector no LatestDetectTime parameter"),void i.forEach(function(e){e&&e(t);});var r=$(a[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,{lastDetect:r}),i.forEach(function(t){t&&t(null,r);});}});}}},Motion;}(),xnm.aio.dlink.WifiSiren=function(){var Siren=function Siren(t){xnm.aio.dlink.WifiDevice.call(this,t),this._getSettingsCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiSiren");};return(Siren.prototype=new xnm.aio.dlink.WifiDevice()).constructor=Siren,Siren.prototype.TONE=["emergency","fire","ambulance","police","doorbell","acoustic_signal"],Siren.prototype.toJSON=function(){var t=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);return t.data="siren",t;},Siren.prototype.executeCommandCreator=function(t,e,i){if(e&&e.value){var n,o=this;switch(e.value){case"activate":case"deactivate":case"actToggle":case"setTone":case"setDuration":case"setDurationP":case"setVolume":case"volumeUp":case"volumeDown":case"play":this._getSirenAlarmSettings(function(t,a){if(t)i&&i(t);else switch(e.value){case"activate":case"deactivate":o._setSirenActive("activate"==e.value,function(t){i&&i(t);});break;case"actToggle":o._setSirenActive("true"!=a.opStatus,function(t){i&&i(t);});break;case"setVolume":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));(n=parseInt(e.ext))<0&&(n=0),n>100&&(n=100),o._setSirenVolumn(n,function(t){i&&i(t);});break;case"volumeUp":case"volumeDown":(n=parseInt(a.volume))>100&&(n=100),"volumeUp"==e.value?n+=5:n-=5,n<0&&(n=0),n>100&&(n=100),o._setSirenVolumn(n,function(t){i&&i(t);});break;case"setDuration":case"setDurationP":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));o._setSirenDuration(e.ext,function(t){i&&i(t);});break;case"setTone":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));o._setSirenTone(e.ext,function(t){i&&i(t);});break;case"play":o._doAlarm(function(t){i&&i(t);});}});break;case"stop":this._stopAlarm(function(t){i&&i(t);});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command invalid"));},Siren.prototype._controlParameters=function(t,e,i,n,o,a,r){return this._moduleParameters(t)+"<NickName>"+e+"</NickName><Description>"+i+"</Description><DefaultSound>"+n+"</DefaultSound><OPStatus>"+a+"</OPStatus><Volume>"+o+"</Volume><Duration>"+r+"</Duration>";},Siren.prototype._soundPlayParameters=function(t,e,i,n){return this._moduleParameters(t)+"<SoundType>"+e+"</SoundType><Volume>"+i+"</Volume><Duration>"+n+"</Duration><Controller>1</Controller>";},Siren.prototype._dissmissParameters=function(t){return this._moduleParameters(t)+"<Controller>1</Controller>";},Siren.prototype._doAlarm=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1),i=this;this._doAction("SetSoundPlay",this._requestBody("SetSoundPlay",this._soundPlayParameters(1,e.defaultSound,e.volume,e.duration)),"SetSoundPlayResult",function(e,n){e||n&&"OK"==n.text()||(e=new Error("play siren failed")),e||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,1,{alarm:"true"}),t&&t(e);});},Siren.prototype._stopAlarm=function(t){var e=this;this._doAction("SetAlarmDismissed",this._requestBody("SetAlarmDismissed",this._dissmissParameters(1)),"SetAlarmDismissedResult",function(i,n){i||n&&"OK"==n.text()||(i=new Error("stop siren failed")),i||xnm.aio.dlink._SettingsBuffer.setSettings(e.ip,1,{alarm:"false"}),t&&t(i);});},Siren.prototype._setSirenActive=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);i.opStatus=t+"",this._setSirenAlarmSettings(i,e);},Siren.prototype._setSirenVolumn=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);i.volume=t+"",this._setSirenAlarmSettings(i,e);},Siren.prototype._setSirenDuration=function(t,e){var i=null;switch(t){case"3s":i=3;break;case"10s":i=10;break;case"30s":i=30;break;case"1min":i=60;break;case"repeat":i=88888;break;default:if(i=parseInt(t),isNaN(i))return void(e&&e(new Error("invalid duration")));i<=0&&(i=1),i>86400&&(i=86400);}var n=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);n.duration=i+"",this._setSirenAlarmSettings(n,e);},Siren.prototype._setSirenTone=function(t,e){var i=this.TONE.indexOf(t)+1;if(i){var n=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);n.defaultSound=i+"",this._setSirenAlarmSettings(n,e);}else e&&e(new Error("no such tone"));},Siren.prototype._setSirenAlarmSettings=function(t,e){var i=this;this._doAction("SetSirenAlarmSettings",this._requestBody("SetSirenAlarmSettings",this._controlParameters(1,t.nickName,t.description,t.defaultSound,t.volume,t.opStatus,t.duration)),"SetSirenAlarmSettingsResult",function(n,o){n||o&&"OK"==o.text()||(n=new Error("set siren settings failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,1,t),e&&e(n);});},Siren.prototype._getStates=function(t,e){if(t&&0!=t.length)for(var i={},n=0,cb=function cb(){++n==t.length&&e&&e(null,i);},o=this,a=!1,r=0;r<t.length;r++){switch(t[r]){case"active":case"tone":case"volume":case"duration":case"durationStr":case"alarm":a?cb():(a=!0,this._getSirenAlarmSettings(function(t,e){if(!t&&e)if(i.active=e.opStatus,i.tone=o.TONE[parseInt(e.defaultSound)-1],i.volume=parseInt(e.volume),999==i.volume&&(i.volume=100),i.alarm=e.alarm,i.duration=parseInt(e.duration),i.duration<60)i.durationStr=i.duration+"s";else if(88888==i.duration||9999==i.duration)i.durationStr="repeat";else{var n=Math.floor(i.duration/60),a=i.duration-60*n;i.durationStr=(n?n+"m":"")+(a?a+"s":"");}cb();}));break;default:cb();}}else e&&e(null,{});},Siren.prototype._getSirenAlarmSettings=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.defaultSound&&e.opStatus&&e.nickName&&e.description&&e.volume&&e.duration&&e.alarm)t&&t(null,e);else{var i=this._getSettingsCbs.length;if(t&&-1==this._getSettingsCbs.indexOf(t)&&this._getSettingsCbs.push(t),0==i){var n=this;this._doAction("GetSirenAlarmSettings",this._requestBody("GetSirenAlarmSettings",this._moduleParameters(1)),"GetSirenAlarmSettingsResponse",function(t,e){var i=n._getSettingsCbs;if(n._getSettingsCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get siren settings result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetSirenAlarmSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get siren settings failed"),void i.forEach(function(e){e&&e(t);});var a={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};e.find("NickName").each(function(){a.nickName=$(this).text();}),e.find("Description").each(function(){a.description=$(this).text();}),e.find("OPStatus").each(function(){a.opStatus=$(this).text();}),e.find("Volume").each(function(){a.volume=$(this).text();}),e.find("Duration").each(function(){a.duration=$(this).text();}),e.find("DefaultSound").each(function(){a.defaultSound=$(this).text();}),e.find("IsSounding").each(function(){a.alarm=$(this).text();}),xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,a),i.forEach(function(t){t&&t(null,a);});}});}}},Siren;}(),xnm.aio.dlink.WifiWater=function(){var Water=function Water(t){xnm.aio.dlink.WifiDevice.call(this,t),this._getSettingsCbs=[],this._getStateCbs=[],this._getLastDetectCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiWater");};return(Water.prototype=new xnm.aio.dlink.WifiDevice()).constructor=Water,Water.prototype.toJSON=function(){var t=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);return t.data="water",t;},Water.prototype.executeCommandCreator=function(t,e,i){if(e&&e.value){var n=this;switch(e.value){case"activate":case"deactivate":case"actToggle":this._getWaterDetectorSettings(function(t,o){if(t)i&&i(t);else switch(e.value){case"activate":case"deactivate":n._setDetectorActive("activate"==e.value,i);break;case"actToggle":n._setDetectorActive("true"!=o.opStatus,i);}});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command json format invalid"));},Water.prototype._controlParameters=function(t,e){return this._moduleParameters(t)+"<NickName>"+e.nickName+"</NickName><Description>"+e.description+"</Description><OPStatus>"+e.opStatus+"</OPStatus>";},Water.prototype._setDetectorActive=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);i.opStatus=t+"",this._setWaterDetectorSettings(i,e);},Water.prototype._setWaterDetectorSettings=function(t,e){var i=this;this._doAction("SetWaterDetectorSettings",this._requestBody("SetWaterDetectorSettings",this._controlParameters(1,t)),"SetWaterDetectorSettingsResult",function(n,o){n||o&&"OK"==o.text()||(n=new Error("turn plug on failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(i.ip,1,t),e&&e(n);});},Water.prototype._getStates=function(t,e){if(t&&0!=t.length)for(var i={},n=0,cb=function cb(){++n==t.length&&e&&e(null,i);},o=0;o<t.length;o++){switch(t[o]){case"active":this._getActiveState(function(t,e){!t&&e&&(i.active=e),cb();});break;case"state":this._getWaterDetectorState(function(t,e){!t&&e&&(i.state="true"==e?"water":"dry"),cb();});break;case"dectTime":case"dectTimeStr":this._getDetectTime(function(t,e){!t&&e&&(i.dectTime=e,i.dectTimeStr=new Date(1e3*e).toLocaleString()),cb();});break;default:cb();}}else e&&e(null,{});},Water.prototype._getActiveState=function(t){this._getWaterDetectorSettings(function(e,i){if(e)t&&t(e);else{var n=i.opStatus;t&&t(null,n);}});},Water.prototype._getDetectTime=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.lastDetect)t&&t(null,e.lastDetect);else{var i=this._getLastDetectCbs.length;if(t&&-1==this._getLastDetectCbs.indexOf(t)&&this._getLastDetectCbs.push(t),0==i){var n=this;this._doAction("GetLatestDetection",this._requestBody("GetLatestDetection",this._moduleParameters(1)),"GetLatestDetectionResponse",function(t,e){var i=n._getLastDetectCbs;if(n._getLastDetectCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get water detector detection time result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetLatestDetectionResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get water detector detection time failed"),void i.forEach(function(e){e&&e(t);});var a=e.find("LatestDetectTime");if(!a||!a[0])return t=new Error("get water detector no LatestDetectTime parameter"),void i.forEach(function(e){e&&e(t);});var r=$(a[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,{lastDetect:r}),i.forEach(function(t){t&&t(null,r);});}});}}},Water.prototype._getWaterDetectorState=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.watering)t&&t(null,e.watering);else{var i=this._getStateCbs.length;if(t&&-1==this._getStateCbs.indexOf(t)&&this._getStateCbs.push(t),0==i){var n=this;this._doAction("GetWaterDetectorState",this._requestBody("GetWaterDetectorState",this._moduleParameters(1)),"GetWaterDetectorStateResponse",function(t,e){var i=n._getStateCbs;if(n._getStateCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get water detector state result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetWaterDetectorStateResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get water detector state failed"),void i.forEach(function(e){e&&e(t);});var a=e.find("IsWater");if(!a||!a[0])return t=new Error("get water detector no IsWater parameter"),void i.forEach(function(e){e&&e(t);});var r=$(a[0]).text();xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,{watering:r}),i.forEach(function(t){t&&t(null,r);});}});}}},Water.prototype._getWaterDetectorSettings=function(t){var e=xnm.aio.dlink._SettingsBuffer.getSettings(this.ip,1);if(e&&e.opStatus&&e.nickName&&e.description)t&&t(null,e);else{var i=this._getSettingsCbs.length;if(t&&-1==this._getSettingsCbs.indexOf(t)&&this._getSettingsCbs.push(t),0==i){var n=this;this._doAction("GetWaterDetectorSettings",this._requestBody("GetWaterDetectorSettings",this._moduleParameters(1)),"GetWaterDetectorSettingsResponse",function(t,e){var i=n._getSettingsCbs;if(n._getSettingsCbs=[],t)i.forEach(function(e){e&&e(t);});else{if(!e)return t=new Error("get water detector settings result format error"),void i.forEach(function(e){e&&e(t);});var o=e.find("GetWaterDetectorSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return t=new Error("get water detector settings failed"),void i.forEach(function(e){e&&e(t);});var a={nickName:null,description:null,opStatus:null};e.find("NickName").each(function(){a.nickName=$(this).text();}),e.find("Description").each(function(){a.description=$(this).text();}),e.find("OPStatus").each(function(){a.opStatus=$(this).text();}),xnm.aio.dlink._SettingsBuffer.setSettings(n.ip,1,a),i.forEach(function(t){t&&t(null,a);});}});}}},Water;}(),xnm.aio.dlink.WifiHub=function(){var WifiHub=function WifiHub(t){xnm.aio.dlink.WifiDevice.call(this,t),"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.WifiHub");};return(WifiHub.prototype=new xnm.aio.dlink.WifiDevice()).constructor=WifiHub,WifiHub.prototype.toJSON=function(){var t=xnm.aio.dlink.WifiDevice.prototype.toJSON.call(this);return t.data="hub",t;},WifiHub.prototype.listZwaveDevice=function(t){this._getModuleProfile(0,function(e,i){if(e)t&&t(e);else{var n=[];i.find("ModuleProfile").each(function(){var t=$(this),e=t.find("ModuleID");e&&e[0]&&(e=$(e[0]).text());var i=t.find("ModuleSubType");switch(i&&i[0]&&(i=$(i[0]).text()),i){case"Contact Sensor":n.push({sys:"dlink",type:"zwave",data:"contact",model:"DCH-Z110",node_id:e.substr(0,e.length-2)});break;case"Motion Detector":n.push({sys:"dlink",type:"zwave",data:"motion",model:"DCH-Z120",node_id:e.substr(0,e.length-2)});break;case"Siren Alarm":n.push({sys:"dlink",type:"zwave",data:"siren",model:"DCH-Z510",node_id:e.substr(0,e.length-2)});}}),t&&t(null,n);}});},WifiHub.prototype.executeCommandCreator=function(t,e,i){if(t){var n=xnm.aio.dlink.ZwaveDevice.parseJSON(t);n?n.executeCommand(this,e,i):i&&i(new Error("deviceJSON invalid"));}else i&&i(new Error("gateway command not suppoort"));},WifiHub.prototype.getStatesCreator=function(t,e,i){for(var n,o={querys:[],dpts:[]},a={},r=0;r<e.length;r++){if(e[r]&&e[r].id&&e[r].device&&e[r].status){var s=e[r].device;if("wifi"==s.type&&"hub"==s.data)o.querys.push(e[r]),(n=e[r].status.value)&&-1==o.dpts.indexOf(n)&&o.dpts.push(n);else if("zwave"==s.type&&s.data&&s.node_id){var u=s.node_id+"@"+s.data,l=a[u];l||(a[u]={device:s,querys:[]},l=a[u]),l.querys.push(e[r]);}}}var c=this;this._getWifiStatesCreator(t,o,function(e,n){if(e)i&&i(e);else{var o=[];n&&(o=o.concat(n)),c._getZwaveStatesCreator(t,a,function(t,e){!t&&e&&(o=o.concat(e)),i&&i(null,o);});}});},WifiHub.prototype._getWifiStatesCreator=function(t,e,i){if(e&&e.querys&&0!=e.querys.length){var n=e.querys;this._getStates(e.dpts,function(t,e){for(var o=[],a=0;a<n.length;a++){if(n[a]&&n[a].id){var r="?";if(e&&n[a].status&&n[a].status.value){var s=n[a].status.value;null!=e[s]&&void 0!==e[s]&&(r=e[s]);}o.push({id:n[a].id,status:r});}}i&&i(null,o);});}else i&&i(null,[]);},WifiHub.prototype._getZwaveStatesCreator=function(t,e,i){var n=[],o=0,a=0;for(var r in e){e.hasOwnProperty(r)&&e[r]&&(n.push(e[r]),a++);}if(0!=a){var s=[],u=this,cb=function cb(){++o==a&&(i&&i(null,s),i=null);};n.forEach(function(e){if(e.device&&e.querys&&0!=e.querys.length){var i=xnm.aio.dlink.ZwaveDevice.parseJSON(e.device);i?i.getStatesCreator(u,t,e.querys,function(t,e){!t&&e&&(s=s.concat(e)),cb();}):cb();}else cb();});}else i&&i(null,[]);},WifiHub.prototype._getStates=function(t,e){t&&0!=t.length||e&&e(null,{});},WifiHub;}(),xnm.aio.dlink._SettingsBuffer={_buffer:{},getSettings:function getSettings(t,e){if(!this._buffer[t]||!this._buffer[t][e])return null;var i=this._buffer[t][e],n={},o=Math.round(new Date().getTime()/1e3),a=0;for(var r in i){if(i.hasOwnProperty(r)){var s=i[r];if(!s)continue;if(!s.time)continue;if(o-s.time>5)continue;a++,n[r]=s.value;}}return a?n:null;},setSettings:function setSettings(t,e,i){this._buffer[t]||(this._buffer[t]={}),this._buffer[t][e]||(this._buffer[t][e]={});var n=Math.round(new Date().getTime()/1e3);for(var o in i){i.hasOwnProperty(o)&&(this._buffer[t][e][o]||(this._buffer[t][e][o]={}),this._buffer[t][e][o].value=i[o],this._buffer[t][e][o].time=n);}}},xnm.aio.dlink.ZwaveDevice=function(){var Device=function Device(t){t&&(this.node_id=t.node_id),this._getTempCbs=[],this._getBriCbs=[],this._getBatCbs=[],this._getSabCbs=[];};return Device.prototype.getStatesCreator=function(t,e,i,n){for(var o=[],a=0;a<i.length;a++){if(i[a]&&i[a].id&&i[a].status&&i[a].status.value){var r=i[a].status.value;-1==o.indexOf(r)&&o.push(r);}}this._getStates(t,o,function(t,e){for(var o=[],a=0;a<i.length;a++){if(i[a]&&i[a].id){var r="?";if(e&&i[a].status&&i[a].status.value){var s=i[a].status.value;null!=e[s]&&void 0!==e[s]&&(r=e[s]);}o.push({id:i[a].id,status:r});}}n&&n(null,o);});},Device.prototype._moduleParameters=function(t){return"<ModuleID>"+t+"</ModuleID>";},Device.prototype._getTempState=function(t,e,i){this._logger.log("debug","get zwave "+e+" temperature");var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(n&&void 0!==n.temp&&null!=n.temp)i&&i(null,n.temp);else{var o=this._getTempCbs.length;if(i&&-1==this._getTempCbs.indexOf(i)&&this._getTempCbs.push(i),0==o){var a=this;t._doAction("GetCurrentTemperature",t._requestBody("GetCurrentTemperature",this._moduleParameters(e)),"CurrentTemperature",function(i,o){var r=a._getTempCbs;return a._getTempCbs=[],i?(a._logger.log("warn","get zwave "+e+" temperature error:"+i.stack),void r.forEach(function(t){t&&t(i);})):o?(n||(n={}),n.temp=o.text(),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,n),void r.forEach(function(t){t&&t(null,o.text());})):(a._logger.log("warn","get zwave "+e+" temperature result format error"),i=new Error("get contact temperature state result format error"),void r.forEach(function(t){t&&t(i);}));});}}},Device.prototype._getBriState=function(t,e,i){this._logger.log("debug","get zwave "+e+" brightness");var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(n&&void 0!==n.bri&&null!=n.bri)i&&i(null,n.bri);else{var o=this._getBriCbs.length;if(i&&-1==this._getBriCbs.indexOf(i)&&this._getBriCbs.push(i),0==o){var a=this;t._doAction("GetIllumination",t._requestBody("GetIllumination",this._moduleParameters(e)),"Illumination",function(i,o){var r=a._getTempCbs;return a._getTempCbs=[],i?(a._logger.log("warn","get zwave "+e+" brightness error:"+i.stack),void r.forEach(function(t){t&&t(i);})):o?(n||(n={}),n.bri=o.text(),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,n),void r.forEach(function(t){t&&t(null,o.text());})):(a._logger.log("warn","get zwave "+e+" brightness result format error"),i=new Error("get contact brightness state result format error"),void r.forEach(function(t){t&&t(i);}));});}}},Device.prototype._getBatteryState=function(t,e,i){this._logger.log("debug","get zwave "+e+" battery");var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(n&&void 0!==n.bat&&null!=n.bat)i&&i(null,n.bat);else{var o=this._getBatCbs.length;if(i&&-1==this._getBatCbs.indexOf(i)&&this._getBatCbs.push(i),0==o){var a=this;t._doAction("GetBatteryLevel",t._requestBody("GetBatteryLevel",this._moduleParameters(e)),"BatteryLevel",function(i,o){var r=a._getBatCbs;return a._getBatCbs=[],i?(a._logger.log("warn","get zwave "+e+" battery error:"+i.stack),void r.forEach(function(t){t&&t(i);})):o?(n||(n={}),n.bat=o.text(),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,n),void r.forEach(function(t){t&&t(null,o.text());})):(a._logger.log("warn","get zwave "+e+" battery result format error"),i=new Error("get contact battery state result format error"),void r.forEach(function(t){t&&t(i);}));});}}},Device.prototype._getSaboState=function(t,e,i){this._logger.log("debug","get zwave "+e+" sabotage");var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(n&&void 0!==n.sabo&&null!=n.sabo)i&&i(null,n.sabo);else{var o=this._getSabCbs.length;if(i&&-1==this._getSabCbs.indexOf(i)&&this._getSabCbs.push(i),0==o){var a=this;t._doAction("GetTamperSensorState",t._requestBody("GetTamperSensorState",this._moduleParameters(e)),"TamperState",function(i,o){var r=a._getSabCbs;return a._getSabCbs=[],i?(a._logger.log("warn","get zwave "+e+" sabotage error:"+i.stack),void r.forEach(function(t){t&&t(i);})):o?(n||(n={}),n.sabo=o.text(),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,n),void r.forEach(function(t){t&&t(null,o.text());})):(a._logger.log("warn","get zwave "+e+" sabotage result format error"),i=new Error("get contact sabotage state result format error"),void r.forEach(function(t){t&&t(i);}));});}}},Device.parseJSON=function(t){if(!t||"zwave"!=t.type||!t.data||!t.node_id)return null;switch(t.data){case"contact":return new xnm.aio.dlink.ZwaveContact(t);case"motion":return new xnm.aio.dlink.ZwaveMotion(t);case"siren":return new xnm.aio.dlink.ZwaveSiren(t);default:return null;}},Device;}(),xnm.aio.dlink.ZwaveContact=function(){var Contact=function Contact(t){xnm.aio.dlink.ZwaveDevice.call(this,t),this._getActivCbs=[],this._getOpenCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveContact ");};return(Contact.prototype=new xnm.aio.dlink.ZwaveDevice()).constructor=Contact,Contact.prototype.executeCommand=function(t,e,i){if(e&&e.value){var n=this;switch(e.value){case"activate":case"deactivate":this._setActive(t,"activate"==e.value,i);break;case"actToggle":this._getActiveState(t,function(e,o){if(e)i&&i(e);else{var a="true"==o?"deactivate":"activate";n.executeCommand(t,{value:a},i);}});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command invalid"));},Contact.prototype._getStates=function(t,e,i){if(e&&0!=e.length)for(var n={},o=0,cb=function cb(){++o==e.length&&i&&i(null,n);},a=0;a<e.length;a++){switch(e[a]){case"active":this._getActiveState(t,function(t,e){!t&&e&&(n.active=e),cb();});break;case"state":this._getOpenState(t,function(t,e){!t&&e&&(n.state=e),cb();});break;case"temp":this._getTempState(t,this.node_id+"03",function(t,e){!t&&e&&(n.temp=e),cb();});break;case"bri":this._getBriState(t,this.node_id+"04",function(t,e){!t&&e&&(n.bri=e),cb();});break;case"bat":this._getBatteryState(t,this.node_id+"05",function(t,e){!t&&e&&(n.bat=e),cb();});break;case"sabo":this._getSaboState(t,this.node_id+"02",function(t,e){!t&&e&&(n.sabo=e),cb();});break;default:cb();}}else i&&i(null,{});},Contact.prototype._controlParameters=function(t,e){return this._moduleParameters(t)+"<OPStatus>"+e+"</OPStatus>";},Contact.prototype._setActive=function(t,e,i){var n=this.node_id+"01",o=this;t._doAction("SetContactSensorSettings",t._requestBody("SetContactSensorSettings",this._controlParameters(n,e)),"SetContactSensorSettingsResult",function(n,a){n||a&&"OK"==a.text()||(n=new Error("activate contact failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,o.node_id,{active:e+""}),i&&i(n);});},Contact.prototype._getActiveState=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(i&&void 0!==i.active&&null!=i.active)e&&e(null,i.active);else{var n=this._getActivCbs.length;if(e&&-1==this._getActivCbs.indexOf(e)&&this._getActivCbs.push(e),0==n){var o=this.node_id+"01",a=this;t._doAction("GetContactSensorSettings",t._requestBody("GetContactSensorSettings",this._moduleParameters(o)),"OPStatus",function(n,o){var r=a._getActivCbs;if(a._getActivCbs=[],n)r.forEach(function(t){t&&t(n);});else{if(!o)return n=new Error("get contact active state result format error"),void r.forEach(function(t){t&&t(n);});i||(i={}),i.active=o.text(),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,i),e&&e(null,o.text());}});}}},Contact.prototype._getOpenState=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(i&&void 0!==i.state&&null!=i.state)e&&e(null,i.state);else{var n=this._getOpenCbs.length;if(e&&-1==this._getOpenCbs.indexOf(e)&&this._getOpenCbs.push(e),0==n){var o=this.node_id+"01",a=this;t._doAction("GetContactSensorState",t._requestBody("GetContactSensorState",this._moduleParameters(o)),"ContactState",function(n,o){var r=a._getOpenCbs;if(a._getOpenCbs=[],n)r.forEach(function(t){t&&t(n);});else{if(!o)return n=new Error("get contact open state result format error"),void r.forEach(function(t){t&&t(n);});var s=o.text();"true"==s?s="closed":"false"==s&&(s="open"),i||(i={}),i.state=s,xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,i),e&&e(null,s);}});}}},Contact;}(),xnm.aio.dlink.ZwaveMotion=function(){var Motion=function Motion(t){xnm.aio.dlink.ZwaveDevice.call(this,t),this._getSettingsCbs=[],this._getDetecCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveMotion");};return(Motion.prototype=new xnm.aio.dlink.ZwaveDevice()).constructor=Motion,Motion.prototype.executeCommand=function(t,e,i){if(e&&e.value){var n=this;switch(e.value){case"activate":case"deactivate":xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id)?this._setMotionDetectorActive(t,"activate"==e.value,function(t){i&&i(t);}):this._getMotionDetectorSettings(t,function(o){o?i&&i(o):n.executeCommand(t,e,i);});break;case"actToggle":this._getMotionDetectorSettings(t,function(e,o){if(e)i&&i(e);else{var a="true"==o.opStatus?"deactivate":"activate";n.executeCommand(t,{value:a},i);}});break;case"sensTo":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));var o=parseInt(e.ext);o<1&&(o=1),o>100&&(o=100),xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id)?this._setMotionDetectorSensitivity(t,o,function(t){i&&i(t);}):this._getMotionDetectorSettings(t,function(o){o?i&&i(o):n.executeCommand(t,e,i);});break;case"sensUp":case"sensDown":this._getMotionDetectorSettings(t,function(o,a){if(o)i&&i(o);else{var r=parseInt(a.sensitivity);1!=r&&100!=r?("sensUp"==e.value?r+=5:"sensDown"==e.value&&(r-=5),n.executeCommand(t,{value:"sensTo",ext:r},i)):i&&i();}});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command invalid"));},Motion.prototype._getStates=function(t,e,i){if(e&&0!=e.length)for(var n={},o=0,cb=function cb(){++o==e.length&&i&&i(null,n);},a=!1,r=!1,s=0;s<e.length;s++){switch(e[s]){case"active":case"sens":a?cb():(a=!0,this._getMotionDetectorSettings(t,function(t,e){!t&&e&&(n.active=e.opStatus,n.sens=e.sensitivity),cb();}));break;case"dectTime":case"dectTimeStr":r?cb():(r=!0,this._getLastDetectionState(t,function(t,e){!t&&e&&(n.dectTime=e,e=parseInt(e),n.dectTimeStr=new Date(1e3*e).toLocaleString()),cb();}));break;case"temp":this._getTempState(t,this.node_id+"03",function(t,e){!t&&e&&(n.temp=e),cb();});break;case"bri":this._getBriState(t,this.node_id+"04",function(t,e){!t&&e&&(n.bri=e),cb();});break;case"bat":this._getBatteryState(t,this.node_id+"05",function(t,e){!t&&e&&(n.bat=e),cb();});break;case"sabo":this._getSaboState(t,this.node_id+"02",function(t,e){!t&&e&&(n.sabo=e),cb();});break;default:cb();}}else i&&i(null,{});},Motion.prototype._controlParameters=function(t,e,i,n,o,a){return this._moduleParameters(t)+"<NickName>"+e+"</NickName><Description>"+i+"</Description><Sensitivity>"+n+"</Sensitivity><OPStatus>"+o+"</OPStatus><Backoff>"+a+"</Backoff>";},Motion.prototype._setMotionDetectorActive=function(t,e,i){var n=this.node_id+"01",o=this,a=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);t._doAction("SetMotionDetectorSettings",t._requestBody("SetMotionDetectorSettings",this._controlParameters(n,a.nickName,a.description,a.sensitivity,e,a.backoff)),"SetMotionDetectorSettingsResult",function(n,a){n||a&&"OK"==a.text()||(n=new Error("activate contact failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,o.node_id,{opStatus:e+""}),i&&i(n);});},Motion.prototype._setMotionDetectorSensitivity=function(t,e,i){var n=this.node_id+"01",o=this,a=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);t._doAction("SetMotionDetectorSettings",t._requestBody("SetMotionDetectorSettings",this._controlParameters(n,a.nickName,a.description,e,a.opStatus,a.backoff)),"SetMotionDetectorSettingsResult",function(n,a){n||a&&"OK"==a.text()||(n=new Error("activate contact failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,o.node_id,{sensitivity:e+""}),i&&i(n);});},Motion.prototype._getMotionDetectorSettings=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(i&&i.sensitivity&&i.opStatus&&i.nickName&&i.description&&i.backoff)e&&e(null,i);else{var n=this._getSettingsCbs.length;if(e&&-1==this._getSettingsCbs.indexOf(e)&&this._getSettingsCbs.push(e),0==n){var o=this.node_id+"01",a=this;t._doAction("GetMotionDetectorSettings",t._requestBody("GetMotionDetectorSettings",this._moduleParameters(o)),"GetMotionDetectorSettingsResponse",function(e,i){var n=a._getSettingsCbs;if(a._getSettingsCbs=[],e)n.forEach(function(t){t&&t(e);});else{if(!i)return e=new Error("get contact settings result format error"),void n.forEach(function(t){t&&t(e);});var o=i.find("GetMotionDetectorSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return e=new Error("get contact settings failed"),void n.forEach(function(t){t&&t(e);});var r=null,s=null,u=null,l=null,c=null;i.find("NickName").each(function(){u||(u=$(this).text());}),i.find("Description").each(function(){l||(l=$(this).text());}),i.find("OPStatus").each(function(){r||(r=$(this).text());}),i.find("Sensitivity").each(function(){s||(s=$(this).text());}),i.find("Backoff").each(function(){c||(c=$(this).text());});var f={nickName:u,description:l,opStatus:r,sensitivity:s,backoff:c};xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,f),n.forEach(function(t){t&&t(null,f);});}});}}},Motion.prototype._getLastDetectionState=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(i&&i.dectTime)e&&e(null,i.dectTime);else{var n=this._getDetecCbs.length;if(e&&-1==this._getDetecCbs.indexOf(e)&&this._getDetecCbs.push(e),0==n){var o=this.node_id+"01",a=this;t._doAction("GetLatestDetection",t._requestBody("GetLatestDetection",this._moduleParameters(o)),"LatestDetectTime",function(e,i){var n=a._getDetecCbs;if(a._getDetecCbs=[],e)n.forEach(function(t){t&&t(e);});else{if(!i)return e=new Error("get contact open state result format error"),void n.forEach(function(t){t&&t(e);});xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,{dectTime:i.text()}),n.forEach(function(t){t&&t(null,i.text());});}});}}},Motion;}(),xnm.aio.dlink.ZwaveSiren=function(){var Siren=function Siren(t){xnm.aio.dlink.ZwaveDevice.call(this,t),this._getSettingsCbs=[],"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.dlink.ZwaveSiren");};return(Siren.prototype=new xnm.aio.dlink.ZwaveDevice()).constructor=Siren,Siren.prototype.TONE=["emergency","fire","ambulance","police","doorbell","acoustic_signal"],Siren.prototype.executeCommand=function(t,e,i){if(e&&e.value){var n,o=this;switch(e.value){case"activate":case"deactivate":case"actToggle":case"setTone":case"setDuration":case"setDurationP":case"setVolume":case"volumeUp":case"volumeDown":case"play":this._getSirenAlarmSettings(t,function(a,r){if(a)i&&i(a);else switch(e.value){case"activate":case"deactivate":o._setSirenActive(t,"activate"==e.value,function(t){i&&i(t);});break;case"actToggle":o._setSirenActive(t,"true"!=r.opStatus,function(t){i&&i(t);});break;case"setVolume":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));(n=parseInt(e.ext))<0&&(n=0),n>100&&(n=100),o._setSirenVolumn(t,n,function(t){i&&i(t);});break;case"volumeUp":case"volumeDown":(n=parseInt(r.volume))>100&&(n=100),"volumeUp"==e.value?n+=5:n-=5,n<0&&(n=0),n>100&&(n=100),o._setSirenVolumn(t,n,function(t){i&&i(t);});break;case"setDuration":case"setDurationP":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));o._setSirenDuration(t,e.ext,function(t){i&&i(t);});break;case"setTone":if(void 0===e.ext||null==e.ext)return void(i&&i(new Error("command ext invalid")));o._setSirenTone(t,e.ext,function(t){i&&i(t);});break;case"play":o._doAlarm(t,function(t){i&&i(t);});}});break;case"stop":this._stopAlarm(t,function(t){i&&i(t);});break;default:i&&i(new Error("unknown command"));}}else i&&i(new Error("command invalid"));},Siren.prototype._controlParameters=function(t,e,i,n,o,a,r){return this._moduleParameters(t)+"<NickName>"+e+"</NickName><Description>"+i+"</Description><DefaultSound>"+n+"</DefaultSound><OPStatus>"+a+"</OPStatus><Volume>"+o+"</Volume><Duration>"+r+"</Duration>";},Siren.prototype._soundPlayParameters=function(t,e,i,n){return this._moduleParameters(t)+"<SoundType>"+e+"</SoundType><Volume>"+i+"</Volume><Duration>"+n+"</Duration><Controller>1</Controller>";},Siren.prototype._dissmissParameters=function(t){return this._moduleParameters(t)+"<Controller>1</Controller>";},Siren.prototype._doAlarm=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id),n=this.node_id+"09",o=this;t._doAction("SetSoundPlay",t._requestBody("SetSoundPlay",this._soundPlayParameters(n,i.defaultSound,i.volume,i.duration)),"SetSoundPlayResult",function(i,n){i||n&&"OK"==n.text()||(i=new Error("play siren failed")),i||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,o.node_id,{alarm:"true"}),e&&e(i);});},Siren.prototype._stopAlarm=function(t,e){var i=this.node_id+"09",n=this;t._doAction("SetAlarmDismissed",t._requestBody("SetAlarmDismissed",this._dissmissParameters(i)),"SetAlarmDismissedResult",function(i,o){i||o&&"OK"==o.text()||(i=new Error("stop siren failed")),i||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,n.node_id,{alarm:"false"}),e&&e(i);});},Siren.prototype._setSirenActive=function(t,e,i){var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);n.opStatus=e+"",this._setSirenAlarmSettings(t,n,i);},Siren.prototype._setSirenVolumn=function(t,e,i){var n=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);n.volume=e+"",this._setSirenAlarmSettings(t,n,i);},Siren.prototype._setSirenDuration=function(t,e,i){var n=null;switch(e){case"30s":n=30;break;case"60s":n=60;break;case"90s":n=90;break;case"3min":n=180;break;case"repeat":n=88888;break;default:if(n=parseInt(e),isNaN(n))return void(i&&i(new Error("invalid duration")));n<=0&&(n=1),n>86400&&(n=86400);}var o=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);o.duration=n+"",this._setSirenAlarmSettings(t,o,i);},Siren.prototype._setSirenTone=function(t,e,i){var n=this.TONE.indexOf(e)+1;if(n){var o=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);o.defaultSound=n+"",this._setSirenAlarmSettings(t,o,i);}else i&&i(new Error("no such tone"));},Siren.prototype._setSirenAlarmSettings=function(t,e,i){var n=this.node_id+"09",o=this;t._doAction("SetSirenAlarmSettings",t._requestBody("SetSirenAlarmSettings",this._controlParameters(n,e.nickName,e.description,e.defaultSound,e.volume,e.opStatus,e.duration)),"SetSirenAlarmSettingsResult",function(n,a){n||a&&"OK"==a.text()||(n=new Error("set siren settings failed")),n||xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,o.node_id,e),i&&i(n);});},Siren.prototype._getStates=function(t,e,i){if(e&&0!=e.length)for(var n={},o=0,cb=function cb(){++o==e.length&&i&&i(null,n);},a=this,r=!1,s=0;s<e.length;s++){switch(e[s]){case"active":case"tone":case"volume":case"duration":case"durationStr":case"alarm":r?cb():(r=!0,this._getSirenAlarmSettings(t,function(t,e){if(!t&&e)if(n.active=e.opStatus,n.tone=a.TONE[parseInt(e.defaultSound)-1],n.volume=parseInt(e.volume),999==n.volume&&(n.volume=100),n.alarm=e.alarm,n.duration=parseInt(e.duration),n.duration<180)n.durationStr=n.duration+"s";else if(88888==n.duration||9999==n.duration)n.durationStr="repeat";else{var i=Math.floor(n.duration/60),o=n.duration-60*i;n.durationStr=(i?i+"m":"")+(o?o+"s":"");}cb();}));break;default:cb();}}else i&&i(null,{});},Siren.prototype._getSirenAlarmSettings=function(t,e){var i=xnm.aio.dlink._SettingsBuffer.getSettings(t.ip,this.node_id);if(i&&i.defaultSound&&i.opStatus&&i.nickName&&i.description&&i.volume&&i.duration&&i.alarm)e&&e(null,i);else{var n=this._getSettingsCbs.length;if(e&&-1==this._getSettingsCbs.indexOf(e)&&this._getSettingsCbs.push(e),0==n){var o=this.node_id+"09",a=this;t._doAction("GetSirenAlarmSettings",t._requestBody("GetSirenAlarmSettings",this._moduleParameters(o)),"GetSirenAlarmSettingsResponse",function(e,i){var n=a._getSettingsCbs;if(a._getSettingsCbs=[],e)n.forEach(function(t){t&&t(e);});else{if(!i)return e=new Error("get contact settings result format error"),void n.forEach(function(t){t&&t(e);});var o=i.find("GetSirenAlarmSettingsResult");if(!o||!o[0]||"OK"!=$(o[0]).text())return e=new Error("get siren settings failed"),void n.forEach(function(t){t&&t(e);});var r={nickName:null,description:null,opStatus:null,volume:null,defaultSound:null,duration:null,alarm:null};i.find("NickName").each(function(){r.nickName=$(this).text();}),i.find("Description").each(function(){r.description=$(this).text();}),i.find("OPStatus").each(function(){r.opStatus=$(this).text();}),i.find("Volume").each(function(){r.volume=$(this).text();}),i.find("Duration").each(function(){r.duration=$(this).text();}),i.find("DefaultSound").each(function(){r.defaultSound=$(this).text();}),i.find("IsSounding").each(function(){r.alarm=$(this).text();}),xnm.aio.dlink._SettingsBuffer.setSettings(t.ip,a.node_id,r),n.forEach(function(t){t&&t(null,r);});}});}}},Siren;}(),xnm.aio.dlink.DM=function(){var DMError=function DMError(t,e){this.code=t,this.message=e,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="DlinkDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var t={"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"device ready",ref:{value:"ready",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"float",name:"current consumption",ref:{value:"power"}},{type:"float",name:"total consumption",ref:{value:"totalPower"}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",ext:"%d",extMeta:"1-100"}},{type:"enum",name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:["emergency","fire","ambulance","police","doorbell","acoustic_signal"]}},{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["3s","10s","30s","1min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",extMeta:"1-86400",unit:"s"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:["emergency","fire","ambulance","police","doorbell","acoustic_signal"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]},water:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["water","dry"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}}]}},e={contact:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"state",options:["open","closed"]}},{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},motion:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"int",name:"set sensitivity",ref:{value:"sensTo",ext:"%d",extMeta:"1-100"}},{type:"enum",name:"sensitivity +",ref:{value:"sensUp"}},{type:"enum",name:"sensitivity -",ref:{value:"sensDown"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"int",name:"last detection (timestamp)",ref:{value:"dectTime"}},{type:"string",name:"last detection (text)",ref:{value:"dectTimeStr"}},{type:"int",name:"sensitivity",ref:{value:"sens"}},{type:"float",name:"brightness",ref:{value:"bri"}},{type:"float",name:"temperature",ref:{value:"temp"}},{type:"int",name:"battery",ref:{value:"bat"}},{type:"enum",name:"sabotage",ref:{value:"sabo",options:["true","false"]}}]},siren:{command:[{type:"enum",name:"activate",ref:{value:"activate"}},{type:"enum",name:"deactivate",ref:{value:"deactivate"}},{type:"enum",name:"toggle activate",ref:{value:"actToggle"}},{type:"enum",name:"alarm",ref:{value:"play"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"set tone",ref:{value:"setTone",ext:"%e",extMeta:["emergency","fire","ambulance","police","doorbell","acoustic_signal"]}},{type:"enum",name:"set duration (preset)",ref:{value:"setDurationP",ext:"%e",extMeta:["30s","60s","90s","3min","repeat"],sort:"none"}},{type:"int",name:"set duration",ref:{value:"setDuration",ext:"%d",extMeta:"1-86400",unit:"s"}}],status:[{type:"enum",name:"active",ref:{value:"active",options:["true","false"]}},{type:"enum",name:"alarming",ref:{value:"alarm",options:["true","false"]}},{type:"enum",name:"tone",ref:{value:"tone",options:["emergency","fire","ambulance","police","doorbell","acoustic_signal"]}},{type:"int",name:"duration",ref:{value:"duration"}},{type:"string",name:"duration (text)",ref:{value:"durationStr"}}]}};return{SYS:"dlink",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"mydlink Connected Home",port:80}];},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"mydlink Connected Home Hub",port:80};},getGatewayDeviceType:function getGatewayDeviceType(t){return[{sys:this.SYS,data:"contact",name:"Home Door/Window Sensor"},{sys:this.SYS,data:"motion",name:"Battery Motion Sensor"},{sys:this.SYS,data:"siren",name:"Siren"}];},createGateway:function createGateway(t,e,i){var n=DMError,o=DMError.ERROR_CODE;t?t.ip?t.password?i(null,t):i(new n(o.INVALID,"password is invalid")):i(new n(o.INVALID,"ip is invalid")):i(new n(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(t,e,i,n){var o=DMError,a=DMError.ERROR_CODE;e?e.ip?e.password?n(null,e):n(new o(a.INVALID,"password is invalid")):n(new o(a.INVALID,"ip is invalid")):n(new o(a.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(t,e,i){i();},createDevice:function createDevice(t,e,i){var n=DMError,o=DMError.ERROR_CODE;if(t){if(t.type){if(t.data){if("wifi"==t.type){if(!t.ip)return void i(new n(o.INVALID,"ip is invalid"));if(!t.password)return void i(new n(o.INVALID,"password is invalid"));}else if("zwave"==t.type){if(!t.gateway)return void i(new n(o.INVALID,"gateway is invalid"));if(!t.node_id)return void i(new n(o.INVALID,"node_id is invalid"));if(!e.data||!e.data.gateways||0===e.data.gateways.length)return void i(new n(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));var a,r,s=e.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===t.gateway){r=s[a];break;}}if(!r)return void i(new n(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}i(null,t);}else i(new n(o.INVALID,"data is invalid"));}else i(new n(o.INVALID,"type is invalid"));}else i(new n(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,e,i){var n=DMError,o=DMError.ERROR_CODE;if(t){if(t.type){if(t.data){if("wifi"==t.type){if(!t.ip)return void i(new n(o.INVALID,"ip is invalid"));if(!t.password)return void i(new n(o.INVALID,"password is invalid"));}else if("zwave"==t.type){if(!t.gateway)return void i(new n(o.INVALID,"gateway is invalid"));if(!t.node_id)return void i(new n(o.INVALID,"node_id is invalid"));if(!e.data||!e.data.gateways||0===e.data.gateways.length)return void i(new n(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));var a,r,s=e.data.gateways;for(a=0;a<s.length;a++){if(s[a].index===t.gateway){r=s[a];break;}}if(!r)return void i(new n(o.NOT_FOUND,"gateway with index "+t.gateway+" not exists"));}i(null,t);}else i(new n(o.INVALID,"data is invalid"));}else i(new n(o.INVALID,"type is invalid"));}else i(new n(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,i){i();},applyUIFilter:function applyUIFilter(t,e,i){var n=this,_doFilterArr=function _doFilterArr(t,e,i){var n=[];return t.forEach(function(t){if("root"==t.type){var o=JSON.parse(JSON.stringify(t)),a=_doFilterArr(o.children,e,i);a&&a.length>0&&(o.children=a,n.push(o));}else if(function(t,e){if("*"==t)return!0;for(var i=!1,n=0;n<t.length;n++){if(t[n]==e){i=!0;break;}}return i;}(i.elems,t.type)){var r=JSON.parse(JSON.stringify(t));n.push(r);}}),n;},_filter=function _filter(t,e){var o=[],a=null,r=n.getCommandStatusMap(t,i);return r&&(a=function(t,e,i){var n=[];switch(i.catagory){case"command":t.command&&(n=_doFilterArr(t.command,e,i));break;case"status":t.status&&(n=_doFilterArr(t.status,e,i));}return n;}(r,t,e),o=o.concat(a)),o;};if(!t.sys)return null;var o=JSON.parse(JSON.stringify(t)),a=null;switch(e.catagory){case"command":a=_filter(t,e),o.command=a;break;case"status":a=_filter(t,e),o.status=a;break;default:return null;}return a&&0!=a.length?o:null;},getCommandStatusMap:function getCommandStatusMap(i){return i&&i.type&&i.data?"wifi"==i.type?t[i.data]:"zwave"==i.type?e[i.data]:null:null;}};}(),xnm.aio.dlink.Handler=function(){var Handler=function Handler(){};return Handler.prototype.WifiPlug=xnm.aio.dlink.WifiPlug,Handler.prototype.WifiMotion=xnm.aio.dlink.WifiMotion,Handler.prototype.WifiSiren=xnm.aio.dlink.WifiSiren,Handler.prototype.WifiWater=xnm.aio.dlink.WifiWater,Handler.prototype.WifiHub=xnm.aio.dlink.WifiHub,Handler.prototype.devicemanager=xnm.aio.dlink.DM,Handler.prototype.registModule=function(t){t.register(this.devicemanager.SYS,"dlink");},Handler.prototype.resolveGateway=function(t){return t&&"wifi"==t.type&&"hub"==t.data?xnm.aio.dlink.WifiDevice.parseJSON(t):null;},Handler.prototype.resolveDevice=function(t){return t&&"wifi"===t.type?xnm.aio.dlink.WifiDevice.parseJSON(t):null;},Handler.prototype.getDeviceCommands=function(t,e){var i=this.devicemanager.applyUIFilter(t,{catagory:"command",elems:"*"}),n=i?i.command:[];e&&e(null,n);},Handler.prototype.getDeviceStatus=function(t,e){var i=this.devicemanager.applyUIFilter(t,{catagory:"status",elems:"*"}),n=i?i.status:[];e&&e(null,n);},Handler.prototype.doCommand=function(t,e,i,n){var o;(o=t?this.resolveGateway(t):this.resolveDevice(e))?o.executeCommandCreator(e,i,function(t){n&&n(t);}):n&&n(new Error("gateway/device json format invalid"));},Handler.prototype.doStatus=function(t,e,i,n,o){var a;if(a=e?this.resolveGateway(e):this.resolveDevice(i)){var r=[{id:t,device:i,status:n}];a.getStatesCreator(null,r,function(t,e){t?o&&o(t):o&&o(null,e[0]);});}else o&&o(new Error("device json format invalid"));},Handler.prototype.discoverWifiDevice=function(t,e){var i=require("x.mdns.js");i.clearRecordBuffer(),i.discoverServiceWithTimeout("_dhnap._tcp.local",t,function(t,i){if(t)e&&e(t);else{for(var n=[],o=0;o<i.length;o++){var a=i[o],r=null;if(a.info&&a.ip&&a.ip.length>0){var s={ip:a.ip[0],mac:a.info.mac,model:a.info.model_number};switch(a.info.model_number){case"DSP-W215":r=new xnm.aio.dlink.WifiPlug(s);break;case"DCH-G020":r=new xnm.aio.dlink.WifiHub(s);break;case"DCH-S150":r=new xnm.aio.dlink.WifiMotion(s);break;case"DCH-S220":r=new xnm.aio.dlink.WifiSiren(s);break;case"DCH-S160":r=new xnm.aio.dlink.WifiWater(s);}r&&n.push(r);}}e&&e(t,n);}});},Handler.prototype.listZwaveDevice=function(t,e){var i=this.resolveGateway(t);i?i.listZwaveDevice(e):e&&e(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.dlink.Handler());