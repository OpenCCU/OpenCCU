var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.raumfeld=xnm.aio.raumfeld||{},xnm.aio.raumfeld.Player=function(){var Player=function Player(){this._renderer=null;};return Player.prototype.getIP=function(){return this._renderer?this._renderer.ip:null;},Player.prototype.setIP=function(e){this._renderer&&(this._renderer.ip=e);},Player.prototype.getPort=function(){return this._renderer?this._renderer.port:null;},Player.prototype.setPort=function(e){this._renderer&&(this._renderer.port=e);},Player.prototype.getUUID=function(){return this._renderer?this._renderer.uuid:null;},Player.prototype.executeCommandCreator=function(e,t,r){t&&t.value?this._executeCommand(t.value,t.ext,function(e){r&&r(e);}):r&&r(new Error("command value is empty"));},Player.prototype.getStatesCreator=function(e,t,r){this._getStates(function(e,o){if(e)r&&r(e);else{for(var n=[],i=0;i<t.length;i++){var a=t[i];if(a&&a.id&&a.status)switch(a.status.value){case"muted":null!=o.muted&&void 0!==o.muted&&n.push({id:a.id,status:o.muted});break;case"volume":null!=o.volume&&void 0!==o.volume&&n.push({id:a.id,status:o.volume});break;case"playMode":o.playMode&&n.push({id:a.id,status:o.playMode});break;case"playState":o.transportState&&n.push({id:a.id,status:o.transportState});break;case"duration":o.playInfo&&o.playInfo.duration&&n.push({id:a.id,status:o.playInfo.duration});break;case"durationS":o.playInfo&&void 0!==o.playInfo.durationSec&&null!=o.playInfo.durationSec&&n.push({id:a.id,status:o.playInfo.durationSec});break;case"position":o.playInfo&&o.playInfo.position&&n.push({id:a.id,status:o.playInfo.position});break;case"positionS":o.playInfo&&void 0!==o.playInfo.positionSec&&null!=o.playInfo.positionSec&&n.push({id:a.id,status:o.playInfo.positionSec});break;case"artist":o.playInfo&&o.playInfo.trackMetaData&&o.playInfo.trackMetaData.artist?n.push({id:a.id,status:o.playInfo.trackMetaData.artist}):n.push({id:a.id,status:""});break;case"title":o.playInfo&&o.playInfo.trackMetaData&&o.playInfo.trackMetaData.title?n.push({id:a.id,status:o.playInfo.trackMetaData.title}):n.push({id:a.id,status:""});break;case"album":o.playInfo&&o.playInfo.trackMetaData&&o.playInfo.trackMetaData.album?n.push({id:a.id,status:o.playInfo.trackMetaData.album}):n.push({id:a.id,status:""});break;case"eqLow":o.eq&&void 0!==o.eq.eqLow&&null!=o.eq.eqLow&&n.push({id:a.id,status:parseFloat(o.eq.eqLow)});break;case"eqMid":o.eq&&void 0!==o.eq.eqMid&&null!=o.eq.eqMid&&n.push({id:a.id,status:parseFloat(o.eq.eqMid)});break;case"eqHigh":o.eq&&void 0!==o.eq.eqHigh&&null!=o.eq.eqHigh&&n.push({id:a.id,status:parseFloat(o.eq.eqHigh)});break;case"shuffle":o.playMode&&o.playMode.shuffle&&n.push({id:a.id,status:o.playMode.shuffle});break;case"repeat":o.playMode&&o.playMode.repeat&&n.push({id:a.id,status:o.playMode.repeat});}}r&&r(null,n);}});},Player.prototype.play=function(e,t,r){if(e&&t&&t["class"]&&t.id){var o=this;e.browseMetaData(t.id,function(n,i){if(n)r&&r(n);else if(0!=t["class"].indexOf("object.container")||t.res&&t.res.url){var a=null;if(t.res&&t.res.url)a=t.res.url;else{if(!i||!i.meta||!i.meta.res)return void(r&&r(new Error("resource url invalid")));a=i.meta.res;}o._renderer.playResource({url:a},i.result,r);}else{if(!e.uuid)return void(r&&r(new Error("media server uuid invalid")));o._renderer.playContainer({containerID:t.id,server_uuid:e.uuid},i.result,r);}});}else r&&r(new Error("play obj invalid"));},Player.prototype.playFromContainer=function(e,t,r,o){if(e&&t&&t.id&&t.parentID){if(e.uuid){var n=this;e.browseMetaData(t.parentID,function(i,a){i?o&&o(i):n._renderer.playContainer({containerID:t.parentID,server_uuid:e.uuid,firstIdx:r},a.result,o);});}else o&&o(new Error("media server uuid invalid"));}else o&&o(new Error("play obj invalid"));},Player.prototype.browser=function(e,t,r,o,n){if(e){t||(t=0),r||(r=0),o||(o=0);e.browseChildren(t,r,o,null,function(e,t,r){n&&n(e,t,r);});}else n&&n(new Error("play obj invalid"));},Player.prototype._executeCommand=function(e,t,r){if(this._renderer)switch(e){case"play":this._renderer.play(r);break;case"pause":this._renderer.pause(r);break;case"stop":this._renderer.stop(r);break;case"previous":this._renderer.previous(r);break;case"next":this._renderer.next(r);break;case"mute":this._renderer.mute(function(e){setTimeout(function(){r&&r(e);},500);});break;case"unmute":this._renderer.unmute(function(e){setTimeout(function(){r&&r(e);},500);});break;case"toggleMute":this._renderer.toggleMute(function(e){setTimeout(function(){r&&r(e);},500);});break;case"volumeUp":this._renderer.volumeUp(r);break;case"volumeDown":this._renderer.volumeDown(r);break;case"setPlayMode":if(!t)return void(r&&r(new Error("play mode value invalid")));this._renderer.setPlayMode(t,r);break;case"seekTo":if(void 0===t||null==t)return void(r&&r(new Error("seek value invalid")));this._renderer.seekRelTimeSec(t,r);break;case"setVolume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this._renderer.setVolume(t,r);break;case"shuffleToggle":this.shuffleToggle(r);break;case"repeatSwitch":this.repeatSwitch(r);break;default:r&&r(new Error("unknown command"));}else r&&r(new Error("renderer not initialized"));},Player.prototype._getStates=function(e){if(this._renderer){var cb=function cb(){0==--r&&e&&e(null,t);},t={},r=5;this._renderer.getPlayState(function(e,r){e||(t.transportState=r),cb();}),this._renderer.getPlayInfo(function(e,r){e||(t.playInfo=r),cb();}),this._renderer.isMuted(function(e,r){e||(t.muted=r),cb();}),this._renderer.getVolume(function(e,r){e||(t.volume=r),cb();}),this.getPlayMode(function(e,r){e||(t.playMode=r),cb();});}else e&&e(new Error("renderer not initialized"));},Player.prototype.getPlayMode=function(e){if(this._renderer){var t=this;this._renderer.getPlayMode(function(r,o){r?e&&e(r):e&&e(null,t._parsePlayMode(o));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.setPlayMode=function(e,t){this._renderer?(e=this._buildPlayMode(e),this._renderer.setPlayMode(e,t)):t&&t(new Error("renderer not initialized"));},Player.prototype._parsePlayMode=function(e){switch(e){case"NORMAL":default:return{shuffle:"off",repeat:"off"};case"REPEAT_ALL":return{shuffle:"off",repeat:"all"};case"REPEAT_ONE":return{shuffle:"off",repeat:"one"};case"RANDOM":return{shuffle:"on",repeat:"all"};case"SHUFFLE":return{shuffle:"on",repeat:"off"};}},Player.prototype._buildPlayMode=function(e){var t=e.shuffle,r=e.repeat;return t||(t="off"),r||(r="off"),"off"==t&&"off"==r?"NORMAL":"off"==t&&"all"==r?"REPEAT_ALL":"off"==t&&"one"==r?"REPEAT_ONE":"on"==t&&"off"==r?"SHUFFLE":"on"==t&&"all"==r?"RANDOM":"NORMAL";},Player.prototype.shuffleToggle=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,o){r?e&&e(r):(o.shuffle="on"==o.shuffle?"off":"on",t.setPlayMode(o,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.repeatSwitch=function(e){if(this._renderer){var t=this;this.getPlayMode(function(r,o){r?e&&e(r):("off"==o.shuffle?"off"==o.repeat?o.repeat="all":"all"==o.repeat?o.repeat="one":o.repeat="off":"off"==o.repeat?o.repeat="all":o.repeat="off",t.setPlayMode(o,e));});}else e&&e(new Error("renderer not initialized"));},Player.prototype.equalsTo=function(e){return!!e&&e instanceof Player&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},Player;}(),xnm.aio.raumfeld.MasterPlayer=function(){var MasterDev=function MasterDev(e,t,r){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.raumfeld.MasterDevice"):this._logger={log:{}},this.ip=e,this.port=t,this.port||(this.port=47365),this.uuid=r,this._zones=null,this._zonePlayer=null,this._getInfoCbs=[],this._autoGetInfoTimeout=null;};return MasterDev.prototype.getIP=function(){return this.ip;},MasterDev.prototype.getPort=function(){return this.port;},MasterDev.prototype.getUUID=function(){return this.uuid;},MasterDev.prototype.executeCommandCreator=function(e,t,r){if(this._zonePlayer)this._zonePlayer.executeCommandCreator(e,t,r);else{var o=this;this.getInfos(function(n){n?r&&r(n):o._zonePlayer?o._zonePlayer.executeCommandCreator(e,t,r):r&&r(n);});}},MasterDev.prototype.getStatesCreator=function(e,t,r){if(this._zonePlayer)this._zonePlayer.getStatesCreator(e,t,r);else{var o=this;this.getInfos(function(n){n?r&&r(n):o._zonePlayer?o._zonePlayer.getStatesCreator(e,t,r):r&&r(n);});}},MasterDev.prototype.play=function(e,t,r){if(this._zonePlayer)this._zonePlayer.play(e,t,r);else{var o=this;this.getInfos(function(n){n?r&&r(n):o._zonePlayer?o._zonePlayer.play(e,t,r):r&&r(n);});}},MasterDev.prototype.playFromContainer=function(e,t,r,o){if(this._zonePlayer)this._zonePlayer.playFromContainer(e,t,r,o);else{var n=this;this.getInfos(function(i){i?o&&o(i):n._zonePlayer?n._zonePlayer.playFromContainer(e,t,r,o):o&&o(i);});}},MasterDev.prototype.browser=function(e,t,r,o,n){if(this._zonePlayer)this._zonePlayer.browser(e,t,r,o,n);else{var i=this;this.getInfos(function(a){a?n&&n(a):i._zonePlayer?i._zonePlayer.browser(e,t,r,o,n):n&&n(a);});}},MasterDev.prototype.getAllRoomInfo=function(e){if(this._zones){var t=[];for(var r in this._zones.roomPlayers){var o=this._zones.roomPlayers[r];o&&t.push({uuid:o.getUUID(),name:o.getRoomName()});}e&&e(null,t);}else{var n=this;this.getInfos(function(t){t?e&&e(t):n._zones?n.getAllRoomInfo(e):e&&e(t);});}},MasterDev.prototype.getAllZoneInfo=function(e){if(this._zones){var t=[];for(var r in this._zones.zonePlayers){var o=this._zones.zonePlayers[r];o&&t.push({uuid:o.getUUID(),rooms:o.getRooms()});}e&&e(null,t);}else{var n=this;this.getInfos(function(t){t?e&&e(t):n.getAllZoneInfo(e);});}},MasterDev.prototype.getCurrentZone=function(e){if(this._zonePlayer)e&&e(null,this._zonePlayer);else{var t=this;this.getInfos(function(r){r?e&&e(r):this._zonePlayer?t.getCurrentZone(e):e&&e(new Error("no current zone"));});}},MasterDev.prototype.setCurrentZone=function(e,t){if(e){if(this._zones){var r=this._zones.zonePlayers[e],o=null;r||(o=new Error("no such zone")),t&&t(o,r);}else{var n=this;this.getInfos(function(r){r?t&&t(r):n.setCurrentZone(e,t);});}}else t&&t(new Error("zone uuid invalid"));},MasterDev.prototype.addRoomToZone=function(e,t,r){var o="/"+this.uuid+"/connectRoomToZone?";o+="zoneUDN="+encodeURIComponent("uuid:"+t),o+="&roomUDN="+encodeURIComponent("uuid:"+e);var n=this;this._doGetRequest(this.ip,47365,o,function(e){e?r&&r(e):n.getInfos(r);});},MasterDev.prototype.dropRoom=function(e,t){var r="/"+this.uuid+"/dropRoomJob?";r+="roomUDN="+encodeURIComponent("uuid:"+e);var o=this;this._doGetRequest(this.ip,47365,r,function(e){e?t&&t(e):o.getInfos(t);});},MasterDev.prototype.getRoomPlayer=function(e){if(!e||!e.uuid)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var t=this._zones.roomPlayers[e.uuid];return t||(e.port&&e.port&&e.zone_uuid?((t=new xnm.aio.raumfeld.RoomPlayer(e.ip,e.port,e.zone_uuid,e.uuid))._isDummy=!0,this._zones.roomPlayers[e.uuid]=t,t):null);},MasterDev.prototype.getDiscoveredRoomPlayer=function(e){if(!e)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var t=this._zones.roomPlayers[e];return!t||t._isDummy?null:t;},MasterDev.prototype.getRoomPlayers=function(){if(!this._zones)return null;var e=[];for(var t in this._zones.roomPlayers){e.push(this._zones.roomPlayers[t]);}return e;},MasterDev.prototype.getDedicatePlayer=function(e){if(!e||!e.uuid)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var t=this._zones.dedicatePlayers[e.uuid];return t||(e.port&&e.port?((t=new xnm.aio.raumfeld.DedicatePlayer(e.ip,e.port,e.uuid))._isDummy=!0,this._zones.dedicatePlayers[e.uuid]=t,t):null);},MasterDev.prototype.getDiscoveredDedicatePlayer=function(e){if(!e)return null;this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}});var t=this._zones.dedicatePlayers[e];return!t||t._isDummy?null:t;},MasterDev.prototype.getDedicatePlayers=function(e){if(!this._zones)return null;var t=[];for(var e in this._zones.dedicatePlayers){t.push(this._zones.dedicatePlayers[e]);}return t;},MasterDev.prototype.getInfos=function(e){var t=this._getInfoCbs.length;if(e&&-1==this._getInfoCbs.indexOf(e)&&this._getInfoCbs.push(e),0==t){this._autoGetInfoTimeout&&(clearTimeout(this._autoGetInfoTimeout),this._autoGetInfoTimeout=null);var r=this;this._getInfos(function(e,t,o){r._autoGetInfoTimeout=setTimeout(function(){r.getInfos(null);},5e3);var n=r._getInfoCbs;r._getInfoCbs=[],n.forEach(function(r){r&&r(e,t,o);});});}},MasterDev.prototype._getInfos=function(e){var t=this;this._listDevices(function(r,o){r?e&&e(r):t._getZones(function(r,n){r?e&&e(r):(t._updateBufferedZones(n,o),e&&e(null,n,o));});});},MasterDev.prototype._getZones=function(e){this._doGetRequest(this.ip,47365,"/"+this.uuid+"/getZones",function(t,r){if(t)e&&e(t);else try{var o={},n=$($.parseXML(r));n.find("zone").each(function(){var e=$(this),t=e.attr("udn");t&&(o[t]={},e.find("room").each(function(){var e=$(this),r=e.attr("udn"),n=e.attr("name");r&&n&&(o[t][r]={name:n,renderer:{}},e.find("renderer").each(function(){var e=$(this),n=e.attr("udn"),i=e.attr("name");n&&i&&(o[t][r].renderer[n]=i);}));}));}),n.find("unassignedRooms").each(function(){var e=$(this);o.idle={},e.find("room").each(function(){var e=$(this),t=e.attr("udn"),r=e.attr("name");t&&r&&(o.idle[t]={name:r,renderer:{}},e.find("renderer").each(function(){var e=$(this),r=e.attr("udn"),n=e.attr("name");r&&n&&(o.idle[t].renderer[r]=n);}));});}),e&&e(null,o);}catch(t){e&&e(t);}});},MasterDev.prototype._listDevices=function(e){this._doGetRequest(this.ip,47365,"/"+this.uuid+"/listDevices",function(t,r){if(t)e&&e(t);else try{var o={};$($.parseXML(r)).find("device").each(function(){var e=$(this),t=e.attr("udn");if(t){o[t]={udn:t,type:e.attr("type"),location:e.attr("location"),name:e.text()};var r=require("url").parse(e.attr("location"));o[t].ip=r.hostname,o[t].port=r.port;}}),e&&e(null,o);}catch(t){e&&e(t);}});},MasterDev.prototype._updateBufferedZones=function(e,t){var r,o=[],n=[],i=[];for(var a in this._zones||(this._zones={zonePlayers:{},roomPlayers:{},dedicatePlayers:{}}),e){o.push(a);var u,s=e[a];if("idle"!=a){var l=a.substr(5),d=t[a];d&&(this._zones.zonePlayers[l]?((u=this._zones.zonePlayers[l]).setIP(d.ip),u.setPort(d.port)):(u=new xnm.aio.raumfeld.ZonePlayer(d.ip,d.port,l),this._zones.zonePlayers[l]=u));}for(var f in u&&u.clearRoom(),s){n.push(f);var p,m=s[f],c=m.name,h=f.substr(5);u&&u.addRoom(h,c),this._zones.roomPlayers[h]?p=this._zones.roomPlayers[h]:(p=new xnm.aio.raumfeld.RoomPlayer(null,null,null,h),this._zones.roomPlayers[h]=p),p.setZonePlayer(u),p.setRoomName(c);var y=m.renderer;for(var v in y){i.push(v);var _,g=v.substr(5),P=y[v],R=t[v];R&&(this._zones.dedicatePlayers[g]?((_=this._zones.dedicatePlayers[g]).setIP(R.ip),_.setPort(R.port)):(_=new xnm.aio.raumfeld.DedicatePlayer(R.ip,R.port,g),this._zones.dedicatePlayers[g]=_),_.setName(P),_.setRoom(h,c));}}}for(r in this._zones.zonePlayers){-1==o.indexOf("uuid:"+r)&&delete this._zones.zonePlayers[r];}for(r in this._zones.roomPlayers){-1==n.indexOf("uuid:"+r)&&delete this._zones.roomPlayers[r];}for(r in this._zones.dedicatePlayers){-1==i.indexOf("uuid:"+r)&&delete this._zones.dedicatePlayers[r];}if(!this._zonePlayer||!this._zones.zonePlayers[this._zonePlayer.getUUID()])for(r in this._zonePlayer=null,this._zones.zonePlayers){if(this._zones.zonePlayers[r])return void(this._zonePlayer=this._zones.zonePlayers[r]);}},MasterDev.prototype._doGetRequest=function(e,t,r,o){var n=this,i="http://"+e+":"+t+r;this._logger.log("trace","send get to url:"+i);var a=o;$.ajax({url:i,type:"GET",timeout:2e3,dataType:"text",cache:!0,success:function success(e){n._logger.log("trace","http request success:"+e),a&&(a(null,e),a=null);},error:function error(e,t){var r="http request error:"+(e?e.status:"0")+"-"+t;n._logger.log("trace",r),a&&(a(new Error(r)),a=null);}});},MasterDev.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"master",model:"Raumfeld"};},MasterDev.prototype.equalsTo=function(e){return!!e&&e instanceof MasterDev&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},MasterDev;}(),xnm.aio.raumfeld.ZonePlayer=function(){var ZonePlayer=function ZonePlayer(e,t,r){this._renderer=null,this.rooms={},e&&t&&(this._renderer=this._getRenderer(e,t,r));};return(ZonePlayer.prototype=new xnm.aio.raumfeld.Player()).constructor=ZonePlayer,ZonePlayer.prototype.addRoom=function(e,t){this.rooms[e]=t;},ZonePlayer.prototype.clearRoom=function(){this.rooms={};},ZonePlayer.prototype.getRooms=function(){return this.rooms;},ZonePlayer.prototype.muteRoom=function(e,t){this._setRoomMute(0,e,1,t);},ZonePlayer.prototype.unmuteRoom=function(e,t){this._setRoomMute(0,e,0,t);},ZonePlayer.prototype.toggleMuteRoom=function(e,t){var r=this;this.isRoomMuted(e,function(o,n){o?t&&t(o):r._setRoomMute(0,e,n?0:1,t);});},ZonePlayer.prototype.isRoomMuted=function(e,t){this._getRoomMute(0,e,function(e,r){e?t&&t(e):t&&t(null,"1"==r.muted);});},ZonePlayer.prototype.getRoomVolume=function(e,t){this._getRoomVolume(0,e,function(e,r){e?t&&t(e):t&&t(null,r.volume);});},ZonePlayer.prototype.setVolumeRoom=function(e,t,r){this._setRoomVolume(0,e,t,r);},ZonePlayer.prototype.volumeUpRoom=function(e,t){var r=this;this.getRoomVolume(e,function(o,n){if(o)t&&t(o);else{var i=parseInt(n);(i+=5)>100&&(i=100),r._setRoomVolume(0,e,i,t);}});},ZonePlayer.prototype.volumeDownRoom=function(e,t){var r=this;this.getRoomVolume(e,function(o,n){if(o)t&&t(o);else{var i=parseInt(n);(i-=5)<0&&(i=0),r._setRoomVolume(0,e,i,t);}});},ZonePlayer.prototype.getPlayInfo=function(e){this._renderer?this._renderer.getPlayInfo(function(t,r){e&&e(t,r);}):e&&e(new Error("no renderer"));},ZonePlayer.prototype._getRenderer=function(e,t,r){if(r){var o=require("xnm.aio.raumfeld.js");if(o.discovery&&o.discovery._mediaRenderer){var n=o.discovery._mediaRenderer[r];if(n)return n;}}var i=new(require("x.upnp.js").MediaRenderer)();return i.init(e,t,r,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/TransportService/Control"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/ConnectionManager/Control"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/RenderingService/Control"}}),i;},ZonePlayer.prototype._getRoomVolume=function(e,t,r){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetRoomVolume",{InstanceID:e,Room:"uuid:"+t},function(e,t){if(e)r&&r(e);else{var o={},n=t.find("CurrentVolume");n.length>0&&(o.volume=$(n[0]).text()),r&&r(null,o);}});},ZonePlayer.prototype._setRoomVolume=function(e,t,r,o){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRoomVolume",{InstanceID:e,Room:"uuid:"+t,DesiredVolume:r},function(e){o&&o(e);});},ZonePlayer.prototype._getRoomMute=function(e,t,r){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetRoomMute",{InstanceID:e,Room:"uuid:"+t},function(e,t){if(e)r&&r(e);else{var o={},n=t.find("CurrentMute");n.length>0&&(o.muted=$(n[0]).text()),r&&r(null,o);}});},ZonePlayer.prototype._setRoomMute=function(e,t,r,o){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetRoomMute",{InstanceID:e,Room:"uuid:"+t,DesiredMute:r},function(e){o&&o(e);});},ZonePlayer.prototype.equalsTo=function(e){return!!e&&e instanceof ZonePlayer&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},ZonePlayer.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"zone",model:"Raumfeld"};},ZonePlayer;}(),xnm.aio.raumfeld.RoomPlayer=function(){var RoomPlayer=function RoomPlayer(e,t,r,o){this._zonePlayer=null,this.uuid=o,this.name=null,e&&t&&(this._zonePlayer=new xnm.aio.raumfeld.ZonePlayer(e,t,r));};return RoomPlayer.prototype.setZonePlayer=function(e){this._zonePlayer=e;},RoomPlayer.prototype.getUUID=function(){return this.uuid;},RoomPlayer.prototype.setRoomName=function(e){this.name=e;},RoomPlayer.prototype.getRoomName=function(){return this.name;},RoomPlayer.prototype.executeCommandCreator=function(e,t,r){t&&t.value?this._executeCommand(t.value,t.ext,function(e){r&&r(e);}):r&&r(new Error("command value is empty"));},RoomPlayer.prototype.getStatesCreator=function(e,t,r){this._getStates(function(e,o){if(e)r&&r(e);else{for(var n=[],i=0;i<t.length;i++){var a=t[i];if(a&&a.id&&a.status)switch(a.status.value){case"muted":null!=o.muted&&void 0!==o.muted&&n.push({id:a.id,status:o.muted});break;case"volume":null!=o.volume&&void 0!==o.volume&&n.push({id:a.id,status:o.volume});}}r&&r(null,n);}});},RoomPlayer.prototype._executeCommand=function(e,t,r){if(this._zonePlayer){if(this.uuid)switch(e){case"mute":this._zonePlayer.muteRoom(this.uuid,function(e){setTimeout(function(){r&&r(e);},500);});break;case"unmute":this._zonePlayer.unmuteRoom(this.uuid,function(e){setTimeout(function(){r&&r(e);},500);});break;case"toggleMute":this._zonePlayer.toggleMuteRoom(this.uuid,function(e){setTimeout(function(){r&&r(e);},500);});break;case"volumeUp":this._zonePlayer.volumeUpRoom(this.uuid,r);break;case"volumeDown":this._zonePlayer.volumeDownRoom(this.uuid,r);break;case"setVolume":if(void 0===t||null==t)return void(r&&r(new Error("volume value invalid")));this._zonePlayer.setVolumeRoom(this.uuid,t,r);break;default:r&&r(new Error("unknown command"));}else r&&r(new Error("room uuid invalid"));}else r&&r(new Error("no zone play for this room"));},RoomPlayer.prototype._getStates=function(e){if(this._zonePlayer){if(this.uuid){var cb=function cb(){0==--r&&e&&e(null,t);},t={},r=2;this._zonePlayer.isRoomMuted(this.uuid,function(e,r){e||(t.muted=r),cb();}),this._zonePlayer.getRoomVolume(this.uuid,function(e,r){e||(t.volume=r),cb();});}else e&&e(new Error("room uuid invalid"));}else e&&e(new Error("no zone play for this room"));},RoomPlayer.prototype.equalsTo=function(e){return!!e&&e instanceof RoomPlayer&&!(!this._zonePlayer||!e._zonePlayer)&&this._zonePlayer.getIP()==e._zonePlayer.getIP()&&this._zonePlayer.getPort()==e._zonePlayer.getPort();},RoomPlayer.prototype.toJSON=function(){return{sys:"raumfeld",ip:this._zonePlayer?this._zonePlayer.getIP():null,port:this._zonePlayer?this._zonePlayer.getPort():null,uuid:this.uuid,type:"room",model:"Raumfeld",zone_uuid:this._zonePlayer?this._zonePlayer.getUUID():null,server_uuid:null,name:this.name};},RoomPlayer;}(),xnm.aio.raumfeld.DedicatePlayer=function(){var e={},RPlayer=function RPlayer(e,t,r){this._renderer=null,this.room=null,this.name=null,e&&t&&(this._renderer=this._getRenderer(e,t,r));};return(RPlayer.prototype=new xnm.aio.raumfeld.Player()).constructor=RPlayer,RPlayer.prototype.setName=function(e){this.name=e;},RPlayer.prototype.setRoom=function(e,t){this.room={},this.room[e]=t;},RPlayer.prototype.getEqualizer=function(t){var r=this;this._getFilter(0,function(o,n){o?t&&t(o):(e[r._renderer.uuid]||(e[r._renderer.uuid]={}),e[r._renderer.uuid].eqLow=n.eqLow,e[r._renderer.uuid].eqMid=n.eqMid,e[r._renderer.uuid].eqHigh=n.eqHigh,t&&t(null,n));});},RPlayer.prototype.setEqualizer=function(t,r){var o=this;this._setFilter(0,t,function(n){n?r&&r(n):(e[o._renderer.uuid]||(e[o._renderer.uuid]={}),e[o._renderer.uuid].eqLow=t.eqLow,e[o._renderer.uuid].eqMid=t.eqMid,e[o._renderer.uuid].eqHigh=t.eqHigh,r&&r(null));});},RPlayer.prototype._executeCommand=function(t,r,o){if(this._renderer)switch(t){case"eqLowTo":case"eqMidTo":case"eqHighTo":if(void 0===r||null==r)return void(o&&o(new Error("equlizer value invalid")));var n=this,i=e[this._renderer.uuid];if(i&&i.eqLow&&i.eqMid&&i.eqHigh){var a={eqLow:i.eqLow,eqMid:i.eqMid,eqHigh:i.eqHigh};switch(r<-1536&&(r=-1536),r>1536&&(r=1536),t){case"eqLowTo":a.eqLow=r;break;case"eqMidTo":a.eqMid=r;break;case"eqHighTo":a.eqHigh=r;}this.setEqualizer(a,o);}else this.getEqualizer(function(e){e?o&&o(e):n._executeCommand(t,r,o);});break;default:xnm.aio.raumfeld.Player.prototype._executeCommand.call(this,t,r,o);}else o&&o(new Error("renderer not initialized"));},RPlayer.prototype._getStates=function(e){if(this._renderer){var cb=function cb(){0==--r&&e&&e(null,t);},t={},r=3;this._renderer.isMuted(function(e,r){e||(t.muted=r),cb();}),this._renderer.getVolume(function(e,r){e||(t.volume=r),cb();}),this.getEqualizer(function(e,r){!e&&r&&(t.eq=r),cb();});}else e&&e(new Error("renderer not initialized"));},RPlayer.prototype._getRenderer=function(e,t,r){if(r){var o=require("xnm.aio.raumfeld.js");if(o.discovery&&o.discovery._mediaRenderer){var n=o.discovery._mediaRenderer[r];if(n)return n;}}var i=new(require("x.upnp.js").MediaRenderer)();return i.init(e,t,r,{avTransport:{type:"urn:schemas-upnp-org:service:AVTransport:1",url:"/AVTransport/ctrl"},connectionManager:{type:"urn:schemas-upnp-org:service:ConnectionManager:1",url:"/ConnectionManager/ctrl"},renderingControl:{type:"urn:schemas-upnp-org:service:RenderingControl:1",url:"/RenderingControl/ctrl"}}),i;},RPlayer.prototype._getFilter=function(e,t){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"GetFilter",{InstanceID:e},function(e,r){if(e)t&&t(e);else{var o={},n=r.find("LowDB");n.length>0&&(o.eqLow=$(n[0]).text()),(n=r.find("MidDB")).length>0&&(o.eqMid=$(n[0]).text()),(n=r.find("HighDB")).length>0&&(o.eqHigh=$(n[0]).text()),t&&t(null,o);}});},RPlayer.prototype._setFilter=function(e,t,r){this._renderer._doSOAPRequest(this._renderer.getURL(this._renderer.renderingControl.url),this._renderer.renderingControl.type,"SetFilter",{InstanceID:e,LowDB:t.eqLow,MidDB:t.eqMid,HighDB:t.eqHigh},function(e){r&&r(e);});},RPlayer.prototype.equalsTo=function(e){return!!e&&e instanceof RPlayer&&this.getIP()==e.getIP()&&this.getPort()==e.getPort();},RPlayer.prototype.toJSON=function(){return{sys:"raumfeld",ip:this.getIP(),port:this.getPort(),uuid:this.getUUID(),type:"player",model:this._renderer?this._renderer.modelName:null,server_uuid:null,name:this.name,room:this.room};},RPlayer;}(),xnm.aio.raumfeld.Discovery=function(){var Discover=function Discover(){"undefined"!=typeof require&&require?this._logger=require("x.logger.js").getLogger("xnm.aio.raumfeld.Discovery"):this._logger={log:{}},this._upnpCB=null,this._masterPlayer=null,this._mediaServer={},this._mediaRenderer={},this._searchRaumfeldCB=[],this._autoSearchTimeout=null,this.searchRaumfeld(null);};return Discover.prototype.getPlayer=function(e){if(!e||!e.type||!e.uuid)return null;var t=null;if("master"==e.type){if(!this._masterPlayer){if(!e.ip||!e.port)return null;this._masterPlayer=new xnm.aio.raumfeld.MasterPlayer(e.ip,e.port,e.uuid),this._masterPlayer._isDummy=!0;}t=this._masterPlayer;}else if("room"==e.type)t=this._masterPlayer.getRoomPlayer(e);else{if("player"!=e.type)return null;t=this._masterPlayer.getDedicatePlayer(e);}return t&&!t._isDummy||this.searchRaumfeld(null),t;},Discover.prototype.getDiscoveredPlayer=function(e,t){if(!e||!t)return null;var r=null;if("master"==e)r=this._masterPlayer;else if("room"==e)r=this._masterPlayer.getDiscoveredRoomPlayer(t);else{if("player"!=e)return null;r=this._masterPlayer.getDiscoveredDedicatePlayer(t);}return r&&!r._isDummy||this.searchRaumfeld(null),r;},Discover.prototype.getBufferedMediaServers=function(){var e=[];for(var t in this._mediaServer){if(this._mediaServer.hasOwnProperty(t)){var r=this._mediaServer[t];r.manufacturer&&-1!=r.manufacturer.indexOf("Raumfeld")&&(r._raumfeldMaster=!0),e.push(r);}}return e;},Discover.prototype.getBufferedPlayers=function(){if(!this._masterPlayer)return[];var e,t=null;for(e in this._mediaServer){if(this._mediaServer.hasOwnProperty(e)){var r=this._mediaServer[e];if(r&&r.ip==this._masterPlayer.getIP()){t=r.uuid;break;}}}if(!t)return[];var o=[];o.push(this._masterPlayer.toJSON());var n=this._masterPlayer.getRoomPlayers();n&&n.forEach(function(e){if(e){var r=e.toJSON();r.server_uuid=t,o.push(r);}});var i=this,a=this._masterPlayer.getDedicatePlayers();return a&&a.forEach(function(e){var r=e.toJSON(),n=r.uuid;r.server_uuid=t;var a=i._mediaRenderer[n];a&&(r.model=a.modelName),o.push(r);}),o;},Discover.prototype.searchRaumfeld=function(e){var t=this._searchRaumfeldCB.length;if(e&&-1==this._searchRaumfeldCB.indexOf(e)&&this._searchRaumfeldCB.push(e),0==t){this._autoSearchTimeout&&(clearTimeout(this._autoSearchTimeout),this._autoSearchTimeout=null),this._search();var r=this;setTimeout(function(){r._autoSearchTimeout=setTimeout(function(){r._logger.log("trace","auto search timeout, search again"),r.searchRaumfeld(null);},3e4);var e=r._searchRaumfeldCB;r._searchRaumfeldCB=[],e.forEach(function(e){e&&e();});},5e3);}},Discover.prototype._search=function(){if(!this._upnpCB){var e=this;this._upnpCB=function(t){e._findUpnpDevice(t);};}this._mediaServer={},this._mediaRenderer={};var t=require("x.upnp.js").getDiscoveryService();t.addCallback("upnp:rootdevice",this._upnpCB),t.discoverTarget("upnp:rootdevice");},Discover.prototype._findUpnpDevice=function(e){if(e){var t=e.uuid;switch(e.deviceType){case"urn:schemas-raumfeld-com:device:ConfigDevice:1":this._logger.log("trace","find raumfeld master"),this._masterPlayer||(this._masterPlayer=new xnm.aio.raumfeld.MasterPlayer(e.ip,0,e.uuid)),this._masterPlayer._isDummy=!1,this._masterPlayer.ip=e.ip,this._masterPlayer.getInfos(null);break;case"urn:schemas-upnp-org:device:MediaServer:1":this._logger.log("trace","find media server:"+e.name+" @"+e.ip),this._mediaServer[t]=e;break;case"urn:schemas-upnp-org:device:MediaRenderer:1":this._logger.log("trace","find media renderer:"+e.name+" @"+e.ip),this._mediaRenderer[t]=e;}}},Discover;}(),xnm.aio.raumfeld.DM=function(){var e={master:{command:[{type:"enum",name:"play",ref:{value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"int",name:"seek to (seconds)",ref:{value:"seekTo",ext:"%d"}},{type:"enum",name:"toggle shuffle",ref:{value:"shuffleToggle"}},{type:"enum",name:"switch repeat",ref:{value:"repeatSwitch"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"string",name:"play state",ref:{value:"playState",options:["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"]}},{type:"string",name:"track duration",ref:{value:"duration"}},{type:"int",name:"track duration (seconds)",ref:{value:"durationS"}},{type:"string",name:"track position",ref:{value:"position"}},{type:"int",name:"track position (seconds)",ref:{value:"positionS"}},{type:"string",name:"artist",ref:{value:"artist"}},{type:"string",name:"title",ref:{value:"title"}},{type:"string",name:"album",ref:{value:"album"}},{type:"enum",name:"shuffle state",ref:{value:"shuffle",options:["on","off"]}},{type:"enum",name:"repeat state",ref:{value:"repeat",options:["off","one","all"]}}]},room:{command:[{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}}]},player:{command:[{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume",ref:{value:"setVolume",ext:"%d",extMeta:"0-100"}},{type:"int",name:"set equalizer low (db)",ref:{value:"eqLowTo",ext:"%d",extMeta:"-1536-1536"}},{type:"int",name:"set equalizer middle (db)",ref:{value:"eqMidTo",ext:"%d",extMeta:"-1536-1536"}},{type:"int",name:"set equalizer high (db)",ref:{value:"eqHighTo",ext:"%d",extMeta:"-1536-1536"}}],status:[{type:"enum",name:"muted",ref:{value:"muted",options:["true","false"]}},{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-100"}},{type:"int",name:"equalizer low (db)",ref:{value:"eqLow"}},{type:"int",name:"equalizer middle (db)",ref:{value:"eqMid"}},{type:"int",name:"equalizer high (db)",ref:{value:"eqHigh"}}]}},DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="RaumfeldDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"raumfeld",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Raumfeld"}];},createDevice:function createDevice(e,t,r){var o=DMError,n=DMError.ERROR_CODE;e?e.type?e.ip?e.port?r(null,e):r(new o(n.INVALID,"port is invalid")):r(new o(n.INVALID,"ip is invalid")):r(new o(n.INVALID,"type is invalid")):r(new o(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var o=DMError,n=DMError.ERROR_CODE;e?e.type?e.ip?e.port?r(null,e):r(new o(n.INVALID,"port is invalid")):r(new o(n.INVALID,"ip is invalid")):r(new o(n.INVALID,"type is invalid")):r(new o(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},applyUIFilter:function applyUIFilter(e,t,r){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,o=0;o<e.length;o++){if(e[o]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var o=[],n=null,i=xnm.aio.raumfeld.DM.getCommandStatusMap(e,r);return i&&(n=function(e,t,r){var o=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));o.push(t);}});}return o;}(i,0,t),o=o.concat(n)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),o.command=n;break;case"status":n=_filter(e,t),o.status=n;break;default:return null;}return n&&0!=n.length?o:null;},getCommandStatusMap:function getCommandStatusMap(t,r){return t&&t.type?e[t.type]:null;},applySmartWidgetFilter:function applySmartWidgetFilter(e,t,r,o,n){var i={"%next%":{value:"next"},"%pause%":{value:"pause"},"%play%":{value:"play"},"%previous%":{value:"previous"},"%stop%":{value:"stop"},"%toggleMute%":{value:"toggleMute"},"%volume%":{value:"setVolume",ext:"%d",extMeta:"0-100"}},a={"%mutedState%":{value:"muted",options:["true","false"]},"%volumeState%":{value:"volume",extMeta:"0-100"}};"master"===t.type?(i["%seekTo%"]={value:"seekTo",ext:"%d"},i["%shuffleToggle%"]={value:"shuffleToggle"},a["%durationState%"]={value:"durationS"},a["%playState%"]={value:"playState",options:["STOPPED","PLAYING","TRANSITIONING","PAUSED_PLAYBACK","PAUSED_RECORDING","RECORDING","NO_MEDIA_PRESENT"]},a["%positionState%"]={value:"positionS"},a["%shuffleState%"]={value:"shuffle",options:["on","off"]}):"player"===t.type?(i["%balance%"]={value:"eqMidTo",ext:"%d",extMeta:"-1536-1536"},i["%bass%"]={value:"eqLowTo",ext:"%d",extMeta:"-1536-1536"},i["%treble%"]={value:"eqHighTo",ext:"%d",extMeta:"-1536-1536"},a["%balanceState%"]={value:"eqMid"},a["%bassState%"]={value:"eqLow"},a["%trebleState%"]={value:"eqHigh"}):"room"===t.type&&(delete i["%next%"],delete i["%pause%"],delete i["%play%"],delete i["%previous%"],delete i["%stop%"]);return e._injectToSmartWidgetTemplate(o,["media"],n,i,a,null);}};}(),xnm.aio.raumfeld.Handler=function(){var Handler=function Handler(){this.discovery=new xnm.aio.raumfeld.Discovery();};return Handler.prototype.devicemanager=xnm.aio.raumfeld.DM,Handler.prototype.registModule=function(e){e.register(xnm.aio.raumfeld.DM.SYS,"raumfeld");},Handler.prototype.resolveDevice=function(e){return e?this.discovery.getPlayer(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),o=r?r.command:[];t&&t(null,o);},Handler.prototype.getDeviceStatus=function(e,t){var r=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),o=r?r.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,r){var o=this.resolveDevice(e);o?o.executeCommandCreator(e,t,function(e){r&&r(e);}):r&&r(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,r,o){var n=this.resolveDevice(t);if(n){var i=[{id:e,device:t,status:r}];n.getStatesCreator(null,i,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("device json format invalid"));},Handler.prototype.discover=function(e){var t=this;this.discovery.searchRaumfeld(function(){e&&e(null,t.discovery.getBufferedPlayers());});},Handler.prototype.getPlayer=function(e,t){if(e&&e.uuid&&e.type){var r=this.discovery.getDiscoveredPlayer(e.type,e.uuid);if(r)t&&t(null,r);else{var o=this;this.discovery.searchRaumfeld(function(){r=o.discovery.getDiscoveredPlayer(e.type,e.uuid),t&&t(null,r);});}}else t&&t(new Error("device json invalid"));},Handler.prototype.getMediaServer=function(e){var t=this.discovery.getBufferedMediaServers();if(0==t.length){var r=this;this.discovery.searchRaumfeld(function(){e&&e(null,r.discovery.getBufferedMediaServers());});}else e&&e(null,t);},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.raumfeld.Handler());