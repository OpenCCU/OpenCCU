var x=x||{};x.hub=x.hub||{},x.hub.recordman=x.hub.recordman||{},x.hub.recordman.Record=function(){var R=function R(){this.id=null,this.roomName=null,this.deviceName=null,this.stateName=null,this.device=null,this.gateway=null,this.status=null,this._lastHitTime=null;};return R.prototype.isMatch=function(e){if(!e)return!1;if(!e.device||!e.device.sys)return!1;var r=require("x.hub.moduleman.js").modulemanager.getModule(e.device.sys);if(!r||!r.checkDeviceMatch)return!1;if(!r.checkDeviceMatch({device:this.device,gateway:this.gateway},e))return!1;var t=this.status;return t.ref&&t.ref.value?t=t.ref.value:t.value&&(t=t.value),t==e.data.key;},R.prototype._saveRecord=function(e){if(e&&e.data&&void 0!==e.data.value&&null!=e.data.value&&this.deviceName&&this.stateName){var r=require("x.hub.datastore.js").dataStore;if(r){var t=new Date().getTime(),i=[this.roomName,this.deviceName,this.stateName,e.data.value,t];r.openDB(function(e,r){e||r.serialize(function(){var e=i.join(" ");e="INSERT INTO windowstate(room, name, state, value, time) "+e,e+=";",r.run(e,function(e){r.close();});});});}}},R.prototype.onStatusEvt=function(e){var r=!1;if(this._logger.log("trace","check record for status event"),this.isMatch(e)&&(this._logger.log("debug","record hit:"+JSON.stringify(this.toJSON())),r=!0),r){var t=new Date().getTime();if(this._lastHitTime&&t-this._lastHitTime<2e3)return;this._lastHitTime=t,this._saveRecord(e);}},R.prototype.toJSON=function(){return{id:this.id,roomName:this.roomName,deviceName:this.deviceName,stateName:this.stateName,device:this.device,gateway:this.gateway,status:this.status};},R.parse=function(e){if(!(e&&e.id&&e.deviceName&&e.stateName))return null;var r=new R();return r.id=e.id,r.roomName=e.roomName,r.deviceName=e.deviceName,r.stateName=e.stateName,r.device=e.device,r.gateway=e.gateway,r.status=e.status,r;},R;}(),x.hub.recordman.RecordManager=function(){var RM=function RM(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.RecordManager"),this._rmFile=null,this._records=[];};return RM.FILE_NAME="rm.json",RM.prototype.init=function(e,r){var t=require("fs_extra"),i=require("path");this._rmFile||(this._rmFile=i.resolve(e.getUserRootDataPath(),RM.FILE_NAME));var a=this;t.ensureFile(this._rmFile,function(e){e?r&&r(e):a._loadRecords(function(){a._initDB(r);});});},RM.prototype.reload=function(e){this._loadRecords(e);},RM.prototype.createRecord=function(e,r){if(e){for(var t=1,i=-1,a=0;a<this._records.length;a++){if(this._records[a].id>t){e.id=t,i=a;break;}t++;}-1==i&&(e.id=t,i=this._records.length),this._records.splice(i,0,e),this._writeData(r);}else r&&r(new Error("record is null"));},RM.prototype.readRecord=function(e,r){if(e){for(var t=null,i=0;i<this._records.length;i++){var a=this._records[i];if(a.id==e){t=a;break;}}t?r&&r(null,t):r&&r(new Error("no such record with id:"+e));}else r&&r(new Error("record id is null"));},RM.prototype.readAllRecords=function(e){e&&e(null,this._records);},RM.prototype.updateRecord=function(e,r){for(var t=null,i=-1,a=0;a<this._records.length;a++){var o=this._records[a];if(o.id==e.id){t=o,i=a;break;}}t?(this._records.splice(i,1,e),this._writeData(r)):r&&r(new Error("no such record with id:"+e.id));},RM.prototype.deleteRecord=function(e,r){if(e){for(var t=-1,i=0;i<this._records.length;i++){var a=this._records[i];if(a.id==e){t=i,a;break;}}-1!=t&&this._records.splice(t,1),this._writeData(r);}else r&&r(new Error("record id is null"));},RM.prototype.onStatusEvt=function(e){this._logger.log("info","receive status event:"+JSON.stringify(e));for(var r=0;r<this._records.length;r++){this._records[r].onStatusEvt(e);}},RM.prototype._initDB=function(e){var r=require("x.hub.datastore.js").dataStore;r?r.openDB(function(r,t){r?e&&e(r):t.serialize(function(){t.run("CREATE TABLE IF NOT EXISTS devicestate (id integer primary key autoincrement, room text, name text, state text, value text,time datetime default current_timestamp)",function(r){t.close(),e&&e(r);});});}):e&&e(new Error("data store not initialized"));},RM.prototype._loadRecords=function(e){var r=this;this._readData(function(t,i){t?e&&e(t):(r._records=i,r._sort(),e&&e());});},RM.prototype._readData=function(e){require("fs").readFile(this._rmFile,"utf8",function(r,t){if(r)e&&e(r);else if(t)try{var i=JSON.parse(t),a=[];Array.isArray(i)&&i.forEach(function(e){var r=x.hub.recordman.Record.parse(e);r&&a.push(r);}),e&&e(null,a||[]);}catch(r){e&&e(r);}else e&&e(null,[]);});},RM.prototype._writeData=function(e){var r=[];this._records.forEach(function(e){e&&r.push(e.toJSON());}),require("fs").writeFile(this._rmFile,JSON.stringify(r,null,2),function(r){e&&e(r);});},RM.prototype._sort=function(){var e=this._records.length-1,r=!1;do{r=!1;for(var t=0;t<e;++t){if(this._records[t].id>this._records[t+1].id){var i=this._records[t];this._records[t]=this._records[t+1],this._records[t+1]=i,r=!0;}}}while(r);},RM;}(),x.hub.recordman.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.recordman.Handler"),this.recordManager=new x.hub.recordman.RecordManager();};return Handler.prototype.RecordManager=x.hub.recordman.RecordManager,Handler.prototype.init=function(e,r,t){require("x.hub.eventbus.js").on("status",this.onStatusEvt.bind(this)),this._config(e),this.recordManager.init(r,function(e){t&&t({error:e});});},Handler.prototype.doWebRequest=function(e,r,t){var cb=function cb(e){if(e.error){var r=x.hub.taskman.ERROR_CODE.General_Error;e.error.code&&(r=e.error.code),t(JSON.stringify({XC_ERR:{code:r,msg:e.error.message}}));}else t(JSON.stringify({XC_SUC:e.data?e.data:""}));};switch(e){case"Read":var i=r.query.id;void 0===i?this.readAllTasks(cb):this.readTask(i,cb);break;case"Create":this.createTask(r.query.data,cb);break;case"Update":this.updateTask(r.query.data,r.query.pin,cb);break;case"Delete":this.deleteTask(r.query.id,r.query.pin,cb);break;case"SetTaskActive":this.setTaskActive(r.query.id,r.query.active,r.query.pin,cb);break;case"SetAlarmActive":this.setAlarmActive(r.query.active,r.query.pin,cb);break;case"SetAlarmDelay":this.setAlarmDelay(r.query.delay,r.query.pin,cb);break;case"GetAlarmInfo":this.getAlarmInfo(cb);break;case"SelectAlarmTask":this.selectAlarmTask(r.query.id,r.query.isAlarmTask,r.query.pin,cb);break;case"SetAlarmPin":this.setAlarmPin(r.query.newPin,r.query.pin,cb);}},Handler.prototype.readAllRecords=function(e){this.recordManager.readAllRecords(function(r,t){if(r)e&&e({error:r});else{var i=[];t.forEach(function(e){i.push(e.toJSON());}),e&&e({data:i});}});},Handler.prototype.createRecord=function(e,r){if(e){e.id||(e.id=-1);var t=x.hub.recordman.Record.parse(e);t?this.recordManager.createRecord(t,function(e){r&&r({error:e});}):r&&r({error:new Error("record json invalid")});}else r&&r({error:new Error("record json is null")});},Handler.prototype.readRecord=function(e,r){this.recordManager.readRecord(e,function(e,t){r&&r({error:e,data:t?t.toJSON():null});});},Handler.prototype.updateRecord=function(e,r){if(e){var t=x.hub.recordman.Record.parse(e);t?this.recordManager.updateRecord(t,function(e){r&&r({error:e});}):r&&r({error:new Error("record json invalid")});}else r&&r({error:new Error("record json is null")});},Handler.prototype.deleteRecord=function(e,r){this.recordManager.deleteRecord(e,function(e){r&&r({error:e});});},Handler.prototype.onStatusEvt=function(e){this._logger.log("trace","receive status event:"+JSON.stringify(e)),this.recordManager.onStatusEvt(e);},Handler;}(),module.exports=new x.hub.recordman.Handler();