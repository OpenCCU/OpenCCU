var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.systemdata=xnm.aio.systemdata||{},xnm.aio.systemdata.SystemData=function(){this._sysData=null,this._sceneData=null,this._dataKey="system",this._sceneKey="scenes",this.reset=function(){XC.localStorage.removeItem(this._dataKey),XC.localStorage.removeItem(this._sceneKey),this.init();},this.init=function(){this._sysData=this.load(),this._sysData&&!this._sysData.demo||(this._sysData={rooms:[],devices:[],gateways:[]},this.save()),this._sceneData=this.loadScenes(),this._sceneData||(this._sceneData={groups:[{index:1,macros:[],name:"Gruppe",classid:"group"}]},this.saveScenes());},this.save=function(e){e?(XC.localStorage.setJson(this._dataKey,e),this._sysData=e):XC.localStorage.setJson(this._dataKey,this._sysData);},this.saveScenes=function(e){e?(XC.localStorage.setJson(this._sceneKey,e),this._sceneData=e):XC.localStorage.setJson(this._sceneKey,this._sceneData);},this.load=function(){return XC.localStorage.getJson(this._dataKey);},this.loadScenes=function(){return XC.localStorage.getJson(this._sceneKey);},this._getNextIndex=function(e){if(0===e.length)return 1;for(var t=0,s=0;s<e.length;s++){t<e[s].index&&(t=e[s].index);}return t+1;},this.addGateway=function(e,t){if(!("gtw"===t.common_type?this.getGateways(function(e){return e.info.address==t.address;}).length>0:this.getGateways(function(e){return e.info.mac==t.mac;}).length>0)){var s=this._getNextIndex(this._sysData.gateways);return e=this._getFreeGatewayName(e),this._sysData.gateways.push({name:e,index:s,info:t}),this.save(),this._sysData.gateways[this._sysData.gateways.length-1];}},this.saveGateway=function(e){for(var t=0;t<this._sysData.gateways.length;t++){var s=this._sysData.gateways[t];if(s.index===e.index)return s.name=e.name,s.user=e.user,s.pwd=e.pwd,s.tasks=e.tasks,s.info.ip=e.info.ip,s.info.sid=e.info.sid,s._codeNames=e._codeNames,s.info._token=e.info._token,s.info.server=e.info.server,s.info.firmware=e.info.firmware,s.info._cloudAccessActive=e.info._cloudAccessActive,this.save(),void XC.debugf("gateway changed saved");}},this.getGateways=function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:!1;var s=this._sysData.gateways.slice(0);if(t||(s=s.filter(function(e){return"aio"===e.info.sys&&"gtw"!==e.info.common_type||"cloudservice"===e.info.sys;})),!e)return s;for(var a=[],i=0;i<s.length;i++){e(s[i])&&a.push(s[i]);}return a;},this.deleteGateways=function(e){for(var t=this._sysData.gateways.length;t--;){e(this._sysData.gateways[t])&&this._sysData.gateways.splice(t,1);}this.save();},this.addRoom=function(e){return e.index=this._getNextIndex(this._sysData.rooms),this._sysData.rooms.push(e),this.save(),e;},this.saveRoom=function(e){for(var t=0;t<this._sysData.rooms.length;t++){var s=this._sysData.rooms[t];if(s.index===e.index)return s.name=e.name,s.type=e.type,void this.save();}},this.getRooms=function(e){var t=this._sysData.rooms.slice(0);if(!e)return t;filtered=[];for(var s=0;s<t.length;s++){e(t[s])&&filtered.push(t[s]);}return filtered;},this.deleteRooms=function(e){for(var t=this._sysData.rooms.length;t--;){e(this._sysData.rooms[t])&&(this.deleteDevices(function(e){return e.room===this._sysData.rooms[t].index;}.bind(this)),this._sysData.rooms.splice(t,1));}this.save();},this.addDevice=function(e){if(e){if(!(this.getDevices(function(t){return"CODE"!==t.info.type&&"FX3"!==t.info.type&&t.info.address&&e.info.address&&t.info.address==e.info.address;}).length>0))return e.index=this._getNextIndex(this._sysData.devices),e.cloud={enabled:!0},this._sysData.devices.push(e),this.save(),e;this.addDeviceDuplicate&&"function"==typeof this.addDeviceDuplicate&&this.addDeviceDuplicate();}},this.addDeviceDuplicate=null,this.saveDevice=function(e){for(var t=0;t<this._sysData.devices.length;t++){var s=this._sysData.devices[t];if(s.index===e.index)return s.name=e.name,s.order=e.order,s.info._isFav=e.info._isFav,s.info._target=e.info._target,void this.save();}},this.getDevices=function(e){var t=this._sysData.devices.slice(0);if(!e)return t;filtered=[];for(var s=0;s<t.length;s++){e(t[s])&&filtered.push(t[s]);}return filtered;},this.deleteDevices=function(e){for(var t=this._sysData.devices.length;t--;){e(this._sysData.devices[t])&&(this._unlearnDevice(this._sysData.devices[t]),this._sysData.devices.splice(t,1));}this.save();},this.addScene=function(e){return e.index=this._getNextIndex(this._getSceneList()),e.cloud={enabled:!0},this._getSceneList().push(e),this.saveScenes(),e;},this.saveScene=function(e){for(var t=this._getSceneList(),s=0;s<t.length;s++){var a=t[s];if(a.index===e.index)return a.name=e.name,a.pause=e.pause,a.commands=e.commands,void this.saveScenes();}},this.getScenes=function(e){var t=this._getSceneList().slice(0);if(!e)return t;for(var s=[],a=0;a<t.length;a++){e(t[a])&&s.push(t[a]);}return s;},this.deleteScenes=function(e){for(var t=this._getSceneList(),s=t.length;s--;){e(t[s])&&t.splice(s,1);}this.saveScenes();},this._getSceneList=function(){return this._sceneData.groups[0].macros;},this.getHueGatewayInfo=function(e){return{ip:e.ip,sys:"hue",port:e.port,uuid:e.uuid,username:e._USER,password:""};},this.getV6Info=function(e){return{ip:e.IP,sn:e.SN,dns:e.DNS,mac:e.MAC,hwv:e.HWV,vid:e.VID,sys:"aio",name:e.NAME,dhcp:e.DHCP,server:e.SERVER,version:e.VER,gateway_vendor:"mediola"};},this.getV5PlusInfo=function(e){return{ip:e.ip,tz:e.TZ,mac:e.mac,ntp:e.ntp,sys:"aio",lat:e.LAT,hwv:e.hwv,port:80,"long":e.LONG,name:e.name,server:e.server,rfmode:e.RFM,username:"user",password:"",firmware:e.msv,gateway_vendor:"mediola",_cloudAccessActive:!(64&Number("0x"+e.cfg))};},this._getFreeGatewayName=function(e){var _this=this;for(var t=1,s="",nameOkay=function nameOkay(){return!_this.getGateways(function(t){return t.name===e+s;},!0)[0];};!nameOkay();){t++,s=" "+t;}return e+s;},this._unlearnDevice=function(e){var t=this._getGatewayByDevice(e);if(t){var s=require("xnm.aio.gateway.js");if(t=s.resolveGateway(t.info)){var a=s.devicemanager.getSystem(e.info,t.info);a&&(a.delSensor&&a.delSensor(t,e.info.address,function(e){e&&XC.debugf("SystemData: unlearn device error: "+e);}),a.deleteDevice&&e.info.id&&a.deleteDevice(t,{id:e.info.id},function(e){e&&XC.debugf("SystemData: unlearn device error: "+e);}));}}},this._getGatewayByDevice=function(e){return this.getGateways(function(t){return t.index===e.info.gateway;},!0)[0];},this.init();},xnm.aio.systemdata.Handler=function(){},xnm.aio.systemdata.Handler.prototype.SystemData=xnm.aio.systemdata.SystemData,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.systemdata.Handler());