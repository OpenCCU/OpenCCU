var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.gealan=xnm.aio.gealan||{},xnm.aio.gealan.Fan=function(){var t={_stateTimeout:10,_errorTimeout:5,_buffer:{},getFanStates:function getFanStates(t){var e=this._buffer[t];e||(this._buffer[t]={},e=this._buffer[t]);var n=e.fan;if(!n)return e.fan={},void(n=e.fan);var a=n.time,r=Math.round(new Date().getTime()/1e3);return!a||r-a>this._stateTimeout||null==n.states&&r-a>this._errorTimeout?void 0:n.states;},setFanStates:function setFanStates(t,e){var n=this._buffer[t];n||(this._buffer[t]={},n=this._buffer[t]);var a=n.fan;a||(n.fan={},a=n.fan);var r=Math.round(new Date().getTime()/1e3);a.states=e,a.time=r;},getFilterStates:function getFilterStates(t){var e=this._buffer[t];e||(this._buffer[t]={},e=this._buffer[t]);var n=e.filter;if(!n)return e.filter={},void(n=e.filter);var a=n.time,r=Math.round(new Date().getTime()/1e3);return!a||r-a>this._stateTimeout||null==n.states&&r-a>this._errorTimeout?void 0:n.states;},setFilterStates:function setFilterStates(t,e){var n=this._buffer[t];n||(this._buffer[t]={},n=this._buffer[t]);var a=n.filter;a||(n.filter={},a=n.filter);var r=Math.round(new Date().getTime()/1e3);a.states=e,a.time=r;}},Fan=function Fan(t,e,n,a){if(this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.Fan"),this._ip=t,this._port=e,this._port||(this._port=443),80==this._port&&(this._port=443),this._username=n,this._password=a,this._timeout=5e3,this._readMainCallbacks=[],this._readAmbientsCallbacks=[],this._readFilterCallbacks=[],this._readLogCallbacks=[],this._readFanCallbacks=[],this._readWlanScanCallbacks=[],this._readCounterCallbacks=[],this._httpReqBuffer=[],this._configUdpServerInterval=null,"undefined"!=typeof process&&null!=process&&process.env){var r=require("https");this._keepAliveAgent=new r.Agent({keepAlive:!0,maxSockets:1});}};return Fan.prototype.executeCommandCreator=function(t,e,n){var a;if(e&&e.value)switch(e.value){case"on":this._setOn(n);break;case"off":this._setStandBy(n);break;case"setLevel":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("level value invalid")));switch(a){case 0:this._setStandBy(n);break;case 1:this._setLevel1(n);break;case 2:this._setLevel2(n);break;case 3:this._setLevel3(n);break;case 4:this._setLevel4(n);break;case 5:this._setLevel5(n);break;default:n&&n(new Error("level value out of range"));}break;case"automatic":this._setAutomatic(n);break;case"manual":this._setManual(n);break;case"nextLevel":this._setNextLevel(n);break;case"previousLevel":this._setPreviousLevel(n);break;case"nightIn":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("night in value invalid")));switch(a){case 1:this._setNightIn1(n);break;case 2:this._setNightIn2(n);break;case 3:this._setNightIn3(n);break;default:n&&n(new Error("night in value out of range"));}break;case"nightOut":if(a=parseInt(e.ext),isNaN(a))return void(n&&n(new Error("night out value invalid")));switch(a){case 1:this._setNightOut1(n);break;case 2:this._setNightOut2(n);break;case 3:this._setNightOut3(n);break;default:n&&n(new Error("night out value out of range"));}break;case"resetFilter":this._resetFilter(calllback);break;case"resetError":this._resetError(calllback);}else n&&n(new Error("command value is empty"));},Fan.prototype.getStatesCreator=function(t,e,n){for(var a=this,_doReq=function _doReq(t,e,n){var r,o,s=[];switch(t){case"main":a.getMainStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++){if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"tempIn":case"tempOut":case"humIn":case"humOut":case"sleepMode":s.push({id:o.id,status:a[o.status.value]});}}n(null,s);}});break;case"general":a.getGeneralStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++){if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"level":case"mode":case"stateNr":case"stateNrInt":case"error":case"errorNr":case"nightSpeed":case"filterReplace":case"logEntries":case"humidityNr":case"freezeNr":case"usageMode":case"nightModeState":s.push({id:o.id,status:a[o.status.value]});}}n(null,s);}});break;case"ambients":a.getAmbientsStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++){if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"temp1":case"temp2":case"temp3":case"temp4":case"hum1":case"hum2":s.push({id:o.id,status:a[o.status.value]});}}n(null,s);}});break;case"filter":a.getFilterStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++){if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"elapsed":case"remaining":s.push({id:o.id,status:a?a[o.status.value]:"?"});}}n(null,s);}});break;case"fan":a.getFanStates(function(t,a){if(t)n(t);else{for(r=0;r<e.length;r++){if((o=e[r])&&o.id&&o.status)switch(o.status.value){case"targetRSIn":case"currentRSIn":case"targetRSOut":case"currentRSOut":case"maxRS":case"minRS":s.push({id:o.id,status:a?a[o.status.value]:"?"});}}n(null,s);}});}},r=[],o=0;o<e.length;o++){var s=e[o];if(s&&s.id&&s.status&&s.status.value)switch(s.status.value){case"tempIn":case"tempOut":case"humIn":case"humOut":case"sleepMode":-1==r.indexOf("main")&&r.push("main");break;case"level":case"mode":case"stateNr":case"stateNrInt":case"error":case"errorNr":case"nightSpeed":case"filterReplace":case"logEntries":case"humidityNr":case"freezeNr":case"usageMode":case"nightModeState":-1==r.indexOf("general")&&r.push("general");break;case"temp1":case"temp2":case"temp3":case"temp4":case"hum1":case"hum2":-1==r.indexOf("ambients")&&r.push("ambients");break;case"elapsed":case"remaining":-1==r.indexOf("filter")&&r.push("filter");break;case"targetRSIn":case"currentRSIn":case"targetRSOut":case"currentRSOut":case"maxRS":case"minRS":-1==r.indexOf("fan")&&r.push("fan");}}if(0!=r.length){var i=0,u=[],cb=function cb(a,o){i++,!a&&o&&(u=u.concat(o),void 0!==t&&null!=t&&void 0!==t.reportStates&&null!=t.reportStates&&t.reportStates(null,o)),i<r.length?_doReq(r[i],e,cb):n&&n(null,u);};_doReq(r[i],e,cb);}else n&&n(null,[]);},Fan.prototype.getMainStates=function(t){var e=this;this._readMain(function(n,a){if(n)t&&t(n);else{var r=e._resolveMainStates(a);t&&t(null,r);}});},Fan.prototype._resolveMainStates=function(t){var e={};return e.tempIn=parseInt(t.TempIn)/100,e.tempOut=parseInt(t.TempOut)/100,e.humIn=parseInt(t.HumidityIn)/100,e.humOut=parseInt(t.HumidityOut)/100,e.sleepMode="yes"==t.SleepMode,e;},Fan.prototype.getGeneralStates=function(t){var e=this;this._readStatus(function(n,a){if(n)t&&t(n);else{var r=e._resolveGeneralStates(a);t&&t(null,r);}});},Fan.prototype._resolveGeneralStates=function(t){var e={};return e.stateNr=parseInt(t.StateNr),e.stateNr<=5?(e.level=e.stateNr,e.mode="MANUAL"):(e.level="",e.mode=t.State),10==e.stateNr?(e.error=t.Error,e.errorNr=t.ErrorNr):(e.error="",e.errorNr=""),7==e.stateNr||8==e.stateNr?e.nightSpeed=parseInt(t.NightSpeed):e.nightSpeed="",e.stateNrInt=parseInt(t.StateNrInternal),e.logEntries=parseInt(t.LOGEntries),e.filterReplace="yes"==t.ReplaceFilter,e.humidityNr=parseInt(t.StateOfHumidityNr),e.freezeNr=parseInt(t.StateOfFreezeNr),e.usageMode=parseInt(t.UsageMode),e.nightModeState=parseInt(t.NightModeState),e;},Fan.prototype.getAmbientsStates=function(t){var e=this;this._readAmbients(function(n,a){if(n)t&&t(n);else{var r=e._resolveAmbientsStates(a);t&&t(null,r);}});},Fan.prototype._resolveAmbientsStates=function(t){var e={};return e.temp1=parseInt(t.Temp1)/100,e.temp2=parseInt(t.Temp2)/100,e.temp3=parseInt(t.Temp3)/100,e.temp4=parseInt(t.Temp4)/100,e.hum1=parseInt(t.Humidity1)/100,e.hum2=parseInt(t.Humidity2)/100,e;},Fan.prototype.getFilterStates=function(e){var n=t.getFilterStates(this._ip);if(void 0!==n)return null!=n&&(n=this._resolveFilterStates(n)),void(e&&e(null,n));var a=this;this.readFilter(function(n,r){t.setFilterStates(a._ip,n?null:r);var o=a._resolveFilterStates(r);e&&e(null,o);});},Fan.prototype._resolveFilterStates=function(t){var e={};return e.elapsed=parseInt(t.Elapsed),e.remaining=parseInt(t.Remaining),e;},Fan.prototype.getFanStates=function(e){var n=t.getFanStates(this._ip);if(void 0!==n)return null!=n&&(n=this._resolveFanStates(n)),void(e&&e(null,n));var a=this;this.readFan(function(n,r){t.setFanStates(a._ip,n?null:r);var o=a._resolveFanStates(r);e&&e(null,o);});},Fan.prototype._resolveFanStates=function(t){var e={};return e.targetRSIn=parseInt(t.TargetRotationSpeedIN),e.currentRSIn=parseInt(t.ActualRotationSpeedIN),e.targetRSOut=parseInt(t.TargetRotationSpeedOUT),e.currentRSOut=parseInt(t.ActualRotationSpeedOUT),e.maxRS=parseInt(t.MaxRotationSpeed),e.minRS=parseInt(t.MinRotationSpeed),e;},Fan.prototype.configUdpServer=function(t,e,n){t||(t="255.255.255.255"),e||(e=1903);var a=this;this.setUdpServer(t,e,function(r){r?n&&n(r):(a._configUdpServerInterval&&clearInterval(a._configUdpServerInterval),a._configUdpServerInterval=setInterval(function(){a.setUdpServer(t,e);},6e5),n&&n());});},Fan.prototype.setStandBy=function(t){this._setStandBy(t);},Fan.prototype._setStandBy=function(t){this._doRequest("POST","/CommandSET_STANDBY.cmd",null,function(e){t&&t(e);});},Fan.prototype.setOn=function(t){this._setOn(t);},Fan.prototype._setOn=function(t){this._doRequest("POST","/CommandSET_ON.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLevel1=function(t){this._setLevel1(t);},Fan.prototype._setLevel1=function(t){this._doRequest("POST","/CommandSET_LEVEL1.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLevel2=function(t){this._setLevel2(t);},Fan.prototype._setLevel2=function(t){this._doRequest("POST","/CommandSET_LEVEL2.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLevel3=function(t){this._setLevel3(t);},Fan.prototype._setLevel3=function(t){this._doRequest("POST","/CommandSET_LEVEL3.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLevel4=function(t){this._setLevel4(t);},Fan.prototype._setLevel4=function(t){this._doRequest("POST","/CommandSET_LEVEL4.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLevel5=function(t){this._setLevel5(t);},Fan.prototype._setLevel5=function(t){this._doRequest("POST","/CommandSET_LEVEL5.cmd",null,function(e){t&&t(e);});},Fan.prototype.setAutomatic=function(t){this._setAutomatic(t);},Fan.prototype._setAutomatic=function(t){this._doRequest("POST","/CommandSET_AUTOMATIC.cmd",null,function(e){t&&t(e);});},Fan.prototype.setManual=function(t){this._setManual(t);},Fan.prototype._setManual=function(t){this._doRequest("POST","/CommandSET_MANUAL.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNextLevel=function(t){this._setNextLevel(t);},Fan.prototype._setNextLevel=function(t){this._doRequest("POST","/CommandSET_NEXT_LEVEL.cmd",null,function(e){t&&t(e);});},Fan.prototype.setPreviousLevel=function(t){this._setPreviousLevel(t);},Fan.prototype._setPreviousLevel=function(t){this._doRequest("POST","/CommandSET_PREV_LEVEL.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightIn1=function(t){this._setNightIn1(t);},Fan.prototype._setNightIn1=function(t){this._doRequest("POST","/CommandSET_N_IN1.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightIn2=function(t){this._setNightIn2(t);},Fan.prototype._setNightIn2=function(t){this._doRequest("POST","/CommandSET_N_IN2.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightIn3=function(t){this._setNightIn3(t);},Fan.prototype._setNightIn3=function(t){this._doRequest("POST","/CommandSET_N_IN3.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightOut1=function(t){this._setNightOut1(t);},Fan.prototype._setNightOut1=function(t){this._doRequest("POST","/CommandSET_N_OUT1.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightOut2=function(t){this._setNightOut2(t);},Fan.prototype._setNightOut2=function(t){this._doRequest("POST","/CommandSET_N_OUT2.cmd",null,function(e){t&&t(e);});},Fan.prototype.setNightOut3=function(t){this._setNightOut3(t);},Fan.prototype._setNightOut3=function(t){this._doRequest("POST","/CommandSET_N_OUT3.cmd",null,function(e){t&&t(e);});},Fan.prototype._resetFilter=function(t){this._doRequest("POST","/CommandRESET_FILTER.cmd",null,function(e){t&&t(e);});},Fan.prototype.readMainA=function(t){this._readMain(function(e,n){t&&t(e,n);});},Fan.prototype.readMainB=function(t){this._asyncRead("_readMainCallbacks","_cmdReadMain","_readMain",t);},Fan.prototype._cmdReadMain=function(t){this._doRequest("POST","/CommandREAD_MAIN.cmd",null,function(e){t&&t(e);});},Fan.prototype._readMain=function(t){this._doRequestXML("GET","/CmdResultREAD_MAIN.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_MAIN response invalid"));});},Fan.prototype.readStatus=function(t){this._readStatus(function(e,n){t&&t(e,n);});},Fan.prototype._readStatus=function(t){this._doRequestXML("GET","/CmdResultREAD_STATUS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_STATUS response invalid"));});},Fan.prototype.readSoftware=function(t){this._readSoftware(function(e,n){t&&t(e,n);});},Fan.prototype._readSoftware=function(t){this._doRequestXML("GET","/CmdResultREAD_SOFTWARE.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_SOFTWARE response invalid"));});},Fan.prototype.readAmbientsA=function(t){this._readAmbients(function(e,n){t&&t(e,n);});},Fan.prototype.readAmbientsB=function(t){this._asyncRead("_readAmbientsCallbacks","_cmdReadAmbients","_readAmbients",t);},Fan.prototype._cmdReadAmbients=function(t){this._doRequest("POST","/CommandREAD_AMBIENTS.cmd",null,function(e){t&&t(e);});},Fan.prototype._readAmbients=function(t){this._doRequestXML("GET","/CmdResultREAD_AMBIENTS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_AMBIENTS response invalid"));});},Fan.prototype.readFilter=function(t){this._asyncRead("_readFilterCallbacks","_cmdReadFilter","_readFilter",t);},Fan.prototype.readFilter2=function(t){this._readFilter(function(e,n){t&&t(e,n);});},Fan.prototype._cmdReadFilter=function(t){this._doRequest("GET","/CommandREAD_FILTER.cmd",null,function(e){t&&t(e);});},Fan.prototype._readFilter=function(t){this._doRequestXML("GET","/CmdResultREAD_FILTER.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_FILTER response invalid"));});},Fan.prototype.readLog=function(t,e){var n=this._readLogCallbacks.length;if(e&&-1==this._readLogCallbacks.indexOf(e)&&this._readLogCallbacks.push(e),0==n){var a=this,_doCallbacks=function _doCallbacks(t,e){var n=a._readLogCallbacks;a._readLogCallbacks=[];for(var r=0;r<n.length;r++){try{n[r](t,e);}catch(t){}}};this._cmdParameterReadLog(t,function(e){if(e)_doCallbacks(e);else{var n=0,cb=function cb(e,r){e?_doCallbacks(e):"yes"!=r.ready?n>50?_doCallbacks(new Error("result not ready")):(n++,setTimeout(function(){a._readLog(t,cb);},500)):_doCallbacks(null,r);};a._readLog(t,cb);}});}},Fan.prototype._cmdParameterReadLog=function(t,e){this._doRequest("POST","/CommandPARAMETER_READ_LOG"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype._readLog=function(t,e){this._doRequestXML("GET","/CmdResultPARAMETER_READ_LOG"+t+".cmd",null,function(t,n){t?e&&e(t):n&&n.State?e&&e(null,n.State):e&&e(new Error("PARAMETER_READ_LOG response invalid"));});},Fan.prototype.readFan=function(t){this._asyncRead("_readFanCallbacks","_cmdReadFan","_readFan",t);},Fan.prototype._cmdReadFan=function(t){this._doRequest("POST","/CommandREAD_FAN.cmd",null,function(e){t&&t(e);});},Fan.prototype._readFan=function(t){this._doRequestXML("GET","/CmdResultREAD_FAN.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_FAN response invalid"));});},Fan.prototype.readWlanScan=function(t){this._asyncRead("_readWlanScanCallbacks","_cmdReadWlanScan","_readWlanScan",t);},Fan.prototype._cmdReadWlanScan=function(t){this._doRequest("POST","/CommandREAD_WLANSCAN.cmd",null,function(e){t&&t(e);});},Fan.prototype._readWlanScan=function(t){this._doRequestXML("GET","/CmdResultREAD_WLANSCAN.cmd",null,function(e,n){e?t&&t(e):n&&n.WiFi?t&&t(null,n.WiFi):t&&t(new Error("READ_WLANSCAN response invalid"));});},Fan.prototype.readIpMac=function(t){this._readIpMac(function(e,n){t&&t(e,n);});},Fan.prototype._readIpMac=function(t){this._doRequestXML("GET","/CmdResultREAD_IPMAC.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("CmdResultREAD_IPMAC.cmd response invalid"));});},Fan.prototype.readWifiSettings=function(t){this._readWifiSettings(function(e,n){t&&t(e,n);});},Fan.prototype._readWifiSettings=function(t){this._doRequestXML("GET","/CmdResultREAD_WIFISETTINGS.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_MAIN response invalid"));});},Fan.prototype.readSignal=function(t){this._readSignal(function(e,n){t&&t(e,n);});},Fan.prototype._readSignal=function(t){this._doRequestXML("GET","/CmdResultREAD_SIGNAL.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_SIGNAL response invalid"));});},Fan.prototype.readLED=function(t){this._readLED(function(e,n){t&&t(e,n);});},Fan.prototype._readLED=function(t){this._doRequestXML("GET","/CmdResultREAD_LED.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_LED response invalid"));});},Fan.prototype.readCommon=function(t){this._readCommon(function(e,n){t&&t(e,n);});},Fan.prototype._readCommon=function(t){this._doRequestXML("GET","/CmdResultREAD_COMMON.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_COMMON response invalid"));});},Fan.prototype.readCounter=function(t){this._asyncRead("_readCounterCallbacks","_cmdReadCounter","_readCounter",t);},Fan.prototype._cmdReadCounter=function(t){this._doRequest("GET","/CommandREAD_COUNTER.cmd",null,function(e){t&&t(e);});},Fan.prototype._readCounter=function(t){this._doRequestXML("GET","/CmdResultREAD_COUNTER.cmd",null,function(e,n){e?t&&t(e):n&&n.State?t&&t(null,n.State):t&&t(new Error("READ_COUNTER response invalid"));});},Fan.prototype.readSerial=function(t){this._readSerial(function(e,n){t&&t(e,n);});},Fan.prototype._readSerial=function(t){this._doRequest("GET","/CmdResultREAD_SERIALNR.cmd",null,function(e,n){t&&t(e,n);});},Fan.prototype.readName=function(t){this._readName(function(e,n){t&&t(e,n);});},Fan.prototype._readName=function(t){this._doRequest("GET","/CmdResultREAD_NAME.cmd",null,function(e,n){t&&t(e,n);});},Fan.prototype.changeName=function(t,e){this._cmdParamChangeName(t,function(t){e&&e(t);});},Fan.prototype._cmdParamChangeName=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHANGE_NAME"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.setWlanOff=function(t,e){this._cmdParamWlanOff(t,function(t){e&&e(t);});},Fan.prototype._cmdParamWlanOff=function(t,e){this._doRequest("POST","/CommandPARAMETER_WLAN_OFF"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.selectSTA=function(t,e,n){var a=this;this._cmdParamChooseWlanNet(t,function(t){t?n&&n(t):a._cmdParamChooseWlanPwd(e,function(t){t?n&&n(t):a._cmdSelectSTA(function(t){n&&n(t);});});});},Fan.prototype._cmdParamChooseWlanNet=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANNET"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype._cmdParamChooseWlanPwd=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHOOSEWLANPWD"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype._cmdSelectSTA=function(t){this._doRequest("POST","/CommandSELECT_STA.cmd",null,function(e){t&&t(e);});},Fan.prototype.setLedTimeout=function(t,e){this._cmdParamLedTimeout(t,function(t){e&&e(t);});},Fan.prototype._cmdParamLedTimeout=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_TIMEOUT"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.setLedIntensity=function(t,e){this._cmdParamLedIntensity(t,function(t){e&&e(t);});},Fan.prototype._cmdParamLedIntensity=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_INTENSITY"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.setLedReverseDirection=function(t,e){this._cmdParamLedReverseDirection(t?"yes":"no",function(t){e&&e(t);});},Fan.prototype._cmdParamLedReverseDirection=function(t,e){this._doRequest("POST","/CommandPARAMETER_LED_REVERSE_DIRECTION"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.setExtKeyActive=function(t,e){this._cmdParamExtkeyActive(t?"yes":"no",function(t){e&&e(t);});},Fan.prototype._cmdParamExtkeyActive=function(t,e){this._doRequest("POST","/CommandPARAMETER_EXTKEY_ACTIVE"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype.setUdpServer=function(t,e,n){this._cmdParamUdpServer(t,e,function(t){n&&n(t);});},Fan.prototype._cmdParamUdpServer=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_UDP_SERVER"+t+":"+e+".cmd",null,function(t){n&&n(t);});},Fan.prototype.identify=function(t,e,n){this._cmdParamIdentify(t,e,function(t){n&&n(t);});},Fan.prototype._cmdParamIdentify=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_IDENTIFY"+t+"_"+e+".cmd",null,function(t){n&&n(t);});},Fan.prototype.startTestRGBs=function(t,e){this._cmdParamTestRGBs(t,1,function(t){e&&e(t);});},Fan.prototype.stopTestRGBs=function(t){this._cmdParamTestRGBs("ffffff",0,function(e){t&&t(e);});},Fan.prototype._cmdParamTestRGBs=function(t,e,n){this._doRequest("POST","/CommandPARAMETER_TESTRGBS"+t+"_"+e+".cmd",null,function(t){n&&n(t);});},Fan.prototype.resetError=function(t){this._resetError(function(e){t&&t(e);});},Fan.prototype._resetError=function(t){this._doRequest("POST","/CommandRESET_ERROR.cmd",null,function(e){t&&t(e);});},Fan.prototype.quitError=function(t){this._cmdQuitError(function(e){t&&t(e);});},Fan.prototype._cmdQuitError=function(t){this._doRequest("POST","/CommandQUIT_ERROR.cmd",null,function(e){t&&t(e);});},Fan.prototype.restart=function(t){this._cmdRestart(function(e){t&&t(e);});},Fan.prototype._cmdRestart=function(t){this._doRequest("POST","/CommandRESTART.cmd",null,function(e){t&&t(e);});},Fan.prototype.resetWlan=function(t){this._cmdResetWlan(function(e){t&&t(e);});},Fan.prototype._cmdResetWlan=function(t){this._doRequest("POST","/CommandRESET_WLAN.cmd",null,function(e){t&&t(e);});},Fan.prototype.resetData=function(t){this._cmdResetData(function(e){t&&t(e);});},Fan.prototype._cmdResetData=function(t){this._doRequest("POST","/CommandRESET_DATA.cmd",null,function(e){t&&t(e);});},Fan.prototype.saveStampStartup=function(t,e){var n=t.getFullYear()+"";n=n.substr(2,2);var a=t.getMonth()+1+"";a.length<2&&(a="0"+a);var r=t.getDate()+"";r.length<2&&(r="0"+r);var o=t.getHours()+"";o.length<2&&(o="0"+o);var s=t.getMinutes()+"";s.length<2&&(s="0"+s),this._cmdParamStampStartup(n,a,r,o,s,function(t){e&&e(t);});},Fan.prototype._cmdParamStampStartup=function(t,e,n,a,r,o){this._doRequest("POST","/CommandPARAMETER_STAMP_STARTUP"+t+e+n+a+r+".cmd",null,function(t){o&&o(t);});},Fan.prototype.changeAPPwd=function(t,e){this._cmdParamChangeAppwd(t,function(t){e&&e(t);});},Fan.prototype._cmdParamChangeAppwd=function(t,e){this._doRequest("POST","/CommandPARAMETER_CHANGE_APPWD"+t+".cmd",null,function(t){e&&e(t);});},Fan.prototype._asyncRead=function(t,e,n,a){var r=this[t].length;if(a&&-1==this[t].indexOf(a)&&this[t].push(a),0==r){var o=this,_doCallbacks=function _doCallbacks(e,n){var a=o[t];o[t]=[];for(var r=0;r<a.length;r++){try{a[r](e,n);}catch(t){}}};this[e](function(t){if(t)_doCallbacks(t);else{var e=0,cb=function cb(t,a){t?_doCallbacks(t):"yes"!=a.ready?e>50?_doCallbacks(new Error("result not ready")):(e++,setTimeout(function(){o[n](cb);},500)):_doCallbacks(null,a);};o[n](cb);}});}},Fan.prototype._doRequestXML=function(t,e,n,a){var r=this;this._doRequest(t,e,n,function(t,e){if(t)a&&a(t);else{var n=null;e&&(n=r._xml2json(e))&&n["?xml-stylesheet"]&&(n=n["?xml-stylesheet"]),a&&a(null,n);}});},Fan.prototype._xml2json=function(t){var _xml2obj=function _xml2obj(t){var e={};return t.children().each(function(){var t=$(this),n=t.prop("tagName"),a=null;a=0==t.children().length?t.text():_xml2obj(t);var r=e[n];void 0===r||null==r?e[n]=a:Array.isArray(r)?r.push(a):e[n]=[r,a];}),e;};try{var e,n=$($.parseXML(t));if(!(e=n.getRootNode?n.getRootNode():$(n.children()[0])))return null;var a=e.prop("tagName"),r=_xml2obj(e),o={};return o[a]=r,o;}catch(t){return null;}},Fan.prototype._doRequest=function(t,e,n,a){var r=this._httpReqBuffer.length;this._httpReqBuffer.push({method:t,path:e,data:n,callback:a}),0==r&&this._doNextHttpReq();},Fan.prototype._doNextHttpReq=function(){if(0!=this._httpReqBuffer.length){var t=this._httpReqBuffer[0],e=this;this._doRequestHttp(t.method,t.path,t.data,function(n,a){t.callback&&t.callback(n,a),e._httpReqBuffer.splice(0,1),e._doNextHttpReq();});}},Fan.prototype._doRequestHttp=function(t,e,n,a){var r="https://"+this._ip+":"+this._port+e;this._logger.log("trace","send "+t+" to url: "+r+" data:"+n);var o={host:this._ip,port:this._port,path:e,method:t,headers:{}};(this._username||this._password)&&(o.auth=(this._username?this._username:"")+":"+(this._password?this._password:""),o.headers.Authorization="Basic "+new Buffer((this._username?this._username:"")+":"+(this._password?this._password:"")).toString("base64"));var s=this,i=a,u=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0",o.agent=this._keepAliveAgent);var l=u.request(o,function(t){t.setEncoding("utf-8");var e="";t.on("data",function(t){e+=t;}),t.on("end",function(){if(s._logger.log("trace",r+" response "+t.statusCode+": "+e),200==t.statusCode)i&&i(null,e);else{var n=new Error("http response "+t.statusCode);i&&i(n);}i=null;});});l.setTimeout(this._timeout,function(){s._logger.log("trace","http request "+r+" timeout"),i&&(i(new Error("http request timeout")),i=null),l.abort();}),l.on("error",function(t){s._logger.log("trace","http request "+r+" error:"+t.message),i&&(i(t),i=null);}),n&&l.write(n),l.end();},Fan.prototype._doRequestAjax=function(t,e,n,a){var r=this,o="http://"+this._ip+":"+this._port+e;this._logger.log("trace","send "+t+" to url:"+o+" data:"+n);var s=a;$.ajax({url:o,type:t,timeout:this._timeout,data:n,dataType:"text",cache:!1,username:this._username,password:this._password,success:function success(t){r._logger.log("trace","http request success:"+t),s&&(s(null,t),s=null);},error:function error(t,e){var n="http request error:"+(t?t.status:"0")+"-"+e;r._logger.log("trace",n),s&&(s(new Error(n)),s=null);}});},Fan.prototype.toJSON=function(){return{sys:"gealan",ip:this._ip,port:this._port,username:this._username,password:this._password};},Fan.prototype.equalsTo=function(t){return!!t&&t instanceof Fan&&this._ip==t._ip&&this._port==t._port;},Fan.parseJSON=function(t){return t&&t.ip?new Fan(t.ip,t.port,t.username,t.password):null;},Fan;}(),xnm.aio.gealan.UdpListener=function(){var L=function L(t){this._logger=require("x.logger.js").getLogger("xnm.aio.gealan.EventListener"),this._port=t,this._port||(this._port=1903),this._state=0,this._socket=null,this._callbacks=[],this._listeners=[];};return L.prototype.start=function(t){if(2!=this._state){if(1!=this._state){var e=this;this._state=1,this._logger.log("debug","start listen to port "+this._port),this._startUdpListener(this._port,function(t,n){t?(e._state=0,e._logger.log("debug","failed to listen to port "+e._port+":"+t.message)):(e._state=2,e._socket=n,e._logger.log("debug","listen to port "+e._port+" success"));var a=e._callbacks;e._callbacks=[];for(var r=0;r<a.length;r++){a[r](t);}});}else t&&-1==this._callbacks.indexOf(t)&&this._callbacks.push(t);}else t&&t();},L.prototype.stop=function(t){if(0!=this._state){if(1==this._state)return this._socket&&(this._socket.close(),this._socket=null),this._state=0,void(t&&t());this._socket&&(this._socket.close(),this._socket=null),this._state=0,t&&t();}else t&&t();},L.prototype.addListener=function(t){t&&-1==this._listeners.indexOf(t)&&this._listeners.push(t);},L.prototype.removeListener=function(t){if(t){var e=this._listeners.indexOf(t);-1!=e&&this._listeners.splice(e,1);}},L.prototype._startUdpListener=function(t,e){var n=this,a=e,r=require("dgram").createSocket({type:"udp4",reuseAddr:!0});r.on("listening",function(){r.setBroadcast&&r.setBroadcast(!0),n._logger.log("trace","udp listener started at port:"+t),a&&(a(null,r),a=null);}),r.on("error",function(e){a?(n._logger.log("trace","bind udp listener at port:"+t+" error:"+e.stack),a(e),a=null):(n._logger.log("trace","udp listener at port:"+t+" error:"+e.stack),n.stop());}),r.on("message",function(e,a){var r=e.toString();n._logger.log("trace","receive udp message at port:"+t+" from:"+a.address+" data:"+r);var o=r.split(" "),s=null;s="Status"==o[0]&&"changed"==o[1]?{key:"Status changed",value:o[2]}:"new"==o[0]&&"IP"==o[1]?{key:"new IP",value:o[2]}:{key:o[0],value:o[1]};for(var i=0;i<n._listeners.length;i++){try{n._listeners[i](s,a);}catch(t){}}}),r.bind(t);},L;}(),xnm.aio.gealan.DM=function(){var t={command:[{type:"int",name:"set level",ref:{value:"setLevel",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"automatic",ref:{value:"automatic"}},{type:"enum",name:"manual",ref:{value:"manual"}},{type:"enum",name:"next level",ref:{value:"nextLevel"}},{type:"enum",name:"previous level",ref:{value:"previousLevel"}},{type:"enum",name:"reset filter",ref:{value:"resetFilter"}},{type:"enum",name:"reset error",ref:{value:"resetError"}}],status:[{type:"int",name:"temperature inside",ref:{value:"tempIn",ext:"%d"}},{type:"int",name:"temperature outside",ref:{value:"tempOut",ext:"%d"}},{type:"int",name:"humidity inside",ref:{value:"humIn",ext:"%d"}},{type:"int",name:"humidity outside",ref:{value:"humOut",ext:"%d"}},{type:"int",name:"level",ref:{value:"level",ext:"%d",extMeta:"0-5"}},{type:"enum",name:"mode",ref:{value:"mode",options:["MANUAL","AUTOMATIC","NIGHT_IN","NIGHT_OUT","FLAP_CLOSED","ERROR","FROST_PROTECTION","MOISTURE_PROTECTION"]}},{type:"int",name:"state no.",ref:{value:"stateNr",ext:"%d",extMeta:"0-12"}},{type:"int",name:"state no. (internal)",ref:{value:"stateNrInt",ext:"%d"}},{type:"string",name:"error message",ref:{value:"error",ext:"%s"}},{type:"int",name:"error no.",ref:{value:"errorNr",ext:"%d"}},{type:"int",name:"night speed",ref:{value:"nightSpeed",ext:"%d",extMeta:"1-3"}},{type:"enum",name:"replace filter",ref:{value:"filterReplace",options:["true","false"]}},{type:"enum",name:"sleep mode",ref:{value:"sleepMode",options:["true","false"]}},{type:"int",name:"log entries",ref:{value:"logEntries",ext:"%d"}},{type:"int",name:"humidity no.",ref:{value:"humidityNr",ext:"%d"}},{type:"int",name:"freeze no.",ref:{value:"freezeNr",ext:"%d"}},{type:"int",name:"usage mode",ref:{value:"usageMode",ext:"%d"}},{type:"int",name:"night mode state",ref:{value:"nightModeState",ext:"%d"}},{type:"int",name:"temperature exhaust air (outside)",ref:{value:"temp1",ext:"%d"}},{type:"int",name:"temperature supply air (inside)",ref:{value:"temp2",ext:"%d"}},{type:"int",name:"temperature supply air (outside)",ref:{value:"temp3",ext:"%d"}},{type:"int",name:"temperature exhaust air (inside)",ref:{value:"temp4",ext:"%d"}},{type:"int",name:"humidity supply air (outside)",ref:{value:"hum1",ext:"%d"}},{type:"int",name:"humidity exhaust air (inside)",ref:{value:"hum2",ext:"%d"}},{type:"int",name:"filter elapsed time",ref:{value:"elapsed",ext:"%d"}},{type:"int",name:"filter remaining time",ref:{value:"remaining",ext:"%d"}},{type:"int",name:"target rotation speed in",ref:{value:"targetRSIn",ext:"%d"}},{type:"int",name:"actual rotation speed in",ref:{value:"currentRSIn",ext:"%d"}},{type:"int",name:"target rotation speed out",ref:{value:"targetRSOut",ext:"%d"}},{type:"int",name:"actual rotation speed out",ref:{value:"currentRSOut",ext:"%d"}},{type:"int",name:"max rotation speed",ref:{value:"maxRS",ext:"%d"}},{type:"int",name:"min rotation speed",ref:{value:"minRS",ext:"%d"}}]},DMError=function DMError(t,e){this.code=t,this.message=e,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="GealanDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"gealan",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Gealan Fan"}];},createDevice:function createDevice(t,e,n){var a=DMError,r=DMError.ERROR_CODE;t?t.type?t.ip?n(null,t):n(new a(r.INVALID,"ip is invalid")):n(new a(r.INVALID,"type is invalid")):n(new a(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(t,e,n){var a=DMError,r=DMError.ERROR_CODE;t?t.type?t.ip?n(null,t):n(new a(r.INVALID,"ip is invalid")):n(new a(r.INVALID,"type is invalid")):n(new a(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(t,e,n){n();},applyUIFilter:function applyUIFilter(t,e,n){var a=this,_contains=function _contains(t,e){if("*"==t)return!0;for(var n=!1,a=0;a<t.length;a++){if(t[a]==e){n=!0;break;}}return n;},_filter=function _filter(t,e){var r=[],o=null,s=a.getCommandStatusMap(t,n);return s&&(o=function(t,e,n){var a=[];switch(n.catagory){case"command":t.command&&t.command.forEach(function(t){if(_contains(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));a.push(e);}});break;case"status":t.status&&t.status.forEach(function(t){if(_contains(n.elems,t.type)){var e=JSON.parse(JSON.stringify(t));a.push(e);}});}return a;}(s,0,e),r=r.concat(o)),r;};if(!t.sys)return null;var r=JSON.parse(JSON.stringify(t)),o=null;switch(e.catagory){case"command":o=_filter(t,e),r.command=o;break;case"status":o=_filter(t,e),r.status=o;break;default:return null;}return o&&0!=o.length?r:null;},getCommandStatusMap:function getCommandStatusMap(e,n){return t;}};}(),xnm.aio.gealan.Handler=function(){var Handler=function Handler(){this._udpListener=new xnm.aio.gealan.UdpListener(1903);};return Handler.prototype.devicemanager=xnm.aio.gealan.DM,Handler.prototype.Fan=xnm.aio.gealan.Fan,Handler.prototype.registModule=function(t){t.register("gealan","gealan");},Handler.prototype.resolveDevice=function(t){return this.Fan.parseJSON(t);},Handler.prototype.getDeviceCommands=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"command",elems:"*"}),a=n?n.command:[];e&&e(null,a);},Handler.prototype.getDeviceStatus=function(t,e){var n=this.devicemanager.applyUIFilter(t,{catagory:"status",elems:"*"}),a=n?n.status:[];e&&e(null,a);},Handler.prototype.doCommand=function(t,e,n){var a=this.resolveDevice(t);a?a.executeCommandCreator(t,e,function(t){n&&n(t);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(t,e,n,a){var r=this.resolveDevice(e);if(r){var o=[{id:t,device:e,status:n}];r.getStatesCreator(null,o,function(t,e){t?a&&a(t):a&&a(null,e[0]);});}else a&&a(new Error("device json format invalid"));},Handler.prototype.getUdpListener=function(){return this._udpListener;},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.gealan.Handler());