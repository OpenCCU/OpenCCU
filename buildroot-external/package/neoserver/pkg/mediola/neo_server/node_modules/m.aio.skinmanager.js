function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var m=m||{};m.aio=m.aio||{},m.aio.skinmanager=m.aio.skinmanager||{},m.aio.skinmanager.Resource=function(){this.widget=null,this.name=null,this.file=null,this.sha1=null,this.size=null,this.mtime=null;},m.aio.skinmanager.Resource.load=function(e,n,i,t){var r=require("unorm"),s=new m.aio.skinmanager.Resource();s.widget=i,s.name=r.nfc(n),s.file=e,t&&t(null,s);},m.aio.skinmanager.Resource.loadSync=function(e,n,i){var t=require("unorm"),r=new m.aio.skinmanager.Resource();return r.widget=i,r.name=t.nfc(n),r.file=e,r;},m.aio.skinmanager.Resource.prototype={copy:function copy(e,n,i){this._copy(this.file,e,n,i);},copySync:function copySync(e,n){this._copySync(this.file,e,n);},_copy:function _copy(e,n,i,t){var r=require("fs-extra"),s=require("path");if(n){if(i){if(this.widget&&this.widget.type&&this.widget.name){if(this.file){var a=n+s.sep+i+s.sep+this.widget.type+s.sep+this.widget.name+s.sep+this.name;a!=this.file?r.copy(e,a,{clobber:!0},function(e){t&&t(e);}):t&&t();}else t&&t(new Error("resource file invalid"));}else t&&t(new Error("resource widget invalid"));}else t&&t(new Error("skinId invalid"));}else t&&t(new Error("skinFolder invalid"));},_copySync:function _copySync(e,n,i){var t=require("fs-extra"),r=require("path");if(!n)throw new Error("skinFolder invalid");if(!i)throw new Error("skinId invalid");if(!this.widget||!this.widget.type||!this.widget.name)throw new Error("resource widget invalid");if(!this.file)throw new Error("resource file invalid");var s=n+r.sep+i+r.sep+this.widget.type+r.sep+this.widget.name+r.sep+this.name;s!=this.file&&t.copySync(e,s,{clobber:!0});},del:function del(e){this.file?require("fs").unlink(this.file,function(n){e&&e(n);}.bind(this)):e&&e(new Error("resource file invalid"));},getRef:function getRef(){if(!this.widget||!this.widget.skin)return null;var e="";return(this.widget.skin instanceof m.aio.skinmanager.DummySkin||this.widget.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin)&&(e=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"),e+this.widget.type+"/"+this.widget.name+"/"+this.name;},getURL:function getURL(){if(!this.widget||!this.widget.skin)return null;var e=this.widget.skin.getURL();return e.widgetType=this.widget.type,e.widgetName=this.widget.name,e.resourcePath=this.name,e.toString();},toJSON:function toJSON(){return{name:this.name,ref:this.getRef(),url:this.getURL()};}},m.aio.skinmanager.Widget=function(){this.skin=null,this.type=null,this.name=null,this.resources=[];},m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE="misc",m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME="default",m.aio.skinmanager.Widget.loadType=function(e,n,i,t){var r=require("fs"),s=require("async"),a=require("path");r.readdir(e,function(r,o){if(r)t&&t(r);else{var u=[];s.eachLimit(o,100,function(t,r){m.aio.skinmanager.Widget.load(e+a.sep+t,n,t,i,function(e,n){!e&&n&&u.push(n),r();});},function(e){t&&t(e,u);});}});},m.aio.skinmanager.Widget.load=function(e,n,i,t,r){var s=require("fs"),a=require("path");require("async");s.readdir(e,function(s,o){if(s)r&&r(s);else{var u=require("unorm"),c=new m.aio.skinmanager.Widget();c.skin=t,c.type=u.nfc(n),c.name=u.nfc(i);var l=[];o.forEach(function(n){if(".DS_Store"!==n){var i=new m.aio.skinmanager.Resource.loadSync(e+a.sep+n,n,c);i&&l.push(i);}}),l&&0!=l.length?(c.resources=l,r&&r(null,c)):r&&r(new Error("widget has no resources"));}});},m.aio.skinmanager.Widget.prototype={getLocation:function getLocation(){var e=null;return this.skin&&(e=this.skin instanceof m.aio.skinmanager.DummySkin?"in_remote_custom":this.skin instanceof m.aio.skinmanager.LocalCustomWidgetDummySkin?"local_custom":this.skin instanceof m.aio.skinmanager.RemoteSkin?"in_remote_skin":this.skin instanceof m.aio.skinmanager.CustomSkin?"local_custom_skin":"local_skin"),e;},copy:function copy(e,n,i){this._copy(this.skin.path,e,n,i);},copySync:function copySync(e,n){this._copySync(this.skin.path,e,n);},_copy:function _copy(e,n,i,t){var r=require("fs-extra"),s=require("path");if(e){if(n){if(i){if(this.type&&this.name){var a=n+s.sep+i+s.sep+this.type+s.sep+this.name,o=e+s.sep+this.type+s.sep+this.name;r.copy(o,a,{clobber:!0},function(e){t&&t(e);});}else t&&t(new Error("widget type or name invalid"));}else t&&t(new Error("skinId invalid"));}else t&&t(new Error("dstSkinFolder invalid"));}else t&&t(new Error("srcSkinFolder invalid"));},_copySync:function _copySync(e,n,i){var t=require("fs-extra"),r=require("path");if(!e)throw new Error("srcSkinFolder invalid");if(!n)throw new Error("dstSkinFolder invalid");if(!i)throw new Error("skinId invalid");if(!this.type||!this.name)throw new Error("widget type or name invalid");var s=n+r.sep+i+r.sep+this.type+r.sep+this.name,a=e+r.sep+this.type+r.sep+this.name;t.copySync(a,s,{clobber:!0});},del:function del(e){if(this.skin){if(this.type){if(this.name){var n=this.skin.path;if(n){var i=require("path"),t=require("fs-extra"),r=n+i.sep+this.type+i.sep+this.name;t.remove(r,function(n){e&&e(n);});}else e&&e(new Error("skin path is null"));}else e&&e(new Error("widgetName is null"));}else e&&e(new Error("widgetType is null"));}else e&&e(new Error("skin is null"));},hasSameRef:function hasSameRef(e){return this.type==e.type&&this.name==e.name;},merge:function merge(e){if(e.resources&&0!=e.resources.length)if(this.resources&&0!=this.resources.length){for(var n=[],i=0;i<e.resources.length;i++){for(var t=!1,r=0;r<this.resources.length;r++){if(this.resources[r].name==e.resources[i].name){t=!0,this.resources[r]=e.resources[i];break;}}t||n.push(e.resources[i]);}this.resources=this.resources.concat(n);}else this.resources=e.resources;},toJSON:function toJSON(){var e={type:this.type,name:this.name,resources:[]};return e._loc=this.getLocation(),this.resources.forEach(function(n){e.resources.push(n.toJSON());}),e;}},m.aio.skinmanager.Skin=function(e){this.type=e,this.id=null,this.name=null,this.version=null,this.system=null,this.base=null,this.schema=null,this.info=null,this.path=null;},m.aio.skinmanager.Skin.SETTINGS_FILE="settings",m.aio.skinmanager.Skin.TYPE={SYSTEM:1,CUSTOM:2,REMOTE:3,DUMMY:4},m.aio.skinmanager.Skin.load=function(e,n,i,t){if(e){var r=require("fs"),s=require("path"),a=e+s.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;r.readFile(a,{encoding:"utf8"},function(r,s){if(r){if(i.skinType!==m.aio.skinmanager.Skin.TYPE.REMOTE)return void(t&&t(r));s=JSON.stringify({id:n,name:"in-remote",system:1});}if(s&&0!=s.length){var o=null;try{o=JSON.parse(s);}catch(e){return void(t&&t(new Error("settings file of "+a+" is not in json")));}if(o.name){var u=null;switch(i.skinType){case m.aio.skinmanager.Skin.TYPE.SYSTEM:u=new m.aio.skinmanager.SystemSkin();break;case m.aio.skinmanager.Skin.TYPE.CUSTOM:u=new m.aio.skinmanager.CustomSkin();break;case m.aio.skinmanager.Skin.TYPE.REMOTE:if(!i.tenantId||!i.remoteId)return void(t&&t(new Error("skinType info invalid")));u=new m.aio.skinmanager.RemoteSkin(i.tenantId,i.remoteId);break;case m.aio.skinmanager.Skin.TYPE.DUMMY:if(!i.tenantId||!i.remoteId)return void(t&&t(new Error("skinType info invalid")));u=new m.aio.skinmanager.DummySkin(i.tenantId,i.remoteId);break;default:return void(t&&t(new Error("skin type invalid")));}u.id=n,u.name=o.name,u.version=o.version?o.version:0,u.system=o.system?o.system:1,u.base=o.base,u.schema=o.schema?o.schema:0,u.info=o.info||null,u.path=e,t&&t(null,u);}else t&&t(new Error("skin has no name"));}else t&&t(new Error("settings file of "+a+" is empty"));});}else t&&t(new Error("invalid skin path"));},m.aio.skinmanager.Skin.prototype={updateVersion:function updateVersion(e,n){var i=this,t=require("fs"),r=require("path"),s=this.path+r.sep+m.aio.skinmanager.Skin.SETTINGS_FILE;t.readFile(s,{encoding:"utf8"},function(r,a){if(r)n&&n(r);else if(a&&0!=a.length){var o=null;try{o=JSON.parse(a);}catch(e){return void(n&&n(new Error("settings file of "+s+" is not in json")));}parseInt(o.version)!=parseInt(e)?(o.version=parseInt(e),t.writeFile(s,JSON.stringify(o),{encoding:"utf8"},function(t){t||(i.version=parseInt(e)),n&&n(t);})):n&&n(null);}else n&&n(new Error("settings file of "+s+" is empty"));});},loadWidgets:function loadWidgets(e){var n=require("fs"),i=require("path"),t=require("async");n.readdir(this.path,function(n,r){if(n)e&&e(n);else{var s=[];t.eachLimit(r,100,function(e,n){m.aio.skinmanager.Widget.loadType(this.path+i.sep+e,e,this,function(e,i){!e&&i&&(s=s.concat(i)),n();});}.bind(this),function(n){e&&e(n,s);}.bind(this));}}.bind(this));},toJSON:function toJSON(){return{type:this.type,id:this.id,name:this.name,version:this.version,system:this.system,base:this.base,schema:this.schema,folder:this.path,info:this.info};}},m.aio.skinmanager.SystemSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.SYSTEM);},m.aio.skinmanager.SystemSkin.prototype=new m.aio.skinmanager.Skin(),m.aio.skinmanager.SystemSkin.prototype.constructor=m.aio.skinmanager.SystemSkin,m.aio.skinmanager.SystemSkin.prototype.getURL=function(){var e=new m.aio.skinmanager.LocalUrl();return e.skinId=this.id,e;},m.aio.skinmanager.CustomSkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.CUSTOM);},m.aio.skinmanager.CustomSkin.prototype=new m.aio.skinmanager.Skin(),m.aio.skinmanager.CustomSkin.prototype.constructor=m.aio.skinmanager.CustomSkin,m.aio.skinmanager.CustomSkin.prototype.getURL=function(){var e=new m.aio.skinmanager.LocalUrl();return e.skinId=this.id,e;},m.aio.skinmanager.RemoteSkin=function(e,n){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.REMOTE),this.tenantId=e,this.remoteId=n;},m.aio.skinmanager.RemoteSkin.URL_PREFIX="REMOTE",m.aio.skinmanager.RemoteSkin.prototype=new m.aio.skinmanager.Skin(),m.aio.skinmanager.RemoteSkin.prototype.constructor=m.aio.skinmanager.RemoteSkin,m.aio.skinmanager.RemoteSkin.prototype.getURL=function(){var e=new m.aio.skinmanager.InRemoteUrl();return e.tenantId=this.tenantId,e.remoteId=this.remoteId,e.skinId=this.id,e;},m.aio.skinmanager.DummySkin=function(e,n){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY),this.id=m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this.tenantId=e,this.remoteId=n;},m.aio.skinmanager.DummySkin.prototype=new m.aio.skinmanager.Skin(),m.aio.skinmanager.DummySkin.prototype.constructor=m.aio.skinmanager.DummySkin,m.aio.skinmanager.DummySkin.prototype.getURL=function(){var e=new m.aio.skinmanager.InRemoteCustomWidgetUrl();return e.tenantId=this.tenantId,e.remoteId=this.remoteId,e;},m.aio.skinmanager.LocalCustomWidgetDummySkin=function(){m.aio.skinmanager.Skin.call(this,m.aio.skinmanager.Skin.TYPE.DUMMY);},m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype=new m.aio.skinmanager.Skin(),m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetDummySkin,m.aio.skinmanager.LocalCustomWidgetDummySkin.prototype.getURL=function(){return new m.aio.skinmanager.LocalCustomWidgetUrl();},m.aio.skinmanager.Url=function(e){this.prefix=e;},m.aio.skinmanager.Url.PREFIX={LOCAL:"LOCAL",INREMOTE:"INREMOTE"},m.aio.skinmanager.Url.resolve=function(e){var n=e.split("/"),i=null,t=null;switch(n[0]){case m.aio.skinmanager.Url.PREFIX.LOCAL:if(n.length<2)return null;switch(n[1]){case"skins":if(n.length<6)return null;(i=new m.aio.skinmanager.LocalUrl()).skinId=n[2],i.widgetType=n[3],i.widgetName=n[4],t=n.slice(5),i.resourcePath=t.join("/");break;case"custom":if(n.length<5)return null;(i=new m.aio.skinmanager.LocalCustomWidgetUrl()).widgetType=n[2],i.widgetName=n[3],t=n.slice(4),i.resourcePath=t.join("/");break;default:return null;}break;case m.aio.skinmanager.Url.PREFIX.INREMOTE:if(n.length<6)return null;if("tenant"!=n[1]||"remote"!=n[3])return null;switch(n[5]){case m.aio.skinmanager.SkinManager.SKIN_FLODER:if(i=new m.aio.skinmanager.InRemoteUrl(),n.length<10)return null;i.skinId=n[6],i.widgetType=n[7],i.widgetName=n[8],t=n.slice(9),i.resourcePath=t.join("/");break;case m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER:if(i=new m.aio.skinmanager.InRemoteCustomWidgetUrl(),n.length<9)return null;i.widgetType=n[6],i.widgetName=n[7],t=n.slice(8),i.resourcePath=t.join("/");break;default:return null;}i.tenantId=n[2],i.remoteId=n[4];break;default:return null;}return i;},m.aio.skinmanager.LocalUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL),this.skinId=null,this.widgetType=null,this.widgetName=null,this.resourcePath=null;},m.aio.skinmanager.LocalUrl.prototype=new m.aio.skinmanager.Url(),m.aio.skinmanager.LocalUrl.prototype.constructor=m.aio.skinmanager.LocalUrl,m.aio.skinmanager.LocalUrl.prototype.toString=function(){return this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null;},m.aio.skinmanager.LocalCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.LOCAL),this.widgetType=null,this.widgetName=null,this.resourcePath=null;},m.aio.skinmanager.LocalCustomWidgetUrl.prototype=new m.aio.skinmanager.Url(),m.aio.skinmanager.LocalCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.LocalCustomWidgetUrl,m.aio.skinmanager.LocalCustomWidgetUrl.prototype.toString=function(){return this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null;},m.aio.skinmanager.InRemoteUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE),this.tenantId=null,this.remoteId=null,this.skinId=null,this.widgetType=null,this.widgetName=null,this.resourcePath=null;},m.aio.skinmanager.InRemoteUrl.prototype=new m.aio.skinmanager.Url(),m.aio.skinmanager.InRemoteUrl.prototype.constructor=m.aio.skinmanager.InRemoteUrl,m.aio.skinmanager.InRemoteUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.skinId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.SKIN_FLODER+"/"+this.skinId+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null;},m.aio.skinmanager.InRemoteCustomWidgetUrl=function(){m.aio.skinmanager.Url.call(this,m.aio.skinmanager.Url.PREFIX.INREMOTE),this.tenantId=null,this.remoteId=null,this.widgetType=null,this.widgetName=null,this.resourcePath=null;},m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype=new m.aio.skinmanager.Url(),m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.constructor=m.aio.skinmanager.InRemoteCustomWidgetUrl,m.aio.skinmanager.InRemoteCustomWidgetUrl.prototype.toString=function(){return this.tenantId&&this.remoteId&&this.widgetType&&this.widgetName&&this.resourcePath?this.prefix+"/tenant/"+this.tenantId+"/remote/"+this.remoteId+"/"+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER+"/"+this.widgetType+"/"+this.widgetName+"/"+this.resourcePath:null;},m.aio.skinmanager.SkinManager={SKIN_FLODER:"skins",CUSTOM_IN_REMOTE_WIDGET_FOLDER:"custom",RESOURCE_FOLDER:"resources",sysSkinsPath:null,customSkinsPath:null,customWidgetPath:null,_configmanager:null,skins:[],_logger:null,init:function init(e,n,i){var t=function(e){var n=require("async"),i=require("fs");n.parallel([function(e){i.mkdir(this.sysSkinsPath,function(){e();});}.bind(this),function(e){i.mkdir(this.customSkinsPath,function(){e();});}.bind(this),function(e){i.mkdir(this.customWidgetPath,function(){e();});}.bind(this)],function(){e&&e();});}.bind(this),r=require("x.logger.js");this._logger=r.getLogger("m.aio.skinmanager.SkinManager");var s=require("path"),a=e.getAppResourcePath();if(a){var o=e.getUserResourcePath();if(o)this.sysSkinsPath=a+s.sep+this.SKIN_FLODER,this.customSkinsPath=o+s.sep+this.SKIN_FLODER,this.customWidgetPath=o+s.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,this._configmanager=n,require("async").series([function(e){t(e);}.bind(this),function(e){this._loadAllSkins(function(n,i){!n&&i&&(this.skins=i),e();}.bind(this));}.bind(this)],function(){i&&i();}.bind(this));else i&&i(new Error("user resource path invalid"));}else i&&i(new Error("app resource path invalid"));},_loadAllSkins:function _loadAllSkins(e){var n=[];require("async").parallel([function(e){this._loadSkins(this.sysSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.SYSTEM},function(i,t){!i&&t&&(n=n.concat(t)),e();});}.bind(this),function(e){this._loadSkins(this.customSkinsPath,{skinType:m.aio.skinmanager.Skin.TYPE.CUSTOM},function(i,t){!i&&t&&(n=n.concat(t)),e();});}.bind(this)],function(i){e&&e(i,n);});},_loadSkins:function _loadSkins(e,n,i){var t=require("fs"),r=require("path"),s=require("async"),a=[];t.readdir(e,function(t,o){!t&&o?s.each(o,function(i,t){m.aio.skinmanager.Skin.load(e+r.sep+i,i,n,function(e,n){!e&&n&&a.push(n),t();});}.bind(this),function(e){i(e,a);}):i(null,a);}.bind(this));},_getPermittedSkins:function _getPermittedSkins(e,n,i){var t="config/tenants/"+e;this._configmanager.trace(t,function(e,t){if(e)i&&i(e);else{for(var r=t.license,s=[],a=require("m.aio.infomanager"),o=0;o<n.length;o++){if(n[o]&&n[o].id)if(2==n[o].type)s.push(n[o]);else{var u=n[o].id;a.permitSkin(u,r)&&s.push(n[o]);}}i&&i(null,s);}}.bind(this));},_isSkinPermitted:function _isSkinPermitted(e,n,i){for(var t=0;t<this.skins.length;t++){if(this.skins[t]&&this.skins[t].id&&this.skins[t]&&this.skins[t].id==n&&2==this.skins[t].type)return void(i&&i(null,!0));}var r=this._configmanager,s=require("m.aio.infomanager"),a="config/tenants/"+e;r.trace(a,function(e,t){e?i&&i(e):i&&i(null,s.permitSkin(n,t.license));}.bind(this));},getResourceByURL:function getResourceByURL(e,n){var _checkResource=function _checkResource(e,n,i){var t=this._getSkin(e,n.skinId);t?_checkSkinResource(t,n,function(r,s){r||!s?t.base&&(t=this._getSkin(e,t.base))?_checkSkinResource(t,n,function(e,n){e?i&&i(e):i&&i(null,n);}):i&&i(new Error("invalid resource path")):i&&i(null,s);}.bind(this)):i&&i(new Error("no such skin"));},_checkSkinResource=function _checkSkinResource(e,n,i){var t=require("path"),r=require("fs"),s=t.join(e.path,n.widgetType,n.widgetName,n.resourcePath);r.exists(s,function(e){e?i&&i(null,s):i&&i(new Error("no such resource"));});},i=require("path"),t=require("fs"),r=m.aio.skinmanager.Url.resolve(e);if(r instanceof m.aio.skinmanager.LocalUrl)_checkResource.call(this,this.skins,r,n);else if(r instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var s=this.customWidgetPath+i.sep+r.widgetType+i.sep+r.widgetName+i.sep+r.resourcePath;t.exists(s,function(e){e?n&&n(null,s):n&&n(new Error("no such resource"));});}else r instanceof m.aio.skinmanager.InRemoteUrl?this._getInRemoteSkins(r.tenantId,r.remoteId,function(e,i){e?n&&n(e):_checkResource.call(this,i,r,n);}.bind(this)):r instanceof m.aio.skinmanager.InRemoteCustomWidgetUrl?this._getRemoteFolder(r.tenantId,r.remoteId,function(e,s){if(e)n&&n(e);else{var a=s+i.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER+i.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,o=i.join(a,r.widgetType,r.widgetName,r.resourcePath);t.exists(o,function(e){e?n&&n(null,o):n&&n(new Error("no such resource"));});}}.bind(this)):n&&n(new Error("no such resource"));},deleteResourceByURL:function deleteResourceByURL(e,n){var i=require("path"),t=require("fs"),r=m.aio.skinmanager.Url.resolve(e);if(r instanceof m.aio.skinmanager.LocalCustomWidgetUrl){var s=this.customWidgetPath+i.sep+r.widgetType+i.sep+r.widgetName+i.sep+r.resourcePath;t.exists(s,function(e){e?t.unlink(s,function(e){n&&n(e);}):n&&n();});}else n&&n(new Error("can not delete this type of resource"));},getSkinList:function getSkinList(e,n,i){var t=[];e&&n?this._getInRemoteSkins(e,n,function(n,r){!n&&r&&(t=t.concat(r)),this._getPermittedSkins(e,this.skins,function(e,n){!e&&n&&(t=t.concat(n)),i&&i(null,t);});}.bind(this)):this._getPermittedSkins(e,this.skins,function(e,n){!e&&n&&(t=t.concat(n)),i&&i(null,t);});},uploadResource:function uploadResource(e,n,i,t,r,s){if(e&&n){i||(i=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE),t||(t=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME),r||(r=e);var a=require("path"),o=require("async"),u=require("fs-extra"),c=require("fs-extra"),l=this.customWidgetPath+a.sep+i+a.sep+t,g=l+a.sep+r;o.series([function(e){u.ensureDir(l,e);},function(e){u.exists(g,function(n){n?c.move(g,g+"_del",function(n){n?e(n):u.unlink(g+"_del",function(n){e(n);});}):e();});},function(e){c.move(n,g,function(n){e(n);});}],function(e){if(e)s&&s(e);else{var n=new m.aio.skinmanager.LocalCustomWidgetUrl();n.widgetType=i,n.widgetName=t,n.resourcePath=r,s&&s(null,n.toString());}});}else s&&s(new Error("invalid paramters"));},_uploadResource:function _uploadResource(e,n,i,t,r){if(e&&n&&i&&t){var s=require("path");this._getRemoteFolder(e,n,function(a,o){if(a)r&&r(a);else{var u=require("async"),c=require("fs"),l=o+s.sep+m.aio.skinmanager.SkinManager.RESOURCE_FOLDER;u.series([function(e){c.mkdir(l,function(){e();});},function(e){l=l+s.sep+m.aio.skinmanager.SkinManager.CUSTOM_IN_REMOTE_WIDGET_FOLDER,c.mkdir(l,function(){e();});},function(e){l=l+s.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,c.mkdir(l,function(){e();});},function(e){l=l+s.sep+m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,c.mkdir(l,function(){e();});}],function(a){if(a)r&&r(a);else{var o=l+s.sep+i;c.rename(t,o,function(t){if(t)r&&r(t);else{var s=new m.aio.skinmanager.InRemoteCustomWidgetUrl();s.tenantId=e,s.remoteId=n,s.widgetType=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_TYPE,s.widgetName=m.aio.skinmanager.Widget.DEFAULT_CUSTOM_WIDGET_NAME,s.resourcePath=i,r&&r(null,s.toString());}});}});}});}else r&&r(new Error("invalid paramters"));},getRemoteWidgets:function getRemoteWidgets(e,n,i,t,r){if(e){if(n){"string"==typeof t&&(t="true"==t);var s=[];require("async").parallel([function(i){this._getInRemoteCustomWidgets(e,n,function(e,n){!e&&n&&(s=s.concat(n)),i();});}.bind(this),function(e){this._getLocalCustomWidgets(function(n,i){!n&&i&&(s=s.concat(i)),e();}.bind(this));}.bind(this),function(r){i?t?this._getInRemoteSkinWidgets(e,n,i,function(e,n){!e&&n&&(s=s.concat(n)),r();}):this._isSkinPermitted(e,i,function(e,n){!e&&n?this._getLocalSkinWidgets(i,function(e,n){!e&&n&&(s=s.concat(n)),r();}):r();}.bind(this)):r();}.bind(this)],function(e){r&&r(e,s);});}else r&&r(new Error("remote id invalid"));}else r&&r(new Error("tenant id invalid"));},_getLocalSkinWidgets:function _getLocalSkinWidgets(e,n){e?this._getSkinWidgets(this.skins,e,function(e,i){n&&n(e,i);}):n&&n(new Error("skin id invalid"));},_getLocalCustomWidgets:function _getLocalCustomWidgets(e){var n=new m.aio.skinmanager.LocalCustomWidgetDummySkin();n.path=this.customWidgetPath,n.loadWidgets(function(n,i){e&&e(n,i);});},_getInRemoteSkinWidgets:function _getInRemoteSkinWidgets(e,n,i,t){this._getInRemoteSkins(e,n,function(e,n){e?t&&t(e):this._getSkinWidgets(n,i,function(e,n){t&&t(e,n);});}.bind(this));},_getInRemoteSkins:function _getInRemoteSkins(e,n,i){var t=require("path");this._getRemoteFolder(e,n,function(r,s){if(r)i&&i(r);else{var a=s+t.sep+this.RESOURCE_FOLDER+t.sep+this.SKIN_FLODER;this._loadSkins(a,{skinType:m.aio.skinmanager.Skin.TYPE.REMOTE,tenantId:e,remoteId:n},function(e,n){i&&i(e,n);}.bind(this));}}.bind(this));},_getInRemoteCustomWidgets:function _getInRemoteCustomWidgets(e,n,i){var t=require("path");this._getRemoteFolder(e,n,function(r,s){if(r)i&&i(r);else{var a=s+t.sep+this.RESOURCE_FOLDER+t.sep+this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,o=new m.aio.skinmanager.DummySkin(e,n);o.path=a,o.loadWidgets(function(e,n){i&&i(e,n);});}}.bind(this));},_getRemoteFolder:function _getRemoteFolder(e,n,i){require("fs"),require("path");var t="config/tenants/"+e+"/remotes/"+n;this._configmanager.trace(t,function(e,n){if(e)i&&i(e);else{var t=n.getFolderPath();t?i&&i(null,t):i&&i(new Error("remote folder path invalid"));}}.bind(this));},_getSkin:function _getSkin(e,n){for(var i=0;i<e.length;i++){if(e[i].id==n)return e[i];}return null;},_getSkinWidgets:function _getSkinWidgets(e,n,i){var t=this._getSkin(e,n);if(t){var r=t;if(t.base)for(var s=0;s<e.length;s++){if(e[s].id==t.base){r=e[s];break;}}r.loadWidgets(function(e,n){e?i&&i(e):t.base?t.loadWidgets(function(e,t){if(e)i&&i(e);else{for(var r=[],s=0;s<t.length;s++){for(var a=!1,o=0;o<n.length;o++){if(t[s].hasSameRef(n[o])){a=!0,n[o].merge(t[s]);break;}}a||r.push(t[s]);}n=n.concat(r),i&&i(null,n);}}):i&&i(null,n);});}else i&&i(new Error("no skin has id "+n));},_getInRemoteResourceFolder:function _getInRemoteResourceFolder(e){return require("path").join(e,this.RESOURCE_FOLDER);},_getInRemoteSkinsFolder:function _getInRemoteSkinsFolder(e){return require("path").join(this._getInRemoteResourceFolder(e),this.SKIN_FLODER);},_getInRemoteCustomWidgetFolder:function _getInRemoteCustomWidgetFolder(e){return require("path").join(this._getInRemoteResourceFolder(e),this.CUSTOM_IN_REMOTE_WIDGET_FOLDER);},_getLocalSkinResourcePath:function _getLocalSkinResourcePath(e,n){var i=require("path"),t=require("fs"),r=this._getSkin(this.skins,e);if(!r||!r.path)return null;var s=i.join(r.path,n);return t.existsSync(s)?s:r.base?this._getLocalSkinResourcePath(r.base,n):null;},_getLocalSkinWidgetPath:function _getLocalSkinWidgetPath(e,n,i){var t=require("path"),r=require("fs"),s=this._getSkin(this.skins,e);if(!s||!s.path)return null;var a=t.join(s.path,n,i);return r.existsSync(a)?a:s.base?this._getLocalSkinResourcePath(s.base,n,i):null;},saveRemote2:function saveRemote2(e,n,i){var t=require("fs-extra"),r=require("path"),s=require("async"),a=e.getFolderPath();if(a){var o=e.index,u=e.parent.parent.index,c=n&&n.skin&&n.skin.id?n.skin.id:null,l=!(!e||!e.skin||!e.skin.id),g=n&&n.skin&&n.skin.inRemote,h=new Date().getTime(),f=this._getInRemoteSkinsFolder(a),d=this._getInRemoteCustomWidgetFolder(a),k=a+r.sep+this.RESOURCE_FOLDER,p=a+r.sep+this.RESOURCE_FOLDER+"_"+h,S=a+r.sep+this.RESOURCE_FOLDER+"_"+h+r.sep+this.SKIN_FLODER,y=f+r.sep+n.skin.id,decorateName=function decorateName(e,n){e=e.toString();var i=n.split(".");return 2==i.length?i.splice(1,0,e):i.length>=3&&(i[i.length-2].match(/^\d+$/)?parseInt(i[i.length-2])<parseInt(e)&&(i[i.length-2]=e):i.splice([i.length-2],0,e)),i.join(".");},_copyResource=function _copyResource(e,n,i){var t=require("fs-extra"),r=require("path"),s=require("crypto"),_size=function _size(e){return t.statSync(e).size;},_md5=function _md5(e){var n=t.readFileSync(e),i=s.createHash("md5");return i.update(n),i.digest("hex");},a=0;n=decorateName(a,n);for(var o,u=e+r.sep+n;o=u,t.existsSync(o);){if(_size(u)==_size(i)&&_md5(u)==_md5(u))return n;a++,n=decorateName(a,n),u=e+r.sep+n;}return t.copySync(i,u,{clobber:!0}),n;};s.waterfall([function(e){g?e():t.remove(f,function(n){e(n);});},function(e){this.getRemoteWidgets(u,o,l?c:null,g,function(n,i){n?e(n):t.exists(k,function(n){n?t.move(k,p,function(n){e(n,i);}):e(null,i);});}.bind(this));}.bind(this),function(n,s){var a={resourceBuf:[],widgetBuf:[],processResourceSync:function processResourceSync(e){for(var i=0;i<this.resourceBuf.length;i++){if(this.resourceBuf[i]&&this.resourceBuf[i].ref==e)return this.resourceBuf[i].newRef;}try{var s=function(e,n){for(var i,s,a,o,u,l,g,p,y,v=n.length,w=function(e){var n=e.split("/");if(n.length>2&&"custom"==n[0]){if(n[1].match(/^.+__\d+$/))return!0;var i=n[n.length-1].split(".");if(i.length>=3&&i[i.length-2].match(/^\d+$/))return!0;}return!1;}(e),_=function(e){var n=e.split("/");if("custom"!=n[0])return!1;if(n.length>2&&"custom"==n[0]){if(n[1].match(/^.+__\d+$/))return!1;var i=n[n.length-1].split(".");if(i.length>=3&&i[i.length-2].match(/^\d+$/))return!1;}return!0;}(e);v--;){switch(a=n[v].getLocation()){case"local_custom":if(_)for(o=n[v].resources.length;o--;){if(n[v].resources[o].getRef()==e)return l=k+r.sep+"custom"+r.sep+n[v].type+r.sep+n[v].name,(y=_copyResource(l,n[v].resources[o].name,n[v].resources[o].file))?"custom/"+n[v].type+"/"+n[v].name+"/"+y:null;}break;case"in_remote_custom":if(_){for(o=n[v].resources.length;o--;){if(n[v].resources[o].getRef()==e){i=n[v],s=n[v].resources[o];break;}}}else if(w)for(o=n[v].resources.length;o--;){if(n[v].resources[o].getRef()==e){p=n[v].skin.path,"\\"==r.sep&&(p=p.replace(/\\/g,"/")),(g=p.split("/")).length>2&&(g[g.length-2]=g[g.length-2]+"_"+h),u=(p=g.join(r.sep))+r.sep+n[v].type+r.sep+n[v].name+r.sep+n[v].resources[o].name;var E=n[v].type,R=E.indexOf("__");return R>0&&(E=E.substr(0,R)),l=d+r.sep+E+r.sep+n[v].name,(y=_copyResource(l,n[v].resources[o].name,u))?"custom/"+E+"/"+n[v].name+"/"+y:null;}}break;default:if(0==e.indexOf(n[v].type+"/"+n[v].name))for(o=n[v].resources.length;o--;){if(n[v].resources[o].getRef()==e)return"in_remote_skin"==a?(u=(p=S)+r.sep+n[v].type+r.sep+n[v].name+r.sep+n[v].resources[o].name,l=f+r.sep+c+r.sep+n[v].type+r.sep+n[v].name+r.sep+n[v].resources[o].name,void t.copySync(u,l,{clobber:!0})):void n[v].resources[o].copySync(f,c);}}}if(i&&s)return p=i.skin.path,"\\"==r.sep&&(p=p.replace(/\\/g,"/")),(g=p.split("/")).length>2&&(g[g.length-2]=g[g.length-2]+"_"+h),u=(p=g.join(r.sep))+r.sep+i.type+r.sep+i.name+r.sep+s.name,l=d+r.sep+i.type+r.sep+i.name,(y=_copyResource(l,s.name,u))?"custom/"+i.type+"/"+i.name+"/"+y:null;}(e,n);return this.resourceBuf.push({ref:e,newRef:s}),s;}catch(e){return null;}},processWidgetSync:function processWidgetSync(e){for(var t=0;t<this.widgetBuf.length;t++){var s=this.widgetBuf[t];if(s&&s.widgetType==e.widgetType&&s.widgetName==e.widgetName)return void((s.widgetSkin||e.widgetSkin)&&(s.widgetSkin,e.widgetSkin));}try{!function(e,n){for(var t,s=0;s<n.length;s++){if(e.widgetType==n[s].type&&e.widgetName==n[s].name){t=n[s];break;}}if(t)switch(t.getLocation()){case"in_remote_skin":case"in_remote_custom":var a=t.skin.path;"\\"==r.sep&&(a=a.replace(/\\/g,"/"));var o=a.split("/");o.length>3&&(o[o.length-3]=o[o.length-3]+"_"+h),a=o.join(r.sep),t._copySync(a,f,c);break;default:t.copySync(f,c,i);}}(e,n),this.widgetBuf.push(e);}catch(e){}}};e.processResourceList(a,function(e){s(e);});},function(e){t.remove(p,e);},function(e){t.ensureDir(y,function(i){i?e(i):t.writeFile(y+r.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify({name:"in-remote"}),function(i){i||(n.skin.inRemote=!0),e(i);});});}],function(e){i&&i(e,n);});}else i&&i(new Error("remote folder path invalid"));},saveRemote:function saveRemote(e,n,i){var t=require("fs-extra"),r=require("path"),s=require("async"),a=require("m.aio.skinmanager.js"),o=e.getFolderPath();if(o){var u=n&&n.skin&&n.skin.id?n.skin.id:null,c=n&&n.skin&&n.skin.inRemote,l=this._getInRemoteResourceFolder(o),g=this._getInRemoteSkinsFolder(o),h=this.customWidgetPath.replace(this.CUSTOM_IN_REMOTE_WIDGET_FOLDER,""),f=g+r.sep+n.skin.id,_isCustomRef=function _isCustomRef(e){return"custom"==e.split("/")[0];},_isInRemoteCustomWidgetRef=function _isInRemoteCustomWidgetRef(e){if(!_isCustomRef(e))return!1;var n=e.split("/");if(n.length>2){if(n[1].match(/^.+__\d+$/))return!0;var i=n[n.length-1].split(".");if(i.length>=3&&i[i.length-2].match(/^\d+$/))return!0;}return!1;},_isLocalCustomWidgetRef=function _isLocalCustomWidgetRef(e){return!!_isCustomRef(e)&&!_isInRemoteCustomWidgetRef(e);},_isSkinRef=function _isSkinRef(e){return!_isCustomRef(e);},_isInRemoteSkinRef=function _isInRemoteSkinRef(e){return!!_isSkinRef(e)&&c;},_isLocalSkinRef=function _isLocalSkinRef(e){return!!_isSkinRef(e)&&!_isInRemoteSkinRef(e);},_isInRemoteSkinWidget=function _isInRemoteSkinWidget(){return c;},_getResSrc=function _getResSrc(e,n){return _isInRemoteCustomWidgetRef(e)?r.join(l,e):_isLocalCustomWidgetRef(e)?r.join(h,e):_isLocalSkinRef(e)?a._getLocalSkinResourcePath(n||u,e):r.join(g,e);},_getResDst=function _getResDst(e,n){return _isInRemoteCustomWidgetRef(e)||_isLocalCustomWidgetRef(e)?r.join(l,e):(_isLocalSkinRef(e),r.join(g,n||u,e));},_decorateRes=function _decorateRes(e,n){var i=n.split("/"),t=i[i.length-1].split(".");return t.splice(t.length-1,0,""+e),i[i.length-1]=t.join("."),i.join("/");},_copyResource=function _copyResource(e,n){var i,t=require("fs-extra"),r=require("crypto"),_size=function _size(e){return t.statSync(e).size;},_md5=function _md5(e){var n=t.readFileSync(e),i=r.createHash("md5");return i.update(n),i.digest("hex");};return i=n,t.existsSync(i)?_size(n)==_size(e)&&_md5(n)==_md5(e)?n:null:(t.copySync(e,n,{clobber:!0}),n);},d=[],k=[],p={},S={},_handleWidget=function _handleWidget(e){var n=e.widgetType+"/"+e.widgetName;if(e.widgetSkin&&(n=e.widgetSkin+"/"+n),!S[n]){var i=function(e){return _isInRemoteSkinWidget()?r.join(g,e.widgetSkin||u,e.widgetType,e.widgetName):a._getLocalSkinWidgetPath(e.widgetSkin||u,e.widgetType,e.widgetName);}(e),s=function(e){return r.join(g,e.widgetSkin||u,e.widgetType,e.widgetName);}(e);_isInRemoteSkinWidget()?(S[n]=!0,k.push(s)):(t.copySync(i,s,{clobber:!0}),S[n]=!0,k.push(s));}},_handleResource=function _handleResource(e,n,i){var r=n+":"+(i||e);if(p[r])return p[r];var s=_getResSrc(e,n),a=_getResDst(i||e,n);if(_isInRemoteCustomWidgetRef(e)||_isInRemoteSkinRef(e))return p[r]=i||e,d.push(a),e;if(_isLocalCustomWidgetRef(e)){var o=_decorateRes(0,i||e);a=_getResDst(o);for(var u=0;!_copyResource(s,a);){o=_decorateRes(++u,i||e),a=_getResDst(o);}return p[r]=o,d.push(a),o;}t.copySync(s,a,{clobber:!0}),p[r]=i||e,d.push(a);},_processFolder=function _processFolder(e){for(var n=t.readdirSync(e),i=0,s=0;s<n.length;s++){var a=r.join(e,n[s]);(t.statSync(a).isDirectory()?_processFolder(a):_processFile(a))&&i++;}return i==n.length&&(t.removeSync(e),!0);},_processFile=function _processFile(e){if(-1!=d.indexOf(e))return!1;var n=require("unorm").nfc(e);if(-1!=d.indexOf(n))return!1;for(var i=0;i<k.length;i++){var r=k[i];if(e.substr(0,r.length)==r)return!1;}return t.removeSync(e),!0;},y={};s.waterfall([function(e){c?e():t.remove(g,function(n){e(n);});},function(n){var i={resourceBuf:[],widgetBuf:[],processResourceSync:function processResourceSync(e,n){n&&(y[n]=1);try{var i=_handleResource(e,n);return this.resourceBuf.push({ref:e,newRef:i}),i;}catch(e){return null;}},processWidgetSync:function processWidgetSync(e){try{e&&"object"==_typeof(e)&&"string"==typeof e.widgetSkin&&(y[e.widgetSkin]=1),_handleWidget(e),this.widgetBuf.push(e);}catch(e){}},processDefaultImageSync:function processDefaultImageSync(e){try{var n=e._default,i=n.split("/");i.splice(i.length-1,1,"default.png");var t=i.join("/");return t=_handleResource(n,e.img_skin,t),this.resourceBuf.push({ref:n,newRef:t}),t;}catch(e){return console.error(e),null;}}};e.processResourceList(i,function(e){n(e);});},function(e){!function(e){try{for(var n=require("unorm"),i=0;i<d.length;i++){d[i]=n.nfc(d[i]);}t.existsSync(l)&&_processFolder(l),e(null);}catch(n){e(n);}}(e);},function(e){var i=[];for(var s in y){if(s!==n.skin.id){var a=m.aio.skinmanager.SkinManager.skins.find(function(e){return(1===e.type||2===e.type)&&e.id===s;});a&&i.push(a);}}var next=function next(n){if(n>=i.length)e();else{var s=i[n];t.ensureDir(g+r.sep+s.id+r.sep,function(e){if(e)next(n+1);else{var i={name:"in-remote",original:s.id,system:s.system||1,version:s.version};t.writeFile(g+r.sep+s.id+r.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify(i),function(e){next(n+1);});}});}};next(0);},function(e){t.ensureDir(f,function(i){if(i)e(i);else{var s={name:"in-remote",original:n.skin.id},a=m.aio.skinmanager.SkinManager.skins.find(function(e){return(1===e.type||2===e.type)&&e.id===n.skin.id;});a&&(s.system=a.system||1,s.version=a.version),t.writeFile(f+r.sep+m.aio.skinmanager.Skin.SETTINGS_FILE,JSON.stringify(s),function(i){i||(n.skin.inRemote=!0),e(i);});}});}],function(e){e&&(console.error(e),this._logger.log("error",e)),i&&i(e,n);}.bind(this));}else i&&i(new Error("remote folder path invalid"));},downloadSystemSkin:function downloadSystemSkin(e,n,i,t,r){var s="webservice.mediola.com",a=443,o="";switch(process.env.CLOUD){case"local":s=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost",a=8080,o="/webservice";break;case"dev":s=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com",a=80;break;default:s=process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",a=443;}i=Number(i),isNaN(i)&&(i=0);var u=this,c=this._logger,l=this._configmanager,g="config/tenants/"+e;c.log("debug","start to download system skin "+n),t&&t(0,"start"),l.trace(g,function(e,l){if(e)r&&r(e);else{var g=l.license;t&&t(1,"get skin info from server"),c.log("debug","try to get skin "+n+" info from server"),function(e,n,t){var r=t,u=443===a?require("https"):require("http"),c={host:s,port:a,path:o+"/creatorneo/skin/getSkinUrl?license="+e+"&skinName="+encodeURIComponent(n)+"&level_support="+i,method:"GET",timeout:2e4,headers:{"User-Agent":"mediola",Connection:"close"}},l="",g=u.request(c,function(e){e.setEncoding("utf8"),e.on("data",function(e){l+=e;}),e.on("end",function(){if(r)if(200==e.statusCode){var n;try{n=JSON.parse(l);}catch(e){r(new Error("request response invalid:"+l));}n&&n.url?r(null,n.url,n.version):r(new Error("request response invalid:"+l));}else r(new Error("request failed:"+l));r=null;});});g.on&&"function"==typeof g.on&&g.on("error",function(e){r&&r(e),r=null;}),g.setTimeout&&g.setTimeout(2e4),g.end();}(g.licenseTxt,n,function(e,i,s){e?r&&r(e):u._checkSystemSkinExists(n,s,function(e,a){if(!e)return a?(c.log("debug","find system skin "+n),void u._updateInfomanager(g,n,function(){r&&r();})):void u._downloadAndSaveSkin(g,i,n,s,t,function(e){e?r&&r(e):u._updateInfomanager(g,n,function(){r&&r();});});r&&r(e);});});}});},_checkSystemSkinExists:function _checkSystemSkinExists(e,n,i){for(var t=!1,r=0;r<this.skins.length;r++){if(this.skins[r]&&1==this.skins[r].type&&this.skins[r].id==e)if((this.skins[r].version?parseInt(this.skins[r].version):0)>=(n?parseInt(n):0)){t=!0;break;}}i&&i(null,t);},_downloadAndSaveSkin:function _downloadAndSaveSkin(e,n,i,t,r,s){var a=this,o=this._logger;switch(process.env.CLOUD){case"local":process.env.CLOUD_HOST?process.env.CLOUD_HOST:"localhost",8080,"/webservice";break;case"dev":process.env.CLOUD_HOST?process.env.CLOUD_HOST:"mediola-dev.elasticbeanstalk.com",80;break;default:process.env.CLOUD_HOST?process.env.CLOUD_HOST:"webservice.mediola.com",443;}r&&r(1,"get skin info from server"),o.log("debug","start download skin "+i+" zip from server"),r&&r(2,"download skin"),function(e,n,i){var t=i,r=require("url").parse(e),s=require("http");-1!=r.protocol.indexOf("https")&&(s=require("https")),r.method="GET",r.timeout=2e4;var a=require("m.aio.filemanager.js").getTmpDir(),u=require("path"),c=require("fs"),l=0,g=u.join(a,new Date().getTime()+".zip"),h=c.createWriteStream(g);h.on("error",function(e){t&&t(e),t=null;});var f=s.request(r,function(e){var i=e.headers["content-length"];o.log("trace","http skin zip length:"+i);var r=!1,s=!1;e.pipe(h),h.on("finish",function(){h.close(function(){s=!0,r&&s&&t&&(200!=e.statusCode?t(new Error("http response code:"+e.statusCode)):t(null,g),t=null);});}),e.on("data",function(e){l+=e.length,o.log("trace","receive chunk:"+e.length+" total:"+l+"/"+i),n&&n(parseFloat("2."+l),"download chunk "+l,{count:l,total:parseInt(i)});}),e.on("end",function(){(r=!0)&&s&&t&&(200!=e.statusCode?t(new Error("http response code:"+e.statusCode)):t(null,g),t=null);});});f.on&&"function"==typeof f.on&&f.on("error",function(e){t&&t(e),t=null;}),f.setTimeout&&f.setTimeout(2e4),f.end();}(n,r,function(e,n){e?s&&s(e):(r&&r(3,"unpack skin"),o.log("debug","start unpack skin from file:"+n),function(e,n,i){var t=require("m.aio.filemanager.js").getTmpDir(),r=require("path"),s=require("fs-extra"),o=r.join(t,n);try{s.existsSync(o)&&s.removeSync(o),s.ensureDirSync(o);}catch(e){return void(i&&i(e));}var u=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(u,function(n){if(a._logger.log("debug","Checked CPU for features: "+u.join(", ")+". Result: "+n),n){var t=new(require("adm-zip"))(e);try{t.extractAllTo(o,!0),i&&i(null,o);}catch(e){i&&i(e);}}else XC.unzip(e,o,a._logger,i);});}(n,i,function(e,n){e?s&&s(e):(o.log("debug","move skin from:"+n+" to:"+a.sysSkinsPath),function(e,n,i,t){var r=require("path"),s=require("fs-extra"),a=r.join(e,i);s.existsSync(a)&&s.removeSync(a),s.move(n,a,{limit:100},function(e){s.chmod(a,parseInt("777",8),function(e){t&&t(e,a);});});}(a.sysSkinsPath,n,i,function(e,n){e?s&&s(e):(r&&r(4,"load skin"),o.log("debug","load skin "+i+" from:"+n),m.aio.skinmanager.Skin.load(n,i,{skinType:1},function(e,n){if(e)s&&s(e);else{for(var i=-1,r=0;r<a.skins.length;r++){if(a.skins[r]&&a.skins[r].type==n.type&&a.skins[r].id==n.id){i=r;break;}}-1!=i&&a.skins.splice(i,1),a.skins.push(n),n.updateVersion(t,function(e){s&&s(e);});}}));}));}));});},_updateInfomanager:function _updateInfomanager(e,n,i){require("m.aio.infomanager").updateDownloadSkin(e,n,function(){i&&i();});}},"undefined"!=typeof module&&null!=module&&(module.exports=m.aio.skinmanager.SkinManager);