var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.onkyo=xnm.aio.onkyo||{},xnm.aio.onkyo.AVReceiverBuffer={getAVR:function getAVR(e,t){return e&&t?this[e+":"+t]:null;},setAVR:function setAVR(e){if(!e||!e.getIp())return null;this[e.getIp()+":"+e.getPort()]=e;}},xnm.aio.onkyo.AVReceiver=function(){var e=[1,2,3,4],StatusTask=function StatusTask(e,t,n,o){this._taskBuffer=e,this._avr=t,this._datapoints=n,this._callback=o;};StatusTask.prototype.run=function(){this._avr._logger.log("debug","run status task: "+JSON.stringify(this._datapoints));var e=this,t={},n=0,cb=function cb(o,r){if(!o||1!=o.errorCode&&2!=o.errorCode&&3!=o.errorCode){var u=e._datapoints[n],a=null,i=u.indexOf(":");i>0&&(a=u.substr(0,i),u=u.substr(i+1));var s="?";if("frontTone"==u?r&&(null!=r.mainzone.frontBass&&void 0!==r.mainzone.frontBass&&(t["mainzone:frontBass"]=r.mainzone.frontBass),null!=r.mainzone.frontTreble&&void 0!==r.mainzone.frontTreble&&(t["mainzone:frontTreble"]=r.mainzone.frontTreble)):(r&&(a||null==r[u]||void 0===r[u]?a&&r[a]&&null!=r[a][u]&&void 0!==r[a][u]&&(s=r[a][u]):s=r[u]),t[e._datapoints[n]]=s),(n+=1)<e._datapoints.length){var f=e._avr._getStateQuest(e._datapoints[n]);e._avr._doStateReq(f,cb);}else e._taskBuffer._finishLastTask(null,t);}else e._taskBuffer._finishAllTask(o);},o=this._avr._getStateQuest(this._datapoints[n]);o?this._avr._doStateReq(o,cb):cb(new Error("unknow status"));},StatusTask.prototype.merge=function(e){e&&e._datapoints&&(this._datapoints?this._datapoints=function(e){for(var t=0;t<e.length;++t){for(var n=t+1;n<e.length;++n){e[t]===e[n]&&e.splice(n,1);}}return e;}(this._datapoints.concat(e._datapoints)):this._datapoints=e._datapoints);};var CommandTask=function CommandTask(e,t,n,o){this._taskBuffer=e,this._avr=t,this._commandTxt=n,this._callback=o;};CommandTask.prototype.run=function(){this._avr._logger.log("debug","run command task: "+this._commandTxt);var e=this,t=this._commandTxt,n=null,o=t.indexOf(":");o>0&&(n=t.substr(0,o),t=t.substr(o+1));var r=null;"toggle"==t?(r=this._avr._getStateQuest(n+":power"),this._avr._doStateReq(r,function(t,o){if(t)1==t.errorCode||2==t.errorCode||3==t.errorCode?e._taskBuffer._finishAllTask(t):e._taskBuffer._finishLastTask(t);else{var u="on";o&&o[n]&&"on"==o[n].power&&(u="off"),r=e._avr._getCommandQuest(n+":"+u),e._avr._doCommandReq(r,function(t){!t||1!=t.errorCode&&2!=t.errorCode&&3!=t.errorCode?e._taskBuffer._finishLastTask(t):e._taskBuffer._finishAllTask(t);});}})):(r=this._avr._getCommandQuest(this._commandTxt),this._avr._doCommandReq(r,function(t){!t||1!=t.errorCode&&2!=t.errorCode&&3!=t.errorCode?e._taskBuffer._finishLastTask(t):e._taskBuffer._finishAllTask(t);}));};var TaskBuffer=function TaskBuffer(e){this._avr=e,this._buffer=[];};TaskBuffer.prototype.executeTask=function(e){if(0==this._buffer.length)this._buffer.push(e),this._doNextTask();else if(e instanceof CommandTask)this._buffer.length>1&&this._buffer[this._buffer.length-1]&&this._buffer[this._buffer.length-1]instanceof StatusTask?this._buffer.splice(this._buffer.length-1,0,e):this._buffer.push(e);else if(e instanceof StatusTask){var t=[];if(this._buffer.length>1){for(var n=1;n<this._buffer.length;n++){this._buffer[n]&&this._buffer[n]instanceof StatusTask&&(t.push(n),e.merge(this._buffer[n]));}for(var o=0;o<t.length;o++){this._buffer.splice(t[o],1);}}this._buffer.push(e);}else this._buffer.push(e);},TaskBuffer.prototype._doNextTask=function(){0!=this._buffer.length&&this._buffer[0].run();},TaskBuffer.prototype._finishLastTask=function(e,t){if(this._buffer.length>0){var n=this._buffer[0];n&&n._callback&&(n._callback(e,t),n._callback=null),this._buffer.splice(0,1);}this._doNextTask();},TaskBuffer.prototype._finishAllTask=function(e){var t=this._buffer;this._buffer=[];for(var n=0;n<t.length;n++){t[n]&&t[n]._callback&&(t[n]._callback(e),t[n]._callback=null);}};var PacketBuffer=function PacketBuffer(e){this._avr=e,this._buffer=[],this._bufferEmptyTo=null;};PacketBuffer.prototype.RESPONSE_TO=1e3,PacketBuffer.prototype.PACKET_IDLE_TO=6e4,PacketBuffer.prototype.sendPacket=function(e,t,n){if(e){var o={packet:e,ignoreRsp:t,callback:n},r=this._buffer.length;this._buffer.push(o),this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null),0==r&&this._sendNextPacket();}else n&&n(new Error("ISCP message is null"));},PacketBuffer.prototype._sendNextPacket=function(){if(0!=this._buffer.length){var t=this,n=this._buffer[0];this._avr._sendPacket(n.packet,function(o){if(o)return o.errorCode=e[0],void t._finishAllPacket(o);n.ignoreRsp?t._finishLastPacket():n.timeout=setTimeout(function(){t._avr._logger.log("warn","packet response timeout");var n=new Error("packet reponse timeout");n.errorCode=e[3],t._finishLastPacket(n);},t.RESPONSE_TO);});}},PacketBuffer.prototype._finishLastPacket=function(e,t){if(this._buffer.length>0&&(this._buffer[0]&&(this._buffer[0].timeout&&(clearTimeout(this._buffer[0].timeout),this._buffer[0].timeout=null),this._buffer[0].callback&&(this._buffer[0].callback(e,t),this._buffer[0].callback=null)),this._buffer.splice(0,1)),0==this._buffer.length){var n=this;this._bufferEmptyTo=setTimeout(function(){n._bufferEmptyTo=null,0==n._buffer.length&&n._avr._disconnect();},this.PACKET_IDLE_TO);}else this._sendNextPacket();},PacketBuffer.prototype._finishAllPacket=function(e){var t=this._buffer;this._buffer=[],this._bufferEmptyTo&&(clearTimeout(this._bufferEmptyTo),this._bufferEmptyTo=null);for(var n=0;n<t.length;n++){t[n]&&(t[n].timeout&&(clearTimeout(t[n].timeout),t[n].timeout=null),t[n].callback&&(t[n].callback(e),t[n].callback=null));}},PacketBuffer.prototype._onSocketData=function(e){if(e=(e=new Buffer(e)).toString("hex"),(e=new Buffer(e,"hex")).length>12){var t=e.slice(18,e[11]-2+18).toString().trim();t=t.replace(/[\x1a]/g,""),this._avr&&this._avr._datapointBuffer&&this._avr._datapointBuffer.updateDpt(t),this._buffer.length>0&&this._buffer[0]&&this._buffer[0].packet&&this._buffer[0].packet.substr(0,3)==t.substr(0,3)&&this._finishLastPacket(null,t);}},PacketBuffer.prototype._onSocketTimeout=function(){},PacketBuffer.prototype._onSocketError=function(t){t.errorCode=e[1],this._finishAllPacket(t);},PacketBuffer.prototype._onSocketClose=function(t){var n=new Error("socket closed");n.errorCode=e[2],this._finishAllPacket(n);};var DatapointBuffer=function DatapointBuffer(){this._buffer={};};DatapointBuffer.prototype.EXPIRE_TO=3e3,DatapointBuffer.prototype.updateDpt=function(e){if(e&&e.length>3){var t=e.substr(0,3);this._buffer[t]={status:e,timestamp:new Date().getTime()};}},DatapointBuffer.prototype.getDpt=function(e){if(e&&e.length>3){var t=e.substr(0,3);if(this._buffer[t]){if(!this._buffer[t].timestamp)return delete this._buffer[t],null;var n=new Date().getTime(),o=n-this._buffer[t].timestamp;return o>this.EXPIRE_TO||o<0?(this._buffer[t].timestamp=n,null):null==this._buffer[t].status||void 0===this._buffer[t].status?(delete this._buffer[t],null):this._buffer[t].status;}}return null;},DatapointBuffer.prototype.delDpt=function(e){if(e&&e.length>3){var t=e.substr(0,3);"AMT"!=t?delete this._buffer[t]:this._buffer[t].timestamp=new Date().getTime();}},DatapointBuffer.prototype.refreshDptTime=function(){var e=new Date().getTime();for(var t in this._buffer){this._buffer.hasOwnProperty(t)&&(this._buffer[t].timestamp=e);}};var AVReceiver=function AVReceiver(e,t,n,o,r){this._ip=e,this._port=t,this._port||(this._port=60128),this._uuid=n,this._logger=require("x.logger.js").getLogger("xnm.aio.onkyo.AVReceiver"),this._model=o,this._name=r,this._socket=null,this._taskBuffer=new TaskBuffer(this),this._packetBuffer=new PacketBuffer(this),this._datapointBuffer=new DatapointBuffer();};AVReceiver.prototype.getIp=function(){return this._ip;},AVReceiver.prototype.getPort=function(){return this._port;},AVReceiver.prototype.executeCommandCreator=function(e,t,n){if(t&&t.value){if("openNative"==t.value)return window&&window.XC&&window.XC.callHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()?window.XC.callHost("SYSTEM","startApp",{scheme:"onkyo-remote3://"}):"Android"==window.XCHost.getType()&&window.XC.callHost("SYSTEM","startApp",{scheme:"com.onkyo.jp.onkyoremote"})),void(n&&n());var o="";t.path&&t.path[0]&&"global"!=t.path[0]&&(o=t.path[0]+":");var r=o+t.value;if("setTo"==t.value||"tuner"==t.value||"frontBassTo"==t.value||"frontTrebleTo"==t.value){if(null==t.ext||void 0===t.ext)return void(n&&n(new Error("command setTo ext format invalid")));r+=t.ext;}else if("audioMode"==t.value){if(!t.ext)return void(n&&n(new Error("command audioMode ext format invalid")));r+=t.ext;}else if("setInput"==t.value){if(!t.ext)return void(n&&n(new Error("command setInput ext format invalid")));r=o+t.ext;}else if("customCMD"==t.value){if(!t.ext)return void(n&&n(new Error("command customCMD ext format invalid")));r=o+t.ext;}var u=this;this._executeCommand(r,function(e){if(e)n&&n(e);else if("on"!=t.value&&"off"!=t.value&&"toggle"!=t.value){if("mute"==t.value||"unmute"==t.value||"toggleMute"==t.value){if(t.path&&t.path[0]&&"mainzone"==t.path[0])return u._datapointBuffer&&u._datapointBuffer.refreshDptTime(),void setTimeout(function(){n&&n();},3e3);}else if("volumeUp"==t.value||"volumeDown"==t.value)return void setTimeout(function(){n&&n();},100);n&&n(e);}else setTimeout(function(){n&&n();},4e3);});}else n&&n(new Error("command json format invalid"));},AVReceiver.prototype.getStatesCreator=function(e,t,n){for(var _contains=function _contains(e,t){for(var n=0;n<t.length;n++){if(t[n]===e)return!0;}return!1;},o=[],r=[],u=0;u<t.length;u++){if(t[u]&&t[u].id&&t[u].status&&t[u].status.value){var a="";t[u].status.path&&t[u].status.path[0]&&"global"!=t[u].status.path[0]&&(a=t[u].status.path[0]+":");var i=t[u].status.value;o.push({id:t[u].id,datapoint:a+i}),"frontBass"!=i&&"frontTreble"!=i||(i="frontTone"),_contains(a+i,r)||r.push(a+i);}}this._getStates(r,function(e,t){if(e)n&&n(e);else{for(var r=[],u=0;u<o.length;u++){var a="?",i=o[u].id,s=o[u].datapoint;t&&null!=t[s]&&void 0!==t[s]&&(a=t[s]),r.push({id:i,status:a});}n&&n(null,r);}});},AVReceiver.prototype.executeCommand=function(e,t){this._executeCommand(e,t);},AVReceiver.prototype.getStates=function(e){var t=Object.keys(AVReceiver.STATUS_DPT_QUEST);this._getStates(t,function(t,n){e&&e(t,n);});},AVReceiver.prototype._executeCommand=function(e,t){this._logger.log("debug","execute command: "+e);var n=new CommandTask(this._taskBuffer,this,e,t);this._taskBuffer.executeTask(n);},AVReceiver.prototype._getStates=function(e,t){this._logger.log("debug","get states: "+JSON.stringify(e));var n=new StatusTask(this._taskBuffer,this,e,t);this._taskBuffer.executeTask(n);},AVReceiver.prototype._getCommandQuest=function(e){var t,n,o=e,r=null,u=e.indexOf(":");return u>0&&(r=e.substr(0,u),e=e.substr(u+1)),"on"==e?o="zone2"==r?"ZPW01":"zone3"==r?"PW301":"PWR01":"off"==e?o="zone2"==r?"ZPW00":"zone3"==r?"PW300":"PWR00":"mute"==e?o="zone2"==r?"ZMT01":"zone3"==r?"MT301":"AMT01":"unmute"==e?o="zone2"==r?"ZMT00":"zone3"==r?"MT300":"AMT00":"toggleMute"==e?o="zone2"==r?"ZMTTG":"zone3"==r?"MT3TG":"AMTTG":"volumeDown"==e?o="zone2"==r?"ZVLDOWN":"zone3"==r?"VL3DOWN":"MVLDOWN":"volumeUp"==e?o="zone2"==r?"ZVLUP":"zone3"==r?"VL3UP":"MVLUP":"BDDVD"==e||"BD/DVD"==e?o="zone2"==r?"SLZ10":"zone3"==r?"SL310":"SLI10":"STRMBOX"==e||"STRM BOX"==e?o="zone2"==r?"SLZ11":"zone3"==r?"SL311":"SLI11":"CBLSAT"==e||"CBL/SAT"==e?o="zone2"==r?"SLZ01":"zone3"==r?"SL301":"SLI01":"PC"==e?o="zone2"==r?"SLZ05":"zone3"==r?"SL305":"SLI05":"GAME"==e?o="zone2"==r?"SLZ02":"zone3"==r?"SL302":"SLI02":"AUX"==e?o="zone2"==r?"SLZ03":"zone2"==r?"SL303":"SLI03":"CD"==e?o="zone2"==r?"SLZ23":"zone3"==r?"SL323":"SLI23":"TV"==e?o="zone2"==r?"SLZ12":"zone3"==r?"SL312":"SLI12":"FM"==e?o="zone2"==r?"SLZ24":"zone3"==r?"SL324":"SLI24":"AM"==e?o="zone2"==r?"SLZ25":"zone3"==r?"SL325":"SLI25":"NET"==e?o="zone2"==r?"SLZ2B":"zone3"==r?"SL32B":"SLI2B":"BLUETOOTH"==e?o="zone2"==r?"SLZ2E":"zone3"==r?"SL32E":"SLI2E":"Optical"==e?o="zone2"==r?"SLZ44":"zone3"==r?"SL344":"SLI44":0==e.indexOf("audioMode")?"STEREO"!=(e=e.replace(/audioMode/g,""))&&"MOVIE"!=e&&"MUSIC"!=e&&"GAME"!=e||("STEREO"==e&&(e="00"),o="LMD"+e):"play"==e?o="NTCPLAY":"pause"==e?o="NTCPAUSE":"stop"==e?o="NTCSTOP":"previous"==e?o="NTCTRDN":"next"==e?o="NTCTRUP":"frontBassUp"==e?o="TFRBUP":"frontBassDown"==e?o="TFRBDOWN":"frontTrebleUp"==e?o="TFRTUP":"frontTrebleDown"==e?o="TFRTDOWN":0==e.indexOf("frontBassTo")?(0==e.indexOf("frontBassTo")&&(e=e.replace(/frontBassTo/g,"")),e=e.replace(/%/g,""),t=!1,(n=parseInt(e))<0&&(t=!0,n=0-n),n<0&&(n=0),n>10&&(n=10),n=n.toString(16).toUpperCase(),o="TFRB"+(n=t?"-"+n:"+"+n)):0==e.indexOf("frontTrebleTo")?(0==e.indexOf("frontTrebleTo")&&(e=e.replace(/frontTrebleTo/g,"")),e=e.replace(/%/g,""),t=!1,(n=parseInt(e))<0&&(t=!0,n=0-n),n<0&&(n=0),n>10&&(n=10),n=n.toString(16).toUpperCase(),o="TFRT"+(n=t?"-"+n:"+"+n)):0==e.indexOf("tuner")?"Up"==(e=e.replace(/tuner/g,""))?o="zone2"==r?"PRZUP":"zone3"==r?"PR3UP":"PRSUP":"Down"==e?o="zone2"==r?"PRZDOWN":"zone3"==r?"PR3DOWN":"PRSDOWN":((n=parseInt(e))<0?n=0:n>40&&(n=40),o="zone2"==r?"PRZ"+XC.getHexVal(n,2):"zone3"==r?"PR3"+XC.getHexVal(n,2):"PRS"+XC.getHexVal(n,2)):(0==e.indexOf("setTo")||/^\d+$/.test(e))&&(0==e.indexOf("setTo")&&(e=e.replace(/setTo/g,"")),e=e.replace(/%/g,""),"zone2"==r?((n=parseInt(e))<0?n=0:n>100&&(n=100),o="ZVL"+XC.getHexVal(n,2)):"zone3"==r?((n=parseInt(e))<0?n=0:n>100&&(n=100),o="VL3"+XC.getHexVal(n,2)):((n=parseInt(e))<0?n=0:n>100&&(n=100),o="MVL"+XC.getHexVal(n,2))),o;},AVReceiver.STATUS_DPT_QUEST={"mainzone:power":"PWRQSTN","mainzone:volume":"MVLQSTN","mainzone:mute":"AMTQSTN","mainzone:audioMode":"LMDQSTN","mainzone:input":"SLIQSTN","mainzone:frontTone":"TFRQSTN","zone2:power":"ZPWQSTN","zone2:volume":"ZVLQSTN","zone2:mute":"ZMTQSTN","zone2:input":"SLZQSTN","zone3:power":"PW3QSTN","zone3:volume":"VL3QSTN","zone3:mute":"MT3QSTN","zone3:input":"SL3QSTN"},AVReceiver.LMD_MAP={"00":"Stereo","01":"Direct","02":"SURROUND","03":"Game-RPG","04":"THX","05":"Game-Action","06":"Game-Rock","07":"MONO MOVIE","08":"Orchestra","09":"Unplugged","0A":"Studio-Mix","0B":"TV Logic","0C":"All Ch Stereo","0D":"Theater-Dimensional","0E":"Game-Sports","0F":"Mono",11:"Pure Audio",12:"MULTIPLEX",13:"Full Mono",14:"DOLBY VIRTUAL",15:"DTS Surround Sensation",16:"Audyssey DSX","1F":"Whole House Mode",23:"Stage",25:"Action",26:"Music","2E":"Sports",40:"Straight Decode*1",41:"Dolby EX*2",42:"THX Cinema",43:"THX Surround EX",44:"THX Music",45:"THX Games",50:"THX U2/S2/I/S Cinema/Cinema2",51:"THX U2/S2/I/S Music",52:"THX U2/S2/I/S Games",80:"Dolby Surround",81:"PLII/PLIIx Music",82:"DTS Neo:6 Cinema",83:"DTS Neo:6 Music",84:"PLII/PLIIx THX Cinema",85:"Neo:6/Neo:X THX Cinema",86:"PLII/PLIIx Game",87:"Neural Surr*3",88:"Neural THX/Neural Surround",89:"PLII/PLIIx THX Games","8A":"Neo:6/Neo:X THX Games","8B":"PLII/PLIIx THX Music","8C":"Neo:6/Neo:X THX Music","8D":"Neural THX Cinema","8E":"Neural THX Music","8F":"Neural THX Games",90:"PLIIz Height",91:"Neo:6 Cinema DTS Surround Sensation",92:"Neo:6 Music DTS Surround Sensation",93:"Neural Digital Music",94:"PLIIz Height + THX Cinema",95:"PLIIz Height + THX Music",96:"PLIIz Height + THX Games",97:"PLIIz Height + THX U2/S2 Cinema",98:"PLIIz Height + THX U2/S2 Music",99:"PLIIz Height + THX U2/S2 Games","9A":"Neo:X Game",A0:"PLIIx/PLII Movie + Audyssey DSX",A1:"PLIIx/PLII Music + Audyssey DSX",A2:"PLIIx/PLII Game + Audyssey DSX",A3:"Neo:6 Cinema + Audyssey DSX",A4:"Neo:6 Music + Audyssey DSX",A5:"Neural Surround + Audyssey DSX",A6:"Neural Digital Music + Audyssey DSX",A7:"Dolby EX + Audyssey DSX"},AVReceiver.prototype._getStateQuest=function(e){return e?AVReceiver.STATUS_DPT_QUEST[e]:null;},AVReceiver.prototype._buildData=function(e){var t=[73,83,67,80,0,0,0,16,0,0,0,8,1,0,0,0,33,49],n=2+e.length+1&4294967295;t[8]=n>>24&255,t[9]=n>>16&255,t[9]=n>>8&255,t[11]=255&n;for(var o=0;o<e.length;o++){t.push(e.charCodeAt(o));}return t.push(13),new Buffer(t);},AVReceiver.prototype._resolveStatus=function(e){var t,n=e,o={mainzone:{},zone2:{},zone3:{}};if(0==n.indexOf("MVL"))n.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(o.mainzone.volume=parseInt(n.substr(3),16));else if(0==n.indexOf("PWR"))"00"==n.substr(3)?o.mainzone.power="off":"01"==n.substr(3)&&(o.mainzone.power="on");else if(0==n.indexOf("AMT"))"00"==n.substr(3)?o.mainzone.mute="off":"01"==n.substr(3)&&(o.mainzone.mute="on");else if(0==n.indexOf("LMD"))t=n.substr(3).trim(),AVReceiver.LMD_MAP[t]&&(o.mainzone.audioMode=AVReceiver.LMD_MAP[t]);else if(0==n.indexOf("TFR")){if(6==(t=n.substr(3)).length){var r=parseInt(t.substr(2,1),16),u="-"==t.charAt(1);u&&(r=0-r);var a=parseInt(t.substr(5,1),16);(u="-"==t.charAt(4))&&(a=0-a),o.mainzone.frontBass=r,o.mainzone.frontTreble=a;}}else if(0==n.indexOf("ZVL"))n.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(o.zone2.volume=parseInt(n.substr(3),16));else if(0==n.indexOf("ZPW"))"00"==n.substr(3)?o.zone2.power="off":"01"==n.substr(3)&&(o.zone2.power="on");else if(0==n.indexOf("ZMT"))"00"==n.substr(3)?o.zone2.mute="off":"01"==n.substr(3)&&(o.zone2.mute="on");else if(0==n.indexOf("VL3"))n.substr(3).match(/[0-9A-Fa-f]{2}/g)&&(o.zone3.volume=parseInt(n.substr(3),16));else if(0==n.indexOf("PW3"))"00"==n.substr(3)?o.zone3.power="off":"01"==n.substr(3)&&(o.zone3.power="on");else if(0==n.indexOf("MT3"))"00"==n.substr(3)?o.zone3.mute="off":"01"==n.substr(3)&&(o.zone3.mute="on");else if(0==n.indexOf("SLI")||0==n.indexOf("SLZ")||0==n.indexOf("SL3")){var i=o.mainzone;0==n.indexOf("SLZ")?i=o.zone2:0==n.indexOf("SL3")&&(i=o.zone3),"10"==n.substr(3)?i.input="BD/DVD":"11"==n.substr(3)?i.input="STRM BOX":"01"==n.substr(3)?i.input="CBL/SAT":"05"==n.substr(3)?i.input="PC":"02"==n.substr(3)?i.input="GAME":"03"==n.substr(3)?i.input="AUX":"23"==n.substr(3)?i.input="CD":"12"==n.substr(3)?i.input="TV":"24"==n.substr(3)?i.input="FM":"25"==n.substr(3)?i.input="AM":"2B"==n.substr(3)?i.input="NET":"2E"==n.substr(3)?i.input="BLUETOOTH":"44"==n.substr(3)&&(i.input="Optical");}return o;},AVReceiver.prototype._doCommandReq=function(e,t){this._datapointBuffer&&this._datapointBuffer.delDpt(e),this._packetBuffer.sendPacket(e,!0,t);},AVReceiver.prototype._doStateReq=function(e,t){var n=this;if(this._datapointBuffer){var o=this._datapointBuffer.getDpt(e);if(o){var r=this._resolveStatus(o);return void t(null,r);}}this._packetBuffer.sendPacket(e,!1,function(e,o){if(e)t(e);else{var r=n._resolveStatus(o);t(null,r);}});},AVReceiver.prototype._sendPacket=function(e,t){if(this._socket){this._logger.log("trace","send ISCP message:"+e);var n=this._buildData(e);this._socket.write(n,"binary"),t();}else{var o=this;this._connect(function(n){n?t(n):o._sendPacket(e,t);});}},AVReceiver.prototype._connect=function(e){this._socket&&(this._socket.end(),this._socket=null);var t=this,n={port:this._port,host:this._ip},o=require("net").connect(n);return o.setTimeout(2e3),o.__connected=!1,o.on("connect",function(){t._logger.log("trace","connect to onkyo avr:"+t._ip),o.__connected=!0,t._socket=o,e();}),o.on("data",function(e){t._logger.log("trace","receive from onkyo avr "+(o.__disconnected?"(closed)":"")+":"+t._ip+" data:"+e),o.__disconnected||t._packetBuffer._onSocketData(e);}),o.on("error",function(n){o.__connected?(t._logger.log("trace","onkyo avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" error:"+n.message),o.destroy(),o.__disconnected||(o.__disconnected=!0,t._socket=null,t._packetBuffer._onSocketError(n))):(t._logger.log("trace","onkyo avr:"+t._ip+" connection error:"+n.message),e(n));}),o.on("timeout",function(){o.__connected?(t._logger.log("trace","onkyo avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" data timeout"),o.__disconnected||t._packetBuffer._onSocketTimeout()):(t._logger.log("trace","onkyo avr:"+t._ip+" connection timeout"),o.destroy&&o.destroy(),e(new Error("timeout")));}),o.on("close",function(){t._logger.log("trace","onkyo avr"+(o.__disconnected?"(closed)":"")+":"+t._ip+" close socket"),o.__disconnected||(o.__disconnected=!0,t._socket=null,t._packetBuffer._onSocketClose(o));}),o._doConnect&&"function"==typeof o._doConnect&&o._doConnect(),o;},AVReceiver.prototype._disconnect=function(){this._logger.log("debug","disconnect socket"),this._socket&&(this._socket.__disconnected=!0,this._socket.end(),this._socket=null);},AVReceiver.prototype.toJSON=function(){var e={sys:xnm.aio.onkyo.DM.SYS,type:"avr",ip:this._ip,port:this._port,uuid:this._uuid,model:this._model};return this._name&&(e.name=this._name),e;},AVReceiver.prototype.equalsTo=function(e){return!!e&&e instanceof AVReceiver&&this._ip==e._ip&&this._port==e._port;},AVReceiver.parseJSON=function(e){return e.ip?new AVReceiver(e.ip,e.port,e.uuid,e.model,e.name):null;};var AVReceiverWrapper=function AVReceiverWrapper(e,t,n,o,r){this._avr=xnm.aio.onkyo.AVReceiverBuffer.getAVR(e,t),this._avr||(this._avr=new AVReceiver(e,t,n,o,r),xnm.aio.onkyo.AVReceiverBuffer.setAVR(this._avr));};return AVReceiverWrapper.prototype.getUUID=function(){return this._avr?this._avr._uuid:null;},AVReceiverWrapper.prototype.executeCommandCreator=function(e,t,n){this._avr.executeCommandCreator(e,t,n);},AVReceiverWrapper.prototype.getStatesCreator=function(e,t,n){this._avr.getStatesCreator(e,t,n);},AVReceiverWrapper.prototype.executeCommand=function(e,t){this._avr.executeCommand(e,t);},AVReceiverWrapper.prototype.getStates=function(e){this._avr.getStates(e);},AVReceiverWrapper.prototype.toJSON=function(){return this._avr.toJSON();},AVReceiverWrapper.prototype.equalsTo=function(e){return this._avr.equalsTo(e._avr);},AVReceiverWrapper.parseJSON=function(e){return e.ip?new AVReceiverWrapper(e.ip,e.port,e.uuid,e.model,e.name):null;},AVReceiverWrapper;}(),xnm.aio.onkyo.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};(DMError.prototype=new Error()).name="OnkyoDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6};var e={avr:{command:[{type:"root",name:"global",value:"global",children:[{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}},{type:"enum",name:"open Onkyo Remote App",ref:{value:"openNative",value_t:"open_app_onkyo"}}]},{type:"root",name:"NET",value:"net",children:[{type:"enum",name:"play",ref:{path:["global"],value:"play"}},{type:"enum",name:"pause",ref:{value:"pause"}},{type:"enum",name:"stop",ref:{value:"stop"}},{type:"enum",name:"previous",ref:{value:"previous"}},{type:"enum",name:"next",ref:{value:"next"}}]},{type:"root",name:"main zone",value:"mainzone",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"set listening mode",ref:{value:"audioMode",ext:"%e",extMeta:["MOVIE","MUSIC","GAME","STEREO"]}},{type:"enum",name:"front bass up",ref:{value:"frontBassUp",value_t:"bassUp"}},{type:"enum",name:"front bass down",ref:{value:"frontBassDown",value_t:"bassDown"}},{type:"int",name:"front bass to",ref:{value:"frontBassTo",value_t:"bassTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"front treble up",ref:{value:"frontTrebleUp",value_t:"trebleUp"}},{type:"enum",name:"front treble down",ref:{value:"frontTrebleDown",value_t:"trebleDown"}},{type:"int",name:"front treble to",ref:{value:"frontTrebleTo",value_t:"trebleTo",ext:"%d",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","BD/DVD","STRM BOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","BD/DVD","STRM BOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"enum",name:"power on",ref:{value:"on"}},{type:"enum",name:"power off",ref:{value:"off"}},{type:"enum",name:"toggle power",ref:{value:"toggle"}},{type:"enum",name:"volume up",ref:{value:"volumeUp"}},{type:"enum",name:"volume down",ref:{value:"volumeDown"}},{type:"int",name:"set volume to",ref:{value:"setTo",value_t:"volumeTo",ext:"%d",extMeta:"0-80",scale:"1"}},{type:"enum",name:"mute",ref:{value:"mute"}},{type:"enum",name:"unmute",ref:{value:"unmute"}},{type:"enum",name:"toggle mute",ref:{value:"toggleMute"}},{type:"enum",name:"tuner preset up",ref:{value:"tunerUp"}},{type:"enum",name:"tuner preset down",ref:{value:"tunerDown"}},{type:"int",name:"set tuner preset",ref:{value:"tuner",ext:"%d",extMeta:"1-40",scale:"1"}},{type:"enum",name:"set input",ref:{value:"setInput",ext:"%e",extMeta:["CBL/SAT","BD/DVD","STRM BOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]}],status:[{type:"root",name:"main zone",value:"mainzone",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"int",name:"front bass",ref:{value:"frontBass",value_t:"bass",extMeta:"-10-10",scale:"2"}},{type:"int",name:"front treble",ref:{value:"frontTreble",value_t:"treble",extMeta:"-10-10",scale:"2"}},{type:"enum",name:"listening mode",ref:{value:"audioMode",options:["Stereo","All Ch Stereo"]}},{type:"enum",name:"input",ref:{value:"input",options:["CBLSAT","BDDVD","STRMBOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]},{type:"root",name:"zone 2",value:"zone2",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["CBLSAT","BDDVD","STRMBOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]},{type:"root",name:"zone 3",value:"zone3",children:[{type:"int",name:"volume",ref:{value:"volume",extMeta:"0-80",scale:"1"}},{type:"enum",name:"power",ref:{value:"power",options:["on","off"]}},{type:"enum",name:"mute",ref:{value:"mute",options:["on","off"]}},{type:"enum",name:"input",ref:{value:"input",options:["CBLSAT","BDDVD","STRMBOX","GAME","AUX","PC","CD","TV","NET","BLUETOOTH","FM","AM","Optical"]}}]}]}};return{SYS:"onkyo",getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"Onkyo AV Receiver",type:"avr"}];},createDevice:function createDevice(e,t,n){var o=DMError,r=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(r.INVALID,"ip is invalid")):n(new o(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,n){var o=DMError,r=DMError.ERROR_CODE;e?e.ip?n(null,e):n(new o(r.INVALID,"ip is invalid")):n(new o(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,n){n();},applyUIFilter:function applyUIFilter(e,t,n){var _doFilterArr=function _doFilterArr(e,t,n){var o=[];return e.forEach(function(e){if("root"==e.type){var r=JSON.parse(JSON.stringify(e)),u=_doFilterArr(r.children,t,n);u&&u.length>0&&(r.children=u,o.push(r));}else if(function(e,t){if("*"==e)return!0;for(var n=!1,o=0;o<e.length;o++){if(e[o]==t){n=!0;break;}}return n;}(n.elems,e.type)){var a=JSON.parse(JSON.stringify(e));o.push(a);}}),o;},_filter=function _filter(e,t){var o=[],r=null,u=xnm.aio.onkyo.DM.getCommandStatusMap(e,n);return u&&(r=function(e,t,n){var o=[];switch(n.catagory){case"command":e.command&&(o=_doFilterArr(e.command,t,n));break;case"status":e.status&&(o=_doFilterArr(e.status,t,n));}return o;}(u,e,t),o=o.concat(r)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),o.command=r;break;case"status":r=_filter(e,t),o.status=r;break;default:return null;}return r&&0!=r.length?o:null;},getCommandStatusMap:function getCommandStatusMap(t){return t&&t.type?e[t.type]:null;}};}(),xnm.aio.onkyo.Handler=function(){var Handler=function Handler(){this.detectedAVRs={};};return Handler.prototype.devicemanager=xnm.aio.onkyo.DM,Handler.prototype.AVReceiver=xnm.aio.onkyo.AVReceiver,Handler.prototype.registModule=function(e){e.register(xnm.aio.onkyo.DM.SYS,"onkyo");},Handler.prototype.resolveDevice=function(e){return e&&"avr"===e.type?xnm.aio.onkyo.AVReceiver.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var n=xnm.aio.onkyo.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),o=n?n.command:[];t&&t(null,o);},Handler.prototype.getDeviceStatus=function(e,t){var n=xnm.aio.onkyo.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),o=n?n.status:[];t&&t(null,o);},Handler.prototype.doCommand=function(e,t,n){var o=this.resolveDevice(e);o?o.executeCommandCreator(e,t,function(e){n&&n(e);}):n&&n(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,n,o){var r=this.resolveDevice(t);if(r){var u=[{id:e,device:t,status:n}];r.getStatesCreator(null,u,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("device json format invalid"));},Handler.prototype.getDeviceCommandList=function(e,t,n){var o=[];if(t)o.push({id:window.XC_Text.on,cmd:"on"}),o.push({id:window.XC_Text.off,cmd:"off"});else if(n&&"avr"==e.type){var r=[];r.push({id:"on",cmd:"on"}),r.push({id:"off",cmd:"off"}),r.push({id:"toggle",cmd:"toggle"}),r.push({id:"volumeDown",cmd:"volumeDown"}),r.push({id:"volumeUp",cmd:"volumeUp"}),r.push({id:"set volume",cmd:"setTo",step:"1",max:"80"}),r.push({id:"mute",cmd:"mute"}),r.push({id:"unmute",cmd:"unmute"}),r.push({id:"toggleMute",cmd:"toggleMute"}),r.push({id:"CBLSAT",cmd:"CBLSAT"}),r.push({id:"BDDVD",cmd:"BDDVD"}),r.push({id:"STRMBOX",cmd:"STRMBOX"}),r.push({id:"GAME",cmd:"GAME"}),r.push({id:"AUX",cmd:"AUX"}),r.push({id:"PC",cmd:"PC"}),r.push({id:"CD",cmd:"CD"}),r.push({id:"TV",cmd:"TV"}),r.push({id:"NET",cmd:"NET"}),r.push({id:"BLUETOOTH",cmd:"BLUETOOTH"}),r.push({id:"FM",cmd:"FM"}),r.push({id:"AM",cmd:"AM"}),r.push({id:"tunerUp",cmd:"tunerUp"}),r.push({id:"tunerDown",cmd:"tunerDown"}),r.push({id:"set tuner to",cmd:"tuner",step:"1",min:"1",max:"40"}),cl=r.length;for(var u=0;u<cl;u++){var a=JSON.parse(JSON.stringify(r[u]));a.ch="mainzone",o.push(a),(a=JSON.parse(JSON.stringify(r[u]))).ch="zone2",o.push(a);}o.push({id:"MOVIE",cmd:"MOVIE"}),o.push({id:"MUSIC",cmd:"MUSIC"}),o.push({id:"GAME",cmd:"GAME"}),o.push({id:"STEREO",cmd:"STEREO"}),o.push({id:"play",cmd:"play"}),o.push({id:"pause",cmd:"pause"}),o.push({id:"stop",cmd:"stop"}),o.push({id:"previous",cmd:"previous"}),o.push({id:"next",cmd:"next"});}return o;},Handler.prototype.discoverDevices=function(e){var t=require("x.upnp.js");if(t){var n=this;t.discoverDevicesWithTimeout(3e3,function(t){if(t.manufacturer&&0==t.manufacturer.indexOf("ONKYO")&&"AV Receiver"==t.modelDescription){var o=new xnm.aio.onkyo.AVReceiver(t.ip,null,t.uuid,t.modelName,t.name);n.detectedAVRs["uuid:"+t.uuid]||(n.detectedAVRs["uuid:"+t.uuid]=o),e(o);}});}},Handler.prototype.discoverWithTimeout=function(e,t){var n={};this.discoverDevices(function(e){e&&e.getUUID()&&!n[e.getUUID()]&&(n[e.getUUID()]=e);}),setTimeout(function(){var e=[];for(var o in n){n.hasOwnProperty(o)&&e.push(n[o]);}t&&t(null,e);},e);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.onkyo.Handler());