var m=m||{};m.aio=m.aio||{},m.aio.templatemanager=m.aio.templatemanager||{},m.aio.templatemanager.OPTIONS={host:"localhost",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}},m.aio.templatemanager.SysTemplateUploader=function(e,t,a){this.authHeader=e,this.skinName=t,this.templateName=a;},m.aio.templatemanager.SysTemplateUploader.prototype={upload:function upload(e,t){var a=this;require("m.aio.configmanager.js").trace(e,function(e,o){e?t&&t(e):a._processPage(o,t);});},_processPage:function _processPage(e,t){var a=e.getChild("pagecontent"),o=this._removeDevice(JSON.parse(JSON.stringify(a.content))),n="/creatorneo/template/uploadSysTemplate?";n+="skin="+encodeURI(this.skinName),n+="&name="+encodeURI(this.templateName);var i=this;this._doPostRequest(n,null,JSON.stringify(o),function(a,o){if(a)t&&t(a);else if(o){try{o=JSON.parse(o);}catch(e){return void(t&&t("upload system template response json invalid"));}if(o.id){var s=e.getFolderPath(),r=s.substr(0,s.length-2)+".png",l=require("fs");l.exists(r,function(e){e?l.readFile(r,function(e,a){e?t&&t():(n="/creatorneo/template/uploadSysTemplateThumb?",n+="id="+o.id,i._doPostRequest(n,{"Content-Type":"application/octet-stream"},a,function(e){t&&t(e);}));}):t&&t();});}else t&&t("upload system template response has not template id");}else t&&t("upload system template response invalid");});},_removeDevice:function _removeDevice(e){return delete e.action,e.labels&&e.labels.forEach(function(e){delete e.action,delete e.status;}),e.infos&&e.infos.forEach(function(e){delete e.action,delete e.status;}),e.buttons&&e.buttons.forEach(function(e){delete e.action,delete e.status;}),e.sliders&&e.sliders.forEach(function(e){delete e.action,delete e.status;}),e.colorchoosers&&e.colorchoosers.forEach(function(e){delete e.action,delete e.status;}),e.analogmeters&&e.analogmeters.forEach(function(e){delete e.action,delete e.status;}),e.cams&&e.cams.forEach(function(e){e.cam&&delete e.cam.device;}),e.webpages&&e.webpages.forEach(function(e){e.webpage&&delete e.webpage.device;}),e;},_doPostRequest:function _doPostRequest(e,t,a,o){var n=o,i=JSON.parse(JSON.stringify(m.aio.templatemanager.OPTIONS));(i.path+=e,i.method="POST",this.authHeader&&(i.auth=this.authHeader),t)&&Object.keys(t).forEach(function(e){i.headers[e]=t[e];});var s="",r=require("http").request(i,function(e){e.setEncoding("utf8"),e.on("data",function(e){s+=e;}),e.on("end",function(){200==e.statusCode?n&&n(null,s):n&&n(new Error("http error with status code:"+e.statusCode),s),n=null;});});r.on("error",function(e){n&&(n(e),n=null);}),r.write(a),r.end();}},m.aio.templatemanager.Handler=function(){this._configmanager=null;},m.aio.templatemanager.Handler.prototype={init:function init(e,t,a,o){this._configmanager=e,t&&(m.aio.templatemanager.OPTIONS.host=t,m.aio.templatemanager.OPTIONS.host=t,m.aio.templatemanager.OPTIONS.host=t),a&&a>0&&(m.aio.templatemanager.OPTIONS.port=a,m.aio.templatemanager.OPTIONS.port=a,m.aio.templatemanager.OPTIONS.port=a),process&&"local"==process.env.CLOUD&&(m.aio.templatemanager.OPTIONS.path="/webservice",m.aio.templatemanager.OPTIONS.path="/webservice",m.aio.templatemanager.OPTIONS.path="/webservice"),o&&o();},uploadSystemTemplate:function uploadSystemTemplate(e,t,a,o,n){e&&t&&a&&o?new m.aio.templatemanager.SysTemplateUploader(e,t,a).upload(o,n):n&&n(new Error("invalid parameter"));},submitUserTemplate:function submitUserTemplate(e,t,a){if(e&&e.tenantIdx&&e.remoteIdx&&e.remotePageIdxes)this._configmanager,e.tenantIdx;else a&&a(new Error("options invalid"));}},"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.templatemanager.Handler());