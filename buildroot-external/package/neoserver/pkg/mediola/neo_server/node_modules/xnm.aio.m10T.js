var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.m10T=xnm.aio.m10T||{},xnm.aio.m10T._CRC8Table=[0,94,188,226,97,63,221,131,194,156,126,32,163,253,31,65,157,195,33,127,252,162,64,30,95,1,227,189,62,96,130,220,35,125,159,193,66,28,254,160,225,191,93,3,128,222,60,98,190,224,2,92,223,129,99,61,124,34,192,158,29,67,161,255,70,24,250,164,39,121,155,197,132,218,56,102,229,187,89,7,219,133,103,57,186,228,6,88,25,71,165,251,120,38,196,154,101,59,217,135,4,90,184,230,167,249,27,69,198,152,122,36,248,166,68,26,153,199,37,123,58,100,134,216,91,5,231,185,140,210,48,110,237,179,81,15,78,16,242,172,47,113,147,205,17,79,173,243,112,46,204,146,211,141,111,49,178,236,14,80,175,241,19,77,206,144,114,44,109,51,209,143,12,82,176,238,50,108,142,208,83,13,239,177,240,174,76,18,145,207,45,115,202,148,118,40,171,245,23,73,8,86,180,234,105,55,213,139,87,9,235,181,54,104,138,212,149,203,41,119,244,170,72,22,233,183,85,11,136,214,52,106,43,117,151,201,74,20,246,168,116,42,200,150,21,75,169,247,182,232,10,84,215,137,107,53],xnm.aio.m10T.CRC8=function(e){for(var t=0,i=0;i<e.length;i++){t=xnm.aio.m10T._CRC8Table[t^e[i]];}return t;},xnm.aio.m10T.CRC32=function(e){for(var t=new Array(256),i=0;i<256;i++){for(var r=i<<24&4294967295,o=0;o<8;o++){0!=(r&1<<31)?(r<<=1,r^=79764919):r<<=1;}t[i]=4294967295&r;}for(var a=4294967295,n=0;n<e.length;n++){var s=(a=4294967295&(a^(255&e[n])<<24))>>24&255;a=4294967295&((a=a<<8&4294967295)^t[s]);}return XC.getHexVal(a>>>16,4)+XC.getHexVal(65535&a,4);},xnm.aio.m10T.IBus=function(e,t,i){this._type=e,this._host=t,this._port=i,this._socket=null,this._timeout=2e3,this._callback=null;},xnm.aio.m10T.IBus.prototype._openSocket=function(e){var t=e,i=require("net"),r={port:this._port,host:this._host};this._socket=i.connect(r),this._socket.setTimeout(this._timeout),this._socket.setEncoding("binary");var o=this;this._socket.on("connect",function(){var e=new Buffer(o._type);o._socket.write(e);}),this._socket.on("data",function(e){if(e=new Buffer(e,"binary"),null!=o._socket){var i=[];if(e.length>=2&&79==e[0]&&75==e[1]){if(t)o._socket.write(new Buffer(t)),t=null;else{if(e.length>3)for(var r=3;r<e.length;r++){i.push(e[r]);}o._callback&&o._callback({error:null,data:i});}}else o._callback&&o._callback({error:"socket data error",data:null});}}),this._socket.on("error",function(e){null!=o._socket&&(o._socket.destroy(),o._socket=null,o._callback&&o._callback({error:"socket error",data:null}));}),this._socket.on("timeout",function(){null!=o._socket&&(o._socket.destroy(),o._socket=null,o._callback&&o._callback({error:"socket timeout",data:null}));}),this._socket.on("close",function(){o._socket=null;}),this._socket._doConnect&&"function"==typeof this._socket._doConnect&&this._socket._doConnect();},xnm.aio.m10T.IBus.prototype.send=function(e,t,i){this._callback=i,e=t?[87,58].concat(t).concat(e):[87,58].concat(e),this._socket?this._socket.write(new Buffer(e)):this._openSocket(e);},xnm.aio.m10T.IBus.prototype.receive=function(e,t,i){if("SPI"==this._type){for(var r=[],o=0;o<e;o++){r.push(0);}this.send(r,null,function(e){i&&i(e);});}else this._callback=i,bytes=[82,58].concat([t,e]),this._socket?this._socket.write(new Buffer(bytes)):this._openSocket(bytes);},xnm.aio.m10T.IBus.prototype.end=function(){this._socket&&(this._socket.write(new Buffer("E:")),this._socket.destroy(),this._socket=null);},xnm.aio.m10T.STMSPIBootloader=function(e){this._spi=e,this._retryCnt=0;},xnm.aio.m10T.STMSPIBootloader.prototype.start=function(e){var t=this;this._spi.send([90,0,0,121],null,function(i){i.data&&4==i.data.length&&121==i.data[2]?e&&e(!0):t._retryCnt++<40?setTimeout(function(){t.start(e);},100):e&&e(!1);});},xnm.aio.m10T.STMSPIBootloader.prototype.sendGet=function(e){var t=this;this._spi.send([90,0,255,0,0,121],null,function(i){i.data&&6==i.data.length&&121==i.data[4]?t._spi.receive(14,null,function(t){e&&e(t.data);}):e&&e();});},xnm.aio.m10T.STMSPIBootloader.prototype.readFlash=function(e,t){var i=e>>0&255,r=e>>8&255,o=e>>16&255,a=e>>24&255,n=a^o^r^i,s=this;this._spi.send([90,17,238,0,0,121,a,o,r,i,n,0,0,121,255,0,0,0,121],null,function(e){e.data&&19==e.data.length&&121==e.data[4]&&121==e.data[12]&&121==e.data[17]?s._spi.receive(257,null,function(e){t&&t(e.data);}):t&&t();});},xnm.aio.m10T.STMSPIBootloader.prototype.eraseFlash=function(e){var t=this;this._spi.send([90,68,187,0,0,121,255,255,0],null,function(i){i.data&&9==i.data.length&&121==i.data[4]?t._waitForACK(1e3,10,e):e&&e();});},xnm.aio.m10T.STMSPIBootloader.prototype.writeFlash=function(e,t,i){var r=e>>0&255,o=e>>8&255,a=e>>16&255,n=e>>24&255,s=n^a^o^r,l=this;this._spi.send([90,49,206,0,0,121,n,a,o,r,s,0,0,121],null,function(e){if(e.data&&14==e.data.length&&121==e.data[4]&&121==e.data[12]){var r=[t.length-1].concat(t);s=0;for(var o=0;o<r.length;o++){s^=r[o];}r=r.concat([s]),l._spi.send(r,null,function(e){l._waitForACK(10,50,i);});}else i&&i();});},xnm.aio.m10T.STMSPIBootloader.prototype.end=function(){this._spi.end();},xnm.aio.m10T.STMSPIBootloader.prototype._waitForACK=function(e,t,i){if(t<1)i&&i(!1);else{var r=this;setTimeout(function(){r._spi.send([0,0,121],null,function(o){o.data&&121==o.data[1]?i&&(i(!0),i=null):i&&r._waitForACK(e,t-1,i);});},e);}},xnm.aio.m10T.STMUpdater=function(e,t,i){this._file=e,this._bootloader=null,this._host=null,this.dfuTool=xnm.aio.m10T.V5Updater.DFU_TOOL.DFU_UTIL,this.hostType="A20",this.at=null,this.auth=null,this._offset=0,t&&(this._offset=t),this._fixedSize=i,this._callback=null,this._bytesToWrite=0,this._bytesWritten=0,this._retries=0,this._blockSize=256;},xnm.aio.m10T.STMUpdater.prototype._writeNextBlock=function(){var e=this;require("fs").readFileBinary(this._file,this._offset+this._bytesWritten,this._blockSize,function(t,i){if(!t&&i){var r=[],o=new Buffer(XC.getBytes(i,!0));for(r=Array.prototype.slice.call(o,0);r.length<e._blockSize;){r.push(255);}var a=!1;e._bootloader.writeFlash(134217728+e._bytesWritten,r,function(t){a||(a=!0,t?(e._retries=0,e._bytesWritten+=e._blockSize,e._bytesWritten>=e._bytesToWrite?(e._bootloader.end(),setTimeout(function(){e._resetViaNet(function(){e._callback&&(e._callback({error:null,state:100}),e._callback=null);});},50)):(e._callback&&e._callback({error:null,state:Math.floor(e._bytesWritten/e._bytesToWrite*100)}),e._writeNextBlock())):e._retries<12?(e._retries++,setTimeout(function(){e._writeNextBlock();},500)):(e._bootloader.end(),e._callback&&(e._callback({error:"failed to write ("+e._bytesWritten+")",state:0}),e._callback=null)));});}else e._callback&&(e._bootloader.end(),e._callback&&(e._callback({error:"failed to read file ("+e._bytesWritten+")",state:0}),e._callback=null));});},xnm.aio.m10T.STMUpdater.prototype._resetViaNet=function(e,t){var i="";this.at?i="&at="+this.at:this.auth&&(i="&auth="+this.auth);var r=this;$.ajax({type:"GET",url:"http://"+r._host+"/set?io3=0&t=50"+i,timeout:2e3,cache:!1,complete:function complete(o){var a=!1;if(o&&o.responseText&&(o=o.responseText),o){var n=null;try{n=$.parseJSON(o);}catch(e){}n&&n.XC_SUC&&(a=!0);}$.ajax({type:"GET",url:"http://"+r._host+"/set?io3=3"+i,timeout:2e3,cache:!1,complete:function complete(i){a||t?e&&e():r._resetViaNet(e,!0);}});}});},xnm.aio.m10T.STMUpdater.prototype._startSPIBootloader=function(e){var t="http://"+this._host+"/custom/startSPIBL";this.at?t+="?at="+this.at:this.auth&&(t+="?auth="+this.auth);$.ajax({type:"GET",url:t,timeout:4e3,cache:!1,complete:function complete(t){var i="request error";if(t&&t.responseText&&(t=t.responseText),t){var r=null;try{r=$.parseJSON(t);}catch(e){}r&&(i=r.XC_SUC?null:r.XC_ERR?r.XC_ERR.code?"code "+r.XC_ERR.code:"init error":"data error");}else i="response error";e&&e(i);}});},xnm.aio.m10T.STMUpdater.prototype.startNetUpdate=function(e,t){var i=new xnm.aio.m10T.IBus("SPI",e,8081);this._bootloader=new xnm.aio.m10T.STMSPIBootloader(i),this._host=e,this._callback=t,this._bytesToWrite=0,this._bytesWritten=0;var r=require("fs"),o=this;r.stat(this._file,function(e,i){e?t&&(t({error:"invalid update file",state:0}),o._callback=t=null):(o._fixedSize?o._bytesToWrite=o._fixedSize:o._bytesToWrite=i.size,o._startSPIBootloader(function(e){e?(o._bootloader.end(),t&&(t({error:"failed to start bootloader ("+e+")",state:0}),o._callback=t=null)):o._bootloader.eraseFlash(function(e){e?o._writeNextBlock():(o._bootloader.end(),t&&(t({error:"failed to erase flash",state:0}),o._callback=t=null));});}));});},xnm.aio.m10T.STMUpdater.prototype.startDFUUpdate=function(e,t,i,r){this.dfuTool===xnm.aio.m10T.V5Updater.DFU_TOOL.STM32?this._startDFUUpdate_STM32(e,t,i):this._startDFUUpdate_DFUUtil(e,t,r);},xnm.aio.m10T.STMUpdater.prototype._startDFUUpdate_DFUUtil=function(e,t,i){if(this._callback=t,this._bytesToWrite=0,this._bytesWritten=0,!require("fs").existsSync(this._file)&&t)return t({error:"invalid dfu file",state:0}),void(this._callback=t=null);var r='"'+e+'" -t 1024 -d 0483:df11 -a 0 -s 0x08000000:leave -D '+this._file;i&&"v6p"==i&&(r='"'+e+'" -d 0483:df11 -a 0 -s 0x08000000:leave -D '+this._file);var o=(0,require("child_process").exec)(r),a=0,n=this;o.stdout.on("data",function(e){if("."==(e=""+e))n._bytesWritten+=1024,n._callback&&(a=Math.floor(n._bytesWritten/n._bytesToWrite*100),n._callback({error:null,state:a}));else if(e&&e.length>1&&"-"==e.charAt(0))a=Number(e.substr(1)),n._callback&&100!=a&&n._callback({error:null,state:a});else if(e&&1===e.indexOf("Download")){var t=e.split("%")[0].split(" ");a=Number(t[t.length-1]),n._callback&&!isNaN(a)&&100!=a&&n._callback({error:null,state:a});}else if(e){var i=e.indexOf(", size = ");i>-1&&(n._bytesToWrite=parseInt(e.substr(i+9)));}}),o.on("error",function(e){n._callback&&(n._callback({error:"failed to start dfu-util",state:0}),n._callback=null);}),o.on("close",function(e){0==e||74==e&&100==a?n._callback&&(n._callback({error:null,state:100}),n._callback=null):n._callback&&(n._callback({error:"failed to flash via dfu-util",state:0}),n._callback=null);});},xnm.aio.m10T.STMUpdater.prototype._startDFUUpdate_STM32=function(e,t,i){if(this._callback=t,!require("fs").existsSync(this._file)&&t)return t({error:"invalid dfu file",state:0}),void(l._callback=t=null);var r='"'+e+'" -c port='+i+" -w "+this._file+" 0x08000000 -v -s",o=(0,require("child_process").exec)(r),a=0,n="",s=!1,l=this;o.stdout.on("data",function(e){var t=e.toString();if(XC.debugf(t),t.toLowerCase().indexOf("error: failed to download the file")>=0)l._callback&&(l._callback({error:"Failed to write file with STM32 cli.",state:0}),o.kill());else if(n+=t,!s)if(t.indexOf("File download complete")>=0)s=!0;else{var i=t.indexOf("%");if(i>=1){var r=t.substr(i-3,3).trim();a=parseInt(r,10),l._callback&&100!=a&&l._callback({error:null,state:a});}}}),o.on("error",function(e){var t="Failed to start STM32 cli.";XC.debugf("[STMUpdater._startDFUUpdate_STM32] Error "+e+": "+t,"error"),l._callback&&(l._callback({error:t,state:0}),l._callback=null);}),o.on("close",function(e,t){if(XC.debugf("DFU update via STM32 cli done. Close code/signal: "+e+"/"+t),0==e||74==e&&100==a)l._callback&&(l._callback({error:null,state:100}),l._callback=null);else if(l._callback){var i="Failed to flash via STM32 cli.";n.indexOf("verification failed")>=0&&(i+=" Verification failed."),XC.debugf("[STMUpdater._startDFUUpdate_STM32] "+i,"error"),l._callback({error:i,state:0}),l._callback=null;}});},xnm.aio.m10T.STMUpdater.prototype.resetST=function(e){var t=require("child_process").exec,i="/sys/class/gpio/gpio240/value",r="/sys/class/gpio/gpio241/value";"PI2"==this.hostType&&(i="/sys/class/gpio/gpio21/value",r="/sys/class/gpio/gpio20/value"),t(e?"echo 1 > "+i:"echo 0 > "+i),t("echo 1 > "+r),t("echo 0 > "+r),t("echo 1 > "+r),t("echo 0 > "+i);},xnm.aio.m10T.STMUpdater.prototype.startSPIUpdate=function(e,t){this._bootloader=new xnm.aio.m10T.STMSPIBootloader(e),this._callback=t,this._bytesToWrite=0,this._bytesWritten=0;var i=require("fs"),r=this;i.stat(this._file,function(e,i){e?t&&(t({error:"invalid update file (spi)",state:0}),r._callback=t=null):(r.resetST(!0),r._fixedSize?r._bytesToWrite=r._fixedSize:r._bytesToWrite=i.size,r._bootloader.start(function(e){e?r._bootloader.eraseFlash(function(e){e?r._writeNextBlock():(r._bootloader.end(),t&&(t({error:"failed to erase flash (spi)",state:0}),r._callback=t=null));}):(r._bootloader.end(),t&&(t({error:"failed to start bootloader (spi)",state:0}),r._callback=t=null));}));});},xnm.aio.m10T.STMUSBSerial=function(){this._port=null,this._serialPort=null,this._timeoutTimer=null,this._onError=null,this._onData=null,this._onTimeout=null,this._useChromeAPI=!1,this._connectionInfo=null,this._connId=null;try{require("serialport");}catch(e){"undefined"!=typeof chrome&&void 0!==chrome.serial&&(this._useChromeAPI=!0);}},xnm.aio.m10T.STMUSBSerial.prototype.on=function(e,t){"error"==e?this._onError=t:"data"==e?this._onData=t:"timeout"==e&&(this._onTimeout=t);},xnm.aio.m10T.STMUSBSerial.prototype.open=function(e,t,i){if(i||(i=230400),this._useChromeAPI)this._chromeOpen(e,t,i);else{this._port=e,this._baudrate=i;var r=require("serialport");if(r){if("undefined"!=typeof nw)if(String(nw.App.manifest.dependencies.serialport).split(".")[0].replace(/[><=~^]*/,"")>=10){var _require=require("serialport"),o=_require.SerialPort;this._serialPort=new o({path:e,baudRate:i});}this._serialPort||(r.SerialPort?this._serialPort=new r.SerialPort(e,{baudrate:i}):this._serialPort=new r(e,{baudRate:i}));var a=this;this._serialPort.on("open",function(){t&&t(),a._serialPort.flush(),a._serialPort.on("data",function(e){a._timeoutTimer&&(clearTimeout(a._timeoutTimer),a._timeoutTimer=null),a._onData&&a._onData(e);});}),this._serialPort.on("error",function(e){a._serialPort=null,a._timeoutTimer&&(clearTimeout(a._timeoutTimer),a._timeoutTimer=null),a._onError&&a._onError(e);});}else a._onError&&a._onError();}},xnm.aio.m10T.STMUSBSerial.prototype.write=function(e,t,i){if(this._useChromeAPI)this._chromeWrite(e,t,i);else if(this._serialPort){var r=this;this._serialPort.write(e,function(e){i&&i(e);}),t&&(this._timeoutTimer&&clearTimeout(this._timeoutTimer),this._timeoutTimer=setTimeout(function(){r._onTimeout&&r._onTimeout();},t));}},xnm.aio.m10T.STMUSBSerial.prototype.flush=function(){this._useChromeAPI?this._chromeFlush():this._serialPort&&this._serialPort.flush();},xnm.aio.m10T.STMUSBSerial.prototype.close=function(){this._useChromeAPI?this._chromeClose():(this._serialPort&&this._serialPort.close(),this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null),this._onError=null,this._onData=null,this._onTimeout=null);},xnm.aio.m10T.STMUSBSerial.prototype.generateCommandMessage=function(e,t){var i=[],r=[];if(t){(i=[31]).push(t),r.push(t);for(var o=0;o<e.length;o++){if("string"==typeof e)i.push(e.charCodeAt(o)),r.push(e.charCodeAt(o));else{var a=e[o];r.push(a),31!=a&&4!=a&&27!=a||i.push(27),i.push(a);}}var n=xnm.aio.m10T.CRC8(r);31!=n&&4!=n&&27!=n||i.push(27),i.push(n),i.push(4);}return i;},xnm.aio.m10T.STMUSBSerial.prototype.getMessageData=function(e){for(var t=null,i=!1,r=!1,o=0;o<e.length;o++){var a=e[o];if(27==a||4==a||31==a){if(i)t&&t.push(a),i=!1;else if(27==a)i=!0;else{if(4==a){r=!0,e.splice(0,o+1);break;}31==a&&(t=[],i=!1);}}else t&&t.push(a),i=!1;}if(t&&r&&t.length>1){xnm.aio.m10T.CRC8(t.slice(0,t.length-1));return t=t.slice(0,t.length-1);}return null;},xnm.aio.m10T.STMUSBSerial.prototype._chromeOpen=function(e,t,i){var r=this;if(!(null!==this._connId||this._port||"darwin"===process.platform&&String(e).indexOf("/tty.")<0)){this._port=e,this._baudrate=i;var o={bitrate:this._baudrate,persistent:!0};chrome.serial.onReceiveError.addListener(function(e){r._onError&&r._onError(),r._chromeClose();}),chrome.serial.connect(e,o,function(e){e?(r._connectionInfo=e,r._connId=e.connectionId,chrome.serial.onReceive.addListener(function(e){if(e&&e.connectionId===r._connId&&(r._timeoutTimer&&(clearTimeout(r._timeoutTimer),r._timeoutTimer=null),r._onData)){var t=Buffer.from(e.data);r._onData(t);}}),chrome.serial.flush(r._connId,function(e){t&&t();})):r._chromeClose();});}},xnm.aio.m10T.STMUSBSerial.prototype._chromeWrite=function(e,t,i){if(null!==this._connId){var r=this,o=new Uint8Array(e);chrome.serial.send(r._connId,o,function(e){console.log("[STMUSBSerial._chromeWrite] send:",e);}),r._timeoutTimer&&clearTimeout(r._timeoutTimer),t&&(r._timeoutTimer=setTimeout(function(){r._onTimeout&&r._onTimeout();},t));}},xnm.aio.m10T.STMUSBSerial.prototype._chromeFlush=function(){null!==this._connId&&chrome.serial.flush(this._connId,function(e){});},xnm.aio.m10T.STMUSBSerial.prototype._chromeClose=function(){if(null!==this._connId){var e=this._connId;chrome.serial.disconnect(this._connId,function(t){console.log("[STMUSBSerial._chromeOpen] Connection to "+e+" has been closed. ("+t+")");});}this._connectionInfo=null,this._connId=null,this._timeoutTimer&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null),this._port=null,this._onError=null,this._onData=null,this._onTimeout=null;},xnm.aio.m10T.ESPUpdater=function(e,t,i,r){this._file=e,this._filesize=0,this._offset=0,t&&(this._offset=t),this._fixedSize=i,this._md5=null,r&&(this._md5=r),this._useNewHeader=!0,this._callback=null,this._blockSize=496,this._bytesSent=0,this._retries=0;},xnm.aio.m10T.ESPUpdater.prototype._getNextSerialFlashData=function(e,t){require("fs").readFileBinary(this._file,this._offset+this._bytesSent,this._blockSize,function(i,r){if(!i&&r){for(var o=r.length/2,a=[192,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=239,s=0;s<r.length;s+=2){n^=c=parseInt(r[s]+r[s+1],16),a.push(c);}a[3]=o+16&255,a[4]=(o+16&65280)>>8,a[5]=n,a[9]=255&o,a[10]=(65280&o)>>8,a[13]=255&e,a[14]=(65280&e)>>8;var l=[192];for(s=1;s<a.length;s++){var c;192!=(c=a[s])&&219!=c||(l.push(219),c=208+((240&c)>>4)),l.push(c);}l.push(192),t&&t(l);}else t&&t();});},xnm.aio.m10T.ESPUpdater.prototype.startSerialUpdate32=function(e,t,i){this._callback=i,this._blockSize=1024,this._bytesSent=0;var r=this,o=r._file,a=new xnm.aio.m10T.STMUSBSerial();new Buffer([]);a.on("error",function(){i&&i({error:"serial port error",state:0});}),a.on("data",function(e){}),a.on("timeout",function(){i&&i({error:"serial timeout",state:0}),a.close();}),a.open(e,function(){a.write([31,48,0,4]),setTimeout(function(){a.close();var i="python "+t+" --chip esp32 --port "+e+' --baud 115200 --before no_reset --after hard_reset write_flash -z --flash_mode dio --flash_freq 40m --flash_size detect 0xe000 "'+o+'/ota_data_initial.bin" 0x1000 "'+o+'/bootloader/bootloader.bin" 0x10000 "'+o+'/main.bin" 0x8000 "'+o+'/partitions.bin"',n=(0,require("child_process").exec)(i);n.stdout.on("data",function(e){if((e=e.trim()).length>26&&0==e.indexOf("Writing at ")){var t=parseInt(e.substr(26));t>99&&(t=99),r._callback&&r._callback({error:null,state:t});}}),n.on("error",function(e){}),n.on("close",function(e){r._callback&&(0==e?r._callback({error:null,state:100}):r._callback({error:"esptool error",state:0}));});},500);});},xnm.aio.m10T.ESPUpdater.prototype.startSerialUpdate=function(e,t,i){this._callback=t,this._blockSize=1024,this._bytesSent=0;var r=this;require("fs").stat(this._file,function(o,a){if(o)t&&t({error:"invalid update file",state:0});else{r._fixedSize?r._filesize=r._fixedSize:r._filesize=a.size;for(var n=new xnm.aio.m10T.STMUSBSerial(),s=!1,l=!1,c=0,u=[192,0,8,36,0,221,0,0,0,7,7,18,32],_=0;_<32;_++){u.push(85);}u.push(192);var f=new Buffer([]);n.on("error",function(e){if(n.close(),t){var i="serial port error";e&&e.message&&(i+=" ("+e.message+")"),t({error:i,state:0});}}),n.on("data",function(e){var o=!1;f=Buffer.concat([f,e]);for(var a=-1,c=null,u=0;u<f.length;u++){if(192==f[u])if(a<0)a=u;else if(12==(c=f.slice(a,a+u+1)).length&&0==c[9]&&0==c[10]){if(!s&&8==c[2]||!l&&2==c[2]||3==c[2]){f=new Buffer([]),n.flush(),o=!0;break;}a=u;}else a=u;}if(r._connTimeoutTimer&&(clearTimeout(r._connTimeoutTimer),r._connTimeoutTimer=null),s||l||(r._connTimeoutTimer=setTimeout(function(){s||l||(n.close(),t&&t({error:"communication error",state:0}));},2e3)),o)if(s||l){if(s=!0,l?r._bytesSent+=r._blockSize:l=!0,r._bytesSent<r._filesize){r._callback&&r._callback({error:null,state:Math.floor(r._bytesSent/r._filesize*100)});var _=Math.round(r._bytesSent/r._blockSize);r._bytesSent+r._blockSize>r._filesize&&(r._blockSize=r._filesize-r._bytesSent),r._getNextSerialFlashData(_,function(e){e?(r._lastCRC=e[5],setTimeout(function(){n.write(e,500);},5)):r._callback&&r._callback({error:"failed to read update file",state:0});});}else{var h=[192,0,4,4,0,r._lastCRC,0,0,0,1,0,0,0,192];setTimeout(function(){n.write(h),setTimeout(function(){r._callback&&r._callback({error:null,state:100}),n.close();},250);},50);}}else{s=!0;var m=[192,0,2,16,0,26,0,0,0,0,240,3,0,0,2,0,0,0,4,0,0,0,0,0,0,192];m[11]=7,m[10]=0,1==i&&(m[11]=63);var d=239;for(u=10;u<m.length-1;u++){d^=m[u];}m[5]=d,setTimeout(function(){n.write(m,2e4);},20);}}),n.on("timeout",function(){s?(t&&t({error:"serial timeout",state:0}),n.close()):c<5?(n.write(u,500),c++):(n.close(),t&&t({error:"failed to connect",state:0}));}),n.open(e,function(){n.write([31,48,0,4]),setTimeout(function(){n.write(u,500);},250);});}});},xnm.aio.m10T.ESPUpdater.prototype._sendNextNetPackage=function(e,t){var i=this;i._bytesSent<i._filesize&&(i._bytesSent+i._blockSize>i._filesize&&(i._blockSize=i._filesize-i._bytesSent),require("fs").readFileBinary(i._file,i._offset+i._bytesSent,i._blockSize,function(r,o){if(!r&&o){var a="443A";i._bytesSent+i._blockSize==i._filesize?a="453A":i._useNewHeader&&(a="4E3A"+XC.getHexVal(i._bytesSent/i._blockSize+1,4));var n=new Buffer(XC.getBytes(a+o,!0));e.write(n),i._bytesSent+=i._blockSize;}else e.destroy(),t&&t({error:"failed to read file",state:0});}));},xnm.aio.m10T.ESPUpdater.prototype._createUpdateSocket=function(e,t,i){var r=this,o={port:t,host:e},a=require("net").connect(o);a.setTimeout(1500),a.setNoDelay&&a.setNoDelay(!1),a.setEncoding("binary"),a.on("connect",function(){var e=new Buffer("UPD");r._useNewHeader&&0!=r._retries&&(e=new Buffer("UP2")),a.write(e);}),a.on("data",function(o){if(2==(o=new Buffer(o,"binary")).length&&79==o[0]&&75==o[1]){if(r._md5&&!r._md5Sent){var n=new Buffer("M:"+r._md5);return a.write(n),void(r._md5Sent=!0);}if(r._retries=0,i&&i({error:null,state:Math.floor(r._bytesSent/r._filesize*100)}),r._bytesSent<r._filesize)r._bytesSent+r._blockSize>r._filesize&&(r._blockSize=r._filesize-r._bytesSent),require("fs").readFileBinary(r._file,r._offset+r._bytesSent,r._blockSize,function(e,t){if(!e&&t){var o="443A";r._bytesSent+r._blockSize==r._filesize?o="453A":r._useNewHeader&&(o="4E3A"+XC.getHexVal(r._bytesSent/r._blockSize+1,4));var n=new Buffer(XC.getBytes(o+t,!0));a.write(n),r._bytesSent+=r._blockSize;}else i&&i({error:"failed to read file",state:0});});else a.destroy();}else if(5==o.length&&69==o[0]&&82==o[1]&&82==o[2]&&79==o[3]&&82==o[4]&&r._md5&&r._md5Sent&&0==r._bytesSent){r._md5=null;var s=i;i=null,setTimeout(function(){r.startNetUpdate(e,t,s);},0);}else if(5==o.length&&69==o[0]&&82==o[1]&&82==o[2]&&79==o[3]&&82==o[4]&&r._useNewHeader&&r._bytesSent==r._blockSize){r._useNewHeader=!1;s=i;i=null,setTimeout(function(){r.startNetUpdate(e,t,s);},0);}else a.destroy(),i&&i({error:"failed to flash block",state:0});}),a.on("error",function(e){i&&i({error:"socket error",state:0});}),a.on("timeout",function(){r._useNewHeader&&r._retries<2?(r._retries++,r._bytesSent-=r._blockSize,a.destroy(),r._createUpdateSocket(e,t,i)):(i&&i({error:"socket timeout",state:0}),a.destroy());}),a.on("close",function(){}),a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();},xnm.aio.m10T.ESPUpdater.prototype.startNetUpdate=function(e,t,i,r){this._callback=i,this._blockSize=496,this._bytesSent=0,this._retries=0,this._md5Sent=!1;var o=this;require("fs").stat(this._file,function(a,n){a?i&&i({error:"invalid update file",state:0}):(o._fixedSize?o._filesize=o._fixedSize:o._filesize=n.size,r>0?o._createUpdateSocket(e,t,function(a){a.error&&r>0?setTimeout(function(){o.startNetUpdate(e,t,i,r-1);},2e3):i(a);}):o._createUpdateSocket(e,t,i));});},xnm.aio.m10T.CC1310Updater=function(e,t,i,r){this._file=e,this._filesize=0,this._offset=0,t&&(this._offset=t),this._fixedSize=i,this._crc=null,r&&(this._crc=r),this._eraseFlash=!1,this._stmUSB=new xnm.aio.m10T.STMUSBSerial(),this._connected=!1,this._flashingFinished=!1,this._callback=null,this._blockSize=252,this._bytesSent=0,this._retries=0;},xnm.aio.m10T.CC1310Updater.prototype._getNextPackage=function(e,t){var i=this;if(84==e[0]&&8==e.length&&(204==e[1]||51==e[1])){if(51==e[1]?i._retries++:i._retries=0,1==i._eraseFlash&&1!=e[2]){var r=i._stmUSB.generateCommandMessage([6,1],84);return void t(r);}if(0==i._eraseFlash&&0!=e[2]){r=i._stmUSB.generateCommandMessage([6,0],84);return void t(r);}if(0==e[3]){if(i._flashingFinished)i._bytesSent=i._filesize,t([]);else{r=i._stmUSB.generateCommandMessage([0],84);t(r);}}else if(5==e[3]){i._flashingFinished=!0;r=i._stmUSB.generateCommandMessage([5],84);t(r);}else if(1==e[3]||3==e[3]||4==e[3]){if(i._bytesSent=(e[4]<<24)+(e[5]<<16)+(e[6]<<8)+e[7],i._bytesSent<i._filesize)i._bytesSent+i._blockSize>i._filesize&&(i._blockSize=i._filesize-i._bytesSent),require("fs").readFileBinary(i._file,i._offset+i._bytesSent,i._blockSize,function(e,r){if(!e&&r){var o=[3,(4278190080&i._bytesSent)>>24,(16711680&i._bytesSent)>>16,(65280&i._bytesSent)>>8,255&i._bytesSent];o=o.concat(XC.getBytes(r,!0)),o=i._stmUSB.generateCommandMessage(o,84),t(o),i._bytesSent+=i._blockSize;}else t&&t(null);});else t([]);}}},xnm.aio.m10T.CC1310Updater.prototype._createUpdateSocket=function(e,t,i){var r=this,o={port:t,host:e},a=require("net").connect(o);a.setTimeout(1e3),a.setNoDelay&&a.setNoDelay(!1),a.setEncoding("binary");var n=[];a.on("connect",function(){var e=new Buffer("SER");a.write(e);}),a.on("data",function(e){e=new Buffer(e,"binary");for(var t=0;t<e.length;t++){n.push(e[t]);}if(r._connected||2!=e.length||79!=e[0]||75!=e[1]){if(r._connected)for(o=r._stmUSB.getMessageData(n);o;){r._getNextPackage(o,function(e){if(r._retries>3)return i&&i({error:"flashing failed ["+r._bytesSent+" bytes sent]",state:0}),void a.destroy();null!=e?(i&&i({error:null,state:Math.floor(r._bytesSent/r._filesize*100)}),e.length>0?a.write(new Buffer(e)):a.destroy()):i&&i({error:"failed to read file",state:0});}),o=r._stmUSB.getMessageData(n);}else a.destroy(),i&&i({error:"failed to flash block",state:0});}else{r._connected=!0,n=[];var o=r._stmUSB.generateCommandMessage([1],84);a.write(new Buffer(o));}}),a.on("error",function(e){i&&i({error:"socket error",state:0});}),a.on("timeout",function(){r._retries<2?(r._retries++,r._connected=!1,r._bytesSent-=r._blockSize,r._bytesSent<0&&(r._bytesSent=0),a.destroy(),r._createUpdateSocket(e,t,i)):(i&&i({error:"socket timeout",state:0}),a.destroy());}),a.on("close",function(){}),a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();},xnm.aio.m10T.CC1310Updater.prototype.startNetUpdate=function(e,t,i,r){this._callback=i,this._connected=!1,this._flashingFinished=!1,this._bytesSent=0,this._retries=0,this._eraseFlash=!1,1==r&&(this._eraseFlash=!0);var o=this;require("fs").stat(this._file,function(r,a){r?i&&i({error:"invalid update file",state:0}):(o._fixedSize?o._filesize=o._fixedSize:o._filesize=a.size,o._createUpdateSocket(e,t,i));});},xnm.aio.m10T.CC1310Updater.prototype.startSerialUpdate=function(e,t,i){this._callback=t,this._connected=!1,this._flashingFinished=!1,this._bytesSent=0,this._retries=0,this._eraseFlash=!1,1==i&&(this._eraseFlash=!0);var r=this;require("fs").stat(this._file,function(i,o){if(i)t&&t({error:"invalid update file",state:0});else{r._fixedSize?r._filesize=r._fixedSize:r._filesize=o.size;var a=new xnm.aio.m10T.STMUSBSerial(),n=0,s=[];a.on("error",function(e){if(t){var i="serial port error";e&&e.message&&(i+=" ("+e.message+")"),t({error:i,state:0});}}),a.on("data",function(e){for(var i=0;i<e.length;i++){s.push(e[i]);}for(var o=r._stmUSB.getMessageData(s);o;){r._getNextPackage(o,function(e){if(r._retries>3)return t&&t({error:"flashing failed ["+r._bytesSent+" bytes sent]",state:0}),void a.close();if(null!=e){var i=Math.floor(r._bytesSent/r._filesize*99);r._flashingFinished&&(i=100),t&&t({error:null,state:i}),e.length>0?a.write(e,500):a.close();}else t&&t({error:"failed to read file",state:0});}),o=r._stmUSB.getMessageData(s);}}),a.on("timeout",function(){if(n<5){var e=r._stmUSB.generateCommandMessage([1],84);a.write(e,500),n++;}else a.close(),t&&t({error:"failed to connect",state:0});}),a.open(e,function(){setTimeout(function(){var e=r._stmUSB.generateCommandMessage([1],84);a.write(e,500);},250);});}});},xnm.aio.m10T.V5Updater=function(){this.at=null,this.auth=null,this.dfuTool=xnm.aio.m10T.V5Updater.DFU_TOOL.DFU_UTIL,this.useMD5=!1,this.useNewHeader=!0;},xnm.aio.m10T.V5Updater.DFU_TOOL={DFU_UTIL:1,STM32:2},xnm.aio.m10T.V5Updater.prototype.parseHeader=function(e){var t=null,i=e.indexOf("HEADER@");if(0===i&&(i=(t=e.substr(7)).indexOf("@HEADER"))>0&&(t=t.substr(0,i)),t&&t.length&&t.length>0){var r=t.split("@");if(2==r.length){var o=r[0].split("_"),a=r[1].split("_");if(o.length>=5&&a.length>=5){var n=o[0],s=o[1],l=parseInt(o[o.length-2],10),c=o[o.length-1],u=o.slice(2,o.length-2).join("_");o=[n,s,u,l,c];var _=a[0],f=a[1],h=parseInt(a[a.length-2],10),m=a[a.length-1],d=a.slice(2,a.length-2).join("_");a=[_,f,d,h,m];var p=c.split("-");2===p.length?(c=parseInt(p[0],10),o[4]=c,o.push(p[1])):(c=parseInt(c,10),o[4]=c);var g=m.split("-");return 2===g.length?(m=parseInt(g[0],10),a[4]=m,a.push(g[1])):(m=parseInt(m,10),a[4]=m),{esp:o,st:a,offset:e.length+1};}}}return null;},xnm.aio.m10T.V5Updater.prototype.getFileInfos=function(e,t){var i=require("fs");i.stat(e,function(r,o){if(r)t(r,null);else{var a=require("crypto"),n=i.createReadStream(e),s=a.createHash("md5"),l=new Buffer([]);s.setEncoding("hex"),n.on("data",function(e){l=Buffer.concat([l,e]);}),n.on("end",function(){s.end(),o.md5=s.read(),o.crc32=xnm.aio.m10T.CRC32(l),t(null,o);}),n.pipe(s);}});},xnm.aio.m10T.V5Updater.prototype.packFile=function(e,t,i,r,o,a,n){var s=require("fs"),l=this;l.getFileInfos(i,function(c,u){c?n&&n("invalid file"):l.getFileInfos(r,function(l,c){if(l)n&&n("invalid file");else{var _="HEADER@"+("esp_"+o+"_"+e+"_0_"+u.size+"-"+u.md5)+"@"+("st_"+o+"_"+t+"_"+u.size+"_"+c.size+"-"+c.crc32)+"@HEADER\r\n";s.existsSync(a)&&s.unlinkSync(a);var f=s.createWriteStream(a);f.write(_);var h=s.createReadStream(i);h.on("end",function(){(h=s.createReadStream(r)).on("end",function(){f.end(),n&&n();}),h.pipe(f,{end:!1});}),h.pipe(f,{end:!1});}});});},xnm.aio.m10T.V5Updater.prototype.packFileV5Plus=function(e,t,i,r,o,a,n){var s=require("fs");s.stat(i,function(l,c){l?n&&n("invalid file"):s.stat(r,function(l,u){if(l)n&&n("invalid file");else{var _=0,f="a20_"+o+"_"+e+"_"+_+"_"+c.size;_+=c.size;var h="HEADER@"+f+"@"+("st_"+o+"_"+t+"_"+_+"_"+u.size)+"@HEADER\r\n";s.existsSync(a)&&s.unlinkSync(a);var m=s.createWriteStream(a);m.write(h);var d=s.createReadStream(i);d.on("end",function(){(d=s.createReadStream(r)).on("end",function(){m.end(),n&&n();}),d.pipe(m,{end:!1});}),d.pipe(m,{end:!1});}});});},xnm.aio.m10T.V5Updater.prototype.updateFirmware=function(e,t,i,r){var o=require("fs"),a=this;o.existsSync(t)?o.stat(t,function(n,s){n||o.readFileLine(t,1,function(o,n){var s=!1;if(!o&&n){var l=a.parseHeader(n);if(l){var c=null;a.useMD5&&(c=l.st[5]);var u=new xnm.aio.m10T.STMUpdater(t,l.offset+l.st[3],l.st[4],c);u.at=a.at,u.auth=a.auth,u.startNetUpdate(e,function(o){if(o.error&&i)i(o);else if(i&&i({error:null,state:Math.floor(o.state/2)}),100==o.state){var n=null;a.useMD5&&(n=l.esp[5]),(u=new xnm.aio.m10T.ESPUpdater(t,l.offset,l.esp[4],n)).startNetUpdate(e,8081,function(e){e.error&&i?i(e):i&&i({error:null,state:Math.floor(50+e.state/2)});},r);}}),s=!0;}}!s&&i&&i({error:"[04] invalid firmware file",state:0});});}):i&&i({error:"[02] file does not exist",state:0});},xnm.aio.m10T.V5Updater.prototype.updateFirmwareInReverseOrder=function(e,t,i,r){var o=require("fs"),a=this;o.existsSync(t)?o.stat(t,function(n,s){n?i&&i({error:n.message,state:0}):o.readFileLine(t,1,function(o,n){var s=!1;if(!o&&n){var l=a.parseHeader(n);if(l){var c=null;a.useMD5&&(c=l.esp[5]);var u=new xnm.aio.m10T.ESPUpdater(t,l.offset,l.esp[4],c);u.startNetUpdate(e,8081,function(r){if(r&&r.error)i&&i(r);else{var o=Math.floor(r.state/2);if(i&&i({error:null,state:o}),100===r.state){setTimeout(function(){var r;r=null,a.useMD5&&(r=l.st[5]),(u=new xnm.aio.m10T.STMUpdater(t,l.offset+l.st[3],l.st[4],r)).at=a.at,u.auth=a.auth,u.startNetUpdate(e,function(e){if(e&&e.error)i&&i(e);else{var t=Math.floor(50+e.state/2);i&&i({error:null,state:t});}});},9e4);}}},r),s=!0;}}s||i&&i({error:"[04] invalid firmware file",state:0});});}):i&&i({error:"[02] file does not exist",state:0});},xnm.aio.m10T.V5Updater.prototype._updateFirmwareWithRetries_phase1=function(e,t,i,r,o,a){var n=this,s=null;this.useMD5&&(s=o.st[5]);var l=new xnm.aio.m10T.STMUpdater(t,o.offset+o.st[3],o.st[4],s);l.at=n.at,l.auth=n.auth,l.startNetUpdate(e,function(s){if(s.error)return a&&a({error:s.error,state:s.state,phase:1,retriesLeft:r}),void(0===s.state&&r>0&&setTimeout(function(){n._updateFirmwareWithRetries_phase1(e,t,i,r-1,o,a);},2e3));a&&a({error:null,state:Math.floor(s.state/2)}),100==s.state&&n._updateFirmwareWithRetries_phase2(e,t,i,o,a);});},xnm.aio.m10T.V5Updater.prototype._updateFirmwareWithRetries_phase2=function(e,t,i,r,o){var a=this,n=null;this.useMD5&&(n=r.esp[5]),new xnm.aio.m10T.ESPUpdater(t,r.offset,r.esp[4],n).startNetUpdate(e,8081,function(n){n.error?(o&&o({error:n.error,state:n.state,phase:2,retriesLeft:i}),i>0&&setTimeout(function(){a._updateFirmwareWithRetries_phase2(e,t,i-1,r,o);},2e3)):o&&o({error:null,state:Math.floor(50+n.state/2)});});},xnm.aio.m10T.V5Updater.prototype.updateFirmwareWithRetries=function(e,t,i,r){var o=require("fs"),a=this;(i=Number(i))<0||isNaN(i)?r&&r({error:'[01] Invalid value for parameter "retries". Has to be a number >= 0.',state:0}):o.existsSync(t)?o.stat(t,function(n,s){n?r&&r({error:n.message,state:0}):o.readFileLine(t,1,function(o,n){if(!o&&n){var s=a.parseHeader(n);s?a._updateFirmwareWithRetries_phase1(e,t,i,i,s,r):r&&r({error:"[03] Failed to parse firmware file header.",state:0});}else r&&r({error:"[04] Invalid firmware file.",state:0});});}):r&&r({error:"[02] File does not exist.",state:0});},xnm.aio.m10T.V5Updater.prototype.isDFUConnected=function(e,t,i){var r=xnm.aio.m10T.V5Updater.DFU_TOOL;this.dfuTool===r.STM32?this._isDFUConnected_STM32(e,t,i):this._isDFUConnected_DFUUtil(e,t,i);},xnm.aio.m10T.V5Updater.prototype._isDFUConnected_DFUUtil=function(e,t,i){var r=(0,require("child_process").exec)('"'+e+'" -l'),o=!1;r.stdout.on("data",function(e){e&&e.toString().indexOf(t)>-1&&(o=!0);}),r.on("error",function(e){XC.debugf("error",e);}),r.on("close",function(e){i&&i(o);});},xnm.aio.m10T.V5Updater.prototype._isDFUConnected_STM32=function(e,t,i){var r=(0,require("child_process").exec)('"'+e+'" -l usb'),o="";Array.isArray(t)||(t=[t]),r.stdout.on("data",function(e){e&&(o+=e.toString());}),r.on("error",function(e){XC.debugf("STM32 tool error: "+e,"error");}),r.on("close",function(e){var r=!1,a=null,n=null;XC.debugf(o);for(var s=0;s<t.length;s++){var l=t[s];if(o.indexOf("Device ID              : "+l)>-1){r=!0,a=l;for(var c=o.split("\n"),u=0;u<c.length;u++){var _=c[u];if(_.indexOf("Device Index           : ")>=0){var f=_.split(":");n=(n=f[f.length-1].trim()).toLowerCase();break;}}break;}}i&&i(r,a,n);});},xnm.aio.m10T.V5Updater.prototype.waitForDFUConnect=function(e,t,i,r){var o=this;this.isDFUConnected(e,t,function(a,n,s){a?r&&r(!0,n,s):i>0?setTimeout(function(){o.waitForDFUConnect(e,t,i-.5,r);},500):r&&r(!1,n,s);});},xnm.aio.m10T.V5Updater.prototype.waitForSerialConnection=function(e,t,i){if(this._useChromeAPI)this._chromeWaitForSerialConnection(e,t,i);else{var r=this,cbPorts=function cbPorts(o,a){if(null==a&&(a=[]),i&&a&&i.length<a.length)for(var n=0;n<a.length;n++){for(var s=!0,l=a[n].comName||a[n].path,c=0;c<i.length;c++){if(l==(i[c].comName||i[c].path)){s=!1;break;}}if(s){var u=l;setTimeout(function(){t&&t(u);},1e3);}}else e>0?setTimeout(function(){r.waitForSerialConnection(e-.5,t,a);},500):t&&t(null);},o=require("serialport");if("undefined"!=typeof nw){var a=String(nw.App.manifest.dependencies.serialport).split(".")[0].replace(/[><=~^]*/,"");if(a>=10){var _require2=require("serialport"),n=_require2.SerialPort;o=n;}if(a>=8)return void o.list().then(function(e){cbPorts(0,e);},function(e){cbPorts(0,null);});}o.list(cbPorts);}},xnm.aio.m10T.V5Updater.prototype._chromeWaitForSerialConnection=function(e,t,i){var r=this,fnCb=function fnCb(e){setTimeout(function(){t&&t(e);},1e3);};chrome.serial.getDevices(function(o){if(Array.isArray(o)||(o=[]),i&&i.length<o.length)for(var a=0;a<o.length;a++){for(var n=!0,s=0;s<i.length;s++){if(o[a].path==i[s].path){n=!1;break;}}if(n){var l=o[a].path;fnCb(l);}}else e>0?setTimeout(function(){r._chromeWaitForSerialConnection(e-.5,t,o);},500):t&&t(null);});},xnm.aio.m10T.V6PUpdater=function(){var Updater=function Updater(e,t,i,r){this._logger=null;try{this._logger=require("x.logger.js").getLogger("xnm.aio.m10T.V6PUpdater");}catch(e){var o=this;this._logger={log:function log(){console.log.apply(o,arguments);}};}this._gatewayJSON=e,this._updateFileUrl=null,this._gateway=null,this._cloud=null,this._listeners={},this._state=0,this._gatewayRebootTimeout=t||3e5,this._updateFirmwareMessageTimeout=i||18e4,this._wsClz=r||require("ws");};return Updater.prototype.on=function(e,t){e&&t&&(this._listeners[e]||(this._listeners[e]=[]),-1==this._listeners[e].indexOf(t)&&this._listeners[e].push(t));},Updater.prototype.off=function(e,t){if(e&&this._listeners[e])if(t){var i=this._listeners[e].indexOf(t);-1!=i&&this._listeners[e].splice(i,1);}else this._listeners[e]=[];},Updater.prototype.start=function(e,t){if(0!=this._state&&-1!=this._state)throw new Error("firmware update process is running");if(!e)throw new Error("invalid url argument");t&&this.on("end",t),this._logger.log("debug","start update firmware with url:"+e),this._updateFileUrl=e,this._onStart();var i=require("xnm.aio.gateway.js");if(this._gateway=i.resolveGateway(this._gatewayJSON),!this._gateway)return this._logger.log("debug","invalid gateway json"),void this._onError(new Error("invalid gateway json"));this._gateway.timeout=2e3;var r=this;this._onStage(1,"get gateway info"),this._logger.log("debug","get gateway info"),this._getGatewayInfo(function(e){if(r._logger.log("debug","get gateway info"+(e?" failed:"+e.message:" success")),e)r._onError(new Error("get gateway info failed:"+e.message));else{var t=r._gateway._mac;r._onStage(2,"submit update file url to gateway"),r._logger.log("debug","submit update file url to gateway["+t+"]"),r._submitUpdateFileUrl(function(e){r._logger.log("debug","submit update file url to gateway["+t+"]"+(e?" failed:"+e.message:" success")),e?r._onError(new Error("submit update file url to gateway failed:"+e.message)):(r._onStage(3,"gateway reboot to recovery mode"),r._logger.log("debug","wait gateway["+t+"] reboot to recovery mode"),r._gatewayRebootToRecovery(function(e){r._logger.log("debug","gateway["+t+"] reboot to recovery mode"+(e?" failed:"+e.message:" success")),e?r._onError(new Error("gateway reboot to recovery mode failed:"+e.message)):(r._onStage(4,"update firmware"),r._logger.log("debug","update firmware"),r._updateFirmware(function(e){r._logger.log("debug","update firmware"+(e?" failed:"+e.message:" success")),e?r._onError(new Error("update firmware failed:"+e.message)):(r._onStage(5,"gateway reboot to normal mode"),r._logger.log("debug","wait gateway["+t+"] reboot to normal mode"),r._gatewayRebootToNormal(function(e){r._logger.log("debug","gateway["+t+"] reboot to normal mode"+(e?" failed:"+e.message:" success")),e?r._onError(new Error("gateway reboot to normal mode failed:"+e.message)):r._onEnd();}));}));}));});}});},Updater.prototype._getGatewayInfo=function(e){var t=this;this._gateway._getInfo(function(i,r){i?e(i):r&&r.mac?(t._gateway._mac=r.mac,r.mediola_mac&&(t._gateway._mac=r.mediola_mac),e()):e(new Error("invalid gateway info"));});},Updater.prototype._submitUpdateFileUrl=function(e){this._gateway._executeRequest("/update",{url:this._updateFileUrl},{timeout:3e4},function(t){e(t);});},Updater.prototype._gatewayRebootToRecovery=function(e){var t=this._gatewayRebootTimeout,i=!0,r=this,_searchGateway=function _searchGateway(){i&&(r._logger.log("trace","start search gateway"),require("xnm.aio.gateway.js").discoverWithTimeout(5e3,null,function(e,t){if(i)if(!e&&t&&t.length){r._logger.log("trace","find gateways:"+JSON.stringify(t.map(function(e){return{ip:e._ip,mac:e._mac,mode:e._mode,hwv:e._hwv};})));for(var o=0;o<t.length;o++){var a=t[o];a&&a._mac==r._gateway._mac&&0==a._mode&&a._ip!=r._gateway._ip&&(r._gateway._ip=a._ip,r._gateway._port=a._port);}_searchGateway();}else _searchGateway();}));},_getInfo=function _getInfo(e,t){i?e._getInfo(function(o,a){if(r._logger.log("trace","get gateway["+e._mac+"] - "+e._ip+" info "+(o?"failed:"+o.message:"success")),!o&&a&&r._logger.log("trace","get gateway["+e._mac+"] - "+e._ip+" info:"+JSON.stringify(a)),o)setTimeout(function(){_getInfo(e,t);},500);else if(a&&0==a.mode){var n=a.mac;a.mediola_mac&&(n=a.mediola_mac),n&&-1!=n.indexOf(":")&&(n=n.replace(/\:/g,"-")),n==e._mac?(r._logger.log("trace","gateway["+e._mac+"] - "+e._ip+" in recovery mode"),i=!1,t()):setTimeout(function(){_getInfo(e,t);},500);}else setTimeout(function(){_getInfo(e,t);},500);}):t(new Error("get info from gateway in recovery mode failed"));},o=setTimeout(function(){i=!1,o=null,e&&(e(new Error("wait timeout")),e=null);},t);_searchGateway(),_getInfo(this._gateway,function(t){o&&(clearTimeout(o),o=null),e&&(e(t),e=null);});},Updater.prototype._updateFirmware=function(e){var t=!1,i=null,r=null,o=this,a=new(0,this._wsClz)("ws://"+this._gateway._ip+":"+this._gateway._port+"/ws"),_startMessageTimeout=function _startMessageTimeout(){i&&(clearTimeout(i),i=null),i=setTimeout(function(){o._logger.log("trace","websocket message timeout"),i=null;var t=null;e&&(t=e,e=null),a.close(),t&&(t(new Error("firmware update message timeout")),t=null);},o._updateFirmwareMessageTimeout);};a.on("open",function(){o._logger.log("trace","websocket open"),t=!0,_startMessageTimeout();}),a.on("message",function(t){o._logger.log("trace","websocket message:"+t),_startMessageTimeout();try{var n=JSON.parse(t);if(n)switch(n.type){case"status":switch(n.status){case"START":r=0;break;case"RUN":case"DONE":break;case"SUCCESS":r=100;}break;case"step":var s=parseInt(n.number),l=(parseInt(n.step)-1)/s*100,c=100/n.number,u=parseInt(n.percent);r=c*u/100+l,r=Math.round(r),o._logger.log("debug","update firmware progress:"+r+" name:"+n.name);}if(e&&o._onStage(4,"update firmware",r,n),"status"==n.type&&"DONE"==n.status){i&&(clearTimeout(i),i=null);var _=null;e&&(_=e,e=null),a.close(),_&&(_(),_=null);}else if("status"==n.type&&"FAILURE"==n.status){i&&(clearTimeout(i),i=null);_=null;e&&(_=e,e=null),a.close(),_&&(_(new Error("firmware update failure")),_=null);}}catch(e){}}),a.on("close",function(i,r){o._logger.log("trace","websocket closed"),t||e&&(e(new Error("enable to connect websocket, directly closed")),e=null);}),a.on("error",function(i){o._logger.log("trace","websocket error:"+i.message),t||e&&(e(i),e=null);}),a.on("pong",function(){o._logger.log("trace","receive pong");}),a.on("ping",function(){o._logger.log("trace","receive ping"),a.pong();});},Updater.prototype._gatewayRebootToNormal=function(e){var t=this._gatewayRebootTimeout,i=!0,r=this,_searchGateway=function _searchGateway(){i&&(r._logger.log("trace","start search gateway"),require("xnm.aio.gateway.js").discoverWithTimeout(5e3,null,function(e,t){if(i)if(!e&&t&&t.length){r._logger.log("trace","find gateways:"+JSON.stringify(t.map(function(e){return{ip:e._ip,mac:e._mac,mode:e._mode,hwv:e._hwv};})));for(var o=0;o<t.length;o++){var a=t[o];a&&a._mac==r._gateway._mac&&0!=a._mode&&a._ip!=r._gateway._ip&&(r._gateway._ip=a._ip,r._gateway._port=a._port);}_searchGateway();}else _searchGateway();}));},_getInfo=function _getInfo(e,t){i?e._getInfo(function(o,a){if(r._logger.log("trace","get gateway["+e._mac+"] - "+e._ip+" info "+(o?"failed:"+o.message:"success")),!o&&a&&r._logger.log("trace","get gateway["+e._mac+"] - "+e._ip+" info:"+JSON.stringify(a)),o)setTimeout(function(){_getInfo(e,t);},500);else if(a&&0!=a.mode){var n=a.mac;a.mediola_mac&&(n=a.mediola_mac),n&&-1!=n.indexOf(":")&&(n=n.replace(/\:/g,"-")),n==e._mac?(r._logger.log("trace","gateway["+e._mac+"] - "+e._ip+" in normal mode"),i=!1,t()):setTimeout(function(){_getInfo(e,t);},500);}else setTimeout(function(){_getInfo(e,t);},500);}):t(new Error("get info from gateway in normal mode failed"));},o=setTimeout(function(){i=!1,o=null,e&&(e(new Error("wait timeout")),e=null);},t);_searchGateway(),_getInfo(this._gateway,function(t){o&&(clearTimeout(o),o=null),e&&(e(t),e=null);});},Updater.prototype._emit=function(){var e=arguments[0],t=Array.prototype.slice.call(arguments);t=t.slice(1);var i=this._listeners[e];if(i)for(var r=0;r<i.length;r++){var o=i[r];try{o.apply(this,t);}catch(e){}}},Updater.prototype._onStart=function(){this._state=1,this._emit("start");},Updater.prototype._onStage=function(e,t,i,r){this._state=e,this._emit("stage",{stage:e,message:t,progress:i,info:r});},Updater.prototype._onError=function(e){this._emit("error",e),this._onEnd(e);},Updater.prototype._onEnd=function(e){this._state=-1,this._emit("end",e);},Updater;}(),xnm.aio.m10T.Handler=function(){},xnm.aio.m10T.Handler.prototype.IBus=xnm.aio.m10T.IBus,xnm.aio.m10T.Handler.prototype.STMUpdater=xnm.aio.m10T.STMUpdater,xnm.aio.m10T.Handler.prototype.ESPUpdater=xnm.aio.m10T.ESPUpdater,xnm.aio.m10T.Handler.prototype.CC1310Updater=xnm.aio.m10T.CC1310Updater,xnm.aio.m10T.Handler.prototype.V5Updater=xnm.aio.m10T.V5Updater,xnm.aio.m10T.Handler.prototype.STMUSBSerial=xnm.aio.m10T.STMUSBSerial,xnm.aio.m10T.Handler.prototype.V6PUpdater=xnm.aio.m10T.V6PUpdater,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.m10T.Handler());