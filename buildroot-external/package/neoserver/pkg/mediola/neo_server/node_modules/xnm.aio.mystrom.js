var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.mystrom=xnm.aio.mystrom||{},xnm.aio.mystrom.WifiDevice=function(){var Device=function Device(e,t,o,r){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiDevice"),this.ip=e,this.port=t,this.uuid=o,this.port||(this.port=80),this.token=r,this.timeout=2e3;};Device.prototype.executeCommandCreator=function(e,t,o){t&&t.value?this.executeCommand(t,function(e){o&&o(e);}):o&&o(new Error("command value is empty"));},Device.prototype.getStatesCreator=function(e,t,o){this.getStates(function(e,r){for(var n=[],i=0;i<t.length;i++){if(t[i]&&t[i].id){var s="?";if(r&&t[i].status&&t[i].status.value)void 0!==(s=r[t[i].status.value])&&null!=s&&n.push({id:t[i].id,status:s});}}o&&o(null,n);});},Device.prototype._doRequest=function(e,t,o,r,n){var i,s,a=t,u="http://"+this.ip+":"+this.port+t;if(o){var l=[];for(i in o){if(o.hasOwnProperty(i)){s=i+"=";var c=o[i];void 0!==c&&null!=c&&(s+=encodeURIComponent(c)),l.push(s);}}u+="?"+l.join("&"),a+="?"+l.join("&");}var p="";if(r){for(i in s=[],r){r.hasOwnProperty(i)&&s.push(i+"="+r[i]);}p=s.join("&");}this._logger.log("trace","send "+e+" to url:"+u+" with data:"+p);var f={host:this.ip,port:this.port,path:a,method:e,headers:{"Content-Type":'application/x-www-form-urlencoded; charset="UTF-8"',"User-Agent":"mediola",Connection:"close",Referer:"http://"+this.ip}};p&&(f.headers["Content-Length"]=p.length),this.token&&(f.headers.TOKEN=this.token);var m=this,d=n,h=require("http").request(f,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){if(m._logger.log("trace","recevice "+e.statusCode+" response:"+t),t)try{var o=JSON.parse(t);d&&(d(null,e.statusCode,o),d=null);}catch(t){d&&(d(t,e.statusCode),d=null);}else d&&(d(null,e.statusCode,""),d=null);});});h.setTimeout(this.timeout,function(){m._logger.log("trace","http request timeout"),h.abort(),d&&(d(new Error("timeout")),d=null);}),h.on("error",function(e){m._logger.log("trace","http request error:"+e.message),d&&(d(e),d=null);}),p&&h.write(p),h.end();},Device.prototype._doRequestWithSocket=function(e,t,o,r,n){var i,s,a=t;if(o){var u=[];for(i in o){if(o.hasOwnProperty(i)){s=i+"=";var l=o[i];void 0!==l&&null!=l&&(s+=encodeURIComponent(l)),u.push(s);}}a+="?"+u.join("&");}var c=e+" "+a+" HTTP/1.1\r\n";c+="Host: "+this.ip+(80!=this.port?":"+this.port:"")+"\r\n",c+='Content-Type: application/x-www-form-urlencoded; charset="UTF-8"\r\n',c+="User-Agent: mediola\r\n",this.token&&(c+="Token: "+this.token+"\r\n"),r&&(c+="Content-Length: "+r.length+"\r\n"),c+="Connection: close\r\n\r\n",r&&(c+=r);var p=this,f=null,m=n,d="connect",h="",v=require("net").connect({port:this.port,host:this.ip});v.setTimeout(this.timeout),v.setEncoding("utf8"),this._logger.log("trace","start connect to "+this.ip+":"+this.port),v.on("connect",function(){p._logger.log("trace","success to connect "+p.ip+":"+p.port),d="connected",f=setTimeout(function(){v.destroy(),m&&(p._logger.log("trace","http timeout"),m(new Error("http timeout")),m=null);},p.timeout),p._logger.log("trace","send req "+c),v.write(c);}),v.on("data",function(e){if(p._logger.log("trace","receive data: "+e.toString()),h+=e.toString(),f&&(clearTimeout(f),f=null),h.length>=12){var t=h.substr(0,12).split(" "),o=parseInt(t[1]);v.destroy(),m&&m(null,o);}else f=setTimeout(function(){v.destroy(),m&&(p._logger.log("trace","http timeout"),m(new Error("http timeout")),m=null);},p.timeout);}),v.on("error",function(e){p._logger.log("trace","socket error: "+e.message),v.destroy(),m&&(m(e),m=null);}),v.on("timeout",function(){"connect"==d&&(p._logger.log("trace","connection timeout"),v.destroy(),m&&(m(new Error("connection timeout")),m=null));}),v.on("close",function(){p._logger.log("trace","socket closed"),v.destroy();}),v._doConnect&&"function"==typeof v._doConnect&&v._doConnect();},Device.prototype.toJSON=function(){return{ip:this.ip,port:this.port,uuid:this.uuid,token:this.token};},Device.build=function(e){if(!e||!e.type||!e.ip)return null;switch(e.type){case"switch":return new Switch(e.ip,e.port,e.uuid,e.token);case"bulb":return new Bulb(e.ip,e.port,e.uuid,e.token);case"strip":return new Strip(e.ip,e.port,e.uuid,e.token);case"button":return new Button(e.ip,e.port,e.uuid,e.token);}};var Switch=function Switch(e,t,o,r){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiSwitch"),Device.call(this,e,t,o,r);};Switch.prototype=new Device(),Switch.prototype.constructor=Switch,Switch.prototype.executeCommand=function(e,t){if(e){var o,r;switch(e.value){case"on":o="/relay",r={state:1};break;case"off":o="/relay",r={state:0};break;case"toggle":o="/toggle";break;default:return void(t&&t(new Error("unknown command")));}this._doRequestWithSocket("GET",o,r,null,t);}else t&&t(new Error("command object is null"));},Switch.prototype.getStates=function(e){this._doRequest("GET","/report",null,null,function(t,o,r){t?e&&e(t):r?(r.state=r.relay?"on":"off",e&&e(null,r)):e&&e(new Error("get states result invalid"));});},Switch.prototype.toJSON=function(){var e=Device.prototype.toJSON.call(this);return e.type="switch",e;},Switch.prototype.equalsTo=function(e){return!!e&&e instanceof Switch&&this.ip==e.ip&&this.port==e.port&&this.uuid==e.uuid;};var Bulb=function Bulb(e,t,o,r){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb"),Device.call(this,e,t,o,r),this._stateBuffer=null,this._stateBufferTS=null;};Bulb.prototype=new Device(),Bulb.prototype.constructor=Bulb,Bulb.prototype.executeCommand=function(e,t){if(e){if(this.uuid){var o,r=this,n="POST",i="/api/v1/device/"+this.uuid.toUpperCase(),s=null;switch(e.value){case"on":s={action:"on"};break;case"off":s={action:"off"};break;case"toggle":s={action:"toggle"};break;case"white":return void this.getStatesIncludBuffer(function(e,s){if(e)t&&t(e);else{var a=100;if(s&&s.color){var u=s.color.split(";");a=u.length<3?u[1]:u[2];}r._doRequest(n,i,o,{mode:"mono",color:"18;"+a},t);}});case"dimTo":case"dimUp":case"dimDown":return void 0===e.ext||null==e.ext?void(t&&t(new Error("command ext is null"))):void this.getStatesIncludBuffer(function(s,a){if(s)t&&t(s);else if(a&&a.color){var u=a.color.split(";"),l=0;switch(l=2==u.length?u[1]:u[2],e.value){case"dimTo":l=parseInt(e.ext);break;case"dimUp":l=parseInt(l)+parseInt(e.ext);break;case"dimDown":l=parseInt(l)-parseInt(e.ext);}l<0&&(l=0),l>100&&(l=100),2==u.length?u[1]=l:u[2]=l,r._doRequest(n,i,o,{action:"on",ramp:a.ramp,color:u.join(";")},t);}else t&&t(new Error("can not get color state"));});case"setCT":return void 0===e.ext||null==e.ext?void(t&&t(new Error("command ext is null"))):void this.getStatesIncludBuffer(function(s,a){if(s)t&&t(s);else{var u=parseInt(e.ext),l=100;if(u<1&&(u=1),u>18&&(u=18),a&&a.color){var c=a.color.split(";");l=c.length<3?c[1]:c[2];}r._doRequest(n,i,o,{mode:"mono",color:u+";"+l},t);}});case"setRGB":return void 0===e.ext||null==e.ext?void(t&&t(new Error("command ext is null"))):void this.getStatesIncludBuffer(function(s,a){if(s)t&&t(s);else{var u=function rgbToHsv(e,t,o){e/=255,t/=255,o/=255;var r,n,i=Math.max(e,t,o),s=Math.min(e,t,o),a=i,u=i-s;if(n=0==i?0:u/i,i==s)r=0;else{switch(i){case e:r=(t-o)/u+(t<o?6:0);break;case t:r=(o-e)/u+2;break;case o:r=(e-t)/u+4;}r/=6;}return[r,n,a];}(parseInt(e.ext.substr(0,2),16),parseInt(e.ext.substr(2,2),16),parseInt(e.ext.substr(4,2),16)),l=[];a&&a.color&&(l=a.color.split(";")).length<3&&(l[2]=l[1]),l[0]=Math.round(360*u[0]),l[1]=Math.round(100*u[1]),l[2]||(l[2]=Math.round(100*u[2])),r._doRequest(n,i,o,{color:l.join(";")},t);}});default:return void(t&&t(new Error("unknown command")));}this._doRequest(n,i,o,s,t);}else t&&t(new Error("mac address is null"));}else t&&t(new Error("command object is null"));},Bulb.prototype.getStates=function(e){if(this.uuid){var t=this;this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(o,r,n){if(o)e&&e(o);else if(n){var i=n[t.uuid.toUpperCase()];if(i){i.state=i.on?"on":"off";var s=i.color;if(s){var a=s.split(";");2==a.length?(i.ct=parseInt(a[0]),i.level=parseInt(a[1])):i.level=parseInt(a[2]);}t._stateBuffer=i,t._stateBufferTS=new Date().getTime(),e&&e(null,i);}else e&&e(new Error("get states result do not contain this device"));}else e&&e(new Error("get states result invalid"));});}else e&&e(new Error("mac address in null"));},Bulb.prototype.getStatesIncludBuffer=function(e){var t=new Date().getTime();if(this._stateBuffer&&this._stateBufferTS&&t-this._stateBufferTS<3e4)e&&e(null,this._stateBuffer);else{this._stateBuffer=null,this._stateBufferTS=null;this.getStates(e);}},Bulb.prototype.toJSON=function(){var e=Device.prototype.toJSON.call(this);return e.type="bulb",e;},Bulb.prototype.equalsTo=function(e){return!!e&&e instanceof Bulb&&this.ip==e.ip&&this.port==e.port&&this.uuid==e.uuid;};var Strip=function Strip(e,t,o,r){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiBulb"),Device.call(this,e,t,o,r),this._stateBuffer=null,this._stateBufferTS=null;};Strip.prototype=new Bulb(),Strip.prototype.constructor=Strip,Strip.prototype.toJSON=function(){var e=Bulb.prototype.toJSON.call(this);return e.type="strip",e;},Strip.prototype.equalsTo=function(e){return!!e&&e instanceof Strip&&this.ip==e.ip&&this.port==e.port&&this.uuid==e.uuid;};var Button=function Button(e,t,o,r){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.WifiButton"),Device.call(this,e,t,o,r);};return Button.prototype=new Device(),Button.prototype.constructor=Button,Button.prototype.getInfo=function(e){if(this.uuid){this._doRequest("GET","/api/v1/device/"+this.uuid.toUpperCase(),null,null,function(t,o,r){t?e&&e(t):r?e&&e(null,r):e&&e(new Error("get info result invalid"));});}else e&&e(new Error("mac address in null"));},Button.prototype.toJSON=function(){var e=Device.prototype.toJSON.call(this);return e.type="button",e;},Button.prototype.equalsTo=function(e){return!!e&&e instanceof Button&&this.ip==e.ip&&this.port==e.port&&this.uuid==e.uuid;},Device.Switch=Switch,Device.Bulb=Bulb,Device.Strip=Strip,Device.Button=Button,Device;}(),xnm.aio.mystrom.Discovery=function(){var Discovery=function Discovery(){this._logger=require("x.logger.js").getLogger("xnm.aio.mystrom.Discovery"),this._devices={},this._callbacks=[],this._searchTimeout=null,this._sockets=[];};return Discovery.prototype.start=function(e,t){t||(t=function t(){}),(!e||e<0)&&(e=1e4);var o=this._callbacks.length;if(-1==this._callbacks.indexOf(t)&&this._callbacks.push(t),!o){var r=this;this._searchTimeout=setTimeout(function(){r._searchFinish();},e),this._searchStart();}},Discovery.prototype._searchStart=function(){this._logger.log("debug","start search for devices");var e=require("os");require("dgram");if(e&&e.networkInterfaces){var t=e.networkInterfaces();for(var o in t){for(var r=t[o],n=0;n<r.length;n++){this._addDiscoverSocket(7979,r[n]);}this._addDiscoverSocket(7979,null);}}else this._addDiscoverSocket(7979,null);var i=this,s=require("x.upnp.js");s&&s.discoverDevices(function(e){if(0==e.name.indexOf("myStrom")){i._logger.log("debug","upnp find switch:"+e.uuid+" ip:"+e.ip);var t=e.ip,o=e.uuid.substr(e.uuid.length-12,12);i._devices[t]=new xnm.aio.mystrom.WifiDevice.Switch(t,null,o);}});},Discovery.prototype._searchFinish=function(){this._searchTimeout=null;var e=this._sockets;this._sockets=[];for(var t=e.length;t--;){var o=e[t];o&&o.close();}e=this._callbacks,this._callbacks=[],t=e.length;var r=[];for(var n in this._devices){if(this._devices.hasOwnProperty(n)){var i=this._devices[n];i&&r.push(i);}}for(this._devices={};t--;){var s=e[t];s&&s(null,r);}},Discovery.prototype._receivedData=function(e,t){if(t=t.toString("hex"),this._logger.log("debug","received data from "+e+" ("+t+")"),!(t.length<14)){var o=t.substr(0,12),r=t.substr(12,2);switch(r=parseInt(r,16)){case 101:case 106:case 107:this._devices[e]=new xnm.aio.mystrom.WifiDevice.Switch(e,null,o);break;case 102:this._devices[e]=new xnm.aio.mystrom.WifiDevice.Bulb(e,null,o);break;case 105:this._devices[e]=new xnm.aio.mystrom.WifiDevice.Strip(e,null,o);break;case 103:case 104:this._devices[e]=new xnm.aio.mystrom.WifiDevice.Button(e,null,o);}}},Discovery.prototype._addDiscoverSocket=function(e,t){var o,r=require("dgram"),n=this;if(t){if("IPv4"==t.family&&0==t.internal){try{o=r.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){o=r.createSocket("udp4");}o.on("listening",function(){o.setBroadcast(!0);}),o.on("message",function(e,t){n._receivedData(t.address,e);}),o.on("error",function(e){}),o.bind(e,t.address),this._sockets.push(o);}}else{try{o=r.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){o=r.createSocket("udp4");}o.on("message",function(e,t){n._receivedData(t.address,e);}),o.on("error",function(e){}),o.bind(e),this._sockets.push(o);}},Discovery;}(),xnm.aio.mystrom.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="MystromDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"mystrom",MAP:{"switch":{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}}]},bulb:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]},strip:{command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}},{type:"enum",name:"toggle",ref:{value:"toggle"}},{type:"int",name:"dim to",ref:{value:"dimTo",ext:"%d",extMeta:"0-100"}},{type:"int",name:"dim up",ref:{value:"dimUp",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"int",name:"dim down",ref:{value:"dimDown",ext:"%d",extMeta:"1-10",unit:"%"}},{type:"enum",name:"white",ref:{value:"white"}},{type:"rgb",name:"set color",ref:{value:"setRGB",ext:"%rgb"}},{type:"int",name:"set color temperature",ref:{value:"setCT",ext:"%d",extMeta:"1-18"}}],status:[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}},{type:"float",name:"power",ref:{value:"power"}},{type:"int",name:"color temperature",ref:{value:"ct",ext:"%d",extMeta:"1-18"}},{type:"int",name:"level",ref:{value:"level",ext:"%d"}}]}},getIPDeviceType:function getIPDeviceType(){return[{sys:this.SYS,name:"myStrom"}];},createDevice:function createDevice(e,t,o){var r=DMError,n=DMError.ERROR_CODE;e?e.ip?e.type?o(null,e):o(new r(n.INVALID,"type is invalid")):o(new r(n.INVALID,"ip is invalid")):o(new r(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){var r=DMError,n=DMError.ERROR_CODE;e?e.ip?e.type?o(null,e):o(new r(n.INVALID,"type is invalid")):o(new r(n.INVALID,"ip is invalid")):o(new r(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t){var o=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var o=!1,r=0;r<e.length;r++){if(e[r]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var r=[],n=null,i=o.getCommandStatusMap(e);return i&&(n=function(e,t,o){var r=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(i,0,t),r=r.concat(n)),r;};if(!e||null==e.type||void 0===e.type)return null;var r=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),r.command=n;break;case"status":n=_filter(e,t),r.status=n;break;default:return null;}return n&&0!=n.length?r:null;},getCommandStatusMap:function getCommandStatusMap(e){return this.MAP[e.type];}};}(),xnm.aio.mystrom.Handler=function(){var Handler=function Handler(){this._discovery=new xnm.aio.mystrom.Discovery();};return Handler.prototype.devicemanager=xnm.aio.mystrom.DM,Handler.prototype.Device=xnm.aio.mystrom.WifiDevice,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"mystrom");},Handler.prototype.resolveDevice=function(e){return e&&e.type&&e.ip?this.Device.build(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),r=o?o.command:[];t&&t(null,r);},Handler.prototype.getDeviceStatus=function(e,t){var o=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),r=o?o.status:[];t&&t(null,r);},Handler.prototype.doCommand=function(e,t,o){var r=this.resolveDevice(e);r?r.executeCommandCreator(e,t,function(e){o&&o(e);}):o&&o(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,o,r){var n=this.resolveDevice(t);if(n){var i=[{id:e,device:t,status:o}];n.getStatesCreator(null,i,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.discovery=function(e){this._discovery.start(1e4,e);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.mystrom.Handler());