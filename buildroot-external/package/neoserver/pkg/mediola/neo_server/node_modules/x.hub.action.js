var commandman=require("x.hub.commandman.js"),x=x||{};x.hub=x.hub||{},x.hub.action=x.hub.action||{},x.hub.action.ActionManager=function(){var Action=function Action(t,e,i){this._id=t,this._number=e,this._logger=require("x.logger.js").getLogger("x.hub.action.Action.["+t+"#"+e+"]"),this._actionPool=i,this._state=0,this._actions=[],this._callback=null,this._delayTimeout=null,this._nestedAction=null;};Action.prototype.getId=function(){return this._id;},Action.prototype.run=function(){var t=0,e=this;this._state=1;var cb=function cb(i){if(i){var n=e._actions[t];try{n=JSON.stringify(n);}catch(t){}}var o=i?"error":"trace";if(e._logger.log(o,"finish item("+t+")"+(i?" failed:"+i.message+" action:"+n:" success")),t++,2!=e._state){if(3!=e._state)if(t!=e._actions.length)e._logger.log("trace","do item("+t+")"),e._do(t,cb);else if(e._state=3,e._actionPool._onActionFinish(e),e._callback){try{e._callback(i);}catch(t){}e._callback=null;}}else if(e._state=3,e._logger.log("trace","action canceled "+n),e._actionPool._onActionFinish(e),e._callback){try{e._callback(new Error("action canceled"));}catch(t){}e._callback=null;}};this._logger.log("trace","do item("+t+")"),this._do(t,cb);},Action.prototype.cancel=function(){if(this._logger.log("trace","cancel action"),1==this._state&&(this._state=2),this._nestedAction&&(this._nestedAction.cancel(),this._nestedAction=null),this._delayTimeout&&(clearTimeout(this._delayTimeout),this._delayTimeout=null,this._state=3,this._logger.log("trace","action canceled"),this._actionPool._onActionFinish(this),this._callback))try{this._callback(new Error("action canceled"));}catch(t){}},Action.prototype._do=function(t,e){var i=this._actions[t];if(i){var n=this;if(null==i.delay||null==i.delay){if(i["if"])this._doStatement(t,i,e);else if(i.action)require("x.hub.action.js").getActionManager().executeActionWithId(i.action,e);else commandman.commandHandlerV6.executeCommandWithCommandInfo(i,function(t){e(t);});}else this._delayTimeout=setTimeout(function(){n._delayTimeout=null,e();},i.delay);}else e();},Action.prototype._doStatement=function(t,e,i){var n=this;this._logger.log("trace","do statement("+t+")"),function(t,e){var i=0,_o2=null;t.state?(n._logger.log("trace","check single state object"),n._checkState(t,function(t,i){e(t,i);})):t.and&&t.and.length?(_o2=function o(a,c){n._logger.log("trace","check "+i+'th item in "and" array '+(a?"failed:"+a.message:"result:"+c)),a?e(null,!1):c?++i<t.and.length?(n._logger.log("trace","check "+i+'th item in "and" array'),n._checkState(t.and[i],_o2)):e(null,!0):e(null,!1);},n._logger.log("trace","check "+i+'th item in "and" array'),n._checkState(t.and[i],_o2)):t.or&&t.or.length&&(_o2=function _o(a,c){n._logger.log("trace","check "+i+'th item in "or" array '+(a?"failed:"+a.message:"result:"+c)),a||!c?++i<t.or.length?(n._logger.log("trace","check "+i+'th item in "or" array'),n._checkState(t.or[i],_o2)):e(null,!1):e(null,!0);},n._logger.log("trace","check "+i+'th item in "or" array'),n._checkState(t.or[i],_o2));}(e["if"],function(o,a){n._logger.log("trace","do statement("+t+'), check "if" '+(o?"faild:"+o.message:"result: "+a)),o?i(o):a?(n._logger.log("trace","do statement("+t+') "then" actions'),function(e,i){if(e&&e.length){var o=n._id+"-if:"+t+"(then)";n._doNestedAction(o,e,i);}else i();}(e.then,i)):(n._logger.log("trace","do statement("+t+') "else" actions'),function(e,i){if(e&&e.length){var o=n._id+"-if:"+t+"(else)";n._doNestedAction(o,e,i);}else i();}(e["else"],i));});},Action.prototype._checkState=function(t,e){this._logger.log("trace","check state item: "+JSON.stringify(t));var i=this;if(t.state){var n=t.state;if(!n.devices||!n.devices.length)return void e(new Error("invalid state item, no devices"));if(!n.data||!n.data.length)return void e(new Error("invalid state item, no data"));var o=0,cb=function cb(t,a){if(i._logger.log("trace","check state of "+o+"th device "+(t?"failed:"+t.message:"result:"+JSON.stringify(a))),t)e(t);else if(a){for(var c=!1,r=0;r<n.data.length;r++){var s=n.data[r];if(c=commandman.commandHandlerV6.matchDeviceState(a,s))break;}c?++o<n.devices.length?(i._logger.log("trace","check state of "+o+"th device: "+JSON.stringify(n.devices[o])),commandman.commandHandlerV6.getDeviceStatesWithStateInfo(n.devices[o],cb)):e(null,!0):e(null,!1);}else e(null,!1);};this._logger.log("trace","check state of "+o+"th device: "+JSON.stringify(n.devices[o])),commandman.commandHandlerV6.getDeviceStatesWithStateInfo(n.devices[o],cb);}else if(t.time){var a=require("x.hub.rule.js").RuleManager.Util,c=a.getMomentNow();if(!a.matchDate(c,t.time))return void e(null,!1);var r=!0,s=null,l=null;if(t.time.from&&(l=a.getAstro(c),(s="sun"==t.time.from.substr(0,3)?a.calculateAstroTarget(c,l[0],l[1],t.time.from):a.calculateTimeTarget(c,t.time.from))&&c.isBefore(s)&&(r=!1)),!r)return void e(null,!1);t.time.until&&(l=a.getAstro(c),(s="sun"==t.time.until.substr(0,3)?a.calculateAstroTarget(c,l[0],l[1],t.time.until):a.calculateTimeTarget(c,t.time.until))&&c.isAfter(s)&&(r=!1)),e(null,r);}else e(new Error("invalid state item"));},Action.prototype._doNestedAction=function(t,e,i){this._nestedAction=new Action(t,e,{_onActionFinish:function _onActionFinish(){}}),this._nestedAction._actions=e,this._nestedAction._callback=i,this._nestedAction.run();};var ActionPool=function ActionPool(){this._pool=[],this._count=0;};ActionPool.prototype.runAction=function(t,e,i){if(e){this._count++,this._count>65535&&(this._count=1);var n=new Action(t,this._count,this);Array.isArray(e)?n._actions=e:n._actions=[e],n._callback=i,this._pool.push(n),n.run();}else i&&i();},ActionPool.prototype.cancelAction=function(t){this._pool=this._pool.filter(function(e){return!e||e.getId()!=t||(e.cancel(),!1);});},ActionPool.prototype.isActionRunning=function(t){for(var e=0;e<this._pool.length;e++){var i=this._pool[e];if(i&&i.getId()==t)return!0;}return!1;},ActionPool.prototype._onActionFinish=function(t){var e=this._pool.indexOf(t);-1!=e&&this._pool.splice(e,1);};var AM=function AM(){this._logger=require("x.logger.js").getLogger("x.hub.action.ActionManager"),this._dataFolder=null,this._actions=null,this._actionPool=new ActionPool(this),this._writing=!1,this._writeCallbacks=[];};return AM.FILE_NAME="action.json",AM.prototype.init=function(t,e){this._logger.log("info","init action manager"),this._dataFolder=t.getUserRootDataPath(),this._loadActions(function(t){e&&e(t);});},AM.prototype.getActions=function(){return this._actions;},AM.prototype.getAction=function(t){return this._actions?this._actions[t]:null;},AM.prototype.setAction=function(t,e,i){null!=t&&null!=t?(e?this._actions[t]=e:delete this._actions[t],this._writeActions(function(t){i&&i(t,e);})):i&&i(new Error("invalid action id"));},AM.prototype.executeActionWithId=function(t,e){var i=this.getAction(t);if(i){var n="act:"+t;this._actionPool.runAction(n,i,e);}else e&&e(new Error("no such action "+t));},AM.prototype.executeAction=function(t,e,i){if(this._actionPool.isActionRunning(t))return this._logger.log("trace","action ("+t+") is already running"),void(i&&i());this._actionPool.runAction(t,e,i);},AM.prototype.executeActionSingelton=function(t,e,i){this._actionPool.cancelAction(t),this._actionPool.runAction(t,e,i);},AM.prototype._loadActions=function(t){var e=require("fs-extra"),i=this._getFile(),n=this;e.ensureFile(i,function(e){e?t(e):n._loadFile(function(e,i){e?t(e):(n._actions=i||{},t());});});},AM.prototype._writeActions=function(t){if(t&&-1==this._writeCallbacks.indexOf(t)&&this._writeCallbacks.push(t),!this._writing&&this._writeCallbacks.length){this._writing=!0;var e=this._writeCallbacks;this._writeCallbacks=[];var i=this;this._writeFile(this._actions,function(t){i._writing=!1,e.forEach(function(e){try{e&&e(t);}catch(t){}}),i._writeActions();});}},AM.prototype._getFile=function(){return require("path").resolve(this._dataFolder,AM.FILE_NAME);},AM.prototype._loadFile=function(t){var e=require("fs"),i=this._getFile();e.readFile(i,"utf8",function(e,i){if(e)t(e);else if(i)try{var n=JSON.parse(i);t(null,n);}catch(e){t(null,{});}else t(null,{});});},AM.prototype._writeFile=function(t,e){var i=require("fs"),n=this._getFile();i.writeFile(n,JSON.stringify(t,null,2),function(t){e&&e(t);});},AM.Action=Action,AM;}(),x.hub.action.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.action.Handler"),this._actionManager=new x.hub.action.ActionManager();};return Handler.prototype.ActionManager=x.hub.action.ActionManager,Handler.prototype.init=function(t,e,i){"CA"==global.HARDWARE_VERSION&&this._initHttpApi(t),this._actionManager.init(e,function(t){t&&i(t);});},Handler.prototype.getActionManager=function(){return this._actionManager;},Handler.prototype._initHttpApi=function(){var t=this,e=require("x.hub.js").getServer();e.addRoute("/api/actions",{method:"GET"},function(e,i,n){var o=t._actionManager.getActions();i.json({XC_SUC:o||{}});}),e.addRoute("/api/action",{method:"GET"},function(e,i,n){var o=e.query?e.query.id:null;t._actionManager.executeActionWithId(o,function(t){t?i.json({XC_ERR:{code:"000101",msg:"failed to execute action "+o+":"+t.message}}):i.json({XC_SUC:{}});});}),e.addRoute("/data/act/",{method:"GET"},function(e,i,n){var o=e.path.substr(10),a=t._actionManager.getAction(o);a?i.json({XC_SUC:a}):i.json({XC_ERR:{code:"000101",msg:"failed to open file"}});}),e.addRoute("/data/act/",{method:"POST"},function(e,i){var n=e.path.substr(10);try{var o=e.json;t._actionManager.setAction(n,o,function(t,n){t?i.json({XC_ERR:{code:"000101",msg:"failed to set action:"+t.message}}):n?i.json({XC_SUC:{bytes:e.size}}):i.json({XC_SUC:{bytes:0}});});}catch(t){i.json({XC_ERR:{code:"000101",msg:"failed to set action:"+t.message}});}});},Handler;}(),module.exports=new x.hub.action.Handler();