function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}require("x.core.js");var hubLogger=require("x.logger.js").getLogger("x.hub");var x=x||{};x.hub=x.hub||{},x.hub.Dispatcher=function(){var Dispatcher=function Dispatcher(e){this._expressApp=e,this._routes=[];};return Dispatcher.prototype.add=function(e,t,r){if(!e||!r)throw new Error("invalid arguments");this._routes.push({path:e,opts:t,callback:r});},Dispatcher.prototype.doRequest=function(e,t,r,o){var s=this,_iterate=function _iterate(e,t,r,n){s._findRoute(e,t,function(e,s){e?e.callback(r,n,function(){_iterate(s+1,t,r,n);}):o();});};_iterate(0,e,t,r);},Dispatcher.prototype._findRoute=function(e,t,r){for(;e<this._routes.length;e++){var o=this._routes[e];if(o&&0==o.path.indexOf(t))return void r(o,e);}r(null,-1);},Dispatcher.prototype.init=function(){var e=this;this._expressApp.use("/",function(t,r,o){var s=t.path;e.doRequest(s,t,r,o);});},Dispatcher;}(),x.hub.Auth=function(){var Auth=function Auth(){};return Auth.prototype.auth=function(e,t){if(!t||!t.pwd)return!0;if(!e.query.at&&e.query.auth){var r=require("x.crypt.js");e.query.at=r.MD5(unescape(encodeURI(e.query.auth+"_SALT!")));}return!(!e.query.at||e.query.at!=t.pwd)||!(!e.headers||!e.headers.authorization)&&this._checkAuthHeader(e.headers.authorization,t);},Auth.prototype._checkAuthHeader=function(e,t){if(!e)return!1;if("Basic "==e.substr(0,6)){var r=e.substr(6).trim(),o=new Buffer(r,"base64").toString().split(":"),s=(o[0],o[1]);return!!s&&require("x.crypt.js").MD5(unescape(encodeURI(s+"_SALT!")))==t.pwd;}return!1;},Auth;}(),x.hub.Error=function(){var E=function E(e,t){Error.call(this,e),this.code=t||"000000";};return require("util").inherits(E,Error),E;}(),x.hub.Dispatcher2=function(){var Dispatcher=function Dispatcher(e,t){this._expressApp=e,this._server=t,this._routes=[];};return Dispatcher.prototype.add=function(e,t,r){if(!e)throw new Error("invalid arguments");if(t&&"function"==typeof t&&!r&&(r=t,t=null),!r)throw new Error("invalid arguments");this._routes.push({path:e,opts:t,callback:r});},Dispatcher.prototype.doRequest=function(e,t,r){var o=this,_iterate=function _iterate(e,t,s){o._findRoute(e,t,function(e,n){if(e)try{o._doRoute(e,t,s,function(){_iterate(n+1,t,s);});}catch(e){s.json({XC_ERR:{code:"000000",msg:e.message}});}else r();});};_iterate(0,e,t);},Dispatcher.prototype._doRoute=function(e,t,r,o){var s=this._server._auth,n={pwd:this._server._pwd};!function(e,t,r,o){if("cloud"!=t.source){if(e.opts&&"stream"==e.opts.body)o();else if("POST"!=t.method&&"PUT"!=t.method||"application/octet-stream"==t.header("content-type"))o();else{var s=new Buffer([]);t.on("data",function(e){s=Buffer.concat([s,e]);}),t.on("end",function(){if(t.size=s.length,t.body=s.toString("utf8"),t.json=null,!e.opts||!e.opts.body||"json"==e.opts.body)try{t.json=JSON.parse(s);}catch(e){}o();});}}else o();}(e,t,0,function(){!function(e,t,r,o,s,n){if("cloud"==t.source)return t.hasValidAuth=!0,void n();var a=o.auth(t,s);t.hasValidAuth=a,e.opts&&0==e.opts.auth||a?n():r.json({XC_ERR:{code:"000007",msg:"access denied"}});}(e,t,r,s,n,function(){e.callback(t,r,function(){o();});});});},Dispatcher.prototype._findRoute=function(e,t,r){for(var o,s,_sourceMatch=function _sourceMatch(e,t){return 0!=((e="webserver"==e?1:"cloud"==e?2:3)&t);},n=t.path;e<this._routes.length;e++){var a=this._routes[e];if(a&&a.path&&(o=n,("/"!=(s=a.path)||o==s)&&(s.length<=o.length&&o.substr(0,s.length)==s||"*"==s))){if(a.opts){if(a.opts.method&&t.method&&t.method.toLowerCase()!=a.opts.method.toLowerCase())continue;if(a.opts.source&&!_sourceMatch(t.source,a.opts.source))continue;}return void r(a,e);}}r(null,-1);},Dispatcher.prototype.init=function(){var e=this;this._expressApp.use("/",function(t,r,o){e.doRequest(t,r,o);});},Dispatcher;}(),x.hub.Auth2=function(){var Auth=function Auth(){};return Auth.prototype.auth=function(e,t){if(!t||!t.pwd)return!0;var r=require("x.crypt.js");if(e.query){if(e.query.at){if(e.query.at==t.pwd)return delete e.query.at,!0;delete e.query.at;}if(e.query.auth){if(r.MD5(unescape(encodeURI(e.query.auth+"_SALT!")))==t.pwd)return delete e.query.auth,!0;delete e.query.auth;}}if(e.json){if(e.json.at){if(e.json.at==t.pwd)return delete e.json.at,!0;delete e.json.at;}if(e.json.auth){if(r.MD5(unescape(encodeURI(e.json.auth+"_SALT!")))==t.pwd)return delete e.json.auth,!0;delete e.json.auth;}}return!(!e.headers||!e.headers.authorization)&&this._checkAuthHeader(e.headers.authorization,t);},Auth.prototype._checkAuthHeader=function(e,t){if(!e)return!1;if("Basic "==e.substr(0,6)){var r=e.substr(6).trim(),o=new Buffer(r,"base64").toString().split(":"),s=(o[0],o[1]);return!!s&&require("x.crypt.js").MD5(unescape(encodeURI(s+"_SALT!")))==t.pwd;}return!1;},Auth;}(),x.hub.Server=function(e,t,r){this._logger=require("x.logger.js").getLogger("x.hub.Server"),this.HWV="EB",this.VERSION="0.0.0",this.DEFAULT_NAME="XHUB",this.VID="FFFF",this.hostType="A20",this._port=null,this._stmPort=e,this._hmPort=t,this._signalPin=r,this._stmUSB=null,this._hmSerial=null,this._cloudConnect=null,this._pwd="",this._onSerialEvent=null,this._onCustomSerialEvent=null;var o=require("express");this._app=o(),this._dispatcher=new x.hub.Dispatcher(this._app);var s=require("http");this._httpserver=s.createServer(this._app),this._commandFunctions={},this._cmdFunctions={},this._logger={log:function log(){}};try{var n=require("x.logger.js");n&&(this._logger=n.getLogger("x.hub.Server"));var a=require("x.hub.eventbus.js");a&&(a.on("udpevent",this.onUdpEvt.bind(this)),a.on("status",this.onStatusEvt.bind(this)));}catch(e){}if(localStorage){"EA"==global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.timezone")||localStorage.setItem("x.hub.Server.timezone","8C")),"CA"!=global.HARDWARE_VERSION&&(localStorage.getItem("x.hub.Server.geo.lat")||localStorage.setItem("x.hub.Server.geo.lat","1392"),localStorage.getItem("x.hub.Server.geo.long")||localStorage.setItem("x.hub.Server.geo.long","035C")),localStorage.getItem("x.hub.Server.pwd")&&(this._pwd=localStorage.getItem("x.hub.Server.pwd"));}this._auth=new x.hub.Auth(),this._httpsServer=null,this._enableHttps();},x.hub.Server.prototype.auth=function(e){return this._auth.auth(e,{pwd:this._pwd});},x.hub.Server.prototype.getNetworkSettings=function(e){if("A20"==this.hostType){require("x.hub.v5.js").Native.getIPData(function(t){e&&e(null,t);});}else{var t={},r=require("os");if(r&&r.networkInterfaces){var o=r.networkInterfaces();for(var s in o){t[s]||(t[s]=[]);for(var n=o[s],a=0;a<n.length;a++){if("IPv4"==n[a].family&&!1===n[a].internal){var i=this._getIPData(n[a]);t[s].push(i);}}}}e&&e(null,t);}},x.hub.Server.prototype._getIPData=function(e){var t={};t.IP=e.address,t.PT=this._port,t.SN="255.255.255.0",e.netmask&&(t.SN=e.netmask),t.GW="0.0.0.0";var r=null;try{r=require("netroute");}catch(e){}if(r){var o=r.getInfo();if(o&&o.IPv4)for(var s=0;s<o.IPv4.length;s++){if("0.0.0.0"==o.IPv4[s].destination){t.GW=o.IPv4[s].gateway;break;}}}t.DNS="0.0.0.0";var n=require("dns");if(n&&n.getServers){var a=n.getServers();a&&a.length>0&&(t.DNS=a[0]);}return t.MAC="00-00-00-00-00-00",e.mac&&(t.MAC=e.mac.replace(/:/g,"-")),t;},x.hub.Server.prototype.addRoute=function(e,t,r){return"function"==typeof t&&(r=t,t=null),this._dispatcher.add(e,t,r);},x.hub.Server.prototype.start=function(e){if(this._port=e,this._name=this.DEFAULT_NAME,localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name")),this._vid=this.VID,localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid")),this._startup=Math.round(new Date().getTime()/1e3),this._startServer(),this._startUDPServer(1901),this._stmPort){var t=this,r=require("x.hub.v5.js");this._stmUSB=new r.USBSerial(this._stmPort,this._signalPin),this._stmUSB.on("data",function(e){if(e&&e.type&&e.data)if(80==e.type&&t._onSerialEvent){var r=e.data.toString(),o=null;r.length>8&&"{XC_EVT}"==r.substr(0,8)?(r=r.substr(8),o="EVT"):r.length>4&&"EVT:"==r.substr(0,4)?(r=r.substr(4),o="EVT"):r.length>4&&"STA:"==r.substr(0,4)&&(r=r.substr(4),o="STA"),t._onSerialEvent(r,o);}else 82==e.type&&t._onCustomSerialEvent&&t._onCustomSerialEvent(e.data);});}this._addModulesRoutes(),this._startSecureServer();},x.hub.Server.prototype.startSTM=function(e){if(this._stmPort){var t=this,r=require("x.hub.v5.js");this._stmUSB=new r.USBSerial(this._stmPort,this._signalPin,e),this._stmUSB.on("data",function(e){if(e&&e.type&&e.data)if(80==e.type&&t._onSerialEvent){var r=e.data.toString(),o=null;r.length>8&&"{XC_EVT}"==r.substr(0,8)?(r=r.substr(8),o="EVT"):r.length>4&&"EVT:"==r.substr(0,4)?(r=r.substr(4),o="EVT"):r.length>4&&"STA:"==r.substr(0,4)&&(r=r.substr(4),o="STA"),t._onSerialEvent(r,o);}else 82==e.type&&t._onCustomSerialEvent&&t._onCustomSerialEvent(e.data);});}},x.hub.Server.prototype.startWebserver=function(e,t){this._port=e,this._name=this.DEFAULT_NAME,localStorage&&localStorage.getItem("x.hub.Server.name")&&(this._name=localStorage.getItem("x.hub.Server.name")),this._vid=this.VID,localStorage&&localStorage.getItem("x.hub.Server.vid")&&(this._vid=localStorage.getItem("x.hub.Server.vid")),this._startup=Math.round(new Date().getTime()/1e3);var r=0;this._startServer(function(){hubLogger.log("info","************* ++++++++++++++++++ **************"),hubLogger.log("info","******* http server ("+e+") started ********"),hubLogger.log("info","************* ++++++++++++++++++ **************"),2==++r&&t&&t();}),this._startUDPServer(1901,function(){hubLogger.log("info","************* ++++++++++++++++++ **************"),hubLogger.log("info","********** udp server (1901) started **********"),hubLogger.log("info","************* ++++++++++++++++++ **************"),2==++r&&t&&t();}),this._addModulesRoutes(),this._startSecureServer();},x.hub.Server.prototype.on=function(e,t){"serialevent"==e?this._onSerialEvent=t:"customserialevent"==e&&(this._onCustomSerialEvent=t);},x.hub.Server.prototype._getServerFromReq=function(e){if(e.query.server)return e.query.server;var t=null;return e.ip?t=e.ip:e.connection.remoteAddress&&(t=e.connection.remoteAddress),t&&t.indexOf(":")>-1&&t.indexOf(".")>t.indexOf(":")?t=t.substr(t.lastIndexOf(":")+1):"::1"==t&&(t="localhost"),t;},x.hub.Server.prototype.enableCloudConnect=function(e){this._cloudConnect=e,e.init(this);},x.hub.Server.prototype.restart=function(e){XC.debugf("RESTART!");var t=this;setTimeout(function(){"A20"==t.hostType?require("x.hub.v5.js").Native.reboot():process.exit(0);},e);},x.hub.Server.prototype.resHasError=function(e){var t=null;try{t=JSON.parse(e);}catch(e){t=null;}return!(!t||!t.XC_ERR);},x.hub.Server.prototype._doSTMCommandRequest=function(e,t,r){if(this._stmUSB&&e&&e.indexOf("?")>-1){e=e.substr(e.indexOf("?")+1);this._stmUSB.sendCommand(16,e,function(o){if(o&&o.data?XC.debugf(e+" --\x3e "+o.data.toString()):o&&o.error?XC.debugf(e+" --\x3e FAIL:"+o.error):XC.debugf(e+" --\x3e FAIL"),o&&o.data){var s="XC_SUC";o.error&&(s="XC_ERR"),r(t?"{"+s+"}"+o.data.toString():'{"'+s+'": '+o.data.toString()+"}");}else t?r("{XC_ERR}internal error"):o&&o.error?r(JSON.stringify({XC_ERR:{code:"000000",msg:o.error}})):r('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});}else r(t?"{XC_ERR}invalid request":'{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');},x.hub.Server.prototype.doSTMCommand=function(e,t){this._doSTMCommandRequest("/cmd?"+e,!1,function(e){var r=null;try{r=JSON.parse(e);}catch(e){r=null;}t&&t(r);});},x.hub.Server.prototype.doSTMRequest=function(e,t,r){if(this._stmUSB){this._stmUSB.sendCommand(e,t,function(e){e?e.error?r(null):r(e.data):r(null);});}else r(null);},x.hub.Server.prototype.setCommandFunc=function(e,t){this._commandFunctions[e.toLowerCase()]=t;},x.hub.Server.prototype.setCmdFunc=function(e,t){this._cmdFunctions[e.toLowerCase()]=t;},x.hub.Server.prototype.doRequest=function(e,t,r){var o=require("os");if("/"==e){var s="<!DOCTYPE html>\n";s+='<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n',s+="<title>"+String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>\n",s+='<script>function setHMconfigRef() {var hmconfig = document.getElementById("hmconfig"); if(hmconfig){hmconfig.href = window.location.protocol + "//" + window.location.hostname + ":81/";}}<\/script>\n',s+="</head>\n",s+='<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setHMconfigRef()">\n',s+='<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n',s+="<tbody>\n",s+='<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;">',s+='<th colspan="3">'+this._name+"</th>\n",s+="</tr>\n",s+='<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n';var n='<tr style="height: 30px;"><td>&nbsp;</td><td>',a=":</td><td><b>",i="</b></td></tr>\n";s+=n+"device"+a+this.DEFAULT_NAME+i,s+=n+"version"+a+this.HWV+" ("+this.VERSION+")"+i;var u=Math.round(new Date().getTime()/1e3)-this._startup,c=Math.floor(u/86400);u-=60*c*60*24;var l=Math.floor(u/3600);u-=60*l*60;var d=Math.floor(u/60);s+=n+"uptime"+a+c+"d "+l+"h "+d+"m "+(u-=60*d)+"s"+i,o&&o.freemem&&(s+=n+"memory"+a+Math.floor(o.freemem()/1e3)+i),s+='<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n',s+='<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2018 mediola - connected living AG</td></tr>\n',r(s+="</tbody>\n</table>\n</body>\n</html>");}else if("/info"==e){var h={XC_SUC:{name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round(new Date().getTime()/1e3)}},g="8C",p="1392",f="035C";if(localStorage.getItem("x.hub.Server.timezone")&&(g=localStorage.getItem("x.hub.Server.timezone")),localStorage.getItem("x.hub.Server.geo.lat")&&(p=localStorage.getItem("x.hub.Server.geo.lat")),localStorage.getItem("x.hub.Server.geo.long")&&(f=localStorage.getItem("x.hub.Server.geo.long")),h.XC_SUC.loc=(g+p+f).toUpperCase(),localStorage.getItem("x.hub.v5.config")&&(h.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config")),localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort"))h.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort");else{var m=require("x.hub.v5.js").CloudConnect;h.XC_SUC.server=m.prototype.CLOUD_SERVER+":"+m.prototype.CLOUD_SERVER_PORT;}localStorage.getItem("x.hub.v5.SID")&&(h.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID")),localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(h.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER")),localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(h.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")),localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(h.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")),o&&o.freemem&&(h.XC_SUC.mem=Math.floor(o.freemem()/1e3));try{if(global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")){var _=require("x.hub.m.enocean.js");if(_){var y=_.getEnoceanInfo();h.XC_SUC.enocean=y;}}}catch(e){}if("A20"==this.hostType){h.XC_SUC.SAFE_MODE=global.SAFE_MODE;var S=require("x.hub.v5.js"),fnSetIfaceData=function fnSetIfaceData(e){return{ip:e.IP,sn:e.SN,gw:e.GW,dhcp:e.DHCP,dns:e.DNS,mac:e.MAC,ntp:e.NTP};};S.Native.getIPData(function(e){var t=null,o=null;Array.isArray(e.eth0)&&(t=fnSetIfaceData(e.eth0[0])),Array.isArray(e.wlan0)&&(o=fnSetIfaceData(e.wlan0[0]));var s=t||o;for(var n in s){h.XC_SUC[n]=s[n];}if(h.XC_SUC.primary_net=s===t?"eth0":"wlan0",h.XC_SUC.cfg&&s){var a=parseInt(h.XC_SUC.cfg,16);!0===s.dhcp?a&=-129:a|=128,h.XC_SUC.cfg=a.toString(16),h.XC_SUC.cfg.length<2&&(h.XC_SUC.cfg="0"+h.XC_SUC.cfg),h.XC_SUC.cfg=h.XC_SUC.cfg.toUpperCase();}s!=o&&o&&(h.XC_SUC.wlan0=o),r(JSON.stringify(h));});}else{require("dgram");if(o&&o.networkInterfaces){var v=o.networkInterfaces();for(var C in v){if(v.hasOwnProperty(C))for(var q=v[C],b=0;b<q.length;b++){if("IPv4"==q[b].family&&!1===q[b].internal){var R=this._getIPData(q[b]),X=null;if(t&&t.headers&&t.headers.host){var w=(X=t.headers.host).indexOf(":");-1!=w&&(X=X.substr(0,w));}!X||X!=R.IP&&"localhost"!=X&&"127.0.0.1"!=X||(h.XC_SUC.ip=R.IP,h.XC_SUC.sn=R.SN,h.XC_SUC.gw=R.GW,h.XC_SUC.dns=R.DNS,h.XC_SUC.mac=R.MAC);}}}r(JSON.stringify(h));}}}else if("/set"==e){if(t.query.rgb&&6==t.query.rgb.length)(S=require("x.hub.v5.js")).setRGBColor(t.query.rgb),r('{"XC_SUC": {}}');else r('{"XC_SUC": {}}');}else if("/cmd"==e){var I=t.query.XC_FNC;if(I&&this._cmdFunctions[I.toLowerCase()]){var T=this;this._cmdFunctions[I.toLowerCase()](t,function(e){e?r(e):"POST"==t.method?T._doSTMCommandRequest(t,!1,r):T._doSTMCommandRequest(t.url,!1,r);});}else"POST"==t.method?this._doSTMCommandRequest(t,!1,r):this._doSTMCommandRequest(t.url,!1,r);}else if("/executeCommand"==e){if(require("x.logger.js").getLogger("GeneralExecuteCommand API").log("trace","general execute command:"+JSON.stringify(t.query)),!t.query||!t.query.data)return void r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var j=t.query.type;(U=t.query.data).device&&!U.device.sys&&(U.device.sys=j),U.gateway&&!U.gateway.sys&&(U.gateway.sys=j),(N=require("x.hub.commandman.js")).commandHandler.executeCommand(U.device,U.gateway,U.command,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):r('{"XC_SUC":{}}');});}else if("/getStates"==e){if(require("x.logger.js").getLogger("GeneralGetStates API").log("trace","general get states:"+JSON.stringify(t.query)),!t.query||!t.query.data)return void r('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var U;j=t.query.type;(U=t.query.data).device&&!U.device.sys&&(U.device.sys=j),U.gateway&&!U.gateway.sys&&(U.gateway.sys=j);var N=require("x.hub.commandman.js");U.deviceList?N.commandHandler.getMultiStatesLegacy(U.device,U.gateway,U.deviceList,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?r(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):r('{"XC_SUC":{}}');}):N.commandHandler.getState(U.device,U.gateway,U.status,function(e){e.error?r('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?r(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):r('{"XC_SUC":{}}');});}else{var k=r;s={json:function json(e){k&&(k(JSON.stringify(e)),k=null);},send:function send(e){k&&(k(e),k=null);},status:function status(){},end:function end(){k&&(k(),k=null);}};if(this.HWV&&"CA"==this.HWV)return void this._dispatcher.doRequest(t,s,function(){k&&(k('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),k=null);});this._dispatcher.doRequest(e,t,s,function(){k&&(k('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'),k=null);});}},x.hub.Server.prototype._preHandleRequest=function(e,t,r){if("POST"==e.method&&"application/octet-stream"!=e.header("content-type"))if(e.json){if(e.query&&Object.keys(e.query).length>0)if(this.auth(e))return e.query=e.json,void r();e.query=e.json;}else if("text/plain"!=e.header("content-type")&&"text/xml"!=e.header("content-type")&&"application/xml"!=e.header("content-type"))return void t.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');this.auth(e)?r():t.send('{"XC_ERR":{"code":"000007", "msg":"access denied"}}');},x.hub.Server.prototype._startServer=function(e){this._app.set("case sensitive routing",!0);var t=this;this._app.use(function(e,r,o){if(r.header("Access-Control-Allow-Origin","*"),r.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization"),require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","REQ:"+e.url),"/"!=require("url").parse(e.url).pathname){if("POST"==e.method&&"application/octet-stream"!=e.header("content-type")){var s=new Buffer([]);e.on("data",function(e){s=Buffer.concat([s,e]);}),e.on("end",function(){e.body=s.toString("utf8"),e.json=null;try{e.json=JSON.parse(s);}catch(e){}t._preHandleRequest(e,r,o);});}else t._preHandleRequest(e,r,o);}else t.doRequest("/",e,function(e){r.send(e);});}),this._app.get("/info",function(e,r){try{t.doRequest("/info",e,function(e){r.send(e);});}catch(e){hubLogger.log("error",e);}}),this._app.get("/set",function(e,r){t.doRequest("/set",e,function(e){r.send(e);});}),this._app.get("/cmd",function(e,r){t.doRequest("/cmd",e,function(e){r.send(e);});}),this._app.post("/cmd",function(e,r){t.doRequest("/cmd",e,function(e){r.send(e);});}),this._app.get("/command",function(e,r){XC.debugf("command: "+e.url);var o=e.query.XC_FNC;o&&t._commandFunctions[o.toLowerCase()]?t._commandFunctions[o.toLowerCase()](e,r):t._doSTMCommandRequest(e.url,!0,function(e){r.send(e);});}),this._app.post("/executeCommand",function(e,r){t.doRequest("/executeCommand",e,function(e){r.send(e);});}),this._app.post("/getStates",function(e,r){t.doRequest("/getStates",e,function(e){r.send(e);});}),this._app.get("/config",function(e,r){var o,s,n,a=!0,i=!1;if(e.query.name&&e.query.name.length>0&&(t._name=e.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",e.query.name)),e.query.vid&&e.query.vid.length>0&&(t._vid=e.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",e.query.vid)),e.query.pwd||""==e.query.pwd){var u=require("x.crypt.js");0===e.query.pwd.length?(t._pwd="",e.query.cloud=0):t._pwd=u.MD5(unescape(encodeURI(e.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",t._pwd),i=!0;}e.query.loc&&(2==e.query.loc.length?o=e.query.loc:8==e.query.loc.length?(s=e.query.loc.substr(0,4),n=e.query.loc.substr(4)):10==e.query.loc.length&&(o=e.query.loc.substr(0,2),s=e.query.loc.substr(2,4),n=e.query.loc.substr(6)),o&&localStorage&&localStorage.setItem("x.hub.Server.timezone",o),s&&localStorage&&localStorage.setItem("x.hub.Server.geo.lat",s),n&&localStorage&&localStorage.setItem("x.hub.Server.geo.long",n),"A1"==t.HWV?(a=!1,t._platform.setLocation(s,n,function(e){e?r.json({XC_ERR:{code:"000000",msg:"set coordinate failed: "+e.message}}):t._platform.setTZData(o,function(e){e?r.json({XC_ERR:{code:"000000",msg:"set timezone failed: "+e.message}}):r.json({XC_SUC:{}});});})):require("x.hub.eventbus.js").emit("locationchange",{timezone:o,lat:s,"long":n}));e.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",e.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",e.query.neoserver));e.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",e.query.ccu_init_state),require("x.hub.eventbus.js").emit("x.hub.m.hm.CCU_INIT_STATE",e.query.ccu_init_state));if(e.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",e.query.disable_st_states),"A20"==t.hostType||"CA"==t.HWV){var c={};if(e.query.ip&&e.query.sn&&e.query.gw&&e.query.dns&&(c.IP=e.query.ip,c.SN=e.query.sn,c.GW=e.query.gw,c.DNS=e.query.dns,c.DHCP=!1),e.query.dhcp&&1==e.query.dhcp&&(c={DHCP:!0}),e.query.ntp&&(c.NTP=e.query.ntp),e.query.mac&&(c.MAC=e.query.mac),Object.keys(c).length>0)if("EA"==t.HWV)a=!1,require("x.hub.v5.js").Native.setIPData(t,c,function(e){e?(r.send('{"XC_SUC":{}}'),t.restart(1e3)):r.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});else if("CA"==t.HWV){a=!1,require("x.hub.v6.js").setIPData(c,function(e,o){e?r.json({XC_ERR:{code:"000000",msg:e.message}}):(r.json({XC_SUC:{}}),o&&t.restart(1e3));});}}if(e.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",e.query.sid),i=!0),e.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",e.query.ckey),i=!0),e.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",e.query.cserver),i=!0),e.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",e.query.cport),i=!0),e.query.cloud&&localStorage){var l=255;localStorage.getItem("x.hub.v5.config")&&(l=parseInt(localStorage.getItem("x.hub.v5.config"),16)),1==e.query.cloud?l&=-65:l|=64;var d=l.toString(16);d.length<2&&(d="0"+d),localStorage.setItem("x.hub.v5.config",d.toUpperCase()),i=!0;}if("A20"==t.hostType&&e.query.year&&e.query.month&&e.query.date&&e.query.hour&&e.query.minute){a=!1;var h=parseInt(e.query.year),g=parseInt(e.query.month),p=parseInt(e.query.date),f=parseInt(e.query.hour),m=parseInt(e.query.minute);if(isNaN(h)||h<1970||h>9999)return void r.send('{"XC_ERR":{"code":"000000", "msg":"year invalid"}}');if(isNaN(g)||g<1||g>12)return void r.send('{"XC_ERR":{"code":"000000", "msg":"month invalid"}}');if(isNaN(p)||p<1||p>31)return void r.send('{"XC_ERR":{"code":"000000", "date":"year invalid"}}');if(isNaN(f)||f<0||f>23)return void r.send('{"XC_ERR":{"code":"000000", "date":"hour invalid"}}');if(isNaN(m)||m<0||m>59)return void r.send('{"XC_ERR":{"code":"000000", "date":"minute invalid"}}');require("x.hub.v5.js").Native.setDateTime(h,g,p,f,m,function(e){e?(require("x.hub.eventbus.js").emit("timechange",{}),r.send('{"XC_SUC":{}}')):r.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});}i&&t._cloudConnect&&t._cloudConnect.init(t),a&&r.send('{"XC_SUC": {}}');}),this._app.get("/getKey",function(e,t){var r=require("x.hub.v5.js"),o={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(o.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),r.getPublicKey(function(e){o.XC_SUC.key=e,t.end(JSON.stringify(o));});}),this._app.get("/peripheral",function(e,t){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(e){e?e.error?t.end(JSON.stringify({XC_ERR:{code:"000001",msg:e.error}})):e.data?t.end(JSON.stringify({XC_SUC:e.data})):t.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):t.end(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}));});}),this._hmPort?this._app.get("/hmtest",function(e,r){t._doHMTestRequest(e.query,r);}):"A20"==this.hostType&&this._app.get("/hmtest",function(e,t){require("x.hub.v5.js").Native.checkHMSerial(function(e){"OK"==e?t.send('{"XC_SUC":{}}'):t.send('{"XC_ERR":{"msg":"'+e+'"}}');});}),this._app.get("/update",function(e,r){var o=t._getServerFromReq(e),s="80",n=null;(e.query.port&&(s=e.query.port),e.query.url&&(n=e.query.url),e.query.server&&(o=e.query.server),o&&s&&n)?"A20"==t.hostType?require("x.hub.v5.js").Native.updateFirmware(o,s,n,function(e){r.send(e),t.resHasError(e)||t.restart(1e3);}):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}'):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.get("/updateST",function(e,r){if("CA"!=global.HARDWARE_VERSION){var o=!1,s=t._getServerFromReq(e),n="80",a=null;if(e.query.live&&"0"!=e.query.live&&"false"!=e.query.live&&(o=!0),e.query.port&&(n=e.query.port),e.query.url&&(a=e.query.url),e.query.server&&(s=e.query.server),s&&n&&a){if("A20"==t.hostType){var i=require("x.hub.v5.js");o?i.Native.updateSTFirmware(s,n,a,r):i.Native.updateSTFirmware(s,n,a,null,function(e){r.send(e);});}else o?r.send("ERROR."):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}else o?r.send("ERROR."):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}else t._platform.updateSTM(null,r,function(){});}),this._app.post("/updateST",function(e,r){"CA"!=global.HARDWARE_VERSION?r.json({XC_ERR:{code:"000001",msg:"invalid request"}}):t._platform.updateSTM(e,r,function(){});}),this._app.post("/updateV5PFW",function(e,r){require("x.hub.v5.js").Native.updateV5PFirmware(e,r,function(e){t.resHasError(e)||t.restart(1e3);});}),this._app.get("/backup",function(e,r){var o=require("x.crypt.js"),s=require("x.hub.v5.js");if("A20"==t.hostType&&e.query["native"]&&"0"!=e.query["native"]&&"false"!=e.query["native"])s.Native.backup(t,r);else{var n=null;e.query.enc&&"0"!=e.query.enc&&"false"!=e.query.enc&&(e.query.at?n=e.query.at:e.query.auth&&(n=o.MD5(unescape(encodeURI(e.query.auth+"_SALT!"))))),s.backup(t,r,n);}}),this._app.get("/restore",function(e,r){var o=t._getServerFromReq(e),s="80",n=null;if(e.query.port&&(s=e.query.port),e.query.url&&(n=e.query.url),o&&s&&n){var a=require("x.hub.v5.js");if("A20"==t.hostType&&e.query["native"]&&"0"!=e.query["native"]&&"false"!=e.query["native"])a.Native.restore(t,"http://"+o+":"+s+n,function(e){r.send(e),t.resHasError(e)||t.restart(1e3);});else{var i=null;e.query.key?i=e.query.key:e.query.at?i=e.query.at:e.query.auth&&(i=crypt.MD5(unescape(encodeURI(e.query.auth+"_SALT!")))),a.restore(t,"http://"+o+":"+s+n,i,function(e){r.send(e),t.resHasError(e)||t.restart(1e3);});}}else r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.get("/getLogs",function(e,r){var o=require("x.hub.v5.js");"A20"==t.hostType?o.getLogs(r):"A1"==t.HWV?o.getNeoServerLogs(r):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.get("/clearLogs",function(e,r){var o=require("x.hub.v5.js");"A20"==t.hostType?o.clearLogs(function(){r.send('{"XC_SUC":{}}');}):r.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.get("/getPorts",function(e,t){require("x.hub.v5.js").getSerialPorts(function(e){t.send(e);});}),this._app.get("/reset",function(e,r){r.send('{"XC_SUC":{}}'),t.restart(1e3);}),this._app.get("/refurbish",function(e,r){require("x.hub.v5.js").Native.setIPData(t,{DHCP:!0},function(e){e?t._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){r.status(200).json({XC_SUC:{}});});}):r.send('{"XC_ERR":{"code":"000000", "msg":"enable dhcp failed"}}');});}),this._app.get("/resetST",function(e,r){"CA"==global.HARDWARE_VERSION?t._platform._stm.reset(function(e){e?r.json({XC_ERR:{msg:e.message}}):r.json({XC_SUC:{}});}):t._stmUSB.reset(function(){require("x.hub.v5.js").resetST(function(){r.status(200).json({XC_SUC:{}});});});}),this._app.get("/rebootST",function(e,r){"CA"==global.HARDWARE_VERSION?t._platform._stm.reboot(function(e){e?r.json({XC_ERR:{msg:e.message}}):r.json({XC_SUC:{}});}):t._stmUSB.reset(function(){require("x.hub.v5.js").rebootST(function(){r.status(200).json({XC_SUC:{}});});});}),this._app.get("/resetHM",function(e,r){require("x.hub.v5.js").Native.resetHM(function(e){e?(r.status(200).json({XC_SUC:{}}),t.restart(100)):r.status(200).json({XC_ERR:{code:"000000",message:"reset homematic failed"}});});}),this._app.get("/resetZwave",function(e,r){require("x.hub.v5.js").Native.resetZway(function(e){e?(r.status(200).json({XC_SUC:{}}),t.restart(100)):r.status(200).json({XC_ERR:{code:"000000",message:"reset zwave failed"}});});}),this._app.get("/resetZigbee",function(e,r){require("x.hub.v5.js").Native.resetZigbee(function(e){e?(r.status(200).json({XC_SUC:{}}),t.restart(100)):r.status(200).json({XC_ERR:{code:"000000",message:"reset zigbee failed"}});});}),this._app.get("/resetKNX",function(e,t){require("x.hub.m.knx.js").reset(function(e){e&&!e.error?t.status(200).json({XC_SUC:{}}):t.status(200).json({XC_ERR:{code:"000000",message:"reset knx failed"}});});}),this._app.get("/mountUSB",function(e,t){require("x.hub.v5.js").mountUSB(function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.get("/setBackupUSB",function(e,t){e.query.path?require("x.hub.v5.js").setBackupUsbPath(e.query.path,function(){t.status(200).json({XC_SUC:{}});}):t.status(500).json({XC_ERR:{code:"000000",msg:"no usb path"}});}),this._app.post("/backupDeviceXML",function(e,t){var r=e.body;require("x.hub.v5.js").saveDeviceXMLforBackup(r,function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.post("/backupMacrosXML",function(e,t){var r=e.body;require("x.hub.v5.js").saveMacrosXMLforBackup(r,function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.post("/backupIrcodesXML",function(e,t){var r=e.body;require("x.hub.v5.js").saveIrcodesXMLforBackup(r,function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.get("/backupLocal",function(e,r){var o=require("x.crypt.js"),s=require("x.hub.v5.js"),n=null;e.query.key&&(n=o.MD5(unescape(encodeURI(e.query.key+"_SALT!")))),s.backupLocal(t,n,function(e){e.error?r.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):r.status(200).json({XC_SUC:{file:e.data}});});}),this._app.get("/unmountUSB",function(e,t){require("x.hub.v5.js").unmountUSB(function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.get("/listUsbBackups",function(e,t){require("x.hub.v5.js").listUsbBackups(function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:e.data});});}),this._app.get("/deleteUsbBackup",function(e,t){var r=e.query.file;r?require("x.hub.v5.js").deleteBackup(r,function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});}):t.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}});}),this._app.get("/loadBackup",function(e,t){var r=require("x.hub.v5.js"),o=require("x.crypt.js"),s=e.query.file;if(s){var n=null;e.query.key&&(n=o.MD5(unescape(encodeURI(e.query.key+"_SALT!")))),r.loadBackup(s,n,function(e){e.error?t.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).json({XC_SUC:{}});});}else t.status(200).json({XC_ERR:{code:"000000",msg:"file name is null"}});}),this._app.get("/loadBackupDeviceXML",function(e,t){require("x.hub.v5.js").loadDeviceXML(function(e){e.error?t.status(400).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).end(e.data);});}),this._app.get("/loadBackupMacroXML",function(e,t){require("x.hub.v5.js").loadMacroXML(function(e){e.error?t.status(400).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).end(e.data);});}),this._app.get("/loadBackupIrcodesXML",function(e,t){require("x.hub.v5.js").loadIrcodesXML(function(e){e.error?t.status(400).json({XC_ERR:{code:"000000",msg:e.error.message}}):t.status(200).end(e.data);});}),this._app.get("/restoreLocal",function(e,r){require("x.hub.v5.js").restoreLocal(t,function(e){e.error?r.status(200).json({XC_ERR:{code:"000000",msg:e.error.message}}):(r.status(200).json({XC_SUC:{}}),t.restart(1e3));});}),this._app.get("/testReadOnly",function(e,t){require("x.hub.v5.js").testReadOnly(function(e){e?t.status(200).json({XC_SUC:{readonly:!0,message:e.message}}):t.status(200).json({XC_SUC:{readonly:!1}});});}),this._app.get("/fixReadOnly",function(e,t){require("x.hub.v5.js").fixReadOnly(t,function(e){e?t.status(200).json({XC_ERR:{code:"01001",message:e.message}}):t.status(200).json({XC_SUC:{}});});}),this._app.get("/scan",function(e,t){require("x.hub.v5.js").Native.scanWiFi(function(e,r){if(e)t.send(e.message);else if(r)return void t.send('{"XC_SUC":'+JSON.stringify(r)+"}");t.send('{"XC_ERR":{"msg":"Scanning wifis failed."}}');});}),this._app.get("/connect",function(e,t){e.query.ssid&&e.query.pwd?require("x.hub.v5.js").Native.connectWiFi(e.query.ssid,e.query.pwd,function(e){e?t.send('{"XC_SUC":{}}'):t.send('{"XC_ERR":{"msg":"failed to connect"}}');}):t.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.get("/configWLAN",function(e,t){var r={};(e.query.ip&&e.query.sn&&e.query.gw&&e.query.dns&&(r.IP=e.query.ip,r.SN=e.query.sn,r.GW=e.query.gw,r.DNS=e.query.dns,r.DHCP=!1),e.query.dhcp&&1==e.query.dhcp&&(r={DHCP:!0}),e.query.ntp&&(r.NTP=e.query.ntp),e.query.mac&&(r.MAC=e.query.mac),Object.keys(r).length>0)?require("x.hub.v5.js").Native.setWLANData(r,function(e){e?t.send('{"XC_SUC":{}}'):t.send('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');}):t.send('{"XC_SUC": {}}');}),this._app.get("/tm/http",function(e,t){var r=require("x.hub.taskman.js");r&&r.taskManager?r.taskManager.onHttpEvt(e.query,function(e,r){e?t.send('{"XC_ERR":{"msg":'+e.message+"}}"):r?t.send('{"XC_SUC":{}}'):t.send('{"XC_ERR":{"msg":"no such trigger"}}');}):t.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._dispatcher.init(),this._app.get("*",function(e,t){XC.debugf("INVALID REQ: "+e.url),t.send('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');}),this._app.use(function(e,t,r,o){XC.debugf(e),r.send({XC_ERR:{code:"000001",msg:"exception"}});}),this._httpserver.listen(this._port,function(){var r=t._httpserver.address().port;t._logger.log("info","listening on port "+r+"..."),e&&e();});},x.hub.Server.prototype.sendUDPMessage=function(e){if(this._udpSocket){var t=e.substr(0,4);if("EVT:"==t||"STA:"==t)try{var r=JSON.parse(e.substr(4));r.__srcId=this._udpSocket.__srcId,e=t+JSON.stringify(r);}catch(e){}var o=new Buffer(e);this._udpSocket.send(o,0,o.length,1901,"239.255.255.250"),this._udpSocket.send(o,0,o.length,1901,"255.255.255.255");}},x.hub.Server.prototype._startUDPServer=function(e,t){var r,o=require("dgram"),s=this,n=require("crypto").randomBytes(4).toString("hex");try{r=this._udpSocket=o.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){r=this._udpSocket=o.createSocket("udp4");}r.__srcId=n,r.on("listening",function(){s._logger.log("info","listening on udp port "+e+"..."),r.setBroadcast(!0),t&&t();}),r.on("message",function(e,t){r.address();if(e&&e.length&&e.length>=3&&71==e[0]&&69==e[1]&&84==e[2]){s._logger.log("trace","receive gateway discovery request");var sendPacket=function sendPacket(e,o){var n="DHCP:"+(e.DHCP?"TRUE":"FALSE")+"\nHWV:"+s.HWV+"\nVER:"+s.VERSION+"\nVID:"+s._vid+"\nNAME:"+s._name;n+="\nIP:"+e.IP,n+="\nPT:"+e.PT,n+="\nSN:"+e.SN,n+="\nGW:"+e.GW,n+="\nDNS:"+e.DNS,n+="\nMAC:"+e.MAC,o&&(n+="\nTMP_ID:"+o),n+="\n",s._logger.log("trace","send gateway discovery response:"+n.replace(/(?:\r\n|\r|\n)/g," | "));var a=new Buffer(n);r.send(a,0,a.length,t.port,t.address),r.send(a,0,a.length,1901,"239.255.255.250"),r.send(a,0,a.length,1901,"255.255.255.255");};s.getNetworkSettings(function(e,t){if(!e&&t){var r=null;if("A20"==s.hostType){var fnGetRand=function fnGetRand(){return Math.floor(65536*(1+Math.random())).toString(16).substr(1);};r=fnGetRand()+fnGetRand();}for(var o in t){for(var n=0;n<t[o].length;n++){t[o][n].PT=s._port,sendPacket(t[o][n],r);}}}});}else if(e&&e.length&&e.length>=4&&69==e[0]&&86==e[1]&&84==e[2]){if((n=e.toString()).length>4){var o=null;try{o=JSON.parse(n.substr(4));}catch(e){}if(o)if(o.__srcId!=r.__srcId)delete o.__srcId,require("x.hub.eventbus.js").emit("gatewayevent",o,t,"EVT");}}else if(e&&e.length&&e.length>=4&&83==e[0]&&84==e[1]&&65==e[2]){var n;if((n=e.toString()).length>4){o=null;try{o=JSON.parse(n.substr(4));}catch(e){}if(o)if(o.__srcId!=r.__srcId)delete o.__srcId,require("x.hub.eventbus.js").emit("gatewayevent",o,t,"STA");}}}),r.on("error",function(e){XC.debugf("udp port error"),r.close();}),r.on("close",function(){}),r.bind(e);},x.hub.Server.prototype.onUdpEvt=function(e,t){t||(t="EVT"),this._logger.log("trace","send "+t+" event:"+JSON.stringify(e)),this.sendUDPMessage(t+":"+JSON.stringify(e)+"\r\n");},x.hub.Server.prototype.onStatusEvt=function(e){e&&"aio"!=e.module&&"hm"!=e.module&&e.module;},x.hub.Server.prototype.getTimeZone=function(){var e="8C";return localStorage&&localStorage.getItem("x.hub.Server.timezone")&&(e=localStorage.getItem("x.hub.Server.timezone")),e;},x.hub.Server.prototype.setTimeZoneCompatiable=function(e,t){if(e&&!isNaN(parseInt(e,16))){var r=parseInt(e,16),o=(r>>4&1?-1:1)*(15&r)+11&31|(r>>5&1)<<7;(o=o.toString(16).toUpperCase()).length<2&&(o="0"+o),o&&localStorage&&localStorage.setItem("x.hub.Server.timezone",o);var s=localStorage.getItem("x.hub.Server.geo.lat"),n=localStorage.getItem("x.hub.Server.geo.long");require("x.hub.eventbus.js").emit("locationchange",{timezone:o,lat:s,"long":n}),t&&t();}else t&&t(new Error("timezone invalid"));},x.hub.Server.prototype.getTimeZoneCompatiable=function(e){var t=this.getTimeZone(),r=(31&(t=parseInt(t,16)))-11,o=(0!=(128&t)?1:0)<<5|(r<0?1:0)<<4|(r>0?r:0-r);(o=o.toString(16).toUpperCase()).length<2&&(o="0"+o),e&&e(null,o);},x.hub.Server.prototype._enableHttps=function(){try{var e=require("https"),t=require("fs"),r=require("path"),o=r.join(__dirname,"/"),s=t.readFileSync(r.join(o,"mediola_hub_https_crt/v6PlusSecure.crt"),{encoding:"utf-8"}),n=t.readFileSync(r.join(o,"mediola_hub_https_crt/v6PlusSecure.key"),{encoding:"utf-8"});this._httpsServer=e.createServer({cert:s,key:n},this._app.handle.bind(this._app));}catch(e){this._logger.log("error",e.stack?e.stack:e);}},x.hub.Server.prototype._startSecureServer=function(){var _this=this;var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:443;try{this._httpsServer?this._httpsServer.listen(e,function(){var e=_this._httpsServer.address().port;_this._logger.log("info","listening on port "+e+" for secure requests ...");}):this._logger.log("error","for some reason can not start secured server");}catch(e){this._logger.log("error",e.stack?e.stack:e);}},x.hub.Server.prototype._addModulesRoutes=function(){var _this2=this;try{require("x.hub.moduleman.js").Modules.forEach(function(e){var t=require("x.hub.m.".concat(e,".js"));if(!t)throw new Error("can not load ".concat(e));t.addRoutes&&t.addRoutes(_this2);});}catch(e){this._logger.log("error",e.stack?e.stack:e);}},x.hub.ServerNEO=function(){var ServerNEO=function ServerNEO(e,t,r){x.hub.Server.call(this,e,t,r),this._dispatcher=new x.hub.Dispatcher2(this._app,this),this._auth=new x.hub.Auth2(),this._platform=require("x.hub.neo_server.js");};return require("util").inherits(ServerNEO,x.hub.Server),ServerNEO.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},{path:"/getKey",options:{method:"GET"}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/tm/http",options:{method:"GET"}},{path:"/",options:{method:"GET",auth:0}}],ServerNEO.prototype.addRoute=function(e,t,r){return"function"==typeof t&&(r=t,t=null),this._dispatcher.add(e,t,r);},ServerNEO.prototype._setDefaultRoutes=function(){var e=this,cb=function cb(t,r){var o=null,s=require("url").parse(t.url).pathname;"/"==s?o="/":o="/"+s.split("/")[1];e.doRequest(o,t,r,function(e){null!=e&&null!=e&&("object"==_typeof(e)?r.json(e):r.send(e));});};this._routes.forEach(function(t){e.addRoute(t.path,t.options,cb);});},ServerNEO.prototype._startServer=function(e){var t=this;this._setDefaultRoutes(),this._app.set("case sensitive routing",!0),this._app.use(function(e,t,r){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var o=require("x.logger.js").getLogger("x.hub.Server.Access");o.log("debug",e.method+":"+e.url),e.source="webserver",t.on("finish",function(){o.log("debug",e.method+":"+e.url+" -> HTTP:"+t.statusCode);}),r();}),this._dispatcher.init(),this._app.use("*",function(e,t){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug","INVALID "+e.method+" REQ:"+e.url),t.json({XC_ERR:{code:"000001",msg:"invalid request"}});}),this._app.use(function(e,t,r,o){require("x.logger.js").getLogger("x.hub.Server.Access").log("warn","error: "+e.message+" stack:"+e.stack),r.json({XC_ERR:{code:"000002",msg:e.stack}});}),this._httpserver.listen(this._port,function(){var r=t._httpserver.address().port;t._logger.log("info","listening on port "+r+"..."),e&&e();});},ServerNEO.prototype.doRequest=function(e,t,r,o){var s;!o&&r&&"function"==typeof r&&(o=r,r=null);var n=this;if("/info"==e)this._info(t,function(e,t){e?o&&o(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})):o&&o(JSON.stringify({XC_SUC:t}));});else if("/command"==e)(s=t.query.XC_FNC)&&this._commandFunctions[s.toLowerCase()]?this._commandFunctions[s.toLowerCase()](t,r):o&&o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/cmd"==e)!(s=t.query.XC_FNC)&&t.json&&t.json.XC_FNC&&(s=t.json.XC_FNC,t.query=t.json),s&&this._cmdFunctions[s.toLowerCase()]?this._cmdFunctions[s.toLowerCase()](t,function(e){o&&o(e||'{"XC_ERR":{"code":"000002", "msg":"invalid request"}}');}):o&&o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');else if("/config"==e)this._config(t,function(e,t){e?o&&o(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})):o&&o(JSON.stringify({XC_SUC:t||{}}));});else if("/executeCommand"==e){var a=require("x.logger.js").getLogger("GeneralExecuteCommand API");if(t.json&&(t.query=t.json),a.log("trace","general execute command:"+JSON.stringify(t.query)),!t.query||!t.query.data)return void o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var i=t.query.type;(u=t.query.data).device&&!u.device.sys&&(u.device.sys=i),u.gateway&&!u.gateway.sys&&(u.gateway.sys=i),(c=require("x.hub.commandman.js")).commandHandler.executeCommand(u.device,u.gateway,u.command,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):o('{"XC_SUC":{}}');});}else if("/getStates"==e){if((a=require("x.logger.js").getLogger("GeneralGetStates API")).log("trace","general get states:"+JSON.stringify(t.query)),t.json&&(t.query=t.json),!t.query||!t.query.data)return void o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var u;i=t.query.type;(u=t.query.data).device&&!u.device.sys&&(u.device.sys=i),u.gateway&&!u.gateway.sys&&(u.gateway.sys=i);var c=require("x.hub.commandman.js");u.deviceList?c.commandHandler.getMultiStatesLegacy(u.device,u.gateway,u.deviceList,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?o(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):o('{"XC_SUC":{}}');}):c.commandHandler.getState(u.device,u.gateway,u.status,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?o(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):o('{"XC_SUC":{}}');});}else if("/getKey"==e){var l={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(l.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),require("x.hub.v5.js").getPublicKey(function(e){l.XC_SUC.key=e,o&&o(l);});}else if("/backup"==e)n._platform.backup(t,r,function(){o&&o();});else if("/restore"==e)n._platform.restore(t,r,function(){o&&o();});else if("/reset"==e){var d="factory";t.query&&t.query.type&&(d=t.query.type),n.reset(d,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:"000000",msg:e.message}})):o&&o('{"XC_SUC":{}}');});}else if("/log"==e||"/getLogs"==e)t.method&&"get"==t.method.toLowerCase()?n.getLogs(function(e,t,s){if(e)r.status(500),r.json({XC_ERR:{code:"100000",msg:e.message}}),o&&o();else{var n=require("fs-extra");r.setHeader("Content-disposition","attachment; filename="+t),r.sendFile(s,null,function(e){n.removeSync(s),e&&(r.status(500),r.json({XC_ERR:{code:"100000",msg:e.message}})),o&&o(e);});}}):t.method&&"delete"==t.method.toLowerCase()&&n.clearLogs(function(e){e?o&&o({XC_ERR:{code:"100000",msg:e.message}}):o&&o({XC_SUC:{}});});else if("/tm"==e){if("/tm/http"==require("url").parse(t.url).pathname)require("x.hub.taskman.js").taskManager.onHttpEvt(t.query,function(e,t){e?o&&o('{"XC_ERR":{"msg":'+e.message+"}}"):t?o&&o('{"XC_SUC":{}}'):o&&o('{"XC_ERR":{"msg":"no such trigger"}}');});else o&&o(JSON.stringify({XC_ERR:{code:"000000",msg:"invalid request"}}));}else x.hub.Server.prototype.doRequest.call(this,e,t,o);},ServerNEO.prototype._info=function(e,t){var r={name:this._name,mhv:"XH I-"+this.hostType,msv:this.VERSION,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round(new Date().getTime()/1e3)},o=this;require("async").parallel([function(e){localStorage.getItem("x.hub.v5.config")&&(r.cfg=localStorage.getItem("x.hub.v5.config")),localStorage.getItem("x.hub.v5.SID")&&(r.sid=localStorage.getItem("x.hub.v5.SID")),localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(r.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER"));var t=require("os");t&&t.freemem&&(r.mem=Math.floor(t.freemem()/1e3)),e();},function(e){r.server=o.getCloudServer()+":"+o.getCloudPort(),e();},function(e){o.getTZ(function(t,o){!t&&o&&(r.loc||(r.loc=""),r.loc=(o+r.loc).toUpperCase()),e();});},function(e){o.getLocation(function(t,o,s){!t&&o&&s&&(r.loc||(r.loc=""),r.loc+=(o+s).toUpperCase()),e();});},function(t){o._platform._network.getNetwork(function(o,s){if(!o&&s){var n=null;if(e&&e.headers&&e.headers.host){var a=(n=e.headers.host).indexOf(":");-1!=a&&(n=n.substr(0,a));}for(var i in s){var u=s[i];if(n&&(n==u.ip||"localhost"==n||"127.0.0.1"==n)){r.ip=u.ip,r.sn=u.subnet,r.gw=u.router,r.dns=u.dns?u.dns[0]:null,r.mac=u.mac;break;}}}t();});}],function(){t&&t(null,r);});},ServerNEO.prototype._config=function(e,t){var r,o=this,s=!1;require("async").series([function(t){if(e.query.name&&(o._name=e.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",e.query.name)),e.query.vid&&(o._vid=e.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",e.query.vid)),e.query.pwd||""==e.query.pwd){var r=require("x.crypt.js");0===e.query.pwd.length?(o._pwd="",e.query.cloud=0):o._pwd=r.MD5(unescape(encodeURI(e.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",o._pwd),s=!0;}e.query.neoserver&&(localStorage&&localStorage.setItem("x.hub.taskman.NEO_SERVER",e.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",e.query.neoserver));e.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",e.query.sid),s=!0),t();},function(t){if(localStorage){if(e.query.ckey&&(o.setCloudKey(e.query.ckey),s=!0),e.query.cserver&&(o.setCloudServer(e.query.cserver),s=!0),e.query.cport&&(o.setCloudPort(e.query.cport),s=!0),null!=e.query.cloud&&null!=e.query.cloud){var r=255;localStorage.getItem("x.hub.v5.config")&&(r=parseInt(localStorage.getItem("x.hub.v5.config"),16)),1==e.query.cloud?r&=-65:r|=64;var n=r.toString(16);n.length<2&&(n="0"+n),localStorage.setItem("x.hub.v5.config",n.toUpperCase()),s=!0;}t();}else t();},function(t){var s,n,a;e.query.loc?(2==e.query.loc.length?s=e.query.loc:8==e.query.loc.length?(n=e.query.loc.substr(0,4),a=e.query.loc.substr(4)):10==e.query.loc.length&&(s=e.query.loc.substr(0,2),n=e.query.loc.substr(2,4),a=e.query.loc.substr(6)),o.setTZ(s,function(e){e&&(r=e),o.setLocation(n,a,function(e){e&&(r=e),t();});})):t();}],function(){s&&o._cloudConnect&&o._cloudConnect.init(o),t&&t(r);});},ServerNEO.prototype.setLocation=function(e,t,r){this._logger.log("debug","set location lat="+e+" long="+t),e&&t?(localStorage&&(localStorage.setItem("x.hub.Server.geo.lat",e),localStorage.setItem("x.hub.Server.geo.long",t)),r&&r(),process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:e,"long":t});})):r&&r(new Error("invalid arguments"));},ServerNEO.prototype.getLocation=function(e){var t,r;localStorage&&(t=localStorage.getItem("x.hub.Server.geo.lat"),r=localStorage.getItem("x.hub.Server.geo.long")),t&&r||(t="1392",r="035C"),e&&e(null,t,r);},ServerNEO.prototype.setTZ=function(e,t){this._platform.setTZData(e,t);},ServerNEO.prototype.getTZ=function(e){this._platform.getTZData(e);},ServerNEO.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync();},ServerNEO.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer();},ServerNEO.prototype.setCloudServer=function(e){return this._cloudConnect.setCloudServer(e);},ServerNEO.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort();},ServerNEO.prototype.setCloudPort=function(e){return this._cloudConnect.setCloudPort(e);},ServerNEO.prototype.setCloudKey=function(e){return this._cloudConnect.setCloudKey(e);},ServerNEO.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected();},ServerNEO.prototype.getLogs=function(e){require("x.hub.logman.js").compressLogs(function(t,r,o){e&&e(t,r,o);});},ServerNEO.prototype.clearLogs=function(e){require("x.hub.logman.js").clearLogs(function(t){e&&e(t);});},ServerNEO.prototype.reset=function(e,t){var r=require("fs"),o=require("fs-extra"),s=require("path"),n=require("x.hub.fileman.js").fileManager.getUserRootDataPath();switch(e){case"passwords":var a=s.join(n,"localstorage","x.hub.Server.pwd");r.existsSync(a)&&o.removeSync(a),t&&t(null,!0);break;case"factory":r.existsSync(n)&&o.emptyDirSync(n),t&&t(null,!0);break;default:t&&t(new Error("unknonw reset mode: "+e));}},ServerNEO;}(),x.hub.ServerV6=function(){var e=function(){var Dispatcher=function Dispatcher(e,t){this._expressApp=e,this._server=t,this._routes=[];};return Dispatcher.prototype.add=function(e,t,r){if(!e)throw new Error("invalid arguments");if(t&&"function"==typeof t&&!r&&(r=t,t=null),!r)throw new Error("invalid arguments");this._routes.push({path:e,opts:t,callback:r});},Dispatcher.prototype.doRequest=function(e,t,r){var o=this,_iterate=function _iterate(e,t,s){o._findRoute(e,t,function(e,n){if(e)try{o._doRoute(e,t,s,function(){_iterate(n+1,t,s);});}catch(e){s.json({XC_ERR:{code:"000000",msg:e.message}});}else r();});};_iterate(0,e,t);},Dispatcher.prototype._doRoute=function(e,t,r,o){var s=this,n=this._server._auth,a={pwd:this._server._pwd};!function(e,t,r,o){if("cloud"!=t.source){if(e.opts&&"stream"==e.opts.body)o();else if("POST"!=t.method&&"PUT"!=t.method||"application/octet-stream"==t.header("content-type"))o();else{var s=Buffer.from([]);t.on("data",function(e){s=Buffer.concat([s,e]);}),t.on("end",function(){if(t.size=s.length,t.body=s.toString("utf8"),t.json=null,!e.opts||!e.opts.body||"json"==e.opts.body)try{t.json=JSON.parse(s);}catch(e){}o();});}}else o();}(e,t,0,function(){!function(e,t,r,o,s,n){if("cloud"==t.source)return t.hasValidAuth=!0,void n();var a=o.auth(t,s);t.hasValidAuth=a,e.opts&&0==e.opts.auth||a?n():r.json({XC_ERR:{code:"000007",msg:"access denied"}});}(e,t,r,n,a,function(){!function(e,t,r,o,s){var n=o.isLocked();t.locked=n;var a=o.getRCS();if(t.rcs=a,n){var i=t.query?t.query.pin:null;!i&&t.json&&t.json.pin&&(i=t.json.pin);var u=o.checkPin(i);t.pinMatch=u,e.opts&&e.opts.lock?"function"!=typeof e.opts.lock?u?s():r.json({XC_ERR:{code:"000007",msg:"access denied (locked)"}}):e.opts.lock(u,t,o)?s():r.json({XC_ERR:{code:"000007",msg:"access denied (locked)"}}):s();}else s();}(e,t,r,s._server,function(){e.callback(t,r,function(){o();});});});});},Dispatcher.prototype._findRoute=function(e,t,r){var o,s,_sourceMatch=function _sourceMatch(e,t){return 0!=((e="webserver"==e?1:"cloud"==e?2:3)&t);},n=t.path;for(t.url&&(n=t.url);e<this._routes.length;e++){var a=this._routes[e];if(a&&a.path&&(o=n,s=a.path,o&&("/"!=s||o==s)&&(s.length<=o.length&&o.substr(0,s.length)==s||"*"==s))){if(a.opts){if(a.opts.method&&t.method&&t.method.toLowerCase()!=a.opts.method.toLowerCase())continue;if(a.opts.source&&!_sourceMatch(t.source,a.opts.source))continue;}return void r(a,e);}}r(null,-1);},Dispatcher.prototype.init=function(){var e=this;this._expressApp.use("/",function(t,r,o){e.doRequest(t,r,o);});},Dispatcher;}(),t=function(){var Auth=function Auth(){};return Auth.prototype.auth=function(e,t){if(!t||!t.pwd)return!0;var r=require("x.crypt.js");if(e.query){if(e.query.at&&e.query.at==t.pwd)return!0;if(e.query.auth&&r.MD5(unescape(encodeURI(e.query.auth+"_SALT!")))==t.pwd)return!0;}if(e.json){if(e.json.at){if(e.json.at==t.pwd)return delete e.json.at,!0;delete e.json.at;}if(e.json.auth){if(r.MD5(unescape(encodeURI(e.json.auth+"_SALT!")))==t.pwd)return delete e.json.auth,!0;delete e.json.auth;}}return e.headers&&e.headers.authorization?this._checkAuthHeader(e.headers.authorization,t):(hubLogger.log("error","auth failed for "+e),!1);},Auth.prototype._checkAuthHeader=function(e,t){if(!e)return!1;if("Basic "==e.substr(0,6)){var r=e.substr(6).trim(),o=new Buffer(r,"base64").toString().split(":"),s=(o[0],o[1]);return!!s&&require("x.crypt.js").MD5(unescape(encodeURI(s+"_SALT!")))==t.pwd;}return!1;},Auth.prototype.checkLockWithRCS=function(e,t,r){return!!e&&!("cloud"==t.source&&!r.getRCS());},Auth;}(),ServerV6=function ServerV6(r,o,s){this.PERSISTENT_DATA_PATH=this._getSrvPath()+"/XHUB_PERSISTENTDATA",this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE="PERSISTENTDATA",this.persitentData={"x.hub.Server.vid":null},x.hub.Server.call(this,r,o,s),this._dispatcher=new e(this._app,this),this._auth=new t(),this._platform=require("x.hub.v6.js");var n=this;this._platform._stm.on("event",function(e,t){n._onSerialEvent(e,t);}),this._locked="true"==localStorage.getItem("x.hub.Server.lock"),this._rcs="true"==localStorage.getItem("x.hub.Server.rcs"),this._restorePersistentData();};return require("util").inherits(ServerV6,x.hub.Server),ServerV6.prototype._getSrvPath=function(){var e=require("path");return SYSTEM_ROOT||(SYSTEM_ROOT="/"),e.join(SYSTEM_ROOT,"srv");},ServerV6.prototype._routes=[{path:"/info",options:{method:"GET"}},{path:"/cmd",options:null},{path:"/command",options:null},{path:"/config",options:{method:"GET",source:1,lock:1}},{path:"/wifi",options:{method:"GET",source:1}},{path:"/executeCommand",options:{method:"POST"}},{path:"/getStates",options:{method:"POST"}},{path:"/getKey",options:{method:"GET",lock:function lock(e,t,r){return!!e&&!("cloud"==t.source&&!r.getRCS());}}},{path:"/peripheral",options:{method:"GET"}},{path:"/update",options:{source:1,lock:1}},{path:"/backup",options:{method:"GET"}},{path:"/restore",options:{method:"POST",body:"stream"}},{path:"/reset",options:{method:"GET",source:1,lock:1}},{path:"/reboot",options:{method:"GET"}},{path:"/log",options:{method:"GET",source:1}},{path:"/getLogs",options:{method:"GET",source:1}},{path:"/log",options:{method:"DELETE"}},{path:"/lock",options:{method:"GET",lock:function lock(e,t,r){return!!e&&!("cloud"==t.source&&!r.getRCS());}}},{path:"/unlock",options:{method:"GET",lock:function lock(e,t,r){return!!e&&!("cloud"==t.source&&!r.getRCS());}}},{path:"/tm/http",options:{method:"GET"}},{path:"/sapi",options:{method:"POST",body:"text",auth:0}},{path:"/",options:{method:"GET",auth:0}}],ServerV6.prototype.addRoute=function(e,t,r){return"function"==typeof t&&(r=t,t=null),this._dispatcher.add(e,t,r);},ServerV6.prototype._setDefaultRoutes=function(){var e=this,cb=function cb(t,r){var o=null,s=require("url").parse(t.url).pathname;"/"==s?o="/":o="/"+s.split("/")[1];e.doDefaultRequest(o,t,r,function(e){null!=e&&null!=e&&("object"==_typeof(e)?r.json(e):r.send(e));});};this._routes.forEach(function(t){e.addRoute(t.path,t.options,cb);});},ServerV6.prototype._startServer=function(e){var t=this;this._setDefaultRoutes(),this._app.set("case sensitive routing",!0),this._app.use(function(e,t,r){t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization");var o=require("x.logger.js").getLogger("x.hub.Server.Access");e.source="webserver",t.on("finish",function(){var r=e.headers["x-forwarded-for"]||e.headers.forwarded||e.socket.remoteAddress;o.log("debug",r+" "+e.method+":"+e.url+" -> HTTP:"+t.statusCode);}),r();}),this._dispatcher.init(),this._app.use("*",function(e,t){XC.debugf("INVALID REQ: "+e.url),t.json({XC_ERR:{code:"000001",msg:"invalid request"}});}),this._app.use(function(e,t,r,o){XC.debugf(e),r.json({XC_ERR:{code:"000002",msg:e.stack}});}),this._httpserver.listen(this._port,function(){var r=t._httpserver.address().port;t._logger.log("info","listening on port "+r+"..."),e&&e();});},ServerV6.prototype.doDefaultRequest=function(e,t,r,o){var s;!o&&r&&"function"==typeof r&&(o=r,r=null);var n=this;if("/"==e){var a="<!DOCTYPE html>\n";a+='<html>\n<head>\n<meta http-equiv="content-type" content="text/html; charset=utf-8" />\n',a+="<title>"+String(this._name).replace(/</g,"&lt;").replace(/>/g,"&gt;")+"</title>\n",a+='<script>function setZwaveConfigRef() {var zwaveconfig = document.getElementById("zwaveconfig"); if(zwaveconfig){zwaveconfig.href = window.location.protocol + "//" + window.location.hostname + ":9000/";}}<\/script>\n',a+="</head>\n",a+='<body style="background-color: #FFFFFF; font-family: Helvetica, Arial, sans-serif;" onload="setZwaveConfigRef()">\n',a+='<table style="border-radius: 0px 0px 8px 8px; border: 1px #999 solid; -moz-box-shadow: 0px 5px 8px #888; -webkit-box-shadow: 2px 5px 8px #888; box-shadow: 0px 5px 8px #888; position: absolute; height: 220px; width: 420px; margin: -110px 0px 0px -210px; top: 50%; left: 50%; color: #777; background-color: #fafafa; font-size: 15px;" border="0" cellspacing="0">\n',a+="<tbody>\n",a+='<tr style="height: 48px; background-color: #666; color: #FFFFFF; font-size: 20px;">',a+='<th colspan="3">'+this._name+"</th>\n",a+="</tr>\n",a+='<tr style="height: 28px;"><td style="width: 70px;">&nbsp;</td><td style="width: 150px;">&nbsp;</td><td>&nbsp;</td></tr>\n';var i='<tr style="height: 30px;"><td>&nbsp;</td><td>',u=":</td><td><b>",c="</b></td></tr>\n";a+=i+"device"+u+this.DEFAULT_NAME+c,a+=i+"version"+u+this.HWV+" ("+this.VERSION+")"+c;var l=Math.round(new Date().getTime()/1e3)-this._startup,d=Math.floor(l/86400);l-=60*d*60*24;var h=Math.floor(l/3600);l-=60*h*60;var g=Math.floor(l/60);a+=i+"uptime"+u+d+"d "+h+"h "+g+"m "+(l-=60*g)+"s"+c,(p=require("os"))&&p.freemem&&(a+=i+"memory"+u+Math.floor(p.freemem()/1e3)+c),a+=i+"zwave"+u+'<a href=":9000/" id="zwaveconfig">Expert UI</a>'+c,a+='<tr style="height: 0px;"><td colspan="3">&nbsp;</td></tr>\n',a+='<tr style="height: 32px;"><td colspan="3" style="font-size: 13px; text-align: center;">&copy;&nbsp;2020 mediola - connected living AG</td></tr>\n',o(a+="</tbody>\n</table>\n</body>\n</html>");}else if("/info"==e){var p,f={XC_SUC:{name:this._name,mhv:"XH II-"+this.hostType,msv:this.VERSION,msb:this.BUILD,hwv:this.HWV,vid:this._vid,start:this._startup,time:Math.round(new Date().getTime()/1e3)}};if(localStorage.getItem("x.hub.v5.config")&&(f.XC_SUC.cfg=localStorage.getItem("x.hub.v5.config")),localStorage.getItem("x.hub.v5.cloudServer")&&localStorage.getItem("x.hub.v5.cloudPort"))f.XC_SUC.server=localStorage.getItem("x.hub.v5.cloudServer")+":"+localStorage.getItem("x.hub.v5.cloudPort");else{var m=require("x.hub.v5.js").CloudConnect;f.XC_SUC.server=m.prototype.CLOUD_SERVER+":"+m.prototype.CLOUD_SERVER_PORT;}localStorage.getItem("x.hub.v5.SID")&&(f.XC_SUC.sid=localStorage.getItem("x.hub.v5.SID")),localStorage.getItem("x.hub.taskman.NEO_SERVER")&&(f.XC_SUC.neoserver=localStorage.getItem("x.hub.taskman.NEO_SERVER")),localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")&&(f.XC_SUC.ccu_init_state=localStorage.getItem("x.hub.m.hm.CCU_INIT_STATE")),localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")&&(f.XC_SUC.disable_st_states=localStorage.getItem("x.hub.Server.DISABLE_ST_STATES")),(p=require("os"))&&p.freemem&&(f.XC_SUC.mem=Math.floor(p.freemem()/1e3));try{if(global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")){var _=require("x.hub.m.enocean.js");if(_){var y=_.getEnoceanInfo();f.XC_SUC.enocean=y;}}}catch(e){}require("async").parallel([function(e){n._platform.getSTMSettings(function(t,r){!t&&r&&(f.XC_SUC.stm_settings=r),e();});},function(e){f.XC_SUC.rcs=n.getRCS(),e();},function(e){f.XC_SUC.locked=n.isLocked(),e();},function(e){n._platform.getExtraInfo(function(t,r){!t&&r&&(f.XC_SUC.extra=r),e();});},function(e){n._platform._time.getNTPServers(function(t,r){!t&&r&&(f.XC_SUC.ntp=r.join(",")),e();});},function(e){n._platform.getLocation(function(t,r,o){!t&&r&&o&&(f.XC_SUC.loc=(r+o).toUpperCase()),n._platform._time.getTimezoneEncoded(function(t,r){!t&&r&&(f.XC_SUC.loc=f.XC_SUC.loc?r.toUpperCase()+f.XC_SUC.loc:r.toUpperCase()),e();});});},function(e){f.XC_SUC.mediola_mac=n._platform._network.getMediolaMac(),n._platform._network.getNetwork(function(t,r){if(!t&&r){r.en0&&(r.eth0=r.en0);var fnSetIfaceData=function fnSetIfaceData(e){return e?{ip:e.ip,sn:e.subnet,gw:e.router,dhcp:e.dhcp,dns:e.dns?e.dns.join(","):e.dns,mac:e.mac?e.mac.replace(/\:/g,"-"):null}:null;},o=Object.keys(r);if(0==o.length)return;var s=fnSetIfaceData(r.eth0),n=fnSetIfaceData(r.wlan0),a=null;r.eth0||r.wlan0||(a=fnSetIfaceData(r[o[0]]));var i=null;for(var u in s&&s.ip?(i=s,f.XC_SUC.primary_net="eth0"):n&&n.ip?(i=n,f.XC_SUC.primary_net="wlan0"):a&&a.ip&&(i=n,f.XC_SUC.primary_net=o[0]),i){f.XC_SUC[u]=i[u];}if(f.XC_SUC.cfg&&i){var c=parseInt(f.XC_SUC.cfg,16);!0===i.dhcp?c&=-129:c|=128,f.XC_SUC.cfg=c.toString(16),f.XC_SUC.cfg.length<2&&(f.XC_SUC.cfg="0"+f.XC_SUC.cfg),f.XC_SUC.cfg=f.XC_SUC.cfg.toUpperCase();}f.XC_SUC.eth0=s,f.XC_SUC.wlan0=n;}e();});}],function(){o(JSON.stringify(f));});}else if("/command"==e)(s=t.query.XC_FNC)&&this._commandFunctions[s.toLowerCase()]?this._commandFunctions[s.toLowerCase()](t,r):this._doSTMCommandRequest(t,!0,function(e){r.send(e);});else if("/cmd"==e)!(s=t.query.XC_FNC)&&t.json&&t.json.XC_FNC&&(s=t.json.XC_FNC,t.query=t.json),s&&this._cmdFunctions[s.toLowerCase()]?this._cmdFunctions[s.toLowerCase()](t,function(e){e?o(e):(t.method,n._doSTMCommandRequest(t,!1,o));}):(t.method,this._doSTMCommandRequest(t,!1,o));else if("/config"==e){var S,v=!1,C=!1,q=null;!t.query||1!=t.query.poweroff&&"true"!=t.query.poweroff&&1!=t.query.poweroff||(q=!0),require("async").series([function(e){var r=t.query.enable_stm_states_buffer,o=t.query.stm_states_buffer_timeout,s=null;"1"==r||"true"==r||1==r?(s||(s={}),s.enable_stm_states_buffer=!0):"0"!=r&&"false"!=r&&0!=r||(s||(s={}),s.enable_stm_states_buffer=!1),isNaN(parseInt(o))||(s||(s={}),s.stm_states_buffer_timeout=parseInt(o)),s?n._platform._stm.setSettings(s,function(){e();}):e();},function(e){if(t.query.name&&(n._name=t.query.name,localStorage&&localStorage.setItem("x.hub.Server.name",t.query.name)),t.query.vid&&(n._vid=t.query.vid,localStorage&&localStorage.setItem("x.hub.Server.vid",t.query.vid)),t.query.pwd||""==t.query.pwd){var r=require("x.crypt.js");0===t.query.pwd.length?(n._pwd="",t.query.cloud=0):n._pwd=r.MD5(unescape(encodeURI(t.query.pwd+"_SALT!"))),localStorage&&localStorage.setItem("x.hub.Server.pwd",n._pwd),v=!0;}t.query.neoserver&&localStorage&&(localStorage.setItem("x.hub.taskman.NEO_SERVER",t.query.neoserver),require("x.hub.eventbus.js").emit("neoserver_activation",t.query.neoserver));t.query.ccu_init_state&&localStorage&&(localStorage.setItem("x.hub.m.hm.CCU_INIT_STATE",t.query.ccu_init_state),require("x.hub.eventbus.js").emit("x.hub.m.hm.CCU_INIT_STATE",t.query.ccu_init_state));if(t.query.disable_st_states&&localStorage&&localStorage.setItem("x.hub.Server.DISABLE_ST_STATES",t.query.disable_st_states),t.query.sid&&localStorage&&(localStorage.setItem("x.hub.v5.SID",t.query.sid),v=!0),t.query.ckey&&localStorage&&(localStorage.setItem("x.hub.v5.cloudKey",t.query.ckey),v=!0),t.query.cserver&&localStorage&&(localStorage.setItem("x.hub.v5.cloudServer",t.query.cserver),v=!0),t.query.cport&&localStorage&&(localStorage.setItem("x.hub.v5.cloudPort",t.query.cport),v=!0),t.query.cloud&&localStorage){var o=255;localStorage.getItem("x.hub.v5.config")&&(o=parseInt(localStorage.getItem("x.hub.v5.config"),16)),1==t.query.cloud?o&=-65:o|=64;var s=o.toString(16);s.length<2&&(s="0"+s),localStorage.setItem("x.hub.v5.config",s.toUpperCase()),v=!0;}e();},function(e){var r,o,s;t.query.loc?(2==t.query.loc.length?r=t.query.loc:8==t.query.loc.length?(o=t.query.loc.substr(0,4),s=t.query.loc.substr(4)):10==t.query.loc.length&&(r=t.query.loc.substr(0,2),o=t.query.loc.substr(2,4),s=t.query.loc.substr(6)),n.setTimeZoneCompatiable(r,function(t){t&&(S=t),n.setLocation(o,s,function(t){t&&(S=t),e();});})):e();},function(e){if(t.query.year&&t.query.month&&t.query.date&&t.query.hour&&t.query.minute){var r=parseInt(t.query.year),o=parseInt(t.query.month),s=parseInt(t.query.date),a=parseInt(t.query.hour),i=parseInt(t.query.minute);n.setDateTime(r,o,s,a,i,function(t){t&&(S=t),e();});}else e();},function(e){t.query.apin?n.setPin(t.query.pin,t.query.apin,function(t){t&&(S=new Error("failed to config")),e(t);}):e();},function(e){if(null!=t.query.rcs&&null!=t.query.rcs&&""!=t.query.rcs){var r=null;if("1"==t.query.rcs||"true"==t.query.rcs||1==t.query.rcs)r=!0;else{if("0"!=t.query.rcs&&"false"!=t.query.rcs&&0!=t.query.rcs)return void e();r=!1;}n.setRCS(r,function(t){t&&(S=new Error("failed to config")),e(t);});}else e();},function(e){var r={};t.query.ip&&t.query.sn&&t.query.gw&&t.query.dns&&(r.IP=t.query.ip,r.SN=t.query.sn,r.GW=t.query.gw,r.DNS=t.query.dns,r.DHCP=!1),t.query.dhcp&&1==t.query.dhcp&&(r={DHCP:!0}),t.query.ntp&&(r.NTP=t.query.ntp),t.query.mac&&(r.MAC=t.query.mac),Object.keys(r).length<=0?e():n._platform.setIPData(r,function(t,r){t?S=t:C=r,e();});}],function(){v&&n._cloudConnect&&n._cloudConnect.init(n),o&&o(S?JSON.stringify({XC_ERR:{code:"000001",msg:S.message}}):'{"XC_SUC": {}}'),1!=q?C&&n.restart(1e3):n.poweroff(1e3);});}else if("/executeCommand"==e){var b=require("x.logger.js").getLogger("GeneralExecuteCommand API");if(t.json&&(t.query=t.json),b.log("trace","general execute command:"+JSON.stringify(t.query)),!t.query||!t.query.data)return void o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var R=t.query.type;(X=t.query.data).device&&!X.device.sys&&(X.device.sys=R),X.gateway&&!X.gateway.sys&&(X.gateway.sys=R),(w=require("x.hub.commandman.js")).commandHandler.executeCommand(X.device,X.gateway,X.command,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):o('{"XC_SUC":{}}');});}else if("/getStates"==e){if((b=require("x.logger.js").getLogger("GeneralGetStates API")).log("trace","general get states:"+JSON.stringify(t.query)),t.json&&(t.query=t.json),!t.query||!t.query.data)return void o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');var X;R=t.query.type;(X=t.query.data).device&&!X.device.sys&&(X.device.sys=R),X.gateway&&!X.gateway.sys&&(X.gateway.sys=R);var w=require("x.hub.commandman.js");X.deviceList?w.commandHandler.getMultiStatesLegacy(X.device,X.gateway,X.deviceList,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?o(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):o('{"XC_SUC":{}}');}):w.commandHandler.getState(X.device,X.gateway,X.status,function(e){e.error?o('{"XC_ERR":{"code":"000000","msg":"'+e.error.message+'"}}'):e&&e.data?o(JSON.stringify({XC_SUC:{data:JSON.stringify(e.data)}})):o('{"XC_SUC":{}}');});}else if("/getKey"==e){var I=t.query?t.query.k:null;if(I){if(!(N=(t.headers?t.headers["x-forwarded-for"]:null)||(t.connection?t.connection.remoteAddress:null)))return void(o&&o({XC_ERR:{code:"000000",msg:"can not get client ip address"}}));(k=require("x.hub.password")).registSecureClient(N,I,function(e,t){e?o&&o({XC_ERR:{code:"000000",msg:e.message}}):o&&o({XC_SUC:t});});}else{f={XC_SUC:{}};localStorage.getItem("x.hub.v5.cloudKey")&&(f.XC_SUC.cloud=localStorage.getItem("x.hub.v5.cloudKey")),require("x.hub.v5.js").getPublicKey(function(e){f.XC_SUC.key=e,o&&o(f);});}}else if("/peripheral"==e){require("x.hub.peripheralman.js").getUSBDevicesShortInfo(function(e){e?e.error?o&&o(JSON.stringify({XC_ERR:{code:"000001",msg:e.error}})):e.data?o&&o(JSON.stringify({XC_SUC:e.data})):o&&o(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}})):o&&o(JSON.stringify({XC_ERR:{code:"000001",msg:"get peripheral internal error"}}));});}else if("/update"==e)t.method&&"post"==t.method.toLowerCase()&&t.query&&"st"==t.query.type?n._platform.updateSTM(t,r,function(){o&&o();}):t.query&&"st"==t.query.type?n._platform.updateSTM(null,r,function(){o&&o();}):n._platform.updateFirmware(t.query?t.query.url:null,function(e,t){e?r.json({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}}):(r.json({XC_SUC:{}}),t&&n._platform.reboot(null,1e3)),o&&o();});else if("/backup"==e)n._platform.backup(t,r,function(){o&&o();});else if("/restore"==e)n._platform.restore(t,r,function(){o&&o();});else if("/reset"==e){if(t.query&&t.query.type){if("st"==t.query.type)n._platform._stm.reset(function(e){e?o&&o({XC_ERR:{msg:e.message}}):o&&o({XC_SUC:{}});});else if("st_reboot"==t.query.type)n._platform._stm.reboot(function(e){e?o&&o({XC_ERR:{msg:e.message}}):o&&o({XC_SUC:{}});});else if("knx"==t.query.type){require("x.hub.m.knx.js").reset(function(e){e&&!e.error?o&&o({XC_SUC:{}}):o&&o({XC_ERR:{code:"000000",message:"reset knx failed"}});});}else"zwave"==t.query.type&&n._platform._zwayServer.reset(function(e){e?o&&o({XC_ERR:{msg:e.message}}):o&&o({XC_SUC:{}});});}else o&&o('{"XC_SUC":{}}'),n.restart(1e3);}else if("/reboot"==e){o&&o('{"XC_SUC":{}}');var T=null;t.query&&t.query.mode&&"recovery"==t.query.mode&&(T="recovery"),n._platform.reboot(T,1e3);}else if("/wifi"==e){switch(t.path.substr(5)){case"/scan":n._platform._network.scanWifi(t.query,function(e,t){e?o&&o(JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}})):o&&o(JSON.stringify({XC_SUC:t||[]}));});break;case"/connect":n._platform._network.connectWifi(t.query,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}})):(o&&o(JSON.stringify({XC_SUC:{}})),n.restart(1e3));});break;case"/disconnect":n._platform._network.disconnectWifi(t.query,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}})):(o&&o(JSON.stringify({XC_SUC:{}})),n.restart(1e3));});break;case"/info":n._platform._network.getWifiInfo(t.query,function(e,t){e?o&&o(JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}})):o&&o(JSON.stringify({XC_SUC:t}));});break;case"/config":var j={};if("true"==t.query.dhcp||1==t.query.dhcp||1==t.query.dhcp?j={dhcp:!0}:t.query.ip&&t.query.sn&&t.query.gw&&t.query.dns&&(j.ip=t.query.ip,j.subnet=t.query.sn,j.router=t.query.gw,j.dns=t.query.dns?t.query.dns.split(","):[],j.dhcp=!1),Object.keys(j).length<=0)return void(o&&o(JSON.stringify({XC_SUC:{}})));n._platform._network.setNetwork("wlan0",j,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:e.code?e.code:"000000",msg:e.message}})):(o&&o(JSON.stringify({XC_SUC:{}})),n.restart(1e3));});break;default:o&&o({XC_ERR:{code:"000001",message:"invalid request"}});}}else if("/log"==e||"/getLogs"==e)t.method&&"get"==t.method.toLowerCase()?n.getLogs(function(e,t,s){if(e)r.status(500),r.json({XC_ERR:{code:"100000",msg:e.message}}),o&&o();else{var n=require("fs-extra");r.setHeader("Content-disposition","attachment; filename="+t),r.sendFile(s,null,function(e){n.removeSync(s),e&&(r.status(500),r.json({XC_ERR:{code:"100000",msg:e.message}})),o&&o(e);});}}):t.method&&"delete"==t.method.toLowerCase()&&n.clearLogs(function(e){e?o&&o({XC_ERR:{code:"100000",msg:e.message}}):o&&o({XC_SUC:{}});});else if("/tm"==e){if("/tm/http"==require("url").parse(t.url).pathname)require("x.hub.taskman.js").taskManager.onHttpEvt(t.query,function(e,t){e?o&&o('{"XC_ERR":{"msg":'+e.message+"}}"):t?o&&o('{"XC_SUC":{}}'):o&&o('{"XC_ERR":{"msg":"no such trigger"}}');});else o&&o(JSON.stringify({XC_ERR:{code:"000000",msg:"invalid request"}}));}else if("/lock"==e){var U=t.query?t.query.pin:null;n.lock(U,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:e.code,msg:e.message}})):o&&o(JSON.stringify({XC_SUC:{}}));});}else if("/unlock"==e){U=t.query?t.query.pin:null;n.unlock(U,function(e){e?o&&o(JSON.stringify({XC_ERR:{code:e.code,msg:e.message}})):o&&o(JSON.stringify({XC_SUC:{}}));});}else if("/sapi"==e){var N;if(!(N=(t.headers?t.headers["x-forwarded-for"]:null)||(t.connection?t.connection.remoteAddress:null)))return void(o&&o({XC_ERR:{code:"000000",msg:"can not get client ip address"}}));var k;n=this;(k=require("x.hub.password")).decodeSecureReq(N,t,function(e,t){if(!e){require("x.logger.js").getLogger("x.hub.Server.Access").log("debug",t.method+":"+t.url);var r={json:function json(e){k.encodeSecureRsp(N,JSON.stringify(e),function(e,t){e?o&&o({XC_ERR:{code:"000000",msg:e.message}}):o&&o(t);});},send:function send(e){k.encodeSecureRsp(N,e,function(e,t){e?o&&o({XC_ERR:{code:"000000",msg:e.message}}):o&&o(t);});}};n._dispatcher.doRequest(t,r,function(e){null!=e&&null!=e&&("object"==_typeof(e)?r.json(e):r.send(e));});}});}else o&&o('{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');},ServerV6.prototype._doSTMCommandRequest=function(e,t,r){if(e){var o=this._platform._stm;if(o){var s,n,a=this;"string"==typeof e?(s=16,(n=e).indexOf("?")>-1&&(n=n.substr(n.indexOf("?")+1))):("POST"==e.method?(s=17,n=e.json?JSON.stringify(e.json):e.body):(s=16,(n=e.url).indexOf("?")>-1&&(n=n.substr(n.indexOf("?")+1))),e.locked?"cloud"==e.source?16==s?s=18:17==s&&(s=19):"webserver"!=e.source||e.pinMatch||(16==s?s=18:17==s&&(s=19)):"cloud"==e.source&&(16==s?s=20:17==s&&(s=21))),o.sendCommand(s,n,function(e){if(e&&e.error?a._logger.log("trace",n+" --\x3e FAIL:"+e.error):e&&e.data?a._logger.log("trace",n+" --\x3e "+e.data.toString()):a._logger.log("trace",n+" --\x3e FAIL"),e&&e.data){var o="XC_SUC";e.error&&(o="XC_ERR"),r(t?"{"+o+"}"+e.data.toString():'{"'+o+'": '+e.data.toString()+"}");}else t?r("{XC_ERR}internal error"):e&&e.error?r(JSON.stringify({XC_ERR:{code:"000000",msg:e.error}})):r('{"XC_ERR":{"code":"000000", "msg":"internal error"}}');});}else r(t?"{XC_ERR}no stm":'{"XC_ERR":{"code":"000001", "msg":"no stm"}}');}else r(t?"{XC_ERR}invalid request":'{"XC_ERR":{"code":"000001", "msg":"invalid request"}}');},ServerV6.prototype.setLED=function(e,t){if(e&&"string"==typeof e&&e.match(/^([a-fA-F0-9]){4}/g)){var r=this._platform._led;if(r){var o,s,n,a=parseInt(e.substr(0,2),16),i=parseInt(e.substr(2,2),16);switch(i){case 0:o=0,s=0,n=0;break;case 1:o=0,s=255,n=0;break;case 2:o=0,s=0,n=255;break;case 3:o=255,s=0,n=0;break;case 4:o=255,s=255,n=0;break;case 5:o=255,s=255,n=255;break;case 6:o=255,s=0,n=255;break;case 7:o=0,s=255,n=255;break;default:return void(t&&t(new Error("invalid set led color:"+i)));}0===a?r.setColor(o,s,n,function(e){t&&t(e);}):1==a?r.saveColor(o,s,n,function(e){t&&t(e);}):t&&t(new Error("invalid set led command:"+a));}else t&&t(new Error("no led"));}else t&&t(new Error("invalid set led data: "+e));},ServerV6.prototype.restart=function(e){this._platform.reboot(null,e);},ServerV6.prototype.poweroff=function(e){this._platform.poweroff(e);},ServerV6.prototype.reset=function(e,t){var r=require("path"),o=require("fs"),s=require("fs-extra"),n=require("x.hub.fileman.js").fileManager.getUserRootDataPath();switch(this._logger.log("debug","reset ("+e+")"),e){case"passwords":var a=r.join(n,"localstorage","x.hub.Server.pwd");o.existsSync(a)&&(this._logger.log("trace","remove file "+a),s.removeSync(a)),require("x.hub.password.js").reset(function(){t&&t(null,!0);});break;case"network":this._platform.reset("network",function(e,r){t&&t(e,r);});break;case"factory":this._persistData(),o.existsSync(n)&&(this._logger.log("trace","clear folder "+n),s.emptyDirSync(n)),this._platform.reset("factory",function(e,r){t&&t(e,r);});break;default:t&&t(new Error("unknonw reset mode: "+e));}},ServerV6.prototype.getTimezoneSync=function(){return this._platform.getTimezoneSync();},ServerV6.prototype.setTimeZoneCompatiable=function(e,t){this._platform.setTZData(e,function(r){r||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{timezone:e});}),t&&t(r);});},ServerV6.prototype.getTimeZoneCompatiable=function(e){this._platform.getTZData(e);},ServerV6.prototype.setLocation=function(e,t,r){this._platform.setLocation(e,t,function(o){o||process.nextTick(function(){require("x.hub.eventbus.js").emit("locationchange",{lat:e,"long":t});}),r&&r(o);});},ServerV6.prototype.getLocation=function(e){this._platform.getLocation(function(t,r,o){e&&e(t,r,o);});},ServerV6.prototype.setDateTime=function(e,t,r,o,s,n){isNaN(e)||e<1970||e>9999?n&&n(new Error("year invalid")):isNaN(t)||t<1||t>12?n&&n(new Error("month invalid")):isNaN(r)||r<1||r>31?n&&n(new Error("date invalid")):isNaN(o)||o<0||o>23?n&&n(new Error("hour invalid")):isNaN(s)||s<0||s>59?n&&n(new Error("minute invalid")):this._platform.setTime({year:e,month:t,date:r,hour:o,minute:s},n);},ServerV6.prototype.getLogs=function(e){var t=require("x.hub.fileman.js").fileManager.getUserLogPath(),r=require("os").tmpdir(),o=require("path"),s=require("fs-extra"),n=require("archiver"),a="logs_"+new Date().toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",i=o.join(r,a),u=s.createWriteStream(i),c=n("zip");u.on("close",function(){e&&(e(null,a,i),e=null);}),u.on("error",function(t){e&&(e(t),e=null);}),c.on("error",function(t){e&&(e(t),e=null);}),c.pipe(u),c.directory(t),c.finalize();},ServerV6.prototype.clearLogs=function(e){require("x.hub.logman.js").clearLogs(function(t){e&&e(t);});},ServerV6.prototype.getCloudServer=function(){return this._cloudConnect.getCloudServer();},ServerV6.prototype.getCloudPort=function(){return this._cloudConnect.getCloudPort();},ServerV6.prototype.isCloudConnected=function(){return this._cloudConnect.isConnected();},ServerV6.prototype.isLocked=function(){return this._locked;},ServerV6.prototype.lock=function(e,t){if(!e||this.checkPin(e))localStorage.setItem("x.hub.Server.lock",!0),this._locked=!0,t&&t(null);else{var r=new Error("failed to lock");r.code="000003",t&&t(r);}},ServerV6.prototype.unlock=function(e,t){if(e&&this.checkPin(e))localStorage.setItem("x.hub.Server.lock",!1),this._locked=!1,t&&t(null);else{var r=new Error("access denied (locked)");r.code="000007",t&&t(r);}},ServerV6.prototype.setPin=function(e,t,r){var o=require("x.hub.password.js").setPin(e,t);r&&r(o?null:new Error("failed"));},ServerV6.prototype.checkPin=function(e){return require("x.hub.password.js").checkPin(e);},ServerV6.prototype.getRCS=function(){return this._rcs;},ServerV6.prototype.setRCS=function(e,t){localStorage.setItem("x.hub.Server.rcs",e),this._rcs=e,t&&t();},ServerV6.prototype._persistData=function(){var e=require("fs"),t=require("node-localstorage").LocalStorage;this._logger.log("debug","vid is "+this._vid),this.persitentData["x.hub.Server.vid"]=this._vid;var r=JSON.stringify(this.persitentData);e.existsSync(this._getSrvPath())||e.mkdirSync(this._getSrvPath()),new t(this.PERSISTENT_DATA_PATH).setItem(this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE,r),this._logger.log("trace","data is persisted : "+r);},ServerV6.prototype._restorePersistentData=function(){var _this3=this;var e=require("fs"),t=require("node-localstorage").LocalStorage;require("path");this._logger.log("debug","try to load data from persistent data"),e.existsSync(this._getSrvPath())||e.mkdirSync(this._getSrvPath());var r=new t(this.PERSISTENT_DATA_PATH).getItem(this.PERSISTENTDATA_KEY_IN_LOCALSTORAGE);if(!r)return this._logger.log("debug","persist data after 30 secs"),void setTimeout(function(){_this3._persistData();},3e4);try{var o=JSON.parse(r);if(!localStorage)return void this._logger.log("error","something is wrong, we do not have global localstorage");var s=Object.keys(o);for(var _i=0,_s=s;_i<_s.length;_i++){key=_s[_i];localStorage.setItem(key,o[key]),this._logger.log("debug",key+" is set by "+o[key]+" from persitent data");}}catch(e){this._logger.log("error","error in parsing the persitente data and restoring"),this._logger.log("error",e);}},ServerV6;}(),x.hub.Handler=function(){this.server=null;},x.hub.Handler.prototype.Server=x.hub.Server,x.hub.Handler.prototype.ServerNEO=x.hub.ServerNEO,x.hub.Handler.prototype.ServerV6=x.hub.ServerV6,x.hub.Handler.prototype.getServer=function(){return this.server;},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.Handler());