var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.symcon=xnm.aio.symcon||{},xnm.aio.symcon.TYPE_BOOL=0,xnm.aio.symcon.TYPE_INT=1,xnm.aio.symcon.TYPE_FLOAT=2,xnm.aio.symcon.TYPE_STRING=3,xnm.aio.symcon.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var t=JSON.parse(JSON.stringify(e));if(t.auth&&(t.auth="xxxxxx:xxxxxx"),t.headers)for(var a in headers){if(a&&"authorization"==a.toLocaleLowerCase()){var r=headers[a];if(r){var n=r.indexOf(" ");headers[a]=-1==n?"xxxxxx":r.substr(0,n)+" xxxxxx";}}}return t;}catch(t){return e;}}},xnm.aio.symcon.Server=function(e,t,a,r,n,s,o){try{this._logger=require("x.logger.js").getLogger("xnm.aio.symcon.Server");}catch(e){this._logger={log:function log(){}};}this.ip=e,this.port=t||82,this.user=a,this.password=r,this.webusr="webfront",this.webid=n,this.webpwd=s,this.ver=o,this._id=1,this.scripts={},this.instances={},this.variables={},this._scanning=!1,this._scanCallbacks=[],this._scanListener=[],this.CommandHandler=null;},xnm.aio.symcon.Server.prototype._doRequest=function(e,t,a){var r,n='{"jsonrpc": "2.0", "params": '+JSON.stringify(t)+', "method": "'+e+'", "id": '+this._id++ +"}";"WFC_"==e.substr(0,4)?(this._logger.log("trace","do WFC_ request with cred:xxxxxx pwd:xxxxxx"),r=this.webpwd?"Basic "+new Buffer(this.webusr+":"+this.webpwd).toString("base64"):null):(this._logger.log("trace","do request with cred:xxxxxx pwd:xxxxxx"),r=this.user||this.password?"Basic "+new Buffer(this.user+":"+this.password).toString("base64"):null);var s={host:this.ip,port:this.port,path:"/api/",method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8","Content-Length":n.length,"User-Agent":"mediola",Connection:"close"}};r&&(s.headers.Authorization=r),this._logger.log("trace","do request:"+JSON.stringify(xnm.aio.symcon.Util.clearHttpOptionForLog(s))),this._logger.log("trace","with data:"+n);var o=this,i=require("http").request(s,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){if(o._logger.log("trace","do request reponse:"+e.statusCode),o._logger.log("trace",t),200==e.statusCode){var r={};try{var n=JSON.parse(t);n&&n.error?(r.error="unknown",n.error.message&&(r.error=n.error.message),n.error.code&&(r.errorCode=n.error.code)):r.data=n.result;}catch(e){}a&&a(r);}else a&&a(null);});});i.setTimeout(5e3,function(){o._logger.log("trace","do request timeout"),i.abort();}),i.on("error",function(e){o._logger.log("error","do request error:"+e.message),o._logger.log("error",e.stack),a&&a({error:e&&e.message?e.message:"http requeset error"});}),n&&i.write(n),i.end();},xnm.aio.symcon.Server.prototype._scanInstanceFunctions=function(e,t){var a=this;this._doRequest("IPS_GetFunctionList",[e],function(e){if(e){if(e.error)t(new Error(e.error));else{var r=[];if(e.data)for(var n=e.data.length,s=0;s<e.data.length;s++){var o=e.data[s];"IPS_"==o.substr(0,4)?0==--n&&t(null,r):functions[o]?(n--,r.push(functions[o])):a._scanFunction(e.data[s],function(e,a){n--,!e&&a&&(functions[a.FunctionName]=a,r.push(a)),0==n&&t(null,r);});}else t(null,r);}}else t(new Error("http error"));});},xnm.aio.symcon.Server.prototype._scanFunction=function(e,t){this._doRequest("IPS_GetFunction",[e],function(e){if(e){if(e.error)t(new Error(e.error));else{var a=null;e&&e.data&&(a=e.data),t(null,a);}}else t(new Error("http error"));});},xnm.aio.symcon.Server.prototype._scanWebfront=function(e){this._doRequest("WFC_GetConfigurators",[],function(t){if(t){if(t.error)e(new Error(t.error));else{var a=[];t&&t.data&&t.data.length>0&&t.data.forEach(function(e){e.id&&a.push({id:e.id,requirepwd:e.password});}),e(null,a);}}else e(new Error("http error"));});},xnm.aio.symcon.Server.prototype.scanObjects=function(e,t){var _contains=function _contains(e,t){if(!e||!t)return null;for(var a=0;a<e.length;a++){if(e[a]===t)return!0;}return!1;},_scanFinish=function _scanFinish(e,t,a){e._scanListener.forEach(function(e){e.finish&&"function"==typeof e.finish&&e.finish(t,a);}),e._scanCallbacks.forEach(function(e){e&&e(t,a);}),e._scanning=!1,e._scanCallbacks=[],e._scanListener=[];},_scanNextObject=function _scanNextObject(e,t,a,r){if(0!=t.length){var n=t.pop();e._doRequest("IPS_GetObject",[n],function(n){if(n){if(n.error)_scanNextObject(e,t,a,r);else if(e._scanListener.forEach(function(e){e.one&&"function"==typeof e.one&&e.one();}),n.data){var s=n.data.ObjectID;switch(n.data.ObjectType){case 1:var o=n.data.ChildrenIDs;o&&o.length>0&&!a.instances[s]&&(a.instances[s]={name:n.data.ObjectName,type:1,objectid:s}),_scanNextObject(e,t,a,r);break;case 2:a.variables[s]?_scanNextObject(e,t,a,r):(a.variables[s]={name:n.data.ObjectName,parentid:n.data.ParentID,type:2,objectid:s},function(e,t,a){e._doRequest("IPS_GetVariable",[t],function(e){if(e){if(e.error)a(new Error(e.error));else{var r=null;if(e&&e.data)if((r={}).id=t,null!=e.data.VariableType&&void 0!==e.data.VariableType)r.valuetype=parseInt(e.data.VariableType),r.value=e.data.VariableValue;else if(null!=e.data.VariableValue&&void 0!==e.data.VariableValue){var n=e.data.VariableValue;if(null!=n.ValueType&&void 0!==n.ValueType)switch(r.valuetype=n.ValueType,parseInt(r.valuetype)){case 0:r.value=n.ValueBoolean;break;case 1:r.value=n.ValueInteger;break;case 2:r.value=n.ValueFloat;break;case 3:r.value=n.ValueString;}}a(null,r);}}else a(new Error("http error"));});}(e,s,function(n,o){n?r(n):(o&&(a.variables[s].valuetype=o.valuetype,a.variables[s].value=o.value),_scanNextObject(e,t,a,r));}));break;case 3:a.scripts[s]||(a.scripts[s]={name:n.data.ObjectName,parentid:n.data.ParentID,hidden:n.data.ObjectIsHidden,type:3,objectid:s}),_scanNextObject(e,t,a,r);break;default:_scanNextObject(e,t,a,r);}}else _scanNextObject(e,t,a,r);}else r(new Error("http error"));});}else r(null,a);},_buildTree=function _buildTree(e){var t,a={},r={};for(t in e.variables){if(e.variables.hasOwnProperty(t))if(e.variables[t].parentid){var n=e.instances[e.variables[t].parentid];n?(n.variables||(n.variables=[]),n.variables.push(e.variables[t])):r[t]=e.variables[t];}else r[t]=e.variables[t];}for(t in a.instances={},e.instances){e.instances.hasOwnProperty(t)&&e.instances[t]&&e.instances[t].variables&&e.instances[t].variables.length>0&&(a.instances[t]=e.instances[t]);}return a.scripts=e.scripts,a.variables=r,a;};if(t&&!_contains(this._scanCallbacks,t)&&this._scanCallbacks.push(t),e&&!_contains(this._scanListener,e)&&this._scanListener.push(e),!this._scanning){this.scripts={},this.instances={};var a=this;this._scanListener.forEach(function(e){e.start&&"function"==typeof e.start&&e.start();}),this._doRequest("IPS_GetObjectList",[],function(e){var t;e?e.error&&(t=new Error(e.error)):t=new Error("http request error"),t?_scanFinish(a,t):e.data&&0!=e.data.length?(a._scanListener.forEach(function(t){t.total&&"function"==typeof t.total&&t.total(e.data.length);}),function(e,t,a){_scanNextObject(e,t,{instances:{},variables:{},scripts:{}},function(t,r){if(t)a(t);else{var n=_buildTree(r);e.instances=n.instances,e.scripts=n.scripts,e.variables=n.variables,a(null,n);}});}(a,e.data,function(e,t){_scanFinish(a,e,t);})):_scanFinish(a,t,{instance:{},scripts:{}});});}},xnm.aio.symcon.Server.prototype.getState=function(e,t,a){a&&this._doRequest(t?"GetValueFormatted":"GetValue",[e.id],function(e){if(!e){var t=new Error("http request error");return t._code=1,void(a&&a(t));}e.error?a&&a(new Error(e.error)):a&&a(null,e.data);});},xnm.aio.symcon.Server.prototype.executeCommand=function(e,t,a){var r=!1;"on"==t&&(r=!0),this._doRequest("SetValue",[e.id,r],function(e){a&&a();});},xnm.aio.symcon.Server.prototype.getStates=function(e,t,a){},xnm.aio.symcon.Server.prototype.getStateValues=function(e,t){return sv;},xnm.aio.symcon.Server.prototype._getVariableFromInstance=function(e,t){if(!t.variables)return null;for(var a=0;a<t.variables.length;a++){if(t.variables[a].objectid==e)return t.variables[a];}return null;},xnm.aio.symcon.Server.prototype.executeCommandCreator=function(e,t,a){if(e&&e.objectid&&t&&t.value){var r=t.value,n=e.objectid,s=r.indexOf("#");s>0&&(n=r.substr(0,s),r=r.substr(s+1));var o,i=e.parentid?e.parentid:0;if(1==e.type){var u=this._getVariableFromInstance(n,e);if(!u)return void(a&&a(new Error("no such variable")));u.parentid&&(i=u.parentid),e=u;}switch(parseInt(e.type)){case 2:switch(parseInt(e.valuetype)){case 0:"on"==r?o=!0:"off"==r&&(o=!1);break;case 1:"setValue"==r&&(o=parseInt(t.ext));break;case 2:"setValue"==r&&(o=parseFloat(t.ext));break;case 3:"setValue"==r&&(o=t.ext);}break;case 3:"run"==r&&(o=0);break;default:return void(a&&a(new Error("device type not supported")));}if(null!=o&&void 0!==o){if(this.webid){var l=this,c="WFC_Execute",d=[parseInt(this.webid),parseInt(i),parseInt(n),o];"5.0"==this.ver&&(c="RequestAction",d=[parseInt(n),o]),this._doRequest(c,d,function(e){var r;if(e){if(e.error){var s,i;if(l._logger.log("trace","execute command error:"+JSON.stringify(e)),r=new Error(e.error),e.errorCode)return"run"==t.value?(s="IPS_RunScript",i=[parseInt(n)]):(s="SetValue",i=[parseInt(n),o]),void l._doRequest(s,i,function(e){var t;e?e.error&&(t=new Error(e.error)):t=new Error("http requeset error"),a&&a(t);});}}else r=new Error("http requeset error");a&&a(r);});}else a&&a(new Error("no web front object id"));}else a&&a(new Error("command invalid"));}else a&&a(new Error("argument invalid"));},xnm.aio.symcon.Server.prototype.getStatesCreator=function(e,t,a){if(t&&0!=t.length){for(var r=!0,n={},s={},o=0;o<t.length;o++){if(t[o]&&t[o].device&&t[o].id){var i=t[o].device.objectid,u=t[o].status.value,l=t[o].status.value.indexOf("#");l>0&&(u=t[o].status.value.substr(l+1)),1==t[o].device.type&&t[o].status.value&&l>0&&(i=t[o].status.value.substr(0,l)),i&&(r=!1,"stateF"==u?(n[i]||(n[i]=[]),n[i].push(t[o])):(s[i]||(s[i]=[]),s[i].push(t[o])));}}if(r)a&&a(null,[]);else{var c=this;this._getNextState(0,Object.keys(s),{},function(e,t){if(e)a&&a(e);else{var r=[];if(t)for(var o in t){if(t.hasOwnProperty(o)){var i=s[o];if(i&&i.length>0)for(var u=0;u<i.length;u++){var l=c._resolveState(i[u].device,i[u].status,t[o]);null!=l&&void 0!==l&&r.push({id:i[u].id,status:l});}}}c._getNextFormattedState(0,Object.keys(n),{},function(e,t){if(e)a&&a(null,r);else{if(t)for(var s in t){if(t.hasOwnProperty(s)){var o=n[s];if(o&&o.length>0)for(var i=0;i<o.length;i++){var u=c._resolveState(o[i].device,o[i].status,t[s]);null!=u&&void 0!==u&&r.push({id:o[i].id,status:u});}}}a&&a(null,r);}});}});}}else a&&a(null,[]);},xnm.aio.symcon.Server.prototype._resolveState=function(e,t,a){if(!e||!t)return null;if(null==a||void 0===a)return null;var r=!1;"stateF"==t.value&&(r=!0);var n=t.value.indexOf("#");n>0&&"stateF"==t.value.substr(n+1)&&(r=!0);if(1==e.type){var s=e.objectid;n>0&&(s=t.value.substr(0,n));var o=this._getVariableFromInstance(s,e);if(!o)return null;e=o;}if(r)return a;switch(parseInt(e.valuetype)){case 0:if("string"==typeof a)if("true"==a.toLowerCase())a=!0;else{if("false"!=a.toLowerCase())return null;a=!1;}return a?"on":"off";case 1:return parseInt(a);case 2:return parseFloat(a).toFixed(2);case 3:return a.toString();default:return null;}},xnm.aio.symcon.Server.prototype._getNextState=function(e,t,a,r){if(e!=t.length){var n=this,s=t[e];"string"==typeof s&&(s=parseInt(s)),this.getState({id:s},!1,function(s,o){s&&1==s._code?r&&r(s):(s||null==o||void 0===o||(a[t[e]]=o),e+=1,n._getNextState(e,t,a,r));});}else r&&r(null,a);},xnm.aio.symcon.Server.prototype._getNextFormattedState=function(e,t,a,r){if(e!=t.length){var n=this,s=t[e];"string"==typeof s&&(s=parseInt(s)),this.getState({id:s},!0,function(s,o){s&&1==s._code?r&&r(s):(s||null==o||void 0===o||(a[t[e]]=o),e+=1,n._getNextFormattedState(e,t,a,r));});}else r&&r(null,a);},xnm.aio.symcon.Server.prototype.toJSON=function(){return{sys:xnm.aio.symcon.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,webid:this.webid,webpwd:this.webpwd,ver:this.ver};},xnm.aio.symcon.Server.prototype.equalsTo=function(e){return!!e&&e instanceof xnm.aio.symcon.Server&&this.ip==e.ip&&this.port==e.port&&this.user==e.user&&this.password==e.password;},xnm.aio.symcon.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="IPSymconDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"ipsync",getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"IP-Symcon",port:82};},createGateway:function createGateway(e,t,a){var r=DMError,n=DMError.ERROR_CODE;e?e.ip?e.port?e.password?a(null,e):a(new r(n.INVALID,"password is invalid")):a(new r(n.INVALID,"port is invalid")):a(new r(n.INVALID,"ip is invalid")):a(new r(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,r){var n=DMError,s=DMError.ERROR_CODE;t?t.ip?t.port?t.password?r(null,t):r(new n(s.INVALID,"password is invalid")):r(new n(s.INVALID,"port is invalid")):r(new n(s.INVALID,"ip is invalid")):r(new n(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var r=DMError,n=DMError.ERROR_CODE;if(e){if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,o,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){o=i[s];break;}}o?e.type?e.objectid?a(null,e):a(new r(n.INVALID,"address is invalid")):a(new r(n.INVALID,"type is invalid")):a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.INVALID,"gateway is invalid"));}else a(new r(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var r=DMError,n=DMError.ERROR_CODE;if(e){if(e.gateway){var s,o,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){o=i[s];break;}}o?e.type?e.objectid?a(null,e):a(new r(n.INVALID,"address is invalid")):a(new r(n.INVALID,"type is invalid")):a(new r(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new r(n.INVALID,"gateway is invalid"));}else a(new r(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},getCommandStatusMap:function getCommandStatusMap(e){var _getVariableMap=function _getVariableMap(e){if(null==e.valuetype||void 0===e.valuetype)return null;var t;switch(parseInt(e.valuetype)){case 0:t={command:[{type:"enum",name:"on",ref:{value:"on"}},{type:"enum",name:"off",ref:{value:"off"}}],status:[{type:"enum",name:"status",ref:{value:"state",options:["off","on"]}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;case 1:t={command:[{type:"int",name:"set value",ref:{value:"setValue",ext:"%d"}}],status:[{type:"int",name:"status",ref:{value:"state",ext:"%d"}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;case 2:t={command:[{type:"float",name:"set value",ref:{value:"setValue",ext:"%f"}}],status:[{type:"float",name:"status",ref:{value:"state",ext:"%f"}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;case 3:t={command:[{type:"string",name:"set value",ref:{value:"setValue",ext:"%s"}}],status:[{type:"string",name:"status",ref:{value:"state",ext:"%s"}},{type:"string",name:"formatted status",ref:{value:"stateF"}}]};break;default:return null;}return t&&(t.command&&t.command.forEach(function(t){t.name=e.name?e.name+" "+t.name:t.name,t.ref.value=e.objectid+"#"+t.ref.value;}),t.status&&t.status.forEach(function(t){t.name=e.name?e.name+" "+t.name:t.name,t.ref.value=e.objectid+"#"+t.ref.value;})),t;};if(null==e.type||void 0===e.type)return null;switch(parseInt(e.type)){case 1:if(e.variables){var t=[],a=[];return e.variables.forEach(function(e){var r=_getVariableMap(e);r&&r.command&&(t=t.concat(r.command)),r&&r.status&&(a=a.concat(r.status));}),{command:t,status:a};}return null;case 2:return _getVariableMap(e);case 3:return{command:[{type:"enum",name:"run",ref:{value:"run"}}]};default:return null;}},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,r=0;r<e.length;r++){if(e[r]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var a=[],r=null,n=xnm.aio.symcon.DM.getCommandStatusMap(e);return n&&(r=function(e,t,a){var r=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));r.push(t);}});}return r;}(n,0,t),a=a.concat(r)),a;};if(!e.sys)return null;var a=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),a.command=r;break;case"status":r=_filter(e,t),a.status=r;break;default:return null;}return r&&0!=r.length?a:null;}};}(),xnm.aio.symcon.Handler=function(){},xnm.aio.symcon.Handler.prototype.Server=xnm.aio.symcon.Server,xnm.aio.symcon.Handler.prototype.getStateValues=function(e,t){return new xnm.aio.symcon.Server().getStateValues(e.type,t);},xnm.aio.symcon.Handler.prototype.getDeviceCommandList=function(e,t){return[];},xnm.aio.symcon.Handler.prototype.TYPE_BOOL=xnm.aio.symcon.TYPE_BOOL,xnm.aio.symcon.Handler.prototype.TYPE_INT=xnm.aio.symcon.TYPE_INT,xnm.aio.symcon.Handler.prototype.TYPE_FLOAT=xnm.aio.symcon.TYPE_FLOAT,xnm.aio.symcon.Handler.prototype.TYPE_STRING=xnm.aio.symcon.TYPE_STRING,xnm.aio.symcon.Handler.prototype.devicemanager=xnm.aio.symcon.DM,xnm.aio.symcon.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"symcon");},xnm.aio.symcon.Handler.prototype.resolveGateway=function(e){return e&&e.ip&&e.password?new xnm.aio.symcon.Server(e.ip,e.port,e.username,e.password,e.webid,e.webpwd,e.ver):null;},xnm.aio.symcon.Handler.prototype.getWebfronts=function(e,t){var a=this.resolveGateway(e);a?a._scanWebfront(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json invalid"));},xnm.aio.symcon.Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.scanObjects(null,function(e,a){var r,n={webfront:[],devices:[]};if(!e&&a){for(r in a.instances){a.instances.hasOwnProperty(r)&&n.devices.push(a.instances[r]);}for(r in a.scripts){a.scripts.hasOwnProperty(r)&&n.devices.push(a.scripts[r]);}for(r in a.variables){a.variables.hasOwnProperty(r)&&n.devices.push(a.variables[r]);}n.webfront=a.webfront;}t&&t(e,n);}):t&&t(new Error("gateway json invalid"));},xnm.aio.symcon.Handler.prototype.getDeviceCommands=function(e,t){var a=xnm.aio.symcon.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),r=a?a.command:[];t&&t(null,r);},xnm.aio.symcon.Handler.prototype.getDeviceStatus=function(e,t){var a=xnm.aio.symcon.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),r=a?a.status:[];t&&t(null,r);},xnm.aio.symcon.Handler.prototype.doCommand=function(e,t,a,r){var n=this.resolveGateway(e);n?n.executeCommandCreator(t,a,function(e){r&&r(e);}):r&&r(new Error("gateway json invalid"));},xnm.aio.symcon.Handler.prototype.doStatus=function(e,t,a,r,n){var s=this.resolveGateway(t);if(s){var o=[{id:e,device:a,status:r}];s.getStatesCreator(null,o,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.symcon.Handler());