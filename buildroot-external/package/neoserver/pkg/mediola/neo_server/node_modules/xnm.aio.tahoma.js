var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.tahoma=xnm.aio.tahoma||{},xnm.aio.tahoma.Box=function(){var e={_cache:{},getCookie:function getCookie(e,t){if(!e&&!t)return null;var a=e||"",n=t||"";return this._cache[a+":"+n];},setCookie:function setCookie(e,t,a){if(!e&&!t)return null;var n=e||"",o=t||"";this._cache[n+":"+o]=a;}},Box=function Box(e,t,a){this._logger=require("x.logger.js").getLogger("xnm.aio.tahoma.Box"),this.username=String(e).toLowerCase(),this.password=t;};return Box.prototype.executeCommandCreator=function(e,t,a){this.executeCommand(e,t,function(e){a&&a(e);});},Box.prototype.getStatesCreator=function(e,t,a){if(t){if(0!=t.length){for(var n=[],o=0;o<t.length;o++){if(t[o]&&t[o].device&&t[o].device.address&&t[o].status&&t[o].status.value){for(var s=t[o].device.address,r=!1,i=0;i<n.length;i++){if(n[i].address==s){r=!0;var u=n[i].states;-1==u.indexOf(t[o].status.value)&&u.push(t[o].status.value);}}r||n.push({address:s,states:[t[o].status.value]});}}this.getStates(e,n,function(e,n){var o=[];if(!e&&n)for(var s=0;s<t.length;s++){if(t[s]&&t[s].id){var r="?";if(t[s].device&&t[s].device.address&&t[s].status&&t[s].status.value)for(var i=0;i<n.length;i++){if(n[i].address==t[s].device.address){n[i].states;r=n[i].states[t[s].status.value];}}r||(r="?"),o.push({id:t[s].id,status:r});}}a&&a(null,o);});}else a&&a(null,[]);}else a&&a(new Error("deviceList is null"));},Box.prototype.executeCommand=function(e,t,a){if(e&&e.address){if(t&&t.value){var n,o={actions:[]},s={deviceURL:e.address,commands:[]};switch(o.actions.push(s),t.value){case"on":case"off":case"close":case"down":case"my":case"open":case"reset":case"stop":case"up":s.commands.push({name:t.value});break;case"setOnOff":if(!t.ext||"on"!=t.ext&&"off"!=t.ext)return void(a&&a(new Error("command ext invalid")));s.commands.push({name:t.value,parameters:[t.ext]});break;case"onWithTimer":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command ext invalid")));(n=parseInt(t.ext))<5&&(n=5),n>14400&&(n=14400),s.commands.push({name:t.value,parameters:[n]});break;case"setIntensity":if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("command ext invalid")));(n=parseInt(t.ext))<0&&(n=0),n>100&&(n=100),s.commands.push({name:t.value,parameters:[n]});break;default:return void(a&&a(new Error("command unknown")));}var r=this;this.getExecutionID(e.address,function(e,n){e?a&&a(e):n?"stop"==t.value||"my"==t.value?r._cancelExecution(n,a):a&&a(new Error("device running")):r._apply(o,a);});}else a&&a(new Error("command invaild"));}else a&&a(new Error("device invaild"));},Box.prototype.getStates=function(e,t,a){if(t&&0!=t.length){for(var n=[],o=0;o<t.length;o++){if(t[o]&&t[o].address&&t[o].states&&t[o].states.length>0){for(var s={deviceURL:t[o].address,states:[]},r=0;r<t[o].states.length;r++){s.states.push({name:t[o].states[r]});}n.push(s);}}this._getStates(n,function(e,t){if(e)a&&a(e);else if(t&&t.devices){for(var n=[],o=0;o<t.devices.length;o++){var s=t.devices[o];if(s&&s.deviceURL&&s.states&&s.states.length>0){for(var r={address:s.deviceURL,states:{}},i=0;i<s.states.length;i++){r.states[s.states[i].name]=s.states[i].value;}n.push(r);}}a&&a(null,n);}else a&&a(new Error("get states return invalid response"));});}else a&&a(null,[]);},Box.prototype.listDevices=function(e){this._getSetup(function(t,a){if(t)e&&e(t);else if(a&&a.setup){var n={places:{},devices:[]},o=a.setup.rootPlace;n.places=o;for(var s=a.setup.devices,r=0;r<s.length;r++){var i=s[r],u={sys:"tahoma",name:i.label,address:i.deviceURL,placeOID:i.placeOID,type:i.uiClass,definition:i.definition};n.devices.push(u);}e&&e(null,n);}else e&&e(new Error("get setup return format invalid"));});},Box.prototype.getExecutionID=function(e,t){this._getCurrentExecutions(function(a,n){if(a)t&&t(a);else if(n&&n.executions){for(var o=!1,s=null,r=0;r<n.executions.length;r++){var i=n.executions[r];if(i&&i.actionGroup&&i.actionGroup.actions){for(var u=i.actionGroup.actions,l=0;l<u.length;l++){var d=u[l];if(d&&d.deviceURL==e){o=!0;break;}}if(o){s=i.id;break;}}}t&&t(null,s);}else t&&t(null,null);});},Box.prototype._cancelExecution=function(e,t){this._doExecRequest("DELETE","/current/setup/"+e,null,function(e){t&&t(e);});},Box.prototype._getCurrentExecutions=function(e){this._doJsonRequest("/getCurrentExecutions",null,function(t,a){e&&e(t,a);});},Box.prototype._apply=function(e,t){this._doJsonRequest("/apply",JSON.stringify(e),function(e,a){t&&t(e,a);});},Box.prototype._getStates=function(e,t){this._doJsonRequest("/getStates",JSON.stringify(e),function(e,a){t&&t(e,a);});},Box.prototype._getSetup=function(e){this._doJsonRequest("/getSetup",null,function(t,a){e&&e(t,a);});},Box.prototype._login=function(t){var a="userId="+encodeURIComponent(this.username)+"&userPassword="+encodeURIComponent(this.password),n=this;this._logger.log("debug","do login request with data:"+a),this._doRequest("POST","/externalAPI/json/login",{"Content-Type":"application/x-www-form-urlencoded"},a,function(a,o,s){if(a)return n._logger.log("warn","login failed with error:"+a.message),void(t&&t(a));if(s&&200==s.statusCode)try{var r=JSON.parse(o);if(r.success){if(s.headers&&s.headers["set-cookie"]){var i=s.headers["set-cookie"];i.constructor===Array&&(i=i.join(";")),n._logger.log("debug","login success with cookie:"+i),e.setCookie(n.username,n.password,i);}t&&t(null,r);}else n._logger.log("warn","login failed with success not true:"+o),t&&t(new Error("login fail"),r);}catch(e){n._logger.log("warn","login error with invalid json response:"+o),t&&t(new Error("login error with invalid json response"));}else n._logger.log("warn","login error with status code:"+(s?s.statusCode:-1)+" data:"+o),t&&t(new Error("login error with status code:"+(s?s.statusCode:-1)));});},Box.prototype._doJsonRequest=function(e,t,a){var n=this;this._logger.log("debug","do json request "+e+" data:"+JSON.stringify(t)),this._doRequest("POST","/externalAPI/json"+e,{"Content-Type":"application/json"},t,function(o,s,r){if(o)a&&a(o);else{if(r&&401==r.statusCode)return n._logger.log("warn","do json request return 401, try to login again"),void n._login(function(o){o?a&&a(o):n._doJsonRequest(e,t,a);});if(n._logger.log("debug","do json request return status code "+(r?r.statusCode:-1)),o=!r||200!=r.statusCode&&204!=r.statusCode?new Error("http error with status code "+(r?r.statusCode:-1)):null)n._logger.log("warn","do json request return "+r.statusCode+" data:"+s),a&&a(o,s);else try{var i=JSON.parse(s);a&&a(null,i);}catch(e){n._logger.log("warn","do json request return invalid json: "+s),a&&a(e);}}});},Box.prototype._doExecRequest=function(e,t,a,n){var o=this;this._logger.log("debug","do exec request "+t+" data:"+JSON.stringify(a)),this._doRequest(e,"/enduserAPI/exec"+t,null,a,function(s,r,i){if(s)n&&n(s);else{if(i&&401==i.statusCode)return o._logger.log("warn","do exec request return 401, try to login again"),void o._login(function(s){s?n&&n(s):o._doExecRequest(e,t,a,n);});o._logger.log("debug","do exec request return status code "+(i?i.statusCode:-1)),(s=!i||200!=i.statusCode&&204!=i.statusCode?new Error("http error with status code "+(i?i.statusCode:-1)):null)?(o._logger.log("warn","do exec request return "+i.statusCode+" data:"+r),n&&n(s,r)):n&&n(null,r);}});},Box.prototype._doRequest=function(t,a,n,o,s){var r={host:"www.tahomalink.com",port:443,path:"/enduser-mobile-web"+a,method:t,headers:{Connection:"close","Content-Type":"application/x-www-form-urlencoded"}};if(n)for(var i in n){n.hasOwnProperty(i)&&(r.headers[i]=n[i]);}o&&(r.headers["Content-Length"]=o.length);var u=e.getCookie(this.username,this.password);u&&(r.headers.Cookie=u);var l=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),-1!=r.path.indexOf("/externalAPI/json/login")?this._logger.log("trace","do request: /externalAPI/json/login with username & password"):this._logger.log("trace","do request:"+JSON.stringify(r));var d=this,c=s,f=l.request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){d._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),c&&(c(null,t,e),c=null);});});f.on&&f.on("error",function(e){d._logger.log("trace","do request error:"+e.message),c&&(c(e),c=null);}),f.setTimeout&&f.setTimeout(2e3,function(){d._logger.log("trace","do request timeout"),f.abort(),c&&(c(new Error("timeout")),c=null);}),f.setAllowRedirect&&f.setAllowRedirect(!1),o&&(this._logger.log("trace","do request send body:"+o),f.write(o)),f.end();},Box.prototype.toJSON=function(){return{sys:"tahoma",username:this.username,password:this.password};},Box.prototype.equalsTo=function(e){return!!e&&e instanceof Box&&this.username==e.username&&this.password==e.password;},Box;}(),xnm.aio.tahoma.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="TahomaDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"tahoma",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"TaHoma Box"}];},getGatewayDeviceType:function getGatewayDeviceType(){return[{sys:this.SYS,type:"Light",name:"Light"},{sys:this.SYS,type:"OnOff",name:"Switch"},{sys:this.SYS,type:"RollerShutter",name:"Blind"}];},createGateway:function createGateway(e,t,a){var n=DMError,o=DMError.ERROR_CODE;e?e.username?e.password?a(null,e):a(new n(o.INVALID,"password is invalid")):a(new n(o.INVALID,"username is invalid")):a(new n(o.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,n){var o=DMError,s=DMError.ERROR_CODE;t?t.username?t.password?n(null,t):n(new o(s.INVALID,"password is invalid")):n(new o(s.INVALID,"username is invalid")):n(new o(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var n=DMError,o=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,r,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){r=i[s];break;}}r?a(null,e):a(new n(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(o.INVALID,"type is invalid"));}else a(new n(o.INVALID,"address is invalid"));}else a(new n(o.INVALID,"gateway is invalid"));}else a(new n(o.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var n=DMError,o=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,r,i=t.data.gateways;for(s=0;s<i.length;s++){if(i[s].index===e.gateway){r=i[s];break;}}r?a(null,e):a(new n(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(o.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new n(o.INVALID,"type is invalid"));}else a(new n(o.INVALID,"address is invalid"));}else a(new n(o.INVALID,"gateway is invalid"));}else a(new n(o.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var a=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,n=0;n<e.length;n++){if(e[n]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var n=[],o=null,s=a.getCommandStatusMap(e);return s&&(o=function(e,t,a){var n=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(s,0,t),n=n.concat(o)),n;};if(!e||null==e.type||void 0===e.type)return null;var n=JSON.parse(JSON.stringify(e)),o=null;switch(t.catagory){case"command":o=_filter(e,t),n.command=o;break;case"status":o=_filter(e,t),n.status=o;break;default:return null;}return o&&0!=o.length?n:null;},getCommandStatusMap:function getCommandStatusMap(e){if(!e||!e.definition)return null;var t={command:[],status:[]},a=e.definition.commands;a&&a.forEach(function(e){if(e)switch(e.commandName){case"on":t.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case"off":t.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case"setOnOff":t.command.push({type:"enum",name:"set on/off",ref:{value:"setOnOff",ext:"%e",extMeta:["on","off"]}});break;case"onWithTimer":t.command.push({type:"int",name:"on for",ref:{value:"onWithTimer",ext:"%d",extMeta:"5-14400"}});break;case"close":t.command.push({type:"enum",name:"close",ref:{value:"close"}});break;case"down":t.command.push({type:"enum",name:"down",ref:{value:"down"}});break;case"my":t.command.push({type:"enum",name:"my",ref:{value:"my"}});break;case"open":t.command.push({type:"enum",name:"open",ref:{value:"open"}});break;case"reset":t.command.push({type:"enum",name:"reset",ref:{value:"reset"}});break;case"stop":t.command.push({type:"enum",name:"stop",ref:{value:"stop"}});break;case"up":t.command.push({type:"enum",name:"up",ref:{value:"up"}});break;case"setIntensity":t.command.push({type:"int",name:"dim to",ref:{value:"setIntensity",value_t:"dimTo",ext:"%d"}});}});var n=e.definition.states;return n&&n.forEach(function(e){if(e)switch(e.qualifiedName){case"core:OnOffState":t.status.push({type:"enum",name:"on/off state",ref:{value:"core:OnOffState",options:["on","off"]}});break;case"core:LightIntensityState":t.status.push({type:"int",name:"dimmer level",ref:{value:"core:LightIntensityState",ext:"%d"}});}}),t;}};}(),xnm.aio.tahoma.Handler=function(){this.detectedHomebases={};},xnm.aio.tahoma.Handler.prototype.Box=xnm.aio.tahoma.Box,xnm.aio.tahoma.Handler.prototype.devicemanager=xnm.aio.tahoma.DM,xnm.aio.tahoma.Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"tahoma");},xnm.aio.tahoma.Handler.prototype.resolveGateway=function(e){return e&&e.username?new this.Box(e.username,e.password):null;},xnm.aio.tahoma.Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),n=a?a.command:[];t&&t(null,n);},xnm.aio.tahoma.Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),n=a?a.status:[];t&&t(null,n);},xnm.aio.tahoma.Handler.prototype.doCommand=function(e,t,a,n){var o=this.resolveGateway(e);o?o.executeCommandCreator(t,a,function(e){n&&n(e);}):n&&n(new Error("gateway json format invalid"));},xnm.aio.tahoma.Handler.prototype.doStatus=function(e,t,a,n,o){var s=this.resolveGateway(t);if(s){var r=[{id:e,device:a,status:n}];s.getStatesCreator(null,r,function(e,t){e?o&&o(e):o&&o(null,t[0]);});}else o&&o(new Error("gateway json format invalid"));},xnm.aio.tahoma.Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.listDevices(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.tahoma.Handler());