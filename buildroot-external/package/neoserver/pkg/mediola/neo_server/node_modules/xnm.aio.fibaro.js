function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.fibaro=xnm.aio.fibaro||{},xnm.aio.fibaro.Util={clearHttpOptionForLog:function clearHttpOptionForLog(e){try{var t=JSON.parse(JSON.stringify(e));if(t.auth&&(t.auth="xxxxxx:xxxxxx"),t.headers)for(var a in headers){if(a&&"authorization"==a.toLocaleLowerCase()){var s=headers[a];if(s){var r=s.indexOf(" ");headers[a]=-1==r?"xxxxxx":s.substr(0,r)+" xxxxxx";}}}return t;}catch(t){return e;}}},xnm.aio.fibaro.HomeCenter=function(){var HomeCenter=function HomeCenter(e,t,a,s,r){var n=require("x.logger.js");this._logger=n?n.getLogger("xnm.aio.fibaro.HomeCenter"):{log:function log(){}},this.ip=e,this.uuid=s,this.user=t,this.password=a,this.name=r,this.CommandHandler=null,this._getStatesCBs=[];};return HomeCenter.ACTION_LIST=["turnOn","turnOff","setValue","startLevelIncrease","startLevelDecrease","stopLevelChange","close","open","stop","pressButton","setArmed","setSetpointMode","setThermostatSetpoint","setMode","setFanMode","setTargetLevel","setTime","setColor","startProgram","setSlider"],HomeCenter.PROPERTY_LIST=["value","state","batteryLevel","power"," energy","armed"," tamper","on"," mute"," volume","mode","targetLevel","wakeUpTime","Humidity"," Pressure"," Temperature"," WeatherCondition"," Wind"],HomeCenter.SET_POINT_MODES=["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"],HomeCenter.OP_MODES=["OFF","HEATING","COOLING","AUTO","PENDING_HEAT","PENDING_COOL","VENT_ECONOMIZER","AUX_HEATING","2ND_STAGE_HEATING","2ND_STAGE_COOLING","2ND_STAGE_AUX_HEAT","3RD_STAGE_AUX_HEAT"],HomeCenter.FAN_MODES=["AUTO_LOW","LOW","AUTO_HIGH","HIGH","AUTO_MEDIUM","MEDIUM","CIRCULATION","HUMIDITY","LEFT_RIGHT","UP_DOWN","QUIET","3RD_STAGE_AUX_HEAT"],HomeCenter.prototype._callAction=function(e,t,a,s){for(var r="/api/callAction?deviceID="+e+"&name="+t,n=0;n<a.length;n++){r+="&arg"+(n+1)+"="+encodeURIComponent(a[n]);}this._doRestApi("GET",r,null,function(e,t){s&&s(e,t);});},HomeCenter.prototype._getRooms=function(e){this._doRestApi("GET","/api/rooms",null,function(t,a){e&&e(t,a);});},HomeCenter.prototype._getDevices=function(e){this._doRestApi("GET","/api/devices",null,function(t,a){e&&e(t,a);});},HomeCenter.prototype._getGlobalVariables=function(e){this._doRestApi("GET","/api/globalVariables",null,function(t,a){e&&e(t,a);});},HomeCenter.prototype._setGlobalVariableValue=function(e,t,a){var s={name:e,value:t+""};this._doRestApi("PUT","/api/globalVariables/"+e,JSON.stringify(s),function(e,t){a&&a(e,t);});},HomeCenter.prototype._doRestApi=function(e,t,a,s){this._doRequest(e,t,a,function(e,t,a){if(e)return"timeout"==e.reason?e.code=2:e.code=1,void(s&&s(e));if(200!=a&&202!=a)return(e=new Error("http result status code:"+a)).code=a,void(s&&s(e));try{var r=JSON.parse(t);s&&s(null,r);}catch(e){e.code=3,s&&s(e);}});},HomeCenter.prototype._doRequest=function(e,t,a,s){var r={host:this.ip,path:t,method:e,headers:{Authorization:"Basic "+new Buffer(this.user+":"+this.password).toString("base64"),Connection:"close","Content-Type":"text/plain"}};a&&(r.headers["Content-Length"]=a.length);var n=this,o=require("http");this._logger.log("trace","do http request:"+JSON.stringify(xnm.aio.fibaro.Util.clearHttpOptionForLog(r)));var i=o.request(r,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){n._logger.log("trace","receive http response:"+t+" with code:"+e.statusCode),s&&s(null,t,e.statusCode),s=null;});});i.on("error",function(e){n._logger.log("warn","do http request error:"+e.message),s&&s(e),s=null;}),i.setTimeout(4e3,function(){n._logger.log("warn","do http request timeout");var e=new Error("timeout");e.reason="timeout",s&&s(e),s=null;}),a&&i.write(a),i.end();},HomeCenter.prototype.executeCommandCreator=function(e,t,a){if(e&&e.address){if(t&&t.value){var s=t.value;if("global_variable"==e.type)s=t.ext;else if("setSetpointMode"==s){if(!t.ext)return void(a&&a(new Error("setSetpointMode invalid")));var _e=HomeCenter.SET_POINT_MODES.indexOf(t.ext);if(-1==_e)return void(a&&a(new Error("unknown setSetpointMode mode")));s+=_e;}else if(0==s.indexOf("setThermostatSetpoint")){if(!t.ext)return void(a&&a(new Error("setThermostatSetpoint invalid")));s+=":"+t.ext;}else if("setMode"==s){if(!t.ext)return void(a&&a(new Error("setMode invalid")));var _e2=HomeCenter.OP_MODES.indexOf(t.ext);if(-1==_e2)return void(a&&a(new Error("unknown setMode mode")));s+=_e2;}else if("setFanMode"==s){if(!t.ext)return void(a&&a(new Error("setFanMode invalid")));var _e3=HomeCenter.FAN_MODES.indexOf(t.ext);if(-1==_e3)return void(a&&a(new Error("unknown setFanMode mode")));s+=_e3;}else if(0==s.indexOf("setTargetLevel")){if(!t.ext)return void(a&&a(new Error("setTargetLevel invalid")));s+=t.ext;}else if(0==s.indexOf("setTime")){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("setTime invalid")));s+=t.ext;}else if("rgbw"==s){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("rgbw invalid")));s="setColor"+t.ext;}else if("startProgram"==s){if(void 0===t.ext||null==t.ext)return void(a&&a(new Error("startProgram invalid")));s+=t.ext;}else"pressButton"===s||s.startsWith("setSlider")?s=t:void 0!==t.ext&&null!=t.ext&&("setValue"==s&&(s+=t.ext),"disarm"==s&&(s+=t.ext));this.executeCommand(e,s,function(e,t){a&&a(e,t);});}else a&&a(new Error("command invalid"));}else a&&a(new Error("device invalid"));},HomeCenter.prototype.getStatesCreator=function(e,t,a){if(t){if(0!=t.length){if(t){for(var s=[],r=0;r<t.length;r++){var n=t[r];n&&n.device&&n.device.address&&s.push(n.device.address);}this.getStates(e,s,function(e,s,r){if(e)a&&a(e);else{var n=[];if(s)for(var o=0;o<t.length;o++){if(t[o]){var i=t[o].id,l=t[o].device,u=t[o].status;if(i&&u&&u.value&&l&&l.address){var f,d="?";if("global_variable"==l.type)f=r[l.address],d=parseInt(f);else if(f=s[l.address])switch(u.value){case"onoffValue":d="true"==(d=f.value)?"on":"off";break;case"intValue":d=f.value,d=parseInt(d);break;case"boolValue":d=f.value;break;case"floatValue":d=f.value,d=parseFloat(d);break;case"setpointMode":d=f.mode,d=HomeCenter.SET_POINT_MODES[parseInt(d)];break;case"opMode":d=f.mode,d=HomeCenter.OP_MODES[parseInt(d)];break;case"fanMode":d=f.mode,d=HomeCenter.FAN_MODES[parseInt(d)];break;default:d=f[u.value];}void 0!==d&&null!=d||(d="?"),n.push({id:i,status:d});}}}a&&a(null,n);}});}else a&&a(new Error("deviceList is null"));}else a&&a(null,[]);}else a&&a(new Error("deviceList is null"));},HomeCenter.prototype.getDevices=function(e){var t={},a={};t[0]={name:"Unassigned"};var s=this;this._getRooms(function(r,n){if(r)e&&e(r);else{if(n)for(var o=0;o<n.length;o++){t[n[o].id]={name:n[o].name,section:n[o].sectionID};}s._getDevices(function(r,n){if(r)e&&e(r);else{if(n)for(var o=0;o<n.length;o++){var i=n[o];i.visible&&"HC_user"!=i.type&&(a[i.id]={sys:"fibaro",name:i.name,address:i.id,room:i.roomID,type:i.type,baseType:i.baseType,actions:i.actions,states:i.properties});}s._getGlobalVariables(function(s,r){if(s)e&&e(s);else{for(var n={},o=0;o<r.length;o++){var i=r[o];i&&i.name&&(n[i.name]={sys:"fibaro",name:i.name,address:i.name,readOnly:i.readOnly,isEnum:i.isEnum,type:"global_variable"});}e&&e(null,{rooms:t,devices:a,variables:n});}});}});}});},HomeCenter.prototype.executeCommand=function(e,t,a){if("global_variable"==e.type)return void 0===t&&null==t?void(a&&a(new Error("command ext invalid"))):void this._setGlobalVariableValue(e.address,t,function(e){a&&a(e);});var s=t,r=[];if("number"==typeof t)s="setValue",r.push(t);else if("string"==typeof t){if("on"==t)s="turnOn";else if("off"==t)s="turnOff";else{if("toggle"==t){var n=this;return void this._getDevices(function(t,s){if(t)a&&a(t);else{for(var r=null,o=0;o<s.length;o++){var i=s[o];if(i.id&&i.properties&&i.id==e.address){"false"==i.properties.value?r="on":"true"==i.properties.value&&(r="off");break;}}r?n.executeCommand(e,r,a):a&&a(new Error("device has no on/off state"));}});}if("arm"==t)s="setArmed",r=[1];else if(0==t.indexOf("disarm"))(r=[0]).push(t.replace(/disarm/g,"")),s="setArmed";else if(0==t.indexOf("dimTo"))r.push(parseInt(t.replace(/dimTo/g,""))),s="setValue";else if(0==t.indexOf("moveTo"))r.push(parseInt(t.replace(/moveTo/g,""))),s="setValue";else if(0==t.indexOf("setTo"))r.push(parseInt(t.replace(/setTo/g,""))),s="setValue";else if(0==t.indexOf("setValue"))r.push(parseInt(t.replace(/setValue/g,""))),s="setValue";else if(0==t.indexOf("setSetpointMode"))r.push(parseInt(t.replace(/setSetpointMode/g,""))),s="setSetpointMode";else if(0==t.indexOf("setThermostatSetpoint")){var o=t.replace(/setThermostatSetpoint/g,"");o=o.split(":"),r.push(parseInt(o[0]),parseFloat(o[1])),s="setThermostatSetpoint";}else if(0==t.indexOf("setMode"))r.push(parseInt(t.replace(/setMode/g,""))),s="setMode";else if(0==t.indexOf("setFanMode"))r.push(parseInt(t.replace(/setFanMode/g,""))),s="setFanMode";else if(0==t.indexOf("setTargetLevel"))r.push(parseFloat(t.replace(/setTargetLevel/g,""))),s="setTargetLevel";else if(0==t.indexOf("setTime"))r.push(parseInt(t.replace(/setTime/g,""))),s="setTime";else if(0==t.indexOf("setColor")){var i=t.replace(/setColor/g,""),l=i.substr(0,2),u=i.substr(2,2),f=i.substr(4,2),d=i.substr(6,2);r=[parseInt(l,16),parseInt(u,16),parseInt(f,16),parseInt(d,16)],s="setColor";}else 0==t.indexOf("startProgram")?(r.push(parseInt(t.replace(/startProgram/g,""))),s="startProgram"):s=t;}}else if(t&&"object"==_typeof(t))if(s=t.value,"pressButton"===t.value){var _e4=t.ext.split(": ");r=[Number(_e4[0])];}else if(t.value.startsWith("setSlider")){s="setSlider";r=[Number(t.value.substring(9)),Number(t.ext)];}this._callAction(e.address,s,r,function(e,t){a&&a(e,t);});},HomeCenter.prototype.getStates=function(e,t,a){a||(a=function a(){});var s=this._getStatesCBs.length;if(-1==this._getStatesCBs.indexOf(a)&&this._getStatesCBs.push(a),!(s>0)){var r=this;this.CommandHandler=e,this._getGlobalVariables(function(e,a){if(e){var _t=r._getStatesCBs;r._getStatesCBs=[];for(var _a=0;_a<_t.length;_a++){_t[_a](e);}}else{var s={};for(var _e5=0;_e5<a.length;_e5++){var n=a[_e5];n&&n.name&&(s[n.name]=n.value);}r._getDevices(function(e,a){if(e){var _t2=r._getStatesCBs;r._getStatesCBs=[];for(var _a2=0;_a2<_t2.length;_a2++){_t2[_a2](e);}return;}var n={};for(var _e6=0;_e6<a.length;_e6++){var o=a[_e6];if(o.id&&o.properties&&(null==t||-1!=t.indexOf(o.id))){n[o.id]={};for(var _e7 in o.properties){-1!=HomeCenter.PROPERTY_LIST.indexOf(_e7)&&(n[o.id][_e7]=o.properties[_e7]);}Array.isArray(o.properties.rows)&&o.properties.rows.forEach(function(e){e&&Array.isArray(e.elements)&&"slider"===e.type&&e.elements.forEach(function(e){n[o.id]["sliderValue"+e.id]=e.value;});});}}var i=r._getStatesCBs;r._getStatesCBs=[];for(var _e8=0;_e8<i.length;_e8++){i[_e8](null,n,s);}});}});}},HomeCenter.prototype.getStateValues=function(e,t){return t;},HomeCenter.prototype.toJSON=function(){return{sys:"fibaro",ip:this.ip,username:this.user,password:this.password,uuid:this.uuid,name:this.name};},HomeCenter.prototype.equalsTo=function(e){return!!e&&e instanceof HomeCenter&&this.ip==e.ip&&this.user==e.user&&this.password==e.password;},HomeCenter.Discovery=function(){this._homeCenters=[],this._sockets=[],this._searchTimeout=null,this._running=!1,this._listeners=[],this._callbacks=[];var e=require("x.logger.js");this._logger=e?e.getLogger("xnm.aio.fibaro.HomeCenter.Discovery"):{log:function log(){}},this.discoverHomeCenters=function(e,t,a){if(t&&-1==this._listeners.indexOf(t)&&this._listeners.push(t),a&&-1==this._callbacks.indexOf(a)&&this._callbacks.push(a),e||(e=5e3),!this._running){this._logger.log("debug","start search home center");var s=this;this._running=!0,this._createSockets(function(t){t?s._finishDiscover(t):(s._sendDiscoveryMessages(),s._searchTimeout=setTimeout(function(){s._finishDiscover(null,s._homeCenters);},e));});}},this._createSockets=function(e){var t=require("os"),a=(require("dgram"),this);if(t&&t.networkInterfaces){var s=t.networkInterfaces(),r=[];for(var n in s){if(s.hasOwnProperty(n))for(var o=s[n],i=0;i<o.length;i++){"IPv4"==o[i].family&&0==o[i].internal&&r.push(o[i]);}}for(var l=0,u=0,cb=function cb(t,s){if(l++,t&&(u++,s)){var n=a._sockets.indexOf(s);-1!=n&&a._sockets.splice(n,1);}l==r.length&&(u==l?e&&e(t):e&&e());},f=0;f<r.length;f++){this._addDiscoverSocket(44444,r[f],cb);}}else this._addDiscoverSocket(44444,null,function(t,s){if(t&&s){var r=a._sockets.indexOf(s);-1!=r&&a._sockets.splice(r,1);}e&&e(t);});},this._closeSockets=function(){for(var e=0;e<this._sockets.length;e++){this._sockets[e].close();}},this._addDiscoverSocket=function(e,t,a){var s,r=this,n=require("dgram");try{s=n.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){s=n.createSocket("udp4");}s.on("listening",function(){s.setBroadcast(!0),s._listening=!0,r._logger.log("trace","success to bind on port:"+e+(t?" with interface:"+t.address:"")),a&&a(null,s);}),s.on("message",function(e,t){r._receivedData(t.address,e);}),s.on("error",function(n){s._listening||(r._logger.log("trace","failed to bind on port:"+e+(t?" with interface:"+t.address:"")),a&&a(n,s));});try{t?(r._logger.log("trace","try to bind on port:"+e+" with interface:"+t.address),s.bind(e,t.address),this._sockets.push(s)):(r._logger.log("trace","try to bind on port:"+e),s.bind(e),this._sockets.push(s));}catch(e){a&&a(e);}},this._sendDiscoveryMessages=function(){for(var e=new Buffer([70,73,66,65,82,79]),t=0;t<this._sockets.length;t++){this._sockets[t].send(e,0,e.length,44444,"255.255.255.255");}},this._receivedData=function(e,t){if(t=t.toString("hex"),(t=new Buffer(t,"hex")).length>=3){var a=t.toString();this._logger.log("trace","receive packet:"+a+" from:"+e);var s=a.split(" ");if(3==s.length&&"ACK"==s[0]){var r=new HomeCenter(e,null,null,s[2]);r.name=s[1];for(var n=!1,o=0;o<this._homeCenters.length;o++){var i=this._homeCenters[o];if(i&&i.uuid==r.uuid){n=!0;break;}}if(!n){this._homeCenters.push(r);for(var l=0;o<this._listeners.length;l++){this._listeners[l](r);}}}}},this._finishDiscover=function(e,t){var a=this._callbacks;this._closeSockets(),this._sockets=[],this._homeCenters=[],this._running=!1,this._listeners=[],this._callbacks=[];for(var s=0;s<a.length;s++){var r=a[s];r&&r(e,t);}};},HomeCenter;}(),xnm.aio.fibaro.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="FibaroDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"fibaro",getGatewayType:function getGatewayType(){return[{sys:this.SYS,name:"FIBARO Home Center 2"}];},getGatewayDeviceType:function getGatewayDeviceType(){return[];},createGateway:function createGateway(e,t,a){var s=DMError,r=DMError.ERROR_CODE;e?e.ip?e.username?e.password?a(null,e):a(new s(r.INVALID,"password is invalid")):a(new s(r.INVALID,"username is invalid")):a(new s(r.INVALID,"ip is invalid")):a(new s(r.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,a,s){var r=DMError,n=DMError.ERROR_CODE;t?t.ip?t.username?t.password?s(null,t):s(new r(n.INVALID,"password is invalid")):s(new r(n.INVALID,"username is invalid")):s(new r(n.INVALID,"ip is invalid")):s(new r(n.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,a){a();},createDevice:function createDevice(e,t,a){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var n,o,i=t.data.gateways;for(n=0;n<i.length;n++){if(i[n].index===e.gateway){o=i[n];break;}}o?a(null,e):a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.INVALID,"type is invalid"));}else a(new s(r.INVALID,"address is invalid"));}else a(new s(r.INVALID,"gateway is invalid"));}else a(new s(r.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,a){var s=DMError,r=DMError.ERROR_CODE;if(e){if(e.gateway){if(e.address){if(e.type){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var n,o,i=t.data.gateways;for(n=0;n<i.length;n++){if(i[n].index===e.gateway){o=i[n];break;}}o?a(null,e):a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else a(new s(r.INVALID,"type is invalid"));}else a(new s(r.INVALID,"address is invalid"));}else a(new s(r.INVALID,"gateway is invalid"));}else a(new s(r.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,a){a();},applyUIFilter:function applyUIFilter(e,t){var a=this,_contains=function _contains(e,t){if("*"==e)return!0;for(var a=!1,s=0;s<e.length;s++){if(e[s]==t){a=!0;break;}}return a;},_filter=function _filter(e,t){var s=[],r=null,n=a.getCommandStatusMap(e);return n&&(r=function(e,t,a){var s=[];switch(a.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(a.elems,e.type)){var t=JSON.parse(JSON.stringify(e));s.push(t);}});}return s;}(n,0,t),s=s.concat(r)),s;};if(!e||null==e.type||void 0===e.type)return null;var s=JSON.parse(JSON.stringify(e)),r=null;switch(t.catagory){case"command":r=_filter(e,t),s.command=r;break;case"status":r=_filter(e,t),s.status=r;break;default:return null;}return r&&0!=r.length?s:null;},getCommandStatusMap:function getCommandStatusMap(e){if(!e)return null;var t={command:[],status:[]};if("global_variable"==e.type)return e.readOnly||t.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d"}}),t.status.push({type:"int",name:"value",ref:{value:"value"}}),t;var a=e.actions,s=e.states;if(a)for(var r in a){if(r&&-1!=xnm.aio.fibaro.HomeCenter.ACTION_LIST.indexOf(r))switch(r){case"turnOn":t.command.push({type:"enum",name:"on",ref:{value:"on"}});break;case"turnOff":t.command.push({type:"enum",name:"off",ref:{value:"off"}});break;case"setValue":t.command.push({type:"int",name:"set value",ref:{value:"setValue",ext:"%d",extMeta:"0-100"}});break;case"startLevelIncrease":t.command.push({type:"enum",name:"up",ref:{value:"startLevelIncrease"}});break;case"startLevelDecrease":t.command.push({type:"enum",name:"down",ref:{value:"startLevelDecrease"}});break;case"stopLevelChange":t.command.push({type:"enum",name:"stop level change",ref:{value:"stopLevelChange"}});break;case"setArmed":t.command.push({type:"enum",name:"arm",ref:{value:"arm"}}),t.command.push({type:"string",name:"disarm",ref:{value:"disarm",ext:"%s",unit:"(pin)"}});break;case"setTargetLevel":e&&"com.fibaro.hvac"==e.baseType?t.command.push({type:"float",name:"set point",ref:{value:"setTargetLevel",ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}}):t.command.push({type:"float",name:"set target level",ref:{value:"setTargetLevel",ext:"%f"}});break;case"setTime":t.command.push({type:"int",name:"set time",ref:{value:"setTime",ext:"%d",extMeta:"0-21600",unit:"s"}});break;case"setSetpointMode":if(s&&s.supportedModes){var _e9=s.supportedModes.split(",");if(_e9.length>0){var n={type:"enum",name:"set point mode",ref:{value:"setSetpointMode",ext:"%e",extMeta:[]}};_e9.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];t&&n.ref.extMeta.push(t);}),t.command.push(n);}}break;case"setThermostatSetpoint":if(s&&s.supportedModes){var _e10=s.supportedModes.split(",");_e10.length>0&&_e10.forEach(function(e){var a=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];a&&t.command.push({type:"float",name:"set point ("+a+")",ref:{value:"setThermostatSetpoint"+e,ext:"%f",extMeta:"4.0-30.0",scale:"0.5"}});});}break;case"setMode":if(s&&s.supportedModes){var _e11=s.supportedModes.split(",");if(_e11.length>0){(function(){var a={type:"enum",name:"set op mode",ref:{value:"setMode",ext:"%e",extMeta:[]}};_e11.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(e)];t&&a.ref.extMeta.push(t);}),t.command.push(a);})();}}break;case"setFanMode":if(s&&s.supportedModes){var _e12=s.supportedModes.split(",");if(_e12.length>0){(function(){var a={type:"enum",name:"set fan mode",ref:{value:"setFanMode",ext:"%e",extMeta:[]}};_e12.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(e)];t&&a.ref.extMeta.push(t);}),t.command.push(a);})();}}break;case"setColor":t.command.push({type:"rgbw",name:"rgb+white color",ref:{value:"rgbw",ext:"%s"}});break;case"startProgram":t.command.push({type:"int",name:"start program",ref:{value:"startProgram",ext:"%d"}});break;case"pressButton":if(s&&Array.isArray(s.rows)){(function(){var e={type:"enum",name:"press button",ref:{value:"pressButton",ext:"%e",extMeta:[]}};s.rows.filter(function(e){return"button"===e.type&&Array.isArray(e.elements);}).forEach(function(t){t.elements.forEach(function(t){e.ref.extMeta.push(t.id+": "+(t.caption||t.name));});}),e.ref.extMeta.length>0&&t.command.push(e);})();}break;case"setSlider":if(s&&Array.isArray(s.rows)){s.rows.filter(function(e){return"slider"===e.type&&Array.isArray(e.elements);}).forEach(function(e){e.elements.forEach(function(e){var a={type:"int",name:"slider ".concat(e.id,": ")+(e.caption||e.name),ref:{value:"setSlider"+e.id,ext:"%d",extMeta:"0-100"}};t.command.push(a);});});}break;default:t.command.push({type:"enum",name:r,ref:{value:r}});}}if(s){for(var o in s){if(o&&-1!=xnm.aio.fibaro.HomeCenter.PROPERTY_LIST.indexOf(o))switch(o){case"value":a&&a.setValue?t.status.push({type:"int",name:"value",ref:{value:"intValue",ext:"%d"}}):a&&a.setThermostatSetpoint||e&&"com.fibaro.hvac"==e.baseType?t.status.push({type:"float",name:"set point value",ref:{value:"floatValue",ext:"%f"}}):a&&void 0!==a.turnOn&&null!=a.turnOn?(t.command.push({type:"enum",name:"toggle",ref:{value:"toggle"}}),t.status.push({type:"enum",name:"value",ref:{value:"onoffValue",options:["on","off"]}})):"true"==s.value||"false"==s.value?t.status.push({type:"enum",name:"value",ref:{value:"boolValue",options:["true","false"]}}):t.status.push({type:"float",name:"value",ref:{value:"floatValue",ext:"%f"}});break;case"targetLevel":a&&a.setThermostatSetpoint||e&&"com.fibaro.hvac"==e.baseType?t.status.push({type:"float",name:"set point target",ref:{value:"targetLevel",ext:"%f"}}):t.status.push({type:"float",name:"target level",ref:{value:"targetLevel",ext:"%f"}});break;case"mode":if(a&&a.setSetpointMode){if(s.supportedModes){var _e13=s.supportedModes.split(",");if(_e13.length>0){(function(){var a={type:"enum",name:"set point mode",ref:{value:"setpointMode",options:[]}};_e13.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.SET_POINT_MODES[parseInt(e)];t&&a.ref.options.push(t);}),t.status.push(a);})();}}}else if(a&&a.setMode){if(s.supportedModes){var _e14=s.supportedModes.split(",");if(_e14.length>0){(function(){var a={type:"enum",name:"op mode",ref:{value:"opMode",options:[]}};_e14.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.OP_MODES[parseInt(e)];t&&a.ref.options.push(t);}),t.status.push(a);})();}}}else if(a&&a.setFanMode){if(s.supportedModes){var _e15=s.supportedModes.split(",");if(_e15.length>0){(function(){var a={type:"enum",name:"fan mode",ref:{value:"fanMode",options:[]}};_e15.forEach(function(e){var t=xnm.aio.fibaro.HomeCenter.FAN_MODES[parseInt(e)];t&&a.ref.options.push(t);}),t.status.push(a);})();}}}else"true"==s.value||"false"==s.value?t.status.push({type:"enum",name:"state",ref:{value:"boolValue",options:["true","false"]}}):t.status.push({type:"float",name:"state",ref:{value:"floatValue",ext:"%f"}});break;case"armed":case"tamper":t.status.push({type:"enum",name:o,ref:{value:o,options:["true","false"]}});break;case"WeatherCondition":t.status.push({type:"string",name:o,ref:{value:o}});break;default:t.status.push({type:"float",name:o,ref:{value:o,ext:"%f"}});}}Array.isArray(s.rows)&&s.rows.forEach(function(e){e&&Array.isArray(e.elements)&&"slider"===e.type&&e.elements.forEach(function(e){t.status.push({type:"int",name:"slider ".concat(e.id,": ")+(e.caption||e.name),ref:{value:"sliderValue"+e.id,ext:"%d",extMeta:"0-100"}});});});}return t;}};}(),xnm.aio.fibaro.Handler=function(){var Handler=function Handler(){this.detectedHomecenters={},this.discovery=new this.HomeCenter.Discovery();};return Handler.prototype.HomeCenter=xnm.aio.fibaro.HomeCenter,Handler.prototype.devicemanager=xnm.aio.fibaro.DM,Handler.prototype.registModule=function(e){e.register(this.devicemanager.SYS,"fibaro");},Handler.prototype.discoverHomeCenters=function(e,t){this.discovery.discoverHomeCenters(e,null,function(e,a){t&&t(e,a);});},Handler.prototype.resolveGateway=function(e){return e&&e.ip&&e.username?new this.HomeCenter(e.ip,e.username,e.password,e.uuid,e.name):null;},Handler.prototype.getDeviceCommands=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"command",elems:"*"}),s=a?a.command:[];t&&t(null,s);},Handler.prototype.getDeviceStatus=function(e,t){var a=this.devicemanager.applyUIFilter(e,{catagory:"status",elems:"*"}),s=a?a.status:[];t&&t(null,s);},Handler.prototype.doCommand=function(e,t,a,s){var r=this.resolveGateway(e);r?r.executeCommandCreator(t,a,function(e){s&&s(e);}):s&&s(new Error("gateway json format invalid"));},Handler.prototype.doStatus=function(e,t,a,s,r){var n=this.resolveGateway(t);if(n){var o=[{id:e,device:a,status:s}];n.getStatesCreator(null,o,function(e,t){e?r&&r(e):r&&r(null,t[0]);});}else r&&r(new Error("gateway json format invalid"));},Handler.prototype.getDeviceList=function(e,t){var a=this.resolveGateway(e);a?a.getDevices(function(e,a){t&&t(e,a);}):t&&t(new Error("gateway json format invalid"));},Handler.prototype.getStateValues=function(e,t){return new xnm.aio.fibaro.HomeCenter().getStateValues(e.type,t);},Handler.prototype.getDeviceCommandList=function(e,t,a){var s=[];if(e.actions)for(var r in e.actions){if("setVolume"===r)s.push({id:r,cmd:"setTo",step:"1",min:"0",max:"100"});else s.push({id:r,cmd:r});}return s;},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.fibaro.Handler());