var util=require("util"),EventEmitter=require("events"),path=require("path"),fs=require("fs"),fs_extra=require("fs-extra"),fileman=require("x.hub.fileman.js"),logger=require("x.logger.js"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.zway=x.hub.m.zway||{},x.hub.m.zway.Util={hasEvent:function hasEvent(e,t,a,n){if(!e||!t||!a)return null;if(n<0||n>255)return null;var r=null;if("binary"==a.type&&a.value){r=a.value;var i=Math.floor(n/8),s=n%8;return r[i]&&r[i]>>s&1&&e._EVNETS[t]?e._EVNETS[t][n]:null;}return isNaN(parseInt(a.value))?null:parseInt(a.value)>>n&1&&e._EVNETS[t]?e._EVNETS[t][n]:null;}},x.hub.m.zway.PollManager=function(){var e=["37","38","49","51","64","67"],Poller=function Poller(e){this._logger=logger.getLogger("x.hub.m.zway.Poller"),this._pollManager=e,this._deviceID=null,this._pollInterval=0,this._running=!1,this._startPollTO=null,this._pollTO=null,this._errorCount=0;};return Poller.prototype.setDeviceID=function(e){this._deviceID=e;},Poller.prototype.setPollInterval=function(e){this._pollInterval=e;},Poller.prototype.start=function(){if(this._logger.log("trace","start for device: "+this._deviceID+" with interval: "+this._pollInterval+"s"),!this._running){this._running=!0;var e=this;this._startPollTO=setTimeout(function(){e._pollTO=setInterval(function(){e._pollDevice();},1e3*e._pollInterval);},1e3*Math.floor(10*Math.random()+1));}},Poller.prototype.stop=function(){this._logger.log("trace","stop for device: "+this._deviceID),this._running&&(this._running=!1,this._pollTO&&(clearInterval(this._pollTO),this._pollTO=null),this._startPollTO&&(clearInterval(this._startPollTO),this._startPollTO=null));},Poller.prototype.immediatelyPoll=function(){this._pollDevice();},Poller.prototype._pollDevice=function(){var e=this._pollManager.getHandler().getZway();if(e){var t=e.getDevice(this._deviceID);if(!t)return this._logger.log("trace","no such device: "+this._deviceID),this._errorCount++,void(this._errorCount>10&&(this._logger.log("trace","too many error with no such device, stop poller: "+this._deviceID),this._pollManager.stopPoller(this._deviceID)));this._errorCount=0,this._logger.log("trace","poll device:"+this._deviceID);var a=this._findCommandClassesToPoll(this._deviceID,t);a&&a.length>0&&this._pollManager._pollCommandClass(a);}},Poller.prototype._findCommandClassesToPoll=function(t,a){if(!a||!a.instances)return null;var n=[];for(var r in a.instances){var i=a.instances[r];if(i&&i.commandClasses)for(var s in i.commandClasses){-1!=e.indexOf(s)&&n.push(t+"."+r+"."+s);}}return n;},{_logger:require("x.logger.js").getLogger("x.hub.m.zway.PollManager"),_handler:null,_tasks:[],_pollers:{},_pollWait:200,_pollTO:null,init:function init(e,t){this._handler=e,t&&t();},getHandler:function getHandler(){return this._handler;},startPoller:function startPoller(e,t){if(e&&t&&!(t<0)){if(!this._pollers[e]){var a=new Poller(this);a.setDeviceID(e),a.setPollInterval(t),this._pollers[e]=a;}this._pollers[e].start();}},stopPoller:function stopPoller(e){if(e){var t=this._pollers[e];t&&(t.stop(),delete this._pollers[e]);}},immediatelyPoll:function immediatelyPoll(e){if(e)for(var t=0;t<e.length;t++){var a=e[t],n=this._pollers[a];n||(n=new Poller(this)).setDeviceID(a),n.immediatelyPoll();}},_pollCommandClass:function _pollCommandClass(e){for(var t=this._tasks.length,a=0;a<e.length;a++){var n=e[a];-1==this._tasks.indexOf(n)&&this._tasks.push(n);}0!=t||this._pollTO||this._doNextPollTask();},_doNextPollTask:function _doNextPollTask(){this._pollTO&&(clearTimeout(this._pollTO),this._pollTO=null);var e=this._tasks.shift();if(e){var t=this;this._doGetRequest(e,function(){t._pollTO=setTimeout(function(){t._pollTO=null,t._doNextPollTask();},t._pollWait);});}},_doGetRequest:function _doGetRequest(e,t){this._logger.log("trace","do Get() for command class:"+e);var a=this._handler.getZway();if(a){var n=e.split(".");if(!(n.length<3)){var r="devices["+n[0]+"].instances["+n[1]+"].commandClasses["+n[2]+"].Get()",i=this;a._doRunRequest(r,null,function(a){a&&i._logger.log("warn","do Get() for command class:"+e+" error:"+a.message),t&&t();});}}}};}(),x.hub.m.zway.SettingsManager=function(){var Setting=function Setting(e,t){this._settingsManager=e,this._deviceID=t,this._autoPoll=!1,this._pollInterval=0;};return Setting.prototype.init=function(){this.start();},Setting.prototype.start=function(){this._autoPoll&&this._pollInterval>0&&this._settingsManager._startPoller(this);},Setting.prototype.stop=function(){this._settingsManager._stopPoller(this);},Setting.prototype.getDeviceID=function(){return this._deviceID;},Setting.prototype.getPollInterval=function(){return this._pollInterval;},Setting.prototype.toJSON=function(){return{autoPoll:this._autoPoll,pollInterval:this._pollInterval};},Setting.prototype.fromJSON=function(e){e&&(this._autoPoll=!!e.autoPoll,this._pollInterval=e.pollInterval?e.pollInterval:0);},{ZWAY_FILE:"zwave.json",_logger:require("x.logger.js").getLogger("x.hub.m.zway.SettingsManager"),_handler:null,_settings:{},init:function init(e,t){this._logger.log("trace","init"),this._handler=e;var a=this;this._loadSettings(function(e,n){e&&a._logger.log("warn","init error:"+e.message),n&&(a._settings=n,a._initSettings()),t&&t();});},setSetting:function setSetting(e,t,a){if(this._handler.getZway().getDevice(e)){var n=this._settings[e];n&&n.stop(),(n=new Setting(this,e)).fromJSON(t),this._settings[e]=n,n.start(),this._saveSettings(function(e){a&&a(e||null,e?null:n);});}else a&&a(new Error("no such device:"+e));},getSetting:function getSetting(e,t){if(this._handler.getZway().getDevice(e)){var a=this._settings[e];a||(a=new Setting(this,e)),t&&t(null,a);}else t&&t(new Error("no such device:"+e));},deleteSetting:function deleteSetting(e,t){if(this._handler.getZway().getDevice(e)){var a=this._settings[e];a||(a.stop(),delete this._settings[e]),this._saveSettings(t);}else t&&t(new Error("no such device:"+e));},_startPoller:function _startPoller(e){this._handler.startPoller(e.getDeviceID(),e.getPollInterval());},_stopPoller:function _stopPoller(e){this._handler.stopPoller(e.getDeviceID());},_initSettings:function _initSettings(){for(var e in this._settings){var t=this._settings[e];t&&t.init();}},_loadSettings:function _loadSettings(e){var t=this;this._loadFile(function(a,n){if(a)e&&e(a);else{var r=t._jsonToSettingsMap(n);e&&e(null,r);}});},_jsonToSettingsMap:function _jsonToSettingsMap(e){if(!e)return{};var t={};for(var a in e){var n=e[a];if(n){var r=new Setting(this,a);r.fromJSON(n),t[a]=r;}}return t;},_loadFile:function _loadFile(e){var t=this._getFilePath();fs_extra.ensureFile(t,function(a){a?e&&e(a):fs_extra.readFile(t,"utf8",function(t,a){if(t)e&&e(t);else if(a)try{var n=JSON.parse(a);e&&e(null,n);}catch(t){e&&e(t);}else e&&e(null,{});});});},_getFilePath:function _getFilePath(){var e=fileman.fileManager.getUserRootDataPath();return path.resolve(e,this.ZWAY_FILE);},_saveSettings:function _saveSettings(e){var t=this._settingsMapToJson(this._settings);this._saveFile(t,function(t){e&&e(t);});},_settingsMapToJson:function _settingsMapToJson(e){if(!e)return{};var t={};for(var a in e){var n=e[a];if(n){var r=n.toJSON();t[a]=r;}}return t;},_saveFile:function _saveFile(e,t){var a=this._getFilePath();fs_extra.writeFile(a,JSON.stringify(e,null,2),function(e){t&&t(e);});}};}(),x.hub.m.zway.ZWay=function(){var e={_buffer:{},updateState:function updateState(e,t){if(!t)return!1;var a=this._buffer[e],n=t;if(this._buffer[e]=t,!a)return!0;var r=!1;for(var i in n){n[i]!=a[i]&&(r=!0);}return r;}},UdpEventProducer_sendSTAEvent=function UdpEventProducer_sendSTAEvent(e){var t=require("x.hub.eventbus.js");t.emit("gatewayevent",e,{address:"ZWAVE"},"STA"),t.emit("udpevent",e,"STA");},t={_alarms:{},_alarmEvents:{},setAlarm:function setAlarm(e,t){this._alarms[e]=t;},getAlarm:function getAlarm(e){return this._alarms[e];},setAlarmEvent:function setAlarmEvent(e,t){this._alarmEvents[e]=t;},getAlarmEvent:function getAlarmEvent(e){return this._alarmEvents[e];},deleteAlarmEvent:function deleteAlarmEvent(e){delete this._alarmEvents[e];}},LearnHandler=function LearnHandler(e){this.INTERVIEW_TIMEOUT=2e4,this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay.LearnHandler"),this._zway=e,this._inclusion=!1,this._inclusionTO=null,this._inclusionListener=null,this._inclusionCB=null,this._inclusionDeviceId=null,this._inclusionInterViewProgress=0,this._inclusionInterViewTO=null,this._exclusion=!1,this._exclusionTO=null,this._exclusionCB=null,this._exclusionDeviceId=null,this._exclusionAny=!1,this._updateInterview=!1,this._updateInterviewTO=null,this._updateInterviewCB=null,this._updateInterviewListener=null,this._updateInterviewDeviceId=null,this._updateInterviewInstanceID=null,this._updateInterviewCommandClassID=null,this._updateInterviewProgress=0;var t=this;this._dataUpdateListener=function(e){t._onDataUpdate(e);};};LearnHandler.prototype.inclusion=function(e,t){var a;if(this._inclusion)return(a=new Error("inclusion process running")).code="08001",void(t&&t(a));if(this._exclusion)return(a=new Error("exclusion process running")).code="08002",void(t&&t(a));if(this._updateInterview)return(a=new Error("update interview process running")).code="08006",void(t&&t(a));this._logger.log("info","start inclusion");var n=this;this._inclusionListener=e,this._inclusionCB=t,this._inclusionTO=setTimeout(function(){(a=new Error("inclusion timeout")).code="08003",n._inclusionFinish(a);},2e4),this._inclusionListener&&this._inclusionListener(1,0,"start inclusion"),this._zway.addDataUpdateListener(this._dataUpdateListener),this._inclusion=!0,this._zway._startInclusion(function(e){e?n._inclusionFinish(e):n._inclusionListener&&n._inclusionListener(2,0,"set device");});},LearnHandler.prototype.exclusion=function(e,t){var a;if(this._inclusion)return(a=new Error("inclusion process running")).code="08001",void(t&&t(a));if(this._exclusion)return(a=new Error("exclusion process running")).code="08002",void(t&&t(a));if(this._updateInterview)return(a=new Error("update interview process running")).code="08006",void(t&&t(a));this._logger.log("info","start exclusion");var n=this;this._exclusionCB=t,this._exclusionTO=setTimeout(function(){(a=new Error("exclusion timeout")).code="08005",n._exclusionFinish(a);},2e4),this._zway.addDataUpdateListener(this._dataUpdateListener),this._exclusion=!0,-1==e&&(this._exclusionAny=!0),this._zway._startExclusion(function(e){e&&n._exclusionFinish(e);});},LearnHandler.prototype.updateInterview=function(e,t,a,n,r){var i;if(this._inclusion)return(i=new Error("inclusion process running")).code="08001",void(r&&r(i));if(this._exclusion)return(i=new Error("exclusion process running")).code="08002",void(r&&r(i));if(this._updateInterview)return(i=new Error("update interview process running")).code="08006",void(r&&r(i));if(!e)return(i=new Error("update interview deviceID invalid")).code="08006",void(r&&r(i));if(!this._zway.getDevice(e))return(i=new Error("update interview deviceID invalid")).code="08006",void(r&&r(i));var s=this._updateInterviewProgress=this._zway.getInterviewProgress(e);if(100!=s){this._logger.log("info","update interview for device:"+e);var l=this;this._updateInterviewCB=r,this._updateInterviewDeviceId=e,this._updateInterviewInstanceID=t,this._updateInterviewCommandClassID=a,this._updateInterviewListener=n,this._updateInterviewTO=setTimeout(function(){(i=new Error("update interview timeout")).code="08008",l._updateInterviewFinish(i,l._updateInterviewDeviceId);},1e4),this._zway.addDataUpdateListener(this._dataUpdateListener),this._updateInterview=!0,this._updateInterviewProgress=s,this._updateInterviewListener&&this._updateInterviewListener(1,s,"start update interview"),this._zway._startUpdateInterview(e,t,a,function(e){e&&l._updateInterviewFinish(e);});}else r&&r(null,this._zway.getSimplifiedJSON(e));},LearnHandler.prototype._inclusionFinish=function(e,t){e?this._logger.log("warn","inclusion finish with error:"+e.stack):this._logger.log("info","inclusion finish:"+t),this._inclusionTO&&clearTimeout(this._inclusionTO),this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO);var a=this;this._zway._stopInclusion(function(){a._zway.removeDataUpdateListener(a._dataUpdateListener);var n=a._inclusionCB;a._inclusion=!1,a._inclusionTO=null,a._inclusionListener=null,a._inclusionCB=null,a._inclusionInterViewProgress=0,a._inclusionInterViewTO=null,a._inclusionDeviceId=null,setTimeout(function(){var r=null;t&&(r=a._zway.getSimplifiedJSON(t)),r&&(r.interViewDone=!0),e&&"08004"==e.code&&r&&(e=null,r.interViewDone=!1),n&&n(e,r);},5e3);});},LearnHandler.prototype._exclusionFinish=function(e,t){e?this._logger.log("warn","exclusion finish with error:"+e.stack):this._logger.log("info","exclusion finish:"+t),this._exclusionTO&&clearTimeout(this._exclusionTO);var a=this;setTimeout(function(){a._zway._stopExclusion(function(){a._zway.removeDataUpdateListener(a._dataUpdateListener);var n=a._exclusionCB;a._exclusion=!1,a._exclusionTO=null,a._exclusionCB=null,a._exclusionDeviceId=null,a._exclusionAny=!1,n&&n(e,t);});},1e3);},LearnHandler.prototype._updateInterviewFinish=function(e,t){e?this._logger.log("warn","update interview finish with error:"+e.stack):this._logger.log("info","update interview finish:"+t);var a=null;t&&(a=this._zway.getSimplifiedJSON(t)),this._updateInterviewTO&&clearTimeout(this._updateInterviewTO),this._zway.removeDataUpdateListener(this._dataUpdateListener);var n=this._updateInterviewCB;this._updateInterview=!1,this._updateInterviewTO=null,this._updateInterviewCB=null,this._updateInterviewListener=null,this._updateInterviewDeviceId=null,this._updateInterviewInstanceID=null,this._updateInterviewCommandClassID=null,this._updateInterviewProgress=0,n&&n(e,a);},LearnHandler.prototype._onDataUpdate=function(e){this._logger.log("debug","on data update"),this._logger.log("debug",JSON.stringify(e,null,2)),e&&(this._inclusion?this._onInclusionDataUpdate(e):this._exclusion?this._onExclusionDataUpdate(e):this._updateInterview&&this._onUpdateInterviewDataUpdate(e));},LearnHandler.prototype._onInclusionDataUpdate=function(e){if(!this._inclusionDeviceId&&e["controller.data.lastIncludedDevice"]){var t=e["controller.data.lastIncludedDevice"].value;t&&(this._inclusionDeviceId=t,this._inclusionTO&&(clearTimeout(this._inclusionTO),this._inclusionTO=null),this._inclusionListener&&this._inclusionListener(3,0,"run interview"));}var a=this,n=null;if(this._inclusionDeviceId&&(n=this._zway.getDevice(this._inclusionDeviceId),this._inclusionInterViewTO||(this._inclusionInterViewTO=setTimeout(function(){var e=new Error("interview timeout");e.code="08004",a._inclusionFinish(e,a._inclusionDeviceId);},this.INTERVIEW_TIMEOUT))),n&&n.instances){var r=0,i=0;for(var s in n.instances){var l=n.instances[s];if(l&&l.commandClasses)for(var o in l.commandClasses){var u=l.commandClasses[o];u&&u.data&&u.data.interviewDone&&(r+=1,u.data.interviewDone.value&&(i+=1));}}var d=!1;for(var v in e){if(0==v.indexOf("devices."+this._inclusionDeviceId)){d=!0;break;}}var c=0;n.data&&n.data.interviewDone&&n.data.interviewDone.value?(c=100,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._logger.log("debug","inclusion progress:"+c),this._inclusionListener&&this._inclusionListener(3,c,"run interview")):0!=r&&0!=i&&(((c=Math.round(i/r*100))!=this._inclusionInterViewProgress||d)&&(this._inclusionInterViewProgress=c,this._inclusionInterViewTO&&clearTimeout(this._inclusionInterViewTO),this._inclusionInterViewTO=setTimeout(function(){var e=new Error("interview timeout");e.code="08004",a._inclusionFinish(e,a._inclusionDeviceId);},this.INTERVIEW_TIMEOUT)),this._logger.log("debug","inclusion progress:"+c),this._inclusionListener&&this._inclusionListener(3,c,"run interview")),100==c&&this._inclusionFinish(null,this._inclusionDeviceId);}},LearnHandler.prototype._onExclusionDataUpdate=function(e){if(e["controller.data.lastExcludedDevice"]){var t=e["controller.data.lastExcludedDevice"].value;this._exclusionAny?void 0!==t&&null!=t&&(this._exclusionDeviceId=t,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,-1)):t&&(this._exclusionDeviceId=t,this._exclusionTO&&(clearTimeout(this._exclusionTO),this._exclusionTO=null),this._exclusionFinish(null,this._exclusionDeviceId));}},LearnHandler.prototype._onUpdateInterviewDataUpdate=function(e){var t=this,a=this._zway.getInterviewProgress(this._updateInterviewDeviceId);if(a!=this._updateInterviewProgress&&(this._updateInterviewProgress=a,this._updateInterviewTO&&clearTimeout(this._updateInterviewTO),this._updateInterviewTO=setTimeout(function(){var e=new Error("update interview timeout");e.code="08008",t._updateInterviewFinish(e,t._updateInterviewDeviceId);},1e4)),this._logger.log("debug","update interview progress:"+a),this._updateInterviewListener&&this._updateInterviewListener(2,a,"run interview"),void 0!==this._updateInterviewInstanceID&&null!=this._updateInterviewInstanceID&&this._updateInterviewCommandClassID){var n=this._zway.listInterviewResults(this._updateInterviewDeviceId);n&&n[this._updateInterviewInstanceID]&&n[this._updateInterviewInstanceID].commandClasses&&n[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID]&&n[this._updateInterviewInstanceID].commandClasses[this._updateInterviewCommandClassID].interviewDone&&this._updateInterviewFinish(null,this._updateInterviewDeviceId);}else 100==a&&this._updateInterviewFinish(null,this._updateInterviewDeviceId);};var a={LIST:[37,38,48,49,50,51,64,66,67,68,69,91,98,113,128,156],getCommandClassFromId:function getCommandClassFromId(e){if(!e)return null;if(e=parseInt(e),isNaN(e))return null;if(-1==this.LIST.indexOf(e))return null;switch(e){case 37:return this.SwitchBinary;case 38:return this.SwitchMultilevel;case 48:return this.SensorBinary;case 49:return this.SensorMultilevel;case 50:return this.Meter;case 51:return this.SwitchColor;case 64:return this.ThermostatMode;case 66:return this.ThermostatOperatingState;case 67:return this.ThermostatSetPoint;case 68:return this.ThermostatFanMode;case 69:return this.ThermostatFanState;case 91:return this.CentralScene;case 98:return this.DoorLock;case 113:return this.Alarm;case 128:return this.Battery;case 156:return this.AlarmSensor;}},SwitchBinary:{buildCMD:function buildCMD(e,t,a){return e?"on"==e.value?"Set(true)":"off"==e.value?"Set(false)":"toggle"==e.value&&a&&a.data&&a.data.level?a.data.level.value?"Set(false)":"Set(true)":null:null;},resolveState:function resolveState(e){if(!e||!e.data||!e.data.level)return null;return[{id:"37",state:e.data.level.value?"on":"off"}];},getSimplifiedJSON:function getSimplifiedJSON(e){return e&&e.data&&e.data.level?{37:{type:"SwitchBinary",valueType:e.data.level.type}}:null;}},SwitchColor:{buildCMD:function buildCMD(e,t,a){if(!e)return null;var n={whiteWarm:0,whiteCold:1,red:2,green:3,blue:4},r=null;if(0===e.value.indexOf("rgb")&&e.value.length>3)r=e.value.substr(3),e.value="rgb",e.ext=r;else for(var i in n){if(0===e.value.indexOf(i)&&e.value.length>i.length){r=e.value.substr(i.length),e.value=i,e.ext=r;break;}}if("rgb"===e.value){if("string"!=typeof e.ext||e.ext.length<6)return null;var s=(u=String(e.ext).split("_"))[0],l=255;"#"===s[0]&&(s=s.substr(1)),u.length>1&&(l=parseInt(u[1],10),l=isNaN(l)?255:Math.min(254,Math.max(0,l)));var o="SetMultiple([0,1,2,3,4],[0,0,"+(parseInt(s.substr(0,2),16)+","+parseInt(s.substr(2,2),16)+","+parseInt(s.substr(4,2),16))+"]";return l<255&&(o+=","+l),o+")";}if("number"==typeof n[e.value]){if(void 0===e.ext)return null;var u=String(e.ext).split("_"),d=parseInt(u[0],10);l=255;if(isNaN(d))return null;u.length>1&&(l=parseInt(u[1],10),l=isNaN(l)?255:Math.min(254,Math.max(0,l))),d=Math.min(100,Math.max(0,d)),d=Math.round(2.55*d);var v=[n[e.value]],c=[d];"whiteWarm"===e.value||"whiteCold"===e.value?("whiteWarm"===e.value?v.push(1):v.push(0),v.push(2,3,4),c.push(0,0,0,0)):(v.push(0,1),c.push(0,0));o="SetMultiple(["+v.join(",")+"],["+c.join(",")+"]";return l<255&&(o+=","+l),o+")";}return null;},resolveState:function resolveState(e){if(!e||!e.data)return null;var t=[{id:"51",state:null}],a=-1,n=-1,r=-1;for(var i in e.data){var s=parseInt(i);if(!isNaN(s)){var l=e.data[i];if(l){2===s?a=l.level.value:3===s?n=l.level.value:4===s&&(r=l.level.value);var o=Math.round(l.level.value/2.55);(t=t||[]).push({id:"51."+i,state:o});}}}return a>-1&&n>-1&&r>-1&&(a=Number(a).toString(16),n=Number(n).toString(16),r=Number(r).toString(16),a.length<2&&(a="0"+a),n.length<2&&(n="0"+n),r.length<2&&(r="0"+r),t[0].state=a+n+r),t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t={51:{name:"RGB",type:"SwitchColor",valueType:"string"}};for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];r&&r.capabilityString&&r.level&&((t=t||{})["51."+a]={name:r.capabilityString.value,type:"SwitchColor",valueType:r.level.type});}}return t;}},SwitchMultilevel:{buildCMD:function buildCMD(e,t,a){if(!e)return null;var n,r=null;switch(e.value.length>8&&"toggleTo"==e.value.substr(0,8)?(r=e.value.substr(8),e.value="toggleTo",e.ext=r):e.value.length>7&&"valueTo"==e.value.substr(0,7)&&(r=e.value.substr(7),e.value="valueTo",e.ext=r),e.value){case"on":return"Set(255,0)";case"off":return a&&a.data&&(a.data.level={value:0}),"Set(0,0)";case"toggle":return a&&a.data&&a.data.level?((n=a.data.level.value)&&(a.data.level={value:0}),n?"Set(0,0)":"Set(255,0)"):null;case"toggleTo":return void 0===e.ext||null==e.ext?null:a&&a.data&&a.data.level?(n=a.data.level.value)?"Set(0,0)":((n=Math.round(parseInt(e.ext)/100*99))>99&&(n=99),n<0&&(n=0),a&&a.data&&(a.data.level={value:n}),"Set("+n+",0)"):null;case"stop":return"StopLevelChange()";case"up":return"Set(99)";case"down":return"Set(0)";case"stepUp":return r=5,void 0===e.ext&&null==e.ext||(r=parseInt(e.ext)),a&&a.data&&a.data.level?(n=a.data.level.value,n=Math.round(parseInt(n)/99*100),(n+=r)>100&&(n=100),n=Math.round(parseInt(n)/100*99),a&&a.data&&(a.data.level={value:n}),"Set("+n+",0)"):null;case"stepDown":return r=5,void 0===e.ext&&null==e.ext||(r=parseInt(e.ext)),a&&a.data&&a.data.level?(n=a.data.level.value,n=Math.round(parseInt(n)/99*100),(n-=r)<0&&(n=0),n=Math.round(parseInt(n)/100*99),a&&a.data&&(a.data.level={value:n}),"Set("+n+",0)"):null;case"valueTo":return void 0===e.ext||null==e.ext?null:((n=Math.round(parseInt(e.ext)/100*99))>99&&(n=99),n<0&&(n=0),a&&a.data&&(a.data.level={value:n}),"Set("+n+",0)");}return null;},resolveState:function resolveState(e){if(!e||!e.data||!e.data.level)return null;e.data.level.value;return[{id:"38",state:Math.round(parseInt(e.data.level.value)/99*100)}];},getSimplifiedJSON:function getSimplifiedJSON(e){return e&&e.data&&e.data.level?{38:{type:"SwitchMultilevel",valueType:e.data.level.type}}:null;}},SensorMultilevel:{resolveState:function resolveState(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.val){t||(t=[]);var i={id:"49."+n,state:r.val.value};t.push(i);}}}return t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.sensorTypeString&&r.scaleString&&r.val){t||(t={});var i={name:r.sensorTypeString.value,unit:r.scaleString.value,valueType:r.val.type,type:"SensorMultilevel"};t["49."+a]=i;}}}return t;}},SensorBinary:{resolveState:function resolveState(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.level){t||(t=[]);var i={id:"48."+n,state:r.level.value};t.push(i);}}}return t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.sensorTypeString&&r.level){t||(t={});var i={name:r.sensorTypeString.value,type:"SensorBinary"};t["48."+a]=i;}}}return t;}},Meter:{buildCMD:function buildCMD(e,t,a){return e&&"reset"==e.value?"Reset()":null;},resolveState:function resolveState(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.val){t||(t=[]);var i={id:"50."+n,state:r.val.value};t.push(i);}}}return t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.sensorTypeString&&r.scaleString&&r.val){t||(t={});var i={name:r.sensorTypeString.value,unit:r.scaleString.value,valueType:r.val.type,type:"Meter"};t["50."+a]=i;}}}return t;}},ThermostatSetPoint:{buildCMD:function buildCMD(e,t,a){if(!e)return null;var n=null;e.value.length>5&&"setTo"==e.value.substr(0,5)?(n=e.value.substr(5),e.value="setTo",e.ext=n):e.value.length>2&&"up"==e.value.substr(0,2)?(n=e.value.substr(2),e.value="up",e.ext=n):e.value.length>4&&"down"==e.value.substr(0,4)&&(n=e.value.substr(4),e.value="down",e.ext=n);var r,i,s=t[t.length-1];switch(e.value){case"up":return n=.5,void 0===e.ext&&null==e.ext||(n=parseFloat(e.ext)),a&&a.data&&a.data[s]&&a.data[s].setVal?(i=(r=a.data[s]).setVal.value,i+=n,r.max&&i>r.max.value&&(i=r.max.value),a.data[s].setVal.value=i,"Set("+s+","+i+")"):null;case"down":return n=.5,void 0===e.ext&&null==e.ext||(n=parseFloat(e.ext)),a&&a.data&&a.data[s]&&a.data[s].setVal?(i=(r=a.data[s]).setVal.value,i-=n,r.min&&i<r.min.value&&(i=r.min.value),a.data[s].setVal.value=i,"Set("+s+","+i+")"):null;case"setTo":return void 0===e.ext||null==e.ext?null:(i=parseFloat(e.ext),a&&a.data&&a.data[s]&&a.data[s].setVal?(a.data[s].setVal.value=i,"Set("+s+","+i+")"):null);}return null;},resolveState:function resolveState(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.val){var i=r.val.value;r.setVal?i+=":"+r.setVal.value:i+=":"+i,t||(t=[]);var s={id:"67."+n,state:i};t.push(s);}}}return t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.modeName&&r.scaleString&&r.val){t||(t={});var i={name:r.modeName.value,unit:r.scaleString.value,valueType:r.val.type,type:"ThermostatSetPoint"};r.min&&(i.min=r.min.value),r.max&&(i.max=r.max.value),t["67."+a]=i;}}}return t;}},ThermostatMode:{_MODES:["OFF","HEAT","COOL","AUTO","AUXILIARY_HEAT","RESUME","FAN_ONLY","FURNACE","DRY_AIR","MOIST","AUTO_CHANGEOVER","ENERGY_SAVE_HEAT","ENERGY_SAVE_COOL","AWAY",null,"FULL_POWER"],buildCMD:function buildCMD(e,t,a){if(!e)return null;var n=null;e.value.length>13&&"setThermoMode"==e.value.substr(0,13)&&(n=e.value.substr(13),e.value="setThermoMode",e.ext=n);t[t.length-1];switch(e.value){case"thermoModeOff":return"Set(0)";case"thermoModeHeat":return"Set(1)";case"thermoModeCool":return"Set(2)";case"thermoModeAuto":return"Set(3)";case"setThermoMode":return"Set("+e.ext+")";}return null;},resolveState:function resolveState(e){if(!e||!e.data||!e.data.mode)return null;var t=[],a={id:"64",state:e.data.mode.value};return t.push(a),t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];r&&r.modeName&&r.modeName.value&&(t||(t={}),t[a]=r.modeName.value);}}return{64:{type:"ThermostatMode",valueType:"int",modes:t}};}},ThermostatOperatingState:{_MODES:["IDLE","HEATING","COOLING","FAN_ONLY","PENDING_HEAT","PENDING_COOL","VENT_ECONOMIZER","AUX_HEATING","2ND_STAGE_HEATING","2ND_STAGE_COOLING","2ND_STAGE_AUX_HEAT","3RD_STAGE_AUX_HEAT"],resolveState:function resolveState(e){if(!e||!e.data||!e.data.state)return null;var t=[],a={id:"66",state:e.data.state.value};return t.push(a),t;},getSimplifiedJSON:function getSimplifiedJSON(e){return e&&e.data?{66:{type:"ThermostatOperatingState",valueType:e.data.state.type}}:null;}},ThermostatFanMode:{_MODES:["AUTO_LOW","LOW","AUTO_HIGH","HIGH","AUTO_MEDIUM","MEDIUM","CIRCULATION","HUMIDITY","LEFT_RIGHT","UP_DOWN","QUIET","3RD_STAGE_AUX_HEAT"],buildCMD:function buildCMD(e,t,a){if(!e)return null;var n=null;e.value.length>16&&"setThermoFanMode"==e.value.substr(0,16)&&(n=e.value.substr(16),e.value="setThermoFanMode",e.ext=n);var r=1;switch(r="Off"==e.ext?0:1,e.value){case"thermoFanModeAutoLow":return"Set("+r+",0)";case"thermoFanModeLow":return"Set("+r+",1)";case"thermoFanModeAutoHigh":return"Set("+r+",2)";case"thermoFanModeHigh":return"Set("+r+",3)";case"setThermoFanMode":return r?"Set("+r+","+e.ext+")":"Set("+r+",1)";}return null;},resolveState:function resolveState(e){if(!e||!e.data||!e.data.mode)return null;var t=[],a={id:"68",state:e.data.mode.value};return e.data&&e.data.on&&!e.data.on.value&&(a={id:"68",state:"off"}),t.push(a),t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];r&&r.modeName&&r.modeName.value&&(t||(t={}),t[a]=r.modeName.value);}}return{68:{type:"ThermostatFanMode",valueType:"int",modes:t}};}},ThermostatFanState:{resolveState:function resolveState(e){if(!e||!e.data||!e.data.state)return null;var t=[],a={id:"69",state:e.data.state.value?"on":"off"};return t.push(a),t;},getSimplifiedJSON:function getSimplifiedJSON(e){return e&&e.data&&"ThermostatFanState"==e.name?{69:{type:"ThermostatFanState"}}:null;}},CentralScene:{resolveState:function resolveState(e,t,a){if(!(e&&e.data&&e.data.currentScene&&e.data.keyAttribute))return null;var n=e.data.currentScene.value;if(n){var r=null;switch(e.data.keyAttribute.value){case 0:r="press";break;case 1:r="release";break;case 2:r="hold";}if(!r)return null;var i={};i[a+"."+t+".91."+n]=r;return null;}},resolveUpdate:function resolveUpdate(e,t,a){if(!(e&&e.data&&e.data.currentScene&&e.data.keyAttribute))return null;var n=e.data.currentScene.value;if(n){var r=null;switch(e.data.keyAttribute.value){case 0:r="press";break;case 1:r="release";break;case 2:r="hold";}if(!r)return null;var i={};return i[a+"."+t+".91."+n]=r,UdpEventProducer_sendSTAEvent({type:"ZWAVE2",adr:a,state:i}),null;}},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data||!e.data.maxScenes)return null;for(var t={},a=e.data.maxScenes.value,n=1;n<=a;n++){t["91."+n]={name:"Key "+n,type:"CentralScene"};}return t;}},Alarm:{_EVNETS:{1:{1:"Smoke",2:"Smoke",3:"Smoke Alarm Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance",8:"Maintenance Dust"},2:{1:"CO",2:"CO",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance"},3:{1:"CO2",2:"CO2",3:"CO Test",4:"Replacement",5:"Replacement End-of-life",6:"Alarm Silenced",7:"Maintenance"},4:{1:"Overheat",2:"Overheat",3:"Rapid Temperature Rise",4:"Rapid Temperature Rise",5:"Under Heat",6:"Under Heat",7:"Heat Alarm Test",8:"Replacement End-of-life",9:"Alarm Silenced",10:"Maintenance Dust",11:"Maintenance"},5:{1:"Water Leak",2:"Water Leak",3:"Water Level Dropped",4:"Water Level Dropped",5:"Replace Water Filter",6:"Water Flow Alarm",7:"Water Pressure Alarm"},6:{1:"Manual Lock",2:"Manual Unlock",3:"RF Lock",4:"RF Unlock",5:"Keypad Lock",6:"Keypad Unlock",7:"Manual Not Fully Locked",8:"RF Not Fully Locked",9:"Auto Lock Locked",10:"Auto Lock Not Fully Locked",11:"Lock Jammed",22:"Contact Opened",23:"Contact Closed"},7:{1:"Intrusion",2:"Intrusion",3:"Tampering",4:"Tampering",5:"Glass Breakage",6:"Glass Breakage",7:"Motion Detection",8:"Motion Detection",9:"Motion Detection"},8:{1:"Power has been applied",10:"Replace battery soon",11:"Replace battery now",14:"Charge battery soon",15:"Charge battery now"}},buildCMD:function buildCMD(e,a,n){if(!e||!a)return null;var r=a[a.length-1];if("on"==e.value)return"Set("+r+",255)";if("off"==e.value)return"Set("+r+",0)";if("toggle"==e.value){if(n&&n.data&&n.data[r]){var i=n.data[r].status;if(i)return(i=i.value)?"Set("+r+",0)":"Set("+r+",255)";}}else if("resetAlarm"==e.value){if(n&&n.data){var s=n;for(r in s.data){var l=parseInt(r);if(!isNaN(l)){var o=s.data[r];if(o&&o.status&&(t.setAlarmEvent("113."+l,0),o.event&&o.event.value&&(t.setAlarm("113."+l+"."+o.event.value,!1),o.event.value=null),o.eventMask&&o.eventMask.value))for(var u=1;u<=255;u++){x.hub.m.zway.Util.hasEvent(this,l,o.eventMask,u)&&t.getAlarm("113."+l+"."+u,!1);}}}}return-1;}return null;},resolveState:function resolveState(e){if(!e||!e.data)return null;var a=null;for(var n in e.data){var r=parseInt(n);if(!isNaN(r)){var i=e.data[n];if(i&&i.status){a||(a=[]);var s={id:"113."+r,state:i.status.value?"on":"off"};if(a.push(s),i.event)if(t.setAlarmEvent("113."+r,i.event.value),s={id:"113."+r+".event",state:i.event.value},a.push(s),i.event.value&&this._EVNETS[r]&&this._EVNETS[r][i.event.value]?a.push({id:"113."+r+".eventName",state:this._EVNETS[r][i.event.value]}):0==i.event.value&&a.push({id:"113."+r+".eventName",state:"No Alarm"}),i.event.value)t.setAlarm("113."+r+"."+i.event.value,!0);else if(0==i.event.value&&i.eventParameters&&i.eventParameters.value){var l=i.eventParameters.value;if(0==l.length){if(i.eventMask&&i.eventMask.value)for(var o=1;o<=255;o++){x.hub.m.zway.Util.hasEvent(this,r,i.eventMask,o)&&(t.setAlarm("113."+r+"."+o,!1),s={id:"113."+r+"."+o,state:!1});}}else for(o=0;o<l.length;o++){t.setAlarm("113."+r+"."+l[o],!1);}}if(i.eventMask&&i.eventMask.value)for(o=1;o<=255;o++){if(x.hub.m.zway.Util.hasEvent(this,r,i.eventMask,o)){s={id:"113."+r+"."+o,state:!1};var u=t.getAlarm("113."+r+"."+o);u&&(s.state=u),a.push(s);}}}}}return a;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.typeString&&r.status){t||(t={});var i={name:r.typeString.value,subtype:a,type:"Alarm"};if(t["113."+a]=i,r.eventMask&&r.eventMask.value)for(var s=1;s<=255;s++){var l=x.hub.m.zway.Util.hasEvent(this,n,r.eventMask,s);l&&(t["113."+a+"."+s]={name:l,eventID:s,type:"Alarm.Event"});}}}}return t;}},Battery:{resolveState:function resolveState(e){return e&&e.data&&e.data.last?[{id:"128",state:e.data.last.value}]:null;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;return{128:{name:"Battery",valueType:"int",type:"Battery"}};}},AlarmSensor:{resolveState:function resolveState(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.sensorState){t||(t=[]);var i={id:"156."+n,state:r.sensorState.value?"on":"off"};t.push(i);}}}return t;},getSimplifiedJSON:function getSimplifiedJSON(e){if(!e||!e.data)return null;var t=null;for(var a in e.data){var n=parseInt(a);if(!isNaN(n)){var r=e.data[a];if(r&&r.typeString){t||(t={});var i={name:r.typeString.value,subtype:a,type:"AlarmSensor"};t["156."+a]=i;}}}return t;}},DoorLock:{_MODE:{0:"unlock",1:"unlock_with_timeout",16:"inside_handle_unlock",17:"inside_handle_unlock_with_timeout",32:"outside_handle_unlock",33:"outside_handle_unlock_with_timeout",254:"unknown",255:"lock"},buildCMD:function buildCMD(e,t,a){if(!e)return null;var n=null;switch(e.value.length>8&&"toggleTo"==e.value.substr(0,8)?(n=e.value.substr(8),e.value="toggleTo",e.ext=n):e.value.length>7&&"valueTo"==e.value.substr(0,7)&&(n=e.value.substr(7),e.value="valueTo",e.ext=n),e.value){case"unlock":return"Set(0)";case"unlock_with_timeout":return"Set(1)";case"inside_handle_unlock":return"Set(16)";case"inside_handle_unlock_with_timeout":return"Set(17)";case"outside_handle_unlock":return"Set(32)";case"outside_handle_unlock_with_timeout":return"Set(33)";case"lock":return"Set(255)";}return null;},resolveState:function resolveState(e){if(!e||!e.data)return null;var t=[];if(e.data.mode){var a=this._MODE[e.data.mode.value];a&&t.push({id:"98.mode",state:a});}if(e.data.opType){var n=1==e.data.opType.value?"constant":"autolock";n&&t.push({id:"98.op_mode",state:n});}return 0==t.length?null:t;},getSimplifiedJSON:function getSimplifiedJSON(e){return e&&e.data?{98:{name:"DoorLock",type:e.name}}:null;}}},ZWay=function ZWay(e,t,a,n){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.ZWay"),this._learnHandler=new LearnHandler(this),this._ip=e,this._port=t,this._username=a,this._password=n,this._data=null,this._dataUpdateListeners=[],this._dataUpdateRunning=!1,this._dataUpdateCB=[],this._dataUpdatePeriod=1e3,this._dataUpdateTO=null,this._dataFullRunning=!1,this._dataFullCB=[],this._dataFullPeriod=1e4,this._running=!1;};return ZWay.prototype.start=function(e){this._running||(this._running=!0,this._getDataFull()),e&&e();},ZWay.prototype.stop=function(e){this._running&&(this._running=!1),this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null),e&&e();},ZWay.prototype.addDataUpdateListener=function(e){e&&-1==this._dataUpdateListeners.indexOf(e)&&this._dataUpdateListeners.push(e);},ZWay.prototype.removeDataUpdateListener=function(e){if(e){var t=this._dataUpdateListeners.indexOf(e);-1!=t&&this._dataUpdateListeners.splice(t,1);}},ZWay.prototype.getData=function(){return this._data;},ZWay.prototype.getDevices=function(){return this._data&&this._data.devices?this._data.devices:null;},ZWay.prototype.getDevice=function(e){return e&&this._data&&this._data.devices?this._data.devices[e]:null;},ZWay.prototype.getSimplifiedJSON=function(e){if(!this._data||!this._data.devices||!this._data.devices[e])return null;var t=this._data.devices[e];if(!t.data||!t.instances)return null;var n=t.data,r={};r.id=e,r.basicType=n.basicType?n.basicType.value:null,r.genericType=n.genericType?n.genericType.value:null,r.specificType=n.specificType?n.specificType.value:null,r.type=n.deviceTypeString?n.deviceTypeString.value:null,r.vendor=n.vendorString?n.vendorString.value:null,r.name=n.givenName?n.givenName.value:null,r.interViewProgress=this.getInterviewProgress(e);var i,s,l=this.listInterviewResults(e);for(i in r.instanceInterViewProgress={},l){if(l[i]&&l[i].commandClasses){s=l[i].commandClasses;var o=0,u=0;for(var d in s){o+=1,s[d]&&s[d].interviewDone&&(u+=1);}r.instanceInterViewProgress[i]=Math.round(100*u/o);}}r.instance={};var v=t.instances;for(i in v){var c=v[i];if(c&&c.commandClasses)for(var h in r.instance[i]={commandClasses:{}},s=c.commandClasses){var p=s[h];if(p){var _=null,g=a.getCommandClassFromId(h);if(g&&(_=g.getSimplifiedJSON(p)),_)for(var f in _){r.instance[i].commandClasses[f]=_[f];}}}}return r;},ZWay.prototype.getInterviewProgress=function(e){var t=this.getDevice(e);if(!t)return-1;var a=0,n=0;for(var r in t.instances){var i=t.instances[r];if(i&&i.commandClasses)for(var s in i.commandClasses){var l=i.commandClasses[s];l&&l.data&&l.data.interviewDone&&(a+=1,l.data.interviewDone.value&&(n+=1));}}return Math.round(n/a*100);},ZWay.prototype.listInterviewResults=function(e){var t=this.getDevice(e);if(!t)return null;var a={};for(var n in t.instances){var r=t.instances[n];if(r&&r.commandClasses)for(var i in r.commandClasses){var s=r.commandClasses[i];s&&s.data&&s.data.interviewDone&&(a[n]||(a[n]={commandClasses:{}}),a[n].commandClasses[i]={interviewDone:s.data.interviewDone.value});}}return a;},ZWay.prototype.executeCommand=function(e,t,n){if(e&&t){t.value||(t={value:t});var r=e.split(".");if(r.length<3)n&&n(new Error("address invalid"));else if(this._data&&this._data.devices){var i=this._data.devices[r[0]];if(i){if(i.instances&&i.instances[r[1]]){var s=i.instances[r[1]];if(s.commandClasses&&s.commandClasses[r[2]]){var l=s.commandClasses[r[2]],o=null,u=a.getCommandClassFromId(r[2]);if(u&&(o=u.buildCMD(t,r,l)),o){if(-1!=o){var d="devices["+r[0]+"].instances["+r[1]+"].commandClasses["+r[2]+"].";d+=o;var v=this;this._doRunRequest(d,null,function(t){t||v._postCommandExecution(i,e),n&&n(t);});}else n&&n();}else n&&n(new Error("command invalid"));}else n&&n(new Error("no such command class:"+r[2]));}else n&&n(new Error("no such instance:"+r[1]));}else n&&n(new Error("no such device with id:"+r[0]));}else n&&n(new Error("initialization not finish"));}else n&&n(new Error("address or command is null"));},ZWay.prototype._postCommandExecution=function(e,t){if(e&&t&&e.data&&e.data.vendorString&&"Fibaro"==e.data.vendorString.value){var a=t.split(".");"64"!=a[2]&&"67"!=a[2]||setTimeout(function(){x.hub.m.zway.PollManager._pollCommandClass([t]);},2e3);}},ZWay.prototype.getStates=function(e){var t=this._getStates();e&&e(null,t);},ZWay.prototype._getStates=function(){if(!this._data||!this._data.devices)return{};var e={};for(var t in this._data.devices){if(1!=t){var a=this._getState(t);if(a)for(var n in a){e[n]=a[n];}}}return e;},ZWay.prototype._getState=function(e){if(!this._data||!this._data.devices)return null;var t=this._data.devices[e];return this._resolveDeviceState(e,t);},ZWay.prototype._resolveDeviceState=function(e,t){if(!t)return null;var n=e,r={};if(t&&t.instances)for(var i in t.instances){var s=t.instances[i];if(s.commandClasses)for(var l in s.commandClasses){var o=s.commandClasses[l],u=null,d=a.getCommandClassFromId(l);if(d&&(u=d.resolveState(o,i,n)),u)for(var v=0;v<u.length;v++){var c=null,h=null;u[v].id&&(c=e+"."+i+"."+u[v].id),void 0!==u[v].state&&null!=u[v].state&&(h=u[v].state),c&&void 0!==h&&null!=h&&(r[n]||(r[n]={}),r[n][c]=h);}}}return r;},ZWay.prototype.inclusion=function(e,t){this._learnHandler.inclusion(e,t);},ZWay.prototype.exclusion=function(e,t){this._learnHandler.exclusion(e,t);},ZWay.prototype.updateInterview=function(e,t,a,n,r){this._learnHandler.updateInterview(e,t,a,n,r);},ZWay.prototype.resetController=function(e){this._resetController(e);},ZWay.prototype.backup=function(e,t){this._logger.log("debug","backup zwave to folder:"+e);var a={host:this._ip,port:this._port,path:"/ZWaveAPI/Backup",method:"GET"};this._username&&(a.auth=this._username+":"+(this._password?this._password:"")),this._logger.log("trace","send http request:"+JSON.stringify(a));var n=t,r=this,i=require("http").request(a,function(t){if(200!=t.statusCode)return n&&n(new Error("http status code:"+t.statusCode)),void(n=null);var a=require("fs"),r=require("path").join(e,"z-way-backup.zbk");if(a.existsSync(r))try{a.unlinkSync(r);}catch(e){return n&&n(e),void(n=null);}var i=a.createWriteStream(r);t.pipe(i),i.on("finish",function(){i.close(function(){n&&n(null,r),n=null;});}),i.on("error",function(e){a.unlink(r),n&&n(e),n=null;});});i.on("error",function(e){r._logger.log("trace","http request error:"+e.stack),n&&n(e),n=null;}),i.setTimeout(1e4,function(){r._logger.log("trace","http request timeout"),n&&n(new Error("http timeout")),n=null;}),i.end();},ZWay.prototype.restore=function(e,t,a){this._logger.log("debug","restore zwave (restoreStick="+t+") from file:"+e);var n=require("form-data"),r=require("fs"),i=new n();i.append("config_backup",r.createReadStream(e));var s={host:this._ip,port:this._port,path:"/ZWave.zway/Restore?restore_chip_info="+(t?1:0),method:"POST",headers:i.getHeaders()};this._username&&(s.auth=this._username+":"+(this._password?this._password:"")),this._logger.log("trace","send http request:"+JSON.stringify(s));var l=require("http"),o=a,u=this,d=l.request(s,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){u._logger.log("trace","http response status:"+e.statusCode),u._logger.log("trace","http response data:"+t);var a=null;200!=e.statusCode?(a=new Error("http response "+e.statusCode+" data:"+t),o&&o(a,t,e.statusCode),o=null):setTimeout(function(){o&&o(null,t,e.statusCode),o=null;},15e3);});});d.on("error",function(e){u._logger.log("trace","http request error:"+e.stack),o&&o(e),o=null;}),d.setTimeout(1e4,function(){u._logger.log("trace","http request timeout"),o&&o(new Error("http timeout")),o=null;}),i.pipe(d);},ZWay.prototype.pollDataUpdate=function(){this._data?this._getDataUpdate():this._getDataFull();},ZWay.prototype._onDataUpdate=function(e){if(this._running){var t=this;if(this._dataUpdateTO&&clearTimeout(this._dataUpdateTO),this._dataUpdateTO=setTimeout(function(){t.pollDataUpdate();},this._dataUpdatePeriod),e){var a=Object.keys(e);a.length>1&&this._logger.log("info","get data update:"+JSON.stringify(e));var n=null;a.forEach(function(a){if("updateTime"!=a){if("devices"!=a){var r=a.split(".");if(r.length>2&&"devices"==r[0]){var i=r[1],s=t._data.devices[i];n||(n={}),n[i]||(n[i]={device:s,updates:{}}),n[i].updates[a]=e[a];}for(var l=t._data,o=0;o<r.length-1;){l[r[o]]||(l[r[o]]={}),l=l[r[o]],o++;}if(l){var u=l[r[r.length-1]],d=e[a];u&&d&&u.updateTime==d.updateTime?n&&delete n[r[1]].updates[a]:l[r[r.length-1]]=e[a];}}else t._data.devices=e[a];}else t._data[a]=e[a];}),n&&this._onDeviceEvent(n),this._dataUpdateListeners.forEach(function(t){t&&t(e);});}}},ZWay.prototype._onDataFull=function(e){if(this._running){this._logger.log("info","get data full:"+JSON.stringify(e));var t=this;this._dataUpdateTO&&clearTimeout(this._dataUpdateTO);var a=this._dataUpdatePeriod;e||(a=this._dataFullPeriod),this._dataUpdateTO=setTimeout(function(){t.pollDataUpdate();},a),this._data=e;}},ZWay.prototype._onDeviceEvent=function(t){if(t)for(var n in t){var r=t[n];if(r&&r.updates){var i=!1,s={instances:{}};for(var l in r.updates){var o=l.split(".");if("instances"==o[2])if((d=o[3])&&"commandClasses"==o[4]){var u=parseInt(o[5]);-1!=a.LIST.indexOf(u)&&(i=!0,s.instances[d]||(s.instances[d]={}),s.instances[d][u]||(s.instances[d][u]={data:{}}),"data"==o[6]&&(o[7]?s.instances[d][u].data[o[7]]=r.updates[l]:s.instances[d][u].data=r.updates[l]));}}for(var d in s.instances){var v=s.instances[d];for(var u in v){var c=v[u],h=a.getCommandClassFromId(u);h&&h.resolveUpdate&&h.resolveUpdate(c,d,n);}}if(i){var p=this._getState(n);if(p&&p[n]){var _=p[n];if(e.updateState(n,_)){var g={type:"ZWAVE2",adr:n,state:p[n]};UdpEventProducer_sendSTAEvent(g);}}}}}},ZWay.prototype._startInclusion=function(e){var t=this;this._doRunRequest("controller.AddNodeToNetwork(1)",null,function(a,n,r){a?t._logger.log("warn","start include device error:"+a.stack):200!=r?(a=new Error("start include device http response code:"+r),t._logger.log("warn","start include device  http error:"+r+" data:"+n)):t._logger.log("debug","start include device success:"+n),e&&e(a,n);});},ZWay.prototype._stopInclusion=function(e){var t=this;this._doRunRequest("controller.AddNodeToNetwork(0)",null,function(a,n,r){a?t._logger.log("warn","stop include device error:"+a.stack):200!=r?(a=new Error("stop include device http response code:"+r),t._logger.log("warn","stop include device  http error:"+r+" data:"+n)):t._logger.log("debug","stop include device success:"+n),e&&e(a,n);});},ZWay.prototype._startExclusion=function(e){var t=this;this._doRunRequest("controller.RemoveNodeFromNetwork(1)",null,function(a,n,r){a?t._logger.log("warn","start exclude device error:"+a.stack):200!=r?(a=new Error("start exclude device http response code:"+r),t._logger.log("warn","start exclude device http error:"+r+" data:"+n)):t._logger.log("debug","start exclude device success:"+n),e&&e(a,n);});},ZWay.prototype._stopExclusion=function(e){var t=this;this._doRunRequest("controller.RemoveNodeFromNetwork(0)",null,function(a,n,r){a?t._logger.log("warn","stop exclude device error:"+a.stack):200!=r?(a=new Error("stop exclude device http response code:"+r),t._logger.log("warn","stop exclude device http error:"+r+" data:"+n)):t._logger.log("debug","stop exclude device success:"+n),e&&e(a,n);});},ZWay.prototype._startUpdateInterview=function(e,t,a,n){var r=this.getDevice(e);if(r){var i=[];if(void 0!==t&&null!=t&&a)i.push({deviceID:e,instanceID:t,commandClassID:a});else for(var s in r.instances){var l=r.instances[s];if(l&&l.commandClasses)for(var o in l.commandClasses){var u=l.commandClasses[o];if(u&&u.data&&u.data.interviewDone&&!u.data.interviewDone.value){var d={deviceID:e,instanceID:s,commandClassID:o};i.push(d);}}}if(0!=i.length){var v=this,c=0,cb=function cb(){++c!=i.length?v._startInterview(i[c].deviceID,i[c].instanceID,i[c].commandClassID,cb):n&&n();};this._startInterview(i[c].deviceID,i[c].instanceID,i[c].commandClassID,cb);}else n&&n();}else n&&n(new Error("no such device:"+e));},ZWay.prototype._startInterview=function(e,t,a,n){var r=e+"."+t+"."+a;this._logger.log("debug","start interview:"+r);var i=this,s="devices["+e+"].instances["+t+"].commandClasses["+a+"].Interview()";this._doRunRequest(s,null,function(e,t,a){e?i._logger.log("warn","start interview "+r+" error:"+e.stack):200!=a?(e=new Error("start interview "+r+" http response code:"+a),i._logger.log("warn","start interview "+r+" http error:"+a+" data:"+t)):i._logger.log("debug","start interview "+r+" success:"+t),n&&n(e,t);});},ZWay.prototype._resetController=function(e){var t=this;this._doRunRequest("controller.SetDefault()",null,function(a,n,r){a?t._logger.log("warn","reset controller error:"+a.stack):200!=r?(a=new Error("reset controller http response code:"+r),t._logger.log("warn","reset controller http error:"+r+" data:"+n)):t._logger.log("debug","reset controller success:"+n),e&&e(a,n);});},ZWay.prototype._getDataFull=function(e){if(e&&-1==this._dataFullCB.indexOf(e)&&this._dataFullCB.push(e),!this._dataFullRunning){this._dataFullRunning=!0,this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var t=this;this._logger.log("debug","get data all"),this._doDataRequest(null,function(e,a,n){e?t._logger.log("warn","get data full error:"+e.stack):200!=n?(e=new Error("get data http response code:"+n),t._logger.log("warn","get data full http error:"+n+" data:"+a)):t._logger.log("debug","get data full success:"+JSON.stringify(a)),t._dataFullRunning=!1;var r=t._dataFullCB;t._dataFullCB=[],!e&&a?t._onDataFull(a):e&&t._onDataFull(null),r.forEach(function(t){t&&t(e,a);});});}},ZWay.prototype._getDataUpdate=function(e){if(e&&-1==this._dataUpdateCB.indexOf(e)&&this._dataUpdateCB.push(e),!this._dataUpdateRunning){this._dataUpdateRunning=!0,this._dataUpdateTO&&(clearTimeout(this._dataUpdateTO),this._dataUpdateTO=null);var t=this,a=this._data.updateTime;a||(a=Math.floor(new Date().getTime()/1e3)),this._logger.log("trace","get data update with timestamp:"+a),this._doDataRequest(a,function(e,a,n){e?t._logger.log("warn","get data update error:"+e.stack):200!=n?(e=new Error("get data update http response code:"+n),t._logger.log("warn","get data update  http error:"+n+" data:"+a)):t._logger.log("debug","get data update success:"+JSON.stringify(a)),t._dataUpdateRunning=!1;var r=t._dataUpdateCB;t._dataUpdateCB=[],!e&&a?t._onDataUpdate(a):e&&t._onDataUpdate(null),r.forEach(function(t){t&&t(e,a);});});}},ZWay.prototype._doDataRequest=function(e,t){var a="/ZWaveAPI/Data/";e&&(a+=e);var n=1e4;e&&(n=1e3);var r=this;this._logger.log("trace","get data with path:"+a),this._doRequest(a,null,null,n,function(e,n,i){if(e)return r._logger.log("trace","get data with path:"+a+" error:"+e.stack),void(t&&t(e));r._logger.log("trace","get data with path:"+a+" status:"+i),r._logger.log("trace","get data result:"+n);try{var s=JSON.parse(n);t&&t(null,s,i);}catch(e){t&&t(e);}});},ZWay.prototype._doRunRequest=function(e,t,a){var n="/ZWaveAPI/Run/"+e;t||(t=1e3);var r=this;this._logger.log("trace","do run request:"+n),this._doRequest(n,null,null,t,function(e,t,i){if(e)return r._logger.log("trace","do run request with path:"+n+" error:"+e.stack),void(a&&a(e));r._logger.log("trace","do run request with path:"+n+" status:"+i),r._logger.log("trace","do run request result:"+t),a&&a(null,t,i);});},ZWay.prototype._doRequest=function(e,t,a,n,r){var i={host:this._ip,port:this._port,path:e,method:"POST"};t&&(i.headers=t),a&&(i.headers["Content-Length"]=a.length),this._username&&(i.auth=this._username+":"+(this._password?this._password:""));var s=r,l=this;this._logger.log("trace","send http request:"+JSON.stringify(i)),this._logger.log("trace","send http data:"+a);var o=require("http").request(i,function(e){var t="";e.setEncoding("utf-8"),e.on("data",function(e){t+=e;}),e.on("end",function(){l._logger.log("trace","http response status:"+e.statusCode),l._logger.log("trace","http response data:"+t);var a=null;200!=e.statusCode&&(a=new Error("http response "+e.statusCode+" data:"+t)),s&&s(a,t,e.statusCode);});});o.on("error",function(e){l._logger.log("trace","http request error:"+e.stack),s&&s(e),s=null;}),o.setTimeout(n,function(){l._logger.log("trace","http request timeout"),s&&s(new Error("http timeout")),s=null;}),a&&o.write(a),o.end();},ZWay;}(),x.hub.m.zway.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.m.zway.Handler"),this._zway=null,this._pollManager=x.hub.m.zway.PollManager,this._settingsManager=x.hub.m.zway.SettingsManager;};return util.inherits(Handler,EventEmitter),Handler.prototype.ZWay=x.hub.m.zway.ZWay,Handler.prototype.getSystems=function(){return["zway"];},Handler.prototype.init=function(e){this._logger.log("debug","init zway");var t=this,a=require("x.hub.eventbus.js");a.on("x.hub.peripheralman.ADD_ZWAVE",function(e){t._logger.log("debug","insert zwave usb stick"),t._logger.log("info","connect to local zwave server"),t._start();}),a.on("x.hub.peripheralman.REMOVE_ZWAVE",function(e){t._logger.log("debug","eject zwave usb stick"),t._logger.log("info","disconnect from local zwave server"),t._stop();}),global.ZWAVE2_URL&&"A20"!=global.PLATFORM&&"PI-CM3+"!=global.PLATFORM&&(this._logger.log("info","connect to remote zwave server"),this._start()),this._pollManager.init(this,function(){t._settingsManager.init(t,function(){e&&e({});});});},Handler.prototype._start=function(){this._zway||("CA"==global.HARDWARE_VERSION?this._zway=new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT,"mediola","mediola"):this._zway=new this.ZWay(global.ZWAVE2_URL,global.ZWAVE2_PORT)),this._zway.start();},Handler.prototype._stop=function(){this._zway&&(this._zway.stop(),this._zway=null);},Handler.prototype.getAllStates=function(){return this._zway?this._zway._getStates():null;},Handler.prototype.executeCommand=function(e,t,a){e&&e.address&&e.type?t&&t.value?this._ozw?this._ozw.executeCommand(e,t.value,function(e){a&&a({error:e});}):a&&a({error:new Error("zwave serial not initialized")}):a&&a({error:new Error("command invalid")}):a&&a({error:new Error("device invalid")});},Handler.prototype.learnDevice=function(e,t,a){this._zway?this._zway.inclusion(t,function(e,t){a&&a({error:e,data:t});}):a&&a({error:new Error("zwave module not running")});},Handler.prototype.removeDevice=function(e,t){this._zway?this._zway.exclusion(e?e.address:-1,function(e,a){t&&t({error:e,data:{deviceID:a}});}):t&&t({error:new Error("zwave module not running")});},Handler.prototype.listDevices=function(e,t){if(this._zway){var a=this._zway.getDevices();if(a){var n=[];for(var r in a){if(r){var i=this._zway.getSimplifiedJSON(r);i&&n.push(i);}}t&&t({data:n});}else t&&t({data:[]});}else t&&t({error:new Error("zwave module not running")});},Handler.prototype.updateInterview=function(e,t,a,n,r){this._zway?this._zway.updateInterview(e,t,a,n,function(e,t){r&&r({error:e,data:t});}):r&&r({error:new Error("zwave module not running")});},Handler.prototype.listInterviewResults=function(e,t){if(this._zway){if(e&&e.address){var a=this._zway.listInterviewResults(e.address);t&&t({data:a});}else{var n=this._zway.getDevices();if(!n)return void(t&&t({data:[]}));var r={};for(var i in n){if(i){var s=this._zway.listInterviewResults(i);s&&(r[i]||(r[i]={instances:{}}),r[i].instances=s);}}t&&t({data:r});}}else t&&t({error:new Error("zwave module not running")});},Handler.prototype.resetController=function(e){this._zway?this._zway.resetController(function(t,a){e&&e({error:t});}):e&&e({error:new Error("zwave module not running")});},Handler.prototype.getAllStatesLegacy=function(e){var t=[],a=this.getAllStates();if(a)for(var n in a){var r={type:"ZWAVE2",adr:n,state:a[n]};t.push(r);}e&&e({data:t});},Handler.prototype.executeCommandLegacy=function(e,t,a){this._zway?e?t?this._zway.executeCommand(e,t,function(e){a&&a({error:e});}):a&&a({error:new Error("command invalid")}):a&&a({error:new Error("address invalid")}):a&&a({error:new Error("zwave module not running")});},Handler.prototype.getZway=function(){return this._zway;},Handler.prototype.startPoller=function(e,t){this._pollManager.startPoller(e,t);},Handler.prototype.stopPoller=function(e){this._pollManager.stopPoller(e);},Handler.prototype.forcePoll=function(e,t){this._pollManager.immediatelyPoll(e),t&&t({data:{}});},Handler.prototype.setDeviceSetting=function(e,t,a){this._zway?this._zway.getData()?e?t?this._settingsManager.setSetting(e,t,function(e,t){a&&a({error:e||null,data:t?t.toJSON():null});}):a&&a({error:new Error("setting json invalid")}):a&&a({error:new Error("device id invalid")}):a&&a({error:new Error("zwave module initialization not finish")}):a&&a({error:new Error("zwave module not running")});},Handler.prototype.getDeviceSetting=function(e,t){this._zway?this._zway.getData()?e?this._settingsManager.getSetting(e,function(e,a){t&&t({error:e||null,data:a?a.toJSON():null});}):t&&t({error:new Error("device id invalid")}):t&&t({error:new Error("zwave module initialization not finish")}):t&&t({error:new Error("zwave module not running")});},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zway.Handler());