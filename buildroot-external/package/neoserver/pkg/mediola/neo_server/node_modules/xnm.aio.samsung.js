var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.samsung=xnm.aio.samsung||{},xnm.aio.samsung.TV=function(){var CommandTask=function CommandTask(e,t){this.code=e,this.callback=t,this._tv=null,this._socket=null,this._state=0;};CommandTask.prototype.run=function(e){this._tv=e;var t=this,r={onError:function onError(e){t._finish(e);},onTimeout:function onTimeout(){t._finish(new Error("response timeout"));},onData:function onData(r){if(2==t._state){var a,n=e._resolveAuthRsp(e._hex2arr(r));if(1!=n){var o="";-1==n?o="data format invalid":2==n?o="access denied":3==n?o="waiting for grant":4==n&&(o="timeout or cancelled");var s=new Error("auth error:"+o);return s.code=n,t._socket.end(),void t._finish(s);}if(t._state=3,t.code)if(t.code.length<20){var i=e._str2b64arr(t.code.trim()),u=[i.length+5,0,0,0,0,i.length,0];u=u.concat(i),a=e._buildReq(u);}else a=e._buildReq(e._hex2arr(t.code.trim()));e._logger&&e._logger.log("trace","send samsung request:"+e._arr2hex(a)),t._socket.write(new Buffer(a));}else 3==t._state&&(t._socket.end(),t._finish());},onClose:function onClose(){t._finish();}};this._state=1,e._connect(r,function(r,a){if(r)t._finish(r);else{t._socket=a;var n=e._buildAuth();t._state=2,e._logger&&e._logger.log("trace","send samsung auth request:"+e._arr2hex(n)),a.write(new Buffer(n));}});},CommandTask.prototype._finish=function(e){e&&this._tv._logger.log("warn","execute samsung command error:"+e.message),this.callback&&this.callback(e),this.callback=null,this._tv._finishTask(this);};var TV=function TV(e,t){this.ip=e,this.port=t,this.port||(this.port=55e3),this._logger=require("x.logger.js").getLogger("xnm.aio.samsung.TV"),this._tasks=[];};return TV.HEADER=[0,19,0,105,112,104,111,110,101,46,105,97,112,112,46,115,97,109,115,117,110,103],TV.prototype._executeCommand=function(e,t){var r=new CommandTask(e,t);this._addTask(r);},TV.prototype._addTask=function(e){var t=this._tasks.length;this._tasks.push(e),0==t&&this._doNextTask();},TV.prototype._doNextTask=function(){this._tasks&&this._tasks.length>0&&this._tasks[0].run(this);},TV.prototype._finishTask=function(e){this._tasks&&this._tasks[0]===e&&(this._tasks.splice(0,1),this._doNextTask());},TV.prototype._buildAuth=function(){var e=this._str2b64arr("127.0.0.1"),t=[255&e.length,e.length>>8&255],r=this._str2b64arr("00-00-00-00-00-00"),a=[255&r.length,r.length>>8&255],n=this._str2b64arr("aioRemote"),o=[255&n.length,n.length>>8&255],s=4+e.length+2+r.length+2+n.length,i=[255&s,s>>8&255];return[].concat(TV.HEADER).concat(i).concat([100,0]).concat(t).concat(e).concat(a).concat(r).concat(o).concat(n);},TV.prototype._resolveAuthRsp=function(e){if(e.length<3)return-1;var t=(e[2]<<8)+e[1];if(e.length<3+t)return-1;var r=e.slice(3+t);if(r.length<2)return-1;var a=(r[1]<<8)+r[0];return r.length<2+a?-1:101==(r=r.slice(2,2+a))[0]?4:10==r[0]?3:100==r[0]&&0==r[2]?2:100==r[0]&&1==r[2]?1:-1;},TV.prototype._buildReq=function(e){return[].concat(TV.HEADER).concat(e);},TV.prototype._str2b64arr=function(e){for(var t=new Buffer(e).toString("base64"),r=[],a=0;a<t.length;a++){var n=t.charCodeAt(a);r.push(n);}return r;},TV.prototype._hex2arr=function(e){for(var t=[],r=0;r<e.length;r+=2){t.push(parseInt(e.substr(r,2),16));}return t;},TV.prototype._arr2hex=function(e){for(var t="",r=0;r<e.length;r++){for(var a=e[r].toString(16);a.length<2;){a="0"+a;}t+=a.toUpperCase();}return t;},TV.prototype._connect=function(e,t){var r=this,a={port:this.port,host:this.ip},n=!1,o=t,s=require("net").connect(a);e.__socket=s,s.setTimeout(1e4),s.setEncoding("hex"),s.on("connect",function(){if(r._logger.log("trace","connect tcp to:"+r.ip),n=!0,o){var t=e.__socket;delete e.__socket,o(null,t);}}),s.on("data",function(t){r._logger.log("trace","receive from tcp:"+r.ip+" data:"+t),e.onData(t);}),s.on("error",function(t){n?(r._logger.log("trace","tcp:"+r.ip+" error:"+t.message),s.end(),e.onError(t)):(r._logger.log("trace","tcp:"+r.ip+" connection error:"+t.message),o&&(o(t),o=null));}),s.on("timeout",function(){n?(r._logger.log("trace","tcp:"+r.ip+" data timeout"),s.end(),e.onTimeout()):(r._logger.log("trace","tcp:"+r.ip+" connection timeout"),s.end(),o&&(o(new Error("connection timeout")),o=null));}),s.on("close",function(){r._logger.log("trace","tcp:"+r.ip+" close socket"),e.onClose();}),s._doConnect&&"function"==typeof s._doConnect&&s._doConnect();},TV;}(),xnm.aio.samsung.SmartHomeCloud=function(){var e=null,t=0,SmartHomeCloud=function SmartHomeCloud(r,a){"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.samsung.SmartHomeCloud"),this._accessKey=r,this.accessToken=null,this.userID=null,this._appID="4199tgd4z8",this._appSecret="8913F3FF4E064526126408E0AD6E5911",this._channelKey="npbKUFXrEeIxhTwz3L3KrDI1GdooCfS37bG1dmSKctk=",this.accessToken=null,this.userID=null,e||(e=xnm.aio.samsung.SmartHomeCloud._StatusBuffer,t=xnm.aio.samsung.SmartHomeCloud._StatusBufferTO),a?(this._server="simulator.cspserver.net",this._api="/api"):(this._server="api2.cspserver.net",this._api="/bridge/api"),this.CommandHandler=null,this._getStateRunning=!1,this._getStateCallbacks=[];};return SmartHomeCloud.prototype._sendRequest=function(e,t,r,a){var n=this;if(!this.accessToken||!this.userID)return n._logger.log("debug","no accessToken or userID, do get auth token"),void this._getAuthToken(function(o){o?a&&a(o):n._sendRequest(e,t,r,a);});this._doRequest(e,t,r,function(o,s,i){if(o&&401==i)return n._logger.log("debug","send request auth error"),void n._getAuthToken(function(o){o?a&&a(o):n._doRequest(e,t,r,a);});a&&a(o,s);});},SmartHomeCloud.prototype._doRequest=function(e,t,r,a){var n={host:this._server,path:this._api+t,method:e,headers:{"x-csp-channel-key":this._channelKey,"x-csp-appId":this._appID,"x-csp-userId":this.userID,Authorization:"Bearer "+this.accessToken,Connection:"close","Content-Type":"application/json;  charset=UTF-8"}};r&&(n.headers["Content-Length"]=r.length);var o=require("https");"undefined"!=typeof process&&null!=process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),this._logger.log("trace","do request:"+JSON.stringify(n));var s=this,i=a,u=o.request(n,function(e){e.setEncoding("utf-8");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var r,a;if(s._logger.log("trace","receive code:"+e.statusCode+" headers:"+JSON.stringify(e.headers)+" response:"+t),204!=e.statusCode)try{a=t?JSON.parse(t):{};}catch(e){r=e;}204==e.statusCode?a={}:401==e.statusCode?r=new Error("auth error"):200!=e.statusCode&&(r=new Error("http reponse:"+e.statusCode)),i&&(i(r,a,e.statusCode),i=null);});});u.on&&u.on("error",function(e){s._logger.log("trace","do request error:"+e.message),i&&(i(e),i=null);}),u.setTimeout&&u.setTimeout(2e3,function(){s._logger.log("trace","do request timeout"),u.abort(),i&&(i(new Error("timeout")),i=null);}),r&&(this._logger.log("trace","do request send body:"+r),u.write(r)),u.end();},SmartHomeCloud.prototype._getAuthToken=function(e){var t=this,r=e;$.ajax({type:"GET",url:"https://smsng.mediola.com/getAccessToken?ak="+this._accessKey,timeout:4e3,cache:!1,dataType:"json",success:function success(e){var a;t._logger.log("trace","get auth token response:"+JSON.stringify(e)),e&&e.XC_SUC?(t.userID=e.XC_SUC.user,t.accessToken=e.XC_SUC.token):a=e&&e.XC_ERR?Error(e.XC_ERR):new Error(JSON.stringify(e)),r&&(r(a,e,200),r=null);},error:function error(e,a){var n="get auth token error:"+(e?e.status:"0")+"-"+a;t._logger.log("trace",n),r&&(r(new Error(n),e?e.responseText:null,e?e.status:null),r=null);}});},SmartHomeCloud.prototype._getBufferedStatus=function(t){for(var r in e){if(e.hasOwnProperty(r)){var a=e[r];if(a&&a.states&&a.states[t])return a.states[t];}}return null;},SmartHomeCloud.prototype._getStates=function(r){var a=this;if(e[a._accessKey]&&e[a._accessKey].states){var n=e[a._accessKey].time;if(n&&new Date().getTime()-n<t)return void(r&&r(null,e[a._accessKey].states));}r&&-1==this._getStateCallbacks.indexOf(r)&&this._getStateCallbacks.push(r),this._getStateRunning||(this._getStateRunning=!0,this.getDevices(function(t,r){a._getStateRunning=!1;var n=a._getStateCallbacks;if(a._getStateCallbacks=[],t)n.forEach(function(e){e&&e(t);});else if(r&&r.Devices){var o={},s=r.Devices;if(s)for(var i=0;i<s.length;i++){if(s[i]&&s[i].id){var u=xnm.aio.samsung.SmartHomeCloud._AlarmBuffer[s[i].id],l=JSON.parse(JSON.stringify(s[i]));l.Alarms=u;var c=null;switch(l.type){case"Refrigerator":c=a._resolveFridgeStates(l);break;case"Washer":c=a._resolveWasherStates(l);break;case"Air_Conditioner":c=a._resolveACStates(l);break;case"Oven":c=a._resolveOvenStates(l);break;case"Dryer":c=a._resolveDryerStates(l);break;case"Robot_Cleaner":c=a._resolveRobotStates(l);break;case"Air_Purifier":c=a._resolveAPStates(l);}c&&(o[s[i].id]=c);}}e[a._accessKey]={time:new Date().getTime(),states:o},n.forEach(function(e){e&&e(null,o);});}else n.forEach(function(e){e&&e(null,{});});}));},SmartHomeCloud.prototype._resolveFridgeStates=function(e){var t={};if(void 0!==e.connected&&null!=e.connected&&(t.frdgConn=e.connected),e.Doors&&e.Doors.forEach(function(e){e&&e.id&&(e.openState&&(t["frdgDoorState"+e.id]="Close"==e.openState?"closed":"open"),e.name&&(t["frdgDoorName"+e.id]=e.name));}),e.Fridge&&e.Fridge.filterState){var r;switch(e.Fridge.filterState){case"1":r="good";break;case"2":r="order";break;case"3":r="replace";}r&&(t.frdgFilterState=r);}if(e.Temperatures&&e.Temperatures.forEach(function(e){if(e&&e.id){if(e.unit)switch(e.unit){case"Fahrenheit":t["frdgTempUnit"+e.id]="°F";break;case"Celsius":t["frdgTempUnit"+e.id]="°C";break;default:t["frdgTempUnit"+e.id]=e.unit;}void 0!==e.desired&&null!=e.desired&&(t["frdgTempState"+e.id]=parseFloat(e.desired).toFixed(1));}}),e.Mode&&e.Mode.modes&&(-1!=e.Mode.modes.indexOf("WATERFILTER_DISABLE")?t.frdgWFState="good":-1!=e.Mode.modes.indexOf("WATERFILTER_ENABLE")&&(t.frdgWFState="replace")),e.Alarms&&e.Alarms[0]){var a=e.Alarms[0].id,n=e.Alarms[0].code;switch(n){case"71E":n="Freeze_High_Temp";break;case"72E":n="Fridge_High_Temp";break;case"F-Alarm":switch(a){case"0":n="Freeze_Door_Alarm";break;case"1":n="Fridge_Door_Alarm";break;case"2":n="CV_Door_Alarm";break;case"3":n="Single_Door_Alarm";}}t.frdgError=n;}return t.frdgError||(t.frdgError=""),t;},SmartHomeCloud.prototype._resolveWasherStates=function(e){var t={};if(void 0!==e.connected&&null!=e.connected&&(t.wshConn=e.connected),e.Operation&&(e.Operation.progress&&(t.wshProgress=e.Operation.progress.toLowerCase()),e.Operation.state&&(t.wshState=e.Operation.state.toLowerCase()),e.Operation.remainingTime)){t.wshRTStr=e.Operation.remainingTime;var r=e.Operation.remainingTime.split(":");if(r.length>=2){var a=parseInt(r[0]),n=parseInt(r[1]);t.wshRT=60*a+n;}}return e.Configuration&&(t.wshSmC=e.Configuration.remoteControlEnabled?"on":"off"),e.Alarms&&e.Alarms[0]&&(t.wshError=e.Alarms[0].code),t.wshError||(t.wshError=""),t;},SmartHomeCloud.prototype._resolveACStates=function(e){var t,r,a={};if(void 0!==e.connected&&null!=e.connected)switch(e.deviceSubType){case"FAC":a.facConn=e.connected;break;case"Room_Air_Conditioner":a.racConn=e.connected;}if(e.Operation)switch(e.Operation.power&&(t=e.Operation.power.toLowerCase()),e.deviceSubType){case"FAC":a.facPower=t;break;case"Room_Air_Conditioner":a.racPower=t;}if(e.Temperatures&&e.Temperatures.forEach(function(t){if(t&&t.id){var r,n,o;if(t.unit){switch(t.unit){case"Fahrenheit":r="°F";break;case"Celsius":r="°C";break;default:r=t.unit;}switch(e.deviceSubType){case"FAC":a.facTempUnit=r;break;case"Room_Air_Conditioner":a.racTempUnit=r;}}if(void 0!==t.desired&&null!=t.desired)switch(o=parseFloat(t.desired).toFixed(1),e.deviceSubType){case"FAC":a.facSetTemp=o;break;case"Room_Air_Conditioner":a.racSetTemp=o;}if(void 0!==t.current&&null!=t.current)switch(n=parseFloat(t.current).toFixed(1),e.deviceSubType){case"FAC":a.facTemp=n;break;case"Room_Air_Conditioner":a.racTemp=n;}}}),e.Mode&&e.Mode.modes&&e.Mode.modes&&e.Mode.modes[0]){var n=e.Mode.modes[0];switch(e.deviceSubType){case"FAC":a.facMode=n;break;case"Room_Air_Conditioner":a.racMode=n;}}if(e.Mode&&e.Mode.options&&(-1!=e.Mode.options.indexOf("Smarton_LockOff")?r="on":-1!=e.Mode.options.indexOf("Smarton_LockOn")&&(r="off"),"FAC"===e.deviceSubType))a.facSmC=r;return e.Alarms&&e.Alarms[0]&&("Room_Air_Conditioner"==e.deviceSubType?a.racError=e.Alarms[0].code:a.facError=e.Alarms[0].code),"Room_Air_Conditioner"==e.deviceSubType?a.racError||(a.racError=""):a.facError||(a.facError=""),a;},SmartHomeCloud.prototype._resolveOvenStates=function(e){var t={},r=this._getBufferedStatus(e.id);if(r&&(t.ovenTemp=r.ovenTempRaw,t.ovenTempRaw=r.ovenTempRaw,t.ovenState=r.ovenState,t.ovenTempStr=r.ovenTempRaw),void 0!==e.connected&&null!=e.connected&&(t.ovenConn=e.connected),e.Temperatures&&e.Temperatures.forEach(function(e){if(e&&e.id){if(e.unit)switch(e.unit){case"Fahrenheit":t.ovenTempUnit="°F";break;case"Celsius":t.ovenTempUnit="°C";break;default:t.ovenTempUnit=e.unit;}void 0!==e.desired&&null!=e.desired&&(t.ovenTemp=parseFloat(e.desired).toFixed(1),t.ovenTempRaw=t.ovenTemp,t.ovenTempStr=t.ovenTemp);}}),e.Operation&&(e.Operation.state&&(t.ovenOp=e.Operation.state.toLowerCase()),e.Operation.operationTime&&(t.ovenOTStr=e.Operation.operationTime),e.Operation.remainingTime)){t.ovenRTStr=e.Operation.remainingTime;var a=e.Operation.remainingTime.split(":");if(a.length>=2){var n=parseInt(a[0]),o=parseInt(a[1]);t.ovenRT=60*n+o;}}if(e.Oven&&e.Oven.state&&(t.ovenState=e.Oven.state),e.Alarms&&e.Alarms[0]){var s=e.Alarms[0].code;switch(s){case"OV_T_0001":t.ovenError="Preheating finish";break;case"OV_T_0003":t.ovenError="Cooking finish";break;case"OV_T_0004":t.ovenError="Almost finished cooking";break;case"OV_T_0005":t.ovenError="Cooking was finished";break;case"OV_T_0006":t.ovenError="Cancellation while cooking";break;case"OV_T_0007":t.ovenError="Cleaning mode finish";break;case"OV_T_0008":t.ovenError="Cleaning mode cancel";break;default:"OV_E_"==s.substr(0,5)&&(t.ovenError="ErrorCode_"+s.substr(5));}}switch(t.ovenError||(t.ovenError=""),t.ovenState){case"Preheat":case"Cleaning":case"Draining":case"Cooling":case"Rinsing":t.ovenTemp=0,t.ovenTempStr="--";}return t;},SmartHomeCloud.prototype._resolveDryerStates=function(e){var t={};if(void 0!==e.connected&&null!=e.connected&&(t.dryConn=e.connected),e.Operation&&(e.Operation.progress&&(t.dryProgress=e.Operation.progress.toLowerCase()),e.Operation.state&&(t.dryState=e.Operation.state.toLowerCase()),e.Operation.remainingTime)){t.dryRTStr=e.Operation.remainingTime;var r=e.Operation.remainingTime.split(":");if(r.length>=2){var a=parseInt(r[0]),n=parseInt(r[1]);t.dryRT=60*a+n;}}return e.Configuration&&(t.drySmC=e.Configuration.remoteControlEnabled?"on":"off"),e.Alarms&&e.Alarms[0]&&(t.dryError=e.Alarms[0].code),t.dryError||(t.dryError=""),t;},SmartHomeCloud.prototype._resolveRobotStates=function(e){var t={};if(void 0!==e.connected&&null!=e.connected&&(t.rbtConn=e.connected),e.Mode&&e.Mode.modes){for(var r,a,n,o,s,i,u,l=0;l<e.Mode.modes.length;l++){var c=e.Mode.modes[l];switch(c&&"Control"==c.substr(0,7)?r=c:c&&"Cleaning"==c.substr(0,8)?a=c:c&&"Turbo"==c.substr(0,5)?n=c:c&&"Access"==c.substr(0,6)&&(o=c),c){case"Control_Homing":s="Stop cleaning & Return";break;case"Control_Idle":s="Idle";break;case"Control_Alarm":s="Alarming";break;case"Control_After":s="Returning for charging";break;case"Control_Charging":s="Charging";break;case"Control_Pause":s="Pause";break;case"Control_PowerOff":s="Power off";break;case"Control_Reserve":s="Clean reserved (one time)";break;case"Control_Cleaning":s="Cleaning status";break;case"Control_Point":s="Point Cleaning";break;case"Cleaning_Auto":i="Start cleaning";break;case"Cleaning_Part":i="Parts Cleaning";break;case"Cleaning_Repeat":i="Repeat cleaning";break;case"Cleaning_Manual":i="Manual cleaning";break;case"Cleaning_Stop":i="Stop";break;case"Turbo_On":u="Max";break;case"Turbo_Off":u="Normal";break;case"Turbo_Silence":u="Quiet";}}r&&s&&(t.rbtCtrMode=r,t.rbtCtrModeStr=s),a&&i&&(t.rbtClnMode=a,t.rbtClnModeStr=i),n&&u&&(t.rbtTrbMode=n,t.rbtTrbModeStr=u),"Control_Point"==t.rbtCtrMode&&(t.rbtClnMode="Cleaning_Manual",t.rbtClnModeStr="Manual cleaning"),"Access_UnLock"==o?t.rbtRC="on":"Access_Lock"==o&&(t.rbtRC="off");}if(e.Alarms&&e.Alarms[0]){var m=e.Alarms[0].code;t.rbtError="4"==m?"Normal":m;}return t.rbtError||(t.rbtError=""),t;},SmartHomeCloud.prototype._resolveAPStates=function(e){var t={};return void 0!==e.connected&&null!=e.connected&&(t.apConn=e.connected),e.Operation&&e.Operation.power&&(t.apPower=e.Operation.power.toLowerCase()),e.Sensors&&e.Sensors.forEach(function(e){if(e&&e.type&&e.values)switch(e.type){case"Dust":t.apDust=e.values[0],t.apDustLvl=e.values[1];break;case"FineDust":t.apFDust=e.values[0],t.apFDustLvl=e.values[1];break;case"Odor":t.apOdorLvl=e.values[0];}}),e.Wind&&(t.apWSLvl=e.Wind.speedLevel,0==e.Wind.speedLevel?t.apWS="Auto":1==e.Wind.speedLevel?t.apWS="Sleeping":2==e.Wind.speedLevel?t.apWS="Low":3==e.Wind.speedLevel?t.apWS="Medium":4==e.Wind.speedLevel&&(t.apWS="High")),e.Alarms&&e.Alarms[0]&&(t.apError=e.Alarms[0].code),t.apError||(t.apError=""),t;},SmartHomeCloud.prototype._executeCommand=function(e,t,r){if(e&&e.id&&e.type&&t&&t.value){var cb=function cb(e){r&&r(e);};switch(e.type){case"Washer":this._execWasherCmd(e,t,cb);break;case"Air_Conditioner":this._execACCmd(e,t,cb);break;case"Oven":this._execOvenCmd(e,t,cb);break;case"Dryer":this._execDryerCmd(e,t,cb);break;case"Robot_Cleaner":this._execRobotCmd(e,t,cb);break;case"Air_Purifier":this._execAPCmd(e,t,cb);break;default:r&&r(new Error("unknown device type"));}}else r&&r(new Error("parameter invalid"));},SmartHomeCloud.prototype._execWasherCmd=function(e,t,r){var a,n;switch(t.value){case"wshRun":a="Operation",n={Operation:{state:"Run"}};break;case"wshPause":a="Operation",n={Operation:{state:"Pause"}};break;case"wshCancel":a="Operation",n={Operation:{state:"Ready"}};}a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype._execACCmd=function(e,t,r){var a,n,o=this,s=this._getBufferedStatus(e.id);switch(t.value){case"facOn":case"racOn":a="Operation",n={Operation:{power:"On"}};break;case"facOff":case"racOff":a="Operation",n={Operation:{power:"Off"}};break;case"facToggle":case"racToggle":return void this._getStates(function(a,n){if(a)r&&r(a);else if(n&&n[e.id]){var s=n[e.id];if("on"==(s="facToggle"==t.value?s.facPower:s.racPower))o._execACCmd(e,{value:"facToggle"==t.value?"facOff":"racOff"},r);else{if("off"!=s)return void(r&&r(new Error("no valid status")));o._execACCmd(e,{value:"facToggle"==t.value?"facOn":"racOn"},r);}}else r&&r(new Error("no status"));});case"facSetTo":case"racSetTo":if(!t.ext)return void(r&&r(new Error("command invalid")));a="Temperatures",n={Temperatures:[{id:"0",desired:parseFloat(t.ext)}]};break;case"facTempUp":case"facTempDown":case"racTempUp":case"racTempDown":if(s&&("Wind"==s.racMode||"Wind"==s.facMode)){var i=null;return i="facTempUp"==t.value||"facTempDown"==t.value?"facError":"racError",xnm.aio.samsung.SmartHomeNotifyManager.onDummyNotification(e,i,"no temp. change in this mode"),void(r&&r(new Error("can not change temperature in wind mode")));}return t.ext?void this._getStates(function(a,n){if(a)r&&r(a);else if(n&&n[e.id]){var s,i,u=n[e.id],l=18,c=30;if("facTempUp"==t.value||"facTempDown"==t.value?(s=u.facSetTemp,i=u.facTempUnit):(s=u.racSetTemp,i=u.racTempUnit),s){s=parseFloat(s),"°F"==i&&(l=65,c=86);var m,d=parseFloat(t.ext);"facTempUp"==t.value||"racTempUp"==t.value?s+=d:"facTempDown"!=t.value&&"racTempDown"!=t.value||(s-=d),s>c&&(s=c),s<l&&(s=l),m="facTempUp"==t.value||"facTempDown"==t.value?"facSetTo":"racSetTo",o._execACCmd(e,{value:m,ext:s},r);}else r&&r(new Error("no valid status"));}else r&&r(new Error("no status"));}):void(r&&r(new Error("command invalid")));case"facSetMode":case"racSetMode":if(!t.ext)return void(r&&r(new Error("command invalid")));a="Mode",n={Mode:{modes:[t.ext]}};}a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype._execOvenCmd=function(e,t,r){var a,n;if("ovenStop"===t.value)a="Operation",n={Operation:{state:"Ready"}};a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype._execDryerCmd=function(e,t,r){var a,n;switch(t.value){case"dryRun":a="Operation",n={Operation:{state:"Run"}};break;case"dryPause":a="Operation",n={Operation:{state:"Pause"}};break;case"dryCancel":a="Operation",n={Operation:{state:"Ready"}};}a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype._execRobotCmd=function(e,t,r){var a,n;switch(t.value){case"rbtStart":a="Mode",n={Mode:{modes:["Cleaning_Auto"]}};break;case"rbtStop":a="Mode",n={Mode:{modes:["Control_Homing"]}};break;case"rbtTurbo":if(!t.ext)return void(r&&r(new Error("command ext invalid")));var o;switch(t.ext){case"Max":o="Turbo_On";break;case"Normal":o="Turbo_Off";break;case"Quiet":o="Turbo_Silence";break;default:return void(r&&r(new Error("command ext invalid")));}a="Mode",n={Mode:{modes:[o]}};}a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype._execAPCmd=function(e,t,r){var a,n,o=this;switch(t.value){case"apOn":a="Operation",n={Operation:{power:"On"}};break;case"apOff":a="Operation",n={Operation:{power:"Off"}};break;case"apToggle":return void this._getStates(function(t,a){if(t)r&&r(t);else if(a&&a[e.id]){var n=a[e.id];if("on"==(n=n.apPower))o._execAPCmd(e,{value:"apOff"},r);else{if("off"!=n)return void(r&&r(new Error("no valid status")));o._execAPCmd(e,{value:"apOn"},r);}}else r&&r(new Error("no status"));});case"rbtSetWS":case"rbtSetWSLvl":if(void 0===t.ext||null==t.ext)return void(r&&r(new Error("command invalid")));var s;if("rbtSetWS"==t.value)switch(t.ext){case"Auto":s=0;break;case"Sleeping":s=1;break;case"Low":s=2;break;case"Medium":s=3;break;case"High":s=4;}else s=parseInt(t.ext);s>4&&(s=4),s<0&&(s=0),a="Wind",n={Wind:{speedLevel:s}};break;case"rbtSetWSUp":case"rbtSetWSDown":return void this._getStates(function(a,n){if(a)r&&r(a);else if(n&&n[e.id]){var s;void 0!==(s=n[e.id].apWSLvl)&&null!=s?(s=parseInt(s),"rbtSetWSUp"==t.value?s+=1:"rbtSetWSDown"==t.value&&(s-=1),s>4&&(s=4),s<0&&(s=0),o._execAPCmd(e,{value:"rbtSetWSLvl",ext:s},r)):r&&r(new Error("no valid status"));}else r&&r(new Error("no status"));});}a&&n?this._sendRequest("PUT","/devices/"+e.id+"/"+a,JSON.stringify(n),function(e){r&&r(e);}):r&&r(new Error("command invalid"));},SmartHomeCloud.prototype.subscibe=function(e,t){var r={Subscriptions:e};this._sendRequest("POST","/subscriptions",JSON.stringify(r),function(e){t&&t(e);});},SmartHomeCloud.prototype.getDevices=function(e){this._sendRequest("GET","/devices",null,function(t,r){e&&e(t,r);});},SmartHomeCloud.prototype.getDeviceList=function(e){var _formatFridgeDevice=function _formatFridgeDevice(e){return e.sys="samsung_smarthome",delete e.resources,e;},_formatWasherDevice=function _formatWasherDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Operation,delete e.Configuration,e;},_formatACDevice=function _formatACDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Operation,delete e.Temperatures,delete e.Mode,e;},_formatOvenDevice=function _formatOvenDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Operation,delete e.Temperatures,delete e.Configuration,delete e.Oven,e;},_formatDryerDevice=function _formatDryerDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Operation,delete e.Configuration,e;},_formatRobotDevice=function _formatRobotDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Mode,e;},_formatAPDevice=function _formatAPDevice(e){return e.sys="samsung_smarthome",delete e.resources,delete e.Operation,delete e.Sensors,delete e.Wind,e;};this.getDevices(function(t,r){if(t)e&&e(t);else if(r&&r.Devices){for(var a=[],n=r.Devices,o=0;o<n.length;o++){var s=n[o],i=null;if(s){switch(s.type){case"Refrigerator":i=_formatFridgeDevice(s);break;case"Washer":i=_formatWasherDevice(s);break;case"Air_Conditioner":i=_formatACDevice(s);break;case"Oven":i=_formatOvenDevice(s);break;case"Dryer":i=_formatDryerDevice(s);break;case"Robot_Cleaner":i=_formatRobotDevice(s);break;case"Air_Purifier":i=_formatAPDevice(s);}i&&a.push(i);}}e&&e(null,a);}else e&&e(null,[]);});},SmartHomeCloud.prototype.executeCommand=function(e,t,r){cmd=JSON.stringify({Temperatures:[{desired:23,id:"0"}]}),this._doRequest("PUT","/devices/"+e.address+"/Temperatures",cmd,function(e){XC.debugf(e),r&&r();});},SmartHomeCloud.prototype.executeCommandCreator=function(e,t,r){this._executeCommand(e,t,r);},SmartHomeCloud.prototype.getStatesCreator=function(e,t,r){if(t){if(0!=t.length){this._getStates(function(e,a){if(e)r&&r(e);else{for(var n=[],o=0;o<t.length;o++){if(t[o]&&t[o].id){var s="?";t[o].device&&t[o].device.id&&t[o].status&&t[o].status.value&&a&&a[t[o].device.id]&&(void 0!==(s=a[t[o].device.id][t[o].status.value])&&null!=s||(s="?")),n.push({id:t[o].id,status:s});}}r&&r(null,n);}});}else r&&r(null,[]);}else r&&r(new Error("deviceList is null"));},SmartHomeCloud.prototype.equalsTo=function(e){return!!e&&e instanceof SmartHomeCloud&&this._accessKey==e._accessKey;},SmartHomeCloud.prototype.toJSON=function(){return{sys:"samsung_smarthome",accessKey:this._accessKey};},SmartHomeCloud.parseJSON=function(e){return e.accessKey?new SmartHomeCloud(e.accessKey,e.test):null;},SmartHomeCloud;}(),xnm.aio.samsung.SmartHomeCloud._StatusBuffer={},xnm.aio.samsung.SmartHomeCloud._StatusBufferTO=5e3,xnm.aio.samsung.SmartHomeCloud._AlarmBuffer={},xnm.aio.samsung.SmartHomeCloud.DM=function(){var e={command:[{type:"enum",name:"run",ref:{value:"wshRun"}},{type:"enum",name:"pause",ref:{value:"wshPause"}},{type:"enum",name:"cancel",ref:{value:"wshCancel"}}],status:[{type:"enum",name:"connected",ref:{value:"wshConn",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"wshState",options:["ready","run","pause"]}},{type:"enum",name:"progress",ref:{value:"wshProgress",options:["finish","delaywash","weightsensing","prewash","wash","rinse","spin","drying","cooling","wrinkleprevent","airwash","none"]}},{type:"string",name:"remaining time (string)",ref:{value:"wshRTStr"}},{type:"int",name:"remaining time",ref:{value:"wshRT",extMeta:"0-180"}},{type:"enum",name:"Smart Control state",ref:{value:"wshSmC",options:["on","off"]}},{type:"enum",name:"error state",ref:{value:"wshError",options:["FilterAlarm","DrumClean","ErrorCode_%d"]}}]},t={command:[{type:"enum",name:"power on",ref:{value:"facOn"}},{type:"enum",name:"power off",ref:{value:"facOff"}},{type:"enum",name:"power toggle",ref:{value:"facToggle"}},{type:"float",name:"set desired temperature",ref:{value:"facSetTo",ext:"%f",extMeta:"18.0-30.0",scale:"0.1",unit:"°C"}},{type:"float",name:"desired temperature up",ref:{value:"facTempUp",ext:"%f",extMeta:"0.1-5.0",scale:"0.1",unit:"°C"}},{type:"float",name:"desired temperature down",ref:{value:"facTempDown",ext:"%f",extMeta:"0.1-5.0",scale:"0.1",unit:"°C"}},{type:"enum",name:"set mode",ref:{value:"facSetMode",ext:"%e",extMeta:["Auto","Cool","Dry","Wind","Heat"]}}],status:[{type:"enum",name:"connected",ref:{value:"facConn",options:["true","false"]}},{type:"enum",name:"power",ref:{value:"facPower",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"facTemp"}},{type:"float",name:"desired temperature",ref:{value:"facSetTemp"}},{type:"enum",name:"temperature unit",ref:{value:"facTempUnit",options:["°C","°F","NotSupported"]}},{type:"enum",name:"mode",ref:{value:"facMode",options:["Auto","Cool","Dry","Heat","Wind","CoolClean","HeatClean","DryClean","NotSupported"]}},{type:"enum",name:"Smart Control state",ref:{value:"facSmC",options:["on","off"]}},{type:"enum",name:"error state",ref:{value:"facError",options:["FilterAlarm","FilterAlarm_OFF","ErrorCode_%d"]}}]},r={command:[{type:"enum",name:"power on",ref:{value:"racOn"}},{type:"enum",name:"power off",ref:{value:"racOff"}},{type:"enum",name:"power toggle",ref:{value:"racToggle"}},{type:"float",name:"set desired temperature",ref:{value:"racSetTo",ext:"%f",extMeta:"18.0-30.0",scale:"0.1",unit:"°C"}},{type:"float",name:"desired temperature up",ref:{value:"racTempUp",ext:"%f",extMeta:"0.1-5.0",scale:"0.1",unit:"°C"}},{type:"float",name:"desired temperature down",ref:{value:"racTempDown",ext:"%f",extMeta:"0.1-5.0",scale:"0.1",unit:"°C"}},{type:"enum",name:"set mode",ref:{value:"racSetMode",ext:"%e",extMeta:["Auto","Cool","Dry","Wind","Heat"]}}],status:[{type:"enum",name:"connected",ref:{value:"racConn",options:["true","false"]}},{type:"enum",name:"power",ref:{value:"racPower",options:["on","off"]}},{type:"float",name:"current temperature",ref:{value:"racTemp"}},{type:"float",name:"desired temperature",ref:{value:"racSetTemp"}},{type:"enum",name:"temperature unit",ref:{value:"racTempUnit",options:["°C","°F","NotSupported"]}},{type:"enum",name:"mode",ref:{value:"racMode",options:["Auto","Cool","Dry","Heat","Wind","NotSupported"]}},{type:"enum",name:"error state",ref:{value:"racError",options:["FilterAlarm","FilterAlarm_OFF","ErrorCode_%d"]}}]},a={command:[{type:"enum",name:"stop",ref:{value:"ovenStop"}}],status:[{type:"enum",name:"connected",ref:{value:"ovenConn",options:["true","false"]}},{type:"enum",name:"operation",ref:{value:"ovenOp",options:["run","ready"]}},{type:"string",name:"remaining time (string)",ref:{value:"ovenRTStr"}},{type:"int",name:"remaining time",ref:{value:"ovenRT",extMeta:"0-180"}},{type:"string",name:"operation time (string)",ref:{value:"ovenOTStr"}},{type:"float",name:"desired temperature",ref:{value:"ovenTemp"}},{type:"string",name:"desired temperature (string)",ref:{value:"ovenTempStr"}},{type:"enum",name:"temperature unit",ref:{value:"ovenTempUnit",options:["°C","°F","NotSupported"]}},{type:"enum",name:"state",ref:{value:"ovenState",options:["Preheat","Cooking","Cleaning","Draining","Rinsing","Cooling","Ready"]}},{type:"enum",name:"error state",ref:{value:"ovenError",options:["ErrorCode_%d"]}}]},n={command:[{type:"enum",name:"run",ref:{value:"dryRun"}},{type:"enum",name:"pause",ref:{value:"dryPause"}},{type:"enum",name:"cancel",ref:{value:"dryCancel"}}],status:[{type:"enum",name:"connected",ref:{value:"dryConn",options:["true","false"]}},{type:"enum",name:"state",ref:{value:"dryState",options:["ready","run","pause"]}},{type:"enum",name:"progress",ref:{value:"dryProgress",options:["finish","delaywash","weightsensing","drying","cooling","wrinkleprevent","none"]}},{type:"string",name:"remaining time (string)",ref:{value:"dryRTStr"}},{type:"int",name:"remaining time",ref:{value:"dryRT",extMeta:"0-180"}},{type:"enum",name:"Smart Control state",ref:{value:"drySmC",options:["on","off"]}},{type:"enum",name:"error state",ref:{value:"dryError",options:["FilterAlarm","DrumClean","ErrorCode_%d"]}}]},o={command:[{type:"enum",name:"start cleaning",ref:{value:"rbtStart"}},{type:"enum",name:"stop cleaning",ref:{value:"rbtStop"}},{type:"enum",name:"set turbo mode",ref:{value:"rbtTurbo",ext:"%e",extMeta:["Max","Normal","Quiet"]}}],status:[{type:"enum",name:"connected",ref:{value:"rbtConn",options:["true","false"]}},{type:"enum",name:"control mode",ref:{value:"rbtCtrMode",options:["Control_Homing","Control_Idle","Control_Alarm","Control_After","Control_Charging","Control_Pause","Control_PowerOff","Control_Reserve","Control_Cleaning","Control_Point"]}},{type:"string",name:"control mode (description)",ref:{value:"rbtCtrModeStr"}},{type:"enum",name:"cleaning mode",ref:{value:"rbtClnMode",options:["Cleaning_Auto","Cleaning_Part","Cleaning_Repeat","Cleaning_Manual","Cleaning_Stop"]}},{type:"string",name:"cleaning mode (description)",ref:{value:"rbtClnModeStr"}},{type:"enum",name:"turbo mode",ref:{value:"rbtTrbMode",options:["Turbo_On","Turbo_Off","Turbo_Silence"]}},{type:"string",name:"turbo mode (description)",ref:{value:"rbtTrbModeStr"}},{type:"enum",name:"Smart Control state",ref:{value:"rbtRC",options:["on","off"]}},{type:"enum",name:"error state",ref:{value:"rbtError",options:["Normal","ErrorCode_%d"]}}]},s={command:[{type:"enum",name:"power on",ref:{value:"apOn"}},{type:"enum",name:"power off",ref:{value:"apOff"}},{type:"enum",name:"power toggle",ref:{value:"apToggle"}},{type:"enum",name:"set wind speed",ref:{value:"rbtSetWS",ext:"%e",extMeta:["Auto","Sleeping","Low","Medium","High"]}},{type:"int",name:"set wind speed level",ref:{value:"rbtSetWSLvl",ext:"%d",extMeta:"0-4"}},{type:"enum",name:"wind speed up",ref:{value:"rbtSetWSUp"}},{type:"enum",name:"wind speed down",ref:{value:"rbtSetWSDown"}}],status:[{type:"enum",name:"connected",ref:{value:"apConn",options:["true","false"]}},{type:"enum",name:"power",ref:{value:"apPower",options:["on","off"]}},{type:"float",name:"PM 10.0 value",ref:{value:"apDust"}},{type:"int",name:"PM 10.0 level",ref:{value:"apDustLvl"}},{type:"float",name:"PM 2.5 value",ref:{value:"apFDust"}},{type:"int",name:"PM 2.5 level",ref:{value:"apFDustLvl"}},{type:"int",name:"Gas level",ref:{value:"apOdorLvl"}},{type:"enum",name:"wind speed",ref:{value:"apWS",options:["Auto","Sleeping","Low","Medium","High"]}},{type:"int",name:"wind speed level",ref:{value:"apWSLvl"}},{type:"enum",name:"error state",ref:{value:"apError",options:["ErrorCode_%d"]}}]};return{SYS:"samsung_smarthome",registModule:function registModule(e){e.register(this.SYS,"samsung");},getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Samsung Smart Home (Cloud)"};},getGatewayDeviceType:function getGatewayDeviceType(e){return e.sys==this.SYS?[{sys:this.SYS,type:"Refrigerator",name:"Smart Refrigerator"}]:null;},createGateway:function createGateway(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;e?e.accessKey?r(null,e):r(new a(n.INVALID,"accessKey is invalid")):r(new a(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,a){var n=xnm.aio.samsung.DMError,o=xnm.aio.samsung.DMError.ERROR_CODE;t?t.accessKey?a(null,t):a(new n(o.INVALID,"ip is invalid")):a(new n(o.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,r){r();},createDevice:function createDevice(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if(null!=e.id&&void 0!==e.id){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,s,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){s=i[o];break;}}s?r(null,e):r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.INVALID,"address is invalid"));}else r(new a(n.INVALID,"type is invalid"));}else r(new a(n.INVALID,"gateway is invalid"));}else r(new a(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.gateway){if(null!=e.type&&void 0!==e.type){if(null!=e.id&&void 0!==e.id){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var o,s,i=t.data.gateways;for(o=0;o<i.length;o++){if(i[o].index===e.gateway){s=i[o];break;}}s?r(null,e):r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else r(new a(n.INVALID,"address is invalid"));}else r(new a(n.INVALID,"type is invalid"));}else r(new a(n.INVALID,"gateway is invalid"));}else r(new a(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){r();},getCommandStatusMap:function getCommandStatusMap(i,u){if(!i)return null;switch(i.type){case"Refrigerator":return this._getFridgeMap(i);case"Washer":return e;case"Air_Conditioner":switch(i.deviceSubType){case"FAC":return t;case"Room_Air_Conditioner":return r;default:return null;}break;case"Oven":return a;case"Dryer":return n;case"Robot_Cleaner":return o;case"Air_Purifier":return s;default:return null;}},_getFridgeMap:function _getFridgeMap(e){var t,r={command:[],status:[]};return t={type:"enum",name:"connected",ref:{value:"frdgConn",options:["true","false"]}},r.status.push(t),e.Doors&&e.Doors.forEach(function(e){if(e&&e.id&&e.name){var t={type:"enum",name:e.name+" state",ref:{value:"frdgDoorState"+e.id,options:["open","closed"]}};r.status.push(t),t={type:"string",name:e.name+" name",ref:{value:"frdgDoorName"+e.id}},r.status.push(t);}}),e.Fridge&&(t={type:"enum",name:"filter state",ref:{value:"frdgFilterState",options:["good","order","replace"]}},r.status.push(t)),e.Temperatures&&e.Temperatures.forEach(function(e){if(e&&e.id&&e.name){var t={type:"float",name:e.name+" temperature",ref:{value:"frdgTempState"+e.id,extMeta:"-22.0-14.0"}};r.status.push(t),t={type:"enum",name:e.name+" temperature unit",ref:{value:"frdgTempUnit"+e.id,options:["°C","°F","NotSupported"]}},r.status.push(t);}}),e.Mode&&e.Mode.modes&&(t={type:"enum",name:"water filter state",ref:{value:"frdgWFState",options:["good","replace"]}},r.status.push(t)),t={type:"enum",name:"error state",ref:{value:"frdgError",options:["Freeze_Door_Alarm","Freeze_High_Temp","Fridge_Door_Alarm","Freeze_High_Temp","CV_Door_Alarm","CV_High_Temp","Single_Door_Alarm"]}},r.status.push(t),r;}};}(),xnm.aio.samsung.SmartHomeNotifyManager={_logger:null,_inited:!1,_listeners:[],_devices:[],init:function init(e){if(this._inited)e&&e();else{"undefined"==typeof require||null==require?this._logger={log:function log(){}}:this._logger=require("x.logger.js").getLogger("xnm.aio.samsung.SmartHomeNotifyManager");var t=require("xnm.aio.webhook.js");if(t){var r=this;t.start(function(a){a||(r._inited=!0,t.addHandler("samsung_smarthome",r)),e&&e(a);});}else e&&e(new Error("no webhook lib"));}},addListener:function addListener(e){e&&-1==this._listeners.indexOf(e)&&this._listeners.push(e);},clearListeners:function clearListeners(){this._listeners=[];},subscribe:function subscribe(e,t,r){var a,n=require("xnm.aio.webhook.js");if(n){if(e.sys===xnm.aio.samsung.SmartHomeCloud.DM.SYS){if(a=xnm.aio.samsung.SmartHomeCloud.parseJSON(e)){for(var o=this,s=0;s<t.length;s++){for(var i=!1,u=0;u<this._devices.length;u++){if(t[s]&&this._devices[u]&&t[s].id==this._devices[u].id){i=!0;break;}}i||this._devices.push(t[s]);}a.getDeviceList(function(e,t){if(e)r&&r(e);else{var s=o._getDeviceIDs(t),i=o._getSubscriptions(t);a.subscibe(s,function(e){e?r&&r(e):n.subscribe("samsung_smarthome",i,r);});}});}else r&&r(new Error("gateway json format invalid"));}else r&&r(new Error("do not support"));}else r&&r(new Error("no webhook lib"));},unsubscribeAll:function unsubscribeAll(e){var t=require("xnm.aio.webhook.js");t?(this._devices=[],t.unsubscribeType("samsung_smarthome",e)):e&&e(new Error("no webhook lib"));},isUniqueSubscribe:function isUniqueSubscribe(e,t){if(!e||"samsung_smarthome"!=e.type||!e.device)return!1;for(var r=0;r<t.length;r++){if(t[r]&&"samsung_smarthome"==t[r].type&&t[r].device==e.device)return!1;}return!0;},onNotification:function onNotification(e){if(e){var t;this._logger.log("trace","receive notification:"+JSON.stringify(e));for(var r=0;r<this._devices.length;r++){if(this._devices[r]&&this._devices[r].id==e.id){t=this._handleNotification(this._devices[r],e);break;}}if(this._logger.log("trace",this._listeners.length+" resolve state:"+JSON.stringify(t)),t)for(var a=0;a<this._listeners.length;a++){try{this._listeners[a](t);}catch(e){this._logger.log("trace","call listener error:"+e.message);}}}},onDummyNotification:function onDummyNotification(e,t,r){if(e){this._logger.log("trace","receive dummy notification:"+JSON.stringify(e)+" key:"+t+" value:"+r);for(var a=null,n=0;n<this._devices.length;n++){if(this._devices[n]&&this._devices[n].id==e.id){a=this._devices[n];break;}}if(a)for(var o=a._alias+":"+t,s=0;s<this._listeners.length;s++){try{this._listeners[s]([{id:o,status:r}]);}catch(e){this._logger.log("trace","call listener error:"+e.message);}}}},_handleNotification:function _handleNotification(e,t){"Alarms"==t.resource&&function(e,t){var r=t.id;xnm.aio.samsung.SmartHomeCloud._AlarmBuffer[r]=t.Alarms;}(0,t);var r=JSON.parse(JSON.stringify(t));"Device"==t.resource&&((r=t.Device).id=t.id),r.Alarms=xnm.aio.samsung.SmartHomeCloud._AlarmBuffer[t.id];var a,n=new xnm.aio.samsung.SmartHomeCloud();if(!e._alias)return null;switch(e.type){case"Refrigerator":a=n._resolveFridgeStates(r);break;case"Washer":a=n._resolveWasherStates(r);break;case"Air_Conditioner":r.deviceSubType=e.deviceSubType,a=n._resolveACStates(r);break;case"Oven":a=n._resolveOvenStates(r);break;case"Dryer":a=n._resolveDryerStates(r);break;case"Robot_Cleaner":a=n._resolveRobotStates(r);break;case"Air_Purifier":a=n._resolveAPStates(r);break;default:return null;}if(!a)return null;!function(e,t){var r=xnm.aio.samsung.SmartHomeCloud._StatusBuffer;for(var a in r){if(r.hasOwnProperty(a)){var n=r[a],o=!1;for(var s in n.states||(n.states={}),n.states[e.id]||(n.states[e.id]={}),t){t.hasOwnProperty(s)&&(n.states[e.id][s]=t[s],o=!0);}o&&(n.time=new Date().getTime());}}}(e,a);var o,s,i=[];for(var u in a){o=e._alias+":"+u,s=a[u],i.push({id:o,status:s});}return i;},_getDeviceIDs:function _getDeviceIDs(e){for(var t=[],r=0;r<e.length;r++){e[r]&&e[r].id&&-1==t.indexOf(e[r].id)&&t.push(e[r].id);}return t;},_getSubscriptions:function _getSubscriptions(e){for(var t=[],r=[],a=0;a<e.length;a++){e[a]&&e[a].id&&-1==r.indexOf(e[a].id)&&(r.push(e[a].id),t.push({type:"samsung_smarthome",device:e[a].id}));}return t;}},xnm.aio.samsung.DMError=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="SamsungDmError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},DMError;}(),xnm.aio.samsung.DM={_getSystem:function _getSystem(e){for(var t in xnm.aio.samsung){if(xnm.aio.samsung.hasOwnProperty(t)){var r=xnm.aio.samsung[t];if(r&&r.DM&&r.DM.SYS==e)return r;}}return null;},getGatewayType:function getGatewayType(){var e=[];for(var t in xnm.aio.samsung){if(xnm.aio.samsung.hasOwnProperty(t)){var r=xnm.aio.samsung[t];if(r&&r.DM&&r.DM.getGatewayType){var a=r.DM.getGatewayType();a&&e.push(a);}}}return e;},getGatewayDeviceType:function getGatewayDeviceType(e){var t=[];for(var r in xnm.aio.samsung){if(xnm.aio.samsung.hasOwnProperty(r)){var a=xnm.aio.samsung[r];if(a&&a.DM&&a.DM.getGatewayDeviceType){var n=a.DM.getGatewayDeviceType(e);n&&(Array.isArray(n)?t=t.concat(n):t.push(n));}}}return t;},createGateway:function createGateway(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.createGateway?o.DM.createGateway(e,t,r):r&&r(new a(n.INVALID,"no such sys:"+e.sys));}else r&&r(new a(n.INVALID,"sys is invalid"));}else r&&r(new a(n.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,r,a){var n=xnm.aio.samsung.DMError,o=xnm.aio.samsung.DMError.ERROR_CODE;if(t){if(t.sys){var s=this._getSystem(t.sys);s&&s.DM&&s.DM.updateGateway?s.DM.updateGateway(e,t,r,a):a&&a(new n(o.INVALID,"no such sys:"+t.sys));}else a&&a(new n(o.INVALID,"sys is invalid"));}else a(new n(o.INVALID,"info is invalid"));},deleteGateway:function deleteGateway(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.deleteGateway?o.DM.deleteGateway(e,t,r):r&&r(new a(n.INVALID,"no such sys:"+e.sys));}else r&&r(new a(n.INVALID,"sys is invalid"));}else r();},createDevice:function createDevice(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.createDevice?o.DM.createDevice(e,t,r):r&&r(new a(n.INVALID,"no such sys:"+e.sys));}else r&&r(new a(n.INVALID,"sys is invalid"));}else r&&r(new a(n.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.updateDevice?o.DM.updateDevice(e,t,r):r&&r(new a(n.INVALID,"no such sys:"+e.sys));}else r&&r(new a(n.INVALID,"sys is invalid"));}else r(new a(n.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,r){var a=xnm.aio.samsung.DMError,n=xnm.aio.samsung.DMError.ERROR_CODE;if(e){if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.deleteDevice?o.DM.deleteDevice(e,t,r):r&&r(new a(n.INVALID,"no such sys:"+e.sys));}else r&&r(new a(n.INVALID,"sys is invalid"));}else r();},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var r=!1,a=0;a<e.length;a++){if(e[a]==t){r=!0;break;}}return r;},_filter=function _filter(e,t){var r,a=[],n=null;if(e.sys){var o=this._getSystem(e.sys);o&&o.DM&&o.DM.getCommandStatusMap&&(r=o.DM.getCommandStatusMap(e));}return r&&(n=function(e,t,r){var a=[];switch(r.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(r.elems,e.type)){var t=JSON.parse(JSON.stringify(e));a.push(t);}});}return a;}(r,0,t),a=a.concat(n)),a;};if(!e.sys)return null;var r=JSON.parse(JSON.stringify(e)),a=null;switch(t.catagory){case"command":a=_filter.call(this,e,t),r.command=a;break;case"status":a=_filter.call(this,e,t),r.status=a;break;default:return null;}return a&&0!=a.length?r:null;}},xnm.aio.samsung.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.samsung.DM,Handler.prototype.SamsungTV=xnm.aio.samsung.TV,Handler.prototype.SmartHomeCloud=xnm.aio.samsung.SmartHomeCloud,Handler.prototype.SmartHomeNotifyManager=xnm.aio.samsung.SmartHomeNotifyManager,Handler.prototype.registModule=function(e){for(var t in xnm.aio.samsung){if(xnm.aio.samsung.hasOwnProperty(t)){var r=xnm.aio.samsung[t];r&&r.DM&&r.DM.registModule&&r.DM.registModule(e);}}},Handler.prototype.resolveGateway=function(e){return e.sys===xnm.aio.samsung.SmartHomeCloud.DM.SYS?xnm.aio.samsung.SmartHomeCloud.parseJSON(e):null;},Handler.prototype.getDeviceCommands=function(e,t){var r=xnm.aio.samsung.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),a=r?r.command:[];t&&t(null,a);},Handler.prototype.getDeviceStatus=function(e,t){var r=xnm.aio.samsung.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),a=r?r.status:[];t&&t(null,a);},Handler.prototype.doCommand=function(e,t,r,a){if(e){var n=this.resolveGateway(e);if(!n)return void(a&&a(new Error("gateway json format invalid")));n.executeCommandCreator(t,r,function(e){a&&a(e);});}else a&&a(new Error("only support gateway"));},Handler.prototype.doStatus=function(e,t,r,a,n){var o=this.resolveGateway(t);if(o){var s=[{id:e,device:r,status:a}];o.getStatesCreator(null,s,function(e,t){e?n&&n(e):n&&n(null,t[0]);});}else n&&n(new Error("gateway json format invalid"));},Handler.prototype.getSmartHomeDeviceList=function(e,t){var r=this.resolveGateway(e);r?r.getDeviceList(function(e,r){t&&t(e,r);}):t&&t(new Error("gateway json format invalid"));},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.samsung.Handler());