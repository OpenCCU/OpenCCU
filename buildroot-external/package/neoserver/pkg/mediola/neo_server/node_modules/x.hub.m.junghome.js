function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});Object.defineProperty(subClass,"prototype",{writable:false});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined");}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}var websocket=require("ws");var x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.junghome=x.hub.m.junghome||{},x.hub.m.junghome.MODULE=require("xnm.aio.junghome.js"),x.hub.m.junghome.WebSocket=/*#__PURE__*/function(_websocket){_inherits(JunghomeXHUBWebSocket,_websocket);var _super=_createSuper(JunghomeXHUBWebSocket);function JunghomeXHUBWebSocket(e,t){var _this;_classCallCheck(this,JunghomeXHUBWebSocket);e.startsWith("wss://")||(e="wss://"+e),e.endsWith("/ws")||(e+="/ws"),_this=_super.call(this,e,{rejectUnauthorized:!1,headers:{token:t},timeout:3e4,handshakeTimeout:3e4,sessionTimeout:3e4}),_this._logger=null,_this._heartBeatInterval=36e5,_this._pingTimeout=null,_this.ip=e,_this.token=t;var s="x.hub.m.junghome.WebSocket";_this._logger=require("x.logger.js").getLogger(s),require("x.logger.js").setLogToConsole(!0,s),_this.on("open",function(){return _this.openHandler();}),_this.on("close",function(e,t){return _this.closeHandler(e,t);}),_this.on("error",function(e){return _this.errorHandler(e);}),_this.on("message",function(e,t){return _this.messageHandler(e,t);}),_this.on("ping",function(e){_this._logger.log("debug","ping ".concat(e)),_this.heartbeat(_assertThisInitialized(_this),_this._heartBeatInterval);});return _this;}_createClass(JunghomeXHUBWebSocket,[{key:"openHandler",value:function openHandler(){this._logger.log("debug","websocket is open for ".concat(this.url," ")),this.heartbeat(this,this._heartBeatInterval);}},{key:"closeHandler",value:function closeHandler(e,t){this._logger.log("debug","websocket closed with ".concat(e," ").concat(t?t.toString():"")),this._pingTimeout&&clearTimeout(this._pingTimeout);}},{key:"errorHandler",value:function errorHandler(e){this._logger.log("error","websocket has error ".concat(e));}},{key:"messageHandler",value:function messageHandler(e,t){try{this._logger.log("debug","message ".concat(JSON.stringify(e)));}catch(t){this._logger.log("error",t),this._logger.log("debug","message ".concat(e));}}},{key:"heartbeat",value:function heartbeat(e,t){e._pingTimeout&&clearTimeout(e._pingTimeout),e._pingTimeout=setTimeout(function(){e.close(1e3,"refreshing");},t);}}],[{key:"getInstance",value:function getInstance(e,t){var s=new x.hub.m.junghome.WebSocket(e,t);return s.addEventListener("close",function(e){s.terminate(),setTimeout(function(){s._logger.log("debug","reconnecting to ".concat(s.ip," ...")),s=x.hub.m.junghome.WebSocket.getInstance(s.ip,s.token);},1e4);}),s;}}]);return JunghomeXHUBWebSocket;}(websocket),x.hub.m.junghome.Handler=/*#__PURE__*/function(){function JunghomeXHUBHandler(){_classCallCheck(this,JunghomeXHUBHandler);this._logger=require("x.logger.js").getLogger("x.hub.m.junghome.Handler"),this.JunghomeXHUBWebSocket=x.hub.m.junghome.WebSocket,this.wsInstance,this._observedDevices={},this._observedDataPoints={};}_createClass(JunghomeXHUBHandler,[{key:"init",value:function init(e){e&&e();}},{key:"getSystems",value:function getSystems(){return["junghome"];}},{key:"addStateDevice",value:function addStateDevice(e,t,s){this._hasWS()||this._initListener(e.gateway);var o=e.jungInfo.datapoints.find(function(e){return e.type==s.statusKey;});o&&(this._observedDevices[e.address]=e,this._observedDataPoints[o.id]={functionId:e.address,lastValue:null,statusKey:s.statusKey},this._logger.log("debug","observing ".concat(o.type," of ").concat(e.address,"(").concat(e.name,")"))),t&&t();}},{key:"getState",value:function getState(e,t,s){e?e.gateway?x.hub.m.junghome.MODULE.doStatus("xhub",e.gateway,e,{value:t},function(e,t){e?s&&s({error:e}):t?s&&s({data:{value:t.status}}):s&&s({error:new Error("do status failed")});}):s&&s(new Error("device gateway format invalid")):s&&s({error:new Error("device json format invalid")});}},{key:"executeCommand",value:function executeCommand(e,t,s){x.hub.m.junghome.MODULE.doCommand(e.gateway,e,t,s);}},{key:"checkDeviceMatch",value:function checkDeviceMatch(e,t){return!!(t&&t.device&&e&&e.device)&&!(!t.gateway||!e.gateway)&&t.gateway.ip==e.gateway.ip&&t.device.address==e.device.address;}},{key:"_hasWS",value:function _hasWS(){return!!this.wsInstance;}},{key:"_initListener",value:function _initListener(e){var _this2=this;this.wsInstance=this.JunghomeXHUBWebSocket.getInstance(e.ip,e.token),this.wsInstance.addEventListener("message",function(e){return _this2._jungHomeGwEventsHandler(e.data);});}},{key:"_jungHomeGwEventsHandler",value:function _jungHomeGwEventsHandler(e){try{var t=JSON.parse(e);if("datapoint"===t.type){var _e=t.data,s=this._observedDataPoints[_e.id];if(!s)return;var o=this._observedDevices[s.functionId];if(!o)throw new Error("critical we do not have device info for ".concat(JSON.stringify(s)));var r=_e.values[0];x.hub.m.junghome.MODULE.helpers.normalizeValue(r);var n=r.value;this._produceEvent(o,s.statusKey,s.lastValue,n),s.lastValue=n;}else this._logger.log("debug","discarded ".concat(JSON.stringify(t)));}catch(e){this._logger.log("error",e.stack?e.stack:e);}}},{key:"_produceEvent",value:function _produceEvent(e,t,s,o){if(s!=o){this._logger.log("trace","receive new status:"+JSON.stringify({address:e.address,key:t,value:o}));var r={key:t,value:o,oldvalue:s,changed:!0};require("x.hub.eventbus.js").emit("status",{module:"junghome",device:e,gateway:e.gateway,data:r});}}}]);return JunghomeXHUBHandler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.junghome.Handler());