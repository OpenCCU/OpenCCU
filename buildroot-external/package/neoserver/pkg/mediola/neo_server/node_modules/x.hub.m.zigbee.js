var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.zigbee=x.hub.m.zigbee||{},x.hub.m.zigbee.Util=function(){var Util=function Util(){};return Util.prototype.rgbToHsv=function rgbToHsv(e,t,i){e/=255,t/=255,i/=255;var o,r,n=Math.max(e,t,i),s=Math.min(e,t,i),a=n,l=n-s;if(r=0==n?0:l/n,n==s)o=0;else{switch(n){case e:o=(t-i)/l+(t<i?6:0);break;case t:o=(i-e)/l+2;break;case i:o=(e-t)/l+4;}o/=6;}return[o,r,a];},Util.prototype.hsvToRgb=function hsvToRgb(e,t,i){var o,r,n,s=Math.floor(6*e),a=6*e-s,l=i*(1-t),u=i*(1-a*t),c=i*(1-(1-a)*t);switch(s%6){case 0:o=i,r=c,n=l;break;case 1:o=u,r=i,n=l;break;case 2:o=l,r=i,n=c;break;case 3:o=l,r=u,n=i;break;case 4:o=c,r=l,n=i;break;case 5:o=i,r=l,n=u;}return[255*o,255*r,255*n];},Util.prototype.rgbTocie=function rgb_to_cie(e,t,i){var o=.664511*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.154324*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.162028*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92),r=.283881*e+.668433*t+.047685*i,n=88e-6*e+.07231*t+.986039*i,s=(o/(o+r+n)).toFixed(4),a=(r/(o+r+n)).toFixed(4);return isNaN(s)&&(s=0),isNaN(a)&&(a=0),[s,a];},Util.prototype.cieTorgb=function cie_to_rgb(e,t,i){void 0===i&&(i=254);var o=1-e-t,r=(i/254).toFixed(2),n=r/t*e,s=r/t*o,a=1.656492*n-.354851*r-.255038*s,l=.707196*-n+1.655397*r+.036152*s,u=.051713*n-.121364*r+1.01153*s;return a>u&&a>l&&a>1?(l/=a,u/=a,a=1):l>u&&l>a&&l>1?(a/=l,u/=l,l=1):u>a&&u>l&&u>1&&(a/=u,l/=u,u=1),a=a<=.0031308?12.92*a:1.055*Math.pow(a,1/2.4)-.055,l=l<=.0031308?12.92*l:1.055*Math.pow(l,1/2.4)-.055,u=u<=.0031308?12.92*u:1.055*Math.pow(u,1/2.4)-.055,a=Math.round(255*a),l=Math.round(255*l),u=Math.round(255*u),isNaN(a)&&(a=0),isNaN(l)&&(l=0),isNaN(u)&&(u=0),[a,l,u];},Util.prototype.RGBToHSV=function(e,t,i){e/=255,t/=255,i/=255;var o=Math.min(e,Math.min(t,i)),r=Math.max(e,Math.max(t,i));return o==r?[0,0,o]:[60*((e==o?3:i==o?1:5)-(e==o?t-i:i==o?e-t:i-e)/(r-o)),(r-o)/r,r];},new Util();}(),x.hub.m.zigbee.Device=function(){var Device=function Device(e,t){this._ieeeAdr=e,this._endpointID=t,this._profileID=null,this._deviceID=null,this._states={};};return Device.prototype.getIeeeAdr=function(){return this._ieeeAdr;},Device.prototype.getEndpointID=function(){return this._endpointID;},Device.prototype.setBufferedState=function(e,t){this._states[e]=t;},Device.prototype.getBufferedState=function(e){return this._states[e];},Device.prototype.getBufferedStates=function(){return this._states;},Device.prototype.getConvertedStates=function(e){var t={};if(void 0!==this._states.onoff&&null!=this._states.onoff&&(t.onoff=this._states.onoff),void 0!==this._states.level&&null!=this._states.level&&(t.level=Math.round(this._states.level/255*100)),void 0!==this._states.color&&null!=this._states.color&&(t.color=this._states.color,void 0!==this._states.color.hue&&null!=this._states.color.hue&&void 0!==this._states.color.sat&&null!=this._states.color.sat)){var i=this._states.color.hue/254,o=this._states.color.sat/254,r=x.hub.m.zigbee.Util.hsvToRgb(i,o,1),n=Math.round(r[0]).toString(16);n.length<2&&(n="0"+n),n=n.toUpperCase();var s=Math.round(r[1]).toString(16);s.length<2&&(s="0"+s),s=s.toUpperCase();var a=Math.round(r[2]).toString(16);a.length<2&&(a="0"+a),a=a.toUpperCase(),t.rgb=n+s+a;}return"off"==t.onoff&&(t.level=0),"on"==t.onoff&&0==t.level&&(t.level=1),0==t.level&&(t.onoff="off"),t;},Device.prototype.executeCommand=function(e,t,i){var o,r,n=this;if("on"==t||"off"==t)o=t,e._doCommand(this._ieeeAdr,this._endpointID,o,null,function(e){e||n.setBufferedState("onoff",o),i&&i(e);});else if("toggle"==t)r=this.getBufferedState("onoff"),o="on"==r?"off":"on",e._doCommand(this._ieeeAdr,this._endpointID,o,null,function(e){e||n.setBufferedState("onoff",o),i&&i(e);});else if("white"==t){if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57")){var s=x.hub.m.zigbee.Util.rgbTocie(255,255,255);(_=Math.round(65536*s[0]))>65279&&(_=65279),(p=Math.round(65536*s[1]))>65279&&(p=65279),e._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[_,p],function(e){i&&i(e);});}else e._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[0,0],function(e){e||n.setBufferedState("color",{hue:0,sat:0}),i&&i(e);});}else if(0==t.indexOf("dimTo")){if(o="level",r=parseInt(t.substr(5)),isNaN(r))return void(i&&i(new Error("command "+t+" invalid")));r=Math.round(r/100*255),e._doCommand(this._ieeeAdr,this._endpointID,o,r,function(e){e||n.setBufferedState("level",r),i&&i(e);}),0==r?e._doCommand(this._ieeeAdr,this._endpointID,"off",null,function(e){e||n.setBufferedState("onoff","off");}):e._doCommand(this._ieeeAdr,this._endpointID,"on",null,function(e){e||n.setBufferedState("onoff","on");});}else if(0==t.indexOf("setColorMap")){if(!(r=t.substr(11))||-1==r.indexOf(","))return void(i&&i(new Error("command "+t+" invalid")));if((u=r.split(",")).length<2)return void(i&&i(new Error("command "+t+" invalid")));var a=parseInt(u[0]);a<0&&(a=0),a>255&&(a=255);var l=parseInt(u[1]);l<0&&(l=0),l>255&&(l=255),e._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[a,l],function(e){e||n.setBufferedState("color",{hue:a,sat:l}),i&&i(e);});}else if(0==t.indexOf("setColorXY")){if(!(r=t.substr(10))||-1==r.indexOf(","))return void(i&&i(new Error("command "+t+" invalid")));var u;if((u=r.split(",")).length<2)return void(i&&i(new Error("command "+t+" invalid")));var c=parseInt(u[0]);c<0&&(c=0),c>65279&&(c=65279);var d=parseInt(u[1]);d<0&&(d=0),d>65279&&(d=65279),e._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[c,d],function(e){i&&i(e);});}else if(0==t.indexOf("setColorTemp")){if(!(r=t.substr(12)))return void(i&&i(new Error("command "+t+" invalid")));var g=parseFloat(r);g<15.32&&(g=15.32);var v=Math.round(1e6/g);e._doCommand(this._ieeeAdr,this._endpointID,"color_temp",v,function(e){e||n.setBufferedState("color_temp",v),i&&i(e);});}else if(0==t.indexOf("setRGB")){r=t.substr(6);var f=parseInt(r.substr(0,2),16),h=parseInt(r.substr(2,2),16),b=parseInt(r.substr(4,2),16);if("0200"==this._deviceID&&0==this._ieeeAdr.indexOf("000B57")){var _,p;s=x.hub.m.zigbee.Util.rgbTocie(f,h,b);(_=Math.round(65536*s[0]))>65279&&(_=65279),(p=Math.round(65536*s[1]))>65279&&(p=65279),e._doCommand(this._ieeeAdr,this._endpointID,"color_xy",[_,p],function(e){i&&i(e);});}else{var m=x.hub.m.zigbee.Util.rgbToHsv(f,h,b),y=Math.floor(254*m[0]),z=Math.floor(254*m[1]);e._doCommand(this._ieeeAdr,this._endpointID,"hue_sat",[y,z],function(e){e||n.setBufferedState("color",{hue:y,sat:z}),i&&i(e);});}}else i&&i(new Error("unknown command"));},Device.prototype.toJSON=function(){return{ieeeAdr:this._ieeeAdr,endpointID:this._endpointID,profileID:this._profileID,deviceID:this._deviceID};},Device.parseJSON=function(e){if(!e||!e.ieeeAdr||!e.endpointID)return null;var t=new Device(e.ieeeAdr,e.endpointID);return t._profileID=e.profileID,t._deviceID=e.deviceID,t;},Device;}(),x.hub.m.zigbee.Zigbee2=function(){var e=require("nodejs_zb_gateway/zigbee_library/zb_lib.js"),t=require("nodejs_zb_gateway/zb_gateway/zb-gateway.js");var Zigbee2=function Zigbee2(i){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee2"),this._ip=i,this._zigbeeGateway=new t(this._ip),this._state=0,this._cronJob=null,this._cronPattern="0 0 2 * * *";this._zigbeeGateway.on("zb-gateway:newDev",function(e,t,i){e&&e.startPollDeviceStates&&e.startPollDeviceStates(-1);}).on("zb-gateway:deviceList",function(e,t,i){console.log("Webserver: Received zb-gateway:deviceList",e,"The unbindedList: ",t,"The BindedList: ",i);}).on("zb-gateway:removeDeviceCard",function(e){console.log("Webserver: Received Remove Device Card");}).on("zb-gateway:network:ready",function(){console.log("Webserver: Received Network Ready Ind");}).on("zb-gateway:network:info",function(e){console.log("Webserver: Received Network Info Ind");}).on("zb-gateway:binding:event",function(e,t,i){console.log("Webserver: Received zb-gateway:binding:event, unbindedList: ",t,"The BindedList: ",i);}).on("zb-gateway:binding:failed",function(){console.log("Webserver: Received zb-gateway:binding:failed");}).on("zb-gateway:unbinding:failed",function(){console.log("Webserver: Received zb-gateway:unbinding:failed");}).on("zb-gateway:light_device:state",function(e){}).on("zb-gateway:light_device:level",function(e){}).on("zb-gateway:light_device:color",function(e){console.log("Webserver: Got light device color update: ",e);}).on("zb-gateway:light_device:color_temp",function(e){console.log("Webserver: Got light device color temperature update: ",e);}).on("zb-gateway:light_device:color_xy",function(e){console.log("Webserver: Got light device color xy update: ",e);}).on("zb-gateway:temp_device:temp",function(e){console.log("Webserver: Got temp device state update: ",e);}).on("zb-gateway:doorlock_device:state",function(e){console.log("Webserver: Got doorlock device state update: ",e);}).on("zb-gateway:doorlock_device:set_rsp",function(e){console.log("Webserver: Got doorlock device set response: ",e);}).on("zb-gateway:thermostat:attribute",function(e){console.log("Webserver: Got thermostat device attribute response: ",e);}).on(function EVT(){evt_string="",evt_string+=arguments[0]+":";for(var e=1;e<arguments.length;e++){evt_string+=":",evt_string+=arguments[e];}return evt_string;}("zb-gateway",e.HA_CLUSTER_ID.LEVEL_CONTROL,e.STATUS.UNSUPPORTED_ATTRIBUTE),function(e){console.log("Webserver: Got level control, on/off transition time, unsupported device attribute response: ",e);});};return Zigbee2.prototype.init=function(){if(0==this._state){this._state=1,this._zigbeeGateway.init();var e=this,t=require("x.hub.taskman.js").Util._getTimeZone(),i=require("cron").CronJob;this._cronJob=new i(this._cronPattern,function(){e._logger.log("info","do soft system reset"),console.log("zigbee do soft system reset:"+new Date().toString()),e._zigbeeGateway.softSystemReset();},null,!0,t);}},Zigbee2.prototype.terminate=function(){1==this._state&&(this._state=0,this._zigbeeGateway.terminate(),this._cronJob.stop());},Zigbee2.prototype.getDevices=function(){return this._zigbeeGateway.getDevices();},Zigbee2.prototype.getDevice=function(e,t){var i=e.substring(0,4)+e.substring(10,16),o=parseInt(t).toString(16);return o.length<2&&(o="0"+o),i=(i+o).toLowerCase(),this._zigbeeGateway.getDevice(i);},Zigbee2.prototype.getDeviceStates=function(e,t){var i=this.getDevice(e,t);return i&&i.getStates?i.getStates():null;},Zigbee2.prototype.executeCommand=function(e,t,i){if(e){if(t){var o=e.indexOf(":");if(-1!=o){var r=e.substr(0,o),n=e.substr(o+1),s=this.getDevice(r,n);s?s.executeCommand(t,function(e){i&&i(e);}):i&&i(new Error("no such device"));}else i&&i(new Error("address format invalid"));}else i&&i(new Error("command invalid"));}else i&&i(new Error("address is empty"));},Zigbee2;}(),x.hub.m.zigbee.Zigbee=function(){var Zigbee=function Zigbee(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Zigbee"),this._devices=[],this._learnCBs=[],this._learnTO=null;};return Zigbee.prototype.init=function(e){this._logger.log("info","zigbee init");var t=this;this.listDevices(function(i){i&&t._logger.log("info","init list devices error:"+i.message),e&&e(i);});},Zigbee.prototype.getDevices=function(){return this._devices;},Zigbee.prototype.executeCommand=function(e,t,i){if(e){if(t){var o=e.indexOf(":");if(-1!=o){var r=e.substr(0,o),n=e.substr(o+1),s=this._findDevice(r,n);s||(s=new x.hub.m.zigbee.Device(r,n)),s.executeCommand(this,t,i);}else i&&i(new Error("address format invalid"));}else i&&i(new Error("command invalid"));}else i&&i(new Error("address is empty"));},Zigbee.prototype.learnDevice=function(e,t){t||(t=function t(){}),(!(e=parseInt(e))||isNaN(e)||e<=0)&&(e=60);var i=this._learnCBs.length;if(-1==this._learnCBs.indexOf(t)&&this._learnCBs.push(t),!(i>0)){var o=this;this._learnTO=setTimeout(function(){o._listDevices(function(e,t){var i;o._learnTO=null;var r=o._learnCBs;if(o._learnCBs=[],e)for(i=r.length;i--;){r[i]&&r[i](e);}else{var n=[];for(i=t.length;i--;){var s=t[i],a=o._findDevice(s.ieeeAdr,s.endpointID);a||(a=x.hub.m.zigbee.Device.parseJSON(s))&&(o._devices.push(a),n.push(s));}for(i=r.length;i--;){r[i]&&r[i](null,n);}}});},1e3*e),this._openNetwork(e,function(e){if(e){clearTimeout(o._learnTO),o._learnTO=null;var t=o._learnCBs;o._learnCBs=[];for(var i=t.length;i--;){t[i]&&t[i](e);}}});}},Zigbee.prototype.listDevices=function(e){var t=this;this._listDevices(function(i,o){if(i)e&&e(i);else{for(var r=o.length;r--;){var n=o[r],s=t._findDevice(n.ieeeAdr,n.endpointID);s||(s=x.hub.m.zigbee.Device.parseJSON(n))&&t._devices.push(s);}e&&e();}});},Zigbee.prototype.removeDevice=function(e,t){if(e){var i,o=e.indexOf(":");i=-1==o?e:e.substr(0,o);var r=this;this._removeDevice(i,function(e){e?t&&t(e):(r._deleteDevice(i,null),t&&t());});}else t&&t(new Error("address is empty"));},Zigbee.prototype._findDevice=function(e,t){for(var i=this._devices.length;i--;){var o=this._devices[i];if(o.getIeeeAdr()==e&&o.getEndpointID()==t)return o;}return null;},Zigbee.prototype._deleteDevice=function(e,t){var i=this._devices;this._devices=[];for(var o=i.length;o--;){var r=i[o],n=!1;r.getIeeeAdr()==e&&(t&&r.getEndpointID()!=t||(n=!0)),n||this._devices.push(r);}},Zigbee.prototype._listDevices=function(e){this._logger.log("debug","list devices");var t=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];t.push("listdevices");var i=t.join(" "),o=this;this._exec(i,function(t,i,r){if(t)return o._logger.log("debug","list devices error:"+t.message),void(e&&e(t));if(r)return o._logger.log("debug","list devices error:"+r),void(e&&e(new Error(r)));if(o._logger.log("debug","list devices:\r\n"+i),i=i.trim()){for(var n=[],s=i.split("\n"),a=0;a<s.length;a++){var l=s[a].trim();if(l){var u=l.split(" "),c={ieeeAdr:u[0]?u[0].replace(/:/g,""):null,endpointID:u[1],profileID:u[2]?u[2].substr(2):null,deviceID:u[3]?u[3].substr(2):null};n.push(c);}}e&&e(null,n);}else e&&e(null,[]);});},Zigbee.prototype._openNetwork=function(e,t){this._logger.log("debug","open network for "+e+" seconds");var i=this,o=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin","opennetwork",e].join(" ");this._exec(o,function(e,o,r){return e?(i._logger.log("debug","open network error:"+e.message),void(t&&t(e))):r?(i._logger.log("debug","open network error:"+r),void(t&&t(new Error(r)))):void(t&&t());});},Zigbee.prototype._removeDevice=function(e,t){this._logger.log("debug","remove device:"+e);var i=this,o=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin","remove",e].join(" ");this._exec(o,function(o,r,n){return o?(i._logger.log("debug","remove device "+e+" error:"+o.message),void(t&&t(o))):n?(i._logger.log("debug","remove device "+e+" error:"+n),void(t&&t(new Error(n)))):void(t&&t());});},Zigbee.prototype._doCommand=function(e,t,i,o,r){var n=[e,t,i,o];this._logger.log("debug","do command ["+n.join(",")+"]"),(n=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"]).push(i),n.push(e),n.push(t),void 0!==o&&null!=o&&(Array.isArray(o)?n=n.concat(o):n.push(o));var s=this,a=n.join(" ");this._exec(a,function(e,t,i){if(e)return s._logger.log("debug","do command error:"+e.message),void(r&&r(e));if(i)return s._logger.log("debug","do command error:"+i),void(r&&r(new Error(i)));try{if(!t)return void(r&&r());var o=JSON.parse(t);r&&r(null,o);}catch(e){s._logger.log("debug","do command error (not json):"+t),r&&r(new Error(t));}});},Zigbee.prototype._exec=function(e,t){this._logger.log("trace","execute native:"+e);var i,o=this,r=(0,require("child_process").exec)(e),n="",s="";r.stderr.on("data",function(e){i=String(e),s+=i;}),r.stdout.on("data",function(e){i=String(e),n+=i;}),r.on("error",function(e){o._logger.log("warn","execute native error:"+e.message),t&&t(e),t=null;}),r.on("close",function(e,i){o._logger.log("trace","execute native close:"+e+","+i),o._logger.log("trace","outTxt:"+n),o._logger.log("trace","errTxt:"+s),t&&t(null,n,s),t=null;});},Zigbee;}(),x.hub.m.zigbee.Handler=function(){var Handler=function Handler(){this._logger=require("x.logger.js").getLogger("x.hub.m.zigbee.Handler"),this._zigbee=null,this._zigbee2=null,this._zigbeeStickAvaliable=!1;};return util.inherits(Handler,EventEmitter),Handler.prototype.Zigbee=x.hub.m.zigbee.Zigbee,Handler.prototype.Zigbee2=x.hub.m.zigbee.Zigbee2,Handler.prototype.getSystems=function(){return["zigbee"];},Handler.prototype.init=function(e){var t=this,i=require("x.hub.eventbus.js");i.on("x.hub.peripheralman.ADD_ZIGBEE",function(e){t._logger.log("debug","insert zigbee usb stick"),t._zigbeeStickAvaliable=!0,t._zigbee2.init();}),i.on("x.hub.peripheralman.REMOVE_ZIGBEE",function(e){t._logger.log("debug","eject zigbee usb stick"),t._zigbeeStickAvaliable=!1,t._zigbee2.terminate();}),this._zigbee=new this.Zigbee(),this._zigbee.init(),global.ZIGBEE_URL&&"A20"!=global.PLATFORM&&"PI2"!=global.PLATFORM?(this._zigbeeStickAvaliable=!0,this._zigbee2=new this.Zigbee2(global.ZIGBEE_URL),this._zigbee2.init()):this._zigbee2=new this.Zigbee2("127.0.0.1"),e&&e({});},Handler.prototype.executeCommand=function(e,t,i){i&&i();},Handler.prototype.learnDevice=function(e,t){if(this._zigbeeStickAvaliable){this._zigbee.learnDevice(e.timeout,function(e,i){t&&t({error:e,data:i});});}else t&&t({error:new Error("zigbee usb stick not avaliable")});},Handler.prototype.removeDevice=function(e,t){if(this._zigbeeStickAvaliable){this._zigbee.removeDevice(e,function(e){t&&t({error:e});});}else t&&t({error:new Error("zigbee usb stick not avaliable")});},Handler.prototype.listDevices=function(e,t){var i=this._zigbee.getDevices();if(i){for(var o=[],r=i.length;r--;){var n=i[r].toJSON();o.push(n);}t&&t({data:o});}else t&&t({data:[]});},Handler.prototype.getAllStatesLegacy=function(e){var t,i,o,r=[];for(o=(t=this._zigbee2.getDevices()).length;o--;){if(s=(i=t[o]).getStates()){var n={type:"ZIGBEE",adr:i.getGUID().toUpperCase(),state:s};r.push(n);}}for(o=(t=this._zigbee.getDevices()).length;o--;){var s;if(i=t[o],!this._zigbee2.getDevice(i.getIeeeAdr(),i.getEndpointID()))if(s=i.getConvertedStates(this)){n={type:"ZIGBEE",adr:i.getIeeeAdr()+":"+i.getEndpointID(),state:s};r.push(n);}}e&&e({data:r});},Handler.prototype.executeCommandLegacy=function(e,t,i){if(this._zigbeeStickAvaliable){if(e){if(t){var o=e.indexOf(":");if(-1!=o){var r=e.substr(0,o),n=e.substr(o+1);this._zigbee2.getDevice(r,n)?this._zigbee2.executeCommand(e,t,function(e){i&&i({error:e});},this):this._zigbee.executeCommand(e,t,function(e){i&&i({error:e});});}else i&&i({error:new Error("address format invalid")});}else i&&i({error:new Error("command invalid")});}else i&&i({error:new Error("address invalid")});}else i&&i({error:new Error("zigbee usb stick not avaliable")});},Handler.prototype.executeCommandNativeRaw=function(e,t){if(this._zigbeeStickAvaliable){var i=e.command,o=e.value;o&&(o=JSON.parse(o));var r=["/srv/Apps/zigbee/SYSTEM/servers/zb_con_action.bin"];r.push(i),void 0!==o&&null!=o&&(Array.isArray(o)?r=r.concat(o):r.push(o)),this._zigbee._exec(r.join(" "),function(e,i,o){if(e)t&&t({error:e});else if(o)t&&t({error:new Error(o)});else try{if(!i)return void(t&&t({}));var r=JSON.parse(i);t&&t({data:r});}catch(e){t&&t({error:new Error(i)});}});}else t&&t({error:new Error("zigbee usb stick not avaliable")});},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.zigbee.Handler());