var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.harmony=xnm.aio.harmony||{},xnm.aio.harmony.Hub=function(){var GetDevicesJob=function GetDevicesJob(e,t,o){this._hub=e,this._closeSocket=t,this._callback=o,this._data="",this._devices={devices:[],activities:[]};};GetDevicesJob.prototype.execute=function(e){e.write('<iq type="get" id="2320426445" from="e01b88af-b4cd-4d1c-8e76-85562ea3fad5"><oa xmlns="connect.logitech.com" mime="vnd.logitech.harmony/vnd.logitech.harmony.engine?config"></oa></iq>');},GetDevicesJob.prototype._onSocketData=function(e){if("<iq/>"!=e&&(this._data+=e,-1!=this._data.indexOf("</iq>"))){var t=this._data.indexOf("<![CDATA"),o=this._data.indexOf("]]></oa>");if(t>0&&o>t){var n=JSON.parse(this._data.substring(t+9,o));if(n&&n.activity&&n.device){for(var i=0;i<n.device.length;i++){for(var s=[],a=0;a<n.device[i].controlGroup.length;a++){for(var r=n.device[i].controlGroup[a]["function"],c=0;c<r.length;c++){try{var u=JSON.parse(r[c].action);u&&u.command&&s.push({key:u.command});}catch(e){}}}this._devices.devices.push({sys:xnm.aio.harmony.DM.SYS,id:n.device[i].id,type:Hub.DEVICE_TYPE.IR,name:n.device[i].label,ircodes:{sys:xnm.aio.harmony.DM.SYS,codes:s}});}for(i=0;i<n.activity.length;i++){this._devices.activities.push({sys:xnm.aio.harmony.DM.SYS,id:n.activity[i].id,type:Hub.DEVICE_TYPE.ACTIVITY,name:n.activity[i].label});}}}this._callback&&this._callback(null,this._devices),this._hub&&this._hub._onJobFinish(this,this._closeSocket);}},GetDevicesJob.prototype._onSocketTimeout=function(){this._callback&&this._callback(null,this._devices),this._hub&&this._hub._onJobFinish(this,!0);},GetDevicesJob.prototype._onJobCancelled=function(){this._callback&&this._callback(new Error("job cancelled"));};var SendCommandJob=function SendCommandJob(e,t,o,n){this._type="send command",this._hub=e,this._closeSocket=t,this._callback=n,this._type=o.type,this._id=o.id,this._command=o.command,this._socket=null,this._released=!1;};SendCommandJob.prototype.execute=function(e){var t;"IRCommand"==this._type?(this._hub&&this._hub._logger.log("debug","send press"),t='<iq type="render" id="3669650010" from="'+this._hub._sessionToken+'"><oa xmlns="connect.logitech.com" mime="vnd.logitech.harmony/vnd.logitech.harmony.engine?holdAction">status=press:action={"command"::"'+this._command+'","type"::"'+this._type+'","deviceId"::"'+this._id+'"}</oa></iq>\r\n'):(this._hub&&this._hub._logger.log("debug","send activity"),t='<iq type="startActivity" id="1028178097" from="'+this._hub._sessionToken+'"><oa xmlns="connect.logitech.com" mime="vnd.logitech.harmony/vnd.logitech.harmony.engine?startActivity">activityId='+this._id+"</oa></iq>\r\n"),this._socket=e,e.write(t);},SendCommandJob.prototype._onSocketData=function(){var e=!1;if(("IRCommand"==this._type&&this._released||"IRCommand"!=this._type)&&(e=!0),"IRCommand"==this._type&&!this._released){this._hub&&this._hub._logger.log("debug","send release");var t='<iq type="render" id="3669650010" from="'+this._hub._sessionToken+'"><oa xmlns="connect.logitech.com" mime="vnd.logitech.harmony/vnd.logitech.harmony.engine?holdAction">status=release:action={"command"::"'+this._command+'","type"::"'+this._type+'","deviceId"::"'+this._id+'"}</oa></iq>\r\n';this._socket.write(t),this._released=!0;}e&&(this._callback&&this._callback(null),this._hub&&this._hub._onJobFinish(this));},SendCommandJob.prototype._onSocketTimeout=function(){this._callback&&this._callback(new Error("harmony response timeout")),this._hub&&this._hub._onJobFinish(this);},SendCommandJob.prototype._onJobCancelled=function(){this._callback&&this._callback(new Error("job cancelled"));};var PingJob=function PingJob(e,t){this._type="ping",this._hub=e,this._callback=t,this._socket=null,this._released=!1;};PingJob.prototype.execute=function(e){this._socket=e,e.write('<iq type="get" id="ping"><ping xmlns="urn:xmpp:ping"/></iq>\r\n');},PingJob.prototype._onSocketData=function(e){var t=!1;-1!=e.indexOf("id='ping'")&&(t=!0),t&&(this._callback&&this._callback(null),this._hub&&this._hub._onJobFinish(this));},PingJob.prototype._onSocketTimeout=function(){this._callback&&this._callback(new Error("harmony response timeout")),this._hub&&this._hub._onJobFinish(this);},PingJob.prototype._onJobCancelled=function(){this._callback&&this._callback(new Error("job cancelled"));};var CurrentActivityJob=function CurrentActivityJob(e,t){this._hub=e,this._callback=t,this._data="",this._devices={devices:[],activities:[]};};CurrentActivityJob.prototype.execute=function(e){e.write('<iq type="get" id="current_activity"><oa xmlns="connect.logitech.com" mime="vnd.logitech.harmony/vnd.logitech.harmony.engine?getCurrentActivity"></oa></iq>');},CurrentActivityJob.prototype._onSocketData=function(e){if("<iq/>"!=e&&(this._data+=e,-1!=this._data.indexOf("</iq>"))){var t=null,o=this._data.indexOf("<![CDATA["),n=this._data.indexOf("]]>");if(o>0&&n>o){var i=this._data.substring(o+9,n);0==i.indexOf("result=")&&(t=i.substr(7));}this._callback&&this._callback(null,t),this._hub&&this._hub._onJobFinish(this);}},CurrentActivityJob.prototype._onSocketTimeout=function(){this._callback&&this._callback(null,this._devices),this._hub&&this._hub._onJobFinish(this);},CurrentActivityJob.prototype._onJobCancelled=function(){this._callback&&this._callback(new Error("job cancelled"));};var Hub=function Hub(e,t,o,n,i,s){this._logger=require("x.logger.js").getLogger("xnm.aio.harmony.Hub"),this.ip=e,this.port=5222,t&&(this.port=t),this.user=o,this.password=n,this.uuid=s,this._authToken=i,this._sessionToken=null,this._socket=null,this._fsm=0,this._jobQueue=[],this._pingIT=null,this._listener=null;};return Hub.SO_TIMEOUT=5e3,Hub.FSM_STATE={IDLE:0,CONNECTING:1,CONNECTED:2},Hub.DEVICE_TYPE={IR:"IRCommand",ACTIVITY:"Activity"},Hub.prototype.startMonitor=function(e){var t=this;this._createSession(function(o){t._logger.log("debug","create session finish:"+o),o?(t._fsm=Hub.FSM_STATE.IDLE,t._clean()):(t._fsm=Hub.FSM_STATE.CONNECTED,t._startPing()),e&&e(o);});},Hub.prototype.setMonitorListener=function(e){this._listener=e;},Hub.prototype.executeCommandCreator=function(e,t,o,n){t&&t.value?e&&e.id?e.type?(this._logger.log("debug","execute command:"+t.value),this._sendCommand(e.type,t.value,e.id,n,function(e){o&&o(e);})):o&&o(new Error("device has no type")):o&&o(new Error("device has no id")):o&&o(new Error("command invalid"));},Hub.prototype.getStatesCreator=function(e,t,o){t?this.getCurrentActivity(function(e,n){for(var i=[],s=0;s<t.length;s++){var a=t[s],r="?";a&&a.id&&t[s].device&&(r=e?"?":-1==n?"off":a.device.id==n?"on":"off",i.push({id:t[s].id,status:r}));}o&&o(null,i);}):o&&o(new Error("deviceList is null"));},Hub.prototype.getDevices=function(e,t){var o=new GetDevicesJob(this,e,t);this._addJob(o);},Hub.prototype.getCurrentActivity=function(e){var t=new CurrentActivityJob(this,e);this._addJob(t);},Hub.prototype._getAuthToken=function(e){this._logger.log("debug","get auth token");var t='{"password":"'+this.password+'", "email":"'+this.user+'"}',o=this,n=require("url").parse("https://svcs.myharmony.com/CompositeSecurityServices/Security.svc/json/GetUserAuthToken"),i={host:n.hostname,path:n.path,method:"POST",headers:{"Content-Type":"application/json; charset=utf-8","Content-Length":t.length,Connection:"close"}},s=e,a=require("https").request(i,function(e){if(200==e.statusCode){e.setEncoding("binary");var t="";e.on("data",function(e){t+=e;}),e.on("end",function(){var e=JSON.parse(t);if(e&&e.GetUserAuthTokenResult&&e.GetUserAuthTokenResult.UserAuthToken){var n=e.GetUserAuthTokenResult.UserAuthToken;n||(n="dummy_token"),s&&(o._logger.log("trace","get auth token: "+n),s(null,n),s=null);}else s&&(o._logger.log("trace","get token HTTP response has no token, use dummy token"),s(null,"dummy_token"),s=null);});}else s&&(s(new Error("get auth token HTTP response: "+e.statusCode)),s=null);});a.on&&"function"==typeof a.on&&a.on("error",function(e){s&&(s(e),s=null);}),a.write(t),a.end();},Hub.prototype._getSessionToken=function(e){if(this._logger.log("debug","get session token"),this._sessionToken)e&&e(null,this._sessionToken);else{var t='<iq type="get" id="3174962747" from="guest"><oa xmlns="connect.logitech.com" mime="vnd.logitech.connect/vnd.logitech.pair">token='+this._authToken+":name=1vm7ATw/tN6HXGpQcCs/A5MkuvI#iOS6.0.1#iPhone</oa></iq>",o=!1,n=e,i=this,s={port:this.port,host:this.ip},a=require("net").connect(s);a.setTimeout(Hub.SO_TIMEOUT),a.setEncoding("utf8"),a.on("connect",function(){i._logger.log("trace","get session token connect to hub:"+i.ip),o=!0,a.write(t);}),a.on("data",function(e){if(i._logger.log("trace","get session token receive from hub:"+i.ip+" data:"+e),"<iq/>"!=e){var t=e.indexOf(":identity=");t>0?n&&(n(null,e.substr(t+10,36)),n=null):n&&(n(new Error("get session token response has no token")),n=null),a.end();}}),a.on("error",function(e){o?(i._logger.log("trace","get session token hub:"+i.ip+" error:"+e.message),a.end(),n&&(n(e),n=null)):(i._logger.log("trace","get session token hub:"+i.ip+" connection error:"+e.message),n&&(n(e),n=null));}),a.on("timeout",function(){o?(i._logger.log("trace","get session token hub:"+i.ip+" data timeout"),n&&(n(new Error("read timeout")),n=null),a.end()):(i._logger.log("trace","get session token hub:"+i.ip+" connection timeout"),n&&(n(new Error("connection timeout")),n=null));}),a.on("close",function(){i._logger.log("trace","get session token hub:"+i.ip+" close socket"),n&&(n(new Error("get session token socket closed")),n=null);}),a._doConnect&&"function"==typeof a._doConnect&&a._doConnect();}},Hub.prototype._login=function(e){this._logger.log("debug","login");var t='<auth xmlns="urn:ietf:params:xml:ns:xmpp-sasl" mechanism="PLAIN">'+new Buffer(this._sessionToken+"@x.com"+this._sessionToken).toString("base64")+"</auth>\r\n",o=!1,n=!1,i=e,s=this,a={port:this.port,host:this.ip},r="",c=require("net").connect(a);c.setTimeout(Hub.SO_TIMEOUT),c.setEncoding("utf8"),c.on("connect",function(){s._logger.log("trace","connect to hub:"+s.ip),o=!0,c.write("<stream:stream xmlns='jabber:client' xmlns:stream='http://etherx.jabber.org/streams' version='1.0' to='x.com'>\r\n"),c.write(t);}),c.on("data",function(e){s._logger.log("trace","receive from hub:"+s.ip+" data:"+e),n?s._onSocketData(e):-1!=(r+=e).indexOf("<success")&&(s._logger.log("trace","loggin success"),n=!0,i&&(i(null,c),i=null));}),c.on("error",function(e){o?n?(s._logger.log("trace","hub:"+s.ip+" error:"+e.message),s._onSocketError(e)):(s._logger.log("trace","hub:"+s.ip+" login socket error:"+e.message),i&&(i(e),i=null),c.end()):(s._logger.log("trace","hub:"+s.ip+" connection error:"+e.message),i&&(i(e),i=null));}),c.on("timeout",function(){o?n?(s._logger.log("trace","hub:"+s.ip+" data timeout"),s._onSocketTimeout()):(s._logger.log("trace","hub:"+s.ip+" login data timeout"),r?(s._logger.log("trace","authentication fail"),i&&(i(new Error("authentication fail")),i=null)):i&&(i(new Error("login timeout")),i=null)):(s._logger.log("trace","hub:"+s.ip+" connection timeout"),i&&(i(new Error("connection timeout")),i=null));}),c.on("close",function(){s._logger.log("trace","hub:"+s.ip+" close socket"),o&&n&&s._onSocketClose();}),c._doConnect&&"function"==typeof c._doConnect&&c._doConnect();},Hub.prototype._startPing=function(){var e=this;this._pingIT=setInterval(function(){var t=new PingJob(e);e._addJob(t);},15e3);},Hub.prototype._parseNotify=function(e){var t=null;if(!e||-1==e.indexOf('type="connect.stateDigest?notify"'))return null;var o=e.indexOf("<![CDATA[");if(-1==o)return null;o+=9;var n=e.indexOf("]]>",o);if(-1==n)return null;var i=e.substring(o,n);try{var s=JSON.parse(i);if(s.activityId)switch(t={activityId:s.activityId},s.activityStatus){case 3:t.activityStatus="POWERING_OFF";break;case 2:t.activityStatus="RUNNING";break;case 1:t.activityStatus="STARTING";break;case 0:t.activityStatus="NO_ACTIVITY";}return t;}catch(e){return null;}},Hub.prototype._sendCommand=function(e,t,o,n,i){var s=new SendCommandJob(this,n,{type:e,command:t,id:o},i);this._addJob(s);},Hub.prototype._addJob=function(e){var t=this._jobQueue.length;this._jobQueue.push(e),0==t&&this._doNextJob();},Hub.prototype._onSocketTimeout=function(){if(this._jobQueue&&this._jobQueue.length>0){var e=this._jobQueue[0];e&&e._onSocketTimeout&&e._onSocketTimeout();}},Hub.prototype._onSocketError=function(){this._closeSocket();},Hub.prototype._onSocketClose=function(){this._clean(),this._listener&&this._listener.onClose&&this._listener.onClose();},Hub.prototype._onSocketData=function(e){if(this._jobQueue&&this._jobQueue.length>0){var t=this._jobQueue[0];t&&t._onSocketData&&t._onSocketData(e);}if(this._listener&&this._listener.onData){var o=this._parseNotify(e);this._listener.onData(e,o);}},Hub.prototype._onJobFinish=function(e,t){e&&this._jobQueue&&this._jobQueue[0]===e&&(this._jobQueue.splice(0,1),t&&this._closeSocket(),this._doNextJob());},Hub.prototype._closeSocket=function(){this._logger.log("trace","manually close socket"),this._socket&&this._socket.end(),this._clean();},Hub.prototype._clean=function(){if(this._jobQueue)for(var e=0;e<this._jobQueue.length;e++){this._jobQueue[e]._onJobCancelled();}this._jobQueue=[],this._pingIT&&clearInterval(this._pingIT),this._pingIT=null,this._socket=null,this._sessionToken=null,this._fsm=Hub.FSM_STATE.IDLE;},Hub.prototype._doNextJob=function(){var e=this;if(this._jobQueue&&this._jobQueue.length>0){if(this._fsm==Hub.FSM_STATE.IDLE)return this._logger.log("debug","not connected"),this._fsm=Hub.FSM_STATE.CONNECTING,void this._createSession(function(t){if(e._logger.log("debug","create session finish:"+t),t)return e._fsm=Hub.FSM_STATE.IDLE,void e._clean();e._fsm=Hub.FSM_STATE.CONNECTED,e._doNextJob();});if(this._fsm==Hub.FSM_STATE.CONNECTED)this._logger.log("debug","execute next job"),this._jobQueue[0].execute(this._socket);}},Hub.prototype._createSession=function(e){var t=this;this._authToken?this._sessionToken?this._login(function(o,n){if(o||!n)return t._sessionToken=null,void(e&&e(o||new Error("socket is null")));t._socket=n,e&&e(o);}):this._getSessionToken(function(o,n){o?e&&e(o):n?(t._sessionToken=n,t._createSession(e)):e&&e(new Error("invalid session token"));}):this._getAuthToken(function(o,n){o?e&&e(o):n?(t._authToken=n,t._createSession(e)):e&&e(new Error("invalid auth token"));});},Hub.prototype.toJSON=function(){return{sys:xnm.aio.harmony.DM.SYS,ip:this.ip,port:this.port,username:this.user,password:this.password,token:this._authToken,uuid:this.uuid};},Hub.prototype.equalsTo=function(e){return!!e&&e instanceof Hub&&this.ip==e.ip&&this.port==e.port&&this.user==e.user&&this.password==e.password;},Hub.parseJSON=function(e){return e&&e.ip&&e.username&&e.password?new xnm.aio.harmony.Hub(e.ip,e.port,e.username,e.password,e.token,e.uuid):null;},Hub;}(),xnm.aio.harmony.Discovery=function(){var Discovery=function Discovery(){this.Hubs={},this._sockets=[];var e=require("net"),t=this;this._server=e.createServer(function(e){e.on("data",function(e){for(var o={},n=e.toString().split(";"),i=0;i<n.length;i++){var s=n[i].split(":");2==s.length&&(o[s[0]]=s[1]);}o.ip&&o.port&&o.uuid&&(t.Hubs[o.uuid]?t.Hubs[o.uuid].ip=o.ip:t.Hubs[o.uuid]=new xnm.aio.harmony.Hub(o.ip,o.port,o.email,null,null,o.uuid));}),e.on("end",function(){}),e.on("error",function(e){});}),this._server.listen();var o=require("os");require("dgram");if(o&&o.networkInterfaces){var n=o.networkInterfaces();for(var i in n){for(var s=n[i],a=0;a<s.length;a++){this._addDiscoverSocket(null,s[a]);}}}else this._addDiscoverSocket(null,null);};return Discovery.prototype._addDiscoverSocket=function(e,t){var o,n=require("dgram");t?"IPv4"==t.family&&0==t.internal&&((o=n.createSocket("udp4")).on("listening",function(){o.setBroadcast(!0);}),o.ip=t.address,this._sockets.push(o)):(o=n.createSocket("udp4"),this._sockets.push(o));},Discovery.prototype._sendDiscoveryMessages=function(){for(var e=0;e<this._sockets.length;e++){if(this._sockets[e].ip){var t=this._sockets[e].ip.substr(0,this._sockets[e].ip.lastIndexOf("."))+".255",o=new Buffer("_logitech-reverse-bonjour._tcp.local.\n"+this._server.address().port);this._sockets[e].send(o,0,o.length,5224,t);}}},Discovery.prototype.discoverHubs=function(){var e=this,t=0,o=setInterval(function(){e._sendDiscoveryMessages(),t++>=1&&clearInterval(o);},250);},Discovery;}(),xnm.aio.harmony.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="HarmonyDeviceManagerError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"harmony",getGatewayType:function getGatewayType(){return{sys:this.SYS,name:"Logitech Harmony Hub"};},createGateway:function createGateway(e,t,o){var n=DMError,i=DMError.ERROR_CODE;e?e.ip?e.port?e.username?e.password?o(null,e):o(new n(i.INVALID,"password is invalid")):o(new n(i.INVALID,"username is invalid")):o(new n(i.INVALID,"port is invalid")):o(new n(i.INVALID,"ip is invalid")):o(new n(i.INVALID,"info is invalid"));},updateGateway:function updateGateway(e,t,o,n){var i=DMError,s=DMError.ERROR_CODE;t?t.ip?t.port?t.username?t.password?n(null,t):n(new i(s.INVALID,"password is invalid")):n(new i(s.INVALID,"username is invalid")):n(new i(s.INVALID,"port is invalid")):n(new i(s.INVALID,"ip is invalid")):n(new i(s.INVALID,"update is invalid"));},deleteGateway:function deleteGateway(e,t,o){o();},createDevice:function createDevice(e,t,o){var n=DMError,i=DMError.ERROR_CODE;if(e){if(e.gateway){if(t.data&&t.data.gateways&&0!==t.data.gateways.length){var s,a,r=t.data.gateways;for(s=0;s<r.length;s++){if(r[s].index===e.gateway){a=r[s];break;}}a?o(null,e):o(new n(i.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else o(new n(i.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else o(new n(i.INVALID,"gateway is invalid"));}else o(new n(i.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){var n=DMError,i=DMError.ERROR_CODE;if(e){if(e.gateway){var s,a,r=t.data.gateways;for(s=0;s<r.length;s++){if(r[s].index===e.gateway){a=r[s];break;}}a?o(null,e):o(new n(i.NOT_FOUND,"gateway with index "+e.gateway+" not exists"));}else o(new n(i.INVALID,"gateway is invalid"));}else o(new n(i.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},getCommandStatusMap:function getCommandStatusMap(e){var t={command:[]};if(e&&e.type&&e.type==xnm.aio.harmony.Hub.DEVICE_TYPE.IR){if(e&&e.ircodes&&e.ircodes.codes){for(var o=0;o<e.ircodes.codes.length;o++){var n=e.ircodes.codes[o];t.command.push({type:"enum",name:n.key,ref:{value:n.key}});}return t;}return null;}return e&&e.type&&e.type==xnm.aio.harmony.Hub.DEVICE_TYPE.ACTIVITY?(t.command.push({type:"enum",name:"execute",ref:{value:"execute"}}),t.status=[{type:"enum",name:"state",ref:{value:"state",options:["on","off"]}}],"-1"==e.id?t.ipevt=[{type:"enum",name:"event",ref:{value:"event",options:["allOff"]}}]:t.ipevt=[{type:"enum",name:"event",ref:{value:"event",options:["on","off"]}}],t):null;},applyUIFilter:function applyUIFilter(e,t){var _contains=function _contains(e,t){if("*"==e)return!0;for(var o=!1,n=0;n<e.length;n++){if(e[n]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var o=[],n=null,i=xnm.aio.harmony.DM.getCommandStatusMap(e);return i&&(n=function(e,t,o){var n=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var t=JSON.parse(JSON.stringify(e));n.push(t);}});}return n;}(i,0,t),o=o.concat(n)),o;};if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),n=null;switch(t.catagory){case"command":n=_filter(e,t),o.command=n;break;case"status":n=_filter(e,t),o.status=n;break;default:return null;}return n&&0!=n.length?o:null;},applyIPEventFilter:function applyIPEventFilter(e,t){if(!e.sys)return null;var o=JSON.parse(JSON.stringify(e)),n=xnm.aio.harmony.DM.getCommandStatusMap(e);return n?(o.ipevt=n.ipevt,o):o;}};}(),xnm.aio.harmony.Handler=function(){this._Discovery=null;},xnm.aio.harmony.Handler.prototype.devicemanager=xnm.aio.harmony.DM,xnm.aio.harmony.Handler.prototype.Hub=xnm.aio.harmony.Hub,xnm.aio.harmony.Handler.prototype.discoverHubs=function(e,t){this._Discovery||(this._Discovery=new xnm.aio.harmony.Discovery()),this._Discovery.discoverHubs();var o=this;setTimeout(function(){t&&t(null,o._Discovery.Hubs);},e);},xnm.aio.harmony.Handler.prototype.registModule=function(e){e.register(xnm.aio.harmony.DM.SYS,"harmony");},xnm.aio.harmony.Handler.prototype.resolveGateway=function(e){return xnm.aio.harmony.Hub.parseJSON(e);},xnm.aio.harmony.Handler.prototype.getDeviceCommands=function(e,t){var o=xnm.aio.harmony.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),n=o?o.command:[];t&&t(null,n);},xnm.aio.harmony.Handler.prototype.getDeviceStatus=function(e,t){var o=xnm.aio.harmony.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),n=o?o.status:[];t&&t(null,n);},xnm.aio.harmony.Handler.prototype.getDevices=function(e,t){var o=this.resolveGateway(e);o?o.getDevices(!0,t):t&&t(new Error("gateway json format invalid"));},xnm.aio.harmony.Handler.prototype.doCommand=function(e,t,o,n){var i=this.resolveGateway(e);i?i.executeCommandCreator(t,o,n,!0):n&&n(new Error("gateway json format invalid"));},xnm.aio.harmony.Handler.prototype.doStatus=function(e,t,o,n,i){var s=this.resolveGateway(t);if(s){var a=[{id:e,device:o,status:n}];s.getStatesCreator(null,a,function(e,t){e?i&&i(e):i&&i(null,t[0]);});}else i&&i(new Error("gateway json format invalid"));},xnm.aio.harmony.Handler.prototype.getAuthToken=function(e,t){var o=this.resolveGateway(e);o?o._getAuthToken(t):t&&t(new Error("gateway json format invalid"));},"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.harmony.Handler());