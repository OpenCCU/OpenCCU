var util=require("util"),EventEmitter=require("events"),x=x||{};x.hub=x.hub||{},x.hub.m=x.hub.m||{},x.hub.m.sonos=x.hub.m.sonos||{},x.hub.m.sonos.MODULE=require("xnm.aio.sonos.js"),x.hub.m.sonos.AudioPlayer=function(){var Audio=function Audio(){this._process={};};return Audio.prototype.playFile=function(e,o,r){if(o&&o.file){var t=require("x.hub.resource.js").getFileURL(o.file,e.ip);t?(o.url=t,this.playUrl(e,o,r)):r&&r(new Error("no such file"));}else r&&r(new Error("invalid file"));},Audio.prototype.playUrl=function(e,o,r){if(o){var t=o.url;if(t||(t=o.ext),t){var u=x.hub.m.sonos.MODULE.resolveDevice(e);if(u){var i=this;this._cancelPlay(u,function(e){e?r&&r(e):i._setVolume(u,o.volume,function(e){e?r&&r(e):i._unmute(u,function(e){e?r&&r(e):i._playUrl(u,t,function(e){e?r&&r(e):i._setRepeat(u,o.repeat,function(e){e?r&&r(e):o.repeat&&-1!=o.repeat&&(i._process[u.ip]={url:t},i._process[u.ip].timeout=setTimeout(function(){var e=i._process[u.ip].url;i._process[u.ip]=null,i._stopPlay(u,e);},1e3*parseInt(o.repeat)));});});});});}),r&&r(null,1);}else r&&r(new Error("invalid device json"));}else r&&r(new Error("invalid url"));}else r&&r(new Error("invalid command"));},Audio.prototype._cancelPlay=function(e,o){if(e.ip&&this._process[e.ip]){this._process[e.ip].timeout&&clearTimeout(this._process[e.ip].timeout);var r=this._process[e.ip].url;this._process[e.ip]=null,r?this._stopPlay(e,r,o):o&&o();}else o&&o();},Audio.prototype._stopPlay=function(e,o,r){e.getMediaInfo(function(t,u){!t&&u&&u.currentURI&&u.currentURI!=o?r&&r():e.stop(r);});},Audio.prototype._setVolume=function(e,o,r){o?e.setVolume(o,r):r&&r();},Audio.prototype._setRepeat=function(e,o,r){o?e.repeatOne(r):e.repeatOff(r);},Audio.prototype._unmute=function(e,o){e.unmute(o);},Audio.prototype._playUrl=function(e,o,r){o?e.playUrl(o,r):r&&r(new Error("invalid url"));},Audio;}(),x.hub.m.sonos.Handler=function(){var Handler=function Handler(){this._audioPlayer=new x.hub.m.sonos.AudioPlayer();};return util.inherits(Handler,EventEmitter),Handler.prototype.init=function(e){setTimeout(function(){x.hub.m.sonos.MODULE._master._autoSearchTimeout&&clearTimeout(x.hub.m.sonos.MODULE._master._autoSearchTimeout);var e=require("xnm.aio.raumfeld.js");e.discovery._autoSearchTimeout&&clearTimeout(e.discovery._autoSearchTimeout);var o=require("xnm.aio.bose.js");o.master._autoSearchTO&&clearTimeout(o.master._autoSearchTO);},15e3),e&&e();},Handler.prototype.getSystems=function(){return["sonos"];},Handler.prototype.executeCommand=function(e,o,r){o?"playFile"==o.value?this._audioPlayer.playFile(e,o,function(e){r&&r({error:e});}):"playUrl"==o.value?this._audioPlayer.playUrl(e,o,function(e){r&&r({error:e});}):x.hub.m.sonos.MODULE.doCommand(e,o,r):r&&r({error:new Error("invalid command")});},Handler.prototype.executeCommandV6=function(e,o,r,t){var u;if(!e||!e.address)return(u=new Error("invalid device json")).code="000000",void(t&&t(u));if(!r)return(u=new Error("invalid command")).code="000000",void(t&&t(u));var i={sys:"sonos",ip:e.address,port:e.port},n=x.hub.m.sonos.MODULE.resolveDevice(i);if(!n)return(u=new Error("invalid device json")).code="000000",void(t&&t(u));if("alarm"!=r.command){a={value:null,ext:null};switch(r.command){case"pause":case"stop":case"previous":case"next":case"mute":case"unmute":a.value=r.command;break;case"play":r.value?(a.value="playUrl",a.ext=r.value):a.value="play";break;case"volume":a.value="volume",a.ext=r.value;break;default:return(u=new Error("unknown command")).code="000000",void(t&&t(u));}n.executeCommandCreator(i,a,function(e){e&&(e.code="000000"),t&&t(e);});}else{if(!r.value||!r.value.file)return(u=new Error("invalid command")).code="000000",void(t&&t(u));var a;(a={}).volume=r.value.volume,a.repeat=r.value.time;var s=r.value.file;"file://file/"==s.substr(0,12)?(a.value="playFile",a.file=s.substr(12),this.executeCommand(i,a,function(e){e&&e.error?t&&t(e.error):t&&t();})):(a.value="playUrl",a.url=s,this.executeCommand(i,a,function(e){e&&e.error?t&&t(e.error):t&&t();}));}},Handler.prototype.getStatesV6=function(e,o,r){var t;if(!(e?e.address:null))return(t=new Error("invalid device json")).code="000000",void(r&&r(t));var u={sys:"sonos",ip:e.address,port:e.port},i=x.hub.m.sonos.MODULE.resolveDevice(u);if(!i)return(t=new Error("invalid device json")).code="000000",void(r&&r(t));var n=[{id:"playState",device:u,status:{value:"playState"}},{id:"volume",device:u,status:{value:"volume"}},{id:"muted",device:u,status:{value:"muted"}}];i.getStatesCreator(null,n,function(e,o){if(e)r&&r(e);else{var t={};if(o)for(var u=0;u<o.length;u++){var i=o[u];i&&("playState"==i.id&&i.status?t.state="PLAYING"==i.status?"playing":"paused":"volume"==i.id&&null!=i.status&&null!=i.status?t.volume=parseInt(i.status):"muted"==i.id&&(t.muted="true"==i.status||1==i.status));}r&&r(null,t);}});},Handler;}(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new x.hub.m.sonos.Handler());