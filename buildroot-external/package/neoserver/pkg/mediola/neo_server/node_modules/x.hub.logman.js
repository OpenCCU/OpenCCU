var x=x||{};x.hub=x.hub||{},x.hub.logman=x.hub.logman||{},x.hub.logman.Handler=(Handler=function Handler(){},Handler.prototype.init=function(e,r){var l=global.LOG_LEVEL;if(localStorage){var o=localStorage.getItem("x.hub.Server.logLevel");void 0!==o&&null!=o&&(l=o);}this._setupLogger(e,l),"fatal"==l?this._clearLogFiles(r):r&&r();},Handler.prototype.setLoggger=function(e,r,l){require("x.logger.js").setLevel(r,e),!e&&localStorage&&localStorage.setItem("x.hub.Server.logLevel",r),this._logAllInAll(),e||"fatal"!=r?l&&l():this._clearLogFiles(l);},Handler.prototype.clearLogs=function(e){this._clearLogFiles(e);},Handler.prototype.compressLogs=function(e){var r=require("x.hub.fileman.js").fileManager.getUserLogPath(),l=require("os").tmpdir(),o=require("path"),g=require("fs-extra"),a=require("archiver"),i="logs_"+new Date().toISOString().substr(0,16).replace(/T/g,"").replace(/-/g,"").replace(/:/g,"")+".zip",t=o.join(l,i),s=g.createWriteStream(t),n=a("zip");s.on("close",function(){e&&(e(null,i,t),e=null);}),s.on("error",function(r){e&&(e(r),e=null);}),n.on("error",function(r){e&&(e(r),e=null);}),n.pipe(s),n.directory(r),n.finalize();},Handler.prototype._setupLogger=function(e,r){var l=require("fs-extra"),o=require("path");require("x.logger.js").setFile(e.getLogFile()),require("x.logger.js").setLogFolder(e.getUserLogPath()),require("x.logger.js")._fileMaxSize=2048,require("x.logger.js").setLevel(r),require("x.logger.js").setTagFile("x.hub.v5.CloudConnect","v5p_cloud_access.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.v5.CloudConnect"),l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_taskmanager.log")),require("x.logger.js").setTagFile("x.hub.taskman","v5p_taskmanager.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.taskman"),l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_homematic.log")),require("x.logger.js").setTagFile("x.hub.m.hm","v5p_homematic.log"),require("x.logger.js").setTagFile("xnm.aio.hm","v5p_homematic.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.hm"),require("x.logger.js").setLogToConsole(!1,"xnm.aio.hm"),global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("enocean")&&(l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_enocean.log")),require("x.logger.js").setTagFile("x.hub.m.enocean","v5p_enocean.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.enocean")),global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("zigbee")&&(l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_zigbee.log")),require("x.logger.js").setTagFile("x.hub.m.zigbee","v5p_zigbee.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.zigbee")),global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("zway")&&(l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_zwave.log")),require("x.logger.js").setTagFile("x.hub.m.zway","v5p_zwave.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.zway")),global.LOAD_MODULES&&-1!=global.LOAD_MODULES.indexOf("knx")&&(l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_knx.log")),require("x.logger.js").setTagFile("x.hub.m.knx","v5p_knx.log"),require("x.logger.js").setTagFile("xnm.aio.knx","v5p_knx.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.knx"),require("x.logger.js").setLogToConsole(!1,"xnm.aio.knx")),l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_aiogateway.log")),require("x.logger.js").setTagFile("x.hub.m.gateway","v5p_aiogateway.log"),require("x.logger.js").setTagFile("xnm.aio.gateway","v5p_aiogateway.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.m.gateway"),require("x.logger.js").setLogToConsole(!1,"xnm.aio.gateway"),l.ensureFileSync(o.resolve(e.getUserLogPath(),"v5p_rf_st.log")),require("x.logger.js").setTagFile("x.hub.v5.USBSerial","v5p_rf_st.log"),require("x.logger.js").setTagFile("x.hub.v6.STM.Serial","v5p_rf_st.log"),require("x.logger.js").setLogToConsole(!1,"x.hub.v5.USBSerial"),l.ensureFileSync(o.resolve(e.getUserLogPath(),"v6p_pm.log")),require("x.logger.js").setTagFile("x.hub.PluginManager","v6p_pm.log"),this._logAllInAll(),this._logErrorsInErrors();},Handler.prototype._clearLogFiles=function(e){var r=this;this._clearMainLogFile(function(){r._clearTagFiles(function(){r._clearConsoleDumpFile(function(){e&&e();});});});},Handler.prototype._clearConsoleDumpFile=function(e){if("EA"==global.HARDWARE_VERSION){var r=require("x.hub.fileman.js").fileManager,l=require("path");this._clearLogFile(l.resolve(r.getUserLogPath(),"v5plus_daemon"),e);}else e&&e();},Handler.prototype._clearMainLogFile=function(e){var r=require("x.hub.fileman.js").fileManager,l=require("path"),o=require("x.logger.js").getFile();o?this._clearLogFile(l.resolve(r.getUserLogPath(),o),e):e&&e();},Handler.prototype._clearTagFiles=function(e){var r=require("x.hub.fileman.js").fileManager,l=require("x.logger.js").getTagFiles(),o=require("path"),g=[];for(var a in l){l[a]&&g.push(l[a]);}if(0!=g.length){var i=0,t=this,cb=function cb(){++i<g.length?t._clearLogFile(o.resolve(r.getUserLogPath(),g[i]),cb):e&&e();};this._clearLogFile(o.resolve(r.getUserLogPath(),g[i]),cb),this._clearLogFile(o.resolve(r.getUserLogPath(),"x.log"));}else e&&e();},Handler.prototype._clearLogFile=function(e,r){if(e){var l=require("fs-extra");l.ensureFile(e,function(o){o?r&&r(o):l.writeFile(e,"",function(e){r&&r(e);});});}else r&&r();},Handler.prototype._logAllInAll=function(){var e=this._getLogLevel();1!=e&&"all"!=e&&"trace"!=e||(require("x.logger.js").setTagFile("x","all.log"),require("x.logger.js").setTagFile("xnm","all.log"),require("x.logger.js").setTagFile("m","all.log"),require("x.logger.js").setFileSize("all.log",51200));},Handler.prototype._logErrorsInErrors=function(){var e=this._getLogLevel();4!=e&&5!=e&&6!=e&&"warn"!=e&&"error"!=e&&"fatal"!=e||(require("x.logger.js").setTagFile("x","errors.log"),require("x.logger.js").setTagFile("xnm","errors.log"),require("x.logger.js").setTagFile("m","errors.log"),require("x.logger.js").setFileSize("errors.log",102400));},Handler.prototype._getLogLevel=function(){var e=global.LOG_LEVEL;if(localStorage){var r=localStorage.getItem("x.hub.Server.logLevel");void 0!==r&&null!=r&&(e=r);}return"undefined"!=e&&null!=e||(e="fatal"),e;},Handler),module.exports=new x.hub.logman.Handler();