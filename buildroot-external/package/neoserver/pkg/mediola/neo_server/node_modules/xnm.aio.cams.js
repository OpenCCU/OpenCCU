"use strict";function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function");}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:true,configurable:true}});Object.defineProperty(subClass,"prototype",{writable:false});if(superClass)_setPrototypeOf(subClass,superClass);}function _setPrototypeOf(o,p){_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){o.__proto__=p;return o;};return _setPrototypeOf(o,p);}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var Super=_getPrototypeOf(Derived),result;if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget);}else{result=Super.apply(this,arguments);}return _possibleConstructorReturn(this,result);};}function _possibleConstructorReturn(self,call){if(call&&(_typeof(call)==="object"||typeof call==="function")){return call;}else if(call!==void 0){throw new TypeError("Derived constructors may only return object or undefined");}return _assertThisInitialized(self);}function _assertThisInitialized(self){if(self===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true;}catch(e){return false;}}function _getPrototypeOf(o){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o);};return _getPrototypeOf(o);}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);Object.defineProperty(Constructor,"prototype",{writable:false});return Constructor;}function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.cams=xnm.aio.cams||{},xnm.aio.cams._moveFromTmp=function(e,t,o){var i=require("fs"),n=i.createReadStream(e),s=i.createWriteStream(t);s.on("error",function(e){XC.debugf(e.message,"error"),o&&o(e);}),n.on("error",function(e){XC.debugf(e.message,"error"),o&&o(e);}),n.on("end",function(){try{i.unlinkSync(e);}catch(e){}o&&o();}),n.pipe(s);},xnm.aio.cams.rename=function(e,t,o,i){var cbWait=function cbWait(){setTimeout(function(){o&&o();},100);};if("undefined"==typeof process||"object"!=_typeof(process.release)||"node"!==process.release.name||"win32"!==process.platform&&!i){var _o=require("fs");try{_o.renameSync(e,t);}catch(o){return void xnm.aio.cams.rename(e,t,cbWait,!0);}cbWait&&cbWait();}else this._moveFromTmp(e,t,cbWait);},xnm.aio.cams.SystemCam=/*#__PURE__*/function(){function SystemCam(e,t){_classCallCheck(this,SystemCam);this._$cam=e,this._options=t,this.jpegurl=this._addAuth("http://"+this._getIP()+e.attr("imageurl")),this.mjpegurl=null,e.attr("mjpegurl")&&(this.mjpegurl=this._addAuth("http://"+this._getIP()+e.attr("mjpegurl")),"true"==e.attr("useurlauth")&&(this.mjpegurl=this._addAuth("http://"+t.user+":"+t.password+"@"+this._getIP()+e.attr("mjpegurl"))),window.XCHost&&window.XCHost.getType&&("node-webkit"===window.XCHost.getType()||"Android"===window.XCHost.getType())&&("doorbird"===e.attr("id")||String(e.attr("name")).includes("DoorBird")||(this.mjpegurl=null))),this.controlurl=null,this.pantilt=!1,"true"===t.pantilt&&(this.pantilt=!0,e.attr("controlurl")&&(this.controlurl=this._addAuth("http://"+this._getIP()+e.attr("controlurl"))),e.attr("controlpostdata")&&(this.controlpostdata=e.attr("controlpostdata"))),e.attr("imagepathurl")&&(this.jpegurl=null,this.mjpegurl=null,this.jpegpathurl=this._addAuth("http://"+this._getIP()+e.attr("imagepathurl")));}_createClass(SystemCam,[{key:"_getIP",value:function _getIP(){var e=this._$cam.attr("port");var t=this._options.address;return t.indexOf(":")<0&&e&&80!=e&&(t+=":"+e),t;}},{key:"_addAuth",value:function _addAuth(e){var t=this._$cam.attr("auth");if(t){t=t.replace("@user",encodeURIComponent(this._options.user)),t=t.replace("@pwd",encodeURIComponent(this._options.password));var o=e.includes("?")?"&":"?";e+=o+t;}return e;}},{key:"_doRequest",value:function _doRequest(e,t,o){var i=require("url").parse(e);i.port||(i.port=80);var n={host:i.hostname,port:i.port,path:i.path,method:"GET",user:this._options.user,password:this._options.password,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(this._options.user+":"+this._options.password).toString("base64"),Connection:"close"}};t&&(n.method="POST",n.headers["Content-Length"]=t.length);var s=require("http").request(n,function(e){o&&o(e);});"function"==typeof s.on&&s.on("error",function(e){o&&o();}),t&&s.write(t),s.end();}},{key:"executeCommand",value:function executeCommand(e){if(!this.controlurl)return;var t=this;this._$cam.find("key").each(function(){var o=$(this);if(o.attr("id")!==e)return;var i=t.controlurl.replace("%@",o.attr("code")),n=null;t.controlpostdata&&(i=t.controlurl,n=t.controlpostdata.replace("%@",o.attr("code"))),t._doRequest(i,n,function(o){var n=500;"left"!==e&&"right"!==e||(n=800),"XS100"===t._$cam.attr("id")?setTimeout(function(){i=t.controlurl.replace("%@","1"),t._doRequest(i);},n):t._$cam.attr("stop")&&setTimeout(function(){i=t.controlurl.replace("%@",t._$cam.attr("stop")),t._doRequest(i);},n/2);});});}}]);return SystemCam;}(),xnm.aio.cams.JPEGCam=/*#__PURE__*/function(){function JPEGCam(e,t,o,i){_classCallCheck(this,JPEGCam);this._url=e,this._imgPath=o,this._imgPage=i,this._options=t,this._prevDone=!0;}_createClass(JPEGCam,[{key:"_loadImage",value:function _loadImage(e){var _this=this;var t=require("fs");this._loadImage2Tmp(function(o,i){if(!o||!t.existsSync(o))return void(e&&e(null,i));var n=null;n="object"==(typeof nw==="undefined"?"undefined":_typeof(nw))?nw.App.dataPath+"/../cams/":t.dataPath()+"/cams/";var s="image.jpg";if(_this._options&&_this._options.imageName&&(s=_this._options.imageName),t.mkdirRecursiveSync(n),t.existsSync(n+s)){var _i=n+s+"_"+new Date().getTime();xnm.aio.cams.rename(n+s,_i,function(){t.existsSync(_i)&&t.unlinkSync(_i),xnm.aio.cams.rename(o,n+s,function(){e&&e("file://"+n+s+"?"+new Date().getTime());});});}else xnm.aio.cams.rename(o,n+s,function(){e&&e("file://"+n+s+"?"+new Date().getTime());});});}},{key:"_loadImage2Tmp",value:function _loadImage2Tmp(e){var _this2=this;if(!this._url)return void XC.debugf("[xnm.aio.cams.JPEGCam._loadImage2Tmp] No URL set!");if(!this._prevDone)return void(e&&e());var t=require("http");require("fs");this._prevDone=!1,t.getFile(this._url,this._options,function(t,o){t?e&&e(t):(XC.debugf("failed to load "+_this2._url),e&&e(null,o)),_this2._prevDone=!0;},null,{encodeURL:!1});}},{key:"_getImagePath",value:function _getImagePath(e){var t=require("url").parse(this._imgPath);t.port||(t.port=80),this._ip=t.hostname+":"+t.port;var o={host:t.hostname,port:t.port,path:t.path,method:"GET",user:this._options.user,password:this._options.password,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(this._options.user+":"+this._options.password).toString("base64"),Connection:"close"}},i=require("http").request(o,function(t){t.setEncoding("utf-8");var o="";t.on("data",function(e){o+=e;}),t.on("end",function(){e&&e(o);});});"function"==typeof i.on&&i.on("error",function(t){e&&e();}),i.end();}},{key:"_getImagePage",value:function _getImagePage(e){var t=require("url").parse(this._imgPage);t.port||(t.port=80),this._ip=t.hostname+":"+t.port;var o={host:t.hostname,port:t.port,path:t.path,method:"GET",user:this._options.user,password:this._options.password,headers:{"Content-Type":'text/xml; charset="utf-8"',Authorization:"Basic "+new Buffer(this._options.user+":"+this._options.password).toString("base64"),Connection:"close"}},i=require("http").request(o,function(t){t.setEncoding("utf-8");var o="";t.on("data",function(e){o+=e;}),t.on("end",function(){200!=t.statusCode?e&&e(new Error("http status code: "+t.statusCode)):e&&e(null,o),e=null;});});"function"==typeof i.setTimeout&&i.setTimeout(5e3,function(){e&&e(new Error("timeout")),e=null;}),"function"==typeof i.on&&i.on("error",function(t){e&&e(t),e=null;}),i.end();}},{key:"loadImage",value:function loadImage(e){var _this3=this;this._imgPath?this._getImagePath(function(t){if(_this3._url=null,t){var _e=t.indexOf('path="'),o=t.lastIndexOf('"');_e>-1&&o>_e&&(_this3._url="http://"+_this3._ip+t.substring(_e+6,o));}_this3._loadImage(e);}):this._imgPage?this._getImagePage(function(t,o){if(t||!o)return void(e&&e());_this3._url=null;var i=o.substr(o.indexOf('<img src="')+10);i=i.substr(0,i.indexOf('"/>')),i=i.substr(2),_this3._url="http://"+_this3._ip+i,_this3._loadImage(e);}):this._loadImage(e);}},{key:"loadImage2Tmp",value:function loadImage2Tmp(e){var _this4=this;this._imgPath?this._getImagePath(function(t){if(_this4._url=null,t){var _e2=t.indexOf('path="'),o=t.lastIndexOf('"');_e2>-1&&o>_e2&&(_this4._url="http://"+_this4._ip+t.substring(_e2+6,o));}_this4._loadImage2Tmp(e);}):this._loadImage2Tmp(e);}}]);return JPEGCam;}(),xnm.aio.cams.MJPEGCam=/*#__PURE__*/function(){function MJPEGCam(e,t){_classCallCheck(this,MJPEGCam);this._url=e,this._options=t,this._mjpegClient=null,this._loading=!1;}_createClass(MJPEGCam,[{key:"_loadImage",value:function _loadImage(e){var _this5=this;var t=require("fs");this._loadImage2Tmp(function(o){if(o){if(t.existsSync(o)){var i=null;i="object"==(typeof nw==="undefined"?"undefined":_typeof(nw))?nw.App.dataPath+"/../cams/":t.dataPath()+"/cams/";var n="image.jpg";if(_this5._options&&_this5._options.imageName&&(n=_this5._options.imageName),t.mkdirRecursiveSync(i),t.existsSync(i+n)){var s=i+n+"_"+new Date().getTime();xnm.aio.cams.rename(i+n,s,function(){t.existsSync(s)&&t.unlinkSync(s),xnm.aio.cams.rename(o,i+n,function(){e&&e("file://"+i+n+"?"+new Date().getTime());});});}else xnm.aio.cams.rename(o,i+n,function(){e&&e("file://"+i+n+"?"+new Date().getTime());});}}else e&&e();});}},{key:"_loadImage2Tmp",value:function _loadImage2Tmp(e){var _this6=this;if(!this._url)return void(e&&e());if(!this._mjpegClient){var _e3=require("x.mjpeg.js");this._mjpegClient=_e3.getClient(this._url,this._options);}if(this._loading)return void(e&&e());require("fs");this._loading=!0,this._mjpegClient.getFile(this._url,this._options,function(t){_this6._loading=!1,t?e&&e(t):(XC.debugf("failed to load "+_this6._url),e());});}},{key:"loadImage",value:function loadImage(e){this._loadImage(e);}},{key:"loadImage2Tmp",value:function loadImage2Tmp(e){this._loadImage2Tmp(e);}}]);return MJPEGCam;}(),xnm.aio.cams.FoscamDiscovery=/*#__PURE__*/function(){function FoscamDiscovery(){var _this7=this;_classCallCheck(this,FoscamDiscovery);this._sockets=[];var e=require("os"),t=require("dgram");if(e&&e.networkInterfaces){var o=t.createSocket("udp4");o.bind(9600,"0.0.0.0"),o.on("message",function(e,t){_this7._receivedData(t.address,e.toString("hex"));});var i=e.networkInterfaces();for(var _e4 in i){var _t=i[_e4];for(var _e5=0;_e5<_t.length;_e5++){this._addDiscoverSocket(9600,_t[_e5]);}}}else this._addDiscoverSocket(9600,null);}_createClass(FoscamDiscovery,[{key:"_receivedData",value:function _receivedData(e,t){XC.debugf("Received camdata from "+e);}},{key:"_addDiscoverSocket",value:function _addDiscoverSocket(e,t){var _this8=this;var o=require("dgram");if(t){if("IPv4"==t.family&&0==t.internal){var i=o.createSocket("udp4");i.on("listening",function(){i.setBroadcast(!0);}),i.bind(e,t.address),this._sockets.push(i);}}else{var _e6=o.createSocket("udp4");_e6.on("message",function(e,t){_this8._receivedData(t.address,e.toString("hex"));}),this._sockets.push(_e6);}}},{key:"_sendDiscoveryMessages",value:function _sendDiscoveryMessages(e,t,o,i){var n=new Buffer([77,79,95,73,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,4,0,0,0,0,0,0,1]),s=new Buffer([68,72,1,1]);for(var _e7=0;_e7<this._sockets.length;_e7++){this._sockets[_e7].send(n,0,n.length,1e4,"255.255.255.255"),this._sockets[_e7].send(s,0,s.length,8600,"255.255.255.255");}}},{key:"discoverCams",value:function discoverCams(){var _this9=this;var e=0;var t=setInterval(function(){_this9._sendDiscoveryMessages(),e++>=4&&clearInterval(t);},250);}}]);return FoscamDiscovery;}(),xnm.aio.cams.Cam=/*#__PURE__*/function(){function Cam(e,t){_classCallCheck(this,Cam);this._options=e,this._camInfo=t;}_createClass(Cam,[{key:"getIP",value:function getIP(){if(!this._options)return null;var e=this._options.ip;var t=e.indexOf(":");return-1!==t&&(e=e.substr(0,t)),e;}},{key:"getPort",value:function getPort(){if(!this._options)return null;var e=this._options.port;var t=this._options.ip,o=t.indexOf(":");return e||-1===o||(e=parseInt(t.substr(o+1),10)),e;}},{key:"getUsername",value:function getUsername(){return this._options?this._options.username:null;}},{key:"getPassword",value:function getPassword(){return this._options?this._options.password:null;}},{key:"getVideoInfo",value:function getVideoInfo(e){var t={username:this._options.username,password:this._options.password,jpeg:this.getJPEGURL(),mjpeg:this.getMJPEGURL(),jpegPath:this.getJPEGPathURL(),jpegPage:this.getJPEGPageURL()};e&&e(null,t);}},{key:"getJPEGURL",value:function getJPEGURL(){if(!this._camInfo||!this._camInfo.imageurl)return null;var e=this.getRootUrl()+this._camInfo.imageurl;return this._addAuth(e,{type:"jpeg"});}},{key:"getJPEGPathURL",value:function getJPEGPathURL(){return this._camInfo&&this._camInfo.imagepathurl?this._addAuth(this.getRootUrl()+this._camInfo.imagepathurl,{type:"jpegpath"}):null;}},{key:"getJPEGPageURL",value:function getJPEGPageURL(){return this._camInfo&&this._camInfo.imagepageurl?this._addAuth(this.getRootUrl()+this._camInfo.imagepageurl,{type:"jpegpage"}):null;}},{key:"getMJPEGURL",value:function getMJPEGURL(){if(!this._camInfo||!this._camInfo.mjpegurl)return null;var e=this.getRootUrl()+this._camInfo.mjpegurl;if("true"===this._camInfo.useurlauth){var t="";this._options.username&&(t=this._options.username+":"+(this._options.password||"")),e=this.getRootUrl(t)+this._camInfo.mjpegurl;}return this._addAuth(e,{type:"mjpeg"});}},{key:"executeCommandCreator",value:function executeCommandCreator(e,t,o){this.executeCommand(t.value,o);}},{key:"getStatesCreator",value:function getStatesCreator(e,t,o){o&&o(null,[]);}},{key:"executeCommand",value:function executeCommand(e,t){var _this10=this;if(!e)return void(t&&t(new Error("command is empty")));if("snapshot"===e)return void this.snapshot(t);var o=this._buildControlUrl(e);if(!o)return void(t&&t(new Error("build control url error")));var i=this._buildPostData(e),n={user:this._options.username,password:this._options.password};this._doRequest(o,n,i,function(o,i){var n=500;"left"!==e&&"right"!==e||(n=800),"XS100"===_this10._camInfo.id||"telefunken.XS100"===_this10._camInfo.link?setTimeout(function(){var e=_this10._buildControlUrlRaw("1");_this10._doRequest(e,_this10._options,null,null);},n):_this10._camInfo.stop&&setTimeout(function(){var e=_this10._buildControlUrlRaw(_this10._camInfo.stop);_this10._doRequest(e,_this10._options,null,null);},n/2),t&&t(o,i);});}},{key:"getRootUrl",value:function getRootUrl(e){var t="http://",o=this._options.ip;"https://"===o.substr(0,8).toLowerCase()?(t="https://",o=o.substr(8)):"http://"===o.substr(0,7).toLowerCase()&&(o=o.substr(7));var i=this._options.port;var n=o.indexOf(":");return-1!==n&&(i=o.substr(n+1),o=o.substr(0,n)),i||(i="https://"===t?443:80),e&&(e+="@"),t+(e||"")+o+":"+i;}},{key:"_buildControlUrl",value:function _buildControlUrl(e){if(!this._camInfo||!this._camInfo.controlurl)return null;var t=this._getCommandCode(e);if(!t)return null;var o=this._decodeXml(this._camInfo.controlurl);t=this._decodeXml(t);var i=this.getRootUrl()+o.replace("%@",t);return this._addAuth(i,{type:"control"});}},{key:"_buildControlUrlRaw",value:function _buildControlUrlRaw(e){if(!this._camInfo||!this._camInfo.controlurl)return null;if(!e)return null;var t=this._decodeXml(this._camInfo.controlurl);e=this._decodeXml(e);var o=this.getRootUrl()+t.replace("%@",e);return this._addAuth(o,{type:"control"});}},{key:"_buildPostData",value:function _buildPostData(e){if(!this._camInfo||!this._camInfo.controlpostdata)return null;var t=this._getCommandCode(e);return t?(t=this._decodeXml(t),this._camInfo.controlpostdata.replace("%@",t)):null;}},{key:"_getCommandCode",value:function _getCommandCode(e){if(!e||!this._camInfo||!this._camInfo.keys)return null;for(var t=0;t<this._camInfo.keys.length;t++){var o=this._camInfo.keys[t];if(o.id&&o.id==e)return o.code;}return null;}},{key:"_addAuth",value:function _addAuth(e,t){if(!this._camInfo)return e;t=t||{};var o=this._camInfo.auth;if("mjpeg"===t.type&&this._camInfo.auth_mjpeg?o=this._camInfo.auth_mjpeg:"jpeg"===t.type&&this._camInfo.auth_image?o=this._camInfo.auth_image:"control"===t.type&&this._camInfo.auth_cntrl&&(o=this._camInfo.auth_cntrl),!o)return e;var i=encodeURIComponent(this._options.username||"");o=this._decodeXml(o),o=o.replace("@user",i),o=this._options&&"instar"===this._options.manufacturer?o.replace("@pwd",this._options.password||""):o.replace("@pwd",encodeURIComponent(this._options.password||""));var n=e.includes("?")?"&":"?";return e+=n+o;}},{key:"_decodeXml",value:function _decodeXml(e){return e.replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&");}},{key:"_doRequest",value:function _doRequest(e,t,o,i,n){var _this11=this;var s=require("url").parse(e);var r=require("http");"https"===e.substring(0,5).toLowerCase()&&(r=require("https"),s.port||(s.port=443)),s.port||(s.port=80);var a={host:s.hostname,port:s.port,path:s.path,method:"GET",headers:{"Content-Type":'text/xml; charset="utf-8"',Connection:"close"}};n?a.headers.Authorization=n:t.user&&(t.password=t.password||"",a.user=t.user,a.password=t.password,a.headers.Authorization="Basic "+new Buffer(t.user+":"+t.password).toString("base64")),o&&(a.method="POST",a.headers["Content-Length"]=o.length);var l=r.request(a,function(s){s.setEncoding("utf-8");var r="";s.on("data",function(e){r+=e;}),s.on("end",function(){var l=null;if(XC.debugf("response: "+s.statusCode),401==s.statusCode&&!n&&s.headers&&s.headers["www-authenticate"]&&s.headers["www-authenticate"].startsWith("Digest ")){var _n=require("x.crypt.js").DigestAuth(s.headers["www-authenticate"],a.path,t.user,t.password,a.method);if(_n)return _n+=', opaque=""',XC.debugf("do digest auth: "+_n),void _this11._doRequest(e,t,o,i,_n);l=new Error("http response: "+s.statusCode);}else 200!=s.statusCode&&(l=new Error("http response: "+s.statusCode));i&&i(l,r);});});"function"==typeof l.on&&l.on("error",function(e){i&&i(e);}),o&&l.write(o),l.end();}},{key:"snapshot",value:function snapshot(e){this.getVideoInfo(function(t,o){if(t)return void(e&&e(t));var i={user:o.username,password:o.password};if(o.jpeg||o.jpegPath||o.jpegPage){new xnm.aio.cams.JPEGCam(o.jpeg,i,o.jpegPath,o.jpegPage).loadImage2Tmp(function(t){t?e&&e(null,t):e&&e(new Error("load image error"));});}else if(o.mjpeg){new xnm.aio.cams.MJPEGCam(o.mjpeg,i).loadImage2Tmp(function(t){t?e&&e(null,t):e&&e(new Error("load image error"));});}else e&&e(new Error("snapshots are not supported for this camera"));});}},{key:"equalsTo",value:function equalsTo(e){return!!e&&e instanceof Cam&&!(!this._options||!e._options)&&this._options.ip==e._options.ip&&this._options.port==e._options.port&&this._options.username==e._options.username&&this._options.password==e._options.password&&this._options.type==e._options.type&&this._options.model==e._options.model;}}]);return Cam;}(),xnm.aio.cams.DoorBird=function(){var e=/*#__PURE__*/function(_xnm$aio$cams$Cam){_inherits(DoorBird,_xnm$aio$cams$Cam);var _super=_createSuper(DoorBird);function DoorBird(e,t){var _this12;_classCallCheck(this,DoorBird);_this12=_super.call(this,e,t),_this12._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.["+e.username+"@"+e.ip+"]");return _this12;}_createClass(DoorBird,[{key:"getRefId",value:function getRefId(){return this._options.username+":"+this._options.password+"@"+this._options.ip+":"+this._options.port;}},{key:"executeCommandCreator",value:function executeCommandCreator(e,t,o){this.executeCommand(t,o);}},{key:"getStatesCreator",value:function getStatesCreator(e,t,o){this.getStates(function(e,i){var n=[];if(!e&&i)for(var _e8=0;_e8<t.length;_e8++){var _o2=t[_e8];if(!_o2||!_o2.id)continue;var s="?";if(_o2.status&&_o2.status.value){var _e9=_o2.status.value;null!=i[_e9]&&void 0!==i[_e9]&&(s=i[_e9],n.push({id:_o2.id,status:s}));}}o&&o(null,n);});}},{key:"executeCommand",value:function executeCommand(e,t){if(e&&e.value){if("open_app"==e.value||"open_live"==e.value){if(window.XC&&window.XC.callHost&&window.XCHost&&window.XCHost.getType&&("iOS"===window.XCHost.getType()||"Android"===window.XCHost.getType()))if("open_app"===e.value)window.XC.callHost("SYSTEM","startApp",{scheme:"doorbird://"});else{var _e10=this._options.username.substr(0,6);window.XC.callHost("SYSTEM","startApp",{scheme:"doorbird://live/"+_e10});}t&&t();}else if("open_door"===e.value||"open_relay"===e.value||"open_relay_custom"===e.value){var o=e.ext;this.openDoor(o,t);}else"light_on"===e.value?this.lightOn(t):t&&t(new Error("command unknown"));}else t&&t(new Error("command invalid"));}},{key:"getStates",value:function getStates(e){var _this13=this;this._logger.log("debug","get states");var t=require("xnm.aio.cams.js").getDoorBirdHandler();var o=t.getMonitor(this._options);o||(this._logger.log("trace","add monitor"),t._udpMonitor.isRunning()||t.startUdpMonitor(),o=t.addMonitor(this._options));var i={ring:!1,motion:!1,ringT:null,ringTStr:null,motionT:null,motionTStr:null},n=o._stateBuffer;if(n){this._logger.log("debug","buffered states in monitor: "+JSON.stringify(n));var _e11=new Date().getTime();for(var _t2 in n){var _o3=n[_t2];_o3&&_o3.length&&("motion"===_t2?1==_o3[0]&&_e11-_o3[1]<=1e4&&(i.motion=!0):"ring"===_t2?1==_o3[0]&&_e11-_o3[1]<=1e4&&(i.ring=!0):"ringT"===_t2?(i.ringT=_o3[0],i.ringTStr=new Date(_o3[0]).toLocaleString()):"motionT"===_t2&&(i.motionT=_o3[0],i.motionTStr=new Date(_o3[0]).toLocaleString()));}}if(i.ringT)return this._logger.log("debug","return states: "+JSON.stringify(i)),void(e&&e(null,i));this.getHistory("doorbell",1,function(t,o,s){null!=o&&(i.ringT=1e3*o,i.ringTStr=new Date(i.ringT).toLocaleString(),n.ringT=[i.ringT]),_this13._logger.log("debug","return states: "+JSON.stringify(i)),e&&e(null,i);});}},{key:"getInfo",value:function getInfo(e){this._doRequest("/bha-api/info.cgi",function(t,o){if(t)e&&e(t);else try{var _t3=JSON.parse(o);if(!(_t3&&_t3.BHA&&_t3.BHA.VERSION&&_t3.BHA.VERSION.length&&1==_t3.BHA.RETURNCODE))return void(e&&e(new Error("info response invaild")));e&&e(null,_t3.BHA.VERSION[0]);}catch(t){e&&e(t);}});}},{key:"openDoor",value:function openDoor(e,t){var _this14=this;this._logger.log("debug","open door (relay="+e+")");var o="/bha-api/open-door.cgi";e&&(o+="?r="+encodeURIComponent(e)),this._doRequest(o,function(o,i){_this14._logger.log("debug","open door (relay="+e+")"+(o?" failed: "+o.message:" success")),t&&t(o);});}},{key:"lightOn",value:function lightOn(e){var _this15=this;this._logger.log("debug","light on");this._doRequest("/bha-api/light-on.cgi",function(t,o){_this15._logger.log("debug","light on"+(t?" failed: "+t.message:" success")),e&&e(t);});}},{key:"loadHistoryImage",value:function loadHistoryImage(e,t,o){var _this16=this;this._logger.log("trace","load image "+t+"@"+e);var i="http://"+this._options.ip+":"+(this._options.port||80)+"/bha-api/history.cgi?index="+t+"&event="+e;this._logger.log("trace","load image: "+i);var n={user:this._options.username,password:this._options.password};require("xnm.aio.cams.js").createJPEGCam(i,n).loadImage(function(i,n){_this16._logger.log("trace","load image "+t+"@"+e+" finish: file="+i),o&&o(i,n);});}},{key:"getHistory",value:function getHistory(e,t,o){var _this17=this;this._logger.log("trace","get history "+t+"@"+e);var i="/bha-api/history.cgi?index="+t+"&event="+e;this._doRequest(i,function(i,n,s){if(i)return _this17._logger.log("trace","get history "+t+"@"+e+" failed:"+i.message),void(o&&o(i));_this17._logger.log("trace","get history "+t+"@"+e+" headers:"+(s?JSON.stringify(s):"none"));var r=null,a=null;s&&(null!=s["x-count"]&&null!=s["x-count"]&&(r=parseInt(s["x-count"])),null!=s["x-timestamp"]&&null!=s["x-timestamp"]&&(a=parseInt(s["x-timestamp"]))),o&&o(null,a,r);});}},{key:"_doRequest",value:function _doRequest(e,t){var o=this._options.ip,i=this._options.port||80,n="http://"+o+":"+i+e;this._logger.log("trace","send to url:"+n);var s={host:o,port:i,path:e,method:"GET",headers:{Connection:"close"}};this._options.username&&(this._options.password||(this._options.password=""),s.headers.Authorization="Basic "+new Buffer(this._options.username+":"+this._options.password).toString("base64"));var r=require("http").request(s,function(e){e.setEncoding("utf-8");var o="";e.on("data",function(e){o+=e;}),e.on("end",function(){var i=null;200!=e.statusCode&&(i=new Error("http response: "+e.statusCode)),t&&t(i,o,e.headers);});});"function"==typeof r.setTimeout&&r.setTimeout(2e3,function(){r.abort();}),"function"==typeof r.on&&r.on("error",function(e){t&&t(e);}),r.end();}}]);return DoorBird;}(xnm.aio.cams.Cam);return e.Handler=/*#__PURE__*/function(){function Handler(){_classCallCheck(this,Handler);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Handler"),this._udpMonitor=new(/*#__PURE__*/function(){function UdpMonitor(e){_classCallCheck(this,UdpMonitor);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Handler.UdpMonitor"),this._sockets=[],this._port=35344,this._running=!1,this._listener=e;}_createClass(UdpMonitor,[{key:"start",value:function start(){this._running||(this._running=!0,this._addDiscoverSocket(this._port,null));}},{key:"isRunning",value:function isRunning(){return this._running;}},{key:"_addDiscoverSocket",value:function _addDiscoverSocket(e,t){var _this18=this;var o=require("dgram");var i=null;if(this._logger.log("trace","bind udp monitor on port "+e+(t?" ip "+t.address:"")),t){if("IPv4"===t.family&&0==t.internal){try{i=o.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){i=o.createSocket("udp4");}i.on("listening",function(){i.setBroadcast(!0);}),i.on("message",function(e,t){_this18._receivedData(t.address,e);}),i.on("error",function(e){_this18._logger.log("trace","bind udp monitor error "+e.message);}),i.bind(e,t.address),this._sockets.push(i);}}else{try{i=o.createSocket({reuseAddr:!0,type:"udp4"});}catch(e){i=o.createSocket("udp4");}i.on("message",function(e,t){_this18._receivedData(t.address,e);}),i.on("error",function(e){_this18._logger.log("trace","bind udp monitor error "+e.message);}),i.bind(e),this._sockets.push(i);}}},{key:"_receivedData",value:function _receivedData(e,t){t=t.toString("hex"),this._logger.log("trace","receive data from "+e+" data "+t),this._listener&&this._listener.onUdpData&&this._listener.onUdpData(e,t);}}]);return UdpMonitor;}())(this),this._monitors={};}_createClass(Handler,[{key:"finalize",value:function finalize(){for(var _e12 in this._monitors){var t=this._monitors[_e12];t&&t.stop();}this._monitors={};}},{key:"startUdpMonitor",value:function startUdpMonitor(){this._udpMonitor.start();}},{key:"addMonitor",value:function addMonitor(e){if(!e)return;var t=e.username+":"+e.password+"@"+e.ip;var o=this._monitors[t];if(o)throw new Error("monitor already exists");return o=new(/*#__PURE__*/function(){function Monitor(e){_classCallCheck(this,Monitor);var t=e.username+"@"+e.ip;this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Monitor.["+t+"]"),this._useHttpMonitor=this._supportHttpMonitor(),this._doorbirdJSON=e,this._httpMonitor=new(/*#__PURE__*/function(){function HttpMonitor(e,t){_classCallCheck(this,HttpMonitor);var o=this._gentId(e);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.HttpMonitor.["+o+"]"),this._listener=t,this._doorbird=e,this._running=!1,this._req=null,this._reconnectTO=null,this.reconnTimeout=5,this.dataTimeout=30,this._dataTO=null;}_createClass(HttpMonitor,[{key:"_gentId",value:function _gentId(e){return e.username+"@"+e.ip;}},{key:"start",value:function start(){this._logger.log("debug","start monitor"),this._running||(this._running=!0,this._startHttpMonitor());}},{key:"stop",value:function stop(e){this._logger.log("debug","stop monitor"),this._running?(this._running=!1,this._stopHttpMonitor(),e&&e(null,!0)):e&&e(null,!0);}},{key:"updateIP",value:function updateIP(e){this._stopHttpMonitor(),this._doorbird.ip=e;var t=this._gentId(this._doorbird);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.HttpMonitor.["+t+"]"),this._startHttpMonitor();}},{key:"_startHttpMonitor",value:function _startHttpMonitor(){var _this19=this;this._logger.log("debug","start http monitor");var e=this._doorbird.ip;var t=this._doorbird.port;var o=e.indexOf(":");-1===o||t||(t=e.substr(o+1)),t||(t=80);var i="/bha-api/monitor.cgi?ring=doorbell,motionsensor",n="http://"+e+":"+t+i;this._logger.log("trace","send to url: "+n);var s={host:e,port:t,path:i,method:"GET",headers:{}},r=this._doorbird.username,a=this._doorbird.password;r&&(s.auth=r+":"+(a||""));var l=!1,d=!1;var c=require("http").request(s,function(t){t.setEncoding("utf-8"),t.on("data",function(t){l=!0,_this19._dataTO&&(clearTimeout(_this19._dataTO),_this19._dataTO=null),_this19._dataTO=setTimeout(function(){_this19._logger.log("warn","monitor data timeout: "+e),c.abort(),d||(d=!0,_this19._onClose(new Error("data timeout")));},1e3*_this19.dataTimeout),_this19._onData(t);}),t.on("end",function(){var e=null;509==t.statusCode?e=new Error("door bird busy"):200!=t.statusCode&&(e=new Error("door bird monitor reutrn http: "+t.statusCode)),d||(d=!0,_this19._onClose(e));});});c.setTimeout(2e3,function(){l||(c.abort(),d||(d=!0,_this19._onClose(new Error("connection timeout"))));}),c.on("error",function(e){d||(d=!0,_this19._onClose(e));}),c.end(),this._req=c;}},{key:"_stopHttpMonitor",value:function _stopHttpMonitor(){this._logger.log("debug","stop http monitor"),this._dataTO&&(clearTimeout(this._dataTO),this._dataTO=null),this._req&&this._req.abort();}},{key:"_reconnect",value:function _reconnect(){var _this20=this;this._logger.log("trace","reconnect monitor in "+this.reconnTimeout+" s"),this._reconnectTO&&(clearTimeout(this._reconnectTO),this._reconnectTO=null),this._reconnectTO=setTimeout(function(){_this20._startHttpMonitor();},1e3*this.reconnTimeout);}},{key:"_onData",value:function _onData(e){this._listener&&this._listener.onHttpData&&this._listener.onHttpData(e);}},{key:"_onClose",value:function _onClose(e){this._logger.log("debug","http monitor closed: "+(e?" err: "+e.message:"")),this._dataTO&&(clearTimeout(this._dataTO),this._dataTO=null),this._running&&this._reconnect();}}]);return HttpMonitor;}())(e,this),this._listeners=[],this._stateBuffer={};}_createClass(Monitor,[{key:"_supportHttpMonitor",value:function _supportHttpMonitor(){var e=null;return"undefined"!=typeof window&&(window.XCHost?window.XCHost&&window.XCHost.getType&&(e=window.XCHost.getType()):e="node-webkit"),"undefined"!=typeof nw||"node-webkit"==e||"undefined"!=typeof process&&null!=process&&"node"==process.title;}},{key:"getRefId",value:function getRefId(){return this._doorbirdJSON.username+":"+this._doorbirdJSON.password+"@"+this._doorbirdJSON.ip+":"+this._doorbirdJSON.port;}},{key:"addListener",value:function addListener(e){e&&-1===this._listeners.indexOf(e)&&this._listeners.push(e);}},{key:"removeListener",value:function removeListener(e){var t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1);}},{key:"start",value:function start(){this._logger.log("debug","start monitor"),this._running||(this._running=!0,this._useHttpMonitor&&this._httpMonitor.start());}},{key:"stop",value:function stop(){this._logger.log("debug","stop monitor"),this._running&&(this._running=!1,this._listeners=[],this._useHttpMonitor&&this._httpMonitor.stop());}},{key:"updateDoorbird",value:function updateDoorbird(e){if(this._doorbirdJSON&&this._doorbirdJSON.mac&&this._doorbirdJSON.mac==e.mac&&this._doorbirdJSON.ip!=e.ip){var _t4=this._doorbirdJSON.username+"@"+e.ip;this._logger.log("debug","doorbird has new ip: "+e.ip),this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Monitor.["+_t4+"]"),this._useHttpMonitor&&this._httpMonitor.updateIP(e.ip);}}},{key:"onHttpData",value:function onHttpData(e){this._logger.log("trace","receive notify: "+e.replace(/(\r\n|\n|\r)/gm,"\\n "));var t=e.indexOf("doorbell:"),o=!1,i=!1;-1!==t&&(o=e.substr(t+9,1),o="H"===o),t=e.indexOf("motionsensor:"),-1!==t&&(i=e.substr(t+13,1),i="H"===i),this._logger.log("debug","receive http event: ring="+o+" motion="+i),i&&this._onEvent("motion",i),o&&this._onEvent("ring",o);}},{key:"onUdpData",value:function onUdpData(e,t){var _this21=this;this._logger.log("trace","decrypt UDP data");var o=this._doorbirdJSON;if(!o||!o.password)return this._logger.log("trace","decrypt data failed: no password"),void(t&&t(new Error("no password")));var i=this._getDecrypter();if(!i)return this._logger.log("trace","decrypt data failed: cannot find decrypter"),void(t&&t(new Error("cannot find decrypter")));i.decrypt(e,o.password,function(e,o){_this21._logger.log("trace","decrypt data "+(e?"failed: "+e.message:"success")),!e&&o&&(_this21._logger.log("debug","receive udp event: "+JSON.stringify(o)),"motionsensor"===o.event||"motion"===o.event?_this21._onEvent("motion",!0):isNaN(parseInt(o.event))||_this21._onEvent("ring",!0)),t&&t(e,o);});}},{key:"_onEvent",value:function _onEvent(e,t){var o=new Date().getTime();this._stateBuffer[e]=[t,o],"ring"===e&&1==t?this._stateBuffer.ringT=[o]:"motion"===e&&1==t&&(this._stateBuffer.motionT=[o]);for(var _o4=0;_o4<this._listeners.length;_o4++){var i=this._listeners[_o4];if(i.onEvent)try{i.onEvent(e,t);}catch(e){}}}},{key:"_getDecrypter",value:function _getDecrypter(){var e=null;return"undefined"!=typeof window&&(window.XCHost||(e="node-webkit"),window.XCHost&&window.XCHost.getType&&(e=window.XCHost.getType())),"undefined"!=typeof nw?new(/*#__PURE__*/function(){function NWJSDecrypter(){_classCallCheck(this,NWJSDecrypter);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Handler.NWJSDecrypter");}_createClass(NWJSDecrypter,[{key:"decrypt",value:function decrypt(e,t,o){var _this22=this;this._logger.log("trace","decrypt data: "+e);var i=parseInt(e.substr(8,8),16),n=parseInt(e.substr(16,8),16),s=new Buffer(e.substr(24,32),"hex"),r=new Buffer(e.substr(56,16),"hex"),a=new Buffer(e.substr(72),"hex");t=new Buffer(t.substr(0,5),"utf8");var l=new Buffer(32),d=require("libsodium-wrappers");d.ready["catch"](function(e){o&&o(e);}),d.ready.then(function(){var e=null;try{var _o5=d.crypto_pwhash(l.length,d.from_string(t.toString("utf8")),s,i,n,d.crypto_pwhash_ALG_ARGON2I13);e=d.crypto_aead_chacha20poly1305_decrypt(null,a,null,r,_o5);}catch(e){return void(o&&o(e));}var c={intercom_id:Buffer.from(e.slice(0,6)).toString("utf8"),event:Buffer.from(e.slice(6,14)).toString("utf8").trim(),timestamp:Buffer.from(e.slice(14,18)).readInt32BE()};_this22._logger.log("trace","(libsodium-wrappers) decrypt result: "+JSON.stringify(c)),o&&o(null,c);});}}]);return NWJSDecrypter;}())():"node-webkit"===e||"undefined"!=typeof process&&null!=process&&"node"===process.title?new(/*#__PURE__*/function(){function NodeJSDecrypter(){_classCallCheck(this,NodeJSDecrypter);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Handler.NodeJSDecrypter");}_createClass(NodeJSDecrypter,[{key:"decrypt",value:function decrypt(e,t,o){this._logger.log("trace","decrypt data: "+e.substr(0,10)+"...");var i=parseInt(e.substr(8,8),16),n=parseInt(e.substr(16,8),16),s=new Buffer(e.substr(24,32),"hex"),r=new Buffer(e.substr(56,16),"hex"),a=new Buffer(e.substr(72),"hex");t=new Buffer(t.substr(0,5),"utf8");var l=new Buffer(32),d=require("sodium").api;if(!d.crypto_pwhash_argon2i(l,t,s,i,n,1))return void(o&&o(new Error("password hash failed")));var c=d.crypto_aead_chacha20poly1305_decrypt(a,null,r,l);if(!c)return void(o&&o(new Error("decrypt failed")));var p={intercom_id:c.slice(0,6).toString("utf8"),event:c.slice(6,14).toString("utf8").trim(),timestamp:c.slice(14,18).readInt32BE()};this._logger.log("trace","decrypt result: "+JSON.stringify(p)),o&&o(null,p);}}]);return NodeJSDecrypter;}())():new(/*#__PURE__*/function(){function NativeDecrypter(){_classCallCheck(this,NativeDecrypter);this._logger=require("x.logger.js").getLogger("xnm.aio.cams.DoorBird.Handler.NativeDecrypter");}_createClass(NativeDecrypter,[{key:"decrypt",value:function decrypt(e,t,o){var _this23=this;this._logger.log("trace","decrypt data: "+e);var i=t.substr(0,5);XC.callHost("doorbird","decryptUdpMessage",{data:e,password:i},function(e){_this23._logger.log("trace","decrypt result: "+JSON.stringify(e)),e?e.error?o&&o(new Error(e.error)):o&&o(null,e):o&&o(new Error("no reponse from xc doorbird module"));});}}]);return NativeDecrypter;}())();}}]);return Monitor;}())(JSON.parse(JSON.stringify(e))),this._monitors[t]=o,o.start(),o;}},{key:"removeMonitor",value:function removeMonitor(e){if(!e)return;var t=e.username+":"+e.password+"@"+e.ip,o=this._monitors[t];o&&(o.stop(),delete this._monitors[t]);}},{key:"getMonitor",value:function getMonitor(e){if(!e)return null;var t=e.username+":"+e.password+"@"+e.ip;return this._monitors[t];}},{key:"onUdpData",value:function onUdpData(e,t){var _this24=this;if(!t)return;if("DEADBE"!==t.substr(0,6).toUpperCase())return;if("01"!=t.substr(6,2))return;var o=Object.keys(this._monitors);if(!o.length)return;var i=0;var cb=function cb(){i++,i<o.length&&_this24._monitors[o[i]].onUdpData(t,cb);};this._monitors[o[i]].onUdpData(t,cb);}}]);return Handler;}(),e;}(),xnm.aio.cams.Foscam=/*#__PURE__*/function(_xnm$aio$cams$Cam2){_inherits(Foscam,_xnm$aio$cams$Cam2);var _super2=_createSuper(Foscam);function Foscam(e,t){var _this25;_classCallCheck(this,Foscam);_this25=_super2.call(this,e,t),_this25._logger=require("x.logger.js").getLogger("xnm.aio.cams.Foscam");return _this25;}_createClass(Foscam,[{key:"executeCommandCreator",value:function executeCommandCreator(e,t,o){t?"gotoPreset"===t.value?this._gotoPreset(e,t,o):this.executeCommand(t.value,o):o&&o(new Error("command invalid"));}},{key:"_gotoPreset",value:function _gotoPreset(e,t,o){if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("command ext invalid")));if(!this._camInfo||!this._camInfo.controlurl)return void(o&&o(new Error("no control url")));var i=null;var n=this._decodeXml(this._camInfo.controlurl);if("/cgi-bin/CGIProxy.fcgi?cmd=%@"==n?i="ptzGotoPresetPoint&name="+encodeURIComponent(t.ext):"/web/cgi-bin/hi3510/%@"==n&&(i="preset.cgi?-act=goto&-number="+encodeURIComponent(t.ext)),!i)return void(o&&o(new Error("unknow preset command")));var s=this.getRootUrl()+n.replace("%@",i);s=this._addAuth(s);var r={user:this._options.username,password:this._options.password};this._doRequest(s,r,null,function(e,t){o&&o(e,t);});}}]);return Foscam;}(xnm.aio.cams.Cam),xnm.aio.cams.Welcome=/*#__PURE__*/function(_xnm$aio$cams$Cam3){_inherits(Welcome,_xnm$aio$cams$Cam3);var _super3=_createSuper(Welcome);function Welcome(e,t){var _this26;_classCallCheck(this,Welcome);_this26=_super3.call(this,e,t),_this26._logger=require("x.logger.js").getLogger("xnm.aio.cams.Welcome");return _this26;}_createClass(Welcome,[{key:"getVideoInfo",value:function getVideoInfo(e){var t=require("xnm.aio.netatmo.js");if(!t)return void(e&&e(new Error("netatmo module not loaded")));var o=t.resolveGateway({refreshToken:this._options.refreshToken});o?o.getCamUrl(this._options.address,function(t,o){t?e&&e(t):e&&e(null,{hls:o});}):e&&e(new Error("netatmo cam info invalid"));}}]);return Welcome;}(xnm.aio.cams.Cam),xnm.aio.cams.Mobotix=/*#__PURE__*/function(_xnm$aio$cams$Cam4){_inherits(Mobotix,_xnm$aio$cams$Cam4);var _super4=_createSuper(Mobotix);function Mobotix(e,t){var _this27;_classCallCheck(this,Mobotix);_this27=_super4.call(this,e,t),_this27._logger=require("x.logger.js").getLogger("xnm.aio.cams.Mobotix");return _this27;}_createClass(Mobotix,[{key:"executeCommandCreator",value:function executeCommandCreator(e,t,o){if(t){if("gotoPreset"===t.value||"displayMode"===t.value||"customCMD"===t.value){if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("command ext invalid")));var _e13=null;if("gotoPreset"===t.value){if(!this._camInfo||!this._camInfo.controlurl)return void(o&&o(new Error("no control url")));var i="loadview="+encodeURIComponent(t.ext);_e13=this._decodeXml(this._camInfo.controlurl).replace("%@",i);}else if("displayMode"===t.value){var _o6="/control/control?set&section=general&display_mode=";switch(t.ext){case"Full Image":_e13=_o6+"simple";break;case"Normal":_e13=_o6+"lenscorr_l11";break;case"Surround":_e13=_o6+"surround";break;case"Panorama":_e13=_o6+"panorama";break;case"Panorama/Focus":_e13=_o6+"pano_focus";break;case"Double Panorama":_e13=_o6+"pano_dbl";}}else _e13=t.ext;_e13&&this._sendRequest(_e13,function(e,t){o&&o(e,t);});}else this.executeCommand(t.value,o);}else o&&o(new Error("command invalid"));}},{key:"_gotoPreset",value:function _gotoPreset(e,t,o){if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("command ext invalid")));if(!this._camInfo||!this._camInfo.controlurl)return void(o&&o(new Error("no control url")));var i="loadview="+encodeURIComponent(t.ext),n=this._decodeXml(this._camInfo.controlurl).replace("%@",i);this._sendRequest(n,function(e,t){o&&o(e,t);});}},{key:"_sendRequest",value:function _sendRequest(e,t){var o=this.getRootUrl()+e;o=this._addAuth(o);var i={user:this._options.username,password:this._options.password};this._doRequest(o,i,null,function(e,o){t&&t(e,o);});}}]);return Mobotix;}(xnm.aio.cams.Cam),xnm.aio.cams.Axis=/*#__PURE__*/function(_xnm$aio$cams$Cam5){_inherits(Axis,_xnm$aio$cams$Cam5);var _super5=_createSuper(Axis);function Axis(e,t){var _this28;_classCallCheck(this,Axis);_this28=_super5.call(this,e,t),_this28._logger=require("x.logger.js").getLogger("xnm.aio.cams.Mobotix");return _this28;}_createClass(Axis,[{key:"executeCommandCreator",value:function executeCommandCreator(e,t,o){t?"playClip"===t.value?this._playClip(e,t,o):"lightOn"===t.value||"lightOff"===t.value?this._setLight(e,t,o):"actOut"===t.value||"deactOut"===t.value?this._setOutput(e,t,o):this.executeCommand(t.value,o):o&&o(new Error("command invalid"));}},{key:"_playClip",value:function _playClip(e,t,o){if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("command ext invalid")));var i="/axis-cgi/playclip.cgi?clip="+t.ext;var n=this.getRootUrl()+i;n=this._addAuth(n);var s={user:this._options.username,password:this._options.password};this._doRequest(n,s,null,function(e,t){o&&o(e,t);});}},{key:"_setOutput",value:function _setOutput(e,t,o){if(void 0===t.ext||null==t.ext)return void(o&&o(new Error("command ext invalid")));var i=t.ext;var n="\\";"actOut"===t.value&&(n="/");var s="/axis-cgi/io/port.cgi?action="+encodeURIComponent(i+":"+n);var r=this.getRootUrl()+s;r=this._addAuth(r);var a={user:this._options.username,password:this._options.password};this._doRequest(r,a,null,function(e,t){o&&o(e,t);});}},{key:"_setLight",value:function _setLight(e,t,o){if(!t.value)return void(o&&o(new Error("command ext invalid")));var i="/axis-cgi/io/lightcontrol.cgi?action=L1:-"+("lightOn"===t.value?"100":"0");var n=this.getRootUrl()+i;n=this._addAuth(n);var s={user:this._options.username,password:this._options.password};this._doRequest(n,s,null,function(e,t){o&&o(e,t);});}}]);return Axis;}(xnm.aio.cams.Cam),xnm.aio.cams.CAM_INFO={telefunken:{name:"Telefunken",versions:[{id:"XS100",name:"XS100",imageurl:"/snapshot.cgi",mjpegurl:"/videostream.cgi",controlurl:"/decoder_control.cgi?command=%@&amp;onestep=1",auth:"user=@user&amp;pwd=@pwd",pantilt:"true",link:"telefunken.XS100",keys:[{id:"left",code:"4&amp;degree=18"},{id:"right",code:"6&amp;degree=18"},{id:"up",code:"0&amp;degree=15"},{id:"down",code:"2&amp;degree=15"},{id:"switchOn",code:"94"},{id:"switchOff",code:"95"}]}]},konine:{name:"Konine",versions:[{id:"konine",name:"Konine IP Cam",imageurl:"/snapshot.cgi",mjpegurl:"/videostream.cgi",controlurl:"/decoder_control.cgi?command=%@",auth:"user=@user&amp;pwd=@pwd",pantilt:"true",link:"konine.konine",keys:[{id:"left",code:"4&amp;onestep=1"},{id:"right",code:"6&amp;onestep=1"},{id:"up",code:"0&amp;onestep=1"},{id:"down",code:"2&amp;onestep=1"},{id:"switchOn",code:"94&amp;onestep=1"},{id:"switchOff",code:"95&amp;onestep=1"},{id:"call1",code:"31&amp;onestep=0"},{id:"call2",code:"33&amp;onestep=0"},{id:"call3",code:"35&amp;onestep=0"},{id:"call4",code:"37&amp;onestep=0"},{id:"call5",code:"39&amp;onestep=0"},{id:"call6",code:"41&amp;onestep=0"},{id:"call7",code:"43&amp;onestep=0"},{id:"call8",code:"45&amp;onestep=0"},{id:"call9",code:"47&amp;onestep=0"},{id:"call10",code:"49&amp;onestep=0"},{id:"call11",code:"51&amp;onestep=0"},{id:"call12",code:"53&amp;onestep=0"},{id:"call13",code:"55&amp;onestep=0"},{id:"call14",code:"57&amp;onestep=0"},{id:"call15",code:"59&amp;onestep=0"},{id:"call16",code:"61&amp;onestep=0"}]}]},abus:{name:"ABUS",versions:[{id:"tv7204",name:"TV7204",pantilt:"false",link:"dlink.2000"}]},"7links":{name:"7Links",versions:[{id:"PX3615675",name:"PX-3615-675",link:"telefunken.XS100",pantilt:"true"},{id:"robocam1",name:"Robocam 1",imageurl:"/IMAGE.JPG",controlurl:"/PANTILTCONTROL.CGI",controlpostdata:"PanSingleMoveDegree=1&amp;TiltSingleMoveDegree=1&amp;PanTiltSingleMove=%@",pantilt:"true",link:"7links.robocam1",keys:[{id:"left",code:"3"},{id:"right",code:"2"},{id:"up",code:"1"},{id:"down",code:"7"},{id:"home",code:"4"}]},{id:"robocam2",name:"Robocam 2",imageurl:"/cgi/jpg/image.cgi",controlurl:"/users/ptctl.cgi?move=%@",pantilt:"true",link:"7links.robocam2",keys:[{id:"left",code:"left"},{id:"right",code:"right"},{id:"up",code:"up"},{id:"down",code:"down"},{id:"home",code:"h"}]},{id:"730hd",name:"IPC-730HD",imageurl:"/cgi-bin/CGIProxy.fcgi?cmd=snapPicture2",auth:"usr=@user&amp;pwd=@pwd",pantilt:"false",link:"7links.730hd"},{id:"730hd2",name:"IPC-730HD 2",imagepageurl:"/cgi-bin/CGIProxy.fcgi?cmd=snapPicture2",auth:"usr=@user&amp;pwd=@pwd",pantilt:"false",link:"7links.730hd2"},{id:"770hd",name:"IPC-770HD",imageurl:"/cgi-bin/video_snapshot.cgi",mjpegurl:"/cgi-bin/videostream.cgi",controlurl:"/cgi-bin/decoder_control.cgi?type=0&amp;cmd=%@&amp;onestep=1",auth:"user=@user&amp;pwd=@pwd",link:"7links.770hd",pantilt:"true",keys:[{id:"left",code:"2"},{id:"right",code:"3"},{id:"up",code:"0"},{id:"down",code:"1"}]},{id:"vga",name:"Generic Type",link:"telefunken.XS100",pantilt:"true"},{id:"hd",name:"Generic Type HD",link:"7links.770hd",pantilt:"true"}]},dlink:{name:"D-Link",versions:[{id:"dcs930",name:"DCS-930L",imageurl:"/image.jpg",mjpegurl:"/video.cgi",useurlauth:"true",link:"dlink.dcs930"},{id:"dcs942",name:"DCS-942L",imageurl:"/image/jpeg.cgi",mjpegurl:"/video/mjpg.cgi",useurlauth:"true",link:"dlink.dcs942"},{id:"2000",name:"DCS-2000",imageurl:"/cgi-bin/video.jpg?size=2",controlurl:"/cgi-bin/camctrl.cgi?%@",pantilt:"true",link:"dlink.2000",keys:[{id:"home",code:"move=home"},{id:"left",code:"move=left"},{id:"right",code:"move=right"},{id:"up",code:"move=up"},{id:"down",code:"move=down"},{id:"tele",code:"zoom=tele"},{id:"wide",code:"zoom=wide"}]},{id:"dcs2132",name:"DCS-2132L",imageurl:"/dms?nowprofileid=2",useurlauth:"true",link:"dlink.dcs2132"},{id:"dcs935",name:"DCS-935L",link:"dlink.dcs942",pantilt:"false"},{id:"dcs5222",name:"DCS-5222L",imageurl:"/image/jpeg.cgi",mjpegurl:"/video/mjpg.cgi",controlurl:"/cgi/ptdc.cgi?%@",pantilt:"true",link:"dlink.dcs5222",keys:[{id:"home",code:"command=go_home"},{id:"left",code:"command=set_relative_pos&posX=-10&posY=0"},{id:"right",code:"command=set_relative_pos&posX=10&posY=0"},{id:"up",code:"command=set_relative_pos&posX=0&posY=10"},{id:"down",code:"command=set_relative_pos&posX=0&posY=-10 "}]}]},hama:{name:"Hama",versions:[{id:"hwlancam",name:"WLAN IP",link:"telefunken.XS100",pantilt:"false"}]},nueva:{name:"Nueva",versions:[{id:"nueva",name:"NVI Camera",link:"telefunken.XS100",pantilt:"true"},{id:"hd",name:"NVI HD Camera",imageurl:"/snapshot.cgi",mjpegurl:"/videostream.cgi",controlurl:"/decoder_control.cgi?command=%@&amp;onestep=1",auth:"loginuse=@user&amp;loginpas=@pwd",pantilt:"true",link:"nueva.hd",keys:[{id:"left",code:"4&amp;degree=18"},{id:"right",code:"6&amp;degree=18"},{id:"up",code:"0&amp;degree=15"},{id:"down",code:"2&amp;degree=15"}]},{id:"hd_new",name:"NVI New HD Camera",link:"nueva.hd_new",imageurl:"/tmpfs/snap.jpg",controlurl:"/cgi-bin/hi3510/%@",auth:"user=@user&amp;pwd=@pwd",pantilt:"true",keys:[{id:"move_left",code:"ptzctrl.cgi?-step=0&amp;-act=left"},{id:"move_right",code:"ptzctrl.cgi?-step=0&amp;-act=right"},{id:"move_up",code:"ptzctrl.cgi?-step=0&amp;-act=up"},{id:"move_down",code:"ptzctrl.cgi?-step=0&amp;-act=down"},{id:"stop",code:"ptzctrl.cgi?-step=0&amp;-act=stop"},{id:"step_left",code:"ptzctrl.cgi?-step=1&amp;-act=left"},{id:"step_right",code:"ptzctrl.cgi?-step=1&amp;-act=right"},{id:"step_up",code:"ptzctrl.cgi?-step=1&amp;-act=up"},{id:"step_down",code:"ptzctrl.cgi?-step=1&amp;-act=down"},{id:"home",code:"ptzctrl.cgi?-step=0&amp;-act=home"},{id:"horizontal_scan",code:"ptzctrl.cgi?-step=0&amp;-act=hscan"},{id:"vertical_scan",code:"ptzctrl.cgi?-step=0&amp;-act=vscan"},{id:"position_0",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=0"},{id:"position_1",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=1"},{id:"position_2",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=2"},{id:"position_3",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=3"},{id:"position_4",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=4"},{id:"position_5",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=5"},{id:"position_6",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=6"},{id:"position_7",code:"preset.cgi?-act=goto&amp;-status=1&amp;-number=7"}]}]},instar:{name:"INSTAR",versions:[{id:"vga",name:"VGA-Serie",imageurl:"/snapshot.cgi",mjpegurl:"/videostream.cgi",controlurl:"/decoder_control.cgi?command=%@",auth:"user=@user&pwd=@pwd",pantilt:"true",link:"instar.vga",keys:[{id:"left",code:"4&onestep=1"},{id:"right",code:"6&onestep=1"},{id:"up",code:"0&onestep=1"},{id:"down",code:"2&onestep=1"},{id:"home",code:"25"}]},{id:"hd",name:"720p-Serie",imageurl:"/tmpfs/snap.jpg",mjpegurl:"/mjpegstream.cgi?-chn=11",controlurl:"/cgi-bin/hi3510/%@",auth_image:"usr=@user&pwd=@pwd",auth_mjpeg:"-usr=@user&-pwd=@pwd",auth_cntrl:"-usr=@user&-pwd=@pwd",pantilt:"true",link:"instar.hd",keys:[{id:"move_left",code:"ptzctrl.cgi?-step=0&-act=left"},{id:"move_right",code:"ptzctrl.cgi?-step=0&-act=right"},{id:"move_up",code:"ptzctrl.cgi?-step=0&-act=up"},{id:"move_down",code:"ptzctrl.cgi?-step=0&-act=down"},{id:"stop",code:"ptzctrl.cgi?-step=0&-act=stop"},{id:"step_left",code:"ptzctrl.cgi?-step=1&-act=left"},{id:"step_right",code:"ptzctrl.cgi?-step=1&-act=right"},{id:"step_up",code:"ptzctrl.cgi?-step=1&-act=up"},{id:"step_down",code:"ptzctrl.cgi?-step=1&-act=down"},{id:"home",code:"ptzctrl.cgi?-step=0&-act=home"},{id:"horizontal_scan",code:"ptzctrl.cgi?-step=0&-act=hscan"},{id:"vertical_scan",code:"ptzctrl.cgi?-step=0&-act=vscan"},{id:"position_0",code:"preset.cgi?-act=goto&-status=1&-number=0"},{id:"position_1",code:"preset.cgi?-act=goto&-status=1&-number=1"},{id:"position_2",code:"preset.cgi?-act=goto&-status=1&-number=2"},{id:"position_3",code:"preset.cgi?-act=goto&-status=1&-number=3"},{id:"position_4",code:"preset.cgi?-act=goto&-status=1&-number=4"},{id:"position_5",code:"preset.cgi?-act=goto&-status=1&-number=5"},{id:"position_6",code:"preset.cgi?-act=goto&-status=1&-number=6"},{id:"position_7",code:"preset.cgi?-act=goto&-status=1&-number=7"}]},{id:"1080p",name:"1080p-Serie",imageurl:"/tmpfs/snap.jpg",mjpegurl:"/mjpegstream.cgi?-chn=11",controlurl:"/%@",auth_image:"usr=@user&pwd=@pwd",auth_mjpeg:"-usr=@user&-pwd=@pwd",auth_cntrl:"-usr=@user&-pwd=@pwd",pantilt:"true",link:"instar.1080p",keys:[{id:"move_left",code:"ptzctrl.cgi?-step=0&-act=left"},{id:"move_right",code:"ptzctrl.cgi?-step=0&-act=right"},{id:"move_up",code:"ptzctrl.cgi?-step=0&-act=up"},{id:"move_down",code:"ptzctrl.cgi?-step=0&-act=down"},{id:"stop",code:"ptzctrl.cgi?-step=0&-act=stop"},{id:"step_left",code:"ptzctrl.cgi?-step=1&-act=left"},{id:"step_right",code:"ptzctrl.cgi?-step=1&-act=right"},{id:"step_up",code:"ptzctrl.cgi?-step=1&-act=up"},{id:"step_down",code:"ptzctrl.cgi?-step=1&-act=down"},{id:"home",code:"ptzctrl.cgi?-step=0&-act=home"},{id:"horizontal_scan",code:"ptzctrl.cgi?-step=0&-act=hscan"},{id:"vertical_scan",code:"ptzctrl.cgi?-step=0&-act=vscan"},{id:"position_0",code:"preset.cgi?-act=goto&-status=1&-number=0"},{id:"position_1",code:"preset.cgi?-act=goto&-status=1&-number=1"},{id:"position_2",code:"preset.cgi?-act=goto&-status=1&-number=2"},{id:"position_3",code:"preset.cgi?-act=goto&-status=1&-number=3"},{id:"position_4",code:"preset.cgi?-act=goto&-status=1&-number=4"},{id:"position_5",code:"preset.cgi?-act=goto&-status=1&-number=5"},{id:"position_6",code:"preset.cgi?-act=goto&-status=1&-number=6"},{id:"position_7",code:"preset.cgi?-act=goto&-status=1&-number=7"}]},{id:"1440p",name:"1440p-Serie",imageurl:"/snap.cgi?chn=11",mjpegurl:"/livestream/11?action=play&media=mjpeg",auth_image:"user=@user&pwd=@pwd",auth_mjpeg:"user=@user&pwd=@pwd",pantilt:"false",link:"instar.1440p"},{id:"IN-2905",name:"IN-2905/IN-2908",link:"instar.vga",pantilt:"false"},{id:"IN-3010",name:"IN-3010/IN-3011",link:"instar.vga",pantilt:"true"},{id:"IN-4010",name:"IN-4010/IN-4011",link:"instar.vga",pantilt:"true"},{id:"IN-5905",name:"IN-5905/IN-5907 HD",link:"instar.hd",pantilt:"false"},{id:"IN-6001",name:"IN-6001 HD",link:"instar.hd",pantilt:"false"},{id:"IN-6012",name:"IN-6012 HD",link:"instar.hd",pantilt:"true"},{id:"IN-6014",name:"IN-6014 HD",link:"instar.hd",pantilt:"true"},{id:"IN-7011",name:"IN-7011 HD",link:"instar.hd",pantilt:"true"},{id:"IN-8001",name:"IN-8001 Full HD",link:"instar.1080p",pantilt:"false"},{id:"IN-8003",name:"IN-8003 Full HD",link:"instar.1080p",pantilt:"false"},{id:"IN-8015",name:"IN-8015 Full HD",link:"instar.1080p",pantilt:"true"},{id:"IN-8401",name:"IN-8401 2K+ WQHD",link:"instar.1440p",pantilt:"false"},{id:"IN-9008",name:"IN-9008 Full HD",link:"instar.1080p",pantilt:"false"},{id:"IN-9010",name:"IN-9010 Full HD",link:"instar.1080p",pantilt:"true"},{id:"IN-9020",name:"IN-9020 Full HD",link:"instar.1080p",pantilt:"true"},{id:"IN-9408",name:"IN-9408 2K+ WQHD",link:"instar.1440p",pantilt:"false"}]},foscam:{name:"Foscam",versions:[{id:"fi8904W",name:"FI8904W",link:"telefunken.XS100",pantilt:"false"},{id:"fi8620",name:"FI8620",imageurl:"/tmpfs/snap.jpg",controlurl:"/web/cgi-bin/hi3510/%@",pantilt:"true",link:"foscam.fi8620",keys:[{id:"left",code:"ytleft.cgi"},{id:"right",code:"ytright.cgi"},{id:"up",code:"ytup.cgi"},{id:"down",code:"ytdown.cgi"}],command:[{type:"int",name:"go to preset",ref:{value:"gotoPreset",ext:"%d"}}]},{id:"fi8602",name:"FI8602",link:"foscam.fi8620",pantilt:"false"},{id:"fi8919W",name:"FI8919W",imageurl:"/snapshot.cgi",mjpegurl:"/videostream.cgi",controlurl:"/decoder_control.cgi?command=%@&amp;onestep=1",auth:"user=@user&amp;pwd=@pwd",pantilt:"true",link:"foscam.fi8919W",keys:[{id:"left",code:"6&amp;degree=18"},{id:"right",code:"4&amp;degree=18"},{id:"up",code:"0&amp;degree=15"},{id:"down",code:"2&amp;degree=15"},{id:"switchOn",code:"94"},{id:"switchOff",code:"95"}]},{id:"fi9826w",name:"FI9826W",pantilt:"true",link:"foscam.fi9900p"},{id:"fi9831w",name:"FI9831W",pantilt:"true",link:"foscam.fi9900p"},{id:"fi9831p",name:"FI9831P V2",imageurl:"/cgi-bin/CGIProxy.fcgi?cmd=snapPicture2",mjpegurl:"/cgi-bin/CGIStream.cgi?cmd=GetMJStream",controlurl:"/cgi-bin/CGIProxy.fcgi?cmd=%@",stop:"ptzStopRun",auth:"usr=@user&amp;pwd=@pwd",pantilt:"true",link:"foscam.fi9831p",keys:[{id:"left",code:"ptzMoveLeft"},{id:"topLeft",code:"ptzMoveTopLeft"},{id:"right",code:"ptzMoveRight"},{id:"topRight",code:"ptzMoveTopRight"},{id:"bottomLeft",code:"ptzMoveBottomLeft"},{id:"bottomRight",code:"ptzMoveBottomRight"},{id:"up",code:"ptzMoveUp"},{id:"down",code:"ptzMoveDown"},{id:"reset",code:"ptzReset"},{id:"zoomIn",code:"zoomIn"},{id:"zoomOut",code:"zoomOut"},{id:"zoomStop",code:"zoomStop"}],command:[{type:"string",name:"go to preset",ref:{value:"gotoPreset",ext:"%s"}}]},{id:"fi9900p",name:"FI9900P",imageurl:"/cgi-bin/CGIProxy.fcgi?cmd=snapPicture2",controlurl:"/cgi-bin/CGIProxy.fcgi?cmd=%@",stop:"ptzStopRun",auth:"usr=@user&amp;pwd=@pwd",pantilt:"false",link:"foscam.fi9900p",keys:[{id:"left",code:"ptzMoveLeft"},{id:"topLeft",code:"ptzMoveTopLeft"},{id:"right",code:"ptzMoveRight"},{id:"topRight",code:"ptzMoveTopRight"},{id:"bottomLeft",code:"ptzMoveBottomLeft"},{id:"bottomRight",code:"ptzMoveBottomRight"},{id:"up",code:"ptzMoveUp"},{id:"down",code:"ptzMoveDown"},{id:"reset",code:"ptzReset"},{id:"zoomIn",code:"zoomIn"},{id:"zoomOut",code:"zoomOut"},{id:"zoomStop",code:"zoomStop"}],command:[{type:"string",name:"go to preset",ref:{value:"gotoPreset",ext:"%s"}}]},{id:"c1",name:"C1",pantilt:"false",link:"foscam.fi9900p"},{id:"c2",name:"C2",pantilt:"false",link:"foscam.fi9900p"},{id:"r2",name:"R2",pantilt:"true",link:"foscam.fi9900p"},{id:"x4",name:"X4",pantilt:"false",link:"foscam.fi9900p"},{id:"x5",name:"X5",pantilt:"true",link:"foscam.fi9900p"},{id:"s41",name:"S41",pantilt:"false",link:"foscam.fi9900p"},{id:"d4z",name:"D4Z",pantilt:"true",link:"foscam.fi9900p"},{id:"vd1",name:"VD1",pantilt:"false",link:"foscam.fi9900p"},{id:"v5ep",name:"V5EP",pantilt:"false",link:"foscam.fi9900p"},{id:"v8ep",name:"V8EP",pantilt:"false",link:"foscam.fi9900p"},{id:"fi86xx",name:"Generic FI86xx Series",pantilt:"true",link:"foscam.fi8620"},{id:"mjpeg",name:"Generic MJPEG Series",pantilt:"true",link:"foscam.fi8919W"},{id:"h264",name:"Generic H.264 Series",pantilt:"true",link:"foscam.fi9900p"}]},edimax:{name:"Edimax",versions:[{id:"3010",name:"IC-3010 Series",imageurl:"/jpg/image.jpg",pantilt:"false",link:"edimax.3010"},{id:"7010",name:"IC-7010 Series",imageurl:"/jpg/image.jpg",mjpegurl:"/mjpg/video.mjpg",controlurl:"/camera-cgi/com/ptz.cgi",controlpostdata:"%@",pantilt:"true",useurlauth:"true",link:"edimax.7010",keys:[{id:"home",code:"move=center"},{id:"left",code:"move=left"},{id:"right",code:"move=right"},{id:"up",code:"move=up"},{id:"down",code:"move=down"},{id:"preset0",code:"gotoserverpresetIndex=0"},{id:"preset1",code:"gotoserverpresetIndex=1"},{id:"preset2",code:"gotoserverpresetIndex=2"},{id:"preset3",code:"gotoserverpresetIndex=3"},{id:"preset4",code:"gotoserverpresetIndex=4"}]},{id:"3030",name:"IC-3030 Series",pantilt:"false",link:"edimax.7010"},{id:"3110",name:"IC-3110 Series",pantilt:"false",link:"edimax.7010"},{id:"3115",name:"IC-3115 Series",pantilt:"false",link:"edimax.7010"},{id:"3116",name:"IC-3116 Series",pantilt:"false",link:"edimax.7010"},{id:"5150w",name:"IC-5150W",pantilt:"false",link:"edimax.7010"},{id:"3140",name:"IC-3140 Series",pantilt:"false",link:"edimax.7010"},{id:"7001",name:"IC-7001 Series",imageurl:"/jpg/image.jpg",mjpegurl:"/mjpg/video.mjpg",controlurl:"/camera-cgi/com/ptz.cgi",controlpostdata:"%@",pantilt:"true",useurlauth:"true",link:"edimax.7001",keys:[{id:"home",code:"move=center"},{id:"left",code:"move=left"},{id:"right",code:"move=right"},{id:"up",code:"move=up"},{id:"down",code:"move=down"},{id:"preset0",code:"gotopresetIndex=0"},{id:"preset1",code:"gotopresetIndex=1"},{id:"preset2",code:"gotopresetIndex=2"},{id:"preset3",code:"gotopresetIndex=3"},{id:"preset4",code:"gotopresetIndex=4"}]},{id:"7100",name:"IC-7100 Series",pantilt:"true",link:"edimax.7010"},{id:"7110",name:"IC-7110 Series",pantilt:"true",link:"edimax.7010"},{id:"7112",name:"IC-7112 Series",pantilt:"true",link:"edimax.7001"},{id:"7112w",name:"IC-7112W",pantilt:"true",link:"edimax.7001"},{id:"7113",name:"IC-7113 Series",pantilt:"true",link:"edimax.7001"},{id:"9110",name:"IC-9110 Series",pantilt:"true",link:"edimax.7010"},{id:"9110w",name:"IC-9110W",pantilt:"false",link:"edimax.7010"},{id:"type1",name:"Generic Type 1 (no PTZ)",pantilt:"false",link:"edimax.3010"},{id:"type2",name:"Generic Type 2 (PTZ)",pantilt:"true",link:"edimax.7001"},{id:"type3",name:"Generic Type 3 (PTZ)",pantilt:"true",link:"edimax.7010"}]},digitus:{name:"DIGITUS",versions:[{id:"plugandview",name:"Plug&View",imagepathurl:"/web/cgi-bin/hi3510/snap.cgi",stop:"ptzstop.cgi",controlurl:"/cgi-bin/hi3510/%@",pantilt:"true",link:"digitus.plugandview",keys:[{id:"left",code:"ptzleft.cgi"},{id:"right",code:"ptzright.cgi"},{id:"up",code:"ptzup.cgi"},{id:"down",code:"ptzdown.cgi"},{id:"home",code:"ptzgotopoint.cgi?&amp;-chn=0&amp;-point=1"}]}]},doorbird:{name:"DoorBird",versions:[{id:"doorbird",name:"DoorBird",imageurl:"/bha-api/video.cgi",mjpegurl:"/bha-api/video.cgi",controlurl:"/bha-api/%@",pantilt:"true",useurlauth:"true",link:"doorbird.doorbird",keys:[{id:"open_door",code:"open-door.cgi"},{id:"light_on",code:"light-on.cgi"}],command:[{type:"string",name:"open relay (custom)",ref:{value:"open_relay_custom",ext:"%s"}}],status:[{type:"enum",name:"door bell ring",ref:{value:"ring",value_t:"door_bell_ring",options:["true","false"]}},{type:"enum",name:"motion detect",ref:{value:"motion",options:["true","false"]}},{type:"int",name:"last ring timestamp",ref:{value:"ringT"}},{type:"string",name:"last ring time",ref:{value:"ringTStr"}}],ipevt:[{type:"enum",name:"door bell ring",ref:{value:"ring",value_t:"door_bell_ring",options:["true"]}},{type:"enum",name:"motion detect",ref:{value:"motion",options:["true"]}}]}]},mobotix:{name:"MOBOTIX",versions:[{id:"general",name:"General Camera",imageurl:"/record/current.jpg",mjpegurl:"/cgi-bin/faststream.jpg?needlength&fps=0",controlurl:"/control/click.cgi?%@",pantilt:"true",link:"mobotix.general",keys:[{id:"up",code:"moverel&x=0&y=50"},{id:"down",code:"moverel&x=0&y=-50"},{id:"left",code:"moverel&x=-50&y=0"},{id:"right",code:"moverel&x=50&y=0"},{id:"center",code:"center"},{id:"zoomIn",code:"zoomrel=-200"},{id:"zoomOut",code:"zoomrel=200"},{id:"1xZoom",code:"zoom=0"}],command:[{type:"int",name:"go to preset",ref:{value:"gotoPreset",ext:"%d",extExtra:"1-127"}},{type:"enum",name:"display mode",ref:{value:"displayMode",ext:"%e",extMeta:["Full Image","Normal","Surround","Panorama","Panorama/Focus","Double Panorama"]}},{type:"string",name:"custom command",ref:{value:"customCMD",ext:"%s"}}]}]},axis:{name:"Axis",versions:[{id:"212",name:"212 PTZ",link:"axis.ptz",pantilt:"true"},{id:"215",name:"215 PTZ",link:"axis.ptz",pantilt:"true"},{id:"m10",name:"M10 Series",link:"axis.general",pantilt:"true"},{id:"m1054",name:"M1054",link:"axis.ptz",pantilt:"true"},{id:"m11",name:"M11 Series",link:"axis.ptz",pantilt:"true"},{id:"m3014",name:"M3014",link:"axis.ptz",pantilt:"true"},{id:"m32",name:"M32 Series",link:"axis.ptz",pantilt:"true"},{id:"m50",name:"M50 Series",link:"axis.ptz",pantilt:"true"},{id:"p1311",name:"P1311",link:"axis.ptz",pantilt:"false"},{id:"p1346",name:"P1346 Series",link:"axis.ptz",pantilt:"true"},{id:"p1347",name:"P1347 Series",link:"axis.ptz",pantilt:"true"},{id:"q1755",name:"Q 1755 Series",link:"axis.ptz",pantilt:"true"},{id:"p33",name:"P33 Series",link:"axis.ptz",pantilt:"true"},{id:"q6034",name:"Q6034",link:"axis.ptz",pantilt:"true"},{id:"ptz",name:"General (PTZ)",imageurl:"/jpg/image.jpg",mjpegurl:"/mjpg/video.mjpg",controlurl:"/axis-cgi/com/ptz.cgi?camera=1&amp;%@",useurlauth:"true",pantilt:"true",link:"axis.ptz",keys:[{id:"home",code:"move=home"},{id:"left",code:"move=left"},{id:"right",code:"move=right"},{id:"up",code:"move=up"},{id:"down",code:"move=down"},{id:"tele",code:"rzoom=1000"},{id:"wide",code:"rzoom=-1000"}],command:[{type:"enum",name:"light on",ref:{value:"lightOn"}},{type:"enum",name:"light off",ref:{value:"lightOff"}},{type:"int",name:"play clip",ref:{value:"playClip",ext:"%d"}},{type:"int",name:"activate output ",ref:{value:"actOut",ext:"%d"}},{type:"int",name:"deactivate output ",ref:{value:"deactOut",ext:"%d"}}]},{id:"general",name:"General",imageurl:"/jpg/image.jpg",mjpegurl:"/mjpg/video.mjpg",controlurl:"/axis-cgi/com/ptz.cgi?camera=1&amp;%@",useurlauth:"true",link:"axis.general",pantilt:"true",command:[{type:"enum",name:"light on",ref:{value:"lightOn"}},{type:"enum",name:"light off",ref:{value:"lightOff"}},{type:"int",name:"play clip",ref:{value:"playClip",ext:"%d"}},{type:"int",name:"activate output ",ref:{value:"actOut",ext:"%d"}},{type:"int",name:"deactivate output ",ref:{value:"deactOut",ext:"%d"}}]}]},generic:{name:"Generic IP Camera",versions:[{id:"type1",name:"Type 1",link:"telefunken.XS100",pantilt:"false"},{id:"type2",name:"Type 2 (PTZ)",link:"telefunken.XS100",pantilt:"true"},{id:"type3",name:"Type 3 (PTZ)",link:"konine.konine",pantilt:"true"},{id:"type4",name:"Type 4",link:"dlink.2000",pantilt:"false"},{id:"type5",name:"Type 5 (PTZ)",link:"7links.770hd",pantilt:"true"},{id:"type6",name:"Type 6",link:"dlink.dcs930",pantilt:"false"},{id:"type7",name:"Type 7",link:"dlink.dcs942",pantilt:"false"},{id:"type8",name:"Type 8 (PTZ)",link:"dlink.2000",pantilt:"true"},{id:"type9",name:"Type 9",link:"dlink.dcs2132",pantilt:"false"},{id:"type10",name:"Type 10 (PTZ)",link:"nueva.hd",pantilt:"true"},{id:"type11",name:"Type 11 (PTZ)",link:"instar.vga",pantilt:"true"},{id:"type12",name:"Type 12 (PTZ)",link:"instar.hd",pantilt:"true"},{id:"type13",name:"Type 13 (PTZ)",pantilt:"true",link:"foscam.fi8620"},{id:"type14",name:"Type 14 (PTZ)",pantilt:"true",link:"foscam.fi8919W"},{id:"type15",name:"Type 15 (PTZ)",pantilt:"true",link:"foscam.fi9826w"},{id:"type16",name:"Type 16",pantilt:"false",link:"edimax.3010"},{id:"type17",name:"Type 17 (PTZ)",pantilt:"true",link:"edimax.7001"},{id:"type18",name:"Type 18 (PTZ)",pantilt:"true",link:"edimax.7010"},{id:"type19",name:"Type 19 (PTZ)",pantilt:"true",link:"digitus.plugandview"},{id:"type20",name:"Type 20 (PTZ)",pantilt:"true",link:"doorbird.doorbird"},{id:"type21",name:"Type 21 (PTZ)",pantilt:"true",link:"mobotix.general"}]}},xnm.aio.cams.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="CamDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{SYS:"cam",getIPDeviceType:function getIPDeviceType(e,t){var o=[];for(var _e14 in xnm.aio.cams.CAM_INFO){var i=xnm.aio.cams.CAM_INFO[_e14];if(!i||!i.name)continue;if(t&&t.lm&&t.license){var _o7={sys:this.SYS,type:"system",manufacturer:_e14};if(!t.lm.permitFeature("read",_o7,t.license))continue;}var n={category:"system",type:_e14,name:i.name,versions:[]};if(i.versions)for(var _e15=0;_e15<i.versions.length;_e15++){var _t5=i.versions[_e15];_t5&&_t5.id&&_t5.name&&n.versions.push({model:_t5.id,name:_t5.name,link:_t5.link});}o.push(n);}if(e){var _i2=e.getIPCams()||[];for(var _e16=0;_e16<_i2.length;_e16++){var _n2=_i2[_e16],s=$(_n2).getAttributes();if(!s||!s.id||!s.name)continue;if(xnm.aio.cams.CAM_INFO[s.id])continue;if(t&&t.lm&&t.license){var _e17={sys:this.SYS,type:"custom",manufacturer:s.id};if(!t.lm.permitFeature("read",_e17,t.license))continue;}var r={category:"custom",type:s.id,name:s.name,versions:[]};o.push(r);var a=$(_n2).children()||[];for(var _e18=0;_e18<a.length;_e18++){var _t6=a[_e18],_o8=$(_t6).getAttributes();_o8&&_o8.id&&_o8.name&&r.versions.push({model:_o8.id,name:_o8.name});}}}return[{sys:this.SYS,name:"IP Camera",types:o}];},createDevice:function createDevice(e,t,o){e?e.type?e.ip?o(null,e):o(new DMError(DMError.ERROR_CODE.INVALID,"ip is invalid")):o(new DMError(DMError.ERROR_CODE.INVALID,"type is invalid")):o(new DMError(DMError.ERROR_CODE.INVALID,"info is invalid"));},updateDevice:function updateDevice(e,t,o){e?e.type?e.ip?o(null,e):o(new DMError(DMError.ERROR_CODE.INVALID,"ip is invalid")):o(new DMError(DMError.ERROR_CODE.INVALID,"type is invalid")):o(new DMError(DMError.ERROR_CODE.INVALID,"info is invalid"));},deleteDevice:function deleteDevice(e,t,o){o();},applyUIFilter:function applyUIFilter(e,t,o){var _contains=function _contains(e,t){if("*"===e)return!0;var o=!1;for(var _i3=0;_i3<e.length;_i3++){if(e[_i3]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var i=xnm.aio.cams.DM.getCommandStatusMap(e,o);var n=[];return i&&(n=function(e,t,o){var i=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var _t7=JSON.parse(JSON.stringify(e));i.push(_t7);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var _t8=JSON.parse(JSON.stringify(e));i.push(_t8);}});}return i;}(i,0,t)),n;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e));var n=null;switch(t.catagory){case"command":n=_filter(e,t),i.command=n;break;case"status":n=_filter(e,t),i.status=n;break;default:return null;}return n&&0!==n.length?i:null;},applyNeoServerFilter:function applyNeoServerFilter(e,t,o){var _contains=function _contains(e,t){if("*"===e)return!0;var o=!1;for(var _i4=0;_i4<e.length;_i4++){if(e[_i4]==t){o=!0;break;}}return o;},_filter=function _filter(e,t){var i=xnm.aio.cams.DM.getNeoServerCommandStatusMap(e,o);var n=[];return i&&(n=function(e,t,o){var i=[];switch(o.catagory){case"command":e.command&&e.command.forEach(function(e){if(_contains(o.elems,e.type)){var _t9=JSON.parse(JSON.stringify(e));i.push(_t9);}});break;case"status":e.status&&e.status.forEach(function(e){if(_contains(o.elems,e.type)){var _t10=JSON.parse(JSON.stringify(e));i.push(_t10);}});}return i;}(i,0,t)),n;};if(!e.sys)return null;var i=JSON.parse(JSON.stringify(e));var n=null;switch(t.catagory){case"command":n=_filter(e,t),i.command=n;break;case"status":n=_filter(e,t),i.status=n;break;default:return null;}return n&&0!==n.length?i:null;},applyIPEventFilter:function applyIPEventFilter(e,t,o){var i=this.getCamInfo(e,o);return i&&i.ipevt?{ipevt:i.ipevt}:null;},getCamInfo:function getCamInfo(e,t){var _overwriteParam=function _overwriteParam(e,t){for(var _o9 in e){e.hasOwnProperty(_o9)&&(t[_o9]=e[_o9]);}return t;},findSystemCamInfo=function findSystemCamInfo(e){var t=e.type;"tfcam"===e.type&&(t="telefunken");var o=xnm.aio.cams.CAM_INFO[t];if(!o)return null;var i=null;for(var _t11=0;_t11<o.versions.length;_t11++){var _n3=o.versions[_t11];if(_n3&&_n3.id==e.model){i=_n3;break;}}if(!i)return null;if(!i.link||i.link===e.type+"."+e.model)return i;var n=i.link.indexOf("."),s=findSystemCamInfo({type:i.link.substr(0,n),model:i.link.substr(n+1)});if(!s)return null;var r=JSON.parse(JSON.stringify(s));return _overwriteParam(i,r);},findUserCamInfo=function findUserCamInfo(e,t){var o=null;var i=t.find("cam[id=\"".concat(e.type,"\"]"));if(i&&i.length>0&&(o=i[0]),!o)return null;var n=$(o).find("version[id=\"".concat(e.model,"\"]"));if(!n||0===n.length)return null;n=n[0];var s=$(n).attr("link");if(!s||s===e.type+"."+e.model)return function(e){var t=e.getAttributes(),o=JSON.parse(JSON.stringify(t)),i=e.children();for(var _e19=0;_e19<i.length;_e19++){var _t12=$(i[_e19]);if(!_t12)continue;var _n4=_t12.attr("id"),_s=_t12.attr("code");_n4&&_s&&(o.keys||(o.keys=[]),o.keys.push({id:_n4,code:_s}));}return o;}($(n));var r=s.indexOf(".");var a=findSystemCamInfo({type:s.substr(0,r),model:s.substr(r+1)}),l=null;return a?(l=JSON.parse(JSON.stringify(a)),_overwriteParam(n,l)):(a=findUserCamInfo({type:s.substr(0,r),model:s.substr(r+1)},t),a?(l=JSON.parse(JSON.stringify(a)),_overwriteParam(n,l)):null);};if(!e.type||!e.model)return null;"system"!==e.type&&"custom"!==e.type||!e.manufacturer||((e=JSON.parse(JSON.stringify(e))).type=e.manufacturer);var o=findSystemCamInfo(e);return!o&&t&&(o=findUserCamInfo(e,t)),o;},getCommandStatusMap:function getCommandStatusMap(e,t){var o=this.getCamInfo(e,t);if(!o||!o.pantilt||"false"==o.pantilt)return null;var i={command:[]};if(o.keys)for(var _e20=0;_e20<o.keys.length;_e20++){var _t13=o.keys[_e20];i.command.push({type:"enum",name:_t13.id,ref:{value:_t13.id}});}return o.command&&(i.command=i.command.concat(o.command)),o.status&&(i.status=o.status),"system"===e.type&&"doorbird"===e.manufacturer&&(e.relays&&e.relays.length&&i.command.push({type:"enum",name:"open relay",ref:{value:"open_relay",ext:"%e",extMeta:e.relays}}),i.command.push({type:"enum",name:"open doorbird app",ref:{value:"open_app",value_t:"open_app_doorbird"}},{type:"enum",name:"open liveview",ref:{value:"open_live"}})),i;},getNeoServerCommandStatusMap:function getNeoServerCommandStatusMap(e,t){var o={command:[]};if(e&&"system"===e.type){if("doorbird"===e.model&&("doorbird"===e.manufacturer||"doorbird"===e.type))return o;if("netatmo"===e.manufacturer||"netatmo"===e.type)return o;}return o.command.push({type:"enum",name:"take snapshot",ref:{value:"snapshot"}}),o;}};}(),xnm.aio.cams.Handler=function(){var Handler=function Handler(){var e=require("x.logger.js");xnm.aio.cams.DM._logger=e?e.getLogger("xnm.aio.cams.DM"):{log:function log(){}},this._foscamDiscovery=null,this._doorbirdHandler=new xnm.aio.cams.DoorBird.Handler();};return Handler.prototype.devicemanager=xnm.aio.cams.DM,Handler.prototype.registModule=function(e){e.register(xnm.aio.cams.DM.SYS,"cams");},Handler.prototype.resolveDevice=function(e,t){var o=xnm.aio.cams.DM.getCamInfo(e,t);if(e&&"system"===e.type){if(("doorbird"===e.manufacturer||"doorbird"===e.type)&&"doorbird"===e.model)return new xnm.aio.cams.DoorBird(e,o);if("foscam"===e.manufacturer||"foscam"===e.type)return new xnm.aio.cams.Foscam(e,o);if("netatmo"===e.manufacturer||"netatmo"===e.type)return new xnm.aio.cams.Welcome(e,o);if("mobotix"===e.manufacturer||"mobotix"===e.type)return new xnm.aio.cams.Mobotix(e,o);if("axis"===e.manufacturer||"axis"===e.type)return new xnm.aio.cams.Axis(e,o);}return new xnm.aio.cams.Cam(e,o);},Handler.prototype.getCamJPEGUrl=function(e,t,o){var i=xnm.aio.cams.DM.getCamInfo(e,t),n=new xnm.aio.cams.Cam(e,i).getJPEGURL(function(e){n||e?o&&o(null,e):o&&o(new Error("cam has no jpeg url"));});n&&(o&&o(null,{url:n}),o=null);},Handler.prototype.getCamMJPEGUrl=function(e,t,o){var i=xnm.aio.cams.DM.getCamInfo(e,t),n=new xnm.aio.cams.Cam(e,i).getMJPEGURL();o&&o(n?null:new Error("cam has no mjpeg url"),{url:n});},Handler.prototype.getCamVideoInfo=function(e,t,o){var i=this.resolveDevice(e,t);i?i.getVideoInfo(o):o&&o(new Error("no such camera"));},Handler.prototype.getDeviceCommands=function(e,t){var o=xnm.aio.cams.DM.applyUIFilter(e,{catagory:"command",elems:"*"}),i=o?o.command:[];t&&t(null,i);},Handler.prototype.getDeviceStatus=function(e,t){var o=xnm.aio.cams.DM.applyUIFilter(e,{catagory:"status",elems:"*"}),i=o?o.status:[];t&&t(null,i);},Handler.prototype.doCommand=function(e,t,o,i){var n=this.resolveDevice(e,o);n?n.executeCommandCreator(e,t,i):i&&i(new Error("device json format invalid"));},Handler.prototype.doStatus=function(e,t,o,i){var n=this.resolveDevice(t);if(!n)return void(i&&i(new Error("device json format invalid")));var s=[{id:e,device:t,status:o}];n.getStatesCreator(null,s,function(e,t){i&&i(e,t);});},Handler.prototype.listSystemCam=function(e){var t=xnm.aio.cams.DM.getIPDeviceType()||[];e&&e(null,t);},Handler.prototype.createJPEGCam=function(e,t,o,i){return t&&t._extra&&"system"===t._extra.type&&"doorbird"===t._extra.manufacturer&&"doorbird"===t._extra.model&&t._mjpegurl?new xnm.aio.cams.MJPEGCam(t._mjpegurl,t):new xnm.aio.cams.JPEGCam(e,t,o,i);},Handler.prototype.createSystemCam=function(e,t){return new xnm.aio.cams.SystemCam(e,t);},Handler.prototype.detectCams=function(){this._foscamDiscovery||(this._foscamDiscovery=new xnm.aio.cams.FoscamDiscovery()),this._foscamDiscovery.discoverCams();},Handler.prototype.getDoorBirdHandler=function(){return this._doorbirdHandler;},Handler.prototype.discoverDoorbird=function(e,t){var _this29=this;var o=require("x.mdns.js");o.clearRecordBuffer(),o.discoverServiceWithTimeout("_axis-video._tcp.local",e,function(e,o){if(e)return void(t&&t(e));var i=[];for(var _e21=0;_e21<o.length;_e21++){var _t14=o[_e21];if(String(_t14.domain).startsWith("Doorstation")&&Array.isArray(_t14.ip)&&_t14.ip.length>0){var _e22={sys:"cam",type:"system",manufacturer:"doorbird",ip:_t14.ip[0],port:80};_t14.info&&_t14.info.macaddress&&(_e22.mac=_t14.info.macaddress);var _o10=_this29.resolveDevice(_e22);_o10&&i.push(_o10);}}t&&t(null,i);});},Handler.prototype.finalize=function(e){this._doorbirdHandler&&this._doorbirdHandler.finalize(),e&&e();},Handler.prototype.pause=function(e){this.finalize(e);},Handler;}(),"undefined"!=typeof module&&null!==module&&(module.exports=new xnm.aio.cams.Handler());