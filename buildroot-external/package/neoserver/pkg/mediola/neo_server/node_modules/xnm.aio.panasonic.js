var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.panasonic=xnm.aio.panasonic||{},xnm.aio.panasonic.BDP=function(){var BDP=function BDP(e,t,o,n){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.BDP"),this.ip=e,this.port=t,this.port||(this.port=80),this.username=o,this.password=n;};return BDP.URL="/WAN/dvdr/dvdr_ctrl.cgi",BDP.prototype._executeCommand=function(e,t){this._doRequest(e,t);},BDP.prototype._doRequest=function(e,t){var o=this,n=t;this._logger.log("trace","send data:"+e+" to:"+this.ip);var r={host:this.ip,port:this.port,path:BDP.URL,method:"POST",headers:{"User-Agent":"MEI-LAN-REMOTE-CALL"}};(this.username||this.password)&&(r.auth=(this.username?this.username:"")+":"+(this.password?this.password:""),r.headers.Authorization="Basic "+new Buffer((this.username?this.username:"")+":"+(this.password?this.password:"")).toString("base64"));var s="",i=require("http").request(r,function(e){e.on("data",function(e){s+=e;}),e.on("end",function(){200==e.statusCode?(o._logger.log("trace","http request success"),n&&(n(null,s),n=null)):(o._logger.log("trace","http request error:"+e.statusCode),n&&(n(new Error("post request failed with status code:"+e.statusCode)),n=null));});});i.setTimeout&&i.setTimeout(3e3,function(){o._logger.log("trace","http request timeout"),i.abort();}),i.on&&"function"==typeof i.on&&i.on("error",function(e){e||(e=new Error("http request error")),o._logger.log("trace","http request error:"+e.message),n&&n(e),n=null;}),i.write(e),i.end();},BDP;}(),xnm.aio.panasonic.BDP.DM={SYS:"panasonic_bdp",getIPDeviceType:function getIPDeviceType(){return{sys:this.SYS,name:"Panasonic BDP"};}},xnm.aio.panasonic.TV=function(){var TV=function TV(e,t,o,n,r){this._logger=require("x.logger.js").getLogger("xnm.aio.panasonic.TV"),this.ip=e,this.port=t,(!t||t<0)&&(this.port=55e3),this.path=o,o||(this.path="/nrc/control_0"),this.username=n,this.password=r;};return TV.XML_HEADER='<?xml version="1.0" encoding="utf-8"?>',TV.SOAP_EVELOPE_START='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">',TV.SOAP_EVELOPE_END="</s:Envelope>",TV.SOAP_BODY_START="<s:Body>",TV.SOAP_BODY_END="</s:Body>",TV.SOAP_SENDKEY_START='<u:X_SendKey xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">',TV.SOAP_SENDKEY_END="</u:X_SendKey>",TV.KEY_CODE_START="<X_KeyEvent>",TV.KEY_CODE_END="</X_KeyEvent>",TV.SOAP_SENDTXT_START='<u:X_SendString xmlns:u="urn:urn:panasonic-com:service:p00NetworkControl:1">',TV.SOAP_SENDTXT_END="</u:X_SendString>",TV.TXT_START="<X_String>",TV.TXT_END="</X_String>",TV.prototype._sendTxt=function(e,t){var o=this._buildSoapReq(e,!0);this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendString",o,function(e){t&&t(e);});},TV.prototype._executeCommand=function(e,t){this._logger.log("debug","send key:"+e);var o=this._buildSoapReq(e),n=this;this._doRequest("urn:panasonic-com:service:p00NetworkControl:1#X_SendKey",o,function(e){n._logger.log("debug","send key "+(e?"error:"+e.message:"success")),t&&t(e);});},TV.prototype._buildSoapReq=function(e,t){var o=TV.XML_HEADER;return o+=TV.SOAP_EVELOPE_START,o+=TV.SOAP_BODY_START,o+=t?TV.SOAP_SENDTXT_START:TV.SOAP_SENDKEY_START,o+=t?TV.TXT_START:TV.KEY_CODE_START,o+=e,o+=t?TV.TXT_END:TV.KEY_CODE_END,o+=t?TV.SOAP_SENDTXT_END:TV.SOAP_SENDKEY_END,o+=TV.SOAP_BODY_END,o+=TV.SOAP_EVELOPE_END;},TV.prototype._doRequest=function(e,t,o){var n=this,r="http://"+this.ip+":"+this.port+this.path,s=o;this._logger.log("trace","send data:"+t+" to:"+r),$.ajax({url:r,type:"POST",timeout:3e3,data:t,cache:!1,headers:{SOAPAction:'"'+e+'"',"Content-Type":"text/xml; charset=UTF-8","Content-Length":t.length},username:this.username,password:this.password,success:function success(){n._logger.log("trace","http request success"),o&&o();},error:function error(e,t){var o="http request error:"+(e?e.status:"0")+"-"+t;s&&(s(new Error(o)),s=null);}});},TV;}(),xnm.aio.panasonic.DM=function(){var DMError=function DMError(e,t){this.code=e,this.message=t,this.stack=new Error().stack;};return(DMError.prototype=new Error()).name="PanasonicDMError",DMError.prototype.code=0,DMError.ERROR_CODE={DEFAULT:0,INDEX_EXISTS:1,ID_EXISTS:2,INVALID:3,UNKNOW:4,NOT_FOUND:5,IP_EXISTS:6},{getSys:function getSys(){var e=[];for(var t in xnm.aio.lg){xnm.aio.lg.hasOwnProperty(t)&&xnm.aio.lg[t]&&xnm.aio.lg[t].DM&&e.push(xnm.aio.lg[t]);}return e;},registModule:function registModule(e){for(var t=this.getSys(),o=0;o<t.length;o++){t[o]&&t[o].DM&&t[o].DM.SYS&&e.register(t[o].DM.SYS,"panasonic");}},getIPDeviceType:function getIPDeviceType(){for(var e=[],t=this.getSys(),o=0;o<t.length;o++){if(t[o]&&t[o].DM&&t[o].DM.getIPDeviceType){var n=t[o].DM.getIPDeviceType();n&&e.push(n);}}return e;}};}(),xnm.aio.panasonic.Handler=function(){var Handler=function Handler(){};return Handler.prototype.devicemanager=xnm.aio.panasonic.DM,Handler.prototype.BDP=xnm.aio.panasonic.BDP,Handler.prototype.TV=xnm.aio.panasonic.TV,Handler.prototype.registModule=function(e){this.devicemanager.registModule(e);},Handler;}(),"undefined"!=typeof module&&null!=module&&(module.exports=new xnm.aio.panasonic.Handler());