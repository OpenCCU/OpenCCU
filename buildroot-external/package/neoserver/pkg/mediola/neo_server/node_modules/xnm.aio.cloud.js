function _typeof(obj){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj;}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;},_typeof(obj);}var xnm=xnm||{};xnm.aio=xnm.aio||{},xnm.aio.cloud=xnm.aio.cloud||{},xnm.aio.cloud.Server=function(){this._url="http://webservice.aio-control.com/config?";},xnm.aio.cloud.Server.prototype._doRequest=function(e,t){$.ajax({url:this._url+e,timeout:4e3,cache:!1,success:function success(e){var r=null;e&&e.length>=8&&"{XC_SUC}"==e.substr(0,8)?r=e.length>8?{data:$.parseJSON(e.substr(8))}:{data:{}}:e&&e.length>8&&"{XC_ERR}"==e.substr(0,8)&&(r={error:e.substr(8)}),t&&t(r);},error:function error(){t&&t(null);}});},xnm.aio.cloud.Server.prototype.doRequest=function(e,t,r){var o="XC_FNC="+e;if(t)for(var i in t){o+="&"+i+"="+t[i];}this._doRequest(o,r);},xnm.aio.cloud.Server.prototype.getNewSID=function(e){this._doRequest("XC_FNC=getSID",e);},xnm.aio.cloud.Server.prototype.getEleroKey=function(e,t){this._doRequest("XC_FNC=getEleroKey&SID="+e,t);},xnm.aio.cloud.Server.prototype.setMessage=function(e,t,r,o,i,s,n){var a=JSON.stringify({email:r,message:o,username:n}),l=this._url+"XC_FNC=setMessage&SID="+e+"&AID="+t;s&&(l+="&sns="+s),$.ajax({type:"POST",url:l,data:{data:a},timeout:4e3,cache:!1,complete:function complete(e){e&&(e=e.responseText),e&&e.length>=8&&"{XC_SUC}"==e.substr(0,8)?i(!0):i(!1);}});},xnm.aio.cloud.Server.prototype.getMessage=function(e,t,r){this._doRequest("XC_FNC=getMessage&SID="+e+"&AID="+t,r);},xnm.aio.cloud.Server.prototype.assignBeckerSeiral=function(e,t){var r=t;$.ajax({url:this._url+"/beckerserial/assign?sid="+e.toUpperCase(),timeout:4e3,dataType:"text",cache:!0,success:function success(e){try{var t=JSON.parse(e);if("no more available"==t.serial){var o=new Error(t.serial);o.errCode=-1,r&&r(o);}else r&&r(null,t.serial);}catch(e){r&&r(e);}r=null;},error:function error(e,t){var o="http request error:"+(e?e.status:"0")+"-"+t;r&&r(new Error(o));}});},xnm.aio.cloud.RemotesServer=function(){this.ip="https://remotes.mediola.com",this.port=443,this.user="",this.password="",this.secure=!0,this.folder="",this._remotes=null,this._error=null,this._finishedDownloadCallback=null;},xnm.aio.cloud.RemotesServer.prototype._getUpdateFile=function(e){var t=this.secure?"https://":"http://";if(t+=this.ip+":"+this.port+"/creatorneo/remote/requestDownload",this.secure)this._getUpdateFileHttps(e);else{var r=e;$.ajax({type:"GET",url:t,timeout:8e3,cache:!1,dataType:"json",headers:{Authorization:"Basic "+new Buffer(this.user+":"+this.password).toString("base64")},success:function success(e){r&&(r(null,e,200),r=null);},error:function error(e,t,o){var i="HTTP request error: "+(e?e.status:"0")+"-"+t;r&&(r(new Error(i),e?e.responseText:null,e?e.status:null),r=null);}});}},xnm.aio.cloud.RemotesServer.prototype._getUpdateFileHttps=function(e){"object"==(typeof process==="undefined"?"undefined":_typeof(process))&&null!==process&&process.env&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0");var t="https://"+this.ip+":"+this.port+"/creatorneo/remote/requestDownload",r=e;$.ajax({type:"GET",url:t,timeout:8e3,cache:!1,dataType:"json",headers:{"Content-Type":"application/json; charset=utf-8",Authorization:"Basic "+new Buffer(this.user+":"+this.password).toString("base64")},success:function success(e){r&&(r(null,e,200),r=null);},error:function error(e,t,o){var i="HTTPS request error: "+(e?e.status:"0")+"-"+t;r&&(r(new Error(i),e?e.responseText:null,e?e.status:null),r=null);}});},xnm.aio.cloud.RemotesServer.prototype._moveFromTmp=function(e,t,r){var o=require("fs"),i=o.createReadStream(e),s=o.createWriteStream(t);i.pipe(s),i.on("error",function(e){XC.debugf("[xnm.aio.cloud.RemotesServer._moveFromTmp] "+e.message,"error"),r&&r(e);}),i.on("end",function(){o.unlinkSync(e),r&&r();});},xnm.aio.cloud.RemotesServer.prototype._downloadFile=function(e,t,r,o){var i=require("http"),s=require("fs"),n={fileData:r,url:{username:this.user,password:this.password}},a=this,l=null;l="object"==(typeof nw==="undefined"?"undefined":_typeof(nw))?function(e,i){e?s.stat(e,function(i,n){if(i)o(i);else{if("win32"===process.platform){var l=t.substring(t.lastIndexOf("/")+1);if(/[<>:"|?*]/.test(l))return i=new Error('Invalid characters (<>:"|?*) in filename, which cannot be used on Windows: '+l),XC.debugf("[xnm.aio.cloud.RemotesServer._downloadFile] "+i.message,"error"),void o(i);}var c=t.substring(0,t.lastIndexOf("/"));s.mkdirRecursiveSync(c),a._moveFromTmp(e,t,function(e){e?o(e):s.writeFile(t+".md5",r.md5,function(e){o(e);});});}}):o(i||new Error("file from mediola server error"));}:function(e,r){if(e&&s.existsSync(e)){var i=t.substring(0,t.lastIndexOf("/"));s.mkdirRecursiveSync(i),s.renameSync(e,t),o();}else o(r||new Error("file from mediola server error"));};var c=window.XCHost&&window.XCHost.getType&&("iOS"==window.XCHost.getType()||"Android"==window.XCHost.getType());if(this._aws3Client&&r&&r.file.match(/^resources.*/)){var u={Bucket:"mediola-creator",Key:"resources/"+r.ref},d=null;c||(d=require("os").tmpdir()+require("path").sep+"xcdl"+require("path").sep+Math.random().toString(36).substring(2)),this._aws3Client.getObject2File(u,d,function(e,t){e?(XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] failed to download file from S3: "+r.file),XC.debugf("[xnm.aio.cloud.RemoteServer._downloadFile] "+e.message),l(null,new Error("S3:"+e.message))):l(t);});}else{var m=i.getFileAIOCloud;c&&(n={},e+="?username="+encodeURIComponent(this.user)+"&password="+encodeURIComponent(this.password),m=i.getFileUriEncoded),m(e,n,l);}},xnm.aio.cloud.RemotesServer.prototype._encryptFile=function(e,t){if("undefined"!=typeof nw){var r=require("fs");r.readFile(e,"utf8",function(o,i){if(!o&&i){var s=require("m.aio.devicemanager.js"),n=require("x.crypt.js").AES.encodeString(i,s.ml_v1_info());r.writeFile(e+".enc",n,function(o){o?(XC.debugf("[xnm.aio.cloud.RemotesServer._encryptFile] "+o.message,"error"),t&&t("crypt write file")):(r.unlinkSync(e),t&&t());});}else t&&t("crypt read file");});}else t();},xnm.aio.cloud.RemotesServer.prototype._checkFile=function(e,t,r,o,i){for(var s=this._remotesPath+"_new/"+e+"/"+o.file,n=this.secure?"https://":"http://",a=o.ref.split("/"),l="",c=0;c<a.length;c++){l+=encodeURIComponent(a[c]),c<a.length-1&&(l+="/");}n+=this.ip+":"+this.port+"/creatorneo/remote/downloadFile/"+l;var u=!1,d=require("fs"),m=this._remotesPath+"/"+e+"/"+o.file,f=this,h=o.file.indexOf(".DS_Store");h>-1&&h+9==o.file.length?i():d.readFile(m+".md5","utf8",function(e,a){if(!e&&a&&a==o.md5&&"device_db"!==o.file)try{d.copyFileSync(m,s),d.copyFileSync(m+".md5",s+".md5"),u=!0;}catch(e){XC.debugf("[xnm.aio.cloud.RemotesServer._checkFile] "+e.message,"warn");}u?i():f._downloadFile(n,s,o,function(e){var n=!0;if("device_db"==o.file&&t)return n=!1,void d.readFile(s,"utf8",function(e,r){if(!e&&r){var o=require("x.crypt.js").AES.decodeString(r,t);d.writeFile(s,o,function(e){f._encryptFile(s,i);});}else i("crypt");});if("device_db"==o.file&&r&&(n=!1,d.readFile(s,"utf8",function(e,t){if(!e&&t){var r=!1;require("xnm.aio.hm.js").discoverCCUs(function(e){if(!r){r=!0;var o=JSON.parse(t);if(o&&o.gateways)for(var n=0;n<o.gateways.length;n++){var a=o.gateways[n];a.info&&"hm"==a.info.sys&&(a.info.uuid=e.uuid,a.info.ip=e.ip);}var l=JSON.stringify(o);d.writeFile(s,l,function(e){d.existsSync(s+".md5")&&d.unlinkSync(s+".md5"),f._encryptFile(s,i);});}}),setTimeout(function(){r||i("noCCU");},1e3);}else i("file");})),"device_db"===o.file&&(n=!1,f._encryptFile(s,i)),n)if(e){var a="[File] ";if(e instanceof Error)a+=e.message;else if("string"==typeof e)a+=e;else if("object"==_typeof(e))try{a+=JSON.stringify(e);}catch(e){a+="Error object cannot be converted to string.";}i(new Error(a));}else i();});});},xnm.aio.cloud.RemotesServer.prototype._downloadNextFile=function(e,t){if(void 0===e&&(e=0),void 0===t&&(t=0),0===e&&0===t&&(this._remoteNames=[]),0===this._remotes.length&&(this._remoteNames=null),e>=this._remotes.length)return XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Downloaded all remotes."),void setTimeout(function(){this._renameRemoteDir(this._remoteNames);}.bind(this),100);if(this._$progressDiv){var r=Math.floor(this._filesDownloaded/this._filesToDownload*100);this._$progressDiv.text(r+"%");}var o=this._remotes[e];if(0===t&&(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Download next remote: "+o.name),this._remoteNames.push(o.name)),"function"==typeof this.cbProgress){var i=o.resources.length+t,s=Math.floor(100*t/i),n=Math.floor(this._filesDownloaded/this._filesToDownload*100);this.cbProgress(e,o.name,s,n);}o.resources.length>0?(this._filesDownloaded++,this._checkFile(o.name,o.pwd,o.replaceCCU,o.resources[0],function(r){r?(XC.debugf("[xnm.aio.cloud.RemotesServer._downloadNextFile] Check file error: "+r,"error"),this._error=r,this._remotes=[]):this._remotes[e].resources.splice(0,1),this._downloadNextFile(e,t+1);}.bind(this))):this._downloadNextFile(e+1,0);},xnm.aio.cloud.RemotesServer.prototype._renameRemoteDir=function(e){if(XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Renaming directory ..."),e){var t=require("fs"),r=this._remotesPath+"_"+new Date().getTime();t.existsSync(this._remotesPath)&&t.renameSync(this._remotesPath,r);try{t.renameSync(this._remotesPath+"_new",this._remotesPath);}catch(e){XC.debugf(e.message),t.renameSync(r,this._remotesPath);}t.existsSync(r)&&t.rmdirRecursiveSync(r),e.sort(function(e,t){return e.localeCompare(t);});}XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] ... renamed directory."),this._finishedDownloadCallback&&(XC.debugf("[xnm.aio.cloud.RemotesServer._renameRemoteDir] Calling callback for finished download."),this._finishedDownloadCallback(e,this._error));},xnm.aio.cloud.RemotesServer.prototype._checkPasswords=function(){for(var e=this,t=0;t<this._remotes.length;t++){var r=this._remotes[t];if(r.encrypt&&!r.pwd)return void this._passwordCallback(r.name,function(o){var i=!1;null!=o?require("x.crypt.js").AES.decodeString(r.encrypt,o)==r.name?r.pwd=o:(e._remotes.splice(t,1),i=!0):(e._remotes.splice(t,1),i=!0);i&&(r.pwdFailed=!0),e._checkPasswords();});}this._filesDownloaded=0,this._filesToDownload=0;for(t=0;t<this._remotes.length;t++){this._filesToDownload+=this._remotes[t].resources.length;}this._downloadNextFile(0,0);},xnm.aio.cloud.RemotesServer.prototype.updateRemotes=function(e,t,r){this._error=null,this._passwordCallback=r,this._$progressDiv=e;var o=require("fs");if("object"==(typeof nw==="undefined"?"undefined":_typeof(nw))){var i=require("path");this._remotesPath=i.join(nw.App.dataPath,"..","remotes");}else this._remotesPath=o.dataPath()+"/remotes";try{o.mkdirRecursiveSync(this._remotesPath);}catch(e){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+this._remotesPath+'". Error: '+e.message,"error");}try{o.mkdirRecursiveSync(this._remotesPath+"_new");}catch(e){XC.debugf('[xnm.aio.cloud.RemotesServer.updateRemotes] Failed to mkdir: "'+this._remotesPath+'_new". Error: '+e.message);}this._getUpdateFile(function(e,r,o){if(this._aws3Client=null,e)t&&t(null,new Error("[File List] "+e.message),o);else if(r&&"error"==r.classid)t&&t(null,r.code,o);else if(r&&r.infos){if(r.credential){var i=require("x.aws");i&&(this._aws3Client=i.getS3Client(r.credential));}this._remotes=r.infos,this._finishedDownloadCallback=function(e,r){this._aws3Client&&this._aws3Client.release(),t&&t(e,r);}.bind(this),this._checkPasswords();}else t&&t(null,null,o);}.bind(this));},xnm.aio.cloud.Handler=function(){XC.debugf("xnm.aio.cloud.Handler created");},xnm.aio.cloud.Handler.prototype.Server=xnm.aio.cloud.Server,xnm.aio.cloud.Handler.prototype.RemotesServer=xnm.aio.cloud.RemotesServer,"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=new xnm.aio.cloud.Handler());