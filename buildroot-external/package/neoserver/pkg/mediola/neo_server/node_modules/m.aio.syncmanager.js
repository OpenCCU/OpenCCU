var m=m||{};m.aio=m.aio||{},m.aio.syncmanager=m.aio.syncmanager||{};var async=require("async"),crypto=require("crypto"),fs=require("fs"),path=require("path"),unorm=require("unorm");m.aio.syncmanager.PROTOCOL="https",m.aio.syncmanager.HOST="127.0.0.1",m.aio.syncmanager.PORT=8080,m.aio.syncmanager.PATH="",m.aio.syncmanager.HEADERS={"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"},m.aio.syncmanager.RemotesDownloader=function(e,r,o,n){var t=require("x.logger.js");this._logger=t.getLogger("RemotesDownloader"),this._host=e,this._port=r,this._username=o||"",this._password=n||"";},m.aio.syncmanager.RemotesDownloader.PROTOCOL="https",m.aio.syncmanager.RemotesDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}},m.aio.syncmanager.RemotesDownloader.prototype.downloadRemoteList=function(e){this._logger.log("debug","download remotes list from account:"+this._username),this._doRemoteDownloadReq(function(r,o){if(r)e&&e(r);else if(o.infos){var n={remotes:[],info:o};if(0!=o.infos.length){for(var t=0;t<o.infos.length;t++){o.infos[t].name&&n.remotes.push({name:o.infos[t].name,encrypt:!!o.infos[t].encrypt});}e&&e(null,n);}else e&&e(null,n);}else e&&e(new Error("download response format invalid"));});},m.aio.syncmanager.RemotesDownloader.prototype.download=function(e,r){this._logger.log("debug","download remotes from account:"+this._username);var o=this;this._doRemoteDownloadReq(function(n,t){n?r&&r(n):t.infos?0!=t.infos.length?o._doDownloadRemotes(e,t.credential,t.infos,function(e){r&&r(e);}):r&&r():r&&r(new Error("download response format invalid"));});},m.aio.syncmanager.RemotesDownloader.prototype._doRemoteDownloadReq=function(e){this._doGetRequest("/creatorneo/remote/requestDownload",null,function(r,o){if(r)e&&e(r);else try{var n=JSON.parse(o);e&&e(null,n);}catch(r){e&&e(r);}});},m.aio.syncmanager.RemotesDownloader.prototype._doDownloadRemotes=function(e,r,o,n){var t=new m.aio.syncmanager.RemoteDownloader({host:this._host,port:this._port,username:this._username,password:this._password,credential:r}),s=0,cb=function cb(r){r?n&&n(r):++s<o.length?t.download(e,o[s],cb):n&&n();};t.download(e,o[s],cb);},m.aio.syncmanager.RemotesDownloader.prototype._doGetRequest=function(e,r,o){var n=o,t=JSON.parse(JSON.stringify(m.aio.syncmanager.RemotesDownloader.OPTIONS));(t.host=this._host?this._host:t.host,t.port=this._port?this._port:t.port,t.path+=e,t.method="GET",this._username&&this._password&&(t.auth=this._username+":"+this._password),r)&&Object.keys(r).forEach(function(e){t.headers[e]=r[e];});var s="",i=require(m.aio.syncmanager.RemotesDownloader.PROTOCOL).request(t,function(e){e.setEncoding("utf8"),e.on("data",function(e){s+=e;}),e.on("end",function(){200==e.statusCode?n&&n(null,s):n&&n(new Error("http error with status code:"+e.statusCode),s),n=null;});});i.on("error",function(e){n&&(n(e),n=null);}),i.end();},m.aio.syncmanager.RemotesDownloader.prototype._decrypt=function(e,r){try{return require("x.crypt.js").AES.decodeString(e,r).trim();}catch(e){return console.log(e),null;}},m.aio.syncmanager.RemotesDownloader.prototype._findRemote=function(e,r){if(!e)return null;if(!r||!r.infos||0==r.infos.length)return null;for(var o=0;o<r.infos.length;o++){if(r.infos[o].name==e)return r.infos[o];}return null;},m.aio.syncmanager.RemoteDownloader=function(e,r){var o=require("x.logger.js");if(this._logger=o?o.getLogger("RemoteDownloader"):{log:function log(){}},this._listener=r,this._host=e.host,this._port=e.port,this._username=e.username?e.username:"",this._password=e.password?e.password:"",this._override="true"==e.override,this._s3cred=e.credential,this._remotePassword=e.remotePassword,this._encrypted=!1,this._s3cred){var n=require("aws-sdk");this._s3Client=new n.S3({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:e.credential.accessKeyId,secretAccessKey:e.credential.secretAccessKey,sessionToken:e.credential.sessionToken});}},m.aio.syncmanager.RemoteDownloader.PROTOCOL="https",m.aio.syncmanager.RemoteDownloader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}},m.aio.syncmanager.RemoteDownloader.prototype.download=function(e,r,o){this._logger.log("trace","download remote:"+r.name);var n,t=this,s=require("path");if(r.name){if(this._listener&&this._listener.onProgress&&this._listener.onDownloadProgress(0,"start download"),r.resources&&0!=r.resources.length){if(r.encrypt){if(this._encrypted=!0,!this._remotePassword)return void(o&&((n=new Error("no remote password")).code=1,o(n)));if(this._decrypt(r.encrypt,this._remotePassword)!=r.name)return void(o&&((n=new Error("remote password error")).code=2,o(n)));}var i=require("fs"),a=e+s.sep+r.name;try{var l=i.existsSync(a);if(l&&!this._override)return void(o&&((n=new Error("remote:"+r.name+" already exists")).code=3,o(n)));if(l&&this._override){var c=new Date().getTime();i.renameSync(a,a+"_"+c),this._deldir(a+"_"+c);}}catch(e){return void(o&&o(e));}this._listener&&this._listener.onProgress&&this._listener.onDownloadProgress(1,"start to download files",{filesCount:r.resources.length}),this._mkdir(e+s.sep+r.name,function(){var n=o,i=0,cb2=function cb2(o){n&&t._listener&&t._listener.onProgress&&t._listener.onDownloadProgress(2,"one file download finish"),i+=1,o?n&&(n(o),n=null):i!=r.resources.length?t._downloadFile(e+s.sep+r.name,r.resources[i],cb2):n&&(n(),n=null);};t._downloadFile(e+s.sep+r.name,r.resources[i],cb2);});}else o&&o();}else o&&o(new Error("remote info has no remote name"));},m.aio.syncmanager.RemoteDownloader.prototype._downloadFile=function(e,r,o){var n=this;this._logger.log("trace","download file:"+r.file),r.file?"device_db"!==r.file?r.file.match(/^resources.*/)&&this._s3cred?this._downloadFileFromS3(e,r,function(e){n._logger.log("trace","download file finish:"+r.file),e&&n._logger.log("trace","download file "+r.file+" from s3 error:"+e.message),o&&o(e);}):this._downloadFileFromServer(e,r,function(t){if(n._logger.log("trace","download file finish:"+r.file),t)return n._logger.log("trace","download file "+r.file+" from server error:"+t.message),void(o&&o(t));if("device_db"==r.file&&n._encrypted){var s=require("path"),i=r.file.replace(/\//g,s.sep),a=e+s.sep+i;n._decryptFile(a,function(e){o&&o(e);});}else o&&o();}):o&&o():o&&o(new Error("file info has no file path"));},m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromServer=function(e,r,o){if(r.ref){var n=require("path"),t=require("fs"),s=r.file.replace(/\//g,n.sep),i=e+n.sep+s;this._logger.log("trace","download file to:"+i);var a=i.lastIndexOf(n.sep),l=i.substr(0,a);try{t.mkdirRecursiveSync(l);}catch(e){return void(o&&o(e));}for(var c=require(m.aio.syncmanager.RemoteDownloader.PROTOCOL),d=this._host?this._host:m.aio.syncmanager.RemoteDownloader.OPTIONS.host,u=this._port?this._port:m.aio.syncmanager.RemoteDownloader.OPTIONS.port,f=m.aio.syncmanager.RemoteDownloader.OPTIONS.path+"/creatorneo/remote/downloadFile",g=r.ref.split("/"),p=0;p<g.length;p++){g[p]=encodeURIComponent(g[p]);}var h=m.aio.syncmanager.RemoteDownloader.PROTOCOL+"://"+d+":"+u+f+"/"+g.join("/");h+="?username="+(this._username?encodeURIComponent(this._username):"")+"&password="+(this._password?encodeURIComponent(this._password):""),this._logger.log("trace","download file url:"+h);var _=t.createWriteStream(i);c.get(h,function(e){e.pipe(_),_.on("finish",function(){_.close(o);});}).on("error",function(e){t.unlink(i),o&&o(e);});}else o&&o(new Error("file info has no ref"));},m.aio.syncmanager.RemoteDownloader.prototype._downloadFileFromS3=function(e,r,o){if(this._s3Client){if(r.ref){var n=require("path"),t=require("fs"),s=r.file.replace(/\//g,n.sep),i=e+n.sep+s;this._logger.log("trace","download file to:"+i);var a=i.lastIndexOf(n.sep),l=i.substr(0,a);try{t.mkdirRecursiveSync(l);}catch(e){return void(o&&o(e));}var c={Bucket:"mediola-creator",Key:"resources/"+r.ref};this._s3Client.getObject(c,function(e,r){e?o&&o(e):t.writeFile(i,r.Body,function(e){o&&o(e);});});}else o&&o(new Error("file info has no ref"));}else o&&o(new Error("s3 client not properly initialized"));},m.aio.syncmanager.RemoteDownloader.prototype._mkdir=function(e,r){var o=require("fs");try{o.mkdirSync(e);}catch(r){this._logger.log("warn","creator folder "+e+" error:"+r.message);}r&&r();},m.aio.syncmanager.RemoteDownloader.prototype._deldir=function(e){var r=require("fs"),o=this;r.existsSync(e)&&(r.readdirSync(e).forEach(function(n,t){var s=e+"/"+n;r.lstatSync(s).isDirectory()?o._deldir(s):r.unlinkSync(s);}),r.rmdirSync(e));},m.aio.syncmanager.RemoteDownloader.prototype._decrypt=function(e,r){try{return require("x.crypt.js").AES.decodeString(e,r).trim();}catch(e){return console.log(e),null;}},m.aio.syncmanager.RemoteDownloader.prototype._decryptFile=function(e,r){var o=this,n=require("fs"),t=e+".bak";n.rename(e,t,function(s){s?r&&r(s):n.readFile(t,{encoding:"utf8"},function(s,i){if(s)r&&r(s);else{var a=o._decrypt(i,o._remotePassword);a?n.writeFile(e,a,function(e){e?r&&r(e):n.unlink(t,function(e){r&&r(e);});}):r&&r(new Error("decrypt error"));}});});},m.aio.syncmanager.RemoteUploader=function(e,r){var o=require("x.logger.js");this._logger=o?o.getLogger("RemoteUploader"):{log:function log(){}},this._username=e.username?e.username:"",this._password=e.password?e.password:"",this._remotePassword=e.remotePassword?e.remotePassword:"",this._listener=r;},m.aio.syncmanager.RemoteUploader.PROTOCOL="https",m.aio.syncmanager.RemoteUploader.OPTIONS={host:"127.0.0.1",port:8080,path:"",headers:{"Content-Type":'application/json; charset="UTF-8"',"User-Agent":"mediola",Connection:"close"}},m.aio.syncmanager.RemoteUploader.prototype.upload=function(e,r,o,n){if(e){if(o){this._logger.log("debug","upload remote:"+o.id);var t=this;this._logger.log("trace","send upload remote request."),this._listener&&this._listener.onProgress&&this._listener.onProgress(0,"start upload"),this._doRemoteUploadReq(e,r,o,function(s,i){if(s)return t._logger.log("trace","send upload remote request error:"+s.stack),void(n&&n(s));i.resources?(t._logger.log("trace","upload data one by one."),t._uploadResources(e,r,o,i,function(r,o){r?n&&n(r):(t._logger.log("trace","send upload remote finish request."),t._finishUploadRemote(e,o,function(e){n&&n(e);}));})):n&&n(new Error("server return format error"));});}else n&&n(new Error("remote is null"));}else n&&n(new Error("license is empty"));},m.aio.syncmanager.RemoteUploader.prototype._doRemoteUploadReq=function(e,r,o,n){var t=this,s=new m.aio.syncmanager.Assembler();this._listener&&this._listener.onProgress&&this._listener.onProgress(1,"assemble files"),s.generateRemoteUploadReq(r,o,function(r,o){if(r)return t._logger.log("error","Error on generating remote upload request: "+r.message),void(n&&n(r));t._listener&&t._listener.onProgress&&t._listener.onProgress(2,"inform server for upcoming upload"),t._doPostRequest("/creatorneo/remote/requestUpload?license="+e,null,JSON.stringify(o),function(e,r){if(e)n&&n(e);else try{var o=JSON.parse(r);n&&n(null,o);}catch(e){n&&n(e);}});});},m.aio.syncmanager.RemoteUploader.prototype._uploadResources=function(e,r,o,n,t){if(n&&n.resources){var s=new(require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:n.credential.accessKeyId,secretAccessKey:n.credential.secretAccessKey,sessionToken:n.credential.sessionToken,httpOptions:{timeout:3e5}});this._listener&&this._listener.onProgress&&this._listener.onProgress(3,"start to upload files",{filesCount:n.resources.length});var i=this;require("async").eachLimit(n.resources,5,function(n,t){return n.exists&&n.file&&"device_db"!=n.file?(i._listener&&i._listener.onProgress&&i._listener.onProgress(4,"one file upload finish"),void t()):n.file?void(n.file.match(/^resources.*/)?i._uploadFileToS3(s,r,o,n,function(e){n.success=!e,i._listener&&i._listener.onProgress&&i._listener.onProgress(4,"one file upload finish"),t(e);}):i._uploadFileToServer(e,r,o,n,function(e){n.success=!e,i._listener&&i._listener.onProgress&&i._listener.onProgress(4,"one file upload finish"),t(e);})):(n.success=!1,i._listener&&i._listener.onProgress&&i._listener.onProgress(4,"one file upload finish"),void t(new Error("resource index has no file parameter")));},function(e){t&&t(e,n);});}else t&&t(new Error("no resource to upload in the req"));},m.aio.syncmanager.RemoteUploader.prototype._uploadFileToServer=function(e,r,o,n,t){this._logger.log("trace","upload remote file:"+n.file);var s=this,i=require("fs"),a=require("path"),l=o.getFolderPath(),c=r.getFolderPath();switch(n.file){case"device_db":i.readFile(l+a.sep+n.file,function(r,o){if(r)t&&t(r);else{"device_db"==n.file&&s._remotePassword&&(o=s._encrypt(o,s._remotePassword));var i="/creatorneo/remote/uploadFile?license="+e,a={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":new Buffer(n.ref).toString("base64"),"Remote-File-MD5":n.md5,"Remote-File-SHA1":n.sha1,"Remote-File-Size":n.size};s._doPostRequest(i,a,o,function(e,r){e&&s._logger.log("trace","upload remote file "+n.file+" error:"+r),t&&t(e);});}});break;case"macros_db":case"deviceinfo.xml":i.readFile(c+a.sep+n.file,function(r,o){if(r)t&&t(r);else{"device_db"==n.file&&s._remotePassword&&(o=s._encrypt(o,s._remotePassword));var i="/creatorneo/remote/uploadFile?license="+e,a={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":new Buffer(n.ref).toString("base64"),"Remote-File-MD5":n.md5,"Remote-File-SHA1":n.sha1,"Remote-File-Size":n.size};s._doPostRequest(i,a,o,function(e,r){e&&s._logger.log("trace","upload remote file "+n.file+" error:"+r),t&&t(e);});}});break;default:i.readFile(l+a.sep+n.file,function(r,o){if(r)t&&t(r);else{var i="/creatorneo/remote/uploadFile?license="+e,a={"Remote-File-Ref-Base64":!0,"Remote-File-Ref":new Buffer(n.ref).toString("base64"),"Remote-File-MD5":n.md5,"Remote-File-SHA1":n.sha1,"Remote-File-Size":n.size};s._doPostRequest(i,a,o,function(e,r){e&&s._logger.log("trace","upload remote file "+n.file+" error:"+r),t&&t(e);});}});}},m.aio.syncmanager.RemoteUploader.prototype._uploadFileToS3=function(e,r,o,n,t){var _this=this;this._logger.log("trace","upload remote resource:"+n.file);var s=require("fs"),i=require("path"),a=o.getFolderPath(),l=t;var c=i.join(a,n.file);s.readFile(c,function(r,o){if(r)return _this._logger.log("error","[_uploadFileToS3] readFile error (file: \"".concat(c,"\"): ")+r.message),l(r),void(l=null);var t={Bucket:"mediola-creator",Key:"resources/"+n.ref,Body:o},s=e.putObject(t,function(e){e&&_this._logger.log("error","[_uploadFileToS3] S3 error on putObject: "+e.message),n.success=!e,l&&(l(e),l=null);});s.on("error",function(e){l&&(l(e),l=null);});});},m.aio.syncmanager.RemoteUploader.prototype._finishUploadRemote=function(e,r,o){this._listener&&this._listener.onProgress&&this._listener.onProgress(5,"finalize the upload process"),this._remotePassword&&(r.encrypt=this._encrypt(r.name,this._remotePassword)),this._doPostRequest("/creatorneo/remote/finishUpload?license="+e,null,JSON.stringify(r),function(e,r){o&&o(e,r);});},m.aio.syncmanager.RemoteUploader.prototype._doPostRequest=function(e,r,o,n){var t=n,s=JSON.parse(JSON.stringify(m.aio.syncmanager.RemoteUploader.OPTIONS));(s.path+=e,s.method="POST",this._username&&this._password&&(s.auth=this._username+":"+this._password),r)&&Object.keys(r).forEach(function(e){s.headers[e]=r[e];});var i="",a=require(m.aio.syncmanager.RemoteUploader.PROTOCOL).request(s,function(e){e.setEncoding("utf8"),e.on("data",function(e){i+=e;}),e.on("end",function(){200==e.statusCode?t&&t(null,i):t&&t(new Error("http error with status code:"+e.statusCode),i),t=null;});});a.on("error",function(e){t&&(t(e),t=null);}),a.write(o),a.end();},m.aio.syncmanager.RemoteUploader.prototype._encrypt=function(e,r){return require("x.crypt.js").AES.encodeString(e,r).trim();},m.aio.syncmanager.Assembler=function(){},m.aio.syncmanager.Assembler.prototype={generateRemoteDownloadRsp:function generateRemoteDownloadRsp(e,r,o,n,t){var s=this;this._getRemoteDatabaseInfo(r,o,function(o,i){o?n&&n(o):(i&&i.forEach(function(o){o.file&&(o.ref="tenant/"+e.index+"/remote/"+r.index+"/"+o.file);}),s._getRemoteInfo(r,function(o,t){o?n&&n(o):(t.resources&&t.resources.forEach(function(o){o.file&&"device_db"!=o.file&&"macros_db"!=o.file&&"deviceinfo.xml"!=o.file&&(o.ref="tenant/"+e.index+"/remote/"+r.index+"/"+o.file,i.push(o));}),t.resources=i,n&&n(null,t));},t));});},generateRemoteUploadReq:function generateRemoteUploadReq(e,r,o){this.generateRemoteDownloadRsp(e,r,"from_upload_req",o);},_getRemoteInfo:function _getRemoteInfo(e,r,o){var n=require("unorm"),t=e.getFolderPath(),s={name:n.nfc(e.id),resources:[]};this._getFilesInfos(t,function(e,o){e?r&&r(e):(o&&(s.resources=o),r&&r(null,s));},o);},_getRemoteDatabaseInfo:function _getRemoteDatabaseInfo(e,r,o){var n=this,t=e.getFolderPath(),s=require("fs-extra");async.parallel([function(o){var i=e.getDeviceFile();i?fs.exists(i,function(e){e?n._getFileInfos(i,t,function(e,n){if("from_download"==r)try{s.removeSync(i);}catch(e){}o(e,n);}):o();}):o();},function(r){var o=e.getMacrosFile();o?fs.exists(o,function(e){e?n._getFileInfos(o,t,function(e,o){r(e,o);}):r();}):r();},function(r){var o=e.getDeviceinfoFile();o?fs.exists(o,function(e){e?n._getFileInfos(o,t,function(e,o){r(e,o);}):r();}):r();}],function(e,r){var n=[];r&&r.forEach(function(e){e&&n.push(e);}),o&&o(e,n);});},_getTenantDatabaseInfo:function _getTenantDatabaseInfo(e,r){var o=this,n=e.getFolderPath();async.parallel([function(r){var t=e.getDeviceFile();t?fs.exists(t,function(e){e?o._getFileInfos(t,n,function(e,o){r(e,o);}):r();}):r();},function(r){var t=e.getMacrosFile();t?fs.exists(t,function(e){e?o._getFileInfos(t,n,function(e,o){r(e,o);}):r();}):r();},function(r){var t=e.getDeviceinfoFile();t?fs.exists(t,function(e){e?o._getFileInfos(t,n,function(e,o){r(e,o);}):r();}):r();}],function(e,o){var n=[];o&&o.forEach(function(e){e&&n.push(e);}),r&&r(e,n);});},_listAllFiles:function _listAllFiles(e,r){var o=[],n=this,check=function check(t,s){if(s>=t.length)r(null,o);else{var i=t[s],a=path.join(e,i);fs.stat(a,function(e,i){e?r(e,o):i.isDirectory()?n._listAllFiles(a,function(e,n){e?r(e,o):(Array.isArray(n)&&(o=o.concat(n)),check(t,s+1));}):(o.push(a),check(t,s+1));});}};fs.readdir(e,function(e,n){e?r&&r(e,o):check(n,0);});},_getFilesInfos:function _getFilesInfos(e,r,o){var n=[],t=require("m.aio.configmanager.js").Page.FILE_EXT,s=this;this._listAllFiles(e,function(i,a){i?r&&r(i):async.eachLimit(a,50,function(r,i){if(0!=path.basename(r).indexOf(".")){var a=r.replace(e,""),l=path.extname(a);("controls"!=a.substr(1,8)||l===t.PAGE||l===t.POPUP)&&"resources_"!=a.substr(1,10)?s._getFileInfos(r,e,function(e,r){e?i(e):(r&&n.push(r),i());},o):i();}else i();},function(e){r&&r(e,n);});});},_getFileInfos:function _getFileInfos(e,r,o,n){var t=path.relative(r,e);t=unorm.nfc(t),e=unorm.nfc(e),"\\"==path.sep&&(t=t.replace(/\\/g,"/"));var s={file:t,name:path.basename(e)},i=this;fs.stat(e,function(r,n){r?o(r):n.isFile()?(s.size=n.size,i._md5AndSha1(e,function(e,r){e?o(e):(s.md5=r.md5,s.sha1=r.sha1,o(null,s));})):o(new Error(e+" is not a file"));});},_md5AndSha1:function _md5AndSha1(e,r){var o=crypto.createHash("md5"),n=crypto.createHash("sha1"),t=fs.createReadStream(e);t.on("readable",function(){for(var e=null;null!==(e=t.read());){o.update(e),n.update(e);}}).on("end",function(){var e={md5:o.digest("base64"),sha1:n.digest("base64")};r(null,e);});},_md5:function _md5(e,r){var o=crypto.createHash("md5"),n=fs.createReadStream(e);n.on("readable",function(){for(var e;null!==(e=n.read());){o.update(e);}}).on("end",function(){r(null,{md5:o.digest("base64")});});},_sha1:function _sha1(e,r){var o=crypto.createHash("sha1"),n=fs.createReadStream(e);n.on("readable",function(){for(var e;null!==(e=n.read());){o.update(e);}}).on("end",function(){r(null,{sha1:o.digest("base64")});});}},m.aio.syncmanager.UserDBUploader=function(){var Uploader=function Uploader(e,r){this._logger=require("x.logger.js").getLogger("UserDBUploader"),this._username=e.username?e.username:"",this._password=e.password?e.password:"",this._listener=r;};return Uploader.prototype.upload=function(e,r){if(!e)return this._listener&&this._listener.onError&&this._listener.onError({error:"no such tenant",error_code:100}),void(r&&r(new Error("tenant is null")));var o=this;this._upload(e,function(e){e?(o._logger.log("trace","upload user database error:"+e.stack),o._listener&&o._listener.onError&&o._listener.onError({error:e.message,error_code:e.code})):(o._logger.log("trace","upload user database success"),o._listener&&o._listener.onSuccess&&o._listener.onSuccess(4)),r&&r(e);});},Uploader.prototype._upload=function(e,r){this._logger.log("debug","upload user db:"+e.index);var o=this;this._zipUserDB(e,function(e,n){if(e)return o._logger.log("trace","zip user database error:"+e.stack),void(r&&r(e));o._logger.log("trace","zip user database ok"),o._requestUpload(function(e,t){if(e)return o._logger.log("trace","send upload request error:"+e.stack),void(r&&r(e));o._logger.log("trace","send upload request ok"),o._uploadZip(n,t,function(e){if(e)return o._logger.log("trace","upload zip error:"+e.stack),void(r&&r(e));o._logger.log("trace","upload zip ok"),o._finishUpload(t.ref,function(e){e?o._logger.log("trace","finish user database upload error:"+e.stack):o._logger.log("trace","finish user database upload ok"),r&&r(e);});});});});},Uploader.prototype._zipUserDB=function(e,r){var o=this;this._reportProgress(0,"zip user database",function(){o._logger.log("trace","zip the user database.");for(var n=require("path"),t=e.getDeviceFile(),s=e.getDeviceFile()+".enc",i=e.getMacrosFile(),a=(e.getDeviceinfoFile(),e.getFolderPath()+n.sep+"automation"),l=require("m.aio.filemanager.js"),c=require("fs"),d=Math.round(new Date().getTime()/1e3),u=0,f=l.getTmpDir(),g=n.join(f,d+".zip");o._fileExistsSync(g);){if(d++,++u>10)return void(r&&r(new Error("can not create temp file")));g=n.join(f,d+".zip");}o._logger.log("trace","zip file:"+g);var p=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(p,function(l){if(o._logger.log("debug","Checked CPU for features: "+p.join(", ")+". Result: "+l),l){var d=require("archiver"),u=c.createWriteStream(g),f=d("zip");if(u.on("error",function(e){o._logger.log("warn","create user database error:"+e.message),r&&(r(e),r=null);}),u.on("close",function(){r&&(r(null,g),r=null);}),f.pipe(u),o._fileExistsSync(t)&&f.append(c.createReadStream(t),{name:"device_db"}),o._fileExistsSync(i)&&f.append(c.createReadStream(i),{name:"macros_db"}),o._fileExistsSync(s)&&f.append(c.createReadStream(s),{name:"device_db.enc"}),o._fileExistsSync(a)){if(!c.statSync(a).isDirectory()){var h=new Error("Automation folder is not a directory: "+a);return o._logger.log("error",h.message),r&&r(h),void(r=null);}f.directory(a,"automation");}f.finalize();}else{var _=new(require("jszip"))(),y=Date.now(),w=e.getFolderPath(),addRecursive=function addRecursive(e){_.folder(e);for(var r=c.readdirSync(n.join(w,e),{withFileTypes:!0}),o=0;o<r.length;o++){var t=r[o];if(t.isFile()){var s=t.name.toLowerCase();if(".ds_store"!==s&&"thumbs.db"!==s){var i=n.join(w,e,t.name),a=c.readFileSync(i),l=t.name;e&&(l=e+"/"+l),_.file(l,a);}}else if(t.isDirectory()){var d=e+"/"+t.name;addRecursive(d);}}};if(o._fileExistsSync(t)&&_.file("device_db",c.readFileSync(t)),o._fileExistsSync(s)&&_.file("device_db.enc",c.readFileSync(s)),o._fileExistsSync(i)&&_.file("macros_db",c.readFileSync(i)),o._fileExistsSync(a)){if(!c.statSync(a).isDirectory()){var _e=new Error("Automation folder is not a directory: "+a);return o._logger.log("error",_e.message),r&&r(_e),void(r=null);}addRecursive("automation");}_.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:6},streamFiles:!0,type:"nodebuffer"}).pipe(c.createWriteStream(g)).on("finish",function(){o._logger.log("debug","ZIP has been created: "+g),o._logger.log("debug","Creating the ZIP took "+(Date.now()-y)+" ms."),r&&(r(null,g),r=null);});}});});},Uploader.prototype._requestUpload=function(e){var r=this;this._reportProgress(1,"send upload request",function(){r._logger.log("trace","send upload user database request."),r._doRequest("POST","/creatorneo/userdb/requestUpload",null,null,function(r,o){if(o)try{o=JSON.parse(o);}catch(e){(r=e).code=103;}r||(o&&"success"==o.status?o.result&&o.result.ref&&o.result.credential||((r=new Error("request upload response format error")).code=102):(r=new Error("request upload response error:"+o.message)).code=101),r&&(r.code||(r.code=100)),e&&e(r,o&&o.result);});});},Uploader.prototype._uploadZip=function(e,r,o){var n=this;this._reportProgress(2,"upload zip file",function(){n._logger.log("trace","upload zip file with ref:"+r.ref);var t=new(require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:r.credential.accessKeyId,secretAccessKey:r.credential.secretAccessKey,sessionToken:r.credential.sessionToken}),s=require("fs"),i=(require("path"),o),a=s.createReadStream(e);a.on("error",function(e){i&&(e.code=201,i(e),i=null);});var l={Bucket:"mediola-creator",Key:"user_db/"+r.ref,Body:a};t.putObject(l,function(e){i&&(e&&(e.code=202),i(e),i=null);}).on("error",function(e){i&&(e.code=203,i(e),i=null);});});},Uploader.prototype._finishUpload=function(e,r){var o=this;this._reportProgress(3,"finish upload",function(){o._logger.log("trace","finish upload zip file ref:"+e),o._doRequest("POST","/creatorneo/userdb/finishUpload?ref="+e,null,null,function(e,o){if(o)try{o=JSON.parse(o);}catch(r){(e=r).code=303;}e||o&&"success"==o.status||((e=new Error("request upload response error:"+o.message)).code=301),e&&(e.code||(e.code=300)),r&&r(e);});});},Uploader.prototype._reportProgress=function(e,r,o){this._listener&&this._listener.onProgress?this._listener.onProgress(e,r,null,o):o&&o();},Uploader.prototype._fileExistsSync=function(e){var r=require("fs");try{r.statSync(e);}catch(e){if("ENOENT"==e.code)return!1;}return!0;},Uploader.prototype._doRequest=function(e,r,o,n,t){var s=t,i=require(m.aio.syncmanager.PROTOCOL),a={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};(a.path+=r,a.method=e,this._username&&this._password&&(a.auth=this._username+":"+this._password),o)&&Object.keys(o).forEach(function(e){a.headers[e]=o[e];});var l="",c=i.request(a,function(e){e.setEncoding("utf8"),e.on("data",function(e){l+=e;}),e.on("end",function(){200==e.statusCode?s&&s(null,l):s&&s(new Error("http error with status code:"+e.statusCode),l),s=null;});});c.on("error",function(e){s&&(s(e),s=null);}),n&&c.write(n),c.end();},Uploader;}(),m.aio.syncmanager.UserDBDownloader=function(){var Downloader=function Downloader(e,r){this._logger=require("x.logger.js").getLogger("UserDBDownloader"),this._username=e.username?e.username:"",this._password=e.password?e.password:"",this._listener=r;};return Downloader.prototype.download=function(e,r){if(!e)return this._listener&&this._listener.onError&&this._listener.onError({error:"no such tenant",error_code:100}),void(r&&r(new Error("tenant is null")));var o=this;this._download(e,function(e){e?(o._logger.log("trace","download user database error:"+e.stack),o._listener&&o._listener.onError&&o._listener.onError({error:e.message,error_code:e.code})):(o._logger.log("trace","download user database success"),o._listener&&o._listener.onSuccess&&o._listener.onSuccess(4)),r&&r(e);});},Downloader.prototype._download=function(e,r){this._logger.log("debug","download user db:"+e.index);var o=this;this._requestDownload(function(n,t){if(n)return o._logger.log("trace","send download request error:"+n.stack),void(r&&r(n));o._downloadZip(t,function(n,t){if(n)return o._logger.log("trace","download zip file error:"+n.stack),void(r&&r(n));o._unzipFile(t,function(n,t){if(n)return o._logger.log("trace","unzip file error:"+n.stack),void(r&&r(n));o._reloadUserDB(t,e,function(e){e&&o._logger.log("trace","reload user database error:"+e.stack),r&&r(e);});});});});},Downloader.prototype._requestDownload=function(e){var r=this;this._reportProgress(0,"send download request",function(){r._logger.log("trace","send download user database request."),r._doRequest("GET","/creatorneo/userdb/requestDownload",null,null,function(r,o){if(o)try{o=JSON.parse(o);}catch(e){(r=e).code=103;}r||(o&&"success"==o.status?o.result&&o.result.ref&&o.result.credential||((r=new Error("request download response foramt error")).code=102):(r=new Error("request download response error:"+o.message)).code=101),r&&(r.code||(r.code=100)),e&&e(r,o&&o.result);});});},Downloader.prototype._downloadZip=function(e,r){var o=this;this._reportProgress(1,"download zip file",function(){o._logger.log("trace","download zip file with ref:"+e.ref);for(var n=require("m.aio.filemanager.js"),t=require("path"),s=require("fs"),i=Math.round(new Date().getTime()/1e3),a=0,l=n.getTmpDir(),c=t.join(l,i+".zip");o._fileExistsSync(c);){if(i++,++a>10)return void(r&&r(new Error("can not create temp file")));c=t.join(l,i+".zip");}o._logger.log("trace","zip file:"+c);var d=new(require("aws-sdk").S3)({apiVersion:"2006-03-01",region:"eu-central-1",accessKeyId:e.credential.accessKeyId,secretAccessKey:e.credential.secretAccessKey,sessionToken:e.credential.sessionToken}),u={Bucket:"mediola-creator",Key:"user_db/"+e.ref};d.getObject(u,function(e,o){if(e)return e.code=201,void(r&&r(e));s.writeFile(c,o.Body,function(e){e&&(e.code=203),r&&r(e,c);});});});},Downloader.prototype._unzipFile=function(e,r){var o=this;this._reportProgress(2,"unzip file",function(){for(var n=require("m.aio.filemanager.js"),t=require("path"),s=(require("fs"),Math.round(new Date().getTime()/1e3)),i=0,a=n.getTmpDir(),l=t.join(a,s+"");o._fileExistsSync(l);){if(s++,++i>10){var c=new Error("cannot create temp folder: "+l);return c.code=301,void(r&&r(c));}l=t.join(a,s+"");}o._logger.log("trace","unzip to folder:"+l);try{require("fs-extra").ensureDirSync(l);}catch(c){return c.code=201,void(r&&r(c));}var d=["ssse3","sse4_1","sse4_2"];XC.hasCPUFeatures(d,function(n){if(o._logger.log("debug","Checked CPU for features: "+d.join(", ")+". Result: "+n),n){var t=new(require("adm-zip"))(e);try{t.extractAllTo(l,!0),r&&r(null,l);}catch(e){e.code=202,r&&r(e);}}else XC.unzip(e,l,o._logger,function(e){e?(e.code=202,r&&r(e)):r&&r(null,l);});});});},Downloader.prototype._reloadUserDB=function(e,r,o){var n=require("fs"),t=require("fs-extra"),s=this;this._reportProgress(3,"load user database",function(){var i=require("path"),a=r.getDeviceFile(),l=r.getDeviceFile()+".enc",c=r.getMacrosFile(),d=r.getDeviceinfoFile(),u=i.join(r.getFolderPath(),"automation"),f=i.join(e,"device_db"),g=i.join(e,"device_db.enc"),p=i.join(e,"macros_db"),h=i.join(e,"deviceinfo.xml"),_=i.join(e,"automation");s._copyFolder(_,u,function(e){if(e)return e.code=303,void(o&&o(e));s._copyFile(h,d,function(e){if(e)return e.code=301,void(o&&o(e));s._copyFile(p,c,function(e){if(e)return e.code=302,void(o&&o(e));try{t.removeSync(l);}catch(e){}n.existsSync(g)?s._copyFile(g,l,function(e){if(e)return e.code=302,void(o&&o(e));var n=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(r,function(){n.reloadTenant(r,function(){o&&o();});});}):s._copyFile(f,a,function(e){if(e)return e.code=302,void(o&&o(e));var n=require("m.aio.devicemanager.js");require("m.aio.macromanager.js").reloadTenant(r,function(){n.reloadTenant(r,function(){o&&o();});});});});});});});},Downloader.prototype._reportProgress=function(e,r,o){this._listener&&this._listener.onProgress?this._listener.onProgress(e,r,null,o):o&&o();},Downloader.prototype._fileExistsSync=function(e){var r=require("fs");try{r.statSync(e);}catch(e){if("ENOENT"==e.code)return!1;}return!0;},Downloader.prototype._copyFile=function(e,r,o){var n=require("fs");this._fileExistsSync(e)?n.readFile(e,function(e,t){e?o&&o(e):n.writeFile(r,t,function(e){o&&o(e);});}):n.writeFile(r,"",function(e){o&&o(e);});},Downloader.prototype._copyFolder=function(e,r,o){var n=require("fs-extra"),t=this;n.remove(r,function(s){s?o&&o(s):t._fileExistsSync(e)?n.move(e,r,{overwrite:!0},function(e){o&&o(e);}):o&&o();});},Downloader.prototype._doRequest=function(e,r,o,n,t){var s=t,i=require(m.aio.syncmanager.PROTOCOL),a={host:m.aio.syncmanager.HOST,port:m.aio.syncmanager.PORT,path:m.aio.syncmanager.PATH,headers:m.aio.syncmanager.HEADERS};(a.path+=r,a.method=e,this._username&&this._password&&(a.auth=this._username+":"+this._password),o)&&Object.keys(o).forEach(function(e){a.headers[e]=o[e];});var l="",c=i.request(a,function(e){e.setEncoding("utf8"),e.on("data",function(e){l+=e;}),e.on("end",function(){200==e.statusCode?s&&s(null,l):s&&s(new Error("http error with status code:"+e.statusCode),l),s=null;});});c.on("error",function(e){s&&(s(e),s=null);}),n&&c.write(n),c.end();},Downloader;}(),m.aio.syncmanager.SyncManager=function(){this._configmanager=null;},m.aio.syncmanager.SyncManager.prototype={init:function init(e,r,o,n){this._configmanager=e,r&&(m.aio.syncmanager.RemoteUploader.OPTIONS.host=r,m.aio.syncmanager.RemotesDownloader.OPTIONS.host=r,m.aio.syncmanager.RemoteDownloader.OPTIONS.host=r,m.aio.syncmanager.HOST=r),o&&o>0&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=o,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=o,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=o,m.aio.syncmanager.PORT=o,process&&"local"!=process.env.CLOUD&&80==o&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=443,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=443,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=443,m.aio.syncmanager.PORT=443),process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.OPTIONS.port=80,m.aio.syncmanager.RemotesDownloader.OPTIONS.port=80,m.aio.syncmanager.RemoteDownloader.OPTIONS.port=80,m.aio.syncmanager.PORT=80)),process&&"local"==process.env.CLOUD?(m.aio.syncmanager.RemoteUploader.OPTIONS.path="/webservice",m.aio.syncmanager.RemotesDownloader.OPTIONS.path="/webservice",m.aio.syncmanager.RemoteDownloader.OPTIONS.path="/webservice",m.aio.syncmanager.PATH="/webservice",m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL="http"):process&&"dev"==process.env.CLOUD&&(m.aio.syncmanager.RemoteUploader.PROTOCOL="http",m.aio.syncmanager.RemotesDownloader.PROTOCOL="http",m.aio.syncmanager.RemoteDownloader.PROTOCOL="http",m.aio.syncmanager.PROTOCOL="http"),n&&n();},uploadRemote:function uploadRemote(e,r,o,n,t){if(o&&o.username&&o.password){var s=this;this._configmanager.trace("config/tenants/"+e,function(i,a){i?t&&t(i):a.license&&a.license.licenseTxt?s._configmanager.trace("config/tenants/"+e+"/remotes/"+r,function(e,r){if(e)t&&t(e);else{var s=require("m.aio.devicemanager.js");s.saveRemote(r,function(e){e?t&&t(e):new m.aio.syncmanager.RemoteUploader(o,n).upload(a.license.licenseTxt,a,r,function(e){s.clearRemoteDB(r,function(){t&&t(e);});});});}}):t&&t(new Error("no license"));});}else t&&t(new Error("options format invalid"));},downloadRemote:function downloadRemote(e,r,o,n,t,s){n&&n.username&&n.password?this._configmanager.trace("config/tenants/"+e,function(e,i){if(e)s&&s(e);else if(i.license&&i.license.licenseTxt){if(i.isAccessible()){var a=new m.aio.syncmanager.RemotesDownloader()._findRemote(r,o);if(a){n.credential=o.credential;var l=i.getRemotes().getFolderPath();new m.aio.syncmanager.RemoteDownloader(n,t).download(l,a,function(e){e?s&&s(e):setTimeout(function(){i.reloadRemotes(function(e){s&&s(e);});},100);});}else s&&s(new Error("no such remote:"+r));}else s&&s(new Error("not permitted"));}else s&&s(new Error("no license"));}):s&&s(new Error("options format invalid"));},downloadRemoteList:function downloadRemoteList(e,r,o){new m.aio.syncmanager.RemotesDownloader(null,null,e,r).downloadRemoteList(o);},testRemotePassword:function testRemotePassword(e,r,o,n){if(e){if(r){if(o){var t=new m.aio.syncmanager.RemotesDownloader(),s=t._findRemote(e,o);if(s){if(s.encrypt){var i=t._decrypt(s.encrypt,r);n&&n(null,i==e);}else n&&n(null,!0);}else n&&n(new Error("no such remote:"+e));}else n&&n(new Error("info is null"));}else n&&n(new Error("remote password is null"));}else n&&n(new Error("remote name is null"));},listRemotes:function listRemotes(e,r){var o=Date.now();e=e||{},this._configmanager.trace("config/tenants",function(n,t){if(n)return void(r&&r(n));var s=t.getChildren();if(!s)return void(r&&r(null,[]));var i=s.find(function(e){return e.isDefault();});n=null,i?i.license?i.license.isTestLicense()?(n=new Error("Cannot transfer remotes from test license")).code=400:i.license.valid||(n=new Error("License is not valid")):n=new Error("Tenant has no license information"):n=new Error("Cannot find default tenant"),n&&r&&r(n,null);var a=[];function getSize(e){try{var _r=fs.statSync(e);if(_r.isFile())return _r.size;if(_r.isDirectory()){return fs.readdirSync(e).reduce(function(r,o){return r+getSize(path.join(e,o));},0);}}catch(e){console.error(e);}return 0;}!0===e.simple?i.remotes.children.forEach(function(e){a.push({index:e.index,name:e.id,size:getSize(e.getFolderPath())});}):a=i.remotes,console.debug("[m.aio.syncmanager.SyncManager.listRemotes] Listed remotes in ".concat(Date.now()-o," ms. (simple = ").concat(!!e.simple,")")),r&&r(null,i,a);});},listRemoteResources:function listRemoteResources(e,r){var o=Date.now();this.listRemotes({simple:!1},function(n,t,s){if(n)return void(r&&r(n));var i=s.getChildren().find(function(r){return r.index==e;});if(!i)return void(r&&r(new Error("No remote with index ".concat(e," in tenant with index ").concat(t.index,"."))));require("m.aio.devicemanager.js").deleteUnlicensed(t.index,function(e){if(e)return void(r&&r(e));new m.aio.syncmanager.Assembler().generateRemoteDownloadRsp(t,i,"from_download",function(e,n){e?r&&r(e):(console.debug("[m.aio.syncmanager.SyncManager.listRemoteResources] Listed remote resources in ".concat(Date.now()-o," ms.")),r&&r(null,n.resources));});});});},requestDownload:function requestDownload(e,r){var o=this;this._configmanager.trace("config/tenants",function(n,t){if(n)return void(e&&e(n));var s=null;var i=t.getChildren();if(i){if((s=i.find(function(e){return e.isDefault();}))&&s.license&&!s.license.isTestLicense()&&s.license.valid)o.requestDownloadTenant(s.index,e,r);else if(s&&s.license&&s.license.isTestLicense()){var a=new Error("can not download from test license");a.code=400,e&&e(a,null);}else e&&e(null,{infos:[]});}else e&&e(null,{infos:[]});});},requestDownloadTenant:function requestDownloadTenant(e,r,o){var n=Date.now();this._configmanager.trace("config/tenants/"+e,function(t,s){if(t)r&&r(t);else if(s.isAccessible()){var i={infos:[]},a=s.getRemotes();if(a&&0!=a.size())require("m.aio.devicemanager.js").deleteUnlicensed(e,function(e){if(e)r&&r(e);else{var t=0,l=new m.aio.syncmanager.Assembler();a.getChildren().forEach(function(e){l.generateRemoteDownloadRsp(s,e,"from_download",function(e,o){t+=1,e||i.infos.push(o),t==a.size()&&(console.debug("[m.aio.syncmanager.SyncManager.requestDownloadTenant] Done after "+(Date.now()-n)+" ms."),r&&r(null,i));},o);});}});else r&&r(null,i);}else r&&r(new Error("not permitted"));});},getTenantFile:function getTenantFile(e,r,o){e&&r?this._configmanager.trace("config/tenants/"+e,function(e,n){if(e)o&&o(e);else{var t=require("path");r=r.replace(/\//g,t.sep);var s=n.getFolderPath();s?o&&o(null,s+t.sep+r):o&&o(new Error("tenant has no folder"));}}):o&&o(new Error("parameter invalid"));},getRemoteFile:function getRemoteFile(e,r,o,n){e&&r&&o?this._configmanager.trace("config/tenants/"+e+"/remotes/"+r,function(e,r){if(e)n&&n(e);else{var t=require("path");o=o.replace(/\//g,t.sep);var s=r.getFolderPath();s?n&&n(null,s+t.sep+o):n&&n(new Error("remote has no folder"));}}):n&&n(new Error("parameter invalid"));},getRemoteDeviceDBData:function getRemoteDeviceDBData(e,r,o,n){e&&r&&o?require("m.aio.devicemanager.js").getDeviceDBForRemote(e,function(e,r){n&&n(e,r);}):n&&n(new Error("parameter invalid"));},uploadUserDB:function uploadUserDB(e,r,o,n){if(!r||!r.username||!r.password)return o&&o.onError&&o.onError({error:"options format invalid",error_code:100}),void(n&&n(new Error("options format invalid")));this._configmanager.trace("config/tenants/"+e,function(e,t){return e?(o&&o.onError&&o.onError({error:e.message,error_code:100}),void(n&&n(e))):t.license&&t.license.licenseTxt?void new m.aio.syncmanager.UserDBUploader(r,o).upload(t,function(e){n&&n(e);}):(o&&o.onError&&o.onError({error:"no license",error_code:100}),void(n&&n(new Error("no license"))));});},downloadUserDB:function downloadUserDB(e,r,o,n){if(!r||!r.username||!r.password)return o&&o.onError&&o.onError({error:"options format invalid",error_code:100}),void(n&&n(new Error("options format invalid")));this._configmanager.trace("config/tenants/"+e,function(e,t){return e?(o&&o.onError&&o.onError({error:e.message,error_code:100}),void(n&&n(e))):t.license&&t.license.licenseTxt?void new m.aio.syncmanager.UserDBDownloader(r,o).download(t,function(e){n&&n(e);}):(o&&o.onError&&o.onError({error:"no license",error_code:100}),void(n&&n(new Error("no license"))));});},_downloadRemotes:function _downloadRemotes(e,r,o){r&&r.host&&r.port?new m.aio.syncmanager.RemotesDownloader(r.host,r.port,r.username,r.password).download(e,function(e){o&&o(e);}):o&&o(new Error("options format invalid"));}},m.aio.syncmanager.Handler=m.aio.syncmanager.SyncManager,m.aio.syncmanager.Handler.prototype.RemotesDownloader=m.aio.syncmanager.RemotesDownloader,m.aio.syncmanager.Handler.prototype.RemoteDownloader=m.aio.syncmanager.RemoteDownloader,"undefined"!=typeof module&&null!=module&&(module.exports=new m.aio.syncmanager.Handler());